import React, { useState, useEffect } from 'react';
import { Calendar, Users, Clock, FileText, DollarSign, Bell, Settings, Home, Briefcase, TrendingUp, Plus, Search, Filter, ChevronDown, ChevronRight, ChevronLeft, Mail, MessageSquare, Download, Upload, CheckCircle, AlertCircle, XCircle, Menu, X, MoreVertical, Edit, Trash2, Eye, User, LogOut, BarChart3, PieChart, Activity, Check, Building, Percent, Key, Shield, RefreshCw } from 'lucide-react';

// Firebase imports
import { initializeApp } from "firebase/app";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot } from "firebase/firestore";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "firebase/storage";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCv1f44t61b8r11PUC3E0UtwxzwtlVOIOQ",
  authDomain: "ca-hub-pro.firebaseapp.com",
  projectId: "ca-hub-pro",
  storageBucket: "ca-hub-pro.firebasestorage.app",
  messagingSenderId: "72722363355",
  appId: "1:72722363355:web:f4f284624eb96ab59dadfe"
};

// Initialize Firebase
const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);
const storage = getStorage(firebaseApp);

// Utility function for generating IDs
const generateId = () => Math.random().toString(36).substr(2, 9);

// Helper function to format fileNo to always show 2 digits after decimal
const formatFileNo = (fileNo) => {
  if (!fileNo) return '';
  const parts = String(fileNo).split('.');
  if (parts.length !== 2) return fileNo;
  const groupNo = parts[0];
  const clientNo = String(parseInt(parts[1]) || 0).padStart(2, '0');
  return `${groupNo}.${clientNo}`;
};

// Helper function to remove/convert undefined values (Firebase doesn't accept undefined)
// This recursively processes all nested objects and arrays
const removeUndefined = (obj) => {
  if (obj === undefined) return null;
  if (obj === null) return null;
  if (typeof obj !== 'object') return obj;
  
  if (Array.isArray(obj)) {
    return obj.map(item => removeUndefined(item));
  }
  
  const newObj = {};
  for (const key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      const value = obj[key];
      if (value === undefined) {
        newObj[key] = null; // Convert undefined to null
      } else {
        newObj[key] = removeUndefined(value);
      }
    }
  }
  return newObj;
};

// BULLETPROOF: Clean data for Firebase using JSON stringify/parse
// This is GUARANTEED to remove all undefined values
const cleanForFirebase = (data) => {
  // JSON.stringify automatically excludes undefined values
  // We use a replacer to convert undefined to null explicitly
  const jsonString = JSON.stringify(data, (key, value) => {
    if (value === undefined) {
      return null;
    }
    return value;
  });
  
  // Parse it back to object - now guaranteed to have no undefined
  return JSON.parse(jsonString);
};

// Parent and Child Task Data
// Default Parent-Child Tasks Configuration (can be modified via Configuration)
const DEFAULT_PARENT_CHILD_TASKS = {
  'GST': ['Monthly 3B', 'GSTR 1 Monthly', 'GST R1 Quarterly', 'CMP 08', 'GSTR 9', 'GSTR 9C', 'GST Registrations', 'TDS under GST', 'Litigation', 'LUT', 'GST Amend/Cancel/Revive', 'GSTR-4', 'Quarterly 3B', 'IFF Monthly/R1 Quarterly', 'RFD-01'],
  'Income Tax': ['IT Return Filing', 'Litigation', 'Non Filing of Return Notices', '15G/H', '15CA/CB', 'Form 61 A'],
  'Audit': ['Tax Audit', 'Company Audit', 'Other Audits', 'Retainership', 'Concurrent Audit'],
  'TDS': ['24Q', '24G', '26Q', '27EQ', '15CA / CB & 26 QB', 'Correction Returns', 'Default Corrections', 'TDS Deposit'],
  'Accounting': ['Monthly Accounting', 'Reconciliations'],
  'ROC - Company': ['Filings', 'Company Registration'],
  'ROC-LLP': ['LLP Filing', 'LLP Registration'],
  'Finance work': ['Loans & Financing'],
  'Registrations': ['IEC / ISBN / MSME / ISO / Startup', 'FSSAI', 'Trademark', 'Other Misc Registrations'],
  'Miscellaneous': ['Deed Writing', 'Other Misc Replies to notice', 'Other Misc Tasks', 'Certificates', 'PAN / TAN', 'Other Registrations/Returns', 'DSC', 'Virtual Office Rent'],
  'Payroll': ['EPF-ESIC Return', 'EPF-ESIC Registration'],
  'Trademark': ['Trademark Registration', 'Trademark Objection Reply', 'Trademark Hearing'],
  'FEMA': ['Show Cause Notice', 'Appeals', 'Advisory']
};

const FINANCIAL_YEARS = ['FY 2023-24', 'FY 2024-25', 'FY 2025-26', 'FY 2026-27'];
const PERIODS = ['Monthly', 'Quarterly', 'Half-Yearly', 'Annually'];

// Initial mock data
const initialData = {
  tasks: [],
  clients: [],
  staff: [
    {
      id: 'staff-superadmin-001',
      name: 'Test1',
      email: 'test1@firm.com',
      phone: '9999999999',
      role: 'Superadmin',
      dateOfJoin: '2020-01-01',
      dateOfBirth: '1985-01-01',
      password: 'admin123',
      status: 'Active',
      isSuperAdmin: true,
      permissions: null // null means all access (superadmin)
    }
  ],
  timesheets: [],
  invoices: [],
  receipts: [],
  organizations: [],
  recurringSchedules: [],
  leaves: [],
  documents: [],
  userPermissions: {}, // {staffId: {dashboard: true, tasks: true, clients: false, ...}}
  parentChildTasks: { ...DEFAULT_PARENT_CHILD_TASKS }, // Configurable task categories
  recurringBatches: [], // {id, name, parentTask, childTask, clients: [], autoCreate: true/false, isActive: true}
  checklists: [], // {id, name, parentTask, childTask, items: [{id, text, required}], isActive: true}
  pendingApprovals: [], // {id, type, requestedBy, requestedByRole, approverId, approverRole, status, data, createdAt, updatedAt, comments, actionedBy}
  dscRegister: [] // {id, clientId, clientName, holderName, pan, dscType, tokenSerialNo, issuingAuthority, issueDate, expiryDate, password, physicalLocation, status, remarks, createdAt, updatedAt}
};

const PracticeManagementApp = () => {
  // Firebase loading states
  const [firebaseLoading, setFirebaseLoading] = useState(true);
  const [firebaseUser, setFirebaseUser] = useState(null);
  const [dataLoaded, setDataLoaded] = useState(false);
  
  // Data state - starts empty, loaded from Firebase
  const [data, setData] = useState({
    tasks: [],
    clients: [],
    staff: [],
    timesheets: [],
    invoices: [],
    receipts: [],
    organizations: [],
    recurringSchedules: [],
    leaves: [],
    documents: [],
    userPermissions: {},
    parentChildTasks: { ...DEFAULT_PARENT_CHILD_TASKS },
    recurringBatches: [],
    checklists: [],
    pendingApprovals: [],
    dscRegister: [],
    packages: [],
    bulkBatches: [],
    latestGeneratedInvoices: []
  });
  
  const [currentUser, setCurrentUser] = useState(null);
  const [currentView, setCurrentView] = useState('login'); // Start with login view
  const [sidebarOpen, setSidebarOpen] = useState(true);
  
  // Task Configuration Modal State
  const [showTaskConfigModal, setShowTaskConfigModal] = useState(false);
  const [taskConfigNewParent, setTaskConfigNewParent] = useState('');
  const [taskConfigNewChild, setTaskConfigNewChild] = useState('');
  const [taskConfigSelectedParent, setTaskConfigSelectedParent] = useState('');
  const [taskConfigActiveTab, setTaskConfigActiveTab] = useState('categories'); // categories, batches, checklists
  
  // Configuration Floater State
  const [configExpanded, setConfigExpanded] = useState(false);
  const [activeConfigOption, setActiveConfigOption] = useState(''); // categories, batches, checklists
  
  // Recurring Batches State
  const [selectedBatch, setSelectedBatch] = useState(null);
  const [showBatchForm, setShowBatchForm] = useState(false);
  const [batchFormStep, setBatchFormStep] = useState(1); // 1: Details, 2: Client Selection, 3: Preview
  const [batchClientSearch, setBatchClientSearch] = useState('');
  const [batchFormData, setBatchFormData] = useState({
    name: '',
    parentTask: '',
    childTask: '',
    taskManager: '',
    taskLeader: '',
    financialYear: 'FY 2024-25',
    taskDescription: '',
    startDate: '',
    dueDate: '',
    period: '',
    subPeriod: '',
    frequency: 'Monthly', // Monthly, Quarterly, Half-Yearly, Annually
    executionDay: '1', // Day of month/quarter to execute
    clients: [], // [{clientId, primaryAssignedUser}]
    isActive: true
  });
  
  // Checklists State
  const [selectedChecklist, setSelectedChecklist] = useState(null);
  const [showChecklistForm, setShowChecklistForm] = useState(false);
  const [checklistFormData, setChecklistFormData] = useState({
    name: '',
    parentTask: '',
    childTask: '',
    items: [],
    isActive: true
  });
  const [newChecklistItem, setNewChecklistItem] = useState('');
  
  // Approval System State
  const [showApprovalsView, setShowApprovalsView] = useState(false);
  const [approvalsActiveTab, setApprovalsActiveTab] = useState('all'); // all, tasks, clients, billing, receipts, staff
  const [showNotificationDropdown, setShowNotificationDropdown] = useState(false);
  const [selectedApproval, setSelectedApproval] = useState(null);
  const [showApprovalEditModal, setShowApprovalEditModal] = useState(false);
  const [approvalEditData, setApprovalEditData] = useState(null);
  
  // Computed PARENT_CHILD_TASKS - uses stored config or defaults
  const PARENT_CHILD_TASKS = data.parentChildTasks || DEFAULT_PARENT_CHILD_TASKS;
  
  // Helper function to check for duplicate tasks
  // A task is duplicate if same: parentTask + childTask + clientId/clientName + subPeriod
  const isDuplicateTask = (newTask, existingTasks) => {
    const normalizeString = (str) => (str || '').toString().trim().toLowerCase();
    
    return existingTasks.some(existing => {
      // Skip deleted tasks
      if (existing.deleted) return false;
      
      // Check all 4 criteria for duplicate
      const sameParent = normalizeString(existing.parentTask) === normalizeString(newTask.parentTask);
      const sameChild = normalizeString(existing.childTask) === normalizeString(newTask.childTask);
      const sameSubPeriod = normalizeString(existing.subPeriod) === normalizeString(newTask.subPeriod);
      
      // Check client match (by ID or by name)
      let sameClient = false;
      if (newTask.clientId && existing.clientId) {
        sameClient = existing.clientId === newTask.clientId;
      } else {
        sameClient = normalizeString(existing.clientName) === normalizeString(newTask.clientName);
      }
      
      return sameParent && sameChild && sameSubPeriod && sameClient;
    });
  };
  
  // Helper to filter out duplicates and return info about what was filtered
  const filterDuplicateTasks = (newTasks, existingTasks) => {
    const validTasks = [];
    const duplicates = [];
    
    // Also check within newTasks themselves for duplicates
    const allTasksToCheck = [...existingTasks];
    
    newTasks.forEach(task => {
      if (isDuplicateTask(task, allTasksToCheck)) {
        duplicates.push(task);
      } else {
        validTasks.push(task);
        allTasksToCheck.push(task); // Add to check list to prevent duplicates within batch
      }
    });
    
    return { validTasks, duplicates };
  };
  
  // For compatibility
  const isLoggedIn = currentView !== 'login';
  
  // Approval System Helper Functions
  const getCurrentUserRole = () => {
    const staff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    return staff?.role || currentUser?.role || 'Unknown';
  };
  
  const getCurrentUserRM = () => {
    const staff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    return staff?.reportingManager || '';
  };
  
  const needsApproval = (actionType, userRole) => {
    // Superadmin never needs approval
    if (userRole === 'Superadmin' || currentUser?.isSuperAdmin) return false;
    
    // RM actions that need Superadmin approval
    const rmActionsNeedingApproval = ['invoice', 'receipt', 'client_disable', 'staff_add', 'staff_disable'];
    if (userRole === 'Reporting Manager' && rmActionsNeedingApproval.includes(actionType)) {
      return { needsApproval: true, approverRole: 'Superadmin' };
    }
    
    // Senior/Article actions that need RM approval
    const juniorActionsNeedingApproval = ['task', 'bulk_task', 'client_add'];
    if ((userRole === 'Seniors' || userRole === 'Articles') && juniorActionsNeedingApproval.includes(actionType)) {
      return { needsApproval: true, approverRole: 'Reporting Manager' };
    }
    
    return false;
  };
  
  const createApprovalRequest = (type, itemData, description) => {
    const userRole = getCurrentUserRole();
    const approvalInfo = needsApproval(type, userRole);
    
    if (!approvalInfo) return null;
    
    const currentStaff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    
    const approval = {
      id: generateId(),
      type: type,
      description: description,
      requestedBy: currentUser?.name || 'Unknown',
      requestedByEmail: currentUser?.email || '',
      requestedByRole: userRole,
      approverRole: approvalInfo.approverRole,
      approverId: approvalInfo.approverRole === 'Reporting Manager' ? getCurrentUserRM() : null,
      status: 'pending', // pending, approved, rejected
      data: itemData,
      createdAt: new Date().toISOString(),
      updatedAt: null,
      actionedBy: null,
      comments: ''
    };
    
    return approval;
  };
  
  const getPendingApprovalsForUser = () => {
    const userRole = getCurrentUserRole();
    const userName = currentUser?.name;
    
    if (!data.pendingApprovals) return [];
    
    // Superadmin sees RM requests
    if (userRole === 'Superadmin' || currentUser?.isSuperAdmin) {
      return data.pendingApprovals.filter(a => 
        a.status === 'pending' && a.approverRole === 'Superadmin'
      );
    }
    
    // RM sees their team's requests
    if (userRole === 'Reporting Manager') {
      return data.pendingApprovals.filter(a => 
        a.status === 'pending' && 
        a.approverRole === 'Reporting Manager' && 
        a.approverId === userName
      );
    }
    
    return [];
  };
  
  const getMyApprovalRequests = () => {
    if (!data.pendingApprovals) return [];
    return data.pendingApprovals.filter(a => 
      a.requestedByEmail?.toLowerCase() === currentUser?.email?.toLowerCase()
    );
  };
  
  const handleApprovalAction = (approvalId, action, editedData = null, comments = '') => {
    const approval = data.pendingApprovals.find(a => a.id === approvalId);
    if (!approval) return;
    
    if (action === 'approve') {
      const dataToUse = editedData || approval.data;
      
      // Create the actual item based on type
      switch (approval.type) {
        case 'task':
        case 'bulk_task':
          if (Array.isArray(dataToUse)) {
            setData(prev => ({
              ...prev,
              tasks: [...prev.tasks, ...dataToUse],
              pendingApprovals: prev.pendingApprovals.map(a => 
                a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
              )
            }));
          } else {
            setData(prev => ({
              ...prev,
              tasks: [...prev.tasks, dataToUse],
              pendingApprovals: prev.pendingApprovals.map(a => 
                a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
              )
            }));
          }
          break;
        case 'client_add':
          setData(prev => ({
            ...prev,
            clients: [...prev.clients, dataToUse],
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        case 'invoice':
          setData(prev => ({
            ...prev,
            invoices: [...prev.invoices, dataToUse],
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        case 'receipt':
          setData(prev => ({
            ...prev,
            receipts: [...prev.receipts, dataToUse],
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        case 'client_disable':
          setData(prev => ({
            ...prev,
            clients: prev.clients.map(c => c.id === dataToUse.clientId ? {...c, disabled: true, disabledAt: new Date().toISOString()} : c),
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        case 'staff_add':
          setData(prev => ({
            ...prev,
            staff: [...prev.staff, dataToUse],
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        case 'staff_disable':
          setData(prev => ({
            ...prev,
            staff: prev.staff.map(s => s.id === dataToUse.staffId ? {...s, status: 'Inactive', disabledAt: new Date().toISOString()} : s),
            pendingApprovals: prev.pendingApprovals.map(a => 
              a.id === approvalId ? {...a, status: 'approved', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
            )
          }));
          break;
        default:
          break;
      }
      alert('âœ… Approved successfully!');
    } else if (action === 'reject') {
      setData(prev => ({
        ...prev,
        pendingApprovals: prev.pendingApprovals.map(a => 
          a.id === approvalId ? {...a, status: 'rejected', actionedBy: currentUser?.name, updatedAt: new Date().toISOString(), comments} : a
        )
      }));
      alert('âŒ Request rejected.');
    }
  };
  
  // Helper function to get agreed fee for a task from client's agreedFees configuration
  const getClientAgreedFee = (clientId, parentTask, childTask) => {
    if (!clientId) return null;
    const client = data.clients.find(c => c.id === clientId);
    if (!client || !client.agreedFees) return null;
    
    // Look for exact match of parent + child task
    const exactMatch = client.agreedFees.find(
      f => f.parentTask === parentTask && f.childTask === childTask
    );
    if (exactMatch) return parseFloat(exactMatch.fee) || 0;
    
    // Look for parent task only match (when child is empty or "All")
    const parentMatch = client.agreedFees.find(
      f => f.parentTask === parentTask && (!f.childTask || f.childTask === 'All')
    );
    if (parentMatch) return parseFloat(parentMatch.fee) || 0;
    
    return null;
  };
  
  // Firebase Auth State Listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      console.log('Auth state changed:', user?.email);
      setFirebaseUser(user);
      
      if (user) {
        // User is logged in, load data from Firebase
        try {
          const docRef = doc(db, 'appData', 'mainData');
          const docSnap = await getDoc(docRef);
          
          if (docSnap.exists()) {
            const firebaseData = docSnap.data();
            console.log('Loaded data from Firebase:', Object.keys(firebaseData));
            
            // Process organizations - images are stored in state, not Firebase
            // When org has [IMAGE] placeholder, it means image was uploaded but not stored in Firebase
            const orgsProcessed = (firebaseData.organizations || []).map(org => ({
              ...org,
              // If image was placeholder, keep it as is (user needs to re-upload)
              logo: org.logo === '[IMAGE]' ? '' : (org.logo || ''),
              signatureImage: org.signatureImage === '[IMAGE]' ? '' : (org.signatureImage || ''),
              qrCode: org.qrCode === '[IMAGE]' ? '' : (org.qrCode || '')
            }));
            
            // Remove duplicate clients by Client Code (keep first occurrence)
            const clientsFromFirebase = firebaseData.clients || [];
            const seenClientCodes = new Set();
            const uniqueClients = clientsFromFirebase.filter(c => {
              if (!c.fileNo) return true; // Keep clients without fileNo
              if (seenClientCodes.has(c.fileNo)) {
                console.log('Removing duplicate client:', c.name, c.fileNo);
                return false;
              }
              seenClientCodes.add(c.fileNo);
              return true;
            });
            
            if (uniqueClients.length < clientsFromFirebase.length) {
              console.log(`Removed ${clientsFromFirebase.length - uniqueClients.length} duplicate clients`);
            }
            
            // Properly merge ALL data fields with defaults
            setData(prev => ({
              tasks: firebaseData.tasks || prev.tasks || [],
              clients: uniqueClients, // Use deduplicated clients
              staff: firebaseData.staff || prev.staff || [],
              timesheets: firebaseData.timesheets || prev.timesheets || [],
              invoices: firebaseData.invoices || prev.invoices || [],
              receipts: firebaseData.receipts || prev.receipts || [],
              organizations: orgsProcessed,
              recurringSchedules: firebaseData.recurringSchedules || prev.recurringSchedules || [],
              leaves: firebaseData.leaves || prev.leaves || [],
              documents: firebaseData.documents || prev.documents || [],
              userPermissions: firebaseData.userPermissions || prev.userPermissions || {},
              parentChildTasks: firebaseData.parentChildTasks || prev.parentChildTasks || DEFAULT_PARENT_CHILD_TASKS,
              recurringBatches: firebaseData.recurringBatches || prev.recurringBatches || [],
              checklists: firebaseData.checklists || prev.checklists || [],
              pendingApprovals: firebaseData.pendingApprovals || prev.pendingApprovals || [],
              dscRegister: firebaseData.dscRegister || prev.dscRegister || [],
              bulkBatches: firebaseData.bulkBatches || prev.bulkBatches || [],
              latestGeneratedInvoices: firebaseData.latestGeneratedInvoices || prev.latestGeneratedInvoices || []
            }));
            
            // Find current user in staff
            const staffData = firebaseData.staff || [];
            const found = staffData.find(s => s.email?.toLowerCase() === user.email?.toLowerCase());
            if (found) {
              setCurrentUser({
                name: found.name,
                role: found.role,
                email: found.email,
                isSuperAdmin: found.isSuperAdmin || found.role === 'Superadmin',
                id: found.id
              });
            } else {
              // User exists in Firebase Auth but not in staff, add them as Superadmin
              const newStaffMember = {
                id: 'firebase-' + user.uid,
                name: user.email.split('@')[0],
                email: user.email,
                phone: '',
                role: 'Superadmin',
                dateOfJoin: new Date().toISOString().split('T')[0],
                status: 'Active',
                isSuperAdmin: true
              };
              setCurrentUser({
                name: newStaffMember.name,
                role: 'Superadmin',
                email: user.email,
                isSuperAdmin: true,
                id: newStaffMember.id
              });
              // Add new user to staff
              setData(prev => ({
                ...prev,
                staff: [...(prev.staff || []), newStaffMember]
              }));
            }
          } else {
            // No data in Firebase, initialize with default data
            console.log('No data in Firebase, initializing...');
            const initialStaff = [{
              id: 'staff-superadmin-001',
              name: user.email.split('@')[0],
              email: user.email,
              phone: '',
              role: 'Superadmin',
              dateOfJoin: new Date().toISOString().split('T')[0],
              status: 'Active',
              isSuperAdmin: true
            }];
            
            const initialData = {
              tasks: [],
              clients: [],
              staff: initialStaff,
              timesheets: [],
              invoices: [],
              receipts: [],
              organizations: [],
              recurringSchedules: [],
              leaves: [],
              documents: [],
              userPermissions: {},
              parentChildTasks: DEFAULT_PARENT_CHILD_TASKS,
              recurringBatches: [],
              checklists: [],
              pendingApprovals: [],
              dscRegister: []
            };
            
            setData(initialData);
            setCurrentUser({
              name: initialStaff[0].name,
              role: 'Superadmin',
              email: user.email,
              isSuperAdmin: true,
              id: initialStaff[0].id
            });
            
            // Save initial data to Firebase
            await setDoc(doc(db, 'appData', 'mainData'), cleanForFirebase({
              ...initialData,
              lastUpdated: new Date().toISOString()
            }));
          }
          
          setCurrentView('dashboard');
          setDataLoaded(true);
        } catch (error) {
          console.error('Error loading data from Firebase:', error);
          setDataLoaded(true);
        }
      } else {
        // User is logged out
        setCurrentUser(null);
        setCurrentView('login');
        setDataLoaded(false);
      }
      setFirebaseLoading(false);
    });
    
    return () => unsubscribe();
  }, []);
  
  // BULLETPROOF save function - used by all save operations
  // SIMPLE AND BULLETPROOF Firebase save function
  const saveAllDataToFirebase = async (dataObj) => {
    console.log('=== saveAllDataToFirebase V15 ULTRA-CLEAN ===');
    
    // Helper function to deep clean any object
    const deepClean = (obj) => {
      if (obj === null || obj === undefined) return null;
      if (typeof obj !== 'object') return obj;
      if (obj instanceof Date) return obj.toISOString();
      if (obj instanceof File) return null;
      if (Array.isArray(obj)) return obj.map(item => deepClean(item)).filter(x => x !== null);
      
      const cleaned = {};
      for (const [key, value] of Object.entries(obj)) {
        if (value === null || value === undefined) continue;
        if (typeof value === 'function') continue;
        if (value instanceof File) continue;
        if (typeof value === 'string' && value.startsWith('data:image')) {
          cleaned[key] = '[IMAGE]';
        } else if (typeof value === 'object') {
          const cleanedValue = deepClean(value);
          if (cleanedValue !== null && Object.keys(cleanedValue).length > 0) {
            cleaned[key] = cleanedValue;
          }
        } else {
          cleaned[key] = value;
        }
      }
      return cleaned;
    };
    
    try {
      // Step 1: Build data object with deep cleaning
      const rawData = {
        tasks: deepClean(dataObj.tasks) || [],
        clients: deepClean(dataObj.clients) || [],
        staff: deepClean(dataObj.staff) || [],
        timesheets: deepClean(dataObj.timesheets) || [],
        invoices: deepClean(dataObj.invoices) || [],
        receipts: deepClean(dataObj.receipts) || [],
        organizations: deepClean(dataObj.organizations) || [],
        recurringSchedules: deepClean(dataObj.recurringSchedules) || [],
        leaves: deepClean(dataObj.leaves) || [],
        documents: deepClean(dataObj.documents) || [],
        userPermissions: deepClean(dataObj.userPermissions) || {},
        parentChildTasks: deepClean(dataObj.parentChildTasks) || DEFAULT_PARENT_CHILD_TASKS,
        recurringBatches: deepClean(dataObj.recurringBatches) || [],
        checklists: deepClean(dataObj.checklists) || [],
        pendingApprovals: deepClean(dataObj.pendingApprovals) || [],
        dscRegister: deepClean(dataObj.dscRegister) || [],
        bulkBatches: deepClean(dataObj.bulkBatches) || [],
        latestGeneratedInvoices: deepClean(dataObj.latestGeneratedInvoices) || [],
        lastUpdated: new Date().toISOString()
      };
      
      // Step 2: JSON stringify/parse to ensure everything is serializable
      const cleanData = JSON.parse(JSON.stringify(rawData));
      
      console.log('Data prepared. Counts:', {
        tasks: cleanData.tasks?.length || 0,
        clients: cleanData.clients?.length || 0,
        staff: cleanData.staff?.length || 0,
        organizations: cleanData.organizations?.length || 0
      });
      
      // Step 3: Save to Firebase
      await setDoc(doc(db, 'appData', 'mainData'), cleanData);
      console.log('âœ… Firebase save SUCCESS!');
      
      return cleanData;
    } catch (error) {
      console.error('âŒ Firebase save FAILED:', error);
      throw error;
    }
  };
  
  // Save data to Firebase whenever it changes (debounced)
  useEffect(() => {
    if (!firebaseUser || !dataLoaded) {
      console.log('Skip save - firebaseUser:', !!firebaseUser, 'dataLoaded:', dataLoaded);
      return;
    }
    
    const saveTimeout = setTimeout(async () => {
      try {
        console.log('Debounced save starting...');
        await saveAllDataToFirebase(data);
        console.log('âœ… Data saved to Firebase successfully');
      } catch (error) {
        console.error('âŒ Error saving to Firebase:', error);
      }
    }, 1500); // Debounce saves by 1.5 seconds
    
    return () => clearTimeout(saveTimeout);
  }, [data, firebaseUser, dataLoaded]);
  
  // Sync task client codes with client database
  useEffect(() => {
    if (data.tasks.length > 0 && data.clients.length > 0) {
      let needsUpdate = false;
      const updatedTasks = data.tasks.map(task => {
        // If task has no fileNo but has clientName, try to find it from clients
        if (!task.fileNo && task.clientName) {
          const matchingClient = data.clients.find(c => 
            c.name?.toLowerCase() === task.clientName.toLowerCase()
          );
          if (matchingClient && matchingClient.fileNo) {
            needsUpdate = true;
            return { ...task, fileNo: matchingClient.fileNo };
          }
        }
        return task;
      });
      
      if (needsUpdate) {
        setData(prev => ({ ...prev, tasks: updatedTasks }));
      }
    }
  }, [data.clients]); // Re-run when clients change
  
  // Logout function  
  const handleLogout = async () => {
    try {
      await signOut(auth);
      setCurrentView('login');
      setCurrentUser(null);
    } catch (error) {
      console.error('Error signing out:', error);
    }
  };
  
  // Login View Component
  const LoginView = () => {
    const [email, setEmail] = useState('');
    const [pass, setPass] = useState('');
    const [msg, setMsg] = useState('');
    const [isSignUp, setIsSignUp] = useState(false);
    const [loading, setLoading] = useState(false);
    
    const tryLogin = async () => {
      if (!email || !pass) {
        setMsg('Please enter email and password');
        return;
      }
      
      setLoading(true);
      setMsg('');
      
      try {
        if (isSignUp) {
          // Create new account
          await createUserWithEmailAndPassword(auth, email.trim(), pass.trim());
          console.log('Account created successfully');
        } else {
          // Sign in existing account
          await signInWithEmailAndPassword(auth, email.trim(), pass.trim());
          console.log('Login successful');
        }
        // Auth state listener will handle the rest
      } catch (error) {
        console.error('Auth error:', error);
        switch (error.code) {
          case 'auth/invalid-email':
            setMsg('Invalid email address');
            break;
          case 'auth/user-disabled':
            setMsg('This account has been disabled');
            break;
          case 'auth/user-not-found':
            setMsg('No account found with this email. Click "Create Account" to sign up.');
            break;
          case 'auth/wrong-password':
            setMsg('Incorrect password');
            break;
          case 'auth/invalid-credential':
            setMsg('Invalid email or password. Try again or create a new account.');
            break;
          case 'auth/email-already-in-use':
            setMsg('This email is already registered. Try signing in.');
            break;
          case 'auth/weak-password':
            setMsg('Password should be at least 6 characters');
            break;
          default:
            setMsg(error.message);
        }
      }
      setLoading(false);
    };
    
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #d1fae5 100%)',
        zIndex: 9999
      }}>
        <div style={{
          background: '#fff',
          borderRadius: '16px',
          width: '90%',
          maxWidth: '380px',
          boxShadow: '0 20px 60px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            background: 'linear-gradient(135deg, #10b981, #059669)',
            padding: '28px',
            textAlign: 'center',
            color: '#fff',
            borderRadius: '16px 16px 0 0'
          }}>
            <Briefcase size={36} />
            <h1 style={{ margin: '10px 0 0', fontSize: '22px' }}>CA Hub Pro <span style={{fontSize: '10px', color: '#94a3b8'}}>v15</span></h1>
            <p style={{ margin: '5px 0 0', fontSize: '13px', opacity: 0.9 }}>Practice Management</p>
          </div>
          
          <div style={{ padding: '24px' }}>
            <div style={{ marginBottom: '16px' }}>
              <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: 600 }}>Email</label>
              <input
                type="email"
                value={email}
                onChange={e => setEmail(e.target.value)}
                placeholder="your@email.com"
                style={{ width: '100%', padding: '12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '14px', boxSizing: 'border-box' }}
                onKeyPress={e => e.key === 'Enter' && tryLogin()}
              />
            </div>
            
            <div style={{ marginBottom: '16px' }}>
              <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: 600 }}>Password</label>
              <input
                type="password"
                value={pass}
                onChange={e => setPass(e.target.value)}
                placeholder={isSignUp ? "Min 6 characters" : "Enter password"}
                style={{ width: '100%', padding: '12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '14px', boxSizing: 'border-box' }}
                onKeyPress={e => e.key === 'Enter' && tryLogin()}
              />
            </div>
            
            {msg && (
              <div style={{ padding: '10px', background: '#fee2e2', borderRadius: '6px', color: '#dc2626', fontSize: '13px', marginBottom: '16px' }}>
                {msg}
              </div>
            )}
            
            <button
              type="button"
              onClick={tryLogin}
              disabled={loading}
              style={{ 
                width: '100%', 
                padding: '14px', 
                background: loading ? '#9ca3af' : '#10b981', 
                color: '#fff', 
                border: 'none', 
                borderRadius: '8px', 
                fontSize: '15px', 
                fontWeight: 600, 
                cursor: loading ? 'not-allowed' : 'pointer' 
              }}
            >
              {loading ? 'Please wait...' : (isSignUp ? 'Create Account' : 'Sign In')}
            </button>
            
            <div style={{ marginTop: '16px', textAlign: 'center' }}>
              <button
                type="button"
                onClick={() => { setIsSignUp(!isSignUp); setMsg(''); }}
                style={{ 
                  background: 'none', 
                  border: 'none', 
                  color: '#10b981', 
                  fontSize: '13px', 
                  cursor: 'pointer',
                  textDecoration: 'underline'
                }}
              >
                {isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Create one"}
              </button>
            </div>
            
            {/* Info Box */}
            <div style={{ marginTop: '16px', padding: '12px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #bbf7d0' }}>
              <div style={{ fontSize: '11px', color: '#166534' }}>
                <strong>ðŸ”¥ Firebase Powered</strong><br/>
                Your data is securely stored in the cloud. Create an account to get started!
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };
  
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [formData, setFormData] = useState({});
  const [showTaskManageModal, setShowTaskManageModal] = useState(false);
  const [showAddTaskModal, setShowAddTaskModal] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);
  const [activeTab, setActiveTab] = useState('milestones');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedParentTask, setSelectedParentTask] = useState('');
  const [selectedChildTask, setSelectedChildTask] = useState('');
  const [expandedParents, setExpandedParents] = useState({});
  const [taskCategoriesExpanded, setTaskCategoriesExpanded] = useState(false);
  const [sidebarTaskSearch, setSidebarTaskSearch] = useState('');
  const [sidebarSelectedParent, setSidebarSelectedParent] = useState('');
  
  // Invoicing Sidebar State
  const [invoicingExpanded, setInvoicingExpanded] = useState(false);
  const [selectedInvoicingTab, setSelectedInvoicingTab] = useState('');
  
  // User Management Sidebar State
  const [userManagementExpanded, setUserManagementExpanded] = useState(false);
  const [selectedUserManagementTab, setSelectedUserManagementTab] = useState('manageUsers');
  const [managingUserPermissions, setManagingUserPermissions] = useState(null); // staff object being managed
  
  // Staff Management States
  const [activeStaffCategory, setActiveStaffCategory] = useState('Superadmin');
  const [staffSearchTerm, setStaffSearchTerm] = useState('');
  const [showStaffModal, setShowStaffModal] = useState(false);
  const [editingStaff, setEditingStaff] = useState(null);
  const [showStaffControlsModal, setShowStaffControlsModal] = useState(false);
  const [controllingStaff, setControllingStaff] = useState(null);
  const [staffPermissions, setStaffPermissions] = useState({});
  const [activePermissionTab, setActivePermissionTab] = useState('sidebar');
  const [showRolesPermissionsModal, setShowRolesPermissionsModal] = useState(false);
  
  // Timesheet States
  const [showTimesheetModal, setShowTimesheetModal] = useState(false);
  const [selectedTimesheetDate, setSelectedTimesheetDate] = useState(new Date().toISOString().split('T')[0]);
  
  // Search filters
  const [filters, setFilters] = useState({
    fileNo: '',
    clientName: '',
    groupName: '',
    taskFinancialYear: '',
    taskPeriod: '',
    assignedUser: '',
    status: '' // New status filter
  });
  
  const [entriesPerPage, setEntriesPerPage] = useState(300);

  // Global permission check helper - alias for consistency
  const checkPermission = (permissionKey) => {
    // If the key starts with 'perm_', strip it for hasActionPermission
    const cleanKey = permissionKey.startsWith('perm_') ? permissionKey.substring(5) : permissionKey;
    return hasActionPermission(cleanKey);
  };

  // Toggle parent task expansion
  const toggleParent = (parent) => {
    setExpandedParents(prev => ({
      ...prev,
      [parent]: !prev[parent]
    }));
  };

  // Handle child task click
  const handleChildTaskClick = (parent, child) => {
    setSelectedParentTask(parent);
    setSelectedChildTask(child);
    setCurrentView('task-detail');
  };

  // Open task management modal
  const openTaskManageModal = (task) => {
    setSelectedTask(task);
    setShowTaskManageModal(true);
    setActiveTab('milestones');
  };

  const closeTaskManageModal = () => {
    setShowTaskManageModal(false);
    setSelectedTask(null);
  };

  // Handle Delete Task
  const handleDeleteTask = (taskId) => {
    if (window.confirm('Are you sure you want to delete this task? This action can be reversed by filtering for Deleted tasks.')) {
      setData(prev => ({
        ...prev,
        tasks: prev.tasks.map(t => 
          t.id === taskId ? { ...t, deleted: true, deletedAt: new Date().toISOString() } : t
        )
      }));
      alert('Task deleted successfully! You can view deleted tasks using the Status filter.');
    }
  };

  // Staff Management Handlers
  const staffCategories = ['Superadmin', 'Reporting Manager', 'Seniors', 'Articles'];

  // Helper function to check if current user has a specific action permission
  const hasActionPermission = (permissionKey) => {
    // Superadmin always has all permissions
    if (currentUser?.isSuperAdmin || currentUser?.role === 'Superadmin') return true;
    
    // Find current staff record
    const currentStaff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    if (!currentStaff) return true; // If no staff record found, allow by default
    
    // Get user's permissions
    const userPermissions = data.userPermissions?.[currentStaff.id] || {};
    
    // If no permissions are set, allow everything (default full access)
    if (Object.keys(userPermissions).length === 0) return true;
    
    // Check the specific permission - only deny if explicitly set to false
    const permKey = `perm_${permissionKey}`;
    return userPermissions[permKey] !== false;
  };

  // Global helper to check if current user can view a task
  const canUserViewTask = (task) => {
    // Superadmin can see all tasks
    if (currentUser?.isSuperAdmin || currentUser?.role === 'Superadmin') return true;
    
    // Get current staff record
    const currentStaff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    const userName = currentStaff?.name || currentUser?.name;
    const userId = currentStaff?.id || currentUser?.id;
    
    if (!userName && !userId) return true; // Fallback: allow if no user info
    
    // Check if user is assigned to this task (any assignment field)
    const isAssigned = 
      task.primaryAssignedUser === userName ||
      task.primaryAssignedUser === userId ||
      task.assignedTo === userName ||
      task.assignedTo === userId ||
      task.assignedUser === userName ||
      task.assignedUser === userId;
    
    // Check if user is task manager/leader
    const isManager = 
      task.taskManager === userName ||
      task.taskManager === userId ||
      task.taskLeader === userName ||
      task.taskLeader === userId;
    
    // For Reporting Managers, also include tasks of their team members
    if (currentUser?.role === 'Reporting Manager') {
      const teamMembers = data.staff.filter(s => 
        s.reportingManager === userId || 
        s.reportingManager === userName ||
        s.taskManager === userName ||
        s.taskManager === userId ||
        // Fallback: include Seniors/Articles if no explicit team
        (s.role === 'Seniors' || s.role === 'Articles' || s.role === 'Intern')
      );
      
      const isTeamTask = teamMembers.some(member => 
        task.primaryAssignedUser === member.name ||
        task.primaryAssignedUser === member.id ||
        task.assignedTo === member.name ||
        task.assignedTo === member.id
      );
      
      return isAssigned || isManager || isTeamTask;
    }
    
    // For other roles, only show if assigned or manager
    return isAssigned || isManager;
  };

  // Get all tasks visible to current user
  const getVisibleTasks = () => {
    return data.tasks.filter(t => !t.deleted && canUserViewTask(t));
  };

  const getStaffByCategory = (category) => {
    return data.staff.filter(s => s.role === category);
  };

  const handleCreateStaff = () => {
    setEditingStaff(null);
    setShowStaffModal(true);
  };

  const handleEditStaff = (staff) => {
    setEditingStaff(staff);
    setShowStaffModal(true);
  };

  const handleSaveStaff = (staffData) => {
    console.log('=== handleSaveStaff CALLED ===');
    console.log('Staff data received:', staffData);
    console.log('editingStaff:', editingStaff);
    console.log('Current staff count:', data.staff.length);
    
    try {
      // Check for duplicate email
      const emailLower = staffData.email.toLowerCase();
      const existingStaff = data.staff.find(s => 
        s.email.toLowerCase() === emailLower && 
        (!editingStaff || s.id !== editingStaff.id)
      );
      
      if (existingStaff) {
        alert(`Error: A staff member with email "${staffData.email}" already exists (${existingStaff.name}). Please use a different email.`);
        return;
      }
      
      if (editingStaff) {
        console.log('Updating existing staff...');
        // Update existing staff - no approval needed for edits
        setData(prev => ({
          ...prev,
          staff: prev.staff.map(s => s.id === editingStaff.id ? { ...s, ...staffData } : s)
        }));
        alert('Staff updated successfully!');
      } else {
        console.log('Creating new staff...');
        // Create new staff
        const newStaff = {
          id: generateId(),
          ...staffData,
          status: 'Active',
          workload: 0
        };
        console.log('New staff object:', newStaff);
        
        // Check if approval is needed (RM needs Superadmin approval for staff add)
        const userRole = getCurrentUserRole();
        const approvalNeeded = needsApproval('staff_add', userRole);
        
        if (approvalNeeded) {
          // Create approval request instead of direct save
          const approval = createApprovalRequest(
            'staff_add',
            newStaff,
            `New Staff: ${newStaff.name} (${newStaff.role})`
          );
          
          if (approval) {
            setData(prev => ({
              ...prev,
              pendingApprovals: [...(prev.pendingApprovals || []), approval]
            }));
            setShowStaffModal(false);
            alert('ðŸ“ Staff addition submitted for approval!\n\nSuperadmin will review and approve.');
            return;
          }
        }
        
        // Direct save for Superadmin
        setData(prev => {
          const updatedStaff = [...prev.staff, newStaff];
          console.log('Updated staff array length:', updatedStaff.length);
          return {
            ...prev,
            staff: updatedStaff
          };
        });
        
        console.log('Staff created successfully');
        alert('Staff created successfully!');
      }
      console.log('Closing modal...');
      setShowStaffModal(false);
      console.log('=== handleSaveStaff COMPLETE ===');
    } catch (error) {
      console.error('ERROR in handleSaveStaff:', error);
      alert('Error saving staff: ' + error.message);
    }
  };

  const handleToggleStaffStatus = (staffId) => {
    console.log('=== handleToggleStaffStatus CALLED ===');
    console.log('Staff ID:', staffId);
    console.log('Current staff list:', data.staff);
    
    try {
      const staff = data.staff.find(s => s.id === staffId);
      if (!staff) {
        alert('Staff not found');
        return;
      }
      
      const isDisabling = staff.status === 'Active';
      
      // Check if approval is needed (RM needs Superadmin approval for staff disable)
      if (isDisabling) {
        const userRole = getCurrentUserRole();
        const approvalNeeded = needsApproval('staff_disable', userRole);
        
        if (approvalNeeded) {
          const reason = prompt('Reason for disabling this staff member:');
          if (reason === null) return; // User cancelled
          
          // Create approval request instead of direct disable
          const approval = createApprovalRequest(
            'staff_disable',
            { staffId: staff.id, staffName: staff.name, staffEmail: staff.email, reason },
            `Disable Staff: ${staff.name} (${staff.role})`
          );
          
          if (approval) {
            setData(prev => ({
              ...prev,
              pendingApprovals: [...(prev.pendingApprovals || []), approval]
            }));
            alert('ðŸ“ Staff disable request submitted for approval!\n\nSuperadmin will review and approve.');
            return;
          }
        }
      }
      
      // Direct toggle for Superadmin or re-enabling staff
      setData(prev => {
        const updatedStaff = prev.staff.map(s => {
          if (s.id === staffId) {
            const newStatus = s.status === 'Active' ? 'Disabled' : 'Active';
            console.log(`Toggling staff ${s.name} from ${s.status} to ${newStatus}`);
            return { ...s, status: newStatus };
          }
          return s;
        });
        console.log('Updated staff:', updatedStaff);
        return {
          ...prev,
          staff: updatedStaff
        };
      });
      alert('Staff status updated successfully!');
      console.log('=== handleToggleStaffStatus COMPLETE ===');
    } catch (error) {
      console.error('ERROR in handleToggleStaffStatus:', error);
      alert('Error toggling status: ' + error.message);
    }
  };

  const handleResetPassword = (staffId) => {
    console.log('=== handleResetPassword CALLED ===');
    console.log('Staff ID:', staffId);
    
    try {
      if (window.confirm('Reset password for this staff member?')) {
        console.log('User confirmed password reset');
        // In a real app, this would trigger an API call to send reset email
        alert('Password reset link sent to staff email!');
        console.log('Password reset completed');
      } else {
        console.log('User cancelled password reset');
      }
      console.log('=== handleResetPassword COMPLETE ===');
    } catch (error) {
      console.error('ERROR in handleResetPassword:', error);
      alert('Error resetting password: ' + error.message);
    }
  };

  // Dashboard Statistics
  // Get tasks visible to current user for stats
  const visibleTasks = data.tasks.filter(t => !t.deleted && canUserViewTask(t));
  
  const stats = {
    totalTasks: visibleTasks.length,
    pendingTasks: visibleTasks.filter(t => t.status === 'Pending' || (!t.status && !t.completedCheck)).length,
    inProgressTasks: visibleTasks.filter(t => t.status === 'In Progress').length,
    completedTasks: visibleTasks.filter(t => t.status === 'Completed' || t.completedCheck).length,
    totalClients: data.clients.filter(c => !c.disabled).length,
    totalStaff: data.staff.filter(s => s.status === 'Active').length,
    presentStaff: data.staff.filter(s => s.status === 'Present' || s.status === 'Active').length,
  };

  // Modal handlers
  const openModal = (type, item = null) => {
    setModalType(type);
    setSelectedItem(item);
    if (item) {
      setFormData(item);
    } else {
      setFormData({});
    }
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setModalType('');
    setSelectedItem(null);
    setFormData({});
  };

  const handleFormSubmit = (e) => {
    e.preventDefault();
    
    if (modalType === 'task') {
      if (selectedItem) {
        setData(prev => ({
          ...prev,
          tasks: prev.tasks.map(t => t.id === selectedItem.id ? { ...formData, id: t.id } : t)
        }));
      } else {
        setData(prev => ({
          ...prev,
          tasks: [...prev.tasks, { ...formData, id: generateId(), status: formData.status || 'Pending', priority: formData.priority || 'Medium' }]
        }));
      }
    }
    closeModal();
  };

  const deleteTask = (id) => {
    if (window.confirm('Are you sure you want to delete this task?')) {
      setData(prev => ({ ...prev, tasks: prev.tasks.filter(t => t.id !== id) }));
    }
  };

  // Sidebar Component with Task Categories
  const Sidebar = () => {
    // Get current user's permissions
    const currentStaff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    const userPermissions = currentStaff ? (data.userPermissions?.[currentStaff.id] || {}) : {};
    const isSuperAdmin = currentUser?.isSuperAdmin || currentUser?.role === 'Superadmin';
    
    // Debug logging
    console.log('Sidebar Permission Check:', {
      currentUserEmail: currentUser?.email,
      currentStaffId: currentStaff?.id,
      isSuperAdmin,
      permissionsFound: Object.keys(userPermissions).length,
      userPermissions
    });
    
    // Check if user has access to a menu item
    const hasAccess = (menuKey) => {
      if (isSuperAdmin) return true; // Superadmin sees everything
      if (Object.keys(userPermissions).length === 0) return true; // No permissions set = full access (default)
      return userPermissions[menuKey] === true;
    };
    
    return (
    <div className={`sidebar ${sidebarOpen ? 'open' : 'closed'}`}>
      <div className="sidebar-header">
        <div className="logo">
          <Briefcase size={28} />
          <span className="logo-text">CAHub Pro</span>
        </div>
        <button className="sidebar-toggle" onClick={() => setSidebarOpen(!sidebarOpen)}>
          {sidebarOpen ? <X size={20} /> : <Menu size={20} />}
        </button>
      </div>

      <nav className="sidebar-nav">
        {hasAccess('dashboard') && (
        <button 
          className={currentView === 'dashboard' ? 'active' : ''} 
          onClick={() => setCurrentView('dashboard')}
        >
          <Home size={20} />
          <span>Dashboard</span>
        </button>
        )}
        
        {hasAccess('tasks') && (
        <div className="nav-section">
          <button 
            className={`nav-section-header ${taskCategoriesExpanded ? 'expanded' : ''}`}
            onClick={() => {
              setTaskCategoriesExpanded(!taskCategoriesExpanded);
              if (!taskCategoriesExpanded && !sidebarSelectedParent) setSidebarSelectedParent('GST');
            }}
          >
            <CheckCircle size={18} />
            <span>Tasks</span>
            <ChevronRight size={16} style={{ marginLeft: 'auto' }} />
          </button>
          
          {/* Floating Task Panel - Both Parent & Child Outside Sidebar */}
          {taskCategoriesExpanded && (
            <>
              <div 
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  zIndex: 1000
                }}
                onClick={() => {
                  setTaskCategoriesExpanded(false);
                  setSidebarSelectedParent('');
                }}
              />
              <div style={{
                position: 'fixed',
                top: '100px',
                left: '220px',
                display: 'flex',
                background: '#ffffff',
                borderRadius: '0 12px 12px 0',
                overflow: 'hidden',
                boxShadow: '4px 4px 20px rgba(0,0,0,0.1)',
                zIndex: 1001,
                border: '1px solid #e2e8f0'
              }}>
                {/* Left Panel - Parent Tasks */}
                <div style={{
                  width: '170px',
                  borderRight: '1px solid #e2e8f0',
                  display: 'flex',
                  flexDirection: 'column'
                }}>
                  <div style={{flex: 1, overflowY: 'auto'}}>
                  {Object.keys(PARENT_CHILD_TASKS).filter(parent => {
                    // Check if user has access to this parent task category
                    const parentId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}`;
                    return hasAccess(parentId);
                  })
                  // Sort by task count (highest first)
                  .map(parent => ({
                    parent,
                    count: data.tasks.filter(t => 
                      t.parentTask === parent && 
                      !t.deleted &&
                      canUserViewTask(t)
                    ).length
                  }))
                  .sort((a, b) => b.count - a.count)
                  .map(({ parent, count: parentTaskCount }) => {
                    return (
                    <div
                      key={parent}
                      onClick={() => setSidebarSelectedParent(parent)}
                      style={{
                        padding: '10px 12px',
                        cursor: 'pointer',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: sidebarSelectedParent === parent ? '#dcfce7' : 'transparent',
                        color: sidebarSelectedParent === parent ? '#16a34a' : '#64748b',
                        borderBottom: '1px solid #f1f5f9',
                        fontSize: '12px',
                        fontWeight: 500
                      }}
                      onMouseEnter={(e) => {
                        if (sidebarSelectedParent !== parent) {
                          e.currentTarget.style.background = '#f1f5f9';
                          e.currentTarget.style.color = '#334155';
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (sidebarSelectedParent !== parent) {
                          e.currentTarget.style.background = 'transparent';
                          e.currentTarget.style.color = '#64748b';
                        }
                      }}
                    >
                      <span>{parent}</span>
                      <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                        {parentTaskCount > 0 && (
                          <span style={{
                            background: sidebarSelectedParent === parent ? '#16a34a' : '#dcfce7',
                            color: sidebarSelectedParent === parent ? '#fff' : '#16a34a',
                            padding: '2px 8px',
                            borderRadius: '10px',
                            fontSize: '10px',
                            fontWeight: '600',
                            minWidth: '20px',
                            textAlign: 'center'
                          }}>{parentTaskCount}</span>
                        )}
                        <ChevronRight size={14} style={{ opacity: 0.5 }} />
                      </div>
                    </div>
                    );
                  })}
                  </div>
                  {/* Configuration Section - Only for Superadmin */}
                  {currentUser?.isSuperAdmin && (
                    <div
                      onClick={(e) => {
                        e.stopPropagation();
                        setConfigExpanded(!configExpanded);
                        setSidebarSelectedParent('');
                      }}
                      style={{
                        padding: '10px 12px',
                        cursor: 'pointer',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: configExpanded ? '#fef3c7' : '#f8fafc',
                        color: configExpanded ? '#d97706' : '#d97706',
                        borderTop: '1px solid #e2e8f0',
                        fontSize: '11px',
                        fontWeight: 600
                      }}
                      onMouseEnter={(e) => {
                        if (!configExpanded) {
                          e.currentTarget.style.background = '#fef3c7';
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (!configExpanded) {
                          e.currentTarget.style.background = '#f8fafc';
                        }
                      }}
                    >
                      <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <Settings size={14} />
                        <span>Configuration</span>
                      </div>
                      <ChevronRight size={14} style={{ 
                        opacity: 0.5,
                        transform: configExpanded ? 'rotate(90deg)' : 'none',
                        transition: 'transform 0.2s'
                      }} />
                    </div>
                  )}
                </div>
                
                {/* Right Panel - Child Tasks OR Configuration Options */}
                <div style={{
                  width: '180px',
                  background: '#f8fafc'
                }}>
                  {/* Show Configuration Options when config is expanded */}
                  {configExpanded && (
                    <>
                      {[
                        {id: 'categories', label: 'Task Categories', icon: 'ðŸ“'},
                        {id: 'batches', label: 'Recurring Batches', icon: 'ðŸ”„'},
                        {id: 'checklists', label: 'Checklists', icon: 'âœ…'}
                      ].map(option => (
                        <div
                          key={option.id}
                          onClick={() => {
                            setActiveConfigOption(option.id);
                            setTaskConfigActiveTab(option.id);
                            setTaskConfigSelectedParent(Object.keys(PARENT_CHILD_TASKS)[0] || '');
                            setTaskConfigNewParent('');
                            setTaskConfigNewChild('');
                            setShowBatchForm(false);
                            setShowChecklistForm(false);
                            setSelectedBatch(null);
                            setSelectedChecklist(null);
                            setBatchFormStep(1);
                            setShowTaskConfigModal(true);
                            setConfigExpanded(false);
                            setTaskCategoriesExpanded(false);
                          }}
                          style={{
                            padding: '10px 12px',
                            cursor: 'pointer',
                            background: 'transparent',
                            color: '#64748b',
                            borderBottom: '1px solid #e2e8f0',
                            fontSize: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#f1f5f9';
                            e.currentTarget.style.color = '#334155';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#64748b';
                          }}
                        >
                          <span>{option.icon}</span>
                          <span>{option.label}</span>
                        </div>
                      ))}
                    </>
                  )}
                  
                  {/* Show Child Tasks when parent is selected */}
                  {!configExpanded && sidebarSelectedParent && PARENT_CHILD_TASKS[sidebarSelectedParent]?.filter(child => {
                    // Check if user has access to this child task
                    const childId = `task_${sidebarSelectedParent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
                    return hasAccess(childId);
                  })
                  // Sort by task count (highest first)
                  .map(child => ({
                    child,
                    count: data.tasks.filter(t => 
                      t.parentTask === sidebarSelectedParent && 
                      t.childTask === child && 
                      !t.deleted &&
                      canUserViewTask(t)
                    ).length
                  }))
                  .sort((a, b) => b.count - a.count)
                  .map(({ child, count: taskCount }) => {
                    const isActive = selectedParentTask === sidebarSelectedParent && selectedChildTask === child;
                    return (
                      <div
                        key={child}
                        onClick={() => {
                          handleChildTaskClick(sidebarSelectedParent, child);
                          setTaskCategoriesExpanded(false);
                          setSidebarSelectedParent('');
                        }}
                        style={{
                          padding: '9px 12px',
                          cursor: 'pointer',
                          background: isActive ? '#dcfce7' : 'transparent',
                          color: isActive ? '#16a34a' : '#64748b',
                          borderBottom: '1px solid #e2e8f0',
                          fontSize: '12px',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                        onMouseEnter={(e) => {
                          if (!isActive) {
                            e.currentTarget.style.background = '#f1f5f9';
                            e.currentTarget.style.color = '#334155';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!isActive) {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#64748b';
                          }
                        }}
                      >
                        <span>{child}</span>
                        {taskCount > 0 && (
                          <span style={{
                            background: '#10b981',
                            color: '#fff',
                            padding: '2px 6px',
                            borderRadius: '8px',
                            fontSize: '10px',
                            fontWeight: 600
                          }}>{taskCount}</span>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </>
          )}
        </div>
        )}

        {hasAccess('clients') && (
        <button className={currentView === 'clients' ? 'active' : ''} onClick={() => setCurrentView('clients')}>
          <Users size={20} />
          <span>Clients</span>
        </button>
        )}
        
        {hasAccess('dscRegister') && (
        <button className={currentView === 'dscRegister' ? 'active' : ''} onClick={() => setCurrentView('dscRegister')}>
          <Key size={20} />
          <span>DSC Register</span>
        </button>
        )}
        
        {hasAccess('clients') && (
        <button className={currentView === 'packages' ? 'active' : ''} onClick={() => setCurrentView('packages')}>
          <Briefcase size={20} />
          <span>Packages</span>
        </button>
        )}
        
        {hasAccess('staff') && (
        <button className={currentView === 'staff' ? 'active' : ''} onClick={() => setCurrentView('staff')}>
          <User size={20} />
          <span>Staff</span>
        </button>
        )}
        
        {/* Invoicing Expandable Menu */}
        {hasAccess('invoicing') && (
        <div className="nav-section">
          <div
            className={`nav-section-header ${invoicingExpanded ? 'expanded' : ''}`}
            onClick={() => {
              setInvoicingExpanded(!invoicingExpanded);
            }}
            style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: '12px 16px',
              cursor: 'pointer',
              color: invoicingExpanded || currentView.startsWith('invoicing') ? '#10b981' : '#94a3b8',
              background: invoicingExpanded ? 'rgba(16, 185, 129, 0.1)' : 'transparent',
              borderRadius: '8px',
              margin: '4px 8px',
              transition: 'all 0.15s'
            }}
          >
            <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
              <DollarSign size={20} />
              <span style={{fontWeight: 500}}>Invoicing</span>
            </div>
            <ChevronRight size={16} style={{transform: invoicingExpanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.15s'}} />
          </div>
          
          {invoicingExpanded && (
            <div style={{
              background: '#f1f5f9',
              borderRadius: '8px',
              margin: '4px 8px',
              overflow: 'hidden',
              border: '1px solid #e2e8f0'
            }}>
              {[
                { id: 'dashboard', label: 'Dashboard', icon: <BarChart3 size={16} />, permKey: 'invoicing_dashboard' },
                { id: 'billing', label: 'Billing', icon: <FileText size={16} />, permKey: 'invoicing_billing' },
                { id: 'unbilledTasks', label: 'Unbilled Tasks', icon: <Clock size={16} />, permKey: 'invoicing_unbilledTasks' },
                { id: 'receipts', label: 'Receipts', icon: <DollarSign size={16} />, permKey: 'invoicing_receipts' },
                { id: 'debtors', label: 'Debtors', icon: <Users size={16} />, permKey: 'invoicing_debtors' },
                { id: 'organizations', label: 'Organization', icon: <Briefcase size={16} />, permKey: 'invoicing_organizations' }
              ].filter(item => hasAccess(item.permKey)).map(item => {
                const isActive = currentView === 'invoicing' && selectedInvoicingTab === item.id;
                return (
                  <div
                    key={item.id}
                    onClick={() => {
                      setSelectedInvoicingTab(item.id);
                      setCurrentView('invoicing');
                    }}
                    style={{
                      padding: '10px 16px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      background: isActive ? '#dcfce7' : 'transparent',
                      color: isActive ? '#16a34a' : '#64748b',
                      borderBottom: '1px solid #e2e8f0',
                      fontSize: '13px',
                      transition: 'all 0.15s'
                    }}
                    onMouseEnter={(e) => {
                      if (!isActive) {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#334155';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (!isActive) {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#64748b';
                      }
                    }}
                  >
                    {item.icon}
                    <span>{item.label}</span>
                    <ChevronRight size={14} style={{marginLeft: 'auto', opacity: 0.5}} />
                  </div>
                );
              })}
            </div>
          )}
        </div>
        )}
        
        {hasAccess('templates') && (
        <button className={currentView === 'templates' ? 'active' : ''} onClick={() => setCurrentView('templates')}>
          <FileText size={20} />
          <span>Templates</span>
        </button>
        )}
        
        {hasAccess('reports') && (
        <button className={currentView === 'reports' ? 'active' : ''} onClick={() => setCurrentView('reports')}>
          <BarChart3 size={20} />
          <span>Reports</span>
        </button>
        )}
        
        {/* Approvals Menu - Show for RM and above, or anyone with pending requests */}
        {(isSuperAdmin || currentUser?.role === 'Reporting Manager' || getMyApprovalRequests().length > 0) && (
        <button 
          className={currentView === 'approvals' ? 'active' : ''} 
          onClick={() => setCurrentView('approvals')}
          style={{position: 'relative'}}
        >
          <CheckCircle size={20} />
          <span>Approvals</span>
          {getPendingApprovalsForUser().length > 0 && (
            <span style={{
              position: 'absolute',
              right: '12px',
              background: '#ef4444',
              color: '#fff',
              borderRadius: '10px',
              padding: '2px 6px',
              fontSize: '10px',
              fontWeight: '700',
              minWidth: '18px',
              textAlign: 'center'
            }}>
              {getPendingApprovalsForUser().length}
            </span>
          )}
        </button>
        )}
      </nav>

      <div className="sidebar-footer">
        <div className="user-profile">
          <div className="user-avatar">{currentUser?.name?.[0] || 'U'}</div>
          <div className="user-info">
            <div className="user-name">{currentUser?.name || 'User'}</div>
            <div className="user-role">{currentUser?.role || 'Staff'}</div>
            {!isSuperAdmin && Object.keys(userPermissions).length > 0 && (
              <div style={{fontSize: '9px', color: '#f59e0b', marginTop: '2px'}}>
                Restricted Access
              </div>
            )}
          </div>
        </div>
        <button className="logout-btn" onClick={handleLogout} title="Logout">
          <LogOut size={18} />
        </button>
      </div>
    </div>
  );
  };

  // Dashboard View - Role-based
  const DashboardView = () => {
    const userRole = currentUser?.role || 'Articles';
    const isSuperAdmin = currentUser?.isSuperAdmin || userRole === 'Superadmin';
    const isReportingManager = userRole === 'Reporting Manager';
    const isSeniorOrArticle = userRole === 'Seniors' || userRole === 'Articles';
    
    // Common state for all dashboards
    const [selectedTeamMember, setSelectedTeamMember] = useState('all');
    const [dashboardPeriod, setDashboardPeriod] = useState('thisMonth');
    
    // Get current user's staff record
    const currentStaff = data.staff.find(s => s.email?.toLowerCase() === currentUser?.email?.toLowerCase());
    
    // Debug logging
    console.log('Dashboard Debug:', {
      userRole,
      isSuperAdmin,
      isReportingManager,
      isSeniorOrArticle,
      currentUserName: currentUser?.name,
      currentStaffFound: !!currentStaff,
      currentStaffName: currentStaff?.name,
      totalTasks: data.tasks.length
    });
    
    // Helper to check if a task is assigned to a user
    const isTaskAssignedTo = (task, userName, userId) => {
      return (
        task.primaryAssignedUser === userName ||
        task.primaryAssignedUser === userId ||
        task.assignedTo === userName ||
        task.assignedTo === userId ||
        task.assignedUser === userName ||
        task.assignedUser === userId
      );
    };
    
    // Helper to check if user is task manager
    const isTaskManager = (task, userName, userId) => {
      return (
        task.taskManager === userName ||
        task.taskManager === userId ||
        task.taskLeader === userName ||
        task.taskLeader === userId
      );
    };
    
    // Get team members for Reporting Manager
    const getTeamMembers = () => {
      if (!currentStaff) return [];
      
      // First try: Find staff who have this user as their reporting manager
      let teamMembers = data.staff.filter(s => 
        s.id !== currentStaff.id && // Exclude self
        (s.reportingManager === currentStaff.id || 
         s.reportingManager === currentStaff.name ||
         s.taskManager === currentStaff.name ||
         s.taskManager === currentStaff.id)
      );
      
      // Fallback: If no explicit team members found, include all Seniors and Articles
      // (typical hierarchy: Reporting Manager -> Seniors/Articles)
      if (teamMembers.length === 0) {
        teamMembers = data.staff.filter(s => 
          s.id !== currentStaff.id && 
          s.status === 'Active' &&
          (s.role === 'Seniors' || s.role === 'Articles' || s.role === 'Intern')
        );
      }
      
      console.log('Team Members for', currentStaff?.name, ':', teamMembers.map(m => m.name));
      return teamMembers;
    };
    
    // Filter tasks based on role
    const getFilteredTasks = () => {
      let tasks = data.tasks.filter(t => !t.deleted);
      
      if (isSuperAdmin) {
        return tasks; // All tasks
      }
      
      if (isReportingManager) {
        const teamMembers = getTeamMembers();
        
        if (selectedTeamMember === 'all') {
          // All team tasks + tasks where RM is task manager or assigned
          return tasks.filter(t => {
            // Check if task is assigned to any team member
            const isTeamTask = teamMembers.some(member => 
              isTaskAssignedTo(t, member.name, member.id)
            );
            // Check if current user is task manager or assigned
            const isOwnTask = isTaskManager(t, currentStaff?.name, currentStaff?.id) ||
                              isTaskAssignedTo(t, currentStaff?.name, currentStaff?.id);
            return isTeamTask || isOwnTask;
          });
        } else if (selectedTeamMember === 'self') {
          return tasks.filter(t => 
            isTaskManager(t, currentStaff?.name, currentStaff?.id) ||
            isTaskAssignedTo(t, currentStaff?.name, currentStaff?.id)
          );
        } else {
          // Specific team member
          const member = data.staff.find(s => s.id === selectedTeamMember);
          return tasks.filter(t => 
            isTaskAssignedTo(t, member?.name, member?.id)
          );
        }
      }
      
      if (isSeniorOrArticle) {
        // Only tasks where they are Primary Assigned User
        const userName = currentStaff?.name || currentUser?.name;
        const userId = currentStaff?.id || currentUser?.id;
        
        const myTasks = tasks.filter(t => {
          // Check all possible assignment fields
          const assignedName = t.primaryAssignedUser || t.assignedTo || t.assignedUser || '';
          
          // Exact match
          if (isTaskAssignedTo(t, userName, userId)) return true;
          
          // Partial name match (case insensitive)
          if (userName && assignedName.toLowerCase().includes(userName.toLowerCase())) return true;
          if (userName && userName.toLowerCase().includes(assignedName.toLowerCase()) && assignedName.length > 2) return true;
          
          return false;
        });
        
        console.log('My Tasks found:', myTasks.length, 'for user:', userName);
        console.log('Sample tasks assignedTo values:', tasks.slice(0, 5).map(t => t.primaryAssignedUser || t.assignedTo));
        return myTasks;
      }
      
      return tasks;
    };
    
    const filteredTasks = getFilteredTasks();
    
    // Calculate KPIs
    const today = new Date();
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    
    const kpis = {
      totalTasks: filteredTasks.length,
      openTasks: filteredTasks.filter(t => t.status !== 'Completed' && t.status !== 'In Progress').length,
      inProgressTasks: filteredTasks.filter(t => t.status === 'In Progress').length,
      completedTasks: filteredTasks.filter(t => t.status === 'Completed' || t.completedCheck).length,
      overdueTasks: filteredTasks.filter(t => {
        if (t.status === 'Completed' || t.completedCheck) return false;
        if (!t.dueDate) return false;
        const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
        return dueDate < today;
      }).length,
      completedThisMonth: filteredTasks.filter(t => {
        if (!t.completedDate && !t.completedCheck) return false;
        const compDate = t.completedDate ? new Date(t.completedDate.split('-').reverse().join('-')) : today;
        return compDate >= startOfMonth;
      }).length,
      completedThisWeek: filteredTasks.filter(t => {
        if (!t.completedDate && !t.completedCheck) return false;
        const compDate = t.completedDate ? new Date(t.completedDate.split('-').reverse().join('-')) : today;
        return compDate >= startOfWeek;
      }).length,
      highPriorityPending: filteredTasks.filter(t => 
        t.priority === 'High' && t.status !== 'Completed' && !t.completedCheck
      ).length,
      // Efficiency: Completed on time / Total completed
      efficiency: (() => {
        const completed = filteredTasks.filter(t => t.status === 'Completed' || t.completedCheck);
        if (completed.length === 0) return 0;
        const onTime = completed.filter(t => {
          if (!t.dueDate || !t.completedDate) return true;
          const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
          const compDate = new Date(t.completedDate.split('-').reverse().join('-'));
          return compDate <= dueDate;
        }).length;
        return Math.round((onTime / completed.length) * 100);
      })()
    };
    
    // Billing KPIs (for Superadmin)
    const billingKpis = {
      totalBilled: (data.invoices || []).reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0),
      totalCollected: (data.receipts || []).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0),
      totalOutstanding: 0,
      thisMonthBilling: (data.invoices || []).filter(inv => {
        const invDate = new Date(inv.date);
        return invDate >= startOfMonth;
      }).reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0),
      thisMonthCollection: (data.receipts || []).filter(r => {
        const rDate = new Date(r.date);
        return rDate >= startOfMonth;
      }).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0),
      pendingInvoices: (data.invoices || []).filter(inv => {
        const paid = (data.receipts || [])
          .filter(r => r.invoiceId === inv.id)
          .reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        return paid < (parseFloat(inv.totalAmount) || 0);
      }).length
    };
    billingKpis.totalOutstanding = billingKpis.totalBilled - billingKpis.totalCollected;
    
    // Task status distribution for charts
    // Pastel green shades for pie chart
    const taskStatusData = [
      { name: 'Open', value: kpis.openTasks, color: '#86efac' },          // Light green
      { name: 'In Progress', value: kpis.inProgressTasks, color: '#4ade80' },  // Medium green
      { name: 'Completed', value: kpis.completedTasks, color: '#22c55e' },     // Green
      { name: 'Overdue', value: kpis.overdueTasks, color: '#166534' }          // Dark green
    ];
    
    // Task category distribution
    const taskCategoryData = Object.keys(PARENT_CHILD_TASKS).map(parent => ({
      name: parent,
      value: filteredTasks.filter(t => t.parentTask === parent).length
    })).filter(d => d.value > 0).slice(0, 6);
    
    // Team workload (for RM and Superadmin)
    const teamWorkloadData = (() => {
      if (isSeniorOrArticle) return [];
      const staffToShow = isReportingManager ? getTeamMembers() : data.staff.filter(s => s.status === 'Active');
      return staffToShow.map(staff => {
        const staffTasks = data.tasks.filter(t => 
          !t.deleted && 
          isTaskAssignedTo(t, staff.name, staff.id)
        );
        return {
          name: staff.name.split(' ')[0],
          fullName: staff.name,
          id: staff.id,
          total: staffTasks.length,
          completed: staffTasks.filter(t => t.status === 'Completed' || t.completedCheck).length,
          pending: staffTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length,
          overdue: staffTasks.filter(t => {
            if (t.status === 'Completed' || t.completedCheck) return false;
            if (!t.dueDate) return false;
            const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
            return dueDate < today;
          }).length
        };
      }).sort((a, b) => b.pending - a.pending);
    })();
    
    // Recent tasks for table
    const recentTasks = [...filteredTasks]
      .sort((a, b) => {
        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
        return dateB - dateA;
      })
      .slice(0, 10);
    
    // Overdue tasks
    const overdueTasks = filteredTasks.filter(t => {
      if (t.status === 'Completed' || t.completedCheck) return false;
      if (!t.dueDate) return false;
      const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
      return dueDate < today;
    }).sort((a, b) => {
      const dateA = new Date(a.dueDate.split('-').reverse().join('-'));
      const dateB = new Date(b.dueDate.split('-').reverse().join('-'));
      return dateA - dateB;
    });
    
    // Simple bar chart component
    const SimpleBarChart = ({ data, maxValue, colorKey = 'color' }) => (
      <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
        {data.map((item, idx) => (
          <div key={idx} style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
            <div style={{width: '80px', fontSize: '12px', color: '#64748b', textAlign: 'right'}}>{item.name}</div>
            <div style={{flex: 1, background: '#f1f5f9', borderRadius: '4px', height: '24px', overflow: 'hidden'}}>
              <div style={{
                width: `${maxValue > 0 ? (item.value / maxValue) * 100 : 0}%`,
                height: '100%',
                background: item[colorKey] || '#3b82f6',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'flex-end',
                paddingRight: '8px',
                minWidth: item.value > 0 ? '30px' : '0'
              }}>
                {item.value > 0 && <span style={{fontSize: '11px', color: '#fff', fontWeight: '600'}}>{item.value}</span>}
              </div>
            </div>
          </div>
        ))}
      </div>
    );
    
    // Animated Pie Chart component
    const AnimatedPieChart = ({ data, size = 200 }) => {
      const [hoveredIndex, setHoveredIndex] = React.useState(null);
      const [animationKey, setAnimationKey] = React.useState(0);
      
      const total = data.reduce((sum, d) => sum + d.value, 0);
      if (total === 0) return <div style={{width: size, height: size, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8'}}>No data</div>;
      
      const radius = size / 2 - 10;
      const centerX = size / 2;
      const centerY = size / 2;
      
      let currentAngle = -90; // Start from top
      
      const slices = data.map((item, idx) => {
        const angle = (item.value / total) * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;
        currentAngle = endAngle;
        
        const startRad = startAngle * Math.PI / 180;
        const endRad = endAngle * Math.PI / 180;
        
        const x1 = centerX + radius * Math.cos(startRad);
        const y1 = centerY + radius * Math.sin(startRad);
        const x2 = centerX + radius * Math.cos(endRad);
        const y2 = centerY + radius * Math.sin(endRad);
        
        const largeArc = angle > 180 ? 1 : 0;
        
        const pathD = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
        
        // Calculate label position
        const midAngle = (startAngle + endAngle) / 2;
        const midRad = midAngle * Math.PI / 180;
        const labelRadius = radius * 0.65;
        const labelX = centerX + labelRadius * Math.cos(midRad);
        const labelY = centerY + labelRadius * Math.sin(midRad);
        
        return { ...item, pathD, labelX, labelY, percentage: ((item.value / total) * 100).toFixed(0), idx };
      });
      
      return (
        <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
          <div style={{position: 'relative'}}>
            <svg 
              width={size} 
              height={size} 
              style={{cursor: 'pointer', filter: 'drop-shadow(0 4px 6px rgba(0,0,0,0.1))'}}
              key={animationKey}
            >
              <style>{`
                @keyframes pieSliceGrow {
                  from { transform: scale(0); opacity: 0; }
                  to { transform: scale(1); opacity: 1; }
                }
                .pie-slice {
                  transform-origin: ${centerX}px ${centerY}px;
                  animation: pieSliceGrow 0.6s ease-out forwards;
                  transition: transform 0.2s ease, filter 0.2s ease;
                }
                .pie-slice:hover {
                  transform: scale(1.05);
                  filter: brightness(1.1);
                }
              `}</style>
              {slices.map((slice, idx) => (
                <g key={idx}>
                  <path
                    d={slice.pathD}
                    fill={slice.color}
                    className="pie-slice"
                    style={{
                      animationDelay: `${idx * 0.1}s`,
                      transform: hoveredIndex === idx ? 'scale(1.05)' : 'scale(1)',
                      filter: hoveredIndex === idx ? 'brightness(1.1) drop-shadow(0 4px 8px rgba(0,0,0,0.2))' : 'none'
                    }}
                    onMouseEnter={() => setHoveredIndex(idx)}
                    onMouseLeave={() => setHoveredIndex(null)}
                  />
                  {slice.value > 0 && slice.percentage >= 5 && (
                    <text
                      x={slice.labelX}
                      y={slice.labelY}
                      textAnchor="middle"
                      dominantBaseline="middle"
                      fill="#fff"
                      fontSize="11"
                      fontWeight="600"
                      style={{pointerEvents: 'none', textShadow: '0 1px 2px rgba(0,0,0,0.3)'}}
                    >
                      {slice.value}
                    </text>
                  )}
                </g>
              ))}
            </svg>
            <button
              onClick={() => setAnimationKey(k => k + 1)}
              style={{
                position: 'absolute',
                bottom: '-5px',
                right: '-5px',
                width: '28px',
                height: '28px',
                borderRadius: '50%',
                background: '#fff',
                border: '2px solid #e2e8f0',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'transform 0.2s ease'
              }}
              onMouseEnter={(e) => e.currentTarget.style.transform = 'rotate(180deg)'}
              onMouseLeave={(e) => e.currentTarget.style.transform = 'rotate(0deg)'}
              title="Refresh animation"
            >
              <RefreshCw size={14} style={{color: '#64748b'}} />
            </button>
          </div>
          {/* Legend */}
          <div style={{display: 'flex', flexDirection: 'column', gap: '6px', flex: 1}}>
            {slices.filter(s => s.value > 0).map((slice, idx) => (
              <div 
                key={idx} 
                style={{
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '8px', 
                  padding: '4px 8px',
                  borderRadius: '6px',
                  background: hoveredIndex === slice.idx ? '#f1f5f9' : 'transparent',
                  transition: 'background 0.2s ease',
                  cursor: 'pointer'
                }}
                onMouseEnter={() => setHoveredIndex(slice.idx)}
                onMouseLeave={() => setHoveredIndex(null)}
              >
                <div style={{width: '12px', height: '12px', borderRadius: '3px', background: slice.color, flexShrink: 0}} />
                <span style={{fontSize: '11px', color: '#64748b', flex: 1}}>{slice.name}</span>
                <span style={{fontSize: '11px', fontWeight: '600', color: '#1e293b'}}>{slice.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    };
    
    // Donut chart component
    const SimpleDonutChart = ({ data, size = 120 }) => {
      const total = data.reduce((sum, d) => sum + d.value, 0);
      if (total === 0) return <div style={{width: size, height: size, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8'}}>No data</div>;
      
      let currentAngle = 0;
      const radius = size / 2;
      const innerRadius = radius * 0.6;
      
      return (
        <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
          {data.map((item, idx) => {
            const angle = (item.value / total) * 360;
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;
            currentAngle = endAngle;
            
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            
            const x1 = radius + radius * Math.cos(startRad);
            const y1 = radius + radius * Math.sin(startRad);
            const x2 = radius + radius * Math.cos(endRad);
            const y2 = radius + radius * Math.sin(endRad);
            
            const ix1 = radius + innerRadius * Math.cos(startRad);
            const iy1 = radius + innerRadius * Math.sin(startRad);
            const ix2 = radius + innerRadius * Math.cos(endRad);
            const iy2 = radius + innerRadius * Math.sin(endRad);
            
            const largeArc = angle > 180 ? 1 : 0;
            
            const pathD = `
              M ${x1} ${y1}
              A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}
              L ${ix2} ${iy2}
              A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${ix1} ${iy1}
              Z
            `;
            
            return <path key={idx} d={pathD} fill={item.color} />;
          })}
          <text x={radius} y={radius} textAnchor="middle" dominantBaseline="middle" style={{fontSize: '18px', fontWeight: '700', fill: '#1e293b'}}>{total}</text>
        </svg>
      );
    };
    
    // =====================
    // SUPERADMIN DASHBOARD
    // =====================
    if (isSuperAdmin) {
      return (
        <div className="dashboard-view">
          <div className="view-header">
            <div>
              <h1>Firm Dashboard</h1>
              <p className="view-subtitle">Complete overview of your CA practice â€¢ Superadmin View</p>
            </div>
            <div style={{display: 'flex', gap: '12px'}}>
              <button 
                className="btn-secondary" 
                onClick={() => {
                  if (window.confirm('âš ï¸ Clear ALL data? This will delete all tasks, clients, and staff. This action cannot be undone!')) {
                    localStorage.removeItem('caHubProData');
                    setData(initialData);
                    alert('âœ… All data cleared! Page will refresh.');
                    window.location.reload();
                  }
                }}
                style={{background: '#ef4444', color: 'white', border: 'none'}}
              >
                ðŸ—‘ï¸ Clear All Data
              </button>
              <button className="btn-primary" onClick={() => setShowTimesheetModal(true)} style={{background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', display: 'flex', alignItems: 'center', gap: '8px'}}>
                <Clock size={20} /> Timesheet
              </button>
              <button className="btn-primary" onClick={() => setShowAddTaskModal(true)}>
                <Plus size={20} /> Add New Task
              </button>
            </div>
          </div>

          {/* KPI Cards Row 1 - Tasks */}
          <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '20px'}}>
            <div className="dashboard-card" style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe', transition: 'all 0.3s ease', cursor: 'pointer'}} 
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(59, 130, 246, 0.25)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '13px', color: '#3b82f6', fontWeight: '600', marginBottom: '4px'}}>Total Tasks</div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#1e40af'}}>{kpis.totalTasks}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#3b82f6', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', transition: 'transform 0.3s ease'}} className="card-icon">
                  <FileText size={20} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{kpis.openTasks} open â€¢ {kpis.inProgressTasks} in progress</div>
            </div>
            <div className="dashboard-card" style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(16, 185, 129, 0.25)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '13px', color: '#16a34a', fontWeight: '600', marginBottom: '4px'}}>Completed</div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#166534'}}>{kpis.completedTasks}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#16a34a', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <CheckCircle size={20} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{kpis.completedThisMonth} this month</div>
            </div>
            <div className="dashboard-card" style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(239, 68, 68, 0.25)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '13px', color: '#dc2626', fontWeight: '600', marginBottom: '4px'}}>Overdue</div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#b91c1c'}}>{kpis.overdueTasks}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#ef4444', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <AlertCircle size={20} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{kpis.highPriorityPending} high priority</div>
            </div>
            <div className="dashboard-card" style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(139, 92, 246, 0.25)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '13px', color: '#9333ea', fontWeight: '600', marginBottom: '4px'}}>Active Clients</div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#7c3aed'}}>{data.clients.filter(c => !c.disabled).length}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#8b5cf6', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <Users size={20} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{data.clients.filter(c => c.disabled).length} disabled</div>
            </div>
            <div className="dashboard-card" style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(245, 158, 11, 0.25)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '13px', color: '#d97706', fontWeight: '600', marginBottom: '4px'}}>Active Staff</div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#b45309'}}>{data.staff.filter(s => s.status === 'Active').length}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#f59e0b', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <User size={20} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{kpis.efficiency}% efficiency</div>
            </div>
          </div>

          {/* KPI Cards Row 2 - Billing */}
          <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px'}}>
            <div className="dashboard-card" style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(59, 130, 246, 0.15)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', marginBottom: '4px'}}>Total Billed</div>
                  <div style={{fontSize: '24px', fontWeight: '700', color: '#1e293b'}}>â‚¹{billingKpis.totalBilled.toLocaleString('en-IN')}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#dbeafe', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <FileText size={20} style={{color: '#3b82f6'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#10b981', marginTop: '8px'}}>â‚¹{billingKpis.thisMonthBilling.toLocaleString('en-IN')} this month</div>
            </div>
            <div className="dashboard-card" style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(16, 185, 129, 0.15)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', marginBottom: '4px'}}>Total Collected</div>
                  <div style={{fontSize: '24px', fontWeight: '700', color: '#10b981'}}>â‚¹{billingKpis.totalCollected.toLocaleString('en-IN')}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#dcfce7', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <DollarSign size={20} style={{color: '#10b981'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#10b981', marginTop: '8px'}}>â‚¹{billingKpis.thisMonthCollection.toLocaleString('en-IN')} this month</div>
            </div>
            <div className="dashboard-card" style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(239, 68, 68, 0.15)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', marginBottom: '4px'}}>Outstanding</div>
                  <div style={{fontSize: '24px', fontWeight: '700', color: '#ef4444'}}>â‚¹{billingKpis.totalOutstanding.toLocaleString('en-IN')}</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#fee2e2', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <AlertCircle size={20} style={{color: '#ef4444'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{billingKpis.pendingInvoices} pending invoices</div>
            </div>
            <div className="dashboard-card" style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', transition: 'all 0.3s ease', cursor: 'pointer'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.boxShadow = '0 10px 25px rgba(139, 92, 246, 0.15)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)'; }}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', marginBottom: '4px'}}>Collection Rate</div>
                  <div style={{fontSize: '24px', fontWeight: '700', color: '#8b5cf6'}}>{billingKpis.totalBilled > 0 ? Math.round((billingKpis.totalCollected / billingKpis.totalBilled) * 100) : 0}%</div>
                </div>
                <div style={{width: '40px', height: '40px', background: '#ede9fe', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <TrendingUp size={20} style={{color: '#8b5cf6'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>Of total billing</div>
            </div>
          </div>

          {/* Charts Row */}
          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px', marginBottom: '24px'}}>
            {/* Task Status Chart */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', transition: 'all 0.3s ease'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.08)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>Task Status Distribution</h3>
              <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                <SimpleDonutChart data={taskStatusData} size={100} />
                <div style={{flex: 1}}>
                  {taskStatusData.map((item, idx) => (
                    <div key={idx} style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <div style={{width: '10px', height: '10px', borderRadius: '2px', background: item.color}}></div>
                        <span style={{fontSize: '12px', color: '#64748b'}}>{item.name}</span>
                      </div>
                      <span style={{fontSize: '12px', fontWeight: '600', color: '#1e293b'}}>{item.value}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Task Categories Chart - Pie Chart with Pastel Green Shades */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', transition: 'all 0.3s ease'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.08)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>Tasks by Category</h3>
              <AnimatedPieChart 
                data={taskCategoryData.filter(d => d.value > 0).map((d, i) => ({...d, color: ['#dcfce7', '#bbf7d0', '#86efac', '#4ade80', '#22c55e', '#16a34a', '#15803d', '#166534'][i % 8]}))} 
                size={180}
              />
            </div>

            {/* Staff Workload - Pastel Colors */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0', transition: 'all 0.3s ease'}}
              onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.08)'; }}
              onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>Staff Workload (Pending)</h3>
              <SimpleBarChart 
                data={teamWorkloadData.slice(0, 6).map((d, i) => ({name: d.name, value: d.pending, color: d.overdue > 0 ? '#fca5a5' : ['#86efac', '#93c5fd', '#c4b5fd', '#fcd34d', '#a5f3fc', '#fda4af'][i % 6]}))} 
                maxValue={Math.max(...teamWorkloadData.map(d => d.pending), 1)} 
              />
            </div>
          </div>

          {/* DSC & Package Due/Expired Tables - 2x2 Grid */}
          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'}}>
            {/* DSC Due for Renewal */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#d97706', display: 'flex', alignItems: 'center', gap: '8px'}}>
                <Key size={16} /> DSC Due for Renewal ({(() => {
                  const dscRecords = data.dscRegister || [];
                  return dscRecords.filter(d => {
                    if (!d.expiryDate) return false;
                    const expiry = new Date(d.expiryDate);
                    const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    return daysLeft >= 0 && daysLeft <= 60;
                  }).length;
                })()})
              </h3>
              <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                {(() => {
                  const dscRecords = data.dscRegister || [];
                  const dueDsc = dscRecords.filter(d => {
                    if (!d.expiryDate) return false;
                    const expiry = new Date(d.expiryDate);
                    const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    return daysLeft >= 0 && daysLeft <= 60;
                  }).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                  
                  if (dueDsc.length === 0) {
                    return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No DSC due for renewal</div>;
                  }
                  
                  return (
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                      <thead>
                        <tr style={{background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}}>
                          <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client/Holder</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expiry</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days</th>
                        </tr>
                      </thead>
                      <tbody>
                        {dueDsc.slice(0, 5).map((dsc, idx) => {
                          const expiry = new Date(dsc.expiryDate);
                          const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                          return (
                            <tr key={dsc.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef9e7'}}>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb'}}>
                                <div style={{fontWeight: '500', fontSize: '11px'}}>{dsc.clientName}</div>
                                <div style={{fontSize: '10px', color: '#64748b'}}>{dsc.holderName}</div>
                              </td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{expiry.toLocaleDateString('en-IN')}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', 
                                color: daysLeft <= 15 ? '#dc2626' : daysLeft <= 30 ? '#d97706' : '#059669'
                              }}>{daysLeft}d</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  );
                })()}
              </div>
              <button onClick={() => setCurrentView('dscRegister')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fef3c7', color: '#92400e', border: '1px solid #f59e0b', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                View DSC Register â†’
              </button>
            </div>
            
            {/* DSC Expired */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#dc2626', display: 'flex', alignItems: 'center', gap: '8px'}}>
                <Key size={16} /> DSC Expired ({(() => {
                  const dscRecords = data.dscRegister || [];
                  return dscRecords.filter(d => {
                    if (!d.expiryDate) return false;
                    return new Date(d.expiryDate) < today;
                  }).length;
                })()})
              </h3>
              <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                {(() => {
                  const dscRecords = data.dscRegister || [];
                  const expiredDsc = dscRecords.filter(d => {
                    if (!d.expiryDate) return false;
                    return new Date(d.expiryDate) < today;
                  }).sort((a, b) => new Date(b.expiryDate) - new Date(a.expiryDate));
                  
                  if (expiredDsc.length === 0) {
                    return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No expired DSC ðŸŽ‰</div>;
                  }
                  
                  return (
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                      <thead>
                        <tr style={{background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}}>
                          <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client/Holder</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expired On</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days Ago</th>
                        </tr>
                      </thead>
                      <tbody>
                        {expiredDsc.slice(0, 5).map((dsc, idx) => {
                          const expiry = new Date(dsc.expiryDate);
                          const daysAgo = Math.ceil((today - expiry) / (1000 * 60 * 60 * 24));
                          return (
                            <tr key={dsc.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef2f2'}}>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb'}}>
                                <div style={{fontWeight: '500', fontSize: '11px'}}>{dsc.clientName}</div>
                                <div style={{fontSize: '10px', color: '#64748b'}}>{dsc.holderName}</div>
                              </td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{expiry.toLocaleDateString('en-IN')}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', color: '#dc2626'}}>{daysAgo}d</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  );
                })()}
              </div>
              <button onClick={() => setCurrentView('dscRegister')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fee2e2', color: '#991b1b', border: '1px solid #fca5a5', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                View DSC Register â†’
              </button>
            </div>

            {/* Package Due for Renewal */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#d97706', display: 'flex', alignItems: 'center', gap: '8px'}}>
                ðŸ“¦ Packages Due for Renewal ({(() => {
                  const pkgs = (data.packages || []).filter(p => !p.renewed);
                  const sixtyDays = new Date(today.getTime() + (60 * 24 * 60 * 60 * 1000));
                  return pkgs.filter(p => {
                    const ed = new Date(p.endDate);
                    return ed <= sixtyDays && ed >= today;
                  }).length;
                })()})
              </h3>
              <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                {(() => {
                  const pkgs = (data.packages || []).filter(p => !p.renewed);
                  const sixtyDays = new Date(today.getTime() + (60 * 24 * 60 * 60 * 1000));
                  const duePkgs = pkgs.filter(p => {
                    const ed = new Date(p.endDate);
                    return ed <= sixtyDays && ed >= today;
                  }).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                  
                  if (duePkgs.length === 0) {
                    return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No packages due for renewal ðŸŽ‰</div>;
                  }
                  
                  return (
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                      <thead>
                        <tr style={{background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}}>
                          <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>End Date</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days</th>
                          <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        {duePkgs.slice(0, 5).map((pkg, idx) => {
                          const endDate = new Date(pkg.endDate);
                          const daysLeft = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                          return (
                            <tr key={pkg.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef9e7'}}>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', fontWeight: '500', fontSize: '11px'}}>{pkg.clientName}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{endDate.toLocaleDateString('en-IN')}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', 
                                color: daysLeft <= 15 ? '#dc2626' : daysLeft <= 30 ? '#d97706' : '#059669'
                              }}>{daysLeft}d</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'right', fontWeight: '600', color: '#059669'}}>â‚¹{(pkg.totalAmount || 0).toLocaleString('en-IN')}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  );
                })()}
              </div>
              <button onClick={() => setCurrentView('packages')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fef3c7', color: '#92400e', border: '1px solid #f59e0b', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                View All Packages â†’
              </button>
            </div>
            
            {/* Package Expired */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#dc2626', display: 'flex', alignItems: 'center', gap: '8px'}}>
                âš ï¸ Expired Packages ({(() => {
                  const pkgs = (data.packages || []).filter(p => !p.renewed);
                  return pkgs.filter(p => new Date(p.endDate) < today).length;
                })()})
              </h3>
              <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                {(() => {
                  const pkgs = (data.packages || []).filter(p => !p.renewed);
                  const expiredPkgs = pkgs.filter(p => new Date(p.endDate) < today)
                    .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                  
                  if (expiredPkgs.length === 0) {
                    return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No expired packages ðŸŽ‰</div>;
                  }
                  
                  return (
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                      <thead>
                        <tr style={{background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}}>
                          <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expired On</th>
                          <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days Ago</th>
                          <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        {expiredPkgs.slice(0, 5).map((pkg, idx) => {
                          const endDate = new Date(pkg.endDate);
                          const daysAgo = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
                          return (
                            <tr key={pkg.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef2f2'}}>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', fontWeight: '500', fontSize: '11px'}}>{pkg.clientName}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{endDate.toLocaleDateString('en-IN')}</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', color: '#dc2626'}}>{daysAgo}d</td>
                              <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'right', fontWeight: '600', color: '#059669'}}>â‚¹{(pkg.totalAmount || 0).toLocaleString('en-IN')}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  );
                })()}
              </div>
              <button onClick={() => setCurrentView('packages')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fee2e2', color: '#991b1b', border: '1px solid #fca5a5', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                View All Packages â†’
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ===========================
    // REPORTING MANAGER DASHBOARD
    // ===========================
    if (isReportingManager) {
      const teamMembers = getTeamMembers();
      
      return (
        <div className="dashboard-view">
          <div className="view-header">
            <div>
              <h1>Team Dashboard</h1>
              <p className="view-subtitle">Monitor your team's performance â€¢ {teamMembers.length} team members</p>
            </div>
            <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
              {/* Team Member Filter */}
              <select
                value={selectedTeamMember}
                onChange={(e) => setSelectedTeamMember(e.target.value)}
                style={{padding: '10px 16px', borderRadius: '8px', border: '2px solid #e2e8f0', fontSize: '13px', minWidth: '180px'}}
              >
                <option value="all">ðŸ‘¥ All Team Members</option>
                <option value="self">ðŸ‘¤ My Tasks Only</option>
                {teamMembers.map(member => (
                  <option key={member.id} value={member.id}>{member.name}</option>
                ))}
              </select>
              <button className="btn-primary" onClick={() => setShowTimesheetModal(true)} style={{background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', display: 'flex', alignItems: 'center', gap: '8px'}}>
                <Clock size={20} /> Timesheet
              </button>
              {hasActionPermission('canCreateTask') && (
                <button className="btn-primary" onClick={() => setShowAddTaskModal(true)}>
                  <Plus size={20} /> Add Task
                </button>
              )}
            </div>
          </div>

          {/* KPI Cards */}
          <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px'}}>
            <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#1e40af'}}>{kpis.totalTasks}</div>
                  <div style={{fontSize: '12px', color: '#3b82f6', fontWeight: '600'}}>Total Tasks</div>
                </div>
                <div style={{width: '36px', height: '36px', background: '#3b82f6', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <FileText size={18} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{selectedTeamMember === 'all' ? 'Team total' : selectedTeamMember === 'self' ? 'Your tasks' : 'Member tasks'}</div>
            </div>
            <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#b45309'}}>{kpis.openTasks + kpis.inProgressTasks}</div>
                  <div style={{fontSize: '12px', color: '#d97706', fontWeight: '600'}}>Pending</div>
                </div>
                <div style={{width: '36px', height: '36px', background: '#f59e0b', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <Clock size={18} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>{kpis.openTasks} open â€¢ {kpis.inProgressTasks} in progress</div>
            </div>
            <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#166534'}}>{kpis.completedTasks}</div>
                  <div style={{fontSize: '12px', color: '#16a34a', fontWeight: '600'}}>Completed</div>
                </div>
                <div style={{width: '36px', height: '36px', background: '#16a34a', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <CheckCircle size={18} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#16a34a', marginTop: '8px'}}>{kpis.completedThisWeek} this week</div>
            </div>
            <div style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#b91c1c'}}>{kpis.overdueTasks}</div>
                  <div style={{fontSize: '12px', color: '#dc2626', fontWeight: '600'}}>Overdue</div>
                </div>
                <div style={{width: '36px', height: '36px', background: '#ef4444', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <AlertCircle size={18} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#dc2626', marginTop: '8px'}}>{kpis.highPriorityPending} high priority</div>
            </div>
            <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                <div>
                  <div style={{fontSize: '28px', fontWeight: '700', color: '#7c3aed'}}>{kpis.efficiency}%</div>
                  <div style={{fontSize: '12px', color: '#9333ea', fontWeight: '600'}}>On-Time Rate</div>
                </div>
                <div style={{width: '36px', height: '36px', background: '#8b5cf6', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <TrendingUp size={18} style={{color: '#fff'}} />
                </div>
              </div>
              <div style={{fontSize: '11px', color: '#64748b', marginTop: '8px'}}>Tasks completed on time</div>
            </div>
          </div>

          {/* Team Overview & Charts */}
          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px'}}>
            {/* Team Members Table */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>ðŸ‘¥ Team Members ({teamMembers.length})</h3>
              <div style={{overflowX: 'auto'}}>
                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                  <thead>
                    <tr style={{background: '#f8fafc'}}>
                      <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Name</th>
                      <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Total</th>
                      <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Pending</th>
                      <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Overdue</th>
                      <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Done</th>
                    </tr>
                  </thead>
                  <tbody>
                    {teamWorkloadData.map((member, idx) => (
                      <tr key={idx} style={{borderBottom: '1px solid #f1f5f9', cursor: 'pointer'}} onClick={() => {
                        if (member.id) setSelectedTeamMember(member.id);
                      }}>
                        <td style={{padding: '10px 12px', fontWeight: '500'}}>{member.fullName || member.name}</td>
                        <td style={{padding: '10px 12px', textAlign: 'center'}}>{member.total}</td>
                        <td style={{padding: '10px 12px', textAlign: 'center', color: '#f59e0b', fontWeight: '600'}}>{member.pending}</td>
                        <td style={{padding: '10px 12px', textAlign: 'center', color: member.overdue > 0 ? '#ef4444' : '#10b981', fontWeight: '600'}}>{member.overdue}</td>
                        <td style={{padding: '10px 12px', textAlign: 'center', color: '#10b981'}}>{member.completed}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Task Status Chart */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>Task Status Distribution</h3>
              <div style={{display: 'flex', alignItems: 'center', gap: '30px'}}>
                <SimpleDonutChart data={taskStatusData} size={120} />
                <div style={{flex: 1}}>
                  {taskStatusData.map((item, idx) => (
                    <div key={idx} style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px', padding: '8px 12px', background: '#f8fafc', borderRadius: '6px'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <div style={{width: '12px', height: '12px', borderRadius: '3px', background: item.color}}></div>
                        <span style={{fontSize: '13px', color: '#475569'}}>{item.name}</span>
                      </div>
                      <span style={{fontSize: '14px', fontWeight: '700', color: '#1e293b'}}>{item.value}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Tasks Tables */}
          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
            {/* Pending Tasks */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
              <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: '#f59e0b'}}>ðŸ“‹ Pending Tasks ({kpis.openTasks + kpis.inProgressTasks})</h3>
              <div style={{maxHeight: '300px', overflowY: 'auto'}}>
                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                  <thead style={{position: 'sticky', top: 0, background: '#fff'}}>
                    <tr style={{background: '#fffbeb'}}>
                      <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #fde68a'}}>Task</th>
                      <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #fde68a'}}>Assigned To</th>
                      <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #fde68a'}}>Due</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).slice(0, 10).map(task => (
                      <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                        <td style={{padding: '10px 12px'}}>{task.childTask || task.parentTask}</td>
                        <td style={{padding: '10px 12px', color: '#64748b'}}>{task.primaryAssignedUser || task.assignedTo || task.assignedUser || '-'}</td>
                        <td style={{padding: '10px 12px', color: task.dueDate && new Date(task.dueDate.split('-').reverse().join('-')) < today ? '#ef4444' : '#64748b'}}>{task.dueDate || '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* DSC Due for Renewal & Expired Tables */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px'}}>
              {/* DSC Due for Renewal */}
              <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#d97706', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  <Key size={16} /> DSC Due for Renewal ({(() => {
                    const dscRecords = data.dscRegister || [];
                    const todayNow = new Date();
                    return dscRecords.filter(d => {
                      if (!d.expiryDate) return false;
                      const expiry = new Date(d.expiryDate);
                      const daysLeft = Math.ceil((expiry - todayNow) / (1000 * 60 * 60 * 24));
                      return daysLeft >= 0 && daysLeft <= 60;
                    }).length;
                  })()})
                </h3>
                <div style={{maxHeight: '180px', overflowY: 'auto'}}>
                  {(() => {
                    const dscRecords = data.dscRegister || [];
                    const todayNow = new Date();
                    const dueDsc = dscRecords.filter(d => {
                      if (!d.expiryDate) return false;
                      const expiry = new Date(d.expiryDate);
                      const daysLeft = Math.ceil((expiry - todayNow) / (1000 * 60 * 60 * 24));
                      return daysLeft >= 0 && daysLeft <= 60;
                    }).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                    
                    if (dueDsc.length === 0) {
                      return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No DSC due for renewal</div>;
                    }
                    
                    return (
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                        <thead>
                          <tr style={{background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}}>
                            <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client/Holder</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expiry</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days</th>
                          </tr>
                        </thead>
                        <tbody>
                          {dueDsc.slice(0, 5).map((dsc, idx) => {
                            const expiry = new Date(dsc.expiryDate);
                            const daysLeft = Math.ceil((expiry - todayNow) / (1000 * 60 * 60 * 24));
                            return (
                              <tr key={dsc.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef9e7'}}>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb'}}>
                                  <div style={{fontWeight: '500', fontSize: '11px'}}>{dsc.clientName}</div>
                                  <div style={{fontSize: '10px', color: '#64748b'}}>{dsc.holderName}</div>
                                </td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{expiry.toLocaleDateString('en-IN')}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', 
                                  color: daysLeft <= 15 ? '#dc2626' : daysLeft <= 30 ? '#d97706' : '#059669'
                                }}>{daysLeft}d</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    );
                  })()}
                </div>
                <button onClick={() => setCurrentView('dscRegister')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fef3c7', color: '#92400e', border: '1px solid #f59e0b', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                  View DSC Register â†’
                </button>
              </div>
              
              {/* DSC Expired */}
              <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#dc2626', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  <Key size={16} /> DSC Expired ({(() => {
                    const dscRecords = data.dscRegister || [];
                    const todayNow = new Date();
                    return dscRecords.filter(d => {
                      if (!d.expiryDate) return false;
                      return new Date(d.expiryDate) < todayNow;
                    }).length;
                  })()})
                </h3>
                <div style={{maxHeight: '180px', overflowY: 'auto'}}>
                  {(() => {
                    const dscRecords = data.dscRegister || [];
                    const todayNow = new Date();
                    const expiredDsc = dscRecords.filter(d => {
                      if (!d.expiryDate) return false;
                      return new Date(d.expiryDate) < todayNow;
                    }).sort((a, b) => new Date(b.expiryDate) - new Date(a.expiryDate));
                    
                    if (expiredDsc.length === 0) {
                      return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No expired DSC ðŸŽ‰</div>;
                    }
                    
                    return (
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                        <thead>
                          <tr style={{background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}}>
                            <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client/Holder</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expired On</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days Ago</th>
                          </tr>
                        </thead>
                        <tbody>
                          {expiredDsc.slice(0, 5).map((dsc, idx) => {
                            const expiry = new Date(dsc.expiryDate);
                            const daysAgo = Math.ceil((todayNow - expiry) / (1000 * 60 * 60 * 24));
                            return (
                              <tr key={dsc.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef2f2'}}>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb'}}>
                                  <div style={{fontWeight: '500', fontSize: '11px'}}>{dsc.clientName}</div>
                                  <div style={{fontSize: '10px', color: '#64748b'}}>{dsc.holderName}</div>
                                </td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{expiry.toLocaleDateString('en-IN')}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', color: '#dc2626'}}>{daysAgo}d</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    );
                  })()}
                </div>
                <button onClick={() => setCurrentView('dscRegister')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fee2e2', color: '#991b1b', border: '1px solid #fca5a5', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                  View DSC Register â†’
                </button>
              </div>
            </div>

            {/* Package Due for Renewal & Expired Tables */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px'}}>
              {/* Package Due for Renewal */}
              <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#d97706', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  ðŸ“¦ Packages Due for Renewal ({(() => {
                    const pkgs = (data.packages || []).filter(p => !p.renewed);
                    const todayNow = new Date();
                    const sixtyDays = new Date(todayNow.getTime() + (60 * 24 * 60 * 60 * 1000));
                    return pkgs.filter(p => {
                      const ed = new Date(p.endDate);
                      return ed <= sixtyDays && ed >= todayNow;
                    }).length;
                  })()})
                </h3>
                <div style={{maxHeight: '180px', overflowY: 'auto'}}>
                  {(() => {
                    const pkgs = (data.packages || []).filter(p => !p.renewed);
                    const todayNow = new Date();
                    const sixtyDays = new Date(todayNow.getTime() + (60 * 24 * 60 * 60 * 1000));
                    const duePkgs = pkgs.filter(p => {
                      const ed = new Date(p.endDate);
                      return ed <= sixtyDays && ed >= todayNow;
                    }).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                    
                    if (duePkgs.length === 0) {
                      return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No packages due for renewal ðŸŽ‰</div>;
                    }
                    
                    return (
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                        <thead>
                          <tr style={{background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}}>
                            <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>End Date</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days</th>
                            <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {duePkgs.slice(0, 5).map((pkg, idx) => {
                            const endDate = new Date(pkg.endDate);
                            const daysLeft = Math.floor((endDate - todayNow) / (1000 * 60 * 60 * 24));
                            return (
                              <tr key={pkg.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef9e7'}}>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', fontWeight: '500', fontSize: '11px'}}>{pkg.clientName}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{endDate.toLocaleDateString('en-IN')}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', 
                                  color: daysLeft <= 15 ? '#dc2626' : daysLeft <= 30 ? '#d97706' : '#059669'
                                }}>{daysLeft}d</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'right', fontWeight: '600', color: '#059669'}}>â‚¹{(pkg.totalAmount || 0).toLocaleString('en-IN')}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    );
                  })()}
                </div>
                <button onClick={() => setCurrentView('packages')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fef3c7', color: '#92400e', border: '1px solid #f59e0b', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                  View All Packages â†’
                </button>
              </div>
              
              {/* Package Expired */}
              <div style={{background: '#fff', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <h3 style={{margin: '0 0 12px', fontSize: '13px', fontWeight: '600', color: '#dc2626', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  âš ï¸ Expired Packages ({(() => {
                    const pkgs = (data.packages || []).filter(p => !p.renewed);
                    const todayNow = new Date();
                    return pkgs.filter(p => new Date(p.endDate) < todayNow).length;
                  })()})
                </h3>
                <div style={{maxHeight: '180px', overflowY: 'auto'}}>
                  {(() => {
                    const pkgs = (data.packages || []).filter(p => !p.renewed);
                    const todayNow = new Date();
                    const expiredPkgs = pkgs.filter(p => new Date(p.endDate) < todayNow)
                      .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                    
                    if (expiredPkgs.length === 0) {
                      return <div style={{textAlign: 'center', padding: '20px', color: '#10b981', fontSize: '12px'}}>No expired packages ðŸŽ‰</div>;
                    }
                    
                    return (
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                        <thead>
                          <tr style={{background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}}>
                            <th style={{padding: '6px 8px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Expired On</th>
                            <th style={{padding: '6px 8px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Days Ago</th>
                            <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {expiredPkgs.slice(0, 5).map((pkg, idx) => {
                            const endDate = new Date(pkg.endDate);
                            const daysAgo = Math.floor((todayNow - endDate) / (1000 * 60 * 60 * 24));
                            return (
                              <tr key={pkg.id} style={{background: idx % 2 === 0 ? '#fff' : '#fef2f2'}}>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', fontWeight: '500', fontSize: '11px'}}>{pkg.clientName}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontSize: '10px'}}>{endDate.toLocaleDateString('en-IN')}</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'center', fontWeight: '600', color: '#dc2626'}}>{daysAgo}d</td>
                                <td style={{padding: '5px 8px', borderBottom: '1px solid #e5e7eb', textAlign: 'right', fontWeight: '600', color: '#059669'}}>â‚¹{(pkg.totalAmount || 0).toLocaleString('en-IN')}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    );
                  })()}
                </div>
                <button onClick={() => setCurrentView('packages')} style={{marginTop: '8px', width: '100%', padding: '8px', background: '#fee2e2', color: '#991b1b', border: '1px solid #fca5a5', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>
                  View All Packages â†’
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }
    
    // ==============================
    // SENIOR / ARTICLE DASHBOARD
    // ==============================
    return (
      <div className="dashboard-view">
        <div className="view-header">
          <div>
            <h1>My Dashboard</h1>
            <p className="view-subtitle">Your personal task overview â€¢ {currentUser?.role}</p>
          </div>
          <div style={{display: 'flex', gap: '12px'}}>
            <button className="btn-primary" onClick={() => setShowTimesheetModal(true)} style={{background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', display: 'flex', alignItems: 'center', gap: '8px'}}>
              <Clock size={20} /> Fill Timesheet
            </button>
            {hasActionPermission('canCreateTask') && (
              <button className="btn-primary" onClick={() => setShowAddTaskModal(true)}>
                <Plus size={20} /> Add Task
              </button>
            )}
          </div>
        </div>

        {/* Personal KPI Cards */}
        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px'}}>
          <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '16px', padding: '24px', border: '1px solid #bfdbfe'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
              <div>
                <div style={{fontSize: '36px', fontWeight: '700', color: '#1e40af'}}>{kpis.totalTasks}</div>
                <div style={{fontSize: '14px', color: '#3b82f6', marginTop: '4px'}}>My Total Tasks</div>
              </div>
              <div style={{width: '48px', height: '48px', background: '#3b82f6', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                <CheckCircle size={24} style={{color: '#fff'}} />
              </div>
            </div>
            <div style={{marginTop: '16px', padding: '8px 12px', background: 'rgba(59,130,246,0.1)', borderRadius: '8px', fontSize: '12px', color: '#1e40af'}}>
              {kpis.openTasks} open â€¢ {kpis.inProgressTasks} in progress
            </div>
          </div>

          <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '16px', padding: '24px', border: '1px solid #fde68a'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
              <div>
                <div style={{fontSize: '36px', fontWeight: '700', color: '#b45309'}}>{kpis.openTasks + kpis.inProgressTasks}</div>
                <div style={{fontSize: '14px', color: '#d97706', marginTop: '4px'}}>Pending Work</div>
              </div>
              <div style={{width: '48px', height: '48px', background: '#f59e0b', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                <Clock size={24} style={{color: '#fff'}} />
              </div>
            </div>
            <div style={{marginTop: '16px'}}>
              <div style={{height: '6px', background: 'rgba(245,158,11,0.2)', borderRadius: '3px', overflow: 'hidden'}}>
                <div style={{height: '100%', width: `${kpis.totalTasks > 0 ? ((kpis.openTasks + kpis.inProgressTasks) / kpis.totalTasks) * 100 : 0}%`, background: '#f59e0b', borderRadius: '3px'}}></div>
              </div>
              <div style={{fontSize: '11px', color: '#92400e', marginTop: '6px'}}>{kpis.totalTasks > 0 ? Math.round(((kpis.openTasks + kpis.inProgressTasks) / kpis.totalTasks) * 100) : 0}% of total tasks</div>
            </div>
          </div>

          <div style={{background: kpis.overdueTasks > 0 ? 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)' : 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '16px', padding: '24px', border: kpis.overdueTasks > 0 ? '1px solid #fecaca' : '1px solid #bbf7d0'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
              <div>
                <div style={{fontSize: '36px', fontWeight: '700', color: kpis.overdueTasks > 0 ? '#b91c1c' : '#166534'}}>{kpis.overdueTasks}</div>
                <div style={{fontSize: '14px', color: kpis.overdueTasks > 0 ? '#dc2626' : '#16a34a', marginTop: '4px'}}>Overdue</div>
              </div>
              <div style={{width: '48px', height: '48px', background: kpis.overdueTasks > 0 ? '#ef4444' : '#16a34a', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                {kpis.overdueTasks > 0 ? <AlertCircle size={24} style={{color: '#fff'}} /> : <CheckCircle size={24} style={{color: '#fff'}} />}
              </div>
            </div>
            {kpis.overdueTasks > 0 && (
              <div style={{marginTop: '16px', padding: '8px 12px', background: '#fef2f2', borderRadius: '8px', fontSize: '12px', color: '#ef4444'}}>
                âš ï¸ Action required immediately
              </div>
            )}
          </div>

          <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '16px', padding: '24px', border: '1px solid #bbf7d0'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
              <div>
                <div style={{fontSize: '36px', fontWeight: '700', color: '#166534'}}>{kpis.efficiency}%</div>
                <div style={{fontSize: '14px', color: '#16a34a', marginTop: '4px'}}>On-Time Rate</div>
              </div>
              <div style={{width: '48px', height: '48px', background: '#16a34a', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                <TrendingUp size={24} style={{color: '#fff'}} />
              </div>
            </div>
            <div style={{marginTop: '16px', padding: '8px 12px', background: 'rgba(22,163,106,0.1)', borderRadius: '8px', fontSize: '12px', color: '#166534'}}>
              {kpis.completedThisWeek} completed this week
            </div>
          </div>
        </div>

        {/* Task Status & Categories */}
        <div style={{display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '20px', marginBottom: '24px'}}>
          {/* Status Overview */}
          <div style={{background: '#fff', borderRadius: '12px', padding: '24px', border: '1px solid #e2e8f0'}}>
            <h3 style={{margin: '0 0 20px', fontSize: '15px', fontWeight: '600', color: '#1e293b'}}>Task Status</h3>
            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '20px'}}>
              <SimpleDonutChart data={taskStatusData} size={140} />
            </div>
            <div>
              {taskStatusData.map((item, idx) => (
                <div key={idx} style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 0', borderBottom: idx < taskStatusData.length - 1 ? '1px solid #f1f5f9' : 'none'}}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                    <div style={{width: '12px', height: '12px', borderRadius: '3px', background: item.color}}></div>
                    <span style={{fontSize: '13px', color: '#475569'}}>{item.name}</span>
                  </div>
                  <span style={{fontSize: '14px', fontWeight: '700', color: '#1e293b'}}>{item.value}</span>
                </div>
              ))}
            </div>
          </div>

          {/* My Tasks Table */}
          <div style={{background: '#fff', borderRadius: '12px', padding: '24px', border: '1px solid #e2e8f0'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
              <h3 style={{margin: 0, fontSize: '15px', fontWeight: '600', color: '#1e293b'}}>My Tasks</h3>
              <span style={{fontSize: '12px', color: '#64748b'}}>{filteredTasks.filter(t => t.status !== 'Completed').length} pending</span>
            </div>
            <div style={{maxHeight: '350px', overflowY: 'auto'}}>
              <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                <thead style={{position: 'sticky', top: 0, background: '#fff'}}>
                  <tr style={{background: '#f8fafc'}}>
                    <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task</th>
                    <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                    <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Date</th>
                    <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                    <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Priority</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredTasks.filter(t => t.status !== 'Completed').slice(0, 15).map(task => {
                    const isOverdue = task.dueDate && new Date(task.dueDate.split('-').reverse().join('-')) < today;
                    return (
                      <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9', background: isOverdue ? '#fef2f2' : 'transparent'}}>
                        <td style={{padding: '12px'}}>
                          <div style={{fontWeight: '500'}}>{task.childTask || task.parentTask}</div>
                          <div style={{fontSize: '11px', color: '#94a3b8'}}>{task.parentTask}</div>
                        </td>
                        <td style={{padding: '12px', color: '#64748b'}}>{task.client || '-'}</td>
                        <td style={{padding: '12px', color: isOverdue ? '#ef4444' : '#64748b', fontWeight: isOverdue ? '600' : '400'}}>{task.dueDate || '-'}</td>
                        <td style={{padding: '12px', textAlign: 'center'}}>
                          <span style={{
                            padding: '4px 10px',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: '600',
                            background: task.status === 'In Progress' ? '#fef3c7' : '#dbeafe',
                            color: task.status === 'In Progress' ? '#92400e' : '#1d4ed8'
                          }}>{task.status || 'Open'}</span>
                        </td>
                        <td style={{padding: '12px', textAlign: 'center'}}>
                          <span style={{
                            padding: '4px 10px',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: '600',
                            background: task.priority === 'High' ? '#fee2e2' : task.priority === 'Medium' ? '#fef3c7' : '#f1f5f9',
                            color: task.priority === 'High' ? '#dc2626' : task.priority === 'Medium' ? '#d97706' : '#64748b'
                          }}>{task.priority || 'Normal'}</span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* Quick Access */}
        <div style={{background: '#fff', borderRadius: '12px', padding: '24px', border: '1px solid #e2e8f0'}}>
          <h3 style={{margin: '0 0 16px', fontSize: '15px', fontWeight: '600', color: '#1e293b'}}>Quick Access - My Task Categories</h3>
          <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '12px'}}>
            {Object.keys(PARENT_CHILD_TASKS).slice(0, 6).map(parent => {
              const count = filteredTasks.filter(t => t.parentTask === parent && t.status !== 'Completed').length;
              return (
                <div 
                  key={parent} 
                  onClick={() => {
                    setSelectedParentTask(parent);
                    setSelectedChildTask(PARENT_CHILD_TASKS[parent][0]);
                    setCurrentView('task-detail');
                  }}
                  style={{
                    padding: '16px',
                    background: count > 0 ? '#eff6ff' : '#f8fafc',
                    borderRadius: '10px',
                    cursor: 'pointer',
                    border: count > 0 ? '1px solid #bfdbfe' : '1px solid #e2e8f0',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{fontSize: '20px', fontWeight: '700', color: count > 0 ? '#3b82f6' : '#94a3b8'}}>{count}</div>
                  <div style={{fontSize: '12px', color: '#64748b', marginTop: '4px'}}>{parent}</div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };


  // Task Detail View (with search filters and table)
  const TaskDetailView = () => {
    const [activeStatusFilter, setActiveStatusFilter] = useState('');
    const [selectedTasks, setSelectedTasks] = useState([]);
    const [showBulkUpdateModal, setShowBulkUpdateModal] = useState(false);
    const [bulkUpdateData, setBulkUpdateData] = useState({
      taskManager: '',
      assignedUser: '',
      status: ''
    });
    const [showRecurringModal, setShowRecurringModal] = useState(false);
    const [recurringData, setRecurringData] = useState({
      batchName: '',
      selectedClients: [],
      financialYear: 'FY 2024-25',
      period: 'Monthly',
      subPeriods: [],
      taskManager: '',
      assignedUser: '',
      startDate: '',
      dueDate: '',
      description: '',
      // Auto-creation settings
      autoCreate: false,
      autoCreateDay: '1',
      autoCreateTime: '09:00',
      isScheduled: false
    });
    const [clientSearchTerm, setClientSearchTerm] = useState('');
    const [clientSelectionView, setClientSelectionView] = useState('list'); // 'list' or 'upload'
    const [uploadedClients, setUploadedClients] = useState([]);
    
    // Filter tasks by category AND user visibility
    const allTasks = data.tasks.filter(task => 
      task.parentTask === selectedParentTask && 
      task.childTask === selectedChildTask &&
      canUserViewTask(task) // Apply role-based visibility
    );
    
    // Calculate task counts for status boxes
    const today = new Date();
    const sixtyDaysAgo = new Date(today.getTime() - (60 * 24 * 60 * 60 * 1000));
    
    const openTasks = allTasks.filter(t => !t.deleted && t.status !== 'Completed' && t.status !== 'In Progress');
    const inProgressTasks = allTasks.filter(t => !t.deleted && t.status === 'In Progress');
    const longDueTasks = allTasks.filter(t => {
      if (t.deleted || t.status === 'Completed') return false;
      const startDate = new Date(t.startDate?.split('-').reverse().join('-'));
      return startDate < sixtyDaysAgo;
    });
    const deletedTasks = allTasks.filter(t => t.deleted);
    
    // Apply filters
    const filteredTasks = allTasks.filter(task => {
      // Status filter from boxes
      if (activeStatusFilter === 'Open' && (task.deleted || task.status === 'Completed' || task.status === 'In Progress')) return false;
      if (activeStatusFilter === 'InProgress' && (task.deleted || task.status !== 'In Progress')) return false;
      if (activeStatusFilter === 'LongDue') {
        if (task.deleted || task.status === 'Completed') return false;
        const startDate = new Date(task.startDate?.split('-').reverse().join('-'));
        if (startDate >= sixtyDaysAgo) return false;
      }
      if (activeStatusFilter === 'Deleted' && !task.deleted) return false;
      
      // Exclude deleted tasks unless filtering for them
      if (!activeStatusFilter && task.deleted) return false;
      
      // Apply search filters
      if (filters.fileNo && !(task.fileNo || '').includes(filters.fileNo)) return false;
      if (filters.clientName && !task.clientName?.toLowerCase().includes(filters.clientName.toLowerCase())) return false;
      // Filter by Group No. (derived from fileNo - digits before decimal) - EXACT MATCH
      if (filters.groupName) {
        const taskGroupNo = task.fileNo ? task.fileNo.split('.')[0] : '';
        // Use exact match for group number
        if (taskGroupNo !== filters.groupName.trim()) return false;
      }
      if (filters.taskFinancialYear && task.financialYear !== filters.taskFinancialYear) return false;
      if (filters.taskPeriod && !(task.period || '').toLowerCase().includes(filters.taskPeriod.toLowerCase())) return false;
      if (filters.assignedUser && task.assignedTo !== filters.assignedUser) return false;
      
      // Search term
      if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        const taskGroupNo = task.fileNo ? task.fileNo.split('.')[0] : '';
        return (task.clientName || '').toLowerCase().includes(searchLower) ||
               (task.fileNo || '').includes(searchLower) ||
               taskGroupNo === searchLower; // Exact match for group number in search
      }
      
      return true;
    });

    // Calculate month-wise and year-wise summary
    const getSummaryData = () => {
      // Indian Financial Year order: April to March
      const months = ['April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March'];
      const years = ['FY 2025-26', 'FY 2024-25', 'FY 2023-24', 'Previous years'];
      
      const summary = months.map(month => {
        const row = { period: month };
        years.forEach(fy => {
          const fyTasks = allTasks.filter(t => {
            if (t.deleted) return false;
            
            // Check financial year
            const matchesFY = fy === 'Previous years' 
              ? !['FY 2025-26', 'FY 2024-25', 'FY 2023-24'].includes(t.financialYear)
              : t.financialYear === fy;
            
            if (!matchesFY) return false;
            
            // Check if task period contains the month
            const taskPeriod = (t.period || '').toLowerCase();
            const taskSubPeriod = (t.subPeriod || '').toLowerCase();
            const monthLower = month.toLowerCase();
            
            return taskPeriod.includes(monthLower) || taskSubPeriod.includes(monthLower) || taskSubPeriod === monthLower;
          });
          
          row[`${fy}_pending`] = fyTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
          row[`${fy}_completed`] = fyTasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
        });
        return row;
      });
      return { summary, years };
    };
    
    const { summary, years } = getSummaryData();

    const resetFilters = () => {
      setFilters({
        fileNo: '',
        clientName: '',
        groupName: '',
        taskFinancialYear: '',
        taskPeriod: '',
        assignedUser: '',
        status: ''
      });
      setSearchTerm('');
      setActiveStatusFilter('');
    };

    // Complete single task
    const completeTask = (taskId) => {
      const today = new Date();
      const dateStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
      
      setData(prev => ({
        ...prev,
        tasks: prev.tasks.map(t => 
          t.id === taskId ? { ...t, status: 'Completed', completedCheck: true, completedDate: dateStr } : t
        )
      }));
    };

    // Toggle task selection
    const toggleTaskSelection = (taskId) => {
      setSelectedTasks(prev => 
        prev.includes(taskId) 
          ? prev.filter(id => id !== taskId)
          : [...prev, taskId]
      );
    };

    // Select all visible tasks
    const toggleSelectAll = () => {
      const visibleTaskIds = filteredTasks.slice(0, entriesPerPage).filter(t => !t.deleted).map(t => t.id);
      if (selectedTasks.length === visibleTaskIds.length) {
        setSelectedTasks([]);
      } else {
        setSelectedTasks(visibleTaskIds);
      }
    };

    // Bulk complete selected tasks
    const bulkCompleteTasks = () => {
      if (selectedTasks.length === 0) return;
      
      const today = new Date();
      const dateStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
      
      setData(prev => ({
        ...prev,
        tasks: prev.tasks.map(t => 
          selectedTasks.includes(t.id) ? { ...t, status: 'Completed', completedCheck: true, completedDate: dateStr } : t
        )
      }));
      setSelectedTasks([]);
    };

    // Bulk update selected tasks
    const applyBulkUpdate = () => {
      if (selectedTasks.length === 0) return;
      
      const today = new Date();
      const dateStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
      
      setData(prev => ({
        ...prev,
        tasks: prev.tasks.map(t => {
          if (!selectedTasks.includes(t.id)) return t;
          
          const updates = {};
          if (bulkUpdateData.taskManager) updates.taskManager = bulkUpdateData.taskManager;
          if (bulkUpdateData.assignedUser) {
            updates.primaryAssignedUser = bulkUpdateData.assignedUser;
            updates.assignedTo = bulkUpdateData.assignedUser;
          }
          if (bulkUpdateData.status) {
            updates.status = bulkUpdateData.status;
            if (bulkUpdateData.status === 'Completed') {
              updates.completedCheck = true;
              updates.completedDate = dateStr;
            }
          }
          
          return { ...t, ...updates };
        })
      }));
      
      setSelectedTasks([]);
      setShowBulkUpdateModal(false);
      setBulkUpdateData({ taskManager: '', assignedUser: '', status: '' });
    };

    // Get managers for dropdown
    const managers = data.staff.filter(s => s.role === 'Reporting Manager' || s.role === 'Superadmin');

    // Get sub-period options based on period
    const getSubPeriodOptions = (period) => {
      switch(period) {
        case 'Monthly':
          return ['April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March'];
        case 'Quarterly':
          return ['Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'];
        case 'Half Yearly':
          return ['Half 1', 'Half 2'];
        case 'Annual':
          return [''];
        default:
          return [];
      }
    };

    // Create recurring tasks
    const createRecurringTasks = () => {
      if (!recurringData.batchName) {
        alert('Please enter a batch name');
        return;
      }
      if (recurringData.selectedClients.length === 0) {
        alert('Please select at least one client');
        return;
      }
      if (recurringData.subPeriods.length === 0 && recurringData.period !== 'Annual') {
        alert('Please select at least one sub-period');
        return;
      }
      if (!recurringData.taskManager) {
        alert('Please select a task manager');
        return;
      }

      const newTasks = [];
      const periodsToCreate = recurringData.period === 'Annual' ? [''] : recurringData.subPeriods;

      recurringData.selectedClients.forEach(clientId => {
        const client = data.clients.find(c => c.id === clientId);
        if (!client) return;

        periodsToCreate.forEach(subPeriod => {
          const periodDisplay = recurringData.period === 'Annual' ? 'Annual' : `${recurringData.period} - ${subPeriod}`;
          
          newTasks.push({
            id: generateId(),
            batchName: recurringData.batchName,
            fileNo: client.fileNo || '',
            clientName: client.name,
            clientId: client.id,
            groupName: client.groupName || client.name,
            parentTask: selectedParentTask,
            childTask: selectedChildTask,
            financialYear: recurringData.financialYear,
            period: periodDisplay,
            subPeriod: subPeriod,
            taskLeader: data.staff.find(s => s.role === 'Superadmin')?.name || 'Test1',
            taskManager: recurringData.taskManager,
            primaryAssignedUser: recurringData.assignedUser || recurringData.taskManager,
            assignedTo: recurringData.assignedUser || recurringData.taskManager,
            startDate: recurringData.startDate || '',
            expectedCompletionDate: recurringData.dueDate || '',
            taskDescription: recurringData.description || `${selectedChildTask} for ${client.name} - ${subPeriod || 'Annual'} ${recurringData.financialYear}`,
            comments: '',
            status: 'Pending',
            priority: 'Medium',
            completedCheck: false,
            completedBy: '',
            currentPosition: 'New Task Created',
            pendingIssues: ''
          });
        });
      });

      // Filter out duplicate tasks
      const { validTasks, duplicates } = filterDuplicateTasks(newTasks, data.tasks);
      
      if (duplicates.length > 0 && validTasks.length === 0) {
        alert(`âš ï¸ All ${duplicates.length} tasks already exist!\n\nNo new tasks were created.`);
        return;
      }
      
      if (duplicates.length > 0) {
        const duplicateList = duplicates.slice(0, 3).map(d => 
          `â€¢ ${d.clientName} - ${d.subPeriod || d.period}`
        ).join('\n');
        const moreText = duplicates.length > 3 ? `\n...and ${duplicates.length - 3} more` : '';
        
        if (!window.confirm(`âš ï¸ Found ${duplicates.length} duplicate task(s):\n\n${duplicateList}${moreText}\n\nDo you want to create the remaining ${validTasks.length} task(s)?`)) {
          return;
        }
      }
      
      if (validTasks.length === 0) {
        alert('No valid tasks to create.');
        return;
      }

      // If auto-create is enabled, save the schedule
      if (recurringData.autoCreate) {
        const schedule = {
          id: generateId(),
          batchName: recurringData.batchName,
          parentTask: selectedParentTask,
          childTask: selectedChildTask,
          clientIds: recurringData.selectedClients,
          financialYear: recurringData.financialYear,
          period: recurringData.period,
          subPeriods: recurringData.subPeriods,
          taskManager: recurringData.taskManager,
          assignedUser: recurringData.assignedUser,
          description: recurringData.description,
          autoCreateDay: recurringData.autoCreateDay,
          autoCreateTime: recurringData.autoCreateTime,
          isActive: true,
          createdAt: new Date().toISOString(),
          lastRun: null
        };
        
        setData(prev => ({
          ...prev,
          tasks: [...prev.tasks, ...validTasks],
          recurringSchedules: [...(prev.recurringSchedules || []), schedule]
        }));
        
        if (duplicates.length > 0) {
          alert(`âœ… Created ${validTasks.length} task(s).\nâš ï¸ Skipped ${duplicates.length} duplicate(s).\n\nScheduled auto-creation for day ${recurringData.autoCreateDay} of each month at ${recurringData.autoCreateTime}!`);
        } else {
          alert(`Successfully created ${validTasks.length} tasks and scheduled auto-creation for day ${recurringData.autoCreateDay} of each month at ${recurringData.autoCreateTime}!`);
        }
      } else {
        setData(prev => ({
          ...prev,
          tasks: [...prev.tasks, ...validTasks]
        }));
        
        if (duplicates.length > 0) {
          alert(`âœ… Created ${validTasks.length} task(s) in batch "${recurringData.batchName}".\nâš ï¸ Skipped ${duplicates.length} duplicate(s).`);
        } else {
          alert(`Successfully created ${validTasks.length} recurring tasks in batch "${recurringData.batchName}"!`);
        }
      }
      
      setShowRecurringModal(false);
      setRecurringData({
        batchName: '',
        selectedClients: [],
        financialYear: 'FY 2024-25',
        period: 'Monthly',
        subPeriods: [],
        taskManager: '',
        assignedUser: '',
        startDate: '',
        dueDate: '',
        description: '',
        autoCreate: false,
        autoCreateDay: '1',
        autoCreateTime: '09:00',
        isScheduled: false
      });
      setUploadedClients([]);
      setClientSelectionView('list');
    };

    // Handle client CSV upload for recurring tasks
    const handleClientUploadForRecurring = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const text = event.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            alert('CSV file is empty or has no data');
            return;
          }
          
          const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
          const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('client'));
          const codeIdx = headers.findIndex(h => h.includes('code') || h.includes('fileno') || h.includes('file'));
          
          if (nameIdx === -1 && codeIdx === -1) {
            alert('CSV must have a "Client Name" or "Client Code" column');
            return;
          }
          
          const matchedClients = [];
          const unmatchedRows = [];
          
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            const clientName = nameIdx !== -1 ? values[nameIdx] : '';
            const clientCode = codeIdx !== -1 ? values[codeIdx] : '';
            
            // Try to find matching client
            const matchedClient = data.clients.find(c => 
              (clientCode && c.fileNo === clientCode) ||
              (clientName && c.name.toLowerCase() === clientName.toLowerCase())
            );
            
            if (matchedClient) {
              matchedClients.push(matchedClient);
            } else if (clientName || clientCode) {
              unmatchedRows.push({ name: clientName, code: clientCode });
            }
          }
          
          if (matchedClients.length === 0) {
            alert('No matching clients found in the uploaded file');
            return;
          }
          
          setUploadedClients(matchedClients);
          setRecurringData(prev => ({
            ...prev,
            selectedClients: matchedClients.map(c => c.id)
          }));
          
          if (unmatchedRows.length > 0) {
            alert(`Found ${matchedClients.length} matching clients. ${unmatchedRows.length} rows could not be matched.`);
          } else {
            alert(`Successfully matched ${matchedClients.length} clients from the file.`);
          }
          
        } catch (err) {
          alert('Error parsing CSV file: ' + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    };

    // Toggle client selection for recurring tasks
    const toggleClientForRecurring = (clientId) => {
      setRecurringData(prev => ({
        ...prev,
        selectedClients: prev.selectedClients.includes(clientId)
          ? prev.selectedClients.filter(id => id !== clientId)
          : [...prev.selectedClients, clientId]
      }));
    };

    // Toggle sub-period selection
    const toggleSubPeriod = (subPeriod) => {
      setRecurringData(prev => ({
        ...prev,
        subPeriods: prev.subPeriods.includes(subPeriod)
          ? prev.subPeriods.filter(sp => sp !== subPeriod)
          : [...prev.subPeriods, subPeriod]
      }));
    };

    // Select all sub-periods
    const selectAllSubPeriods = () => {
      const allOptions = getSubPeriodOptions(recurringData.period);
      setRecurringData(prev => ({
        ...prev,
        subPeriods: prev.subPeriods.length === allOptions.length ? [] : allOptions
      }));
    };

    // Filter clients for search and remove duplicates by name
    const filteredClientsForRecurring = (() => {
      const filtered = data.clients.filter(c => 
        !c.disabled &&
        (c.name?.toLowerCase().includes(clientSearchTerm.toLowerCase()) ||
        (c.fileNo || '').toLowerCase().includes(clientSearchTerm.toLowerCase()))
      );
      // Remove duplicates by name (keep first occurrence)
      const seen = new Set();
      return filtered.filter(c => {
        const name = (c.name || '').toLowerCase().trim();
        if (seen.has(name)) return false;
        seen.add(name);
        return true;
      });
    })();

    return (
      <div className="task-detail-view" style={{padding: '24px 40px', background: '#f8fafc', minHeight: '100%'}}>
        {/* Recurring Tasks Modal */}
        {showRecurringModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '12px',
              width: '700px',
              maxWidth: '95%',
              maxHeight: '90vh',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column'
            }}>
              <div style={{padding: '20px', borderBottom: '1px solid #e2e8f0'}}>
                <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                  Create Recurring Tasks - {selectedParentTask} / {selectedChildTask}
                </h3>
              </div>
              
              <div style={{flex: 1, overflow: 'auto', padding: '20px'}}>
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'}}>
                  {/* Batch Name */}
                  <div style={{gridColumn: 'span 2'}}>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>
                      Batch Name <span style={{color: '#ef4444'}}>*</span>
                    </label>
                    <input
                      type="text"
                      placeholder="e.g., GST Monthly 3B - April 2024"
                      value={recurringData.batchName}
                      onChange={(e) => setRecurringData({...recurringData, batchName: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    />
                  </div>

                  {/* Financial Year */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Financial Year</label>
                    <select
                      value={recurringData.financialYear}
                      onChange={(e) => setRecurringData({...recurringData, financialYear: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    >
                      {FINANCIAL_YEARS.map(fy => <option key={fy} value={fy}>{fy}</option>)}
                    </select>
                  </div>

                  {/* Period */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Period</label>
                    <select
                      value={recurringData.period}
                      onChange={(e) => setRecurringData({...recurringData, period: e.target.value, subPeriods: []})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    >
                      {PERIODS.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                  </div>

                  {/* Sub-Periods Selection */}
                  {recurringData.period !== 'Annual' && (
                    <div style={{gridColumn: 'span 2'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px'}}>
                        <label style={{fontSize: '13px', fontWeight: '500'}}>
                          Select Sub-Periods <span style={{color: '#ef4444'}}>*</span>
                        </label>
                        <button
                          onClick={selectAllSubPeriods}
                          style={{fontSize: '12px', color: '#3b82f6', background: 'none', border: 'none', cursor: 'pointer'}}
                        >
                          {recurringData.subPeriods.length === getSubPeriodOptions(recurringData.period).length ? 'Deselect All' : 'Select All'}
                        </button>
                      </div>
                      <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', padding: '12px', background: '#f8fafc', borderRadius: '8px', maxHeight: '120px', overflow: 'auto'}}>
                        {getSubPeriodOptions(recurringData.period).map(sp => (
                          <label
                            key={sp}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '6px 12px',
                              background: recurringData.subPeriods.includes(sp) ? '#10b981' : '#fff',
                              color: recurringData.subPeriods.includes(sp) ? '#fff' : '#1e293b',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              border: '1px solid',
                              borderColor: recurringData.subPeriods.includes(sp) ? '#10b981' : '#e2e8f0'
                            }}
                          >
                            <input
                              type="checkbox"
                              checked={recurringData.subPeriods.includes(sp)}
                              onChange={() => toggleSubPeriod(sp)}
                              style={{display: 'none'}}
                            />
                            {sp}
                          </label>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Task Manager */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>
                      Task Manager <span style={{color: '#ef4444'}}>*</span>
                    </label>
                    <select
                      value={recurringData.taskManager}
                      onChange={(e) => setRecurringData({...recurringData, taskManager: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    >
                      <option value="">Select Manager</option>
                      {managers.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>

                  {/* Assigned User */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Assigned User</label>
                    <select
                      value={recurringData.assignedUser}
                      onChange={(e) => setRecurringData({...recurringData, assignedUser: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    >
                      <option value="">Same as Manager</option>
                      {data.staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>

                  {/* Start Date */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Start Date</label>
                    <input
                      type="date"
                      value={recurringData.startDate}
                      onChange={(e) => setRecurringData({...recurringData, startDate: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    />
                  </div>

                  {/* Due Date */}
                  <div>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Due Date</label>
                    <input
                      type="date"
                      value={recurringData.dueDate}
                      onChange={(e) => setRecurringData({...recurringData, dueDate: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                    />
                  </div>

                  {/* Description */}
                  <div style={{gridColumn: 'span 2'}}>
                    <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Description (Optional)</label>
                    <textarea
                      placeholder="Task description (auto-generated if left empty)"
                      value={recurringData.description}
                      onChange={(e) => setRecurringData({...recurringData, description: e.target.value})}
                      style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px', minHeight: '60px', resize: 'vertical'}}
                    />
                  </div>

                  {/* Auto-Creation Settings */}
                  <div style={{gridColumn: 'span 2', background: '#f8fafc', padding: '16px', borderRadius: '8px', border: '1px solid #e2e8f0'}}>
                    <label style={{display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer', marginBottom: '12px'}}>
                      <input
                        type="checkbox"
                        checked={recurringData.autoCreate}
                        onChange={(e) => setRecurringData({...recurringData, autoCreate: e.target.checked})}
                        style={{width: '18px', height: '18px'}}
                      />
                      <span style={{fontSize: '14px', fontWeight: '600'}}>Enable Auto-Creation Schedule</span>
                    </label>
                    
                    {recurringData.autoCreate && (
                      <div style={{display: 'flex', gap: '16px', marginTop: '12px'}}>
                        <div style={{flex: 1}}>
                          <label style={{display: 'block', fontSize: '12px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>
                            Day of Month
                          </label>
                          <select
                            value={recurringData.autoCreateDay}
                            onChange={(e) => setRecurringData({...recurringData, autoCreateDay: e.target.value})}
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                          >
                            {[...Array(28)].map((_, i) => (
                              <option key={i + 1} value={String(i + 1)}>{i + 1}</option>
                            ))}
                          </select>
                        </div>
                        <div style={{flex: 1}}>
                          <label style={{display: 'block', fontSize: '12px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>
                            Time
                          </label>
                          <input
                            type="time"
                            value={recurringData.autoCreateTime}
                            onChange={(e) => setRecurringData({...recurringData, autoCreateTime: e.target.value})}
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                          />
                        </div>
                      </div>
                    )}
                    
                    {recurringData.autoCreate && (
                      <div style={{marginTop: '10px', fontSize: '12px', color: '#64748b'}}>
                        Tasks will be automatically created on day {recurringData.autoCreateDay} of each month at {recurringData.autoCreateTime}
                      </div>
                    )}
                  </div>
                </div>

                {/* Client Selection - Separate Box */}
                <div style={{marginTop: '20px', border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 16px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                    <div>
                      <span style={{fontSize: '14px', fontWeight: '600'}}>Select Clients</span>
                      <span style={{color: '#ef4444', marginLeft: '4px'}}>*</span>
                      <span style={{fontWeight: '400', color: '#64748b', marginLeft: '8px', fontSize: '13px'}}>
                        ({recurringData.selectedClients.length} selected)
                      </span>
                    </div>
                    <div style={{display: 'flex', gap: '8px'}}>
                      <button
                        onClick={() => setClientSelectionView('list')}
                        style={{
                          padding: '6px 12px',
                          background: clientSelectionView === 'list' ? '#10b981' : '#fff',
                          color: clientSelectionView === 'list' ? '#fff' : '#64748b',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: '500'
                        }}
                      >
                        List View
                      </button>
                      <button
                        onClick={() => setClientSelectionView('upload')}
                        style={{
                          padding: '6px 12px',
                          background: clientSelectionView === 'upload' ? '#10b981' : '#fff',
                          color: clientSelectionView === 'upload' ? '#fff' : '#64748b',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: '500'
                        }}
                      >
                        Upload CSV
                      </button>
                    </div>
                  </div>
                  
                  {clientSelectionView === 'list' ? (
                    <div style={{padding: '16px'}}>
                      <div style={{display: 'flex', gap: '12px', marginBottom: '12px'}}>
                        <input
                          type="text"
                          placeholder="Search clients by name or code..."
                          value={clientSearchTerm}
                          onChange={(e) => setClientSearchTerm(e.target.value)}
                          style={{flex: 1, padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                        />
                        <button
                          onClick={() => {
                            const allClientIds = data.clients.map(c => c.id);
                            setRecurringData(prev => ({
                              ...prev,
                              selectedClients: prev.selectedClients.length === allClientIds.length ? [] : allClientIds
                            }));
                          }}
                          style={{padding: '10px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500', whiteSpace: 'nowrap'}}
                        >
                          {recurringData.selectedClients.length === data.clients.length ? 'Deselect All' : 'Select All'}
                        </button>
                      </div>
                      
                      <div style={{maxHeight: '200px', overflow: 'auto', border: '1px solid #e2e8f0', borderRadius: '8px'}}>
                        {filteredClientsForRecurring.length === 0 ? (
                          <div style={{padding: '20px', textAlign: 'center', color: '#64748b'}}>
                            No clients found
                          </div>
                        ) : (
                          filteredClientsForRecurring.map(client => (
                            <label
                              key={client.id}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '10px 14px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f1f5f9',
                                background: recurringData.selectedClients.includes(client.id) ? '#f0fdf4' : '#fff',
                                transition: 'background 0.15s'
                              }}
                            >
                              <input
                                type="checkbox"
                                checked={recurringData.selectedClients.includes(client.id)}
                                onChange={() => toggleClientForRecurring(client.id)}
                                style={{width: '16px', height: '16px'}}
                              />
                              <div style={{flex: 1}}>
                                <div style={{fontWeight: '500', fontSize: '13px'}}>{client.name}</div>
                                {client.fileNo && <div style={{color: '#64748b', fontSize: '11px'}}>Code: {formatFileNo(client.fileNo)}</div>}
                              </div>
                              {client.fileNo && (
                                <span style={{color: '#64748b', fontSize: '11px', background: '#f1f5f9', padding: '2px 8px', borderRadius: '4px'}}>
                                  Group {client.fileNo.split('.')[0]}
                                </span>
                              )}
                            </label>
                          ))
                        )}
                      </div>
                    </div>
                  ) : (
                    <div style={{padding: '16px'}}>
                      <div style={{border: '2px dashed #e2e8f0', borderRadius: '8px', padding: '30px', textAlign: 'center', background: '#fafafa'}}>
                        <Upload size={40} style={{color: '#9ca3af', marginBottom: '12px'}} />
                        <div style={{fontSize: '14px', fontWeight: '500', marginBottom: '8px'}}>Upload Client List (CSV)</div>
                        <div style={{fontSize: '12px', color: '#64748b', marginBottom: '16px'}}>
                          CSV should have "Client Name" or "Client Code" column
                        </div>
                        <label style={{
                          display: 'inline-block',
                          padding: '10px 20px',
                          background: '#3b82f6',
                          color: '#fff',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '500'
                        }}>
                          <input
                            type="file"
                            accept=".csv"
                            onChange={handleClientUploadForRecurring}
                            style={{display: 'none'}}
                          />
                          Choose CSV File
                        </label>
                      </div>
                      
                      {uploadedClients.length > 0 && (
                        <div style={{marginTop: '16px'}}>
                          <div style={{fontSize: '13px', fontWeight: '500', marginBottom: '8px', color: '#166534'}}>
                            âœ“ {uploadedClients.length} clients matched from upload
                          </div>
                          <div style={{maxHeight: '150px', overflow: 'auto', border: '1px solid #e2e8f0', borderRadius: '8px'}}>
                            {uploadedClients.map(client => (
                              <div
                                key={client.id}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '8px 12px',
                                  borderBottom: '1px solid #f1f5f9',
                                  background: '#f0fdf4',
                                  fontSize: '13px'
                                }}
                              >
                                <span>{client.name}</span>
                                <span style={{color: '#64748b', fontSize: '11px'}}>{formatFileNo(client.fileNo)}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      <div style={{marginTop: '16px', padding: '12px', background: '#fefce8', borderRadius: '6px', border: '1px solid #fef08a'}}>
                        <div style={{fontSize: '12px', color: '#854d0e'}}>
                          <strong>Sample CSV format:</strong><br/>
                          Client Name,Client Code<br/>
                          ABC Industries,1.01<br/>
                          XYZ Enterprises,1.02
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Preview */}
                {recurringData.selectedClients.length > 0 && (recurringData.subPeriods.length > 0 || recurringData.period === 'Annual') && (
                  <div style={{marginTop: '16px', padding: '12px', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #bae6fd'}}>
                    <div style={{fontSize: '13px', fontWeight: '500', color: '#0369a1'}}>
                      Preview: {recurringData.selectedClients.length} clients Ã— {recurringData.period === 'Annual' ? 1 : recurringData.subPeriods.length} periods = <strong>{recurringData.selectedClients.length * (recurringData.period === 'Annual' ? 1 : recurringData.subPeriods.length)} tasks</strong> will be created
                      {recurringData.autoCreate && <span style={{marginLeft: '8px', color: '#7c3aed'}}>(+ scheduled for auto-creation)</span>}
                    </div>
                  </div>
                )}
              </div>
              
              <div style={{display: 'flex', gap: '12px', padding: '20px', borderTop: '1px solid #e2e8f0'}}>
                <button
                  onClick={() => {
                    setShowRecurringModal(false);
                    setRecurringData({
                      batchName: '',
                      selectedClients: [],
                      financialYear: 'FY 2024-25',
                      period: 'Monthly',
                      subPeriods: [],
                      taskManager: '',
                      assignedUser: '',
                      startDate: '',
                      dueDate: '',
                      description: '',
                      autoCreate: false,
                      autoCreateDay: '1',
                      autoCreateTime: '09:00',
                      isScheduled: false
                    });
                    setClientSearchTerm('');
                    setClientSelectionView('list');
                    setUploadedClients([]);
                  }}
                  style={{flex: 1, padding: '12px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  Cancel
                </button>
                <button
                  onClick={createRecurringTasks}
                  style={{flex: 1, padding: '12px', background: recurringData.autoCreate ? '#8b5cf6' : '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  {recurringData.autoCreate ? 'ðŸ“… Schedule & Create' : 'Create'} {recurringData.selectedClients.length * (recurringData.period === 'Annual' ? 1 : recurringData.subPeriods.length)} Tasks
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Bulk Update Modal */}
        {showBulkUpdateModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '12px',
              padding: '24px',
              width: '400px',
              maxWidth: '90%'
            }}>
              <h3 style={{margin: '0 0 20px 0', fontSize: '18px', fontWeight: '600'}}>
                Bulk Update Tasks ({selectedTasks.length} selected)
              </h3>
              
              <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                <div>
                  <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Task Manager</label>
                  <select
                    value={bulkUpdateData.taskManager}
                    onChange={(e) => setBulkUpdateData({...bulkUpdateData, taskManager: e.target.value})}
                    style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                  >
                    <option value="">-- No Change --</option>
                    {managers.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                  </select>
                </div>
                
                <div>
                  <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Assigned User</label>
                  <select
                    value={bulkUpdateData.assignedUser}
                    onChange={(e) => setBulkUpdateData({...bulkUpdateData, assignedUser: e.target.value})}
                    style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                  >
                    <option value="">-- No Change --</option>
                    {data.staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                  </select>
                </div>
                
                <div>
                  <label style={{display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px'}}>Status</label>
                  <select
                    value={bulkUpdateData.status}
                    onChange={(e) => setBulkUpdateData({...bulkUpdateData, status: e.target.value})}
                    style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '14px'}}
                  >
                    <option value="">-- No Change --</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                  </select>
                </div>
              </div>
              
              <div style={{display: 'flex', gap: '12px', marginTop: '24px'}}>
                <button
                  onClick={() => {
                    setShowBulkUpdateModal(false);
                    setBulkUpdateData({ taskManager: '', assignedUser: '', status: '' });
                  }}
                  style={{flex: 1, padding: '10px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  Cancel
                </button>
                <button
                  onClick={applyBulkUpdate}
                  style={{flex: 1, padding: '10px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  Apply Changes
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Header */}
        <div className="view-header">
          <div>
            <div className="breadcrumb">
              <span onClick={() => setCurrentView('dashboard')} style={{cursor: 'pointer', color: '#10b981'}}>Dashboard</span>
              <ChevronRight size={16} />
              <span>{selectedParentTask}</span>
              <ChevronRight size={16} />
              <span className="current">{selectedChildTask}</span>
            </div>
            <h1>{selectedParentTask} - {selectedChildTask}</h1>
          </div>
          <div style={{display: 'flex', gap: '10px'}}>
            <button 
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm('Clear ALL tasks?')) {
                  setData(prev => ({ ...prev, tasks: [] }));
                }
              }}
              style={{background: '#ef4444', color: 'white', border: 'none', padding: '10px 16px', borderRadius: '8px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px'}}
            >
              <Trash2 size={18} /> Clear All
            </button>
            <button 
              type="button" 
              onClick={() => setShowRecurringModal(true)}
              style={{background: '#8b5cf6', color: 'white', border: 'none', padding: '10px 16px', borderRadius: '8px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px', ...(hasActionPermission('canCreateTask') ? {} : {display: 'none'})}}
            >
              <Calendar size={18} /> Create Recurring Tasks
            </button>
            {hasActionPermission('canCreateTask') && (
            <button type="button" className="btn-primary" onClick={() => setShowAddTaskModal(true)}>
              <Plus size={20} /> Add Task
            </button>
            )}
          </div>
        </div>

        {/* Main Row: Status Cards | Task Filters | FY Task Status - Side by Side */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: '1fr 1fr 1fr',
          gap: '24px',
          marginBottom: '20px',
          padding: '0 8px'
        }}>
          {/* LEFT: Status Filter Boxes - 2x2 Grid */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: '1fr 1fr',
            gap: '12px'
          }}>
            {/* Open Tasks Box - Green Pastel */}
            <div 
              onClick={() => setActiveStatusFilter(activeStatusFilter === 'Open' ? '' : 'Open')}
              style={{
                background: activeStatusFilter === 'Open' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)',
                color: activeStatusFilter === 'Open' ? '#fff' : '#065f46',
                padding: '8px 12px',
                borderRadius: '10px',
                boxShadow: activeStatusFilter === 'Open' ? '0 4px 12px rgba(16,185,129,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
                cursor: 'pointer',
                border: 'none',
                transition: 'all 0.2s',
                transform: activeStatusFilter === 'Open' ? 'translateY(-2px)' : 'none'
              }}
            >
              <div style={{fontSize: '20px', fontWeight: '700', marginBottom: '0'}}>{openTasks.length}</div>
              <div style={{fontSize: '10px', fontWeight: '600'}}>Open Tasks</div>
            </div>

            {/* In Progress Tasks Box - Blue Pastel */}
            <div 
              onClick={() => setActiveStatusFilter(activeStatusFilter === 'InProgress' ? '' : 'InProgress')}
              style={{
                background: activeStatusFilter === 'InProgress' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                color: activeStatusFilter === 'InProgress' ? '#fff' : '#1e40af',
                padding: '8px 12px',
                borderRadius: '10px',
                boxShadow: activeStatusFilter === 'InProgress' ? '0 4px 12px rgba(59,130,246,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
                cursor: 'pointer',
                border: 'none',
                transition: 'all 0.2s',
                transform: activeStatusFilter === 'InProgress' ? 'translateY(-2px)' : 'none'
              }}
            >
              <div style={{fontSize: '20px', fontWeight: '700', marginBottom: '0'}}>{inProgressTasks.length}</div>
              <div style={{fontSize: '10px', fontWeight: '600'}}>In Progress</div>
            </div>

            {/* Long Due Tasks Box - Amber Pastel */}
            <div 
              onClick={() => setActiveStatusFilter(activeStatusFilter === 'LongDue' ? '' : 'LongDue')}
              style={{
                background: activeStatusFilter === 'LongDue' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                color: activeStatusFilter === 'LongDue' ? '#fff' : '#92400e',
                padding: '8px 12px',
                borderRadius: '10px',
                boxShadow: activeStatusFilter === 'LongDue' ? '0 4px 12px rgba(245,158,11,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
                cursor: 'pointer',
                border: 'none',
                transition: 'all 0.2s',
                transform: activeStatusFilter === 'LongDue' ? 'translateY(-2px)' : 'none'
              }}
            >
              <div style={{fontSize: '20px', fontWeight: '700', marginBottom: '0'}}>{longDueTasks.length}</div>
              <div style={{fontSize: '10px', fontWeight: '600'}}>Long Due (60+)</div>
            </div>

            {/* Deleted Tasks Box - Red Pastel */}
            <div 
              onClick={() => setActiveStatusFilter(activeStatusFilter === 'Deleted' ? '' : 'Deleted')}
              style={{
                background: activeStatusFilter === 'Deleted' ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
                color: activeStatusFilter === 'Deleted' ? '#fff' : '#991b1b',
                padding: '8px 12px',
                borderRadius: '10px',
                boxShadow: activeStatusFilter === 'Deleted' ? '0 4px 12px rgba(239,68,68,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
                cursor: 'pointer',
                border: 'none',
                transition: 'all 0.2s',
                transform: activeStatusFilter === 'Deleted' ? 'translateY(-2px)' : 'none'
              }}
            >
              <div style={{fontSize: '20px', fontWeight: '700', marginBottom: '0'}}>{deletedTasks.length}</div>
              <div style={{fontSize: '10px', fontWeight: '600'}}>Deleted Tasks</div>
            </div>
          </div>

          {/* MIDDLE: Task Filters */}
          <div style={{
            background: 'linear-gradient(135deg, #dbeafe 0%, #fff 100%)',
            borderRadius: '10px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
            padding: '12px',
            display: 'flex',
            flexDirection: 'column'
          }}>
            <h3 style={{margin: '0 0 10px', fontSize: '13px', fontWeight: '600', color: '#1e40af'}}>
              <Filter size={14} style={{marginRight: '6px', verticalAlign: 'middle'}} />
              Task Filters
            </h3>
            
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', flex: 1}}>
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Client Code</label>
                <input
                  type="text"
                  placeholder="Code"
                  value={filters.fileNo}
                  onChange={(e) => setFilters({...filters, fileNo: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px'}}
                />
              </div>
              
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Client Name</label>
                <input
                  type="text"
                  placeholder="Name"
                  value={filters.clientName}
                  onChange={(e) => setFilters({...filters, clientName: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px'}}
                />
              </div>
              
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Group No.</label>
                <input
                  type="text"
                  placeholder="Group"
                  value={filters.groupName}
                  onChange={(e) => setFilters({...filters, groupName: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px'}}
                />
              </div>
              
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Financial Year</label>
                <select
                  value={filters.taskFinancialYear}
                  onChange={(e) => setFilters({...filters, taskFinancialYear: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px', background: '#fff'}}
                >
                  <option value="">All Years</option>
                  {FINANCIAL_YEARS.map(fy => <option key={fy} value={fy}>{fy}</option>)}
                </select>
              </div>
              
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Period</label>
                <select
                  value={filters.taskPeriod}
                  onChange={(e) => setFilters({...filters, taskPeriod: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px', background: '#fff'}}
                >
                  <option value="">All Periods</option>
                  {PERIODS.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
              
              <div>
                <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '2px'}}>Assigned To</label>
                <select
                  value={filters.assignedUser}
                  onChange={(e) => setFilters({...filters, assignedUser: e.target.value})}
                  style={{width: '100%', padding: '6px 8px', border: '1px solid #bfdbfe', borderRadius: '5px', fontSize: '11px', background: '#fff'}}
                >
                  <option value="">All Staff</option>
                  {data.staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                </select>
              </div>
            </div>
            
            <button 
              onClick={resetFilters}
              style={{
                marginTop: '10px',
                padding: '8px 16px',
                background: '#10b981',
                color: '#fff',
                border: 'none',
                borderRadius: '5px',
                fontSize: '11px',
                fontWeight: '600',
                cursor: 'pointer'
              }}
            >
              Reset Filters
            </button>
          </div>

          {/* RIGHT: FY Task Status Report - No Heading, No Scroller */}
          <div style={{
            background: '#fff',
            borderRadius: '10px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
            border: '1px solid #10b981',
            overflow: 'hidden'
          }}>
            <table style={{borderCollapse: 'collapse', fontSize: '10px', width: '100%'}}>
              <thead>
                <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                  <th style={{padding: '6px 8px', textAlign: 'left', border: '1px solid #059669', fontWeight: '700', fontSize: '10px', color: '#fff'}}>Month</th>
                  {years.map(fy => (
                    <th key={fy} colSpan={2} style={{padding: '6px 4px', textAlign: 'center', border: '1px solid #059669', fontWeight: '700', fontSize: '9px', color: '#fff'}}>{fy.replace('FY ', '').replace('Previous years', 'Prev')}</th>
                  ))}
                </tr>
                <tr style={{background: '#dcfce7'}}>
                  <th style={{padding: '4px 8px', border: '1px solid #bbf7d0', fontSize: '8px'}}></th>
                  {years.map(fy => (
                    <React.Fragment key={fy}>
                      <th style={{padding: '4px 4px', textAlign: 'center', border: '1px solid #bbf7d0', color: '#dc2626', fontWeight: '700', fontSize: '8px'}}>P</th>
                      <th style={{padding: '4px 4px', textAlign: 'center', border: '1px solid #bbf7d0', color: '#16a34a', fontWeight: '700', fontSize: '8px'}}>D</th>
                    </React.Fragment>
                  ))}
                </tr>
              </thead>
              <tbody>
                {summary.map((row, idx) => (
                  <tr key={row.period} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                    <td style={{padding: '4px 8px', fontWeight: '600', border: '1px solid #e5e7eb', fontSize: '9px', color: '#374151'}}>{row.period.substring(0, 3)}</td>
                    {years.map(fy => (
                      <React.Fragment key={fy}>
                        <td 
                          style={{
                            padding: '4px 4px', 
                            textAlign: 'center', 
                            border: '1px solid #e5e7eb', 
                            color: row[`${fy}_pending`] > 0 ? '#dc2626' : '#9ca3af', 
                            fontWeight: row[`${fy}_pending`] > 0 ? '700' : '400',
                            cursor: row[`${fy}_pending`] > 0 ? 'pointer' : 'default',
                            background: row[`${fy}_pending`] > 0 ? '#fef2f2' : 'transparent',
                            fontSize: '10px'
                          }}
                          onClick={() => {
                            if (row[`${fy}_pending`] > 0) {
                              setFilters({...filters, taskFinancialYear: fy === 'Previous years' ? '' : fy, taskPeriod: row.period});
                              setActiveStatusFilter('');
                            }
                          }}
                          title={row[`${fy}_pending`] > 0 ? `Click to view ${row[`${fy}_pending`]} pending tasks` : ''}
                        >
                          {row[`${fy}_pending`] || 0}
                        </td>
                        <td 
                          style={{
                            padding: '4px 4px', 
                            textAlign: 'center', 
                            border: '1px solid #e5e7eb', 
                            color: row[`${fy}_completed`] > 0 ? '#16a34a' : '#9ca3af', 
                            fontWeight: row[`${fy}_completed`] > 0 ? '700' : '400',
                            cursor: row[`${fy}_completed`] > 0 ? 'pointer' : 'default',
                            background: row[`${fy}_completed`] > 0 ? '#dcfce7' : 'transparent',
                            fontSize: '10px'
                          }}
                          onClick={() => {
                            if (row[`${fy}_completed`] > 0) {
                              setFilters({...filters, taskFinancialYear: fy === 'Previous years' ? '' : fy, taskPeriod: row.period, status: 'Completed'});
                              setActiveStatusFilter('');
                            }
                          }}
                          title={row[`${fy}_completed`] > 0 ? `Click to view ${row[`${fy}_completed`]} completed tasks` : ''}
                        >
                          {row[`${fy}_completed`] || 0}
                        </td>
                      </React.Fragment>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* Table Controls with Bulk Actions */}
        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px'}}>
          <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
            <div className="entries-control">
              <label>Show</label>
              <select value={entriesPerPage} onChange={(e) => setEntriesPerPage(parseInt(e.target.value))}>
                <option value={10}>10</option>
                <option value={25}>25</option>
                <option value={50}>50</option>
                <option value={100}>100</option>
                <option value={300}>300</option>
              </select>
              <label>entries</label>
            </div>
            
            {/* Bulk Action Buttons - Show when tasks are selected */}
            {selectedTasks.length > 0 && (
              <div style={{display: 'flex', alignItems: 'center', gap: '10px', padding: '8px 12px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #bbf7d0'}}>
                <span style={{fontSize: '13px', fontWeight: '500', color: '#166534'}}>
                  {selectedTasks.length} task{selectedTasks.length > 1 ? 's' : ''} selected
                </span>
                <button
                  onClick={() => setShowBulkUpdateModal(true)}
                  style={{
                    padding: '6px 12px',
                    background: '#3b82f6',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '500',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px'
                  }}
                >
                  <Edit size={14} /> Bulk Update
                </button>
                <button
                  onClick={bulkCompleteTasks}
                  style={{
                    padding: '6px 12px',
                    background: '#10b981',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '500',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px'
                  }}
                >
                  <CheckCircle size={14} /> Complete All
                </button>
                <button
                  onClick={() => setSelectedTasks([])}
                  style={{
                    padding: '6px 12px',
                    background: '#f1f5f9',
                    color: '#64748b',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '500'
                  }}
                >
                  Clear
                </button>
              </div>
            )}
          </div>
          
          <div className="table-search">
            <label>Search:</label>
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Search tasks..."
            />
          </div>
        </div>

        {/* Tasks Table - Excel-like Spreadsheet */}
        <div className="tasks-table-wrapper" style={{background: '#fff', borderRadius: '8px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.1)', border: '1px solid #10b981'}}>
          <table className="tasks-table" style={{fontSize: '12px', borderCollapse: 'collapse', width: '100%'}}>
            <thead>
              <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                <th style={{width: '35px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>
                  <input 
                    type="checkbox" 
                    checked={selectedTasks.length > 0 && selectedTasks.length === filteredTasks.slice(0, entriesPerPage).filter(t => !t.deleted).length}
                    onChange={toggleSelectAll}
                  />
                </th>
                <th style={{width: '60px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Manage</th>
                <th style={{minWidth: '140px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Client Name</th>
                <th style={{width: '70px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Code</th>
                <th style={{minWidth: '180px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Description</th>
                <th style={{width: '85px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', whiteSpace: 'nowrap'}}>Start Date</th>
                <th style={{width: '85px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', whiteSpace: 'nowrap'}}>Due Date</th>
                <th style={{width: '90px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Manager</th>
                <th style={{width: '90px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Assigned</th>
                <th style={{width: '70px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>FY</th>
                <th style={{width: '80px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Period</th>
                <th style={{width: '60px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Sub</th>
                <th style={{width: '75px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Status</th>
                <th style={{width: '85px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Completed</th>
                <th style={{width: '45px', padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Del</th>
              </tr>
            </thead>
            <tbody>
              {filteredTasks.length === 0 ? (
                <tr>
                  <td colSpan={15} style={{textAlign: 'center', padding: '40px', color: '#64748b', border: '1px solid #e5e7eb'}}>
                    No tasks found. {activeStatusFilter && <span>Try clearing the filter.</span>}
                  </td>
                </tr>
              ) : (
                filteredTasks.slice(0, entriesPerPage).map((task, idx) => {
                  const taskStatus = task.deleted ? 'Deleted' : (task.status === 'Completed' || task.completedCheck) ? 'Completed' : task.status === 'In Progress' ? 'In Progress' : 'Open';
                  const isSelected = selectedTasks.includes(task.id);
                  
                  // Parse period and subPeriod if combined
                  let periodDisplay = task.period || '';
                  let subPeriodDisplay = task.subPeriod || '';
                  if (periodDisplay.includes(' - ')) {
                    const parts = periodDisplay.split(' - ');
                    periodDisplay = parts[0];
                    subPeriodDisplay = parts[1] || '';
                  }
                  
                  // Check if task has invoice/receipt
                  const hasInvoice = (data.invoices || []).some(inv => inv.taskId === task.id || (inv.tasks || []).includes(task.id));
                  const hasReceipt = (data.receipts || []).some(r => r.taskId === task.id);
                  // Only "In Progress" tasks can be deleted, and only if no invoice/receipt
                  const isCompleted = task.status === 'Completed' || task.completedCheck;
                  const isOpen = task.status !== 'Completed' && task.status !== 'In Progress';
                  const cannotDelete = hasInvoice || hasReceipt || isCompleted || isOpen;
                  const deleteBlockReason = hasInvoice || hasReceipt ? 'Invoice/Receipt exists' : isCompleted ? 'Completed tasks cannot be deleted' : isOpen ? 'Open tasks cannot be deleted' : '';
                  
                  return (
                  <tr key={task.id} style={{ opacity: task.deleted ? 0.5 : 1, background: isSelected ? '#dcfce7' : (idx % 2 === 0 ? '#fff' : '#f8fafc') }}>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                      <input 
                        type="checkbox" 
                        checked={isSelected}
                        onChange={() => toggleTaskSelection(task.id)}
                        disabled={task.deleted}
                      />
                    </td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb'}}>
                      <div style={{display: 'flex', gap: '4px'}}>
                        {hasActionPermission('canEditTask') && (
                        <button className="manage-btn" title="Manage Task" onClick={() => openTaskManageModal(task)}>
                          <Edit size={14} />
                        </button>
                        )}
                        {!task.deleted && taskStatus !== 'Completed' && hasActionPermission('canChangeTaskStatus') && (
                          <button 
                            title="Complete Task"
                            onClick={() => completeTask(task.id)}
                            style={{
                              background: '#10b981',
                              color: '#fff',
                              border: 'none',
                              borderRadius: '4px',
                              padding: '5px',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}
                          >
                            <CheckCircle size={12} />
                          </button>
                        )}
                      </div>
                    </td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', maxWidth: '140px'}}>
                      <div style={{wordWrap: 'break-word', whiteSpace: 'normal', lineHeight: '1.3', maxHeight: '36px', overflow: 'hidden', fontSize: '11px'}}>{task.clientName || '-'}</div>
                    </td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{formatFileNo(task.fileNo) || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', maxWidth: '180px'}}>
                      <div style={{wordWrap: 'break-word', whiteSpace: 'normal', lineHeight: '1.3', fontSize: '11px', color: '#475569'}} title={task.taskDescription || task.description || ''}>
                        {task.taskDescription || task.description || '-'}
                      </div>
                    </td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', whiteSpace: 'nowrap', fontSize: '11px'}}>{task.startDate || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', whiteSpace: 'nowrap', fontSize: '11px'}}>{task.expectedCompletionDate || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{task.taskManager || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{task.primaryAssignedUser || task.assignedTo || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '10px'}}>{task.financialYear?.replace('FY ', '') || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{periodDisplay || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '10px'}}>{subPeriodDisplay || '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb'}}>
                      <span className={`status-badge-table status-${taskStatus.toLowerCase().replace(' ', '-')}`} style={{fontSize: '9px', padding: '2px 6px'}}>
                        {taskStatus}
                      </span>
                    </td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px', whiteSpace: 'nowrap'}}>{task.completedCheck ? (task.completedDate || '-') : '-'}</td>
                    <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                      {!task.deleted ? (
                        hasActionPermission('canDeleteTask') && (
                          cannotDelete ? (
                            <span title={`Cannot delete - ${deleteBlockReason}`} style={{color: '#9ca3af', cursor: 'not-allowed'}}>
                              <Trash2 size={14} />
                            </span>
                          ) : (
                        <button 
                          type="button"
                          className="delete-btn-table" 
                          title="Delete Task"
                          onClick={(e) => {
                            e.stopPropagation();
                            if (window.confirm('Delete this task?')) {
                              setData(prev => ({
                                ...prev,
                                tasks: prev.tasks.map(t => t.id === task.id ? { ...t, deleted: true, deletedAt: new Date().toISOString(), deletedBy: currentUser?.name || 'Unknown' } : t)
                              }));
                            }
                          }}
                        >
                          <Trash2 size={14} />
                        </button>
                          )
                        )
                      ) : (
                        <span style={{color: '#9ca3af', fontSize: '10px'}}>Del</span>
                      )}
                    </td>
                  </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        <div className="table-footer">
          <div>Showing {Math.min(filteredTasks.length, entriesPerPage)} of {filteredTasks.length} entries</div>
        </div>
      </div>
    );
  };


  // Create Client Form Component
  const CreateClientForm = ({ onClose, onSave, editingClient }) => {
    const [formStep, setFormStep] = useState('basic');
    
    // Helper function to get the last client code for a group
    // Helper function to get all existing group numbers
    const getExistingGroups = () => {
      const groups = new Set();
      data.clients.forEach(c => {
        if (c.fileNo) {
          const parts = c.fileNo.split('.');
          if (parts.length === 2 && parts[0]) {
            groups.add(parseInt(parts[0]));
          }
        }
      });
      return Array.from(groups).filter(g => !isNaN(g)).sort((a, b) => a - b);
    };
    
    // Helper function to get next new group number
    const getNextNewGroup = () => {
      const groups = getExistingGroups();
      if (groups.length === 0) return 1;
      return Math.max(...groups) + 1;
    };
    
    // Helper function to get the last client code number in a group
    const getLastClientCode = (groupCode) => {
      const groupClients = data.clients.filter(c => c.fileNo && c.fileNo.split('.')[0] === String(groupCode));
      if (groupClients.length === 0) return null;
      
      const codes = groupClients.map(c => {
        const parts = c.fileNo.split('.');
        return parts.length === 2 ? parseInt(parts[1]) : 0;
      }).filter(n => !isNaN(n));
      
      return codes.length > 0 ? Math.max(...codes) : 0;
    };
    
    // Helper function to get next client code for a group
    const getNextClientCode = (groupCode) => {
      const lastCode = getLastClientCode(groupCode);
      if (lastCode === null) return `${groupCode}.01`;
      const nextNum = lastCode + 1;
      return `${groupCode}.${String(nextNum).padStart(2, '0')}`;
    };
    
    // Helper function to get client count in a group
    const getGroupClientCount = (groupCode) => {
      return data.clients.filter(c => c.fileNo && c.fileNo.split('.')[0] === String(groupCode)).length;
    };
    
    // Validate client code format and uniqueness (simplified - no manual entry)
    const validateClientCode = (code) => {
      if (!code) return { valid: false, message: 'Client Code is required' };
      
      const parts = code.split('.');
      if (parts.length !== 2) {
        return { valid: false, message: 'Invalid Client Code format' };
      }
      
      const [groupCode, clientNo] = parts;
      if (!groupCode || !clientNo) {
        return { valid: false, message: 'Invalid Client Code format' };
      }
      
      // Check if code already exists (skip check if editing the same client)
      const editingClientId = editingClient?.id;
      const exists = data.clients.some(c => {
        if (c.fileNo !== code) return false;
        if (!editingClientId) return true;
        return String(c.id) !== String(editingClientId);
      });
      
      if (exists) {
        return { valid: false, message: 'Client Code already exists.' };
      }
      
      return { valid: true, message: '' };
    };
    
    // Validate for duplicate client (same name AND PAN)
    const validateDuplicateClient = (name, pan) => {
      if (!name) return { valid: true };
      
      const editingClientId = editingClient?.id;
      const duplicate = data.clients.find(c => {
        // Skip the client being edited
        if (editingClientId && String(c.id) === String(editingClientId)) return false;
        
        // Check for same name (case-insensitive)
        const sameName = c.name?.toLowerCase().trim() === name.toLowerCase().trim() ||
                         c.clientName?.toLowerCase().trim() === name.toLowerCase().trim();
        
        // If PAN is provided, also check PAN
        if (pan && pan.trim()) {
          const samePan = c.pancard?.toUpperCase().trim() === pan.toUpperCase().trim();
          return sameName && samePan;
        }
        
        // If no PAN, just check name
        return sameName;
      });
      
      if (duplicate) {
        if (pan && pan.trim()) {
          return { valid: false, message: `A client with the same Name and PAN already exists: ${duplicate.name || duplicate.clientName} (${duplicate.fileNo})` };
        }
        return { valid: false, message: `A client with the same Name already exists: ${duplicate.name || duplicate.clientName} (${duplicate.fileNo}). Add PAN to differentiate.` };
      }
      
      return { valid: true };
    };
    
    // Create fresh initial state
    const getInitialState = () => ({
      // Basic Details
      fileNo: '',
      clientName: '',
      email: '',
      phone: '',
      dateOfEnrollment: '',
      groupNo: '', // Changed from groupName
      groupMode: 'new', // 'existing' or 'new'
      selectedGroup: '', // For existing group selection
      sameAsClientName: false,
      address: '',
      gstin: '',
      pancard: '',
      aadhaar: '',
      typeOfClient: '',
      reportingManager: '',
      isOutOfIndia: false,
      state: '',
      country: '',
      clientNotes: '',
      showNotes: false,
      
      // Auto Bulk Task Batches
      autoBulkTasks: [],
      taskTypeBatches: [],
      
      // User IDs & Passwords
      gstnUserId: '',
      gstnPassword: '',
      tracesUserId: '',
      tracesPassword: '',
      eWayBillUserId: '',
      eWayBillPassword: '',
      incomeTaxUserId: '',
      incomeTaxPassword: '',
      otherCredentials: [],
      
      // Contact Information
      primaryOwner: { name: '', contact1: '', contact2: '', email1: '', email2: '' },
      secondaryOwner: { name: '', contact1: '', contact2: '', email1: '', email2: '' },
      accountant: { name: '', contact1: '', contact2: '', email1: '', email2: '' },
      otherContact: { name: '', contact1: '', contact2: '', email1: '', email2: '' },
      updateContactList: false,
      
      // Agreed Fees - by Parent/Child Task
      agreedFees: [{ parentTask: '', childTask: '', fee: '', frequency: '' }],
      
      // KYC Documents
      kycDocuments: [
        { id: 1, name: 'PAN', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
        { id: 2, name: 'AADHAAR', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
        { id: 3, name: 'GST Certificate', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
        { id: 4, name: 'Incorporation Certificate', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
        { id: 5, name: 'TAN', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
        { id: 6, name: 'MOA & AOA', file: null, fileName: '', fileData: '', fileType: '', remark: '' },
      ]
    });
    
    const [clientData, setClientData] = useState(getInitialState());

    // Debug logging
    React.useEffect(() => {
      console.log('=== CreateClientForm mounted/updated ===');
      console.log('editingClient:', editingClient);
      console.log('Component key:', editingClient ? editingClient.id : 'new-client');
      console.log('Current clientData state:', {
        clientName: clientData.clientName,
        email: clientData.email,
        phone: clientData.phone,
        address: clientData.address,
        gstin: clientData.gstin,
        pancard: clientData.pancard,
        state: clientData.state
      });
    }, []);

    // Populate form when editing
    React.useEffect(() => {
      console.log('=== editingClient changed ===');
      console.log('New editingClient value:', editingClient);
      
      if (editingClient) {
        console.log('MODE: EDITING - Populating form with client data');
        
        // Get group number from fileNo
        let groupNo = '';
        let selectedGroup = '';
        if (editingClient.fileNo) {
          const parts = editingClient.fileNo.split('.');
          if (parts.length === 2) {
            groupNo = parts[0];
            selectedGroup = parts[0];
          }
        }
        
        setClientData({
          ...getInitialState(), // Start with fresh state
          // Basic Details
          fileNo: editingClient.fileNo || '',
          clientName: editingClient.name || '',
          email: editingClient.email || '',
          phone: editingClient.phone || '',
          dateOfEnrollment: editingClient.dateOfEnrollment || '',
          groupNo: groupNo,
          groupMode: 'existing', // When editing, always existing group
          selectedGroup: selectedGroup,
          address: editingClient.address || '',
          gstin: editingClient.gstin || '',
          pancard: editingClient.pan || '',
          aadhaar: editingClient.aadhaar || '',
          typeOfClient: editingClient.typeOfClient || '',
          reportingManager: editingClient.reportingManager || '',
          isOutOfIndia: editingClient.isOutOfIndia || false,
          state: editingClient.state || '',
          country: editingClient.country || '',
          clientNotes: editingClient.notes || '',
          showNotes: !!editingClient.notes,
          // User IDs & Passwords
          gstnUserId: editingClient.gstnUserId || '',
          gstnPassword: editingClient.gstnPassword || '',
          tracesUserId: editingClient.tracesUserId || '',
          tracesPassword: editingClient.tracesPassword || '',
          eWayBillUserId: editingClient.eWayBillUserId || '',
          eWayBillPassword: editingClient.eWayBillPassword || '',
          incomeTaxUserId: editingClient.incomeTaxUserId || '',
          incomeTaxPassword: editingClient.incomeTaxPassword || '',
          otherCredentials: editingClient.otherCredentials || [],
          // Contact Information
          primaryOwner: editingClient.primaryOwner || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
          secondaryOwner: editingClient.secondaryOwner || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
          accountant: editingClient.accountant || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
          otherContact: editingClient.otherContact || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
          // Agreed Fees - convert old format if needed
          agreedFees: (editingClient.agreedFees && editingClient.agreedFees.length > 0) 
            ? editingClient.agreedFees 
            : [{ parentTask: '', childTask: '', fee: '', frequency: '' }],
          // KYC Documents - preserve fileData for download functionality
          kycDocuments: (editingClient.kycDocuments && editingClient.kycDocuments.length > 0)
            ? editingClient.kycDocuments.map(doc => ({
                ...doc,
                file: null, // File objects can't be persisted
                fileName: doc.fileName || '',
                fileData: doc.fileData || '', // Preserve base64 data
                fileType: doc.fileType || '',
                remark: doc.remark || ''
              }))
            : [
                { id: 1, name: 'PAN', file: null, fileName: '', fileData: '', remark: '' },
                { id: 2, name: 'AADHAAR', file: null, fileName: '', fileData: '', remark: '' },
                { id: 3, name: 'GST Certificate', file: null, fileName: '', fileData: '', remark: '' },
                { id: 4, name: 'Incorporation Certificate', file: null, fileName: '', fileData: '', remark: '' },
                { id: 5, name: 'TAN', file: null, fileName: '', fileData: '', remark: '' },
                { id: 6, name: 'MOA & AOA', file: null, fileName: '', fileData: '', remark: '' },
              ]
        });
      } else {
        // RESET FORM COMPLETELY when creating new client
        console.log('MODE: CREATE NEW - Resetting form to completely empty state');
        const freshState = getInitialState();
        console.log('Fresh state being set:', {
          clientName: freshState.clientName,
          email: freshState.email,
          address: freshState.address,
          gstin: freshState.gstin,
          pancard: freshState.pancard,
          state: freshState.state
        });
        setClientData(freshState);
      }
    }, [editingClient]);

    const formSteps = [
      { id: 'basic', label: 'Basic Details' },
      { id: 'userids', label: 'User-IDs & Passwords' },
      { id: 'contact', label: 'Contact Information' },
      { id: 'fees', label: 'Agreed Fees' },
      { id: 'kyc', label: 'KYC Document' }
    ];

    const handleSubmit = (e) => {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      console.log('Form submitted, Client Data:', clientData);
      
      // Validate ONLY required fields: File No (auto-generated), Client Name
      if (!clientData.fileNo || clientData.fileNo.trim() === '') {
        alert('Client Code is required! Please select a group type.');
        return;
      }
      
      if (!clientData.clientName || clientData.clientName.trim() === '') {
        alert('Client Name is required!');
        return;
      }
      
      // Check for duplicate client (same name AND PAN)
      const duplicateCheck = validateDuplicateClient(clientData.clientName, clientData.pancard);
      if (!duplicateCheck.valid) {
        alert(`âŒ Duplicate Client!\n\n${duplicateCheck.message}`);
        return;
      }
      
      // Get Group No. from fileNo and format fileNo with 2 decimal places
      const groupNo = clientData.fileNo.split('.')[0] || '';
      const formattedFileNo = formatFileNo(clientData.fileNo);
      
      // Map form data to client object structure - save ALL fields
      const newClient = {
        id: editingClient ? editingClient.id : generateId(),
        // Basic Details
        name: clientData.clientName ? clientData.clientName.trim() : '',
        email: clientData.email ? clientData.email.trim() : '',
        phone: clientData.phone ? clientData.phone.trim() : '',
        fileNo: formattedFileNo, // Use formatted fileNo
        groupNo: groupNo, // Store Group No. derived from Client Code
        address: clientData.address ? clientData.address.trim() : '',
        gstin: clientData.gstin ? clientData.gstin.trim() : '',
        pan: clientData.pancard ? clientData.pancard.trim() : '',
        pancard: clientData.pancard ? clientData.pancard.trim() : '', // Keep both for compatibility
        aadhaar: clientData.aadhaar ? clientData.aadhaar.trim() : '',
        state: clientData.state ? clientData.state.trim() : '',
        typeOfClient: clientData.typeOfClient ? clientData.typeOfClient.trim() : '',
        reportingManager: clientData.reportingManager ? clientData.reportingManager.trim() : '',
        dateOfEnrollment: clientData.dateOfEnrollment || '',
        isOutOfIndia: clientData.isOutOfIndia || false,
        country: clientData.country ? clientData.country.trim() : '',
        notes: clientData.clientNotes ? clientData.clientNotes.trim() : '',
        // User IDs & Passwords
        gstnUserId: clientData.gstnUserId || '',
        gstnPassword: clientData.gstnPassword || '',
        tracesUserId: clientData.tracesUserId || '',
        tracesPassword: clientData.tracesPassword || '',
        eWayBillUserId: clientData.eWayBillUserId || '',
        eWayBillPassword: clientData.eWayBillPassword || '',
        incomeTaxUserId: clientData.incomeTaxUserId || '',
        incomeTaxPassword: clientData.incomeTaxPassword || '',
        otherCredentials: clientData.otherCredentials || [],
        // Contact Information
        primaryOwner: clientData.primaryOwner || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
        secondaryOwner: clientData.secondaryOwner || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
        accountant: clientData.accountant || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
        otherContact: clientData.otherContact || { name: '', contact1: '', contact2: '', email1: '', email2: '' },
        // Agreed Fees (filter out empty entries)
        agreedFees: (clientData.agreedFees || []).filter(f => f.parentTask || f.fee),
        // KYC Documents - save file data for download functionality
        kycDocuments: (clientData.kycDocuments || []).map(doc => ({
          id: doc.id,
          name: doc.name,
          remark: doc.remark || '',
          fileName: doc.file?.name || doc.fileName || '',
          fileData: doc.fileData || '', // base64 data for download
          fileType: doc.fileType || '',
          fileSize: doc.fileSize || 0,
          hasFile: !!(doc.fileData || doc.fileName)
        })),
        // Meta
        disabled: editingClient ? editingClient.disabled : false,
        services: editingClient ? editingClient.services : [],
        outstanding: editingClient ? editingClient.outstanding : 0
      };
      
      console.log('Client object created:', newClient);
      
      try {
        onSave(newClient, editingClient ? editingClient.id : null);
        console.log('Client saved successfully');
      } catch (error) {
        console.error('ERROR saving client:', error);
        alert('Error saving client: ' + error.message);
      }
    };

    const handleGroupNameCheck = (checked) => {
      setClientData({
        ...clientData,
        sameAsClientName: checked,
        groupName: checked ? clientData.clientName : clientData.groupName
      });
    };

    return (
      <div className="create-client-professional">
        {/* Header */}
        <div className="client-form-header">
          <div className="header-left">
            <Briefcase size={28} className="header-icon" />
            <div>
              <h2>
                {editingClient ? 'Edit Client' : 'Create a New Client'}
                <span style={{
                  marginLeft: '12px',
                  fontSize: '11px',
                  padding: '4px 10px',
                  background: editingClient ? 'rgba(254, 243, 199, 0.9)' : 'rgba(255, 255, 255, 0.25)',
                  color: editingClient ? '#92400e' : '#fff',
                  borderRadius: '4px',
                  fontWeight: '600'
                }}>
                  {editingClient ? `EDIT MODE` : 'NEW'}
                </span>
              </h2>
              <p>{editingClient ? 'Update client information' : 'Add complete client information to your system'}</p>
            </div>
          </div>
          <button className="btn-close-professional" onClick={onClose}>
            <X size={24} />
          </button>
        </div>

        {/* Tab Navigation */}
        <div className="professional-tabs">
          {formSteps.map((step, index) => (
            <button
              key={step.id}
              className={`professional-tab ${formStep === step.id ? 'active' : ''}`}
              onClick={() => setFormStep(step.id)}
            >
              <span className="tab-number">{index + 1}</span>
              <span className="tab-text">{step.label}</span>
            </button>
          ))}
        </div>

        <form onSubmit={handleSubmit}>
          {/* Basic Details Step */}
          {formStep === 'basic' && (
            <div className="professional-form-body">
              {/* Section 1: Client Identification */}
              <div className="form-section-pro">
                <h3 className="section-title-pro">Client Identification</h3>
                
                  {/* Group Selection - Only show for new clients */}
                  {!editingClient && (
                    <div style={{marginBottom: '12px'}}>
                      <label style={{marginBottom: '6px', display: 'block', fontSize: '12px', fontWeight: '500', color: '#374151'}}>
                        Group Type <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <div style={{display: 'flex', gap: '16px', marginBottom: '8px'}}>
                        <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', padding: '8px 14px', border: `2px solid ${clientData.groupMode === 'existing' ? '#10b981' : '#e2e8f0'}`, borderRadius: '6px', background: clientData.groupMode === 'existing' ? '#dcfce7' : '#fff', fontSize: '13px'}}>
                          <input
                            type="radio"
                            name="groupMode"
                            value="existing"
                            checked={clientData.groupMode === 'existing'}
                            onChange={() => {
                              const existingGroups = getExistingGroups();
                              const selectedGroup = existingGroups.length > 0 ? String(existingGroups[0]) : '';
                              const newFileNo = selectedGroup ? getNextClientCode(selectedGroup) : '';
                              setClientData({
                                ...clientData, 
                                groupMode: 'existing', 
                                selectedGroup: selectedGroup,
                                fileNo: newFileNo,
                                groupNo: selectedGroup
                              });
                            }}
                            style={{accentColor: '#10b981'}}
                          />
                          <span style={{fontWeight: '500'}}>Existing Group</span>
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', padding: '8px 14px', border: `2px solid ${clientData.groupMode === 'new' ? '#10b981' : '#e2e8f0'}`, borderRadius: '6px', background: clientData.groupMode === 'new' ? '#dcfce7' : '#fff', fontSize: '13px'}}>
                          <input
                            type="radio"
                            name="groupMode"
                            value="new"
                            checked={clientData.groupMode === 'new'}
                            onChange={() => {
                              const nextGroup = getNextNewGroup();
                              const newFileNo = `${nextGroup}.01`;
                              setClientData({
                                ...clientData, 
                                groupMode: 'new', 
                                selectedGroup: '',
                                fileNo: newFileNo,
                                groupNo: String(nextGroup)
                              });
                            }}
                            style={{accentColor: '#10b981'}}
                          />
                          <span style={{fontWeight: '500'}}>New Group</span>
                        </label>
                        
                        {/* Inline Group Selection for existing */}
                        {clientData.groupMode === 'existing' && (
                          <select
                            value={clientData.selectedGroup}
                            onChange={(e) => {
                              const selectedGroup = e.target.value;
                              const newFileNo = selectedGroup ? getNextClientCode(selectedGroup) : '';
                              setClientData({
                                ...clientData,
                                selectedGroup: selectedGroup,
                                fileNo: newFileNo,
                                groupNo: selectedGroup
                              });
                            }}
                            style={{flex: 1, padding: '8px 12px', borderRadius: '6px', border: '1px solid #e2e8f0', fontSize: '13px'}}
                          >
                            <option value="">Select group...</option>
                            {getExistingGroups().map(group => (
                              <option key={group} value={group}>
                                Group {group} ({getGroupClientCount(group)} clients)
                              </option>
                            ))}
                          </select>
                        )}
                        
                        {/* New Group Info inline */}
                        {clientData.groupMode === 'new' && (
                          <span style={{padding: '8px 14px', background: '#f0fdf4', borderRadius: '6px', border: '1px solid #bbf7d0', fontSize: '12px', color: '#166534'}}>
                            <strong>New Group No.: {getNextNewGroup()}</strong>
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Row 1: Group No., Client Code, Client Name (MAX WIDTH), Type of Client, Date of Enrollment */}
                  <div style={{display: 'grid', gridTemplateColumns: '60px 70px 1fr 100px 110px', gap: '10px', alignItems: 'end'}}>
                    {/* Group No. */}
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Grp No.</label>
                      <input
                        type="text"
                        value={clientData.fileNo ? clientData.fileNo.split('.')[0] : (clientData.groupMode === 'new' ? getNextNewGroup() : clientData.selectedGroup || '')}
                        readOnly
                        style={{
                          width: '100%',
                          padding: '10px 4px',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          background: '#f8fafc',
                          fontSize: '13px',
                          fontWeight: '600',
                          color: '#1e293b',
                          textAlign: 'center'
                        }}
                      />
                    </div>

                    {/* Client Code */}
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>
                        Code <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <input
                        type="text"
                        value={formatFileNo(clientData.fileNo)}
                        readOnly={!editingClient}
                        disabled={!editingClient}
                        style={{
                          width: '100%',
                          padding: '10px 4px',
                          background: editingClient ? '#fff' : '#f0fdf4',
                          border: clientData.fileNo ? '1px solid #10b981' : '1px solid #e2e8f0',
                          borderRadius: '6px',
                          fontWeight: '600',
                          fontSize: '13px',
                          color: '#166534',
                          textAlign: 'center'
                        }}
                      />
                    </div>

                    {/* Client Name - MAXIMUM WIDTH */}
                    <div>
                      <label style={{display: 'block', fontSize: '11px', fontWeight: '600', color: '#374151', marginBottom: '4px'}}>
                        Client Name <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <input
                        type="text"
                        placeholder="Enter client full name"
                        value={clientData.clientName}
                        onChange={(e) => {
                          setClientData(prev => ({
                            ...prev, 
                            clientName: e.target.value
                          }));
                        }}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          border: '2px solid #10b981',
                          borderRadius: '6px',
                          fontSize: '14px',
                          fontWeight: '500',
                          background: '#f0fdf4'
                        }}
                      />
                    </div>

                    {/* Type of Client */}
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Type</label>
                      <select
                        value={clientData.typeOfClient}
                        onChange={(e) => setClientData({...clientData, typeOfClient: e.target.value})}
                        style={{
                          width: '100%',
                          padding: '10px 4px',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          fontSize: '11px',
                          background: '#fff'
                        }}
                      >
                        <option value="">Select</option>
                        <option value="Individual">Individual</option>
                        <option value="Company">Company</option>
                        <option value="Partnership">Partnership</option>
                        <option value="LLP">LLP</option>
                        <option value="Trust">Trust</option>
                        <option value="HUF">HUF</option>
                      </select>
                    </div>

                    {/* Date of Enrollment */}
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Enrollment</label>
                      <input
                        type="date"
                        value={clientData.dateOfEnrollment}
                        onChange={(e) => setClientData({...clientData, dateOfEnrollment: e.target.value})}
                        style={{
                          width: '100%',
                          padding: '10px 4px',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          fontSize: '11px'
                        }}
                      />
                    </div>
                  </div>
              </div>

              {/* Section 2: Contact & Tax Details */}
              <div className="form-section-pro">
                <h3 className="section-title-pro">Contact & Tax Details</h3>
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '12px'}}>
                  {/* Row 1: Email, Phone, GSTIN, PAN */}
                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Email</label>
                    <input
                      type="email"
                      placeholder="client@example.com"
                      value={clientData.email}
                      onChange={(e) => setClientData({...clientData, email: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Phone</label>
                    <input
                      type="tel"
                      placeholder="+91 98765 43210"
                      value={clientData.phone}
                      onChange={(e) => setClientData({...clientData, phone: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>GSTIN</label>
                    <input
                      type="text"
                      placeholder="GST Number"
                      value={clientData.gstin}
                      onChange={(e) => setClientData({...clientData, gstin: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>PAN</label>
                    <input
                      type="text"
                      placeholder="PAN Number"
                      value={clientData.pancard}
                      onChange={(e) => setClientData({...clientData, pancard: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>

                  {/* Row 2: Address (2 cols), Aadhaar, State */}
                  <div style={{gridColumn: 'span 2', gridRow: 'span 2'}}>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Address</label>
                    <textarea
                      rows="4"
                      placeholder="Enter complete address"
                      value={clientData.address}
                      onChange={(e) => setClientData({...clientData, address: e.target.value})}
                      style={{
                        width: '100%',
                        height: 'calc(100% - 20px)',
                        padding: '10px 12px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '6px',
                        fontSize: '13px',
                        resize: 'none',
                        lineHeight: '1.4'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Aadhaar</label>
                    <input
                      type="text"
                      placeholder="Aadhaar Number"
                      value={clientData.aadhaar}
                      onChange={(e) => setClientData({...clientData, aadhaar: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>State</label>
                    <select
                      value={clientData.state}
                      onChange={(e) => setClientData({...clientData, state: e.target.value})}
                      style={{width: '100%', padding: '10px 8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                    >
                      <option value="">Select State</option>
                      <option value="Andhra Pradesh">Andhra Pradesh</option>
                      <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                      <option value="Assam">Assam</option>
                      <option value="Bihar">Bihar</option>
                      <option value="Chhattisgarh">Chhattisgarh</option>
                      <option value="Goa">Goa</option>
                      <option value="Gujarat">Gujarat</option>
                      <option value="Haryana">Haryana</option>
                      <option value="Himachal Pradesh">Himachal Pradesh</option>
                      <option value="Jharkhand">Jharkhand</option>
                      <option value="Karnataka">Karnataka</option>
                      <option value="Kerala">Kerala</option>
                      <option value="Madhya Pradesh">Madhya Pradesh</option>
                      <option value="Maharashtra">Maharashtra</option>
                      <option value="Manipur">Manipur</option>
                      <option value="Meghalaya">Meghalaya</option>
                      <option value="Mizoram">Mizoram</option>
                      <option value="Nagaland">Nagaland</option>
                      <option value="Odisha">Odisha</option>
                      <option value="Punjab">Punjab</option>
                      <option value="Rajasthan">Rajasthan</option>
                      <option value="Sikkim">Sikkim</option>
                      <option value="Tamil Nadu">Tamil Nadu</option>
                      <option value="Telangana">Telangana</option>
                      <option value="Tripura">Tripura</option>
                      <option value="Uttar Pradesh">Uttar Pradesh</option>
                      <option value="Uttarakhand">Uttarakhand</option>
                      <option value="West Bengal">West Bengal</option>
                      <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                      <option value="Chandigarh">Chandigarh</option>
                      <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                      <option value="Delhi">Delhi</option>
                      <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                      <option value="Ladakh">Ladakh</option>
                      <option value="Lakshadweep">Lakshadweep</option>
                      <option value="Puducherry">Puducherry</option>
                    </select>
                  </div>

                  {/* Row 3: Country, Reporting Manager */}
                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Country</label>
                    <select
                      value={clientData.country || 'India'}
                      onChange={(e) => setClientData({...clientData, country: e.target.value, isOutOfIndia: e.target.value === 'Out of India'})}
                      style={{width: '100%', padding: '10px 8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                    >
                      <option value="India">India</option>
                      <option value="Out of India">Out of India</option>
                    </select>
                  </div>

                  <div>
                    <label style={{display: 'block', fontSize: '11px', fontWeight: '500', color: '#64748b', marginBottom: '4px'}}>Reporting Manager</label>
                    <select
                      value={clientData.reportingManager || ''}
                      onChange={(e) => setClientData({...clientData, reportingManager: e.target.value})}
                      style={{width: '100%', padding: '10px 8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                    >
                      <option value="">Select RM</option>
                      {data.staff.filter(s => s.role === 'Reporting Manager' || s.role === 'Superadmin').map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Other Steps */}
          {formStep !== 'basic' && (
            <div className="professional-form-body">
              {formStep === 'userids' && (
                <div className="userids-content">
                  <h3 className="userids-title">
                    <User size={20} />
                    USER-IDS & PASSWORDS
                  </h3>

                  {/* Main Credentials */}
                  <table className="credentials-table">
                    <thead>
                      <tr>
                        <th></th>
                        <th><User size={18} /> User ID</th>
                        <th><User size={18} /> Password</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td className="credential-label">GSTN</td>
                        <td>
                          <input 
                            type="text" 
                            value={clientData.gstnUserId || ''}
                            onChange={(e) => setClientData({...clientData, gstnUserId: e.target.value})}
                          />
                        </td>
                        <td>
                          <input 
                            type="password" 
                            value={clientData.gstnPassword || ''}
                            onChange={(e) => setClientData({...clientData, gstnPassword: e.target.value})}
                          />
                        </td>
                      </tr>
                      <tr>
                        <td className="credential-label">Traces</td>
                        <td>
                          <input 
                            type="text"
                            value={clientData.tracesUserId || ''}
                            onChange={(e) => setClientData({...clientData, tracesUserId: e.target.value})}
                          />
                        </td>
                        <td>
                          <input 
                            type="password"
                            value={clientData.tracesPassword || ''}
                            onChange={(e) => setClientData({...clientData, tracesPassword: e.target.value})}
                          />
                        </td>
                      </tr>
                      <tr>
                        <td className="credential-label">E Way Bill</td>
                        <td>
                          <input 
                            type="text"
                            value={clientData.eWayBillUserId || ''}
                            onChange={(e) => setClientData({...clientData, eWayBillUserId: e.target.value})}
                          />
                        </td>
                        <td>
                          <input 
                            type="password"
                            value={clientData.eWayBillPassword || ''}
                            onChange={(e) => setClientData({...clientData, eWayBillPassword: e.target.value})}
                          />
                        </td>
                      </tr>
                      <tr>
                        <td className="credential-label">Income Tax</td>
                        <td>
                          <input 
                            type="text"
                            value={clientData.incomeTaxUserId || ''}
                            onChange={(e) => setClientData({...clientData, incomeTaxUserId: e.target.value})}
                          />
                        </td>
                        <td>
                          <input 
                            type="password"
                            value={clientData.incomeTaxPassword || ''}
                            onChange={(e) => setClientData({...clientData, incomeTaxPassword: e.target.value})}
                          />
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  {/* Other User IDs */}
                  <h4 className="other-credentials-title">OTHER USER IDS & PASSWORDS</h4>
                  <table className="other-credentials-table">
                    <thead>
                      <tr>
                        <th><FileText size={18} /> Portal Name</th>
                        <th><User size={18} /> User ID</th>
                        <th><User size={18} /> Password</th>
                        <th style={{width: '60px'}}></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(clientData.otherCredentials.length === 0 ? [{ portalName: '', userId: '', password: '' }] : clientData.otherCredentials).map((cred, idx) => (
                        <tr key={idx}>
                          <td>
                            <input 
                              type="text" 
                              placeholder="Portal Name"
                              value={cred.portalName || ''}
                              onChange={(e) => {
                                const newCreds = [...(clientData.otherCredentials.length === 0 ? [{ portalName: '', userId: '', password: '' }] : clientData.otherCredentials)];
                                newCreds[idx] = { ...newCreds[idx], portalName: e.target.value };
                                setClientData({...clientData, otherCredentials: newCreds});
                              }}
                            />
                          </td>
                          <td>
                            <input 
                              type="text" 
                              placeholder="User ID"
                              value={cred.userId || ''}
                              onChange={(e) => {
                                const newCreds = [...(clientData.otherCredentials.length === 0 ? [{ portalName: '', userId: '', password: '' }] : clientData.otherCredentials)];
                                newCreds[idx] = { ...newCreds[idx], userId: e.target.value };
                                setClientData({...clientData, otherCredentials: newCreds});
                              }}
                            />
                          </td>
                          <td>
                            <input 
                              type="password" 
                              placeholder="Password"
                              value={cred.password || ''}
                              onChange={(e) => {
                                const newCreds = [...(clientData.otherCredentials.length === 0 ? [{ portalName: '', userId: '', password: '' }] : clientData.otherCredentials)];
                                newCreds[idx] = { ...newCreds[idx], password: e.target.value };
                                setClientData({...clientData, otherCredentials: newCreds});
                              }}
                            />
                          </td>
                          <td>
                            {clientData.otherCredentials.length > 1 && (
                              <button
                                type="button"
                                onClick={() => {
                                  const newCreds = clientData.otherCredentials.filter((_, i) => i !== idx);
                                  setClientData({...clientData, otherCredentials: newCreds});
                                }}
                                style={{ background: '#fee2e2', border: 'none', borderRadius: '4px', padding: '4px 8px', cursor: 'pointer' }}
                              >
                                <Trash2 size={14} color="#dc2626" />
                              </button>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  <button
                    type="button"
                    onClick={() => {
                      const newCreds = [...(clientData.otherCredentials.length === 0 ? [] : clientData.otherCredentials), { portalName: '', userId: '', password: '' }];
                      setClientData({...clientData, otherCredentials: newCreds});
                    }}
                    style={{ marginTop: '10px', padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}
                  >
                    <Plus size={14} style={{ marginRight: '6px', verticalAlign: 'middle' }} />
                    Add More
                  </button>
                </div>
              )}

              {formStep === 'contact' && (
                <div className="contact-info-content">
                  <h3 className="contact-title">
                    <Mail size={20} />
                    CONTACT INFORMATION
                  </h3>

                  <table className="contact-table">
                    <thead>
                      <tr>
                        <th></th>
                        <th><User size={18} /> Primary Owner</th>
                        <th><User size={18} /> Secondary Owner</th>
                        <th><User size={18} /> Accountant</th>
                        <th><User size={18} /> Other Contact Person</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td className="contact-row-label">Name Of Person</td>
                        <td><input type="text" placeholder="Primary Owner Name" value={(clientData.primaryOwner || {}).name || ''} onChange={(e) => setClientData({...clientData, primaryOwner: {...(clientData.primaryOwner || {}), name: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Secondary Owner Name" value={(clientData.secondaryOwner || {}).name || ''} onChange={(e) => setClientData({...clientData, secondaryOwner: {...(clientData.secondaryOwner || {}), name: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Accountant Name" value={(clientData.accountant || {}).name || ''} onChange={(e) => setClientData({...clientData, accountant: {...(clientData.accountant || {}), name: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Other Contact Person Name" value={(clientData.otherContact || {}).name || ''} onChange={(e) => setClientData({...clientData, otherContact: {...(clientData.otherContact || {}), name: e.target.value}})} /></td>
                      </tr>
                      <tr>
                        <td className="contact-row-label">Contact No.1</td>
                        <td><input type="text" placeholder="Primary Contact No.1" value={(clientData.primaryOwner || {}).contact1 || ''} onChange={(e) => setClientData({...clientData, primaryOwner: {...(clientData.primaryOwner || {}), contact1: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Secondary Contact No.1" value={(clientData.secondaryOwner || {}).contact1 || ''} onChange={(e) => setClientData({...clientData, secondaryOwner: {...(clientData.secondaryOwner || {}), contact1: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Accountant Contact No.1" value={(clientData.accountant || {}).contact1 || ''} onChange={(e) => setClientData({...clientData, accountant: {...(clientData.accountant || {}), contact1: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Other Contact No.1" value={(clientData.otherContact || {}).contact1 || ''} onChange={(e) => setClientData({...clientData, otherContact: {...(clientData.otherContact || {}), contact1: e.target.value}})} /></td>
                      </tr>
                      <tr>
                        <td className="contact-row-label">Contact No.2</td>
                        <td><input type="text" placeholder="Primary Contact No.2" value={(clientData.primaryOwner || {}).contact2 || ''} onChange={(e) => setClientData({...clientData, primaryOwner: {...(clientData.primaryOwner || {}), contact2: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Secondary Contact No.2" value={(clientData.secondaryOwner || {}).contact2 || ''} onChange={(e) => setClientData({...clientData, secondaryOwner: {...(clientData.secondaryOwner || {}), contact2: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Accountant Contact No.2" value={(clientData.accountant || {}).contact2 || ''} onChange={(e) => setClientData({...clientData, accountant: {...(clientData.accountant || {}), contact2: e.target.value}})} /></td>
                        <td><input type="text" placeholder="Other Contact No.2" value={(clientData.otherContact || {}).contact2 || ''} onChange={(e) => setClientData({...clientData, otherContact: {...(clientData.otherContact || {}), contact2: e.target.value}})} /></td>
                      </tr>
                      <tr>
                        <td className="contact-row-label">Email ID 1</td>
                        <td><input type="email" placeholder="Primary Email 1" value={(clientData.primaryOwner || {}).email1 || ''} onChange={(e) => setClientData({...clientData, primaryOwner: {...(clientData.primaryOwner || {}), email1: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Secondary Email 1" value={(clientData.secondaryOwner || {}).email1 || ''} onChange={(e) => setClientData({...clientData, secondaryOwner: {...(clientData.secondaryOwner || {}), email1: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Accountant Email 1" value={(clientData.accountant || {}).email1 || ''} onChange={(e) => setClientData({...clientData, accountant: {...(clientData.accountant || {}), email1: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Other Email 1" value={(clientData.otherContact || {}).email1 || ''} onChange={(e) => setClientData({...clientData, otherContact: {...(clientData.otherContact || {}), email1: e.target.value}})} /></td>
                      </tr>
                      <tr>
                        <td className="contact-row-label">Email ID 2</td>
                        <td><input type="email" placeholder="Primary Email 2" value={(clientData.primaryOwner || {}).email2 || ''} onChange={(e) => setClientData({...clientData, primaryOwner: {...(clientData.primaryOwner || {}), email2: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Secondary Email 2" value={(clientData.secondaryOwner || {}).email2 || ''} onChange={(e) => setClientData({...clientData, secondaryOwner: {...(clientData.secondaryOwner || {}), email2: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Accountant Email 2" value={(clientData.accountant || {}).email2 || ''} onChange={(e) => setClientData({...clientData, accountant: {...(clientData.accountant || {}), email2: e.target.value}})} /></td>
                        <td><input type="email" placeholder="Other Email 2" value={(clientData.otherContact || {}).email2 || ''} onChange={(e) => setClientData({...clientData, otherContact: {...(clientData.otherContact || {}), email2: e.target.value}})} /></td>
                      </tr>
                    </tbody>
                  </table>

                  <div className="update-contact-list">
                    <label>Do you want to update contact list ?</label>
                    <select value={clientData.updateContactList ? 'Yes' : 'No'} onChange={(e) => setClientData({...clientData, updateContactList: e.target.value === 'Yes'})}>
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                  </div>
                </div>
              )}

              {formStep === 'fees' && (
                <div className="fees-content">
                  <h3 className="fees-title">
                    <DollarSign size={20} />
                    AGREED FEES BY TASK
                  </h3>
                  <p style={{ color: '#64748b', fontSize: '12px', marginBottom: '16px' }}>
                    Set agreed fees for specific task types. These fees will auto-populate when creating tasks for this client.
                  </p>

                  <table className="fees-table" style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                      <tr style={{ background: 'linear-gradient(180deg, #10b981 0%, #059669 100%)' }}>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', width: '50px' }}>Sr.</th>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', minWidth: '140px' }}>Parent Task</th>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', minWidth: '160px' }}>Child Task</th>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', width: '120px' }}>Agreed Fees (â‚¹)</th>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', width: '120px' }}>Frequency</th>
                        <th style={{ padding: '10px 8px', color: '#fff', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600', width: '60px' }}></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(clientData.agreedFees || []).map((fee, idx) => (
                        <tr key={idx} style={{ borderBottom: '1px solid #e2e8f0', background: idx % 2 === 0 ? '#fff' : '#f8fafc' }}>
                          <td style={{ padding: '8px', textAlign: 'center', fontWeight: '600', color: '#64748b' }}>{idx + 1}</td>
                          <td style={{ padding: '8px' }}>
                            <select 
                              value={fee.parentTask || ''}
                              onChange={(e) => {
                                const newFees = [...clientData.agreedFees];
                                newFees[idx] = { ...newFees[idx], parentTask: e.target.value, childTask: '' };
                                setClientData({...clientData, agreedFees: newFees});
                              }}
                              style={{ width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '13px' }}
                            >
                              <option value="">Select Parent Task</option>
                              {Object.keys(PARENT_CHILD_TASKS).map(task => (
                                <option key={task} value={task}>{task}</option>
                              ))}
                            </select>
                          </td>
                          <td style={{ padding: '8px' }}>
                            <select 
                              value={fee.childTask || ''}
                              onChange={(e) => {
                                const newFees = [...clientData.agreedFees];
                                newFees[idx] = { ...newFees[idx], childTask: e.target.value };
                                setClientData({...clientData, agreedFees: newFees});
                              }}
                              style={{ width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '13px' }}
                              disabled={!fee.parentTask}
                            >
                              <option value="">Select Child Task</option>
                              {(PARENT_CHILD_TASKS[fee.parentTask] || []).map(child => (
                                <option key={child} value={child}>{child}</option>
                              ))}
                            </select>
                          </td>
                          <td style={{ padding: '8px' }}>
                            <input 
                              type="number" 
                              value={fee.fee || ''}
                              placeholder="0"
                              onChange={(e) => {
                                const newFees = [...clientData.agreedFees];
                                newFees[idx] = { ...newFees[idx], fee: e.target.value };
                                setClientData({...clientData, agreedFees: newFees});
                              }}
                              style={{ width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '13px' }}
                            />
                          </td>
                          <td style={{ padding: '8px' }}>
                            <select
                              value={fee.frequency || ''}
                              onChange={(e) => {
                                const newFees = [...clientData.agreedFees];
                                newFees[idx] = { ...newFees[idx], frequency: e.target.value };
                                setClientData({...clientData, agreedFees: newFees});
                              }}
                              style={{ width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '13px' }}
                            >
                              <option value="">Select</option>
                              <option value="Monthly">Monthly</option>
                              <option value="Quarterly">Quarterly</option>
                              <option value="Half-Yearly">Half-Yearly</option>
                              <option value="Annually">Annually</option>
                              <option value="One-time">One-time</option>
                            </select>
                          </td>
                          <td style={{ padding: '8px', textAlign: 'center' }}>
                            {clientData.agreedFees.length > 1 && (
                              <button
                                type="button"
                                onClick={() => {
                                  const newFees = clientData.agreedFees.filter((_, i) => i !== idx);
                                  setClientData({...clientData, agreedFees: newFees});
                                }}
                                style={{ background: '#fee2e2', border: 'none', borderRadius: '4px', padding: '6px 8px', cursor: 'pointer' }}
                                title="Remove"
                              >
                                <Trash2 size={14} color="#dc2626" />
                              </button>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  
                  <button
                    type="button"
                    onClick={() => {
                      const newFee = { parentTask: '', childTask: '', fee: '', frequency: '' };
                      setClientData({...clientData, agreedFees: [...(clientData.agreedFees || []), newFee]});
                    }}
                    style={{ marginTop: '12px', padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '6px' }}
                  >
                    <Plus size={14} /> Add More Fee Entry
                  </button>
                </div>
              )}

              {formStep === 'kyc' && (
                <div className="kyc-content">
                  <h3 className="kyc-title">
                    <FileText size={20} />
                    KYC DOCUMENT
                  </h3>

                  <div className="kyc-note">
                    <AlertCircle size={18} />
                    <span>Note : File size upto 20 MB and File with extension .DOC, .DOCX, .TXT, .PDF, .XLS, .XLSX, .CSV, .PDF, .PNG, JPG, .JPEG</span>
                  </div>

                  <table className="kyc-table">
                    <thead>
                      <tr>
                        <th style={{width: '60px'}}><FileText size={16} /> Sr.</th>
                        <th style={{width: '180px'}}><FileText size={16} /> Document</th>
                        <th><Upload size={16} /> Attachment</th>
                        <th style={{width: '200px'}}><Edit size={16} /> Remark</th>
                        <th style={{width: '120px'}}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {clientData.kycDocuments.map((doc, idx) => (
                        <tr key={doc.id}>
                          <td>{doc.id}.</td>
                          <td className="doc-name">{doc.name}</td>
                          <td>
                            <div style={{display: 'flex', flexDirection: 'column', gap: '4px'}}>
                              <input 
                                type="file"
                                accept=".doc,.docx,.txt,.pdf,.xls,.xlsx,.csv,.png,.jpg,.jpeg"
                                onChange={(e) => {
                                  const file = e.target.files[0];
                                  if (file) {
                                    // Check file size (max 5MB for Firebase)
                                    if (file.size > 5 * 1024 * 1024) {
                                      alert('File size must be less than 5MB');
                                      return;
                                    }
                                    // Convert to base64 for storage
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                      const newDocs = [...clientData.kycDocuments];
                                      newDocs[idx].file = file;
                                      newDocs[idx].fileName = file.name;
                                      newDocs[idx].fileData = event.target.result; // base64 data
                                      newDocs[idx].fileType = file.type;
                                      newDocs[idx].fileSize = file.size;
                                      setClientData({...clientData, kycDocuments: newDocs});
                                    };
                                    reader.readAsDataURL(file);
                                  }
                                }}
                              />
                              {doc.fileName && (
                                <div style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                                  {doc.fileData ? (
                                    <span style={{fontSize: '11px', color: '#10b981', fontWeight: '500'}}>
                                      âœ“ {doc.fileName}
                                    </span>
                                  ) : (
                                    <span style={{fontSize: '11px', color: '#f59e0b', fontWeight: '500'}}>
                                      âš  {doc.fileName} (re-upload needed)
                                    </span>
                                  )}
                                </div>
                              )}
                            </div>
                          </td>
                          <td>
                            <input 
                              type="text"
                              placeholder={`Enter ${doc.name} Remark`}
                              value={doc.remark || ''}
                              onChange={(e) => {
                                const newDocs = [...clientData.kycDocuments];
                                newDocs[idx].remark = e.target.value;
                                setClientData({...clientData, kycDocuments: newDocs});
                              }}
                            />
                          </td>
                          <td>
                            <div style={{display: 'flex', gap: '6px', flexWrap: 'wrap'}}>
                              {/* View Button - for images and PDFs */}
                              {doc.fileData && (doc.fileType?.startsWith('image/') || doc.fileType === 'application/pdf') && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    const newWindow = window.open();
                                    if (doc.fileType?.startsWith('image/')) {
                                      newWindow.document.write(`<html><head><title>${doc.fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#1f2937;"><img src="${doc.fileData}" style="max-width:100%;max-height:100vh;" /></body></html>`);
                                    } else {
                                      newWindow.document.write(`<html><head><title>${doc.fileName}</title></head><body style="margin:0;"><iframe src="${doc.fileData}" style="width:100%;height:100vh;border:none;"></iframe></body></html>`);
                                    }
                                  }}
                                  style={{padding: '4px 8px', background: '#8b5cf6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                >
                                  <Eye size={12} /> View
                                </button>
                              )}
                              {/* Download Button */}
                              {doc.fileData && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    const link = document.createElement('a');
                                    link.href = doc.fileData;
                                    link.download = doc.fileName || `${doc.name}.pdf`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                  }}
                                  style={{padding: '4px 8px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                >
                                  <Download size={12} /> Download
                                </button>
                              )}
                              {/* Clear File Button - only clears the file, keeps document row */}
                              {(doc.fileData || doc.fileName) && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (window.confirm(`Remove file from ${doc.name}?`)) {
                                      const newDocs = [...clientData.kycDocuments];
                                      newDocs[idx] = {
                                        ...newDocs[idx],
                                        file: null,
                                        fileName: '',
                                        fileData: '',
                                        fileType: '',
                                        fileSize: 0
                                      };
                                      setClientData({...clientData, kycDocuments: newDocs});
                                    }
                                  }}
                                  style={{padding: '4px 8px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                >
                                  <X size={12} /> Clear
                                </button>
                              )}
                              {/* Delete Row Button - only for custom documents */}
                              {doc.name === 'Custom Document' && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (window.confirm(`Delete this document row?`)) {
                                      const newDocs = clientData.kycDocuments.filter((_, i) => i !== idx);
                                      const renumbered = newDocs.map((d, i) => ({...d, id: i + 1}));
                                      setClientData({...clientData, kycDocuments: renumbered});
                                    }
                                  }}
                                  style={{padding: '4px 8px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                >
                                  <Trash2 size={12} /> Delete
                                </button>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>

                  <button 
                    type="button" 
                    className="btn-add-more-kyc"
                    onClick={() => {
                      const newDoc = {
                        id: clientData.kycDocuments.length + 1,
                        name: 'Custom Document',
                        file: null,
                        fileName: '',
                        fileData: '',
                        remark: ''
                      };
                      setClientData({...clientData, kycDocuments: [...clientData.kycDocuments, newDoc]});
                    }}
                    style={{ marginTop: '10px', padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}
                  >
                    <Plus size={14} style={{ marginRight: '6px', verticalAlign: 'middle' }} />
                    Add More
                  </button>
                </div>
              )}
            </div>
          )}

          {/* Footer Actions */}
          <div className="professional-form-footer">
            <button type="button" className="btn-cancel-pro" onClick={onClose}>
              Cancel
            </button>
            <button 
              type="button" 
              className="btn-submit-pro"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                handleSubmit(e);
              }}
            >
              <CheckCircle size={20} />
              {editingClient ? 'Update Client' : 'Create Client'}
            </button>
          </div>
        </form>
      </div>
    );
  };

  // Clients View
  const ClientsView = () => {
    const [clientSearchTerm, setClientSearchTerm] = useState('');
    const [clientSearchType, setClientSearchType] = useState('Client Name');
    const [showCreateClient, setShowCreateClient] = useState(false);
    const [editingClient, setEditingClient] = useState(null);
    const [viewingClient, setViewingClient] = useState(null);
    const [clientViewTab, setClientViewTab] = useState('basic');
    const [activeClientTab, setActiveClientTab] = useState('enable');
    const [selectedClients, setSelectedClients] = useState([]);
    const [sortBy, setSortBy] = useState('fileno'); // Default sort by Client Code
    const [clientFormStep, setClientFormStep] = useState('basic');

    // Helper to parse fileNo for numeric sorting (e.g., "1.10" -> 1.10)
    const parseFileNo = (fileNo) => {
      if (!fileNo) return 9999999;
      const parts = fileNo.split('.');
      if (parts.length !== 2) return 9999999;
      const group = parseInt(parts[0]) || 0;
      const client = parseInt(parts[1]) || 0;
      return group * 1000 + client; // e.g., 1.10 = 1010, 2.05 = 2005
    };

    // Remove duplicate clients by Client Code and sort by Client Code
    const dedupeAndSortClients = (clients) => {
      // Remove duplicates by fileNo (keep first occurrence)
      const seen = new Set();
      const uniqueClients = clients.filter(c => {
        if (!c.fileNo) return true; // Keep clients without fileNo
        if (seen.has(c.fileNo)) return false;
        seen.add(c.fileNo);
        return true;
      });
      
      // Sort by fileNo (numeric comparison)
      return uniqueClients.sort((a, b) => parseFileNo(a.fileNo) - parseFileNo(b.fileNo));
    };

    const enabledClients = dedupeAndSortClients(data.clients.filter(c => !c.disabled));
    const disabledClients = dedupeAndSortClients(data.clients.filter(c => c.disabled));

    const handleToggleClient = (clientId) => {
      setSelectedClients(prev => 
        prev.includes(clientId) 
          ? prev.filter(id => id !== clientId)
          : [...prev, clientId]
      );
    };

    const handleEditClient = (client) => {
      setEditingClient(client);
      setShowCreateClient(true);
    };

    const handleImportClients = async (file) => {
      if (!file) return;

      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          
          if (lines.length < 2) {
            alert('File is empty or invalid!');
            return;
          }
          
          // Parse CSV
          const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
          console.log('Parsed headers:', headers);
          const newClients = [];
          
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            // Handle quoted values
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let c of lines[i]) {
              if (c === '"') {
                inQuotes = !inQuotes;
              } else if (c === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += c;
              }
            }
            values.push(current.trim());
            
            const clientObj = {
              id: generateId(),
              disabled: false,
              services: []
            };
            
            headers.forEach((header, index) => {
              const value = values[index] || '';
              // Map CSV headers to client object properties (normalized)
              switch(header) {
                case 'name':
                case 'clientname':
                case 'client':
                  clientObj.name = value;
                  break;
                case 'email':
                case 'emailid':
                  clientObj.email = value;
                  break;
                case 'phone':
                case 'contact':
                case 'contactno':
                case 'mobile':
                  clientObj.phone = value;
                  break;
                case 'fileno':
                case 'file':
                case 'clientcode':
                case 'code':
                  clientObj.fileNo = value;
                  break;
                case 'groupname':
                case 'group':
                  clientObj.groupName = value;
                  break;
                case 'address':
                case 'officeaddress':
                  clientObj.address = value;
                  break;
                case 'gstin':
                case 'gst':
                case 'gstno':
                  clientObj.gstin = value;
                  break;
                case 'pan':
                case 'pancard':
                case 'pancardno':
                  clientObj.pan = value;
                  break;
                case 'aadhaar':
                case 'aadhar':
                case 'aadhaarno':
                  clientObj.aadhaar = value;
                  break;
                case 'state':
                  clientObj.state = value;
                  break;
                case 'dateofenrollment':
                case 'enrollmentdate':
                case 'date':
                  clientObj.dateOfEnrollment = value;
                  break;
                default:
                  break;
              }
            });
            
            // Validate required fields
            if (clientObj.name) {
              // Set groupName to name if not provided
              if (!clientObj.groupName) {
                clientObj.groupName = clientObj.name;
              }
              newClients.push(clientObj);
            }
          }
          
          if (newClients.length === 0) {
            alert('No valid clients found in file! Make sure the CSV has a "clientName" or "name" column.');
            return;
          }
          
          // Add clients to data - EXPLICITLY list all fields (no spread operator!)
          const updatedClients = [...data.clients, ...newClients];
          const updatedData = {
            tasks: data.tasks || [],
            clients: updatedClients,
            staff: data.staff || [],
            timesheets: data.timesheets || [],
            invoices: data.invoices || [],
            receipts: data.receipts || [],
            organizations: data.organizations || [],
            recurringSchedules: data.recurringSchedules || [],
            leaves: data.leaves || [],
            documents: data.documents || [],
            userPermissions: data.userPermissions || {},
            parentChildTasks: data.parentChildTasks || DEFAULT_PARENT_CHILD_TASKS,
            recurringBatches: data.recurringBatches || [],
            checklists: data.checklists || [],
            pendingApprovals: data.pendingApprovals || []
          };
          setData(updatedData);
          
          // Immediately save to Firebase using bulletproof function
          try {
            await saveAllDataToFirebase(updatedData);
            console.log('âœ… Bulk clients saved to Firebase!');
            alert(`âœ… Successfully imported ${newClients.length} client(s) and saved to database!`);
          } catch (error) {
            console.error('âŒ Error saving bulk clients:', error);
            alert(`Imported ${newClients.length} clients but error saving: ` + error.message);
          }
          
          // Reset file input
          document.getElementById('import-clients-file').value = '';
          
        } catch (error) {
          console.error('Import error:', error);
          alert('Error importing file: ' + error.message);
        }
      };
      
      reader.readAsText(file);
    };

    const handleDisableMultiple = () => {
      if (selectedClients.length === 0) {
        alert('Please select clients to disable');
        return;
      }
      
      // Validate each selected client - cannot disable if they have outstanding balance or open tasks
      const clientsToCheck = data.clients.filter(c => selectedClients.includes(c.id));
      const blockedClients = [];
      
      clientsToCheck.forEach(client => {
        const issues = [];
        
        // Check for outstanding balance
        const clientInvoices = (data.invoices || []).filter(inv => 
          inv.clientId === client.id || inv.clientName === client.name
        );
        const totalBilled = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
        const totalPaid = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amountPaid) || 0), 0);
        const outstanding = totalBilled - totalPaid;
        
        if (outstanding > 0) {
          issues.push(`Outstanding Balance: â‚¹${outstanding.toLocaleString('en-IN')}`);
        }
        
        // Check for open tasks (not completed)
        const clientOpenTasks = data.tasks.filter(t => 
          !t.deleted && 
          (t.clientId === client.id || t.client === client.name || t.clientName === client.name) &&
          t.status !== 'Completed' && 
          !t.completedCheck
        );
        
        if (clientOpenTasks.length > 0) {
          issues.push(`Open Tasks: ${clientOpenTasks.length}`);
        }
        
        if (issues.length > 0) {
          blockedClients.push({
            name: client.name,
            fileNo: client.fileNo,
            issues: issues
          });
        }
      });
      
      // If any clients are blocked, show error and don't proceed
      if (blockedClients.length > 0) {
        const errorMessage = blockedClients.map(c => 
          `â€¢ ${c.name} (${c.fileNo}): ${c.issues.join(', ')}`
        ).join('\n');
        
        alert(`âŒ Cannot disable the following client(s):\n\n${errorMessage}\n\nPlease clear outstanding balance and complete/delete open tasks first.`);
        return;
      }
      
      const clientNames = data.clients
        .filter(c => selectedClients.includes(c.id))
        .map(c => c.name)
        .slice(0, 3)
        .join(', ');
      
      // Check if approval is needed (RM needs Superadmin approval for client disable)
      const userRole = getCurrentUserRole();
      const approvalNeeded = needsApproval('client_disable', userRole);
      
      if (approvalNeeded) {
        const reason = prompt(`Reason for disabling ${selectedClients.length} client(s):`);
        if (reason === null) return; // User cancelled
        
        // Create approval request for each client or batch
        const clientsToDisable = data.clients.filter(c => selectedClients.includes(c.id));
        
        clientsToDisable.forEach(client => {
          const approval = createApprovalRequest(
            'client_disable',
            { clientId: client.id, clientName: client.name, fileNo: client.fileNo, reason },
            `Disable Client: ${client.name} (${client.fileNo})`
          );
          
          if (approval) {
            setData(prev => ({
              ...prev,
              pendingApprovals: [...(prev.pendingApprovals || []), approval]
            }));
          }
        });
        
        setSelectedClients([]);
        alert(`ðŸ“ ${selectedClients.length} client disable request(s) submitted for approval!\n\nSuperadmin will review and approve.`);
        return;
      }
      
      // Direct disable for Superadmin
      if (window.confirm(`Disable ${selectedClients.length} client(s)?`)) {
        setData(prev => ({
          ...prev,
          clients: prev.clients.map(c => 
            selectedClients.includes(c.id) ? { ...c, disabled: true } : c
          )
        }));
        setSelectedClients([]);
        alert('Clients disabled successfully');
      }
    };

    const handleReEnableClient = (clientId) => {
      if (window.confirm('Are you sure you want to re-enable this client?')) {
        setData(prev => ({
          ...prev,
          clients: prev.clients.map(c => 
            c.id === clientId ? { ...c, disabled: false } : c
          )
        }));
        alert('Client re-enabled successfully!');
      }
    };

    // Search and filter clients
    const getFilteredClients = (clients) => {
      if (!clientSearchTerm || clientSearchTerm.trim() === '') return clients;

      return clients.filter(client => {
        const searchLower = clientSearchTerm.toLowerCase().trim();
        const searchTerm = clientSearchTerm.trim();
        
        switch(clientSearchType) {
          case 'Client Name':
            return client.name?.toLowerCase().includes(searchLower);
          case 'Client Code':
            return client.fileNo?.toLowerCase().includes(searchLower);
          case 'Group No.':
            // Use exact match for Group No.
            const clientGroupNo = client.fileNo ? client.fileNo.split('.')[0] : '';
            return clientGroupNo === searchTerm;
          case 'PAN Card No':
            return client.pan?.toLowerCase().includes(searchLower);
          case 'Email':
            return client.email?.toLowerCase().includes(searchLower);
          default:
            return true;
        }
      });
    };

    // Sort clients
    const getSortedClients = (clients) => {
      const sorted = [...clients];
      
      switch(sortBy) {
        case 'name':
          return sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        case 'fileno':
          // Sort by Client Code numerically (1.01 < 1.10 < 2.01)
          return sorted.sort((a, b) => parseFileNo(a.fileNo) - parseFileNo(b.fileNo));
        case 'recent':
          return sorted.reverse();
        default:
          // Default: sort by Client Code
          return sorted.sort((a, b) => parseFileNo(a.fileNo) - parseFileNo(b.fileNo));
      }
    };

    const filteredEnabledClients = getSortedClients(getFilteredClients(enabledClients));
    const filteredDisabledClients = getSortedClients(getFilteredClients(disabledClients));

    return (
      <div className="clients-view">
        <div className="view-header">
          <div>
            <h1>Client Management</h1>
            <p className="view-subtitle">Manage client information and relationships</p>
          </div>
          <div className="header-buttons-group">
            <input
              type="file"
              id="import-clients-file"
              accept=".csv,.xlsx,.xls"
              style={{display: 'none'}}
              onChange={(e) => handleImportClients(e.target.files[0])}
            />
            <button 
              className="btn-secondary" 
              onClick={() => document.getElementById('import-clients-file').click()}
            >
              <Upload size={20} /> Import Clients
            </button>
            {hasActionPermission('canCreateClient') && (
            <button className="btn-primary" onClick={() => {
              setEditingClient(null);
              setShowCreateClient(true);
            }}>
              <Plus size={20} /> Add New Client
            </button>
            )}
          </div>
        </div>

        {!showCreateClient ? (
          <>
            {/* Search Clients */}
            <div className="client-search-section">
              <h3>Search Clients</h3>
              <div className="search-controls">
                <select 
                  className="search-type-select"
                  value={clientSearchType}
                  onChange={(e) => setClientSearchType(e.target.value)}
                >
                  <option>Client Name</option>
                  <option>Client Code</option>
                  <option>Group No.</option>
                  <option>PAN Card No</option>
                  <option>Email</option>
                </select>
                <input 
                  type="text"
                  className="search-input"
                  placeholder={`Search by ${clientSearchType}...`}
                  value={clientSearchTerm}
                  onChange={(e) => setClientSearchTerm(e.target.value)}
                />
                <button className="btn-search">Search</button>
              </div>
              <div className="client-stats">
                Total Enable Clients Found : {filteredEnabledClients.length} and Total Disable Clients : {filteredDisabledClients.length}
              </div>
            </div>

            {/* Tabs */}
            <div className="client-tabs">
              <button 
                className={`client-tab-btn ${activeClientTab === 'enable' ? 'active' : ''}`}
                onClick={() => setActiveClientTab('enable')}
              >
                Enable Clients
              </button>
              <button 
                className={`client-tab-btn ${activeClientTab === 'disable' ? 'active' : ''}`}
                onClick={() => setActiveClientTab('disable')}
              >
                Disabled Client
              </button>
            </div>

            {/* Enable Clients Tab */}
            {activeClientTab === 'enable' && (
              <div className="clients-table-section">
                <div className="table-header-actions">
                  <h3>Enable Clients</h3>
                  <div className="header-actions-right">
                    <button className="btn-action" onClick={handleDisableMultiple}>
                      Disable Multiple Clients
                    </button>
                    <div className="sorting-control">
                      <label>Sorting By</label>
                      <select value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
                        <option value="default">Default</option>
                        <option value="name">Name</option>
                        <option value="fileno">File No</option>
                        <option value="recent">Recently Added</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div className="clients-table-wrapper" style={{border: '1px solid #10b981', borderRadius: '8px', overflow: 'hidden'}}>
                  <table className="clients-table" style={{borderCollapse: 'collapse', width: '100%', fontSize: '12px'}}>
                    <thead>
                      <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '35px'}}><input type="checkbox" onChange={(e) => {
                          if (e.target.checked) {
                            setSelectedClients(filteredEnabledClients.map(c => c.id));
                          } else {
                            setSelectedClients([]);
                          }
                        }} /></th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '60px'}}>Edit</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '45px'}}>Sr.</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '70px'}}>Code</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', minWidth: '150px'}}>Client Name</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '55px'}}>Group</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '100px'}}>Contact</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', minWidth: '200px'}}>Address</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '150px'}}>Email</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '100px'}}>PAN</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '130px'}}>GSTIN</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '90px'}}>GSTIN Pwd</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '90px'}}>IT Pwd</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '80px'}}>State</th>
                        <th style={{padding: '10px 6px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px', width: '110px'}}>Aadhaar</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredEnabledClients.map((client, index) => (
                        <tr key={client.id} style={{background: index % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                            <input 
                              type="checkbox"
                              checked={selectedClients.includes(client.id)}
                              onChange={() => handleToggleClient(client.id)}
                            />
                          </td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb'}}>
                            <div style={{display: 'flex', gap: '4px'}}>
                              {hasActionPermission('canViewClients') && (
                              <button 
                                className="edit-icon-btn" 
                                onClick={() => { setViewingClient(client); setClientViewTab('basic'); }}
                                title="View Details"
                                style={{background: '#3b82f6', color: '#fff', padding: '4px', borderRadius: '4px', border: 'none', cursor: 'pointer'}}
                              >
                                <Eye size={14} />
                              </button>
                              )}
                              {hasActionPermission('canEditClient') && (
                              <button 
                                className="edit-icon-btn" 
                                onClick={() => handleEditClient(client)}
                                title="Edit Client"
                                style={{background: '#10b981', color: '#fff', padding: '4px', borderRadius: '4px', border: 'none', cursor: 'pointer'}}
                              >
                                <Edit size={14} />
                              </button>
                              )}
                            </div>
                          </td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px'}}>{index + 1}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontWeight: '600', fontSize: '11px', color: '#166534'}}>{formatFileNo(client.fileNo) || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.name || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px'}}>{client.fileNo ? client.fileNo.split('.')[0] : ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.phone || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px', maxWidth: '200px', whiteSpace: 'normal', lineHeight: '1.3'}}>{client.address || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.email || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.pan || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.gstin || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontFamily: 'monospace', fontSize: '10px'}}>{client.gstnPassword || '-'}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontFamily: 'monospace', fontSize: '10px'}}>{client.incomeTaxPassword || '-'}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.state || ''}</td>
                          <td style={{padding: '8px 6px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.aadhaar || ''}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Disabled Clients Tab */}
            {activeClientTab === 'disable' && (
              <div className="clients-table-section">
                <h3>Disabled Clients</h3>
                <div className="clients-table-wrapper" style={{border: '1px solid #10b981', borderRadius: '8px', overflow: 'hidden'}}>
                  <table className="clients-table" style={{borderCollapse: 'collapse', width: '100%', fontSize: '12px'}}>
                    <thead>
                      <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Sr.</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Code</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Client Name</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Group</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Contact</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Email</th>
                        <th style={{padding: '10px 8px', color: '#fff', fontWeight: '700', border: '1px solid #059669', fontSize: '11px'}}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {disabledClients.length === 0 ? (
                        <tr>
                          <td colSpan="7" style={{textAlign: 'center', padding: '40px', border: '1px solid #e5e7eb'}}>
                            No disabled clients
                          </td>
                        </tr>
                      ) : (
                        filteredDisabledClients.map((client, index) => (
                          <tr key={client.id} style={{background: index % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px'}}>{index + 1}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', fontWeight: '600', fontSize: '11px', color: '#166534'}}>{formatFileNo(client.fileNo) || ''}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.name || ''}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px'}}>{client.fileNo ? client.fileNo.split('.')[0] : ''}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.phone || ''}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{client.email || ''}</td>
                            <td style={{padding: '8px', border: '1px solid #e5e7eb'}}>
                              <div style={{display: 'flex', gap: '8px'}}>
                                <button 
                                  onClick={() => setViewingClient(client)}
                                  style={{padding: '5px 10px', fontSize: '11px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px'}}
                                >
                                  <Eye size={12} /> View
                                </button>
                                <button 
                                  onClick={() => handleReEnableClient(client.id)}
                                  style={{padding: '5px 10px', fontSize: '11px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer'}}
                                >
                                  Re-enable
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </>
        ) : (
          <CreateClientForm 
            key={editingClient ? editingClient.id : 'new-client'}
            editingClient={editingClient}
            onClose={() => {
              console.log('Closing form, resetting editingClient to null');
              setEditingClient(null);
              setShowCreateClient(false);
              // Force a small delay to ensure state clears
              setTimeout(() => {
                console.log('Form closed, editingClient should be null');
              }, 100);
            }} 
            onSave={(newClient, editingId) => {
              console.log('onSave called in ClientsView');
              console.log('New client to add/update:', newClient);
              console.log('Editing ID:', editingId);
              
              // Check if approval is needed for new client (Seniors/Articles need RM approval)
              const userRole = getCurrentUserRole();
              const approvalNeeded = !editingId && needsApproval('client_add', userRole);
              
              if (approvalNeeded) {
                // Create approval request instead of direct save
                const approval = createApprovalRequest(
                  'client_add',
                  newClient,
                  `New Client: ${newClient.name} (${newClient.fileNo})`
                );
                
                if (approval) {
                  setData(prev => ({
                    ...prev,
                    pendingApprovals: [...(prev.pendingApprovals || []), approval]
                  }));
                  setShowCreateClient(false);
                  setEditingClient(null);
                  alert('ðŸ“ Client submitted for approval!\n\nYour Reporting Manager will review and approve this client.');
                  return;
                }
              }
              
              // Direct save for Superadmin/RM or editing existing client
              setData(prev => {
                let updatedClients;
                if (editingId) {
                  // Update existing client
                  updatedClients = prev.clients.map(c => 
                    c.id === editingId ? { ...newClient, id: editingId } : c
                  );
                  console.log('Updated client');
                } else {
                  // Add new client
                  updatedClients = [...prev.clients, newClient];
                  console.log('Added new client');
                }
                
                const updatedData = {
                  ...prev,
                  clients: updatedClients
                };
                console.log('Updated clients:', updatedData.clients);
                return updatedData;
              });
              
              setShowCreateClient(false);
              setEditingClient(null);
              alert(editingId ? 'Client updated successfully!' : 'Client created successfully! Check the Enable Clients tab.');
            }}
          />
        )}

        {/* View Client Details Modal - Enhanced with Tabs */}
        {viewingClient && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.6)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '16px',
              width: '95%',
              maxWidth: '1000px',
              maxHeight: '90vh',
              overflow: 'hidden',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              {/* Modal Header */}
              <div style={{
                padding: '20px 24px',
                background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                color: '#fff',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div>
                  <h2 style={{margin: 0, fontSize: '20px', fontWeight: '600'}}>
                    <User size={24} style={{marginRight: '10px', verticalAlign: 'middle'}} />
                    {viewingClient.name}
                  </h2>
                  <p style={{margin: '4px 0 0', fontSize: '13px', opacity: 0.9}}>
                    Client Code: {viewingClient.fileNo || 'N/A'} â€¢ Group No.: {viewingClient.fileNo ? viewingClient.fileNo.split('.')[0] : 'N/A'}
                  </p>
                </div>
                <div style={{display: 'flex', gap: '10px'}}>
                  {hasActionPermission('canEditClient') && (
                    <button
                      onClick={() => {
                        setViewingClient(null);
                        handleEditClient(viewingClient);
                      }}
                      style={{
                        padding: '8px 16px',
                        background: 'rgba(255,255,255,0.2)',
                        color: '#fff',
                        border: '1px solid rgba(255,255,255,0.3)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        fontSize: '13px'
                      }}
                    >
                      <Edit size={16} /> Edit
                    </button>
                  )}
                  <button
                    onClick={() => setViewingClient(null)}
                    style={{
                      background: 'rgba(255,255,255,0.2)',
                      border: 'none',
                      borderRadius: '8px',
                      padding: '8px',
                      cursor: 'pointer',
                      color: '#fff'
                    }}
                  >
                    <X size={20} />
                  </button>
                </div>
              </div>

              {/* Modal Content with Tabs */}
              <div style={{padding: '0', overflowY: 'auto', maxHeight: 'calc(90vh - 100px)'}}>
                {/* Tab Navigation */}
                <div style={{ display: 'flex', borderBottom: '1px solid #e2e8f0', background: '#f8fafc', padding: '0 16px', overflowX: 'auto' }}>
                  {[
                    { id: 'basic', label: 'Basic Info' },
                    { id: 'credentials', label: 'User IDs & Passwords', show: viewingClient.gstnUserId || viewingClient.tracesUserId || viewingClient.eWayBillUserId || viewingClient.incomeTaxUserId },
                    { id: 'contacts', label: 'Contacts', show: viewingClient.primaryOwner?.name || viewingClient.secondaryOwner?.name || viewingClient.accountant?.name },
                    { id: 'fees', label: 'Agreed Fees', show: viewingClient.agreedFees?.some(f => f.parentTask || f.fee) },
                    { id: 'kyc', label: 'KYC Documents' },
                    { id: 'tasks', label: 'Tasks' }
                  ].filter(tab => tab.show !== false).map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setClientViewTab(tab.id)}
                      style={{
                        padding: '12px 20px',
                        border: 'none',
                        background: clientViewTab === tab.id ? '#fff' : 'transparent',
                        color: clientViewTab === tab.id ? '#10b981' : '#64748b',
                        fontWeight: clientViewTab === tab.id ? '600' : '500',
                        fontSize: '13px',
                        cursor: 'pointer',
                        borderBottom: clientViewTab === tab.id ? '2px solid #10b981' : '2px solid transparent',
                        whiteSpace: 'nowrap'
                      }}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>

                <div style={{ padding: '24px' }}>
                  {/* Basic Info Tab */}
                  {clientViewTab === 'basic' && (
                    <>
                      {/* Basic Info Section */}
                      <div style={{marginBottom: '24px'}}>
                        <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                          <span style={{width: '4px', height: '18px', background: '#3b82f6', borderRadius: '2px'}}></span>
                          Basic Information
                        </h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Client Name</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.name || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Client Code</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.fileNo || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Group No.</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.fileNo ? viewingClient.fileNo.split('.')[0] : '-'}</div>
                          </div>
                        </div>
                      </div>

                      {/* Contact Info Section */}
                      <div style={{marginBottom: '24px'}}>
                        <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                          <span style={{width: '4px', height: '18px', background: '#10b981', borderRadius: '2px'}}></span>
                          Contact Information
                        </h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Phone</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.phone || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Email</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.email || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Address</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.address || '-'}</div>
                          </div>
                        </div>
                      </div>

                      {/* Tax & Registration Section */}
                      <div style={{marginBottom: '24px'}}>
                        <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                          <span style={{width: '4px', height: '18px', background: '#f59e0b', borderRadius: '2px'}}></span>
                          Tax & Registration Details
                        </h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>PAN</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b', fontFamily: 'monospace'}}>{viewingClient.pan || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>GSTIN</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b', fontFamily: 'monospace'}}>{viewingClient.gstin || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>TAN</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b', fontFamily: 'monospace'}}>{viewingClient.tan || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Aadhaar</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b', fontFamily: 'monospace'}}>{viewingClient.aadhaar || '-'}</div>
                          </div>
                        </div>
                      </div>

                      {/* Location Section */}
                      <div>
                        <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                          <span style={{width: '4px', height: '18px', background: '#8b5cf6', borderRadius: '2px'}}></span>
                          Location Details
                        </h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>State</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.state || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>City</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.city || '-'}</div>
                          </div>
                          <div style={{background: '#f8fafc', padding: '14px', borderRadius: '8px'}}>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase'}}>Type of Client</div>
                            <div style={{fontSize: '14px', fontWeight: '500', color: '#1e293b'}}>{viewingClient.typeOfClient || '-'}</div>
                          </div>
                        </div>
                      </div>
                    </>
                  )}

                  {/* Credentials Tab */}
                  {clientViewTab === 'credentials' && (
                    <div>
                      <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '4px', height: '18px', background: '#3b82f6', borderRadius: '2px'}}></span>
                        Portal Credentials
                      </h3>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: '#f8fafc' }}>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#64748b', borderBottom: '1px solid #e2e8f0' }}>Portal</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#64748b', borderBottom: '1px solid #e2e8f0' }}>User ID</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#64748b', borderBottom: '1px solid #e2e8f0' }}>Password</th>
                          </tr>
                        </thead>
                        <tbody>
                          {viewingClient.gstnUserId && (
                            <tr style={{ borderBottom: '1px solid #e2e8f0' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>GSTN</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.gstnUserId}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.gstnPassword || '-'}</td>
                            </tr>
                          )}
                          {viewingClient.tracesUserId && (
                            <tr style={{ borderBottom: '1px solid #e2e8f0' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>Traces</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.tracesUserId}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.tracesPassword || '-'}</td>
                            </tr>
                          )}
                          {viewingClient.eWayBillUserId && (
                            <tr style={{ borderBottom: '1px solid #e2e8f0' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>E-Way Bill</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.eWayBillUserId}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.eWayBillPassword || '-'}</td>
                            </tr>
                          )}
                          {viewingClient.incomeTaxUserId && (
                            <tr style={{ borderBottom: '1px solid #e2e8f0' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>Income Tax</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.incomeTaxUserId}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{viewingClient.incomeTaxPassword || '-'}</td>
                            </tr>
                          )}
                          {(viewingClient.otherCredentials || []).filter(c => c.portalName).map((cred, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #e2e8f0' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>{cred.portalName}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{cred.userId}</td>
                              <td style={{ padding: '12px', fontFamily: 'monospace' }}>{cred.password || '-'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}

                  {/* Contacts Tab */}
                  {clientViewTab === 'contacts' && (
                    <div>
                      <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '4px', height: '18px', background: '#10b981', borderRadius: '2px'}}></span>
                        Contact Persons
                      </h3>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                        {viewingClient.primaryOwner?.name && (
                          <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '8px' }}>
                            <div style={{ fontSize: '12px', color: '#10b981', fontWeight: '600', marginBottom: '8px' }}>PRIMARY OWNER</div>
                            <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '6px' }}>{viewingClient.primaryOwner.name}</div>
                            {viewingClient.primaryOwner.contact1 && <div style={{ fontSize: '13px', color: '#64748b' }}>ðŸ“ž {viewingClient.primaryOwner.contact1}</div>}
                            {viewingClient.primaryOwner.contact2 && <div style={{ fontSize: '13px', color: '#64748b' }}>ðŸ“ž {viewingClient.primaryOwner.contact2}</div>}
                            {viewingClient.primaryOwner.email1 && <div style={{ fontSize: '13px', color: '#64748b' }}>Email:  {viewingClient.primaryOwner.email1}</div>}
                            {viewingClient.primaryOwner.email2 && <div style={{ fontSize: '13px', color: '#64748b' }}>Email:  {viewingClient.primaryOwner.email2}</div>}
                          </div>
                        )}
                        {viewingClient.secondaryOwner?.name && (
                          <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '8px' }}>
                            <div style={{ fontSize: '12px', color: '#3b82f6', fontWeight: '600', marginBottom: '8px' }}>SECONDARY OWNER</div>
                            <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '6px' }}>{viewingClient.secondaryOwner.name}</div>
                            {viewingClient.secondaryOwner.contact1 && <div style={{ fontSize: '13px', color: '#64748b' }}>ðŸ“ž {viewingClient.secondaryOwner.contact1}</div>}
                            {viewingClient.secondaryOwner.email1 && <div style={{ fontSize: '13px', color: '#64748b' }}>Email:  {viewingClient.secondaryOwner.email1}</div>}
                          </div>
                        )}
                        {viewingClient.accountant?.name && (
                          <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '8px' }}>
                            <div style={{ fontSize: '12px', color: '#f59e0b', fontWeight: '600', marginBottom: '8px' }}>ACCOUNTANT</div>
                            <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '6px' }}>{viewingClient.accountant.name}</div>
                            {viewingClient.accountant.contact1 && <div style={{ fontSize: '13px', color: '#64748b' }}>ðŸ“ž {viewingClient.accountant.contact1}</div>}
                            {viewingClient.accountant.email1 && <div style={{ fontSize: '13px', color: '#64748b' }}>Email:  {viewingClient.accountant.email1}</div>}
                          </div>
                        )}
                        {viewingClient.otherContact?.name && (
                          <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '8px' }}>
                            <div style={{ fontSize: '12px', color: '#8b5cf6', fontWeight: '600', marginBottom: '8px' }}>OTHER CONTACT</div>
                            <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '6px' }}>{viewingClient.otherContact.name}</div>
                            {viewingClient.otherContact.contact1 && <div style={{ fontSize: '13px', color: '#64748b' }}>ðŸ“ž {viewingClient.otherContact.contact1}</div>}
                            {viewingClient.otherContact.email1 && <div style={{ fontSize: '13px', color: '#64748b' }}>Email:  {viewingClient.otherContact.email1}</div>}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Agreed Fees Tab */}
                  {clientViewTab === 'fees' && (
                    <div>
                      <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '4px', height: '18px', background: '#f59e0b', borderRadius: '2px'}}></span>
                        Agreed Fees by Task
                      </h3>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: 'linear-gradient(180deg, #10b981 0%, #059669 100%)' }}>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Parent Task</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Child Task</th>
                            <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Agreed Fees</th>
                            <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Frequency</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(viewingClient.agreedFees || []).filter(f => f.parentTask || f.fee).map((fee, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #e2e8f0', background: idx % 2 === 0 ? '#fff' : '#f8fafc' }}>
                              <td style={{ padding: '12px', fontWeight: '500' }}>{fee.parentTask || '-'}</td>
                              <td style={{ padding: '12px' }}>{fee.childTask || '-'}</td>
                              <td style={{ padding: '12px', textAlign: 'right', fontWeight: '600', color: '#10b981' }}>â‚¹{parseFloat(fee.fee || 0).toLocaleString('en-IN')}</td>
                              <td style={{ padding: '12px', textAlign: 'center' }}>
                                <span style={{ padding: '4px 10px', background: '#dbeafe', color: '#1d4ed8', borderRadius: '12px', fontSize: '12px' }}>
                                  {fee.frequency || '-'}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}

                  {/* KYC Documents Tab */}
                  {clientViewTab === 'kyc' && (
                    <div>
                      <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '4px', height: '18px', background: '#8b5cf6', borderRadius: '2px'}}></span>
                        KYC Documents
                      </h3>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: 'linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%)' }}>
                            <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase', width: '60px' }}>Sr.</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Document Type</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>File Name</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase' }}>Remark</th>
                            <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#fff', textTransform: 'uppercase', width: '150px' }}>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(viewingClient.kycDocuments || []).map((doc, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #e2e8f0', background: idx % 2 === 0 ? '#fff' : '#f8fafc' }}>
                              <td style={{ padding: '12px', textAlign: 'center', fontWeight: '500' }}>{doc.id || idx + 1}</td>
                              <td style={{ padding: '12px', fontWeight: '500' }}>{doc.name}</td>
                              <td style={{ padding: '12px', color: '#64748b' }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                  <FileText size={14} style={{color: doc.fileName ? '#8b5cf6' : '#d1d5db'}} />
                                  {doc.fileName || <span style={{color: '#9ca3af', fontStyle: 'italic'}}>No file uploaded</span>}
                                </div>
                              </td>
                              <td style={{ padding: '12px', color: '#64748b', fontSize: '13px' }}>{doc.remark || '-'}</td>
                              <td style={{ padding: '12px', textAlign: 'center' }}>
                                {doc.fileData ? (
                                  <div style={{display: 'flex', gap: '6px', justifyContent: 'center'}}>
                                    {/* View Button - for images and PDFs */}
                                    {(doc.fileType?.startsWith('image/') || doc.fileType === 'application/pdf') && (
                                      <button
                                        onClick={() => {
                                          const newWindow = window.open();
                                          if (doc.fileType?.startsWith('image/')) {
                                            newWindow.document.write(`<html><head><title>${doc.fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#1f2937;"><img src="${doc.fileData}" style="max-width:100%;max-height:100vh;" /></body></html>`);
                                          } else {
                                            newWindow.document.write(`<html><head><title>${doc.fileName}</title></head><body style="margin:0;"><iframe src="${doc.fileData}" style="width:100%;height:100vh;border:none;"></iframe></body></html>`);
                                          }
                                        }}
                                        style={{padding: '4px 8px', background: '#8b5cf6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                      >
                                        <Eye size={12} /> View
                                      </button>
                                    )}
                                    {/* Download Button */}
                                    <button
                                      onClick={() => {
                                        const link = document.createElement('a');
                                        link.href = doc.fileData;
                                        link.download = doc.fileName || `${doc.name}.pdf`;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                      }}
                                      style={{padding: '4px 8px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '3px'}}
                                    >
                                      <Download size={12} /> Download
                                    </button>
                                  </div>
                                ) : doc.fileName ? (
                                  <span style={{color: '#f59e0b', fontSize: '11px', fontWeight: '500'}}>âš  Re-upload needed</span>
                                ) : (
                                  <span style={{color: '#9ca3af', fontSize: '12px'}}>-</span>
                                )}
                              </td>
                            </tr>
                          ))}
                          {(!viewingClient.kycDocuments || viewingClient.kycDocuments.length === 0) && (
                            <tr>
                              <td colSpan={5} style={{padding: '24px', textAlign: 'center', color: '#9ca3af'}}>
                                No KYC documents configured
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                  )}

                  {/* Tasks Tab */}
                  {clientViewTab === 'tasks' && (
                    <div>
                      <h3 style={{fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '4px', height: '18px', background: '#06b6d4', borderRadius: '2px'}}></span>
                        Task Summary
                      </h3>
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '24px'}}>
                        {(() => {
                          const clientTasks = data.tasks.filter(t => t.clientId === viewingClient.id || t.clientName === viewingClient.name);
                          const openTasks = clientTasks.filter(t => !t.deleted && t.status !== 'Completed' && !t.completedCheck);
                          const completedTasks = clientTasks.filter(t => t.status === 'Completed' || t.completedCheck);
                          const totalBilled = data.invoices?.filter(inv => inv.clientId === viewingClient.id).reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0) || 0;
                          return (
                            <>
                              <div style={{background: '#eff6ff', padding: '16px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#3b82f6'}}>{clientTasks.length}</div>
                                <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>Total Tasks</div>
                              </div>
                              <div style={{background: '#fef3c7', padding: '16px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#f59e0b'}}>{openTasks.length}</div>
                                <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>Open Tasks</div>
                              </div>
                              <div style={{background: '#dcfce7', padding: '16px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#10b981'}}>{completedTasks.length}</div>
                                <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>Completed</div>
                              </div>
                              <div style={{background: '#f0fdf4', padding: '16px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#16a34a'}}>â‚¹{totalBilled.toLocaleString('en-IN')}</div>
                                <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>Total Billed</div>
                              </div>
                            </>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Staff View
  const filteredStaff = getStaffByCategory(activeStaffCategory).filter(staff => {
    if (!staffSearchTerm) return true;
    const searchLower = staffSearchTerm.toLowerCase();
    return (
      staff.name.toLowerCase().includes(searchLower) ||
      staff.email.toLowerCase().includes(searchLower) ||
      (staff.phone && staff.phone.includes(staffSearchTerm))
    );
  });

  // Staff CSV Upload Handler
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [uploadPreview, setUploadPreview] = useState([]);
  const [uploadError, setUploadError] = useState('');

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.csv')) {
      setUploadError('Please upload a CSV file');
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        console.log('CSV Headers:', headers);
        
        // Only require name, email, password
        const requiredHeaders = ['name', 'email', 'password'];
        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
        
        if (missingHeaders.length > 0) {
          setUploadError(`Missing required columns: ${missingHeaders.join(', ')}. Required: name, email, password`);
          return;
        }

        // Get column indices (some may be -1 if not present)
        const nameIdx = headers.indexOf('name');
        const emailIdx = headers.indexOf('email');
        const phoneIdx = headers.indexOf('phone');
        const roleIdx = headers.indexOf('role');
        const dateOfJoinIdx = headers.indexOf('dateofjoin');
        const dateOfBirthIdx = headers.indexOf('dateofbirth');
        const passwordIdx = headers.indexOf('password');

        // Get existing emails for duplicate check
        const existingEmails = data.staff.map(s => s.email.toLowerCase());
        const newEmails = new Set();
        const duplicateEmails = [];
        const duplicateInFile = [];

        const staffData = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Simple split by comma
          const values = line.split(',').map(v => v.trim());
          
          console.log(`Row ${i}:`, values);
          
          // Get values by index
          const name = nameIdx >= 0 ? (values[nameIdx] || '') : '';
          const email = emailIdx >= 0 ? (values[emailIdx] || '') : '';
          const phone = phoneIdx >= 0 ? (values[phoneIdx] || '') : '';
          const roleRaw = roleIdx >= 0 ? (values[roleIdx] || '') : '';
          const dateOfJoin = dateOfJoinIdx >= 0 ? (values[dateOfJoinIdx] || '') : '';
          const dateOfBirth = dateOfBirthIdx >= 0 ? (values[dateOfBirthIdx] || '') : '';
          const password = passwordIdx >= 0 ? (values[passwordIdx] || '') : '';
          
          console.log(`Parsed - Name: ${name}, Email: ${email}, Password: ${password}`);
          
          // Skip if no name or email or password
          if (!name || !email || !password) {
            console.log(`Skipping row ${i}: missing name, email, or password`);
            continue;
          }
          
          const emailLower = email.toLowerCase();
          
          // Check for duplicate in existing staff
          if (existingEmails.includes(emailLower)) {
            duplicateEmails.push(email);
            continue;
          }
          
          // Check for duplicate within the file
          if (newEmails.has(emailLower)) {
            duplicateInFile.push(email);
            continue;
          }
          
          newEmails.add(emailLower);
          
          // Normalize role to match expected values
          let role = roleRaw || 'Articles';
          const roleLower = role.toLowerCase().trim();
          if (roleLower.includes('superadmin') || roleLower.includes('admin') || roleLower.includes('partner')) role = 'Superadmin';
          else if (roleLower.includes('manager') || roleLower.includes('reporting')) role = 'Reporting Manager';
          else if (roleLower.includes('senior') || roleLower.includes('associate')) role = 'Seniors';
          else if (roleLower.includes('article') || roleLower.includes('intern')) role = 'Articles';
          else role = 'Articles'; // Default
          
          console.log(`Final - Name: ${name}, Email: ${email}, Password: ${password}, Role: ${role}`);
          
          staffData.push({
            id: generateId(),
            name: name,
            email: email,
            phone: phone,
            role: role,
            dateOfJoin: dateOfJoin,
            dateOfBirth: dateOfBirth,
            password: password,
            status: 'Active'
          });
        }

        console.log('Total parsed staff:', staffData.length);
        console.log('Staff data:', staffData);

        // Build error/warning message
        let warningMsg = '';
        if (duplicateEmails.length > 0) {
          warningMsg += `Skipped ${duplicateEmails.length} duplicate email(s) already in system. `;
        }
        if (duplicateInFile.length > 0) {
          warningMsg += `Skipped ${duplicateInFile.length} duplicate email(s) within file.`;
        }

        if (staffData.length === 0) {
          setUploadError(warningMsg || 'No valid staff data found. Ensure CSV has: name, email, password columns');
          return;
        }

        setUploadPreview(staffData);
        setUploadError(warningMsg);
      } catch (err) {
        setUploadError('Error parsing CSV file: ' + err.message);
      }
    };
    reader.readAsText(file);
  };

  const confirmUpload = async () => {
    // Final duplicate check before saving
    const existingEmails = data.staff.map(s => s.email.toLowerCase());
    const validStaff = uploadPreview.filter(s => !existingEmails.includes(s.email.toLowerCase()));
    
    if (validStaff.length === 0) {
      alert('All staff members already exist in the system!');
      return;
    }
    
    const updatedStaff = [...data.staff, ...validStaff];
    // EXPLICITLY list all fields (no spread operator!)
    const updatedData = {
      tasks: data.tasks || [],
      clients: data.clients || [],
      staff: updatedStaff,
      timesheets: data.timesheets || [],
      invoices: data.invoices || [],
      receipts: data.receipts || [],
      organizations: data.organizations || [],
      recurringSchedules: data.recurringSchedules || [],
      leaves: data.leaves || [],
      documents: data.documents || [],
      userPermissions: data.userPermissions || {},
      parentChildTasks: data.parentChildTasks || DEFAULT_PARENT_CHILD_TASKS,
      recurringBatches: data.recurringBatches || [],
      checklists: data.checklists || [],
      pendingApprovals: data.pendingApprovals || []
    };
    setData(updatedData);
    
    // Immediately save to Firebase using bulletproof function
    try {
      await saveAllDataToFirebase(updatedData);
      console.log('âœ… Bulk staff saved to Firebase!');
      alert(`âœ… Successfully imported ${validStaff.length} staff members and saved to database!`);
      setShowUploadModal(false);
      setUploadPreview([]);
    } catch (error) {
      console.error('âŒ Error saving bulk staff:', error);
      alert(`Imported ${validStaff.length} staff but error saving: ` + error.message);
      setShowUploadModal(false);
      setUploadPreview([]);
    }
  };

  const downloadSampleCSV = () => {
    const sampleData = `name,email,phone,role,dateofjoin,dateofbirth,password
Rahul Sharma,rahul.sharma@example.com,9876543210,Superadmin,2020-01-15,1985-03-22,rahul@123
Priya Patel,priya.patel@example.com,9876543211,Reporting Manager,2019-06-01,1988-07-14,priya@123
Amit Kumar,amit.kumar@example.com,9876543212,Seniors,2021-03-10,1990-11-05,amit@123
Sneha Gupta,sneha.gupta@example.com,9876543213,Articles,2023-01-05,1999-02-28,sneha@123
Vikram Singh,vikram.singh@example.com,9876543214,Reporting Manager,2018-09-20,1986-12-10,vikram@123
Ananya Reddy,ananya.reddy@example.com,9876543215,Seniors,2020-07-15,1992-04-18,ananya@123
Rajesh Verma,rajesh.verma@example.com,9876543216,Superadmin,2015-04-01,1980-08-25,rajesh@123
Meera Iyer,meera.iyer@example.com,9876543217,Articles,2024-01-10,2000-06-30,meera@123
Karthik Nair,karthik.nair@example.com,9876543218,Seniors,2022-02-28,1994-09-12,karthik@123
Pooja Mishra,pooja.mishra@example.com,9876543219,Reporting Manager,2017-11-11,1987-01-07,pooja@123
Arjun Menon,arjun.menon@example.com,9876543220,Articles,2023-07-20,1998-05-15,arjun@123
Divya Krishnan,divya.krishnan@example.com,9876543221,Seniors,2021-09-05,1993-10-22,divya@123
Sanjay Joshi,sanjay.joshi@example.com,9876543222,Superadmin,2012-08-18,1978-04-03,sanjay@123
Neha Agarwal,neha.agarwal@example.com,9876543223,Articles,2024-06-01,2001-12-19,neha@123
Rohan Desai,rohan.desai@example.com,9876543224,Reporting Manager,2019-03-25,1989-07-08,rohan@123`;
    
    try {
      const blob = new Blob([sampleData], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'sample_staff_data.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (err) {
      // Fallback: open in new window
      const dataStr = 'data:text/csv;charset=utf-8,' + encodeURIComponent(sampleData);
      window.open(dataStr, '_blank');
    }
  };

  const StaffView = () => {
    // Define all sidebar menu items and their sub-items for permissions
    const MENU_STRUCTURE = {
      dashboard: { label: 'Dashboard', icon: 'ðŸ ', subItems: [] },
      tasks: {
        label: 'Tasks',
        icon: 'âœ…',
        subItems: Object.keys(PARENT_CHILD_TASKS).map(parent => ({
          id: `task_${parent.toLowerCase().replace(/\s+/g, '_')}`,
          label: parent,
          children: PARENT_CHILD_TASKS[parent].map(child => ({
            id: `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`,
            label: child
          }))
        }))
      },
      clients: { label: 'Clients', icon: 'ðŸ‘¥', subItems: [] },
      staff: { label: 'Staff', icon: 'ðŸ‘¤', subItems: [] },
      invoicing: {
        label: 'Invoicing',
        icon: 'ðŸ’°',
        subItems: [
          { id: 'invoicing_dashboard', label: 'Dashboard' },
          { id: 'invoicing_billing', label: 'Billing' },
          { id: 'invoicing_unbilledTasks', label: 'Unbilled Tasks' },
          { id: 'invoicing_receipts', label: 'Receipts' },
          { id: 'invoicing_debtors', label: 'Debtors' },
          { id: 'invoicing_organizations', label: 'Organization' }
        ]
      },
      timesheetReports: { label: 'Timesheet Reports', icon: 'â±ï¸', subItems: [] },
      templates: { label: 'Templates', icon: 'ðŸ“„', subItems: [] },
      reports: { label: 'Reports', icon: 'ðŸ“Š', subItems: [] }
    };
    
    // All action permission keys
    const ACTION_PERMISSIONS = [
      'perm_canViewDashboard', 'perm_canCreateTask', 'perm_canEditTask', 'perm_canDeleteTask',
      'perm_canAssignTask', 'perm_canChangeTaskStatus', 'perm_canViewClients', 'perm_canCreateClient',
      'perm_canEditClient', 'perm_canDeleteClient', 'perm_canViewInvoicing', 'perm_canCreateInvoice',
      'perm_canEditInvoice', 'perm_canDeleteInvoice', 'perm_canPostReceipt', 'perm_canViewReports',
      'perm_canExportData', 'perm_canImportData', 'perm_canManageStaff', 'perm_canViewTimesheet'
    ];
    
    const loadStaffPermissions = (staffId) => {
      const existing = data.userPermissions?.[staffId] || {};
      if (Object.keys(existing).length === 0) {
        // Initialize all permissions to true by default
        const defaults = {};
        // Sidebar menu items
        Object.keys(MENU_STRUCTURE).forEach(menuId => {
          defaults[menuId] = true;
          const menu = MENU_STRUCTURE[menuId];
          if (menu.subItems) {
            menu.subItems.forEach(sub => {
              defaults[sub.id] = true;
              if (sub.children) {
                sub.children.forEach(child => {
                  defaults[child.id] = true;
                });
              }
            });
          }
        });
        // Task categories
        Object.keys(PARENT_CHILD_TASKS).forEach(parent => {
          const parentId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}`;
          defaults[parentId] = true;
          PARENT_CHILD_TASKS[parent].forEach(child => {
            const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
            defaults[childId] = true;
          });
        });
        // Action permissions
        ACTION_PERMISSIONS.forEach(perm => {
          defaults[perm] = true;
        });
        return defaults;
      }
      return existing;
    };
    
    const handleOpenControls = (staff) => {
      setControllingStaff(staff);
      setStaffPermissions(loadStaffPermissions(staff.id));
      setActivePermissionTab('sidebar');
      setShowStaffControlsModal(true);
    };
    
    // Simple toggle - just flip the boolean value
    const togglePermission = (permId) => {
      console.log('Toggling permission:', permId, 'Current value:', staffPermissions[permId]);
      setStaffPermissions(prev => {
        const currentVal = prev[permId];
        const newVal = currentVal === true ? false : true;
        console.log('New value:', newVal);
        return { ...prev, [permId]: newVal };
      });
    };
    
    const toggleParentAndChildren = (menuId, menu) => {
      const currentVal = staffPermissions[menuId];
      const newVal = currentVal === true ? false : true;
      
      setStaffPermissions(prev => {
        const updates = { ...prev, [menuId]: newVal };
        if (menu.subItems) {
          menu.subItems.forEach(sub => {
            updates[sub.id] = newVal;
            if (sub.children) {
              sub.children.forEach(child => { updates[child.id] = newVal; });
            }
          });
        }
        return updates;
      });
    };
    
    // Toggle task parent and all its children
    const toggleTaskParent = (parent) => {
      const parentId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}`;
      const currentVal = staffPermissions[parentId];
      const newVal = currentVal === true ? false : true;
      
      setStaffPermissions(prev => {
        const updates = { ...prev, [parentId]: newVal };
        PARENT_CHILD_TASKS[parent].forEach(child => {
          const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
          updates[childId] = newVal;
        });
        return updates;
      });
    };
    
    // Tab-specific Select All / Deselect All
    const selectAllForTab = (tabId, selectAll) => {
      console.log('selectAllForTab called:', tabId, selectAll);
      
      setStaffPermissions(prev => {
        const updates = { ...prev };
        
        if (tabId === 'sidebar') {
          // Sidebar menu items only
          Object.keys(MENU_STRUCTURE).forEach(menuId => {
            updates[menuId] = selectAll;
            const menu = MENU_STRUCTURE[menuId];
            if (menu.subItems) {
              menu.subItems.forEach(sub => {
                updates[sub.id] = selectAll;
                if (sub.children) {
                  sub.children.forEach(child => { updates[child.id] = selectAll; });
                }
              });
            }
          });
        } else if (tabId === 'tasks') {
          // Task categories only
          Object.keys(PARENT_CHILD_TASKS).forEach(parent => {
            const parentId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}`;
            updates[parentId] = selectAll;
            PARENT_CHILD_TASKS[parent].forEach(child => {
              const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
              updates[childId] = selectAll;
            });
          });
        } else if (tabId === 'permissions') {
          // Action permissions only
          ACTION_PERMISSIONS.forEach(perm => {
            updates[perm] = selectAll;
          });
        }
        
        console.log('Updated permissions:', updates);
        return updates;
      });
    };
    
    const saveStaffPermissions = () => {
      if (!controllingStaff) return;
      console.log('Saving permissions for staff:', controllingStaff.id, controllingStaff.name);
      console.log('Permissions being saved:', staffPermissions);
      setData(prev => ({
        ...prev,
        userPermissions: { ...(prev.userPermissions || {}), [controllingStaff.id]: staffPermissions }
      }));
      setShowStaffControlsModal(false);
      alert(`Permissions saved for ${controllingStaff.name}! They will see changes on next login.`);
    };
    
    return (
    <div className="staff-view">
      <div className="view-header">
        <div>
          <h1>Staff Management</h1>
          <p className="view-subtitle">Manage your team members across different roles</p>
        </div>
        <div className="header-actions">
          {(currentUser?.isSuperAdmin || currentUser?.role === 'Superadmin') && (
            <button 
              className="btn-secondary" 
              onClick={() => setShowRolesPermissionsModal(true)}
              style={{background: '#8b5cf6', color: '#fff', border: 'none'}}
            >
              <Settings size={18} /> Roles & Permissions
            </button>
          )}
          <button className="btn-secondary" onClick={() => setShowUploadModal(true)}>
            <Upload size={18} /> Upload Staff
          </button>
          <button className="btn-primary" onClick={handleCreateStaff}>
            <Plus size={20} /> Add Staff Member
          </button>
        </div>
      </div>

      {/* Staff Categories Tabs */}
      <div className="staff-categories-tabs">
        {staffCategories.map(category => {
          const count = getStaffByCategory(category).length;
          return (
            <button
              key={category}
              className={`category-tab ${activeStaffCategory === category ? 'active' : ''}`}
              onClick={() => setActiveStaffCategory(category)}
            >
              <span className="tab-label">{category}</span>
              <span className="tab-count">{count}</span>
            </button>
          );
        })}
      </div>

      {/* Search Bar */}
      <div className="staff-search-bar">
        <div className="search-input-wrapper">
          <Search size={20} />
          <input
            type="text"
            placeholder="Search by name, email, or phone..."
            value={staffSearchTerm}
            onChange={(e) => setStaffSearchTerm(e.target.value)}
          />
        </div>
        <div className="staff-count-display">
          Total {activeStaffCategory}: <strong>{filteredStaff.length}</strong>
        </div>
      </div>

      {/* Staff List Table */}
      <div className="staff-table-container">
        {filteredStaff.length === 0 ? (
          <div className="empty-state">
            <Users size={64} color="#cbd5e1" />
            <h3>No {activeStaffCategory} Found</h3>
            <p>Add your first {activeStaffCategory} member to get started</p>
            <button className="btn-primary" onClick={handleCreateStaff}>
              <Plus size={18} /> Add {activeStaffCategory}
            </button>
          </div>
        ) : (
          <table className="staff-table">
            <thead>
              <tr>
                <th>Edit</th>
                <th>Controls</th>
                <th>Staff Name</th>
                <th>Email</th>
                <th>Contact No</th>
                <th>Reporting Manager</th>
                <th>Date of Join</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {filteredStaff.map(staff => (
                <tr key={staff.id}>
                  <td>
                    <button 
                      className="icon-btn-staff edit-btn"
                      title="Edit Staff"
                      onClick={() => handleEditStaff(staff)}
                    >
                      <Edit size={16} />
                    </button>
                  </td>
                  <td>
                    <button 
                      className="icon-btn-staff controls-btn"
                      title="Assign Controls"
                      onClick={() => handleOpenControls(staff)}
                      disabled={staff.isSuperAdmin || staff.role === 'Superadmin'}
                      style={staff.isSuperAdmin || staff.role === 'Superadmin' ? {opacity: 0.5, cursor: 'not-allowed'} : {}}
                    >
                      <Settings size={16} />
                    </button>
                  </td>
                  <td className="staff-name-cell">
                    <div className="staff-avatar-small">{staff.name[0]}</div>
                    <span>{staff.name}</span>
                  </td>
                  <td>{staff.email}</td>
                  <td>{staff.phone || 'N/A'}</td>
                  <td>
                    {staff.reportingManager ? (
                      <span style={{ color: '#10b981', fontWeight: 500 }}>{staff.reportingManager}</span>
                    ) : (
                      <span style={{ color: '#9ca3af', fontStyle: 'italic' }}>
                        {staff.role === 'Superadmin' || staff.role === 'Reporting Manager' ? 'â€”' : 'Not Assigned'}
                      </span>
                    )}
                  </td>
                  <td>{staff.dateOfJoin || 'N/A'}</td>
                  <td>
                    <span className={`status-badge-staff status-${staff.status?.toLowerCase()}`}>
                      {staff.status || 'Active'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* Staff Edit/Create Modal */}
      {showStaffModal && (
        <StaffFormModal
          staff={editingStaff}
          onClose={() => setShowStaffModal(false)}
          onSave={handleSaveStaff}
        />
      )}

      {/* Staff Upload Modal */}
      {showUploadModal && (
        <div className="modal-overlay" onClick={() => { setShowUploadModal(false); setUploadPreview([]); setUploadError(''); }}>
          <div className="upload-modal" onClick={(e) => e.stopPropagation()}>
            <div className="upload-modal-header">
              <h2><Upload size={20} /> Upload Staff Data</h2>
              <button className="btn-close-modal" onClick={() => { setShowUploadModal(false); setUploadPreview([]); setUploadError(''); }}>
                <X size={20} />
              </button>
            </div>
            
            <div className="upload-modal-body">
              {uploadPreview.length === 0 ? (
                <>
                  <div className="upload-instructions">
                    <h3>ðŸ“„ CSV File Format</h3>
                    <p>Upload a CSV file with the following columns:</p>
                    <div className="csv-columns">
                      <span className="csv-col required">name</span>
                      <span className="csv-col required">email</span>
                      <span className="csv-col required">password</span>
                      <span className="csv-col">phone</span>
                      <span className="csv-col">role</span>
                      <span className="csv-col">dateofjoin</span>
                      <span className="csv-col">dateofbirth</span>
                    </div>
                    <p className="hint">Only name, email, password are required. Role defaults to "Articles" if not specified.</p>
                  </div>

                  <div className="upload-area">
                    <input 
                      type="file" 
                      accept=".csv" 
                      id="staffFileUpload"
                      onChange={handleFileUpload}
                      style={{ display: 'none' }}
                    />
                    <label htmlFor="staffFileUpload" className="upload-dropzone">
                      <Upload size={48} />
                      <span>Click to select CSV file</span>
                      <span className="hint">or drag and drop</span>
                    </label>
                  </div>

                  {uploadError && (
                    <div className="upload-error">
                      <AlertCircle size={16} /> {uploadError}
                    </div>
                  )}

                  <div className="upload-sample">
                    <button className="btn-download-sample" onClick={downloadSampleCSV}>
                      <Download size={16} /> Download Sample CSV (15 Employees)
                    </button>
                  </div>
                </>
              ) : (
                <>
                  <div className="upload-preview-header">
                    <CheckCircle size={20} color="#10b981" />
                    <span>Found {uploadPreview.length} staff members to import</span>
                  </div>
                  
                  {uploadError && (
                    <div className="upload-warning">
                      <AlertCircle size={16} /> {uploadError}
                    </div>
                  )}
                  
                  <div className="upload-preview-table">
                    <table>
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Name</th>
                          <th>Email</th>
                          <th>Phone</th>
                          <th>Role</th>
                          <th>Date of Join</th>
                        </tr>
                      </thead>
                      <tbody>
                        {uploadPreview.map((staff, idx) => (
                          <tr key={idx}>
                            <td>{idx + 1}</td>
                            <td>{staff.name}</td>
                            <td>{staff.email}</td>
                            <td>{staff.phone}</td>
                            <td><span className={`role-badge role-${staff.role?.toLowerCase().replace(' ', '-')}`}>{staff.role}</span></td>
                            <td>{staff.dateOfJoin}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}
            </div>

            <div className="upload-modal-footer">
              {uploadPreview.length === 0 ? (
                <button className="btn-cancel" onClick={() => { setShowUploadModal(false); setUploadError(''); }}>Cancel</button>
              ) : (
                <>
                  <button className="btn-cancel" onClick={() => { setUploadPreview([]); setUploadError(''); }}>
                    <X size={16} /> Cancel & Re-upload
                  </button>
                  <button className="btn-confirm-upload" onClick={confirmUpload}>
                    <CheckCircle size={16} /> Import {uploadPreview.length} Staff Members
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Staff Controls Modal */}
      {showStaffControlsModal && controllingStaff && (
        <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
          <div style={{background: '#fff', borderRadius: '12px', width: '95%', maxWidth: '1000px', maxHeight: '90vh', overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
            {/* Header */}
            <div style={{padding: '16px 24px', borderBottom: '1px solid #e2e8f0', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <div>
                <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                  Assign Controls to {controllingStaff.name}
                </h3>
                <p style={{margin: '4px 0 0', fontSize: '12px', opacity: 0.9}}>{controllingStaff.email} â€¢ {controllingStaff.role}</p>
              </div>
              <div style={{display: 'flex', gap: '12px'}}>
                <button onClick={saveStaffPermissions} style={{padding: '10px 24px', background: 'rgba(255,255,255,0.2)', color: '#fff', border: '1px solid rgba(255,255,255,0.3)', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  <Check size={16} /> Save All
                </button>
                <button onClick={() => setShowStaffControlsModal(false)} style={{background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', padding: '8px', cursor: 'pointer', color: '#fff'}}>
                  <X size={20} />
                </button>
              </div>
            </div>
            
            {/* Permission Tabs */}
            <div style={{display: 'flex', borderBottom: '1px solid #e2e8f0', background: '#f8fafc'}}>
              {[
                { id: 'sidebar', label: 'Sidebar Menu Access', icon: 'ðŸ“‹' },
                { id: 'tasks', label: 'Task Categories', icon: 'âœ…' },
                { id: 'permissions', label: 'Action Permissions', icon: 'ðŸ”' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActivePermissionTab(tab.id)}
                  style={{
                    padding: '14px 24px',
                    background: activePermissionTab === tab.id ? '#fff' : 'transparent',
                    border: 'none',
                    borderBottom: activePermissionTab === tab.id ? '3px solid #3b82f6' : '3px solid transparent',
                    cursor: 'pointer',
                    fontWeight: activePermissionTab === tab.id ? '600' : '500',
                    color: activePermissionTab === tab.id ? '#1e293b' : '#64748b',
                    fontSize: '13px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}
                >
                  <span>{tab.icon}</span>
                  {tab.label}
                </button>
              ))}
            </div>
            
            {/* Quick Actions - Tab Specific */}
            <div style={{padding: '12px 24px', background: '#fffbeb', borderBottom: '1px solid #fde68a', display: 'flex', gap: '12px', alignItems: 'center'}}>
              <span style={{fontSize: '12px', color: '#92400e', fontWeight: '500'}}>
                Quick Actions for {activePermissionTab === 'sidebar' ? 'Sidebar' : activePermissionTab === 'tasks' ? 'Tasks' : 'Permissions'}:
              </span>
              <button onClick={() => selectAllForTab(activePermissionTab, true)} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontWeight: '600'}}>Select All</button>
              <button onClick={() => selectAllForTab(activePermissionTab, false)} style={{padding: '6px 12px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontWeight: '600'}}>Deselect All</button>
            </div>
            
            {/* Content Area */}
            <div style={{padding: '20px 24px', overflowY: 'auto', flex: 1}}>
              {/* Sidebar Menu Access Tab */}
              {activePermissionTab === 'sidebar' && (
                <table style={{width: '100%', borderCollapse: 'collapse'}}>
                  <thead>
                    <tr style={{background: '#f1f5f9'}}>
                      <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', fontSize: '12px', borderBottom: '2px solid #e2e8f0', width: '300px'}}>Menu Item</th>
                      <th style={{padding: '12px 16px', textAlign: 'center', fontWeight: '600', fontSize: '12px', borderBottom: '2px solid #e2e8f0'}}>Can Access</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(MENU_STRUCTURE).map(([menuId, menu]) => (
                      <React.Fragment key={menuId}>
                        <tr style={{background: '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                          <td style={{padding: '14px 16px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                              <span style={{fontSize: '18px'}}>{menu.icon}</span>
                              <span style={{fontWeight: '600', fontSize: '14px'}}>{menu.label}</span>
                              {menu.subItems.length > 0 && (
                                <span style={{fontSize: '11px', color: '#64748b', background: '#e2e8f0', padding: '2px 8px', borderRadius: '10px'}}>
                                  {menu.subItems.length} sub-items
                                </span>
                              )}
                            </div>
                          </td>
                          <td style={{padding: '14px 16px', textAlign: 'center'}}>
                            <input 
                              type="checkbox" 
                              checked={staffPermissions[menuId] === true} 
                              onChange={(e) => {
                                e.stopPropagation();
                                toggleParentAndChildren(menuId, menu);
                              }} 
                              style={{width: '20px', height: '20px', cursor: 'pointer', accentColor: '#3b82f6'}} 
                            />
                          </td>
                        </tr>
                        {menuId === 'invoicing' && menu.subItems.map(sub => (
                          <tr key={sub.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                            <td style={{padding: '10px 16px 10px 48px'}}>
                              <span style={{fontSize: '13px', color: '#475569'}}>â†³ {sub.label}</span>
                            </td>
                            <td style={{padding: '10px 16px', textAlign: 'center'}}>
                              <input 
                                type="checkbox" 
                                checked={staffPermissions[sub.id] === true} 
                                onChange={(e) => {
                                  e.stopPropagation();
                                  togglePermission(sub.id);
                                }} 
                                style={{width: '18px', height: '18px', cursor: 'pointer', accentColor: '#3b82f6'}} 
                              />
                            </td>
                          </tr>
                        ))}
                      </React.Fragment>
                    ))}
                  </tbody>
                </table>
              )}
              
              {/* Task Categories Tab */}
              {activePermissionTab === 'tasks' && (
                <div>
                  <p style={{margin: '0 0 16px', fontSize: '13px', color: '#64748b'}}>Control which task categories and types this user can access</p>
                  {Object.keys(PARENT_CHILD_TASKS).map(parent => {
                    const parentId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}`;
                    const allChildrenChecked = PARENT_CHILD_TASKS[parent].every(child => {
                      const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
                      return staffPermissions[childId] === true;
                    });
                    return (
                      <div key={parent} style={{marginBottom: '16px', border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden'}}>
                        <div style={{padding: '12px 16px', background: '#f0fdf4', borderBottom: '1px solid #bbf7d0', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                          <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                            <input
                              type="checkbox"
                              checked={allChildrenChecked}
                              onChange={() => {
                                const newVal = !allChildrenChecked;
                                const updates = { [parentId]: newVal };
                                PARENT_CHILD_TASKS[parent].forEach(child => {
                                  const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
                                  updates[childId] = newVal;
                                });
                                setStaffPermissions(prev => ({ ...prev, ...updates }));
                              }}
                              style={{width: '18px', height: '18px', cursor: 'pointer', accentColor: '#10b981'}}
                            />
                            <span style={{fontWeight: '600', fontSize: '14px', color: '#166534'}}>{parent}</span>
                          </div>
                          <span style={{fontSize: '11px', color: '#64748b', background: '#dcfce7', padding: '2px 10px', borderRadius: '10px'}}>{PARENT_CHILD_TASKS[parent].length} tasks</span>
                        </div>
                        <div style={{padding: '8px 0'}}>
                          {PARENT_CHILD_TASKS[parent].map(child => {
                            const childId = `task_${parent.toLowerCase().replace(/\s+/g, '_')}_${child.toLowerCase().replace(/\s+/g, '_')}`;
                            return (
                              <div key={child} style={{padding: '8px 16px 8px 44px', display: 'flex', alignItems: 'center', gap: '12px', borderBottom: '1px solid #f1f5f9'}}>
                                <input 
                                  type="checkbox" 
                                  checked={staffPermissions[childId] === true} 
                                  onChange={(e) => {
                                    e.stopPropagation();
                                    togglePermission(childId);
                                  }} 
                                  style={{width: '16px', height: '16px', cursor: 'pointer', accentColor: '#3b82f6'}} 
                                />
                                <span style={{fontSize: '13px', color: '#475569'}}>{child}</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Action Permissions Tab */}
              {activePermissionTab === 'permissions' && (
                <div>
                  <p style={{margin: '0 0 16px', fontSize: '13px', color: '#64748b'}}>Control what actions this user can perform across the application</p>
                  <table style={{width: '100%', borderCollapse: 'collapse'}}>
                    <thead>
                      <tr style={{background: '#f1f5f9'}}>
                        <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', fontSize: '12px', borderBottom: '2px solid #e2e8f0'}}>Permission</th>
                        <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', fontSize: '12px', borderBottom: '2px solid #e2e8f0'}}>Description</th>
                        <th style={{padding: '12px 16px', textAlign: 'center', fontWeight: '600', fontSize: '12px', borderBottom: '2px solid #e2e8f0'}}>Allowed</th>
                      </tr>
                    </thead>
                    <tbody>
                      {[
                        { id: 'canViewDashboard', label: 'View Dashboard', desc: 'Can view dashboard statistics and overview' },
                        { id: 'canCreateTask', label: 'Create Tasks', desc: 'Can create new tasks' },
                        { id: 'canEditTask', label: 'Edit Tasks', desc: 'Can edit existing tasks' },
                        { id: 'canDeleteTask', label: 'Delete Tasks', desc: 'Can delete tasks' },
                        { id: 'canAssignTask', label: 'Assign Tasks', desc: 'Can assign tasks to team members' },
                        { id: 'canChangeTaskStatus', label: 'Change Task Status', desc: 'Can update task status' },
                        { id: 'canViewClients', label: 'View Clients', desc: 'Can view client list and details' },
                        { id: 'canCreateClient', label: 'Create Clients', desc: 'Can add new clients' },
                        { id: 'canEditClient', label: 'Edit Clients', desc: 'Can modify client information' },
                        { id: 'canDeleteClient', label: 'Delete Clients', desc: 'Can remove clients' },
                        { id: 'canViewInvoicing', label: 'View Invoicing', desc: 'Can access invoicing module' },
                        { id: 'canCreateInvoice', label: 'Create Invoices', desc: 'Can generate new invoices' },
                        { id: 'canEditInvoice', label: 'Edit Invoices', desc: 'Can modify invoices' },
                        { id: 'canDeleteInvoice', label: 'Delete Invoices', desc: 'Can delete invoices' },
                        { id: 'canPostReceipt', label: 'Post Receipts', desc: 'Can post payment receipts' },
                        { id: 'canViewReports', label: 'View Reports', desc: 'Can access reports section' },
                        { id: 'canExportData', label: 'Export Data', desc: 'Can export data to CSV/Excel' },
                        { id: 'canImportData', label: 'Import Data', desc: 'Can import data from files' },
                        { id: 'canManageStaff', label: 'Manage Staff', desc: 'Can view and manage staff members' },
                        { id: 'canViewTimesheet', label: 'View Timesheets', desc: 'Can view timesheet reports' }
                      ].map(perm => (
                        <tr key={perm.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                          <td style={{padding: '12px 16px', fontWeight: '500', fontSize: '13px'}}>{perm.label}</td>
                          <td style={{padding: '12px 16px', fontSize: '12px', color: '#64748b'}}>{perm.desc}</td>
                          <td style={{padding: '12px 16px', textAlign: 'center'}}>
                            <input 
                              type="checkbox" 
                              checked={staffPermissions[`perm_${perm.id}`] === true} 
                              onChange={(e) => {
                                e.stopPropagation();
                                togglePermission(`perm_${perm.id}`);
                              }} 
                              style={{width: '18px', height: '18px', cursor: 'pointer', accentColor: '#3b82f6'}} 
                            />
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Roles & Permissions Modal */}
      {showRolesPermissionsModal && (
        <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
          <div style={{background: '#fff', borderRadius: '12px', width: '90%', maxWidth: '800px', maxHeight: '80vh', overflow: 'auto'}}>
            <div style={{padding: '20px 24px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#f8fafc'}}>
              <div>
                <h2 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Roles & Default Permissions</h2>
                <p style={{margin: '4px 0 0', fontSize: '13px', color: '#64748b'}}>Define default permissions for each role</p>
              </div>
              <button onClick={() => setShowRolesPermissionsModal(false)} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '8px'}}>
                <X size={20} />
              </button>
            </div>
            <div style={{padding: '24px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '16px'}}>
                {['Admin', 'Manager', 'Reporting Manager', 'Team Lead', 'Seniors', 'Articles', 'Intern'].map(role => (
                  <div key={role} style={{border: '1px solid #e2e8f0', borderRadius: '10px', padding: '20px', background: '#f8fafc'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                      <div style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '10px',
                        background: role === 'Admin' ? '#fef3c7' : role === 'Manager' ? '#dbeafe' : role === 'Reporting Manager' ? '#dcfce7' : role === 'Team Lead' ? '#fce7f3' : '#f1f5f9',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '18px'
                      }}>
                        {role === 'Admin' ? 'ðŸ‘‘' : role === 'Manager' ? 'ðŸ“Š' : role === 'Reporting Manager' ? 'ðŸŽ¯' : role === 'Team Lead' ? 'ðŸ†' : role === 'Seniors' ? 'ðŸ‘¨â€ðŸ’¼' : role === 'Articles' ? 'ðŸ“' : 'ðŸŽ“'}
                      </div>
                      <div>
                        <div style={{fontWeight: '600', fontSize: '14px'}}>{role}</div>
                        <div style={{fontSize: '10px', color: '#64748b'}}>
                          {data.staff?.filter(s => s.role === role).length || 0} users
                        </div>
                      </div>
                    </div>
                    <button
                      onClick={() => alert(`Configure ${role} default permissions - Coming Soon`)}
                      style={{width: '100%', padding: '10px', background: '#fff', border: '1px solid #e2e8f0', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '500', color: '#3b82f6'}}
                    >
                      Configure Defaults
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
  };

  // Staff Form Modal Component
  const StaffFormModal = ({ staff, onClose, onSave }) => {
    const [staffFormData, setStaffFormData] = useState({
      name: staff?.name || '',
      email: staff?.email || '',
      phone: staff?.phone || '',
      dateOfJoin: staff?.dateOfJoin || '',
      dateOfBirth: staff?.dateOfBirth || '',
      role: staff?.role || 'Articles',
      reportingManager: staff?.reportingManager || '',
      password: ''
    });

    // Get list of reporting managers
    const reportingManagers = data.staff.filter(s => s.role === 'Reporting Manager' && s.status === 'Active');

    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="staff-modal" onClick={(e) => e.stopPropagation()}>
          <div className="staff-modal-header">
            <h2>{staff ? 'Edit Staff Member' : 'Add New Staff Member'}</h2>
            <button className="btn-close-modal" onClick={onClose}>
              <X size={20} />
            </button>
          </div>

          <div className="staff-modal-body">
            {/* User Detail Section */}
            <div className="form-section-staff">
              <h3 className="section-label-staff">User Detail</h3>
              
              <div className="form-row-staff">
                <div className="form-field-staff">
                  <label>Staff Name <span className="required-star">*</span></label>
                  <input
                    type="text"
                    value={staffFormData.name}
                    onChange={(e) => setStaffFormData({...staffFormData, name: e.target.value})}
                    placeholder="Enter staff name"
                  />
                </div>

                <div className="form-field-staff">
                  <label>Email Id <span className="required-star">*</span></label>
                  <input
                    type="email"
                    value={staffFormData.email}
                    onChange={(e) => setStaffFormData({...staffFormData, email: e.target.value})}
                    placeholder="email@example.com"
                  />
                </div>
              </div>

              <div className="form-row-staff">
                <div className="form-field-staff">
                  <label>Contact No</label>
                  <input
                    type="tel"
                    value={staffFormData.phone}
                    onChange={(e) => setStaffFormData({...staffFormData, phone: e.target.value})}
                    placeholder="Enter contact number"
                  />
                </div>

                <div className="form-field-staff">
                  <label>Date of Birth</label>
                  <input
                    type="date"
                    value={staffFormData.dateOfBirth}
                    onChange={(e) => setStaffFormData({...staffFormData, dateOfBirth: e.target.value})}
                  />
                </div>
              </div>

              <div className="form-row-staff">
                <div className="form-field-staff">
                  <label>Date of Join</label>
                  <input
                    type="date"
                    value={staffFormData.dateOfJoin}
                    onChange={(e) => setStaffFormData({...staffFormData, dateOfJoin: e.target.value})}
                  />
                </div>

                <div className="form-field-staff">
                  <label>Role <span className="required-star">*</span></label>
                  <select
                    value={staffFormData.role}
                    onChange={(e) => setStaffFormData({...staffFormData, role: e.target.value, reportingManager: ''})}
                  >
                    <option value="Superadmin">Superadmin</option>
                    <option value="Reporting Manager">Reporting Manager</option>
                    <option value="Seniors">Seniors</option>
                    <option value="Articles">Articles</option>
                  </select>
                </div>
              </div>

              {/* Reporting Manager - Only for Seniors and Articles */}
              {(staffFormData.role === 'Seniors' || staffFormData.role === 'Articles') && (
                <div className="form-row-staff">
                  <div className="form-field-staff" style={{ flex: '1' }}>
                    <label>Reporting Manager <span className="required-star">*</span></label>
                    <select
                      value={staffFormData.reportingManager}
                      onChange={(e) => setStaffFormData({...staffFormData, reportingManager: e.target.value})}
                      style={{ 
                        borderColor: !staffFormData.reportingManager ? '#fca5a5' : undefined,
                        background: !staffFormData.reportingManager ? '#fef2f2' : undefined
                      }}
                    >
                      <option value="">-- Select Reporting Manager --</option>
                      {reportingManagers.map(rm => (
                        <option key={rm.id} value={rm.name}>{rm.name}</option>
                      ))}
                    </select>
                    {reportingManagers.length === 0 && (
                      <p style={{ color: '#dc2626', fontSize: '12px', marginTop: '4px' }}>
                        No Reporting Managers available. Please add a Reporting Manager first.
                      </p>
                    )}
                  </div>
                </div>
              )}

              {/* Password field - required for new, optional for edit */}
              <div className="form-row-staff">
                <div className="form-field-staff">
                  <label>
                    Password {!staff && <span className="required-star">*</span>}
                    {staff && <span style={{fontSize: '10px', color: '#64748b', marginLeft: '8px'}}>(leave blank to keep current)</span>}
                  </label>
                  <input
                    type="text"
                    value={staffFormData.password}
                    onChange={(e) => setStaffFormData({...staffFormData, password: e.target.value})}
                    placeholder={staff ? "Enter new password (optional)" : "Enter password"}
                  />
                  {staff && staff.password && (
                    <div style={{fontSize: '10px', color: '#10b981', marginTop: '4px'}}>
                      Current password: {staff.password}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Manage User Section (Only for Edit) */}
            {staff && (
              <div className="form-section-staff">
                <h3 className="section-label-staff">Manage User</h3>
                
                <div className="manage-actions-staff">
                  <div className="manage-item-staff">
                    <label>Reset Password</label>
                    <button 
                      type="button"
                      className="btn-action-staff btn-reset"
                      onClick={() => {
                        console.log('Reset password clicked for:', staff.id);
                        if (window.confirm('Reset password for this staff member?')) {
                          alert('Password reset link sent to staff email!');
                        }
                      }}
                    >
                      Reset
                    </button>
                  </div>

                  <div className="manage-item-staff">
                    <label>Lock Status</label>
                    <button 
                      type="button"
                      className="btn-action-staff btn-toggle"
                      onClick={() => {
                        console.log('Toggle status clicked for:', staff.id);
                        handleToggleStaffStatus(staff.id);
                        alert('Status updated! Please close and reopen to see changes.');
                      }}
                    >
                      {staff.status === 'Active' ? 'Disable' : 'Enable'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Form Actions */}
          <div className="staff-modal-footer">
            <button 
              type="button" 
              className="btn-secondary" 
              onClick={onClose}
            >
              Cancel
            </button>
            <button 
              type="button" 
              className="btn-primary"
              onClick={() => {
                console.log('=== CREATE/UPDATE STAFF CLICKED ===');
                console.log('Staff data:', staffFormData);

                // Validation
                if (!staffFormData.name || !staffFormData.email) {
                  alert('Staff Name and Email are required!');
                  return;
                }

                if (!staff && !staffFormData.password) {
                  alert('Password is required for new staff!');
                  return;
                }

                // Reporting Manager is required for Seniors and Articles
                if ((staffFormData.role === 'Seniors' || staffFormData.role === 'Articles') && !staffFormData.reportingManager) {
                  alert('Please select a Reporting Manager for ' + staffFormData.role + '!');
                  return;
                }

                console.log('Validation passed, saving...');
                onSave(staffFormData);
              }}
            >
              {staff ? 'Update Staff' : 'Create Staff'}
            </button>
          </div>
        </div>
      </div>
    );
  };



  // Timesheet Modal Component - Integrated Fill & View with Edit Support
  const TimesheetModal = ({ onClose }) => {
    const [activeTab, setActiveTab] = useState('fill');
    const [timesheetDate, setTimesheetDate] = useState(selectedTimesheetDate);
    // User can only fill/view their own timesheet
    const selectedEmployee = currentUser?.name || '';
    const [attendanceStatus, setAttendanceStatus] = useState('Present');
    const [isEditMode, setIsEditMode] = useState(false);
    const [editingTimesheetId, setEditingTimesheetId] = useState(null);
    const MINIMUM_HOURS = 8;
    
    // View tab states
    const [viewMonth, setViewMonth] = useState(new Date().toISOString().slice(0, 7));
    // User can only view their own timesheets
    const viewEmployee = currentUser?.name || '';
    const [viewingTimesheet, setViewingTimesheet] = useState(null);
    
    // Initialize timesheet entries
    const [entries, setEntries] = useState([
      { id: 1, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
      { id: 2, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
      { id: 3, startTime: '', endTime: '', client: '', task: '', type: 'Non-Billable', description: '', saved: false }
    ]);

    // Check if timesheet exists for selected date/employee
    const existingTimesheet = data.timesheets.find(
      t => t.date === timesheetDate && t.employee === selectedEmployee
    );

    // Load existing timesheet when date/employee changes
    React.useEffect(() => {
      if (existingTimesheet) {
        setIsEditMode(true);
        setEditingTimesheetId(existingTimesheet.id);
        setAttendanceStatus(existingTimesheet.attendanceStatus || 'Present');
        if (existingTimesheet.entries && existingTimesheet.entries.length > 0) {
          setEntries(existingTimesheet.entries.map((e, idx) => ({
            ...e,
            id: e.id || idx + 1,
            saved: true
          })));
        }
      } else {
        setIsEditMode(false);
        setEditingTimesheetId(null);
        setAttendanceStatus('Present');
        setEntries([
          { id: 1, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
          { id: 2, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
          { id: 3, startTime: '', endTime: '', client: '', task: '', type: 'Non-Billable', description: '', saved: false }
        ]);
      }
    }, [timesheetDate, selectedEmployee, data.timesheets]);

    // Calculate total time for an entry
    const calculateTotalTime = (startTime, endTime) => {
      if (!startTime || !endTime) return 0;
      const start = new Date(`2000-01-01 ${startTime}`);
      const end = new Date(`2000-01-01 ${endTime}`);
      const diff = (end - start) / (1000 * 60 * 60);
      return diff > 0 ? diff : 0;
    };

    // Calculate totals
    const filledEntries = entries.filter(e => e.startTime && e.endTime);
    const totalHoursPosted = filledEntries.reduce((sum, e) => sum + calculateTotalTime(e.startTime, e.endTime), 0);
    const billableHours = filledEntries.filter(e => e.type === 'Billable').reduce((sum, e) => sum + calculateTotalTime(e.startTime, e.endTime), 0);
    const nonBillableHours = filledEntries.filter(e => e.type === 'Non-Billable').reduce((sum, e) => sum + calculateTotalTime(e.startTime, e.endTime), 0);
    const hoursRemaining = MINIMUM_HOURS - totalHoursPosted;

    const getTimesheetStatus = () => {
      if (totalHoursPosted === 0) return 'Not Started';
      if (totalHoursPosted < MINIMUM_HOURS) return 'In Progress';
      return 'Submitted';
    };

    const addEntry = (type) => {
      setEntries([...entries, {
        id: Date.now(),
        startTime: '',
        endTime: '',
        client: '',
        task: '',
        type: type,
        description: '',
        saved: false
      }]);
    };

    const removeEntry = (id) => {
      if (entries.length > 1) {
        setEntries(entries.filter(e => e.id !== id));
      }
    };

    // Get user's assigned tasks
    const userTasks = data.tasks.filter(t => 
      t.assignedTo === selectedEmployee || 
      t.primaryAssignedUser === selectedEmployee ||
      t.taskLeader === selectedEmployee ||
      t.taskManager === selectedEmployee
    );

    const userClients = [...new Set(userTasks.map(t => t.clientName))]
      .map(clientName => data.clients.find(c => c.name === clientName))
      .filter(Boolean);

    const getTasksForClient = (clientName) => {
      return userTasks.filter(t => t.clientName === clientName);
    };

    // Save individual entry (mark as saved)
    const saveIndividualEntry = (entryId) => {
      const entry = entries.find(e => e.id === entryId);
      if (!entry.startTime || !entry.endTime) {
        alert('Please fill Start and End time!');
        return;
      }
      
      // Check for time overlap
      const overlapResult = checkEntryOverlap(entryId, entry.startTime, entry.endTime);
      if (overlapResult) {
        alert(`âŒ Cannot save!\n\n${overlapResult.message}\n\nPlease adjust the time to avoid overlap.`);
        return;
      }
      
      if (entry.type === 'Billable' && (!entry.client || !entry.task)) {
        alert('Billable entries must have Client and Task!');
        return;
      }
      
      // Clear any overlap error for this entry
      setOverlapErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[entryId];
        return newErrors;
      });
      
      setEntries(prev => prev.map(e => e.id === entryId ? { ...e, saved: true } : e));
      alert('âœ“ Entry saved! Click "Save Timesheet" to finalize all entries.');
    };

    // Check time overlap for a specific entry against all other entries
    const checkEntryOverlap = (entryId, newStartTime, newEndTime) => {
      if (!newStartTime || !newEndTime) return null;
      
      const newStart = new Date(`2000-01-01 ${newStartTime}`);
      const newEnd = new Date(`2000-01-01 ${newEndTime}`);
      
      if (newStart >= newEnd) return null; // Invalid time range
      
      for (const entry of entries) {
        if (entry.id === entryId) continue; // Skip self
        if (!entry.startTime || !entry.endTime) continue; // Skip incomplete entries
        
        const existingStart = new Date(`2000-01-01 ${entry.startTime}`);
        const existingEnd = new Date(`2000-01-01 ${entry.endTime}`);
        
        // Check for overlap
        if (newStart < existingEnd && existingStart < newEnd) {
          return {
            overlap: true,
            conflictWith: `${entry.startTime} - ${entry.endTime}`,
            message: `Time overlaps with existing entry (${entry.startTime} - ${entry.endTime})`
          };
        }
      }
      return null;
    };

    // State for tracking overlap errors per entry
    const [overlapErrors, setOverlapErrors] = useState({});
    
    // Description dialog state (for fill tab - editable)
    const [descriptionDialog, setDescriptionDialog] = useState({ open: false, entryId: null, value: '' });
    
    // View description dialog state (for view tab - read only)
    const [viewDescriptionDialog, setViewDescriptionDialog] = useState({ open: false, value: '', startTime: '', endTime: '' });
    
    const openDescriptionDialog = (entryId, currentValue) => {
      setDescriptionDialog({ open: true, entryId, value: currentValue || '' });
    };
    
    const openViewDescriptionDialog = (description, startTime, endTime) => {
      setViewDescriptionDialog({ open: true, value: description || '', startTime, endTime });
    };
    
    const saveDescription = () => {
      setEntries(prev => prev.map(ent => 
        ent.id === descriptionDialog.entryId 
          ? { ...ent, description: descriptionDialog.value, saved: false } 
          : ent
      ));
      setDescriptionDialog({ open: false, entryId: null, value: '' });
    };

    // Handle time change with overlap validation
    const handleTimeChange = (entryId, field, value) => {
      const entry = entries.find(e => e.id === entryId);
      const newStartTime = field === 'startTime' ? value : entry.startTime;
      const newEndTime = field === 'endTime' ? value : entry.endTime;
      
      // Check for overlap
      const overlapResult = checkEntryOverlap(entryId, newStartTime, newEndTime);
      
      if (overlapResult) {
        // Show error but still allow the change (user might be adjusting)
        setOverlapErrors(prev => ({ ...prev, [entryId]: overlapResult.message }));
      } else {
        // Clear error for this entry
        setOverlapErrors(prev => {
          const newErrors = { ...prev };
          delete newErrors[entryId];
          return newErrors;
        });
      }
      
      // Update the entry
      setEntries(prev => prev.map(ent => 
        ent.id === entryId ? { ...ent, [field]: value, saved: false } : ent
      ));
    };

    // Check time overlap for final validation
    const checkTimeOverlap = () => {
      for (let i = 0; i < filledEntries.length; i++) {
        for (let j = i + 1; j < filledEntries.length; j++) {
          const a = filledEntries[i], b = filledEntries[j];
          const aStart = new Date(`2000-01-01 ${a.startTime}`);
          const aEnd = new Date(`2000-01-01 ${a.endTime}`);
          const bStart = new Date(`2000-01-01 ${b.startTime}`);
          const bEnd = new Date(`2000-01-01 ${b.endTime}`);
          if (aStart < bEnd && bStart < aEnd) return { overlap: true, e1: i + 1, e2: j + 1 };
        }
      }
      return { overlap: false };
    };

    // Save/Update timesheet
    const handleSaveTimesheet = () => {
      if (attendanceStatus === 'Full Day Leave') {
        const timesheetData = {
          id: editingTimesheetId || generateId(),
          employee: selectedEmployee,
          date: timesheetDate,
          attendanceStatus: 'Full Day Leave',
          entries: [],
          totalHours: 0,
          billableHours: 0,
          nonBillableHours: 0,
          minimumHours: 0,
          status: 'Leave',
          submittedAt: new Date().toISOString()
        };

        setData(prev => ({
          ...prev,
          timesheets: isEditMode 
            ? prev.timesheets.map(t => t.id === editingTimesheetId ? timesheetData : t)
            : [...prev.timesheets, timesheetData]
        }));

        alert('Leave recorded successfully!');
        setViewMonth(timesheetDate.slice(0, 7));
        setActiveTab('view');
        return;
      }

      if (filledEntries.length === 0) {
        alert('Please add at least one entry with Start and End time!');
        return;
      }

      // Check if there are any overlap errors
      if (Object.keys(overlapErrors).length > 0) {
        alert('âŒ Cannot save timesheet!\n\nThere are time overlaps in your entries.\nPlease fix the highlighted entries before saving.');
        return;
      }

      const overlapCheck = checkTimeOverlap();
      if (overlapCheck.overlap) {
        alert(`âŒ Time overlap detected!\n\nEntry ${overlapCheck.e1} and Entry ${overlapCheck.e2} have overlapping times.\n\nPlease adjust the times to avoid overlap.`);
        return;
      }

      const invalidBillable = filledEntries.filter(e => e.type === 'Billable' && (!e.client || !e.task));
      if (invalidBillable.length > 0) {
        alert('All Billable entries must have Client and Task!');
        return;
      }

      const timesheetData = {
        id: editingTimesheetId || generateId(),
        employee: selectedEmployee,
        date: timesheetDate,
        attendanceStatus: 'Present',
        entries: filledEntries.map(e => ({ ...e, saved: true })),
        totalHours: totalHoursPosted,
        billableHours,
        nonBillableHours,
        minimumHours: MINIMUM_HOURS,
        hoursRemaining: hoursRemaining > 0 ? hoursRemaining : 0,
        status: getTimesheetStatus(),
        submittedAt: new Date().toISOString()
      };

      setData(prev => ({
        ...prev,
        timesheets: isEditMode 
          ? prev.timesheets.map(t => t.id === editingTimesheetId ? timesheetData : t)
          : [...prev.timesheets, timesheetData]
      }));

      // Mark all entries as saved
      setEntries(prev => prev.map(e => ({ ...e, saved: true })));
      setIsEditMode(true);
      setEditingTimesheetId(timesheetData.id);

      alert(`Timesheet ${isEditMode ? 'updated' : 'saved'}!\n\nTotal: ${totalHoursPosted.toFixed(2)} Hrs\nBillable: ${billableHours.toFixed(2)} Hrs\nNon-Billable: ${nonBillableHours.toFixed(2)} Hrs`);
    };

    // Delete timesheet
    const handleDeleteTimesheet = () => {
      if (window.confirm('Delete this entire timesheet?')) {
        setData(prev => ({
          ...prev,
          timesheets: prev.timesheets.filter(t => t.id !== editingTimesheetId)
        }));
        setIsEditMode(false);
        setEditingTimesheetId(null);
        setEntries([
          { id: 1, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
          { id: 2, startTime: '', endTime: '', client: '', task: '', type: 'Billable', description: '', saved: false },
          { id: 3, startTime: '', endTime: '', client: '', task: '', type: 'Non-Billable', description: '', saved: false }
        ]);
        alert('Timesheet deleted!');
      }
    };

    // VIEW TAB FUNCTIONS
    const getDaysInMonth = (yearMonth) => {
      const [year, month] = yearMonth.split('-').map(Number);
      const daysCount = new Date(year, month, 0).getDate();
      return Array.from({ length: daysCount }, (_, i) => {
        const day = i + 1;
        const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayOfWeek = new Date(year, month - 1, day).toLocaleDateString('en-US', { weekday: 'short' });
        return { date, dayOfWeek, day };
      });
    };

    const daysInMonth = getDaysInMonth(viewMonth);

    const getTimesheetForDate = (date) => {
      return data.timesheets.find(t => t.date === date && t.employee === viewEmployee);
    };

    // Edit from view - load into fill tab
    const handleEditFromView = (ts) => {
      setTimesheetDate(ts.date);
      setActiveTab('fill');
    };

    const handleDeleteFromView = (tsId) => {
      if (window.confirm('Delete this timesheet?')) {
        setData(prev => ({
          ...prev,
          timesheets: prev.timesheets.filter(t => t.id !== tsId)
        }));
        setViewingTimesheet(null);
        alert('Deleted!');
      }
    };

    const handleDeleteEntryFromView = (tsId, entryIdx) => {
      if (window.confirm('Delete this entry?')) {
        setData(prev => ({
          ...prev,
          timesheets: prev.timesheets.map(t => {
            if (t.id === tsId) {
              const newEntries = t.entries.filter((_, idx) => idx !== entryIdx);
              const billable = newEntries.filter(e => e.type === 'Billable').reduce((s, e) => s + calculateTotalTime(e.startTime, e.endTime), 0);
              const nonBillable = newEntries.filter(e => e.type === 'Non-Billable').reduce((s, e) => s + calculateTotalTime(e.startTime, e.endTime), 0);
              return { ...t, entries: newEntries, totalHours: billable + nonBillable, billableHours: billable, nonBillableHours: nonBillable };
            }
            return t;
          })
        }));
        // Refresh viewing
        const updated = data.timesheets.find(t => t.id === tsId);
        if (updated) setViewingTimesheet({ ...updated });
      }
    };

    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="timesheet-modal-integrated" onClick={(e) => e.stopPropagation()}>
          {/* Header Tabs */}
          <div className="timesheet-modal-header-tabs">
            <div className="timesheet-tabs">
              <button className={`timesheet-tab ${activeTab === 'fill' ? 'active' : ''}`} onClick={() => setActiveTab('fill')}>
                <Plus size={16} /> {isEditMode ? 'Edit Timesheet' : 'Fill Timesheet'}
              </button>
              <button className={`timesheet-tab ${activeTab === 'view' ? 'active' : ''}`} onClick={() => setActiveTab('view')}>
                <Eye size={16} /> View Timesheet
              </button>
            </div>
            <button className="btn-close-modal" onClick={onClose}><X size={20} /></button>
          </div>

          {/* FILL/EDIT TAB */}
          {activeTab === 'fill' && (
            <div className="timesheet-fill-content">
              {/* Edit Mode Banner */}
              {isEditMode && (
                <div className="edit-mode-banner">
                  <Edit size={16} />
                  <span>Editing timesheet for {timesheetDate}</span>
                  <button onClick={handleDeleteTimesheet} className="btn-delete-small">Delete Timesheet</button>
                </div>
              )}

              {/* Info Bar */}
              <div className="timesheet-info-bar">
                <div className="info-bar-item">
                  <label>Status</label>
                  <select value={attendanceStatus} onChange={(e) => setAttendanceStatus(e.target.value)}
                    className={`status-select ${attendanceStatus === 'Present' ? 'present' : 'leave'}`}>
                    <option value="Present">Present</option>
                    <option value="Full Day Leave">Full Day Leave</option>
                  </select>
                </div>
                <div className="info-bar-item">
                  <label>Employee</label>
                  <span className="info-value" style={{ fontWeight: 600, color: '#10b981' }}>{selectedEmployee}</span>
                </div>
                <div className="info-bar-item">
                  <label>Date</label>
                  <input type="date" value={timesheetDate} onChange={(e) => setTimesheetDate(e.target.value)} />
                </div>
                <div className="info-bar-item">
                  <label>Min. Hours</label>
                  <span className="info-value">{MINIMUM_HOURS} Hrs</span>
                </div>
                <div className="info-bar-item">
                  <label>Posted</label>
                  <span className="info-value posted">{totalHoursPosted.toFixed(2)} Hrs</span>
                </div>
                <div className="info-bar-item">
                  <label>Billable</label>
                  <span className="info-value billable-val">{billableHours.toFixed(2)} Hrs</span>
                </div>
                <div className="info-bar-item">
                  <label>Non-Billable</label>
                  <span className="info-value nonbillable-val">{nonBillableHours.toFixed(2)} Hrs</span>
                </div>
                <div className="info-bar-item">
                  <label>Remaining</label>
                  <span className={`info-value ${hoursRemaining > 0 ? 'remaining' : 'complete'}`}>
                    {hoursRemaining > 0 ? `${hoursRemaining.toFixed(2)} Hrs` : 'âœ“ Done'}
                  </span>
                </div>
              </div>

              {attendanceStatus === 'Present' ? (
                <>
                  <div className="timesheet-entries-section">
                    <table className="timesheet-entries-table">
                      <thead>
                        <tr>
                          <th>Start</th>
                          <th>End</th>
                          <th>Total</th>
                          <th>Type</th>
                          <th>Client</th>
                          <th>Task</th>
                          <th>Description</th>
                          <th>Status</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {entries.map((entry) => {
                          const totalTime = calculateTotalTime(entry.startTime, entry.endTime);
                          const hasOverlapError = overlapErrors[entry.id];
                          return (
                            <React.Fragment key={entry.id}>
                            <tr className={`${entry.saved ? 'row-saved' : ''} ${hasOverlapError ? 'row-error' : ''}`}>
                              <td>
                                <input type="time" value={entry.startTime}
                                  className={hasOverlapError ? 'input-error' : ''}
                                  onChange={(e) => handleTimeChange(entry.id, 'startTime', e.target.value)} />
                              </td>
                              <td>
                                <input type="time" value={entry.endTime}
                                  className={hasOverlapError ? 'input-error' : ''}
                                  onChange={(e) => handleTimeChange(entry.id, 'endTime', e.target.value)} />
                              </td>
                              <td className={`total-cell ${hasOverlapError ? 'error-text' : ''}`}>
                                {totalTime > 0 ? totalTime.toFixed(2) : '-'}
                                {hasOverlapError && <div className="error-badge">OVERLAP</div>}
                              </td>
                              <td>
                                <select value={entry.type} className={entry.type === 'Billable' ? 'type-billable' : 'type-nonbillable'}
                                  onChange={(e) => setEntries(prev => prev.map(ent => ent.id === entry.id ? { ...ent, type: e.target.value, client: '', task: '', saved: false } : ent))}>
                                  <option value="Billable">Billable</option>
                                  <option value="Non-Billable">Non-Billable</option>
                                </select>
                              </td>
                              <td>
                                {entry.type === 'Billable' ? (
                                  <select value={entry.client || ''}
                                    onChange={(e) => setEntries(prev => prev.map(ent => ent.id === entry.id ? { ...ent, client: e.target.value, task: '', saved: false } : ent))}>
                                    <option value="">Select Client</option>
                                    {userClients.map(c => (<option key={c.id} value={c.name}>{c.name}</option>))}
                                  </select>
                                ) : <span className="na-cell">-</span>}
                              </td>
                              <td>
                                {entry.type === 'Billable' ? (
                                  <select value={entry.task || ''} disabled={!entry.client}
                                    onChange={(e) => setEntries(prev => prev.map(ent => ent.id === entry.id ? { ...ent, task: e.target.value, saved: false } : ent))}>
                                    <option value="">{entry.client ? 'Select Task' : 'Client First'}</option>
                                    {entry.client && getTasksForClient(entry.client).map(t => (<option key={t.id} value={t.childTask}>{t.childTask}</option>))}
                                  </select>
                                ) : (
                                  <input type="text" placeholder="Activity" value={entry.task || ''}
                                    onChange={(e) => setEntries(prev => prev.map(ent => ent.id === entry.id ? { ...ent, task: e.target.value, saved: false } : ent))} />
                                )}
                              </td>
                              <td>
                                <button 
                                  className={`btn-description ${entry.description ? 'has-content' : ''}`}
                                  onClick={() => openDescriptionDialog(entry.id, entry.description)}
                                  title={entry.description || 'Add description'}
                                >
                                  {entry.description ? (
                                    <><MessageSquare size={12} /> {entry.description.length > 15 ? entry.description.substring(0, 15) + '...' : entry.description}</>
                                  ) : (
                                    <><Plus size={12} /> Add</>
                                  )}
                                </button>
                              </td>
                              <td>
                                {entry.saved ? (
                                  <span className="status-saved">âœ“ Saved</span>
                                ) : entry.startTime && entry.endTime ? (
                                  <button className="btn-save-entry" onClick={() => saveIndividualEntry(entry.id)}>Save</button>
                                ) : (
                                  <span className="status-pending">-</span>
                                )}
                              </td>
                              <td>
                                <button className="btn-remove" onClick={() => removeEntry(entry.id)}><Trash2 size={14} /></button>
                              </td>
                            </tr>
                            {hasOverlapError && (
                              <tr className="error-message-row">
                                <td colSpan="9">
                                  <div className="overlap-error-message">
                                    <AlertCircle size={14} />
                                    <span>{hasOverlapError}</span>
                                  </div>
                                </td>
                              </tr>
                            )}
                            </React.Fragment>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>

                  <div className="timesheet-actions-row">
                    <div className="add-entry-buttons">
                      <button className="btn-add-billable" onClick={() => addEntry('Billable')}>+ Billable</button>
                      <button className="btn-add-nonbillable" onClick={() => addEntry('Non-Billable')}>+ Non-Billable</button>
                    </div>
                    <button className="btn-save-timesheet" onClick={handleSaveTimesheet} disabled={filledEntries.length === 0}>
                      {isEditMode ? 'Update Timesheet' : 'Save Timesheet'}
                    </button>
                  </div>
                </>
              ) : (
                <div className="leave-notice">
                  <div className="leave-icon">ðŸ–ï¸</div>
                  <h3>Full Day Leave</h3>
                  <p>No entries required.</p>
                  <button className="btn-save-leave" onClick={handleSaveTimesheet}>
                    {isEditMode ? 'Update Leave' : 'Record Leave'} for {timesheetDate}
                  </button>
                </div>
              )}
            </div>
          )}

          {/* VIEW TAB - List */}
          {activeTab === 'view' && !viewingTimesheet && (
            <div className="timesheet-view-content">
              <div className="view-filters">
                <div className="filter-item">
                  <label>Employee</label>
                  <span style={{ 
                    padding: '8px 12px', 
                    background: '#f0fdf4', 
                    border: '1px solid #86efac',
                    borderRadius: '6px',
                    fontWeight: 600, 
                    color: '#10b981' 
                  }}>{viewEmployee}</span>
                </div>
                <div className="filter-item">
                  <label>Month</label>
                  <input type="month" value={viewMonth} onChange={(e) => setViewMonth(e.target.value)} />
                </div>
              </div>

              <div className="timesheet-table-container">
                <table className="view-timesheet-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Day</th>
                      <th>Status</th>
                      <th>Billable</th>
                      <th>Non-Billable</th>
                      <th>Total</th>
                      <th>Min Req.</th>
                      <th>Short/Excess</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {daysInMonth.map(({ date, dayOfWeek }) => {
                      const ts = getTimesheetForDate(date);
                      const isMissing = !ts;
                      const status = ts?.attendanceStatus || 'Missing';
                      const minRequired = 8;
                      const totalPosted = ts?.totalHours || 0;
                      const difference = totalPosted - minRequired;
                      const isLeave = ts?.status === 'Leave';
                      
                      return (
                        <tr key={date} className={isMissing ? 'row-missing' : ''}>
                          <td className="col-date">{date.split('-').reverse().join('-')}</td>
                          <td>{dayOfWeek}</td>
                          <td><span className={`status-tag status-${status.toLowerCase().replace(' ', '-')}`}>{status}</span></td>
                          <td className="col-hours">{ts?.billableHours?.toFixed(2) || '-'}</td>
                          <td className="col-hours">{ts?.nonBillableHours?.toFixed(2) || '-'}</td>
                          <td className="col-hours"><strong>{ts?.totalHours?.toFixed(2) || '-'}</strong></td>
                          <td className="col-hours">{ts ? (isLeave ? '-' : '8') : '8'}</td>
                          <td className="col-hours">
                            {isMissing ? (
                              <span className="hours-short">-8.00 Hrs</span>
                            ) : isLeave ? (
                              <span className="hours-neutral">-</span>
                            ) : difference < 0 ? (
                              <span className="hours-short">{difference.toFixed(2)} Hrs</span>
                            ) : difference > 0 ? (
                              <span className="hours-excess">+{difference.toFixed(2)} Hrs</span>
                            ) : (
                              <span className="hours-exact">âœ“ 0.00</span>
                            )}
                          </td>
                          <td>
                            {ts ? (
                              <div className="action-buttons">
                                <button className="btn-view-details" onClick={() => setViewingTimesheet(ts)}>View</button>
                                <button className="btn-edit-small" onClick={() => handleEditFromView(ts)}>Edit</button>
                              </div>
                            ) : (
                              <button className="btn-fill-small" onClick={() => { setTimesheetDate(date); setActiveTab('fill'); }}>Fill</button>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* VIEW TAB - Detail */}
          {activeTab === 'view' && viewingTimesheet && (
            <div className="timesheet-detail-content">
              <div className="detail-header">
                <button className="btn-back" onClick={() => setViewingTimesheet(null)}>â† Back</button>
                <h3>Timesheet: {viewingTimesheet.date}</h3>
                <button className="btn-edit-detail" onClick={() => handleEditFromView(viewingTimesheet)}>
                  <Edit size={14} /> Edit
                </button>
              </div>

              <div className="detail-summary">
                <div className="summary-box"><label>Employee</label><span>{viewingTimesheet.employee}</span></div>
                <div className="summary-box"><label>Status</label><span className={`status-tag status-${viewingTimesheet.attendanceStatus?.toLowerCase().replace(' ', '-')}`}>{viewingTimesheet.attendanceStatus}</span></div>
                <div className="summary-box"><label>Total</label><span>{viewingTimesheet.totalHours?.toFixed(2) || 0} Hrs</span></div>
                <div className="summary-box"><label>Billable</label><span className="billable">{viewingTimesheet.billableHours?.toFixed(2) || 0} Hrs</span></div>
                <div className="summary-box"><label>Non-Billable</label><span className="nonbillable">{viewingTimesheet.nonBillableHours?.toFixed(2) || 0} Hrs</span></div>
              </div>

              {viewingTimesheet.entries?.length > 0 ? (
                <div className="detail-entries">
                  <h4>Time Entries</h4>
                  <table className="entries-detail-table">
                    <thead>
                      <tr><th>Start</th><th>End</th><th>Hours</th><th>Type</th><th>Client</th><th>Task</th><th>Description</th><th></th></tr>
                    </thead>
                    <tbody>
                      {viewingTimesheet.entries.map((entry, idx) => (
                        <tr key={idx}>
                          <td>{entry.startTime}</td>
                          <td>{entry.endTime}</td>
                          <td>{calculateTotalTime(entry.startTime, entry.endTime).toFixed(2)}</td>
                          <td><span className={`type-tag ${entry.type === 'Billable' ? 'billable' : 'nonbillable'}`}>{entry.type}</span></td>
                          <td>{entry.client || '-'}</td>
                          <td>{entry.task || '-'}</td>
                          <td>
                            {entry.description ? (
                              <button 
                                className="btn-view-description"
                                onClick={() => openViewDescriptionDialog(entry.description, entry.startTime, entry.endTime)}
                                title="Click to view full description"
                              >
                                <Eye size={12} /> {entry.description.length > 20 ? entry.description.substring(0, 20) + '...' : entry.description}
                              </button>
                            ) : (
                              <span className="no-description">-</span>
                            )}
                          </td>
                          <td><button className="btn-delete-entry" onClick={() => handleDeleteEntryFromView(viewingTimesheet.id, idx)}><Trash2 size={12} /></button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="no-entries">{viewingTimesheet.attendanceStatus === 'Full Day Leave' ? 'ðŸ–ï¸ Full Day Leave' : 'No entries'}</div>
              )}

              <div className="detail-actions">
                <button className="btn-delete-timesheet" onClick={() => handleDeleteFromView(viewingTimesheet.id)}>Delete Timesheet</button>
              </div>
            </div>
          )}

          {/* Description Dialog - Edit Mode (Fill Tab) */}
          {descriptionDialog.open && (
            <div className="description-dialog-overlay" onClick={() => setDescriptionDialog({ open: false, entryId: null, value: '' })}>
              <div className="description-dialog" onClick={(e) => e.stopPropagation()}>
                <div className="description-dialog-header">
                  <h3><MessageSquare size={18} /> Work Description</h3>
                  <button onClick={() => setDescriptionDialog({ open: false, entryId: null, value: '' })}><X size={18} /></button>
                </div>
                <div className="description-dialog-body">
                  <textarea
                    placeholder="Enter detailed description of work done..."
                    value={descriptionDialog.value}
                    onChange={(e) => setDescriptionDialog(prev => ({ ...prev, value: e.target.value }))}
                    autoFocus
                  />
                  <div className="char-count">{descriptionDialog.value.length} characters</div>
                </div>
                <div className="description-dialog-footer">
                  <button className="btn-cancel" onClick={() => setDescriptionDialog({ open: false, entryId: null, value: '' })}>Cancel</button>
                  <button className="btn-save-desc" onClick={saveDescription}>Save Description</button>
                </div>
              </div>
            </div>
          )}

          {/* Description Dialog - View Mode (Read Only) */}
          {viewDescriptionDialog.open && (
            <div className="description-dialog-overlay" onClick={() => setViewDescriptionDialog({ open: false, value: '', startTime: '', endTime: '' })}>
              <div className="description-dialog view-mode" onClick={(e) => e.stopPropagation()}>
                <div className="description-dialog-header">
                  <h3><MessageSquare size={18} /> Work Description</h3>
                  <button onClick={() => setViewDescriptionDialog({ open: false, value: '', startTime: '', endTime: '' })}><X size={18} /></button>
                </div>
                <div className="description-dialog-body">
                  <div className="view-desc-meta">
                    <span className="meta-label">Time Entry:</span>
                    <span className="meta-value">{viewDescriptionDialog.startTime} - {viewDescriptionDialog.endTime}</span>
                  </div>
                  <div className="view-desc-content">
                    {viewDescriptionDialog.value || 'No description provided'}
                  </div>
                  <div className="char-count">{viewDescriptionDialog.value.length} characters</div>
                </div>
                <div className="description-dialog-footer">
                  <button className="btn-close-dialog" onClick={() => setViewDescriptionDialog({ open: false, value: '', startTime: '', endTime: '' })}>Close</button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  // Timesheet Reports View - By Client, Task, User
  const TimesheetReportsView = () => {
    const [reportType, setReportType] = useState('byClient'); // byClient, byTask, byUser
    const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
    const [expandedItem, setExpandedItem] = useState(null);
    const [dayWiseView, setDayWiseView] = useState(null); // { type, name, entries }
    const [taskTypeFilter, setTaskTypeFilter] = useState('all'); // all, billable, nonBillable

    // Get current user's staff record for role checking
    const currentStaffRecord = data.staff.find(s => s.name === currentUser?.name);
    const userRole = currentStaffRecord?.role || currentUser?.role || '';
    const isSuperadmin = userRole === 'Superadmin';
    const isReportingManager = userRole === 'Reporting Manager';

    // Get allowed clients based on user role
    // - Superadmin: All clients
    // - Reporting Manager: Clients where they are Task Manager or Task Leader
    // - Others: Clients where they are Task Leader, Task Manager, or Primary Assigned User
    const getAllowedClients = () => {
      if (isSuperadmin) {
        return data.clients.map(c => c.name);
      }
      
      const allowedClientNames = new Set();
      data.tasks.forEach(task => {
        if (task.taskLeader === currentUser?.name || 
            task.taskManager === currentUser?.name ||
            task.primaryAssignedUser === currentUser?.name) {
          allowedClientNames.add(task.clientName);
        }
      });
      return Array.from(allowedClientNames);
    };

    // Get allowed users based on role
    // - Superadmin: All users
    // - Reporting Manager: Users mapped under them (reportingManager field)
    // - Others: Only themselves
    const getAllowedUsers = () => {
      if (isSuperadmin) {
        return data.staff.map(s => s.name);
      }
      
      if (isReportingManager) {
        // Get staff mapped under this reporting manager
        const mappedStaff = data.staff
          .filter(s => s.reportingManager === currentUser?.name)
          .map(s => s.name);
        // Include self
        return [currentUser?.name, ...mappedStaff];
      }
      
      // For Seniors/Articles - only themselves
      return [currentUser?.name];
    };

    const allowedClients = getAllowedClients();
    const allowedUsers = getAllowedUsers();

    // Filter timesheets by selected month AND user permissions
    const monthTimesheets = data.timesheets.filter(ts => {
      // Must be in selected month
      if (!ts.date.startsWith(selectedMonth)) return false;
      
      // Superadmin sees all
      if (isSuperadmin) return true;
      
      // Check if user is allowed to see this timesheet
      return allowedUsers.includes(ts.employee);
    });

    // Calculate totals helper
    const calculateTotalTime = (startTime, endTime) => {
      if (!startTime || !endTime) return 0;
      const start = new Date(`2000-01-01 ${startTime}`);
      const end = new Date(`2000-01-01 ${endTime}`);
      const diff = (end - start) / (1000 * 60 * 60);
      return diff > 0 ? diff : 0;
    };

    // Group by Client - filtered by allowed clients
    const getByClientData = () => {
      const clientMap = {};
      monthTimesheets.forEach(ts => {
        if (ts.entries && ts.entries.length > 0) {
          ts.entries.forEach(entry => {
            // Only include allowed clients (or all if superadmin)
            if (entry.client && (isSuperadmin || allowedClients.includes(entry.client))) {
              if (!clientMap[entry.client]) {
                clientMap[entry.client] = { 
                  name: entry.client, 
                  totalHours: 0, 
                  billableHours: 0, 
                  nonBillableHours: 0,
                  entries: [],
                  tasks: {}
                };
              }
              const hours = calculateTotalTime(entry.startTime, entry.endTime);
              clientMap[entry.client].totalHours += hours;
              if (entry.type === 'Billable') {
                clientMap[entry.client].billableHours += hours;
              } else {
                clientMap[entry.client].nonBillableHours += hours;
              }
              clientMap[entry.client].entries.push({ ...entry, date: ts.date, employee: ts.employee });
              
              // Track tasks under client
              if (entry.task) {
                if (!clientMap[entry.client].tasks[entry.task]) {
                  clientMap[entry.client].tasks[entry.task] = { hours: 0, entries: [] };
                }
                clientMap[entry.client].tasks[entry.task].hours += hours;
                clientMap[entry.client].tasks[entry.task].entries.push({ ...entry, date: ts.date, employee: ts.employee });
              }
            }
          });
        }
      });
      return Object.values(clientMap).sort((a, b) => b.totalHours - a.totalHours);
    };

    // Group by Task - filtered by allowed clients
    const getByTaskData = () => {
      const taskMap = {};
      monthTimesheets.forEach(ts => {
        if (ts.entries && ts.entries.length > 0) {
          ts.entries.forEach(entry => {
            // Only include entries for allowed clients
            if (!isSuperadmin && entry.client && !allowedClients.includes(entry.client)) {
              return;
            }
            
            const taskName = entry.task || 'Unspecified Task';
            if (!taskMap[taskName]) {
              taskMap[taskName] = { 
                name: taskName, 
                client: entry.client || '-',
                totalHours: 0, 
                billableHours: 0, 
                nonBillableHours: 0,
                entries: [],
                users: {}
              };
            }
            const hours = calculateTotalTime(entry.startTime, entry.endTime);
            taskMap[taskName].totalHours += hours;
            if (entry.type === 'Billable') {
              taskMap[taskName].billableHours += hours;
            } else {
              taskMap[taskName].nonBillableHours += hours;
            }
            taskMap[taskName].entries.push({ ...entry, date: ts.date, employee: ts.employee });
            
            // Track users under task
            if (!taskMap[taskName].users[ts.employee]) {
              taskMap[taskName].users[ts.employee] = { hours: 0, entries: [] };
            }
            taskMap[taskName].users[ts.employee].hours += hours;
            taskMap[taskName].users[ts.employee].entries.push({ ...entry, date: ts.date, employee: ts.employee });
          });
        }
      });
      return Object.values(taskMap).sort((a, b) => b.totalHours - a.totalHours);
    };

    // Group by User
    const getByUserData = () => {
      const userMap = {};
      monthTimesheets.forEach(ts => {
        if (!userMap[ts.employee]) {
          userMap[ts.employee] = { 
            name: ts.employee, 
            totalHours: 0, 
            billableHours: 0, 
            nonBillableHours: 0,
            presentDays: 0,
            leaveDays: 0,
            entries: [],
            dates: {}
          };
        }
        
        if (ts.status === 'Leave') {
          userMap[ts.employee].leaveDays += 1;
        } else {
          userMap[ts.employee].presentDays += 1;
          userMap[ts.employee].totalHours += ts.totalHours || 0;
          userMap[ts.employee].billableHours += ts.billableHours || 0;
          userMap[ts.employee].nonBillableHours += ts.nonBillableHours || 0;
        }
        
        if (ts.entries && ts.entries.length > 0) {
          ts.entries.forEach(entry => {
            userMap[ts.employee].entries.push({ ...entry, date: ts.date });
          });
        }
        
        // Track by date
        userMap[ts.employee].dates[ts.date] = ts;
      });
      return Object.values(userMap).sort((a, b) => b.totalHours - a.totalHours);
    };

    const byClientData = getByClientData();
    const byTaskData = getByTaskData();
    const byUserData = getByUserData();

    // Total summary
    const totalSummary = {
      totalHours: monthTimesheets.reduce((sum, ts) => sum + (ts.totalHours || 0), 0),
      billableHours: monthTimesheets.reduce((sum, ts) => sum + (ts.billableHours || 0), 0),
      nonBillableHours: monthTimesheets.reduce((sum, ts) => sum + (ts.nonBillableHours || 0), 0),
      totalTimesheets: monthTimesheets.length
    };

    const openDayWiseView = (type, name, entries) => {
      // Group entries by date
      const byDate = {};
      entries.forEach(entry => {
        if (!byDate[entry.date]) {
          byDate[entry.date] = [];
        }
        byDate[entry.date].push(entry);
      });
      setDayWiseView({ type, name, byDate });
    };

    return (
      <div className="timesheet-reports-view">
        <div className="view-header">
          <div>
            <h1><Clock size={28} /> Timesheet Reports</h1>
            <p className="view-subtitle">
              Analyze timesheet data by Client, Task, or User
              {!isSuperadmin && (
                <span style={{ 
                  marginLeft: '12px', 
                  padding: '4px 10px', 
                  background: isReportingManager ? '#dbeafe' : '#fef3c7',
                  color: isReportingManager ? '#1d4ed8' : '#92400e',
                  borderRadius: '12px',
                  fontSize: '11px',
                  fontWeight: 600
                }}>
                  {isReportingManager 
                    ? `Viewing: Your team (${allowedUsers.length} users)` 
                    : 'Viewing: Your data only'}
                </span>
              )}
              {isSuperadmin && (
                <span style={{ 
                  marginLeft: '12px', 
                  padding: '4px 10px', 
                  background: '#d1fae5',
                  color: '#065f46',
                  borderRadius: '12px',
                  fontSize: '11px',
                  fontWeight: 600
                }}>
                  Viewing: All Data (Superadmin)
                </span>
              )}
            </p>
          </div>
        </div>

        {/* Filters and Tabs */}
        <div className="ts-report-controls">
          <div className="ts-report-tabs">
            <button 
              className={`ts-tab ${reportType === 'byClient' ? 'active' : ''}`}
              onClick={() => { setReportType('byClient'); setExpandedItem(null); setDayWiseView(null); }}
            >
              <Briefcase size={16} /> By Client
            </button>
            <button 
              className={`ts-tab ${reportType === 'byTask' ? 'active' : ''}`}
              onClick={() => { setReportType('byTask'); setExpandedItem(null); setDayWiseView(null); }}
            >
              <FileText size={16} /> By Task
            </button>
            <button 
              className={`ts-tab ${reportType === 'byUser' ? 'active' : ''}`}
              onClick={() => { setReportType('byUser'); setExpandedItem(null); setDayWiseView(null); }}
            >
              <User size={16} /> By User
            </button>
          </div>
          <div className="ts-report-filters">
            <label>Month:</label>
            <input 
              type="month" 
              value={selectedMonth} 
              onChange={(e) => { setSelectedMonth(e.target.value); setExpandedItem(null); setDayWiseView(null); }}
            />
          </div>
        </div>

        {/* Summary Cards */}
        <div className="ts-summary-cards">
          <div className="ts-summary-card">
            <div className="ts-summary-icon"><Clock size={24} /></div>
            <div className="ts-summary-info">
              <span className="ts-summary-value">{totalSummary.totalHours.toFixed(1)}</span>
              <span className="ts-summary-label">Total Hours</span>
            </div>
          </div>
          <div className="ts-summary-card billable">
            <div className="ts-summary-icon"><DollarSign size={24} /></div>
            <div className="ts-summary-info">
              <span className="ts-summary-value">{totalSummary.billableHours.toFixed(1)}</span>
              <span className="ts-summary-label">Billable Hours</span>
            </div>
          </div>
          <div className="ts-summary-card nonbillable">
            <div className="ts-summary-icon"><Activity size={24} /></div>
            <div className="ts-summary-info">
              <span className="ts-summary-value">{totalSummary.nonBillableHours.toFixed(1)}</span>
              <span className="ts-summary-label">Non-Billable Hours</span>
            </div>
          </div>
          <div className="ts-summary-card entries">
            <div className="ts-summary-icon"><Calendar size={24} /></div>
            <div className="ts-summary-info">
              <span className="ts-summary-value">{totalSummary.totalTimesheets}</span>
              <span className="ts-summary-label">Timesheets</span>
            </div>
          </div>
        </div>

        {/* Day Wise View Modal */}
        {dayWiseView && (
          <div className="daywise-modal-overlay" onClick={() => setDayWiseView(null)}>
            <div className="daywise-modal" onClick={(e) => e.stopPropagation()}>
              <div className="daywise-header">
                <h3>
                  {dayWiseView.type === 'client' && <><Briefcase size={18} /> Client: {dayWiseView.name}</>}
                  {dayWiseView.type === 'task' && <><FileText size={18} /> Task: {dayWiseView.name}</>}
                  {dayWiseView.type === 'user' && <><User size={18} /> User: {dayWiseView.name}</>}
                </h3>
                <button onClick={() => setDayWiseView(null)}><X size={20} /></button>
              </div>
              <div className="daywise-subtitle">Day-wise Timesheet Entries for {selectedMonth}</div>
              <div className="daywise-content">
                {Object.keys(dayWiseView.byDate).sort().map(date => (
                  <div key={date} className="daywise-date-group">
                    <div className="daywise-date-header">
                      <Calendar size={14} />
                      <span>{date}</span>
                      <span className="daywise-date-total">
                        {dayWiseView.byDate[date].reduce((sum, e) => sum + calculateTotalTime(e.startTime, e.endTime), 0).toFixed(2)} Hrs
                      </span>
                    </div>
                    <table className="daywise-table">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Hours</th>
                          <th>Type</th>
                          {dayWiseView.type !== 'client' && <th>Client</th>}
                          {dayWiseView.type !== 'task' && <th>Task</th>}
                          {dayWiseView.type !== 'user' && <th>Employee</th>}
                          <th>Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        {dayWiseView.byDate[date].map((entry, idx) => (
                          <tr key={idx}>
                            <td>{entry.startTime} - {entry.endTime}</td>
                            <td className="hours-cell">{calculateTotalTime(entry.startTime, entry.endTime).toFixed(2)}</td>
                            <td><span className={`type-badge ${entry.type === 'Billable' ? 'billable' : 'nonbillable'}`}>{entry.type}</span></td>
                            {dayWiseView.type !== 'client' && <td>{entry.client || '-'}</td>}
                            {dayWiseView.type !== 'task' && <td>{entry.task || '-'}</td>}
                            {dayWiseView.type !== 'user' && <td>{entry.employee}</td>}
                            <td className="desc-cell">{entry.description || '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Report Content */}
        <div className="ts-report-content">
          {/* By Client View */}
          {reportType === 'byClient' && (
            <div className="ts-report-section">
              <h2><Briefcase size={20} /> Timesheet by Client</h2>
              {byClientData.length === 0 ? (
                <div className="no-data">No timesheet data for this month</div>
              ) : (
                <div className="ts-report-table-container">
                  <table className="ts-report-table">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Client Name</th>
                        <th>Total Hours</th>
                        <th>Billable</th>
                        <th>Non-Billable</th>
                        <th>Tasks</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {byClientData.map((client, idx) => (
                        <React.Fragment key={idx}>
                          <tr className="ts-report-row" onClick={() => setExpandedItem(expandedItem === client.name ? null : client.name)}>
                            <td className="expand-cell">
                              {expandedItem === client.name ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                            </td>
                            <td className="name-cell"><Briefcase size={14} /> {client.name}</td>
                            <td className="hours-cell"><strong>{client.totalHours.toFixed(2)}</strong></td>
                            <td className="hours-cell billable">{client.billableHours.toFixed(2)}</td>
                            <td className="hours-cell nonbillable">{client.nonBillableHours.toFixed(2)}</td>
                            <td>{Object.keys(client.tasks).length}</td>
                            <td>
                              <button className="btn-view-daywise" onClick={(e) => { e.stopPropagation(); openDayWiseView('client', client.name, client.entries); }}>
                                <Eye size={14} /> Day View
                              </button>
                            </td>
                          </tr>
                          {expandedItem === client.name && (
                            <tr className="expanded-row">
                              <td colSpan="7">
                                <div className="expanded-content">
                                  <h4>Tasks under {client.name}</h4>
                                  <table className="nested-table">
                                    <thead>
                                      <tr><th>Task</th><th>Hours</th><th>Entries</th></tr>
                                    </thead>
                                    <tbody>
                                      {Object.entries(client.tasks).map(([taskName, taskData]) => (
                                        <tr key={taskName}>
                                          <td>{taskName}</td>
                                          <td>{taskData.hours.toFixed(2)}</td>
                                          <td>{taskData.entries.length}</td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* By Task View */}
          {reportType === 'byTask' && (
            <div className="ts-report-section">
              <div className="ts-task-header">
                <h2><FileText size={20} /> Timesheet by Task</h2>
                <div className="ts-task-type-tabs">
                  <button 
                    className={`ts-type-tab ${taskTypeFilter === 'all' ? 'active' : ''}`}
                    onClick={() => { setTaskTypeFilter('all'); setExpandedItem(null); }}
                  >
                    All Tasks
                  </button>
                  <button 
                    className={`ts-type-tab billable ${taskTypeFilter === 'billable' ? 'active' : ''}`}
                    onClick={() => { setTaskTypeFilter('billable'); setExpandedItem(null); }}
                  >
                    <DollarSign size={14} /> Billable
                  </button>
                  <button 
                    className={`ts-type-tab nonbillable ${taskTypeFilter === 'nonBillable' ? 'active' : ''}`}
                    onClick={() => { setTaskTypeFilter('nonBillable'); setExpandedItem(null); }}
                  >
                    <Activity size={14} /> Non-Billable
                  </button>
                </div>
              </div>
              {(() => {
                // Filter tasks based on taskTypeFilter
                let filteredTasks = byTaskData;
                if (taskTypeFilter === 'billable') {
                  filteredTasks = byTaskData.filter(t => t.billableHours > 0).map(t => ({
                    ...t,
                    totalHours: t.billableHours,
                    entries: t.entries.filter(e => e.type === 'Billable')
                  }));
                } else if (taskTypeFilter === 'nonBillable') {
                  filteredTasks = byTaskData.filter(t => t.nonBillableHours > 0).map(t => ({
                    ...t,
                    totalHours: t.nonBillableHours,
                    entries: t.entries.filter(e => e.type === 'Non-Billable')
                  }));
                }

                const totalFilteredHours = filteredTasks.reduce((sum, t) => sum + t.totalHours, 0);

                return filteredTasks.length === 0 ? (
                  <div className="no-data">
                    No {taskTypeFilter === 'billable' ? 'billable' : taskTypeFilter === 'nonBillable' ? 'non-billable' : ''} timesheet data for this month
                  </div>
                ) : (
                  <>
                    <div className="ts-task-summary-bar">
                      <span className="summary-item">
                        <strong>{filteredTasks.length}</strong> {taskTypeFilter === 'all' ? 'Tasks' : taskTypeFilter === 'billable' ? 'Billable Tasks' : 'Non-Billable Tasks'}
                      </span>
                      <span className="summary-item">
                        Total: <strong className={taskTypeFilter === 'billable' ? 'billable' : taskTypeFilter === 'nonBillable' ? 'nonbillable' : ''}>{totalFilteredHours.toFixed(2)} Hrs</strong>
                      </span>
                    </div>
                    <div className="ts-report-table-container">
                      <table className="ts-report-table">
                        <thead>
                          <tr>
                            <th></th>
                            <th>Task Name</th>
                            <th>Client</th>
                            <th>Total Hours</th>
                            {taskTypeFilter === 'all' && <th>Billable</th>}
                            {taskTypeFilter === 'all' && <th>Non-Billable</th>}
                            <th>Users</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredTasks.map((task, idx) => (
                            <React.Fragment key={idx}>
                              <tr className="ts-report-row" onClick={() => setExpandedItem(expandedItem === task.name ? null : task.name)}>
                                <td className="expand-cell">
                                  {expandedItem === task.name ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                                </td>
                                <td className="name-cell">
                                  <FileText size={14} /> {task.name}
                                  {taskTypeFilter !== 'all' && (
                                    <span className={`type-indicator ${taskTypeFilter}`}>
                                      {taskTypeFilter === 'billable' ? 'ðŸ’µ' : 'ðŸ“Š'}
                                    </span>
                                  )}
                                </td>
                                <td>{task.client}</td>
                                <td className={`hours-cell ${taskTypeFilter !== 'all' ? taskTypeFilter : ''}`}>
                                  <strong>{task.totalHours.toFixed(2)}</strong>
                                </td>
                                {taskTypeFilter === 'all' && <td className="hours-cell billable">{task.billableHours.toFixed(2)}</td>}
                                {taskTypeFilter === 'all' && <td className="hours-cell nonbillable">{task.nonBillableHours.toFixed(2)}</td>}
                                <td>{Object.keys(task.users).length}</td>
                                <td>
                                  <button className="btn-view-daywise" onClick={(e) => { e.stopPropagation(); openDayWiseView('task', task.name, task.entries); }}>
                                    <Eye size={14} /> Day View
                                  </button>
                                </td>
                              </tr>
                              {expandedItem === task.name && (
                                <tr className="expanded-row">
                                  <td colSpan={taskTypeFilter === 'all' ? 8 : 6}>
                                    <div className="expanded-content">
                                      <h4>Users working on {task.name}</h4>
                                      <table className="nested-table">
                                        <thead>
                                          <tr><th>User</th><th>Hours</th><th>Entries</th></tr>
                                        </thead>
                                        <tbody>
                                          {Object.entries(task.users).map(([userName, userData]) => (
                                            <tr key={userName}>
                                              <td><User size={12} /> {userName}</td>
                                              <td>{userData.hours.toFixed(2)}</td>
                                              <td>{userData.entries.length}</td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  </td>
                                </tr>
                              )}
                            </React.Fragment>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                );
              })()}
            </div>
          )}

          {/* By User View */}
          {reportType === 'byUser' && (
            <div className="ts-report-section">
              <h2><User size={20} /> Timesheet by User</h2>
              {byUserData.length === 0 ? (
                <div className="no-data">No timesheet data for this month</div>
              ) : (
                <div className="ts-report-table-container">
                  <table className="ts-report-table">
                    <thead>
                      <tr>
                        <th></th>
                        <th>User Name</th>
                        <th>Total Hours</th>
                        <th>Billable</th>
                        <th>Non-Billable</th>
                        <th>Present Days</th>
                        <th>Leave Days</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {byUserData.map((user, idx) => (
                        <React.Fragment key={idx}>
                          <tr className="ts-report-row" onClick={() => setExpandedItem(expandedItem === user.name ? null : user.name)}>
                            <td className="expand-cell">
                              {expandedItem === user.name ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                            </td>
                            <td className="name-cell"><User size={14} /> {user.name}</td>
                            <td className="hours-cell"><strong>{user.totalHours.toFixed(2)}</strong></td>
                            <td className="hours-cell billable">{user.billableHours.toFixed(2)}</td>
                            <td className="hours-cell nonbillable">{user.nonBillableHours.toFixed(2)}</td>
                            <td className="present-cell">{user.presentDays}</td>
                            <td className="leave-cell">{user.leaveDays}</td>
                            <td>
                              <button className="btn-view-daywise" onClick={(e) => { e.stopPropagation(); openDayWiseView('user', user.name, user.entries); }}>
                                <Eye size={14} /> Day View
                              </button>
                            </td>
                          </tr>
                          {expandedItem === user.name && (
                            <tr className="expanded-row">
                              <td colSpan="8">
                                <div className="expanded-content">
                                  <h4>Timesheets for {user.name}</h4>
                                  <table className="nested-table">
                                    <thead>
                                      <tr><th>Date</th><th>Status</th><th>Total</th><th>Billable</th><th>Non-Billable</th></tr>
                                    </thead>
                                    <tbody>
                                      {Object.entries(user.dates).sort(([a], [b]) => a.localeCompare(b)).map(([date, ts]) => (
                                        <tr key={date}>
                                          <td>{date}</td>
                                          <td><span className={`status-badge ${ts.status === 'Leave' ? 'leave' : 'present'}`}>{ts.status || ts.attendanceStatus}</span></td>
                                          <td>{ts.totalHours?.toFixed(2) || '-'}</td>
                                          <td>{ts.billableHours?.toFixed(2) || '-'}</td>
                                          <td>{ts.nonBillableHours?.toFixed(2) || '-'}</td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  };

  // Reports View
  const ReportsView = () => {
    const [activeReportTab, setActiveReportTab] = useState('dashboard');
    const [reportFilters, setReportFilters] = useState({
      dateFrom: '',
      dateTo: '',
      client: '',
      staff: '',
      parentTask: '',
      childTask: '',
      status: '',
      financialYear: '',
      reportingManager: '',
      selectedRM: '',
      rmDetailView: '',
      clientSearch: '',
      debtorFilter: '',
      clientGroup: '',
      sortBy: 'name',
      snapshotDate: new Date().toISOString().split('T')[0]
    });
    const [showFilters, setShowFilters] = useState(true);
    
    // Get current date info
    const today = new Date();
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    
    // =====================
    // KPI CALCULATIONS
    // =====================
    const allTasks = data.tasks.filter(t => !t.deleted);
    const completedTasks = allTasks.filter(t => t.status === 'Completed' || t.completedCheck);
    const pendingTasks = allTasks.filter(t => t.status !== 'Completed' && !t.completedCheck);
    const overdueTasks = pendingTasks.filter(t => {
      if (!t.dueDate) return false;
      const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
      return dueDate < today;
    });
    
    // Billing KPIs
    const totalBilled = (data.invoices || []).reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
    const totalCollected = (data.receipts || []).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
    const totalOutstanding = totalBilled - totalCollected;
    
    // This month metrics
    const tasksThisMonth = allTasks.filter(t => {
      const created = t.createdAt ? new Date(t.createdAt) : null;
      return created && created >= startOfMonth;
    }).length;
    const completedThisMonth = completedTasks.filter(t => {
      const compDate = t.completedDate ? new Date(t.completedDate.split('-').reverse().join('-')) : null;
      return compDate && compDate >= startOfMonth;
    }).length;
    const billedThisMonth = (data.invoices || []).filter(inv => {
      const invDate = new Date(inv.date);
      return invDate >= startOfMonth;
    }).reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
    const collectedThisMonth = (data.receipts || []).filter(r => {
      const rDate = new Date(r.date);
      return rDate >= startOfMonth;
    }).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
    
    // Staff metrics
    const activeStaff = data.staff.filter(s => s.status === 'Active').length;
    const avgTasksPerStaff = activeStaff > 0 ? Math.round(allTasks.length / activeStaff) : 0;
    
    // Efficiency rate
    const onTimeCompletions = completedTasks.filter(t => {
      if (!t.dueDate || !t.completedDate) return true;
      const dueDate = new Date(t.dueDate.split('-').reverse().join('-'));
      const compDate = new Date(t.completedDate.split('-').reverse().join('-'));
      return compDate <= dueDate;
    }).length;
    const efficiencyRate = completedTasks.length > 0 ? Math.round((onTimeCompletions / completedTasks.length) * 100) : 0;
    
    // Collection rate
    const collectionRate = totalBilled > 0 ? Math.round((totalCollected / totalBilled) * 100) : 0;
    
    // =====================
    // FILTER FUNCTIONS
    // =====================
    const applyFilters = (items, type) => {
      return items.filter(item => {
        if (type === 'task') {
          if (reportFilters.client && !(item.clientName || item.client || '').toLowerCase().includes(reportFilters.client.toLowerCase())) return false;
          if (reportFilters.staff && item.primaryAssignedUser !== reportFilters.staff && item.assignedTo !== reportFilters.staff) return false;
          if (reportFilters.parentTask && item.parentTask !== reportFilters.parentTask) return false;
          if (reportFilters.childTask && item.childTask !== reportFilters.childTask) return false;
          if (reportFilters.status) {
            if (reportFilters.status === 'Completed' && item.status !== 'Completed' && !item.completedCheck) return false;
            if (reportFilters.status === 'Pending' && (item.status === 'Completed' || item.completedCheck)) return false;
            if (reportFilters.status === 'In Progress' && item.status !== 'In Progress') return false;
            if (reportFilters.status === 'Overdue') {
              if (item.status === 'Completed' || item.completedCheck) return false;
              if (!item.dueDate) return false;
              const dueDate = new Date(item.dueDate.split('-').reverse().join('-'));
              if (dueDate >= today) return false;
            }
          }
          if (reportFilters.financialYear && item.financialYear !== reportFilters.financialYear) return false;
          if (reportFilters.dateFrom) {
            const itemDate = item.startDate ? new Date(item.startDate.split('-').reverse().join('-')) : null;
            const fromDate = new Date(reportFilters.dateFrom);
            if (!itemDate || itemDate < fromDate) return false;
          }
          if (reportFilters.dateTo) {
            const itemDate = item.startDate ? new Date(item.startDate.split('-').reverse().join('-')) : null;
            const toDate = new Date(reportFilters.dateTo);
            if (!itemDate || itemDate > toDate) return false;
          }
        }
        return true;
      });
    };
    
    const filteredTasks = applyFilters(allTasks, 'task');
    
    // Get unique values for filters
    const uniqueClients = [...new Set(data.clients.map(c => c.name))].filter(Boolean).sort();
    const uniqueStaff = data.staff.filter(s => s.status === 'Active').map(s => s.name).sort();
    const uniqueParentTasks = Object.keys(PARENT_CHILD_TASKS);
    const uniqueFYs = [...new Set(allTasks.map(t => t.financialYear))].filter(Boolean).sort();
    const reportingManagers = data.staff.filter(s => s.role === 'Reporting Manager').map(s => s.name);
    
    // =====================
    // EXPORT FUNCTION
    // =====================
    const exportToCSV = (dataToExport, filename, headers) => {
      const csv = [
        headers.join(','),
        ...dataToExport.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    };
    
    // =====================
    // REPORT TABS
    // =====================
    const reportTabs = [
      { id: 'dashboard', label: 'Daily Snapshot', icon: 'ðŸ“…' },
      { id: 'taskReport', label: 'Task Report', icon: 'ðŸ“‹' },
      { id: 'timesheetReport', label: 'Timesheet Report', icon: 'â±ï¸' },
      { id: 'employeeReport', label: 'Employee Report', icon: 'ðŸ‘¥' },
      { id: 'debtorsReport', label: 'Debtors Report', icon: 'ðŸ’°' },
      { id: 'clientReport', label: 'Client Report', icon: 'ðŸ¢' },
      { id: 'rmReport', label: 'RM Report', icon: 'ðŸ“ˆ' }
    ];
    
    // =====================
    // SIMPLE CHART COMPONENTS
    // =====================
    const MiniBarChart = ({ data, maxVal }) => (
      <div style={{display: 'flex', alignItems: 'flex-end', gap: '4px', height: '60px'}}>
        {data.map((item, idx) => (
          <div key={idx} style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}}>
            <div style={{
              width: '100%',
              height: `${maxVal > 0 ? (item.value / maxVal) * 50 : 0}px`,
              background: item.color || '#3b82f6',
              borderRadius: '4px 4px 0 0',
              minHeight: item.value > 0 ? '4px' : '0'
            }}></div>
            <span style={{fontSize: '9px', color: '#64748b'}}>{item.label}</span>
          </div>
        ))}
      </div>
    );
    
    // =====================
    // RENDER REPORTS
    // =====================
    return (
      <div style={{padding: '24px', background: '#f8fafc', minHeight: '100vh'}}>
        {/* Header */}
        <div style={{marginBottom: '24px'}}>
          <h1 style={{margin: 0, fontSize: '24px', fontWeight: '700', color: '#1e293b'}}>Reports & Analytics</h1>
          <p style={{margin: '4px 0 0', color: '#64748b', fontSize: '14px'}}>Comprehensive business intelligence and reporting</p>
        </div>
        
        {/* Report Tabs */}
        <div style={{display: 'flex', gap: '8px', marginBottom: '24px', flexWrap: 'wrap', background: '#fff', padding: '12px', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.04)'}}>
          {reportTabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveReportTab(tab.id)}
              style={{
                padding: '10px 20px',
                background: activeReportTab === tab.id ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#f1f5f9',
                color: activeReportTab === tab.id ? '#fff' : '#64748b',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontWeight: '600',
                fontSize: '13px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                transition: 'all 0.2s'
              }}
            >
              <span>{tab.icon}</span>
              {tab.label}
            </button>
          ))}
        </div>
        
        {/* ==================== DAILY SNAPSHOT ==================== */}
        {activeReportTab === 'dashboard' && (
          <div>
            {/* Date Selector */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>ðŸ“… Daily Activity Snapshot</h3>
                <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                  <label style={{fontSize: '12px', color: '#64748b'}}>Select Date:</label>
                  <input 
                    type="date" 
                    value={reportFilters.snapshotDate || new Date().toISOString().split('T')[0]} 
                    onChange={(e) => setReportFilters({...reportFilters, snapshotDate: e.target.value})} 
                    style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} 
                  />
                  <button 
                    onClick={() => setReportFilters({...reportFilters, snapshotDate: new Date().toISOString().split('T')[0]})}
                    style={{padding: '8px 16px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}
                  >
                    Today
                  </button>
                </div>
              </div>
            </div>
            
            {(() => {
              const snapshotDate = reportFilters.snapshotDate || new Date().toISOString().split('T')[0];
              const snapshotDateObj = new Date(snapshotDate);
              snapshotDateObj.setHours(0, 0, 0, 0);
              const snapshotDateStr = snapshotDateObj.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
              
              // Helper to check if date matches
              const matchesDate = (dateStr) => {
                if (!dateStr) return false;
                try {
                  // Handle various date formats
                  let checkDate;
                  if (dateStr.includes('T')) {
                    checkDate = new Date(dateStr);
                  } else if (dateStr.includes('-')) {
                    // Could be YYYY-MM-DD or DD-MM-YYYY
                    const parts = dateStr.split('-');
                    if (parts[0].length === 4) {
                      checkDate = new Date(dateStr);
                    } else {
                      checkDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    }
                  } else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    checkDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                  } else {
                    checkDate = new Date(dateStr);
                  }
                  checkDate.setHours(0, 0, 0, 0);
                  return checkDate.getTime() === snapshotDateObj.getTime();
                } catch (e) {
                  return false;
                }
              };
              
              // Tasks created on this date (use createdAt or startDate)
              const tasksCreated = allTasks.filter(t => {
                return matchesDate(t.createdAt) || matchesDate(t.startDate);
              });
              
              // Tasks deleted on this date
              const tasksDeleted = data.tasks.filter(t => {
                if (!t.deleted) return false;
                return matchesDate(t.deletedAt) || matchesDate(t.deletedDate);
              });
              
              // Tasks completed on this date
              const tasksCompleted = allTasks.filter(t => {
                if (!(t.status === 'Completed' || t.completedCheck)) return false;
                return matchesDate(t.completedDate) || matchesDate(t.completedAt);
              });
              
              // Clients created on this date (use createdAt or check if empty, show all for demo)
              const clientsCreated = data.clients.filter(c => {
                if (!c.disabled && matchesDate(c.createdAt)) return true;
                return false;
              });
              
              // Clients disabled on this date
              const clientsDisabled = data.clients.filter(c => {
                if (!c.disabled) return false;
                return matchesDate(c.disabledAt);
              });
              
              // Invoices/Billing created on this date (use invoiceDate field)
              const invoicesCreated = (data.invoices || []).filter(inv => matchesDate(inv.invoiceDate) || matchesDate(inv.date));
              const totalInvoiceAmount = invoicesCreated.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
              
              // Receipts created on this date (use receiptDate field)
              const receiptsCreated = (data.receipts || []).filter(r => matchesDate(r.receiptDate) || matchesDate(r.date));
              const totalReceiptAmount = receiptsCreated.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
              
              // Staff added on this date
              const staffAdded = data.staff.filter(s => matchesDate(s.createdAt));
              
              return (
                <>
                  {/* Date Header */}
                  <div style={{textAlign: 'center', marginBottom: '24px'}}>
                    <div style={{fontSize: '14px', color: '#64748b', marginBottom: '4px'}}>Activity Summary for</div>
                    <div style={{fontSize: '20px', fontWeight: '600', color: '#1e293b'}}>{snapshotDateStr}</div>
                  </div>
                  
                  {/* Summary Cards */}
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px'}}>
                    <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe'}}>
                      <div style={{fontSize: '11px', color: '#3b82f6', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ“‹ Tasks Created</div>
                      <div style={{fontSize: '32px', fontWeight: '700', color: '#1e40af'}}>{tasksCreated.length}</div>
                      <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>{tasksCompleted.length} completed</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca'}}>
                      <div style={{fontSize: '11px', color: '#dc2626', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ—‘ï¸ Tasks Deleted</div>
                      <div style={{fontSize: '32px', fontWeight: '700', color: '#b91c1c'}}>{tasksDeleted.length}</div>
                      <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>removed</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff'}}>
                      <div style={{fontSize: '11px', color: '#9333ea', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ¢ Clients Added</div>
                      <div style={{fontSize: '32px', fontWeight: '700', color: '#7c3aed'}}>{clientsCreated.length}</div>
                      <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>{clientsDisabled.length} disabled</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0'}}>
                      <div style={{fontSize: '11px', color: '#16a34a', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ“„ Billing</div>
                      <div style={{fontSize: '32px', fontWeight: '700', color: '#166534'}}>{invoicesCreated.length}</div>
                      <div style={{fontSize: '11px', color: '#16a34a', marginTop: '4px'}}>â‚¹{totalInvoiceAmount.toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a'}}>
                      <div style={{fontSize: '11px', color: '#d97706', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ’° Receipts</div>
                      <div style={{fontSize: '32px', fontWeight: '700', color: '#b45309'}}>{receiptsCreated.length}</div>
                      <div style={{fontSize: '11px', color: '#d97706', marginTop: '4px'}}>â‚¹{totalReceiptAmount.toLocaleString('en-IN')}</div>
                    </div>
                  </div>
                  
                  {/* Detailed Sections - Row 1 */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                    {/* Tasks Created */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#3b82f6', borderRadius: '50%'}}></span>
                        Tasks Created ({tasksCreated.length})
                      </h3>
                      {tasksCreated.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No tasks created on this date</div>
                      ) : (
                        <div style={{maxHeight: '220px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Client</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Task</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Sub-Period</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Assigned</th>
                              </tr>
                            </thead>
                            <tbody>
                              {tasksCreated.slice(0, 15).map(task => (
                                <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                  <td style={{padding: '8px'}}>{task.clientName || task.client || '-'}</td>
                                  <td style={{padding: '8px', fontWeight: '500'}}>{task.childTask || task.parentTask}</td>
                                  <td style={{padding: '8px', color: '#8b5cf6', fontSize: '10px'}}>{task.subPeriod || task.period || '-'}</td>
                                  <td style={{padding: '8px', color: '#64748b'}}>{task.primaryAssignedUser || '-'}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          {tasksCreated.length > 15 && <div style={{padding: '8px', textAlign: 'center', color: '#64748b', fontSize: '10px'}}>+{tasksCreated.length - 15} more</div>}
                        </div>
                      )}
                    </div>
                    
                    {/* Tasks Deleted */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#ef4444', borderRadius: '50%'}}></span>
                        Tasks Deleted ({tasksDeleted.length})
                      </h3>
                      {tasksDeleted.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No tasks deleted on this date</div>
                      ) : (
                        <div style={{maxHeight: '220px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Client</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Task</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Sub-Period</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Deleted By</th>
                              </tr>
                            </thead>
                            <tbody>
                              {tasksDeleted.slice(0, 15).map(task => (
                                <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9', background: '#fef2f2'}}>
                                  <td style={{padding: '8px'}}>{task.clientName || task.client || '-'}</td>
                                  <td style={{padding: '8px', fontWeight: '500', textDecoration: 'line-through', color: '#94a3b8'}}>{task.childTask || task.parentTask}</td>
                                  <td style={{padding: '8px', color: '#8b5cf6', fontSize: '10px'}}>{task.subPeriod || task.period || '-'}</td>
                                  <td style={{padding: '8px', color: '#64748b'}}>{task.deletedBy || '-'}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          {tasksDeleted.length > 15 && <div style={{padding: '8px', textAlign: 'center', color: '#64748b', fontSize: '10px'}}>+{tasksDeleted.length - 15} more</div>}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Row 2 - Tasks Completed */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                    {/* Tasks Completed */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#10b981', borderRadius: '50%'}}></span>
                        Tasks Completed ({tasksCompleted.length})
                      </h3>
                      {tasksCompleted.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No tasks completed on this date</div>
                      ) : (
                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Client</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Task</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Completed By</th>
                              </tr>
                            </thead>
                            <tbody>
                              {tasksCompleted.slice(0, 10).map(task => (
                                <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                  <td style={{padding: '8px'}}>{task.clientName || task.client || '-'}</td>
                                  <td style={{padding: '8px', fontWeight: '500'}}>{task.childTask || task.parentTask}</td>
                                  <td style={{padding: '8px', color: '#64748b'}}>{task.primaryAssignedUser || '-'}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          {tasksCompleted.length > 10 && <div style={{padding: '8px', textAlign: 'center', color: '#64748b', fontSize: '10px'}}>+{tasksCompleted.length - 10} more</div>}
                        </div>
                      )}
                    </div>
                    
                    {/* Clients Added */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#8b5cf6', borderRadius: '50%'}}></span>
                        Clients Added ({clientsCreated.length})
                      </h3>
                      {clientsCreated.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No clients added on this date</div>
                      ) : (
                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                          {clientsCreated.map(client => (
                            <div key={client.id} style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '10px', background: '#f8fafc', borderRadius: '8px', marginBottom: '8px'}}>
                              <div style={{width: '36px', height: '36px', borderRadius: '50%', background: '#8b5cf6', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600'}}>{client.name.charAt(0)}</div>
                              <div>
                                <div style={{fontSize: '12px', fontWeight: '500'}}>{client.name}</div>
                                <div style={{fontSize: '10px', color: '#64748b'}}>{formatFileNo(client.fileNo) || 'No Code'} â€¢ Group {client.fileNo ? client.fileNo.split('.')[0] : 'N/A'}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Row 3 - Billing & Receipts */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                    {/* Billing/Invoices */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#10b981', borderRadius: '50%'}}></span>
                        Billing ({invoicesCreated.length}) - â‚¹{totalInvoiceAmount.toLocaleString('en-IN')}
                      </h3>
                      {invoicesCreated.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No billing on this date</div>
                      ) : (
                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Invoice #</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Client</th>
                                <th style={{padding: '8px', textAlign: 'right', fontWeight: '600'}}>Amount</th>
                              </tr>
                            </thead>
                            <tbody>
                              {invoicesCreated.map(inv => (
                                <tr key={inv.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                  <td style={{padding: '8px', fontWeight: '500'}}>{inv.invoiceNumber || inv.id?.slice(-8)}</td>
                                  <td style={{padding: '8px'}}>{inv.clientName || '-'}</td>
                                  <td style={{padding: '8px', textAlign: 'right', fontWeight: '600', color: '#10b981'}}>â‚¹{(parseFloat(inv.totalAmount) || 0).toLocaleString('en-IN')}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                    
                    {/* Receipts */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#f59e0b', borderRadius: '50%'}}></span>
                        Receipts ({receiptsCreated.length}) - â‚¹{totalReceiptAmount.toLocaleString('en-IN')}
                      </h3>
                      {receiptsCreated.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No receipts on this date</div>
                      ) : (
                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Receipt #</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Client</th>
                                <th style={{padding: '8px', textAlign: 'left', fontWeight: '600'}}>Mode</th>
                                <th style={{padding: '8px', textAlign: 'right', fontWeight: '600'}}>Amount</th>
                              </tr>
                            </thead>
                            <tbody>
                              {receiptsCreated.map(r => (
                                <tr key={r.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                  <td style={{padding: '8px', fontWeight: '500'}}>{r.receiptNumber || r.id?.slice(-8)}</td>
                                  <td style={{padding: '8px'}}>{r.clientName || '-'}</td>
                                  <td style={{padding: '8px'}}>{r.mode || r.paymentMode || 'Bank'}</td>
                                  <td style={{padding: '8px', textAlign: 'right', fontWeight: '600', color: '#f59e0b'}}>â‚¹{(parseFloat(r.amount) || 0).toLocaleString('en-IN')}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Row 4 - Staff Added */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#ec4899', borderRadius: '50%'}}></span>
                        Staff Added ({staffAdded.length})
                      </h3>
                      {staffAdded.length === 0 ? (
                        <div style={{padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '12px'}}>No staff added on this date</div>
                      ) : (
                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                          {staffAdded.map(staff => (
                            <div key={staff.id} style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '10px', background: '#f8fafc', borderRadius: '8px', marginBottom: '8px'}}>
                              <div style={{width: '36px', height: '36px', borderRadius: '50%', background: '#ec4899', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600'}}>{staff.name.charAt(0)}</div>
                              <div>
                                <div style={{fontSize: '12px', fontWeight: '500'}}>{staff.name}</div>
                                <div style={{fontSize: '10px', color: '#64748b'}}>{staff.role} â€¢ {staff.email}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Quick Stats */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{width: '8px', height: '8px', background: '#64748b', borderRadius: '50%'}}></span>
                        Quick Stats
                      </h3>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', textAlign: 'center'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#3b82f6'}}>{allTasks.length}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Total Tasks</div>
                        </div>
                        <div style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', textAlign: 'center'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>{allTasks.filter(t => t.status === 'Completed' || t.completedCheck).length}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Completed</div>
                        </div>
                        <div style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', textAlign: 'center'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#8b5cf6'}}>{data.clients.filter(c => !c.disabled).length}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Active Clients</div>
                        </div>
                        <div style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', textAlign: 'center'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#f59e0b'}}>{data.staff.filter(s => s.status === 'Active').length}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Active Staff</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        )}
        {/* ==================== TASK REPORT ==================== */}
        {activeReportTab === 'taskReport' && (
          <div>
            {/* Filters */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>ðŸ” Filters</h3>
                <div style={{display: 'flex', gap: '8px'}}>
                  <button onClick={() => setReportFilters({dateFrom: '', dateTo: '', client: '', staff: '', parentTask: '', childTask: '', status: '', financialYear: '', reportingManager: ''})} style={{padding: '6px 12px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>Clear Filters</button>
                  <button onClick={() => exportToCSV(filteredTasks, 'task_report', ['clientName', 'parentTask', 'childTask', 'primaryAssignedUser', 'status', 'startDate', 'dueDate', 'financialYear'])} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>ðŸ“¥ Export CSV</button>
                </div>
              </div>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '12px'}}>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Date From</label>
                  <input type="date" value={reportFilters.dateFrom} onChange={(e) => setReportFilters({...reportFilters, dateFrom: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Date To</label>
                  <input type="date" value={reportFilters.dateTo} onChange={(e) => setReportFilters({...reportFilters, dateTo: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Client</label>
                  <select value={reportFilters.client} onChange={(e) => setReportFilters({...reportFilters, client: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Clients</option>
                    {uniqueClients.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Staff</label>
                  <select value={reportFilters.staff} onChange={(e) => setReportFilters({...reportFilters, staff: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Staff</option>
                    {uniqueStaff.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Task Category</label>
                  <select value={reportFilters.parentTask} onChange={(e) => setReportFilters({...reportFilters, parentTask: e.target.value, childTask: ''})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Categories</option>
                    {uniqueParentTasks.map(p => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Status</label>
                  <select value={reportFilters.status} onChange={(e) => setReportFilters({...reportFilters, status: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Status</option>
                    <option value="Completed">Completed</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Overdue">Overdue</option>
                  </select>
                </div>
              </div>
            </div>
            
            {/* Summary Cards */}
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '20px'}}>
              <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <div style={{fontSize: '24px', fontWeight: '700', color: '#3b82f6'}}>{filteredTasks.length}</div>
                <div style={{fontSize: '12px', color: '#64748b'}}>Total Tasks</div>
              </div>
              <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <div style={{fontSize: '24px', fontWeight: '700', color: '#10b981'}}>{filteredTasks.filter(t => t.status === 'Completed' || t.completedCheck).length}</div>
                <div style={{fontSize: '12px', color: '#64748b'}}>Completed</div>
              </div>
              <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <div style={{fontSize: '24px', fontWeight: '700', color: '#f59e0b'}}>{filteredTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length}</div>
                <div style={{fontSize: '12px', color: '#64748b'}}>Pending</div>
              </div>
              <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                <div style={{fontSize: '24px', fontWeight: '700', color: '#ef4444'}}>{filteredTasks.filter(t => {
                  if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                  return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                }).length}</div>
                <div style={{fontSize: '12px', color: '#64748b'}}>Overdue</div>
              </div>
            </div>
            
            {/* Task Table */}
            <div style={{background: '#fff', borderRadius: '12px', border: '1px solid #e2e8f0', overflow: 'hidden'}}>
              <div style={{maxHeight: '500px', overflowY: 'auto'}}>
                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                  <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                    <tr>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Sr.</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Category</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Type</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Assigned To</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Start Date</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Date</th>
                      <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>FY</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredTasks.slice(0, 100).map((task, idx) => {
                      const isOverdue = task.dueDate && task.status !== 'Completed' && !task.completedCheck && new Date(task.dueDate.split('-').reverse().join('-')) < today;
                      return (
                        <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9', background: isOverdue ? '#fef2f2' : 'transparent'}}>
                          <td style={{padding: '10px 12px'}}>{idx + 1}</td>
                          <td style={{padding: '10px 12px', fontWeight: '500'}}>{task.clientName || task.client || '-'}</td>
                          <td style={{padding: '10px 12px'}}>{task.parentTask || '-'}</td>
                          <td style={{padding: '10px 12px'}}>{task.childTask || '-'}</td>
                          <td style={{padding: '10px 12px'}}>{task.primaryAssignedUser || task.assignedTo || '-'}</td>
                          <td style={{padding: '10px 12px'}}>{task.startDate || '-'}</td>
                          <td style={{padding: '10px 12px', color: isOverdue ? '#ef4444' : 'inherit', fontWeight: isOverdue ? '600' : '400'}}>{task.dueDate || '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'center'}}>
                            <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '10px', fontWeight: '600', background: task.status === 'Completed' || task.completedCheck ? '#dcfce7' : task.status === 'In Progress' ? '#fef3c7' : isOverdue ? '#fee2e2' : '#dbeafe', color: task.status === 'Completed' || task.completedCheck ? '#166534' : task.status === 'In Progress' ? '#92400e' : isOverdue ? '#dc2626' : '#1d4ed8'}}>{task.status === 'Completed' || task.completedCheck ? 'Completed' : isOverdue ? 'Overdue' : task.status || 'Open'}</span>
                          </td>
                          <td style={{padding: '10px 12px'}}>{task.financialYear || '-'}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              {filteredTasks.length > 100 && <div style={{padding: '12px', textAlign: 'center', background: '#f8fafc', fontSize: '12px', color: '#64748b'}}>Showing 100 of {filteredTasks.length} tasks. Export to see all.</div>}
            </div>
          </div>
        )}
        
        {/* ==================== TIMESHEET REPORT ==================== */}
        {activeReportTab === 'timesheetReport' && (
          <TimesheetReportsView />
        )}
        
        {/* ==================== EMPLOYEE REPORT ==================== */}
        {activeReportTab === 'employeeReport' && (
          <div>
            {/* Employee Performance Dashboard */}
            {!reportFilters.staff && (
              <>
                {/* Top KPI Cards */}
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '20px'}}>
                  {(() => {
                    const staffStats = data.staff.filter(s => s.status === 'Active').map(staff => {
                      const tasks = allTasks.filter(t => t.primaryAssignedUser === staff.name || t.assignedTo === staff.name);
                      const completed = tasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                      const pending = tasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                      const overdue = tasks.filter(t => {
                        if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                        return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                      }).length;
                      const billedTasks = tasks.filter(t => t.billed);
                      const taskBilling = billedTasks.reduce((sum, t) => {
                        const inv = (data.invoices || []).find(i => i.taskIds?.includes(t.id));
                        return sum + (inv ? (parseFloat(inv.totalAmount) || 0) / (inv.taskIds?.length || 1) : 0);
                      }, 0);
                      return { ...staff, tasks: tasks.length, completed, pending, overdue, completionRate: tasks.length > 0 ? (completed / tasks.length) * 100 : 0, billing: taskBilling };
                    }).filter(s => s.tasks > 0);
                    
                    const bestPerformer = [...staffStats].sort((a, b) => b.completionRate - a.completionRate)[0];
                    const lowPerformer = [...staffStats].sort((a, b) => a.completionRate - b.completionRate)[0];
                    const mostTasks = [...staffStats].sort((a, b) => b.tasks - a.tasks)[0];
                    const mostOverdue = [...staffStats].sort((a, b) => b.overdue - a.overdue)[0];
                    const topBiller = [...staffStats].sort((a, b) => b.billing - a.billing)[0];
                    
                    return (
                      <>
                        <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0'}}>
                          <div style={{fontSize: '11px', color: '#16a34a', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ† Best Performer</div>
                          <div style={{fontSize: '18px', fontWeight: '700', color: '#166534'}}>{bestPerformer?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#16a34a', marginTop: '4px'}}>{Math.round(bestPerformer?.completionRate || 0)}% completion</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca'}}>
                          <div style={{fontSize: '11px', color: '#dc2626', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>âš ï¸ Needs Attention</div>
                          <div style={{fontSize: '18px', fontWeight: '700', color: '#b91c1c'}}>{lowPerformer?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#dc2626', marginTop: '4px'}}>{Math.round(lowPerformer?.completionRate || 0)}% completion</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe'}}>
                          <div style={{fontSize: '11px', color: '#3b82f6', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ“‹ Most Tasks</div>
                          <div style={{fontSize: '18px', fontWeight: '700', color: '#1e40af'}}>{mostTasks?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#3b82f6', marginTop: '4px'}}>{mostTasks?.tasks || 0} tasks</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a'}}>
                          <div style={{fontSize: '11px', color: '#d97706', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ”´ Most Overdue</div>
                          <div style={{fontSize: '18px', fontWeight: '700', color: '#b45309'}}>{mostOverdue?.overdue > 0 ? mostOverdue?.name : 'None'}</div>
                          <div style={{fontSize: '12px', color: '#d97706', marginTop: '4px'}}>{mostOverdue?.overdue || 0} overdue</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff'}}>
                          <div style={{fontSize: '11px', color: '#9333ea', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ’° Top Biller</div>
                          <div style={{fontSize: '18px', fontWeight: '700', color: '#7c3aed'}}>{topBiller?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#9333ea', marginTop: '4px'}}>â‚¹{Math.round(topBiller?.billing || 0).toLocaleString('en-IN')}</div>
                        </div>
                      </>
                    );
                  })()}
                </div>
                
                {/* Staff Performance Charts & Table */}
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                  {/* Completion Rate Chart */}
                  <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                    <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ“Š Completion Rate by Staff</h3>
                    {data.staff.filter(s => s.status === 'Active').slice(0, 8).map(staff => {
                      const tasks = allTasks.filter(t => t.primaryAssignedUser === staff.name || t.assignedTo === staff.name);
                      const completed = tasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                      const rate = tasks.length > 0 ? (completed / tasks.length) * 100 : 0;
                      return (
                        <div key={staff.id} style={{marginBottom: '12px'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                            <span style={{fontSize: '12px', color: '#64748b'}}>{staff.name.split(' ')[0]}</span>
                            <span style={{fontSize: '12px', fontWeight: '600'}}>{Math.round(rate)}%</span>
                          </div>
                          <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                            <div style={{height: '100%', width: `${rate}%`, background: rate >= 80 ? '#10b981' : rate >= 50 ? '#f59e0b' : '#ef4444', borderRadius: '4px'}}></div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Workload Distribution */}
                  <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                    <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ“ˆ Workload Distribution</h3>
                    {data.staff.filter(s => s.status === 'Active').slice(0, 8).map(staff => {
                      const tasks = allTasks.filter(t => t.primaryAssignedUser === staff.name || t.assignedTo === staff.name);
                      const completed = tasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                      const pending = tasks.length - completed;
                      const maxTasks = Math.max(...data.staff.filter(s => s.status === 'Active').map(s => allTasks.filter(t => t.primaryAssignedUser === s.name || t.assignedTo === s.name).length), 1);
                      return (
                        <div key={staff.id} style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px'}}>
                          <div style={{width: '60px', fontSize: '11px', color: '#64748b'}}>{staff.name.split(' ')[0]}</div>
                          <div style={{flex: 1, display: 'flex', height: '20px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                            <div style={{width: `${(completed / maxTasks) * 100}%`, background: '#10b981'}} title={`Completed: ${completed}`}></div>
                            <div style={{width: `${(pending / maxTasks) * 100}%`, background: '#f59e0b'}} title={`Pending: ${pending}`}></div>
                          </div>
                          <div style={{width: '40px', fontSize: '11px', fontWeight: '600', textAlign: 'right'}}>{tasks.length}</div>
                        </div>
                      );
                    })}
                    <div style={{display: 'flex', gap: '16px', marginTop: '12px', fontSize: '11px'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}><div style={{width: '12px', height: '12px', background: '#10b981', borderRadius: '2px'}}></div> Completed</div>
                      <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}><div style={{width: '12px', height: '12px', background: '#f59e0b', borderRadius: '2px'}}></div> Pending</div>
                    </div>
                  </div>
                </div>
                
                {/* All Staff Performance Table */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                  <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ‘¥ All Staff Performance</h3>
                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                    <thead>
                      <tr style={{background: '#f8fafc'}}>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Employee</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Role</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Total</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Completed</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Pending</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Overdue</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Rate</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {data.staff.filter(s => s.status === 'Active').map(staff => {
                        const tasks = allTasks.filter(t => t.primaryAssignedUser === staff.name || t.assignedTo === staff.name);
                        const completed = tasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                        const pending = tasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                        const overdue = tasks.filter(t => {
                          if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                          return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                        }).length;
                        const rate = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
                        return (
                          <tr key={staff.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                            <td style={{padding: '12px', fontWeight: '500'}}>{staff.name}</td>
                            <td style={{padding: '12px', color: '#64748b'}}>{staff.role}</td>
                            <td style={{padding: '12px', textAlign: 'center', fontWeight: '600'}}>{tasks.length}</td>
                            <td style={{padding: '12px', textAlign: 'center', color: '#10b981', fontWeight: '600'}}>{completed}</td>
                            <td style={{padding: '12px', textAlign: 'center', color: '#f59e0b', fontWeight: '600'}}>{pending}</td>
                            <td style={{padding: '12px', textAlign: 'center', color: overdue > 0 ? '#ef4444' : '#94a3b8', fontWeight: '600'}}>{overdue}</td>
                            <td style={{padding: '12px', textAlign: 'center'}}>
                              <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '11px', fontWeight: '600', background: rate >= 80 ? '#dcfce7' : rate >= 50 ? '#fef3c7' : '#fee2e2', color: rate >= 80 ? '#166534' : rate >= 50 ? '#92400e' : '#dc2626'}}>{rate}%</span>
                            </td>
                            <td style={{padding: '12px', textAlign: 'center'}}>
                              <button onClick={() => setReportFilters({...reportFilters, staff: staff.name})} style={{padding: '6px 12px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px'}}>View Tasks</button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </>
            )}
            
            {/* Individual Staff Task View */}
            {reportFilters.staff && (
              <>
                {/* Filters Bar */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                      <button onClick={() => setReportFilters({...reportFilters, staff: ''})} style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px'}}>â† Back to Dashboard</button>
                      <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>ðŸ‘¤ {reportFilters.staff}'s Tasks</h3>
                    </div>
                    <button onClick={() => {
                      const staffTasks = allTasks.filter(t => t.primaryAssignedUser === reportFilters.staff || t.assignedTo === reportFilters.staff);
                      exportToCSV(staffTasks.map(t => ({
                        client: t.clientName || t.client,
                        parentTask: t.parentTask,
                        childTask: t.childTask,
                        status: t.status === 'Completed' || t.completedCheck ? 'Completed' : t.status || 'Open',
                        startDate: t.startDate,
                        dueDate: t.dueDate,
                        financialYear: t.financialYear
                      })), `${reportFilters.staff}_tasks`, ['client', 'parentTask', 'childTask', 'status', 'startDate', 'dueDate', 'financialYear']);
                    }} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>ðŸ“¥ Export CSV</button>
                  </div>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px'}}>
                    <div>
                      <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Task Category</label>
                      <select value={reportFilters.parentTask} onChange={(e) => setReportFilters({...reportFilters, parentTask: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                        <option value="">All Categories</option>
                        {uniqueParentTasks.map(p => <option key={p} value={p}>{p}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Status</label>
                      <select value={reportFilters.status} onChange={(e) => setReportFilters({...reportFilters, status: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                        <option value="">All Status</option>
                        <option value="Completed">Completed</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Overdue">Overdue</option>
                      </select>
                    </div>
                    <div>
                      <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Financial Year</label>
                      <select value={reportFilters.financialYear} onChange={(e) => setReportFilters({...reportFilters, financialYear: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                        <option value="">All FY</option>
                        {uniqueFYs.map(fy => <option key={fy} value={fy}>{fy}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Client</label>
                      <select value={reportFilters.client} onChange={(e) => setReportFilters({...reportFilters, client: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                        <option value="">All Clients</option>
                        {uniqueClients.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>
                  </div>
                </div>
                
                {/* Staff Summary Cards */}
                {(() => {
                  let staffTasks = allTasks.filter(t => t.primaryAssignedUser === reportFilters.staff || t.assignedTo === reportFilters.staff);
                  if (reportFilters.parentTask) staffTasks = staffTasks.filter(t => t.parentTask === reportFilters.parentTask);
                  if (reportFilters.financialYear) staffTasks = staffTasks.filter(t => t.financialYear === reportFilters.financialYear);
                  if (reportFilters.client) staffTasks = staffTasks.filter(t => (t.clientName || t.client || '').toLowerCase().includes(reportFilters.client.toLowerCase()));
                  if (reportFilters.status === 'Completed') staffTasks = staffTasks.filter(t => t.status === 'Completed' || t.completedCheck);
                  if (reportFilters.status === 'Pending') staffTasks = staffTasks.filter(t => t.status !== 'Completed' && !t.completedCheck && t.status !== 'In Progress');
                  if (reportFilters.status === 'In Progress') staffTasks = staffTasks.filter(t => t.status === 'In Progress');
                  if (reportFilters.status === 'Overdue') staffTasks = staffTasks.filter(t => {
                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                  });
                  
                  const completed = staffTasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                  const pending = staffTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                  const inProgress = staffTasks.filter(t => t.status === 'In Progress').length;
                  const overdue = staffTasks.filter(t => {
                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                  }).length;
                  
                  return (
                    <>
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '20px'}}>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '2px solid #3b82f6'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#3b82f6'}}>{staffTasks.length}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Total Tasks</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#10b981'}}>{completed}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Completed</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#f59e0b'}}>{inProgress}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>In Progress</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#64748b'}}>{pending - inProgress}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Open</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: overdue > 0 ? '2px solid #ef4444' : '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: overdue > 0 ? '#ef4444' : '#94a3b8'}}>{overdue}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Overdue</div>
                        </div>
                      </div>
                      
                      {/* Task Table */}
                      <div style={{background: '#fff', borderRadius: '12px', border: '1px solid #e2e8f0', overflow: 'hidden'}}>
                        <div style={{maxHeight: '500px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Sr.</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Category</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Type</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Start Date</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Date</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Billed</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>FY</th>
                              </tr>
                            </thead>
                            <tbody>
                              {staffTasks.map((task, idx) => {
                                const isOverdue = task.dueDate && task.status !== 'Completed' && !task.completedCheck && new Date(task.dueDate.split('-').reverse().join('-')) < today;
                                return (
                                  <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9', background: isOverdue ? '#fef2f2' : 'transparent'}}>
                                    <td style={{padding: '10px 12px'}}>{idx + 1}</td>
                                    <td style={{padding: '10px 12px', fontWeight: '500'}}>{task.clientName || task.client || '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{task.parentTask || '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{task.childTask || '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{task.startDate || '-'}</td>
                                    <td style={{padding: '10px 12px', color: isOverdue ? '#ef4444' : 'inherit', fontWeight: isOverdue ? '600' : '400'}}>{task.dueDate || '-'}</td>
                                    <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                      <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '10px', fontWeight: '600', background: task.status === 'Completed' || task.completedCheck ? '#dcfce7' : task.status === 'In Progress' ? '#fef3c7' : isOverdue ? '#fee2e2' : '#dbeafe', color: task.status === 'Completed' || task.completedCheck ? '#166534' : task.status === 'In Progress' ? '#92400e' : isOverdue ? '#dc2626' : '#1d4ed8'}}>{task.status === 'Completed' || task.completedCheck ? 'Completed' : isOverdue ? 'Overdue' : task.status || 'Open'}</span>
                                    </td>
                                    <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                      <span style={{padding: '4px 8px', borderRadius: '8px', fontSize: '10px', fontWeight: '600', background: task.billed ? '#dbeafe' : '#f1f5f9', color: task.billed ? '#1d4ed8' : '#94a3b8'}}>{task.billed ? 'â‚¹' : '-'}</span>
                                    </td>
                                    <td style={{padding: '10px 12px'}}>{task.financialYear || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        {staffTasks.length === 0 && <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>No tasks found matching the filters</div>}
                      </div>
                    </>
                  );
                })()}
              </>
            )}
          </div>
        )}
        
        {/* ==================== DEBTORS REPORT ==================== */}
        {activeReportTab === 'debtorsReport' && (
          <div>
            {/* Debtors Dashboard */}
            {(() => {
              // Calculate all debtors metrics
              const debtorsData = data.clients.filter(c => !c.disabled).map(client => {
                const clientInvoices = (data.invoices || []).filter(inv => inv.clientId === client.id || inv.clientName === client.name);
                const clientReceipts = (data.receipts || []).filter(r => r.clientId === client.id || r.clientName === client.name);
                const totalInvoiced = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                const totalReceived = clientReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                const openingBal = parseFloat(client.openingBalance) || 0;
                return {
                  ...client,
                  totalInvoiced,
                  totalReceived,
                  outstanding: openingBal + totalInvoiced - totalReceived,
                  collectionRate: totalInvoiced > 0 ? (totalReceived / (openingBal + totalInvoiced)) * 100 : 0
                };
              }).filter(c => c.totalInvoiced > 0 || c.outstanding > 0);
              
              const topBilledClients = [...debtorsData].sort((a, b) => b.totalInvoiced - a.totalInvoiced).slice(0, 5);
              const topReceiptClients = [...debtorsData].sort((a, b) => b.totalReceived - a.totalReceived).slice(0, 5);
              const topOutstandingClients = [...debtorsData].sort((a, b) => b.outstanding - a.outstanding).slice(0, 5);
              const zeroOutstanding = debtorsData.filter(c => c.outstanding <= 0).length;
              const highOutstanding = debtorsData.filter(c => c.outstanding > 50000).length;
              
              return (
                <>
                  {/* Top KPI Cards */}
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '20px'}}>
                    <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe'}}>
                      <div style={{fontSize: '11px', color: '#3b82f6', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ’° Top Billed Client</div>
                      <div style={{fontSize: '16px', fontWeight: '700', color: '#1e40af'}}>{topBilledClients[0]?.name || '-'}</div>
                      <div style={{fontSize: '12px', color: '#3b82f6', marginTop: '4px'}}>â‚¹{Math.round(topBilledClients[0]?.totalInvoiced || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0'}}>
                      <div style={{fontSize: '11px', color: '#16a34a', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ† Top Receipt</div>
                      <div style={{fontSize: '16px', fontWeight: '700', color: '#166534'}}>{topReceiptClients[0]?.name || '-'}</div>
                      <div style={{fontSize: '12px', color: '#16a34a', marginTop: '4px'}}>â‚¹{Math.round(topReceiptClients[0]?.totalReceived || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca'}}>
                      <div style={{fontSize: '11px', color: '#dc2626', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>âš ï¸ Top Outstanding</div>
                      <div style={{fontSize: '16px', fontWeight: '700', color: '#b91c1c'}}>{topOutstandingClients[0]?.name || '-'}</div>
                      <div style={{fontSize: '12px', color: '#dc2626', marginTop: '4px'}}>â‚¹{Math.round(topOutstandingClients[0]?.outstanding || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff'}}>
                      <div style={{fontSize: '11px', color: '#9333ea', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>âœ… Zero Balance</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#7c3aed'}}>{zeroOutstanding}</div>
                      <div style={{fontSize: '12px', color: '#9333ea', marginTop: '4px'}}>Clients cleared</div>
                    </div>
                    <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a'}}>
                      <div style={{fontSize: '11px', color: '#d97706', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ”´ High Outstanding</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#b45309'}}>{highOutstanding}</div>
                      <div style={{fontSize: '12px', color: '#d97706', marginTop: '4px'}}>Above â‚¹50K</div>
                    </div>
                  </div>
                  
                  {/* Summary Row */}
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '16px', marginBottom: '20px'}}>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Opening Balance</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#8b5cf6'}}>â‚¹{data.clients.reduce((sum, c) => sum + (parseFloat(c.openingBalance) || 0), 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Total Invoiced</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#3b82f6'}}>â‚¹{totalBilled.toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Total Received</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>â‚¹{totalCollected.toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>TDS Deducted</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#f59e0b'}}>â‚¹{(data.receipts || []).filter(r => r.mode === 'TDS' || r.paymentMode === 'TDS').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Discount Given</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#ec4899'}}>â‚¹{(data.receipts || []).filter(r => r.mode === 'Discount' || r.paymentMode === 'Discount').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: totalOutstanding > 0 ? '2px solid #ef4444' : '1px solid #e2e8f0'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Total Outstanding</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#ef4444'}}>â‚¹{totalOutstanding.toLocaleString('en-IN')}</div>
                    </div>
                  </div>
                  
                  {/* Charts Row */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                    {/* Top Billed Clients Chart */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ“Š Top 5 Billed Clients</h3>
                      {topBilledClients.map((client, idx) => {
                        const maxVal = topBilledClients[0]?.totalInvoiced || 1;
                        return (
                          <div key={client.id} style={{marginBottom: '12px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                              <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 15)}</span>
                              <span style={{fontSize: '11px', fontWeight: '600'}}>â‚¹{client.totalInvoiced.toLocaleString('en-IN')}</span>
                            </div>
                            <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                              <div style={{height: '100%', width: `${(client.totalInvoiced / maxVal) * 100}%`, background: '#3b82f6', borderRadius: '4px'}}></div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    
                    {/* Top Receipt Clients Chart */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ’š Top 5 Collections</h3>
                      {topReceiptClients.map((client, idx) => {
                        const maxVal = topReceiptClients[0]?.totalReceived || 1;
                        return (
                          <div key={client.id} style={{marginBottom: '12px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                              <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 15)}</span>
                              <span style={{fontSize: '11px', fontWeight: '600'}}>â‚¹{client.totalReceived.toLocaleString('en-IN')}</span>
                            </div>
                            <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                              <div style={{height: '100%', width: `${(client.totalReceived / maxVal) * 100}%`, background: '#10b981', borderRadius: '4px'}}></div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    
                    {/* Top Outstanding Clients Chart */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ”´ Top 5 Outstanding</h3>
                      {topOutstandingClients.map((client, idx) => {
                        const maxVal = topOutstandingClients[0]?.outstanding || 1;
                        return (
                          <div key={client.id} style={{marginBottom: '12px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                              <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 15)}</span>
                              <span style={{fontSize: '11px', fontWeight: '600', color: '#ef4444'}}>â‚¹{client.outstanding.toLocaleString('en-IN')}</span>
                            </div>
                            <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                              <div style={{height: '100%', width: `${(client.outstanding / maxVal) * 100}%`, background: '#ef4444', borderRadius: '4px'}}></div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </>
              );
            })()}
            
            {/* Filters */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>ðŸ“‹ Debtors Ledger</h3>
                <button onClick={() => {
                  const debtorsData = data.clients.filter(c => !c.disabled).map(client => {
                    const clientInvoices = (data.invoices || []).filter(inv => inv.clientId === client.id || inv.clientName === client.name);
                    const clientReceipts = (data.receipts || []).filter(r => r.clientId === client.id || r.clientName === client.name);
                    const totalInvoiced = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                    const cashReceipts = clientReceipts.filter(r => r.mode === 'Cash' || r.paymentMode === 'Cash').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    const bankReceipts = clientReceipts.filter(r => r.mode === 'Bank' || r.paymentMode === 'Bank' || r.mode === 'NEFT' || r.mode === 'RTGS').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    const tdsDeducted = clientReceipts.filter(r => r.mode === 'TDS' || r.paymentMode === 'TDS').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    const discount = clientReceipts.filter(r => r.mode === 'Discount' || r.paymentMode === 'Discount').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    const totalReceived = clientReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    return {
                      clientName: client.name,
                      clientCode: client.fileNo,
                      openingBalance: client.openingBalance || 0,
                      totalInvoiced,
                      cashReceipts,
                      bankReceipts,
                      tdsDeducted,
                      discount,
                      totalReceived,
                      outstanding: (client.openingBalance || 0) + totalInvoiced - totalReceived
                    };
                  }).filter(d => d.totalInvoiced > 0 || d.openingBalance > 0);
                  exportToCSV(debtorsData, 'debtors_report', ['clientName', 'clientCode', 'openingBalance', 'totalInvoiced', 'cashReceipts', 'bankReceipts', 'tdsDeducted', 'discount', 'totalReceived', 'outstanding']);
                }} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>ðŸ“¥ Export CSV</button>
              </div>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px'}}>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Client</label>
                  <select value={reportFilters.client} onChange={(e) => setReportFilters({...reportFilters, client: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Clients</option>
                    {data.clients.filter(c => !c.disabled).sort((a, b) => a.name.localeCompare(b.name)).map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>As on Date</label>
                  <input type="date" value={reportFilters.dateTo || new Date().toISOString().split('T')[0]} onChange={(e) => setReportFilters({...reportFilters, dateTo: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Show Only</label>
                  <select value={reportFilters.debtorFilter || ''} onChange={(e) => setReportFilters({...reportFilters, debtorFilter: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Clients</option>
                    <option value="outstanding">With Outstanding</option>
                    <option value="nil">Nil Balance</option>
                    <option value="high">High Outstanding (&gt;â‚¹50K)</option>
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Client Group</label>
                  <select value={reportFilters.clientGroup || ''} onChange={(e) => setReportFilters({...reportFilters, clientGroup: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="">All Groups</option>
                    {[...new Set(data.clients.map(c => c.groupName))].filter(Boolean).sort().map(g => <option key={g} value={g}>{g}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Sort By</label>
                  <select value={reportFilters.sortBy || 'name'} onChange={(e) => setReportFilters({...reportFilters, sortBy: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                    <option value="name">Client Name</option>
                    <option value="outstanding-desc">Outstanding (High to Low)</option>
                    <option value="outstanding-asc">Outstanding (Low to High)</option>
                    <option value="billed-desc">Billed (High to Low)</option>
                    <option value="received-desc">Received (High to Low)</option>
                  </select>
                </div>
              </div>
            </div>
            
            {/* Debtors Table */}
            <div style={{background: '#fff', borderRadius: '12px', border: '1px solid #e2e8f0', overflow: 'hidden'}}>
              <div style={{maxHeight: '500px', overflowY: 'auto'}}>
                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                  <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                    <tr>
                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Opening Bal.</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Invoices</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Cash</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Bank</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>TDS</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Discount</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Total Recd.</th>
                      <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Outstanding</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(() => {
                      // Filter clients - if specific client selected, match exact name
                      let filteredClients = data.clients.filter(c => {
                        if (c.disabled) return false;
                        if (reportFilters.client && c.name !== reportFilters.client) return false;
                        if (reportFilters.clientGroup && c.groupName !== reportFilters.clientGroup) return false;
                        return true;
                      });
                      
                      const results = filteredClients.map(client => {
                        const asOnDate = reportFilters.dateTo ? new Date(reportFilters.dateTo) : new Date();
                        asOnDate.setHours(23, 59, 59, 999); // Include the entire day
                        
                        const clientInvoices = (data.invoices || []).filter(inv => {
                          if (inv.clientId !== client.id && inv.clientName !== client.name) return false;
                          if (!inv.date) return true; // Include if no date
                          const invDate = new Date(inv.date);
                          return invDate <= asOnDate;
                        });
                        const clientReceipts = (data.receipts || []).filter(r => {
                          if (r.clientId !== client.id && r.clientName !== client.name) return false;
                          if (!r.date) return true; // Include if no date
                          const rDate = new Date(r.date);
                          return rDate <= asOnDate;
                        });
                        
                        const totalInvoiced = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                        const cashReceipts = clientReceipts.filter(r => r.mode === 'Cash' || r.paymentMode === 'Cash').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const bankReceipts = clientReceipts.filter(r => {
                          const mode = r.mode || r.paymentMode || '';
                          return mode === 'Bank' || mode === 'NEFT' || mode === 'RTGS' || mode === 'Cheque' || mode === 'UPI' || (!mode && mode !== 'TDS' && mode !== 'Discount' && mode !== 'Cash');
                        }).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const tdsDeducted = clientReceipts.filter(r => (r.mode || r.paymentMode) === 'TDS').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const discount = clientReceipts.filter(r => (r.mode || r.paymentMode) === 'Discount').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const totalReceived = clientReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const openingBal = parseFloat(client.openingBalance) || 0;
                        const outstanding = openingBal + totalInvoiced - totalReceived;
                        
                        return { client, openingBal, totalInvoiced, cashReceipts, bankReceipts, tdsDeducted, discount, totalReceived, outstanding };
                      }).filter(row => {
                        // Filter based on debtorFilter
                        if (reportFilters.debtorFilter === 'outstanding' && row.outstanding <= 0) return false;
                        if (reportFilters.debtorFilter === 'nil' && row.outstanding !== 0) return false;
                        if (reportFilters.debtorFilter === 'high' && row.outstanding <= 50000) return false;
                        // Show clients with invoices OR opening balance OR if specific client selected
                        if (reportFilters.client) return true; // Always show selected client
                        return row.totalInvoiced > 0 || row.openingBal > 0;
                      });
                      
                      // Sort results
                      results.sort((a, b) => {
                        if (reportFilters.sortBy === 'outstanding-desc') return b.outstanding - a.outstanding;
                        if (reportFilters.sortBy === 'outstanding-asc') return a.outstanding - b.outstanding;
                        if (reportFilters.sortBy === 'billed-desc') return b.totalInvoiced - a.totalInvoiced;
                        if (reportFilters.sortBy === 'received-desc') return b.totalReceived - a.totalReceived;
                        return a.client.name.localeCompare(b.client.name);
                      });
                      
                      if (results.length === 0) {
                        return <tr><td colSpan="9" style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>No debtors found{reportFilters.client ? ` for "${reportFilters.client}"` : ''}</td></tr>;
                      }
                      
                      return results.map(row => (
                        <tr key={row.client.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                          <td style={{padding: '10px 12px', fontWeight: '500'}}>{row.client.name}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right'}}>{row.openingBal > 0 ? `â‚¹${row.openingBal.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', color: '#3b82f6'}}>{row.totalInvoiced > 0 ? `â‚¹${row.totalInvoiced.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', color: '#10b981'}}>{row.cashReceipts > 0 ? `â‚¹${row.cashReceipts.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', color: '#10b981'}}>{row.bankReceipts > 0 ? `â‚¹${row.bankReceipts.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', color: '#f59e0b'}}>{row.tdsDeducted > 0 ? `â‚¹${row.tdsDeducted.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', color: '#8b5cf6'}}>{row.discount > 0 ? `â‚¹${row.discount.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '500', color: '#10b981'}}>{row.totalReceived > 0 ? `â‚¹${row.totalReceived.toLocaleString('en-IN')}` : '-'}</td>
                          <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: row.outstanding > 0 ? '#ef4444' : '#10b981'}}>{row.outstanding !== 0 ? `â‚¹${row.outstanding.toLocaleString('en-IN')}` : '-'}</td>
                        </tr>
                      ));
                    })()}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}
        
        {/* ==================== CLIENT REPORT ==================== */}
        {activeReportTab === 'clientReport' && (
          <div>
            {/* Client Dashboard - Show when no specific client selected */}
            {!reportFilters.client && (
              <>
                {/* Dashboard KPIs */}
                {(() => {
                  const clientStats = data.clients.filter(c => !c.disabled).map(client => {
                    const tasks = allTasks.filter(t => t.clientId === client.id || t.clientName === client.name || t.client === client.name);
                    const invoices = (data.invoices || []).filter(inv => inv.clientId === client.id || inv.clientName === client.name);
                    const receipts = (data.receipts || []).filter(r => r.clientId === client.id || r.clientName === client.name);
                    const totalBilled = invoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                    const totalReceived = receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                    return {
                      ...client,
                      tasks: tasks.length,
                      completed: tasks.filter(t => t.status === 'Completed' || t.completedCheck).length,
                      pending: tasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length,
                      totalBilled,
                      totalReceived,
                      outstanding: totalBilled - totalReceived
                    };
                  });
                  
                  const topTaskClients = [...clientStats].sort((a, b) => b.tasks - a.tasks).slice(0, 5);
                  const topBilledClients = [...clientStats].sort((a, b) => b.totalBilled - a.totalBilled).slice(0, 5);
                  const topOutstandingClients = [...clientStats].sort((a, b) => b.outstanding - a.outstanding).slice(0, 5);
                  const clientsWithTasks = clientStats.filter(c => c.tasks > 0).length;
                  const activeClients = clientStats.length;
                  
                  return (
                    <>
                      {/* Top KPI Cards */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '20px'}}>
                        <div style={{background: 'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bfdbfe'}}>
                          <div style={{fontSize: '11px', color: '#3b82f6', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ† Most Tasks</div>
                          <div style={{fontSize: '16px', fontWeight: '700', color: '#1e40af'}}>{topTaskClients[0]?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#3b82f6', marginTop: '4px'}}>{topTaskClients[0]?.tasks || 0} tasks</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #bbf7d0'}}>
                          <div style={{fontSize: '11px', color: '#16a34a', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ’° Highest Billed</div>
                          <div style={{fontSize: '16px', fontWeight: '700', color: '#166534'}}>{topBilledClients[0]?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#16a34a', marginTop: '4px'}}>â‚¹{Math.round(topBilledClients[0]?.totalBilled || 0).toLocaleString('en-IN')}</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fecaca'}}>
                          <div style={{fontSize: '11px', color: '#dc2626', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>âš ï¸ Top Outstanding</div>
                          <div style={{fontSize: '16px', fontWeight: '700', color: '#b91c1c'}}>{topOutstandingClients[0]?.name || '-'}</div>
                          <div style={{fontSize: '12px', color: '#dc2626', marginTop: '4px'}}>â‚¹{Math.round(topOutstandingClients[0]?.outstanding || 0).toLocaleString('en-IN')}</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #e9d5ff'}}>
                          <div style={{fontSize: '11px', color: '#9333ea', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ‘¥ Active Clients</div>
                          <div style={{fontSize: '24px', fontWeight: '700', color: '#7c3aed'}}>{activeClients}</div>
                          <div style={{fontSize: '12px', color: '#9333ea', marginTop: '4px'}}>{clientsWithTasks} with tasks</div>
                        </div>
                        <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%)', borderRadius: '12px', padding: '20px', border: '1px solid #fde68a'}}>
                          <div style={{fontSize: '11px', color: '#d97706', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px'}}>ðŸ“Š Avg Tasks/Client</div>
                          <div style={{fontSize: '24px', fontWeight: '700', color: '#b45309'}}>{activeClients > 0 ? Math.round(allTasks.length / activeClients * 10) / 10 : 0}</div>
                          <div style={{fontSize: '12px', color: '#d97706', marginTop: '4px'}}>{allTasks.length} total tasks</div>
                        </div>
                      </div>
                      
                      {/* Charts Row */}
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                        {/* Top Clients by Tasks */}
                        <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                          <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ“‹ Top Clients by Tasks</h3>
                          {topTaskClients.map((client, idx) => {
                            const maxVal = topTaskClients[0]?.tasks || 1;
                            return (
                              <div key={client.id} style={{marginBottom: '12px', cursor: 'pointer'}} onClick={() => setReportFilters({...reportFilters, client: client.name})}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                  <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 18)}</span>
                                  <span style={{fontSize: '11px', fontWeight: '600'}}>{client.tasks}</span>
                                </div>
                                <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                                  <div style={{height: '100%', width: `${(client.tasks / maxVal) * 100}%`, background: '#3b82f6', borderRadius: '4px'}}></div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        
                        {/* Top Clients by Billing */}
                        <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                          <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ’° Top Clients by Billing</h3>
                          {topBilledClients.map((client, idx) => {
                            const maxVal = topBilledClients[0]?.totalBilled || 1;
                            return (
                              <div key={client.id} style={{marginBottom: '12px', cursor: 'pointer'}} onClick={() => setReportFilters({...reportFilters, client: client.name})}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                  <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 18)}</span>
                                  <span style={{fontSize: '11px', fontWeight: '600'}}>â‚¹{client.totalBilled.toLocaleString('en-IN')}</span>
                                </div>
                                <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                                  <div style={{height: '100%', width: `${(client.totalBilled / maxVal) * 100}%`, background: '#10b981', borderRadius: '4px'}}></div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        
                        {/* Top Clients by Outstanding */}
                        <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                          <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ”´ Top Outstanding</h3>
                          {topOutstandingClients.filter(c => c.outstanding > 0).map((client, idx) => {
                            const maxVal = topOutstandingClients[0]?.outstanding || 1;
                            return (
                              <div key={client.id} style={{marginBottom: '12px', cursor: 'pointer'}} onClick={() => setReportFilters({...reportFilters, client: client.name})}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                  <span style={{fontSize: '11px', color: '#64748b'}}>{client.name?.substring(0, 18)}</span>
                                  <span style={{fontSize: '11px', fontWeight: '600', color: '#ef4444'}}>â‚¹{client.outstanding.toLocaleString('en-IN')}</span>
                                </div>
                                <div style={{height: '8px', background: '#f1f5f9', borderRadius: '4px', overflow: 'hidden'}}>
                                  <div style={{height: '100%', width: `${(client.outstanding / maxVal) * 100}%`, background: '#ef4444', borderRadius: '4px'}}></div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </>
                  );
                })()}
                
                {/* Client Selection Table */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #e2e8f0'}}>
                  <h3 style={{margin: '0 0 16px', fontSize: '14px', fontWeight: '600'}}>ðŸ¢ Select Client for Detailed View</h3>
                  <div style={{marginBottom: '16px'}}>
                    <input 
                      type="text" 
                      placeholder="Search clients..." 
                      value={reportFilters.clientSearch || ''} 
                      onChange={(e) => setReportFilters({...reportFilters, clientSearch: e.target.value})} 
                      style={{width: '300px', padding: '10px 16px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}} 
                    />
                  </div>
                  <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                      <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                        <tr>
                          <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Tasks</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Done</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Pending</th>
                          <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Billed</th>
                          <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Outstanding</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.clients.filter(c => !c.disabled && (!reportFilters.clientSearch || c.name.toLowerCase().includes(reportFilters.clientSearch.toLowerCase()))).map(client => {
                          const tasks = allTasks.filter(t => t.clientId === client.id || t.clientName === client.name || t.client === client.name);
                          const completed = tasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                          const pending = tasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                          const invoices = (data.invoices || []).filter(inv => inv.clientId === client.id || inv.clientName === client.name);
                          const receipts = (data.receipts || []).filter(r => r.clientId === client.id || r.clientName === client.name);
                          const totalBilled = invoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                          const totalReceived = receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                          return (
                            <tr key={client.id} style={{borderBottom: '1px solid #f1f5f9', cursor: 'pointer'}} onClick={() => setReportFilters({...reportFilters, client: client.name})}>
                              <td style={{padding: '12px', fontWeight: '500'}}>{client.name}</td>
                              <td style={{padding: '12px', textAlign: 'center'}}>{tasks.length}</td>
                              <td style={{padding: '12px', textAlign: 'center', color: '#10b981', fontWeight: '600'}}>{completed}</td>
                              <td style={{padding: '12px', textAlign: 'center', color: '#f59e0b', fontWeight: '600'}}>{pending}</td>
                              <td style={{padding: '12px', textAlign: 'right'}}>â‚¹{totalBilled.toLocaleString('en-IN')}</td>
                              <td style={{padding: '12px', textAlign: 'right', color: totalBilled - totalReceived > 0 ? '#ef4444' : '#10b981', fontWeight: '600'}}>â‚¹{(totalBilled - totalReceived).toLocaleString('en-IN')}</td>
                              <td style={{padding: '12px', textAlign: 'center'}}>
                                <button style={{padding: '6px 12px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px'}}>View</button>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            )}
            
            {/* Detailed Client View - Show when specific client selected */}
            {reportFilters.client && (
              <>
                {(() => {
                  const client = data.clients.find(c => c.name === reportFilters.client || c.name.toLowerCase().includes(reportFilters.client.toLowerCase()));
                  if (!client) return <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>Client not found</div>;
                  
                  let clientTasks = allTasks.filter(t => t.clientId === client.id || t.clientName === client.name || t.client === client.name);
                  if (reportFilters.parentTask) clientTasks = clientTasks.filter(t => t.parentTask === reportFilters.parentTask);
                  if (reportFilters.financialYear) clientTasks = clientTasks.filter(t => t.financialYear === reportFilters.financialYear);
                  if (reportFilters.status === 'Completed') clientTasks = clientTasks.filter(t => t.status === 'Completed' || t.completedCheck);
                  if (reportFilters.status === 'Pending') clientTasks = clientTasks.filter(t => t.status !== 'Completed' && !t.completedCheck);
                  
                  const completed = clientTasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                  const pending = clientTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                  const overdue = clientTasks.filter(t => {
                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                  }).length;
                  const clientInvoices = (data.invoices || []).filter(inv => inv.clientId === client.id || inv.clientName === client.name);
                  const clientReceipts = (data.receipts || []).filter(r => r.clientId === client.id || r.clientName === client.name);
                  const totalBilled = clientInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                  const totalReceived = clientReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                  
                  return (
                    <>
                      {/* Header with Back Button */}
                      <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                          <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                            <button onClick={() => setReportFilters({...reportFilters, client: '', parentTask: '', status: '', financialYear: ''})} style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>â† Back to Dashboard</button>
                            <div>
                              <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>{client.name}</h3>
                              <div style={{fontSize: '12px', color: '#64748b'}}>{client.fileNo || 'No Code'} â€¢ Group {client.fileNo ? client.fileNo.split('.')[0] : 'N/A'}</div>
                            </div>
                          </div>
                          <button onClick={() => {
                            exportToCSV(clientTasks.map(t => ({
                              category: t.parentTask,
                              task: t.childTask,
                              assignedTo: t.primaryAssignedUser || t.assignedTo,
                              startDate: t.startDate,
                              dueDate: t.dueDate,
                              status: t.status === 'Completed' || t.completedCheck ? 'Completed' : t.status || 'Open',
                              billed: t.billed ? 'Yes' : 'No',
                              financialYear: t.financialYear
                            })), `${client.name}_tasks`, ['category', 'task', 'assignedTo', 'startDate', 'dueDate', 'status', 'billed', 'financialYear']);
                          }} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>ðŸ“¥ Export Tasks</button>
                        </div>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px'}}>
                          <div>
                            <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Task Category</label>
                            <select value={reportFilters.parentTask} onChange={(e) => setReportFilters({...reportFilters, parentTask: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                              <option value="">All Categories</option>
                              {uniqueParentTasks.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Status</label>
                            <select value={reportFilters.status} onChange={(e) => setReportFilters({...reportFilters, status: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                              <option value="">All Status</option>
                              <option value="Completed">Completed</option>
                              <option value="Pending">Pending</option>
                            </select>
                          </div>
                          <div>
                            <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Financial Year</label>
                            <select value={reportFilters.financialYear} onChange={(e) => setReportFilters({...reportFilters, financialYear: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                              <option value="">All FY</option>
                              {uniqueFYs.map(fy => <option key={fy} value={fy}>{fy}</option>)}
                            </select>
                          </div>
                          <div style={{display: 'flex', alignItems: 'flex-end'}}>
                            <button onClick={() => setReportFilters({...reportFilters, parentTask: '', status: '', financialYear: ''})} style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>Clear Filters</button>
                          </div>
                        </div>
                      </div>
                      
                      {/* Client Summary Cards */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '16px', marginBottom: '20px'}}>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '2px solid #3b82f6'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#3b82f6'}}>{clientTasks.length}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Total Tasks</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#10b981'}}>{completed}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Completed</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: '#f59e0b'}}>{pending}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Pending</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: overdue > 0 ? '2px solid #ef4444' : '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '28px', fontWeight: '700', color: overdue > 0 ? '#ef4444' : '#94a3b8'}}>{overdue}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Overdue</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#3b82f6'}}>â‚¹{totalBilled.toLocaleString('en-IN')}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Billed</div>
                        </div>
                        <div style={{background: '#fff', borderRadius: '10px', padding: '16px', border: totalBilled - totalReceived > 0 ? '2px solid #ef4444' : '1px solid #e2e8f0'}}>
                          <div style={{fontSize: '20px', fontWeight: '700', color: totalBilled - totalReceived > 0 ? '#ef4444' : '#10b981'}}>â‚¹{(totalBilled - totalReceived).toLocaleString('en-IN')}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Outstanding</div>
                        </div>
                      </div>
                      
                      {/* Tasks Table */}
                      <div style={{background: '#fff', borderRadius: '12px', border: '1px solid #e2e8f0', overflow: 'hidden'}}>
                        <div style={{padding: '16px 20px', borderBottom: '1px solid #e2e8f0', background: '#f8fafc'}}>
                          <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>ðŸ“‹ All Tasks ({clientTasks.length})</h3>
                        </div>
                        <div style={{maxHeight: '500px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Sr.</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Category</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Assigned To</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Start Date</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Date</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Billed</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>FY</th>
                              </tr>
                            </thead>
                            <tbody>
                              {clientTasks.map((task, idx) => {
                                const isOverdue = task.dueDate && task.status !== 'Completed' && !task.completedCheck && new Date(task.dueDate.split('-').reverse().join('-')) < today;
                                return (
                                  <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9', background: isOverdue ? '#fef2f2' : 'transparent'}}>
                                    <td style={{padding: '10px 12px'}}>{idx + 1}</td>
                                    <td style={{padding: '10px 12px'}}>{task.parentTask || '-'}</td>
                                    <td style={{padding: '10px 12px', fontWeight: '500'}}>{task.childTask || '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{task.primaryAssignedUser || task.assignedTo || '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{task.startDate || '-'}</td>
                                    <td style={{padding: '10px 12px', color: isOverdue ? '#ef4444' : 'inherit', fontWeight: isOverdue ? '600' : '400'}}>{task.dueDate || '-'}</td>
                                    <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                      <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '10px', fontWeight: '600', background: task.status === 'Completed' || task.completedCheck ? '#dcfce7' : task.status === 'In Progress' ? '#fef3c7' : isOverdue ? '#fee2e2' : '#dbeafe', color: task.status === 'Completed' || task.completedCheck ? '#166534' : task.status === 'In Progress' ? '#92400e' : isOverdue ? '#dc2626' : '#1d4ed8'}}>{task.status === 'Completed' || task.completedCheck ? 'Completed' : isOverdue ? 'Overdue' : task.status || 'Open'}</span>
                                    </td>
                                    <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                      <span style={{padding: '4px 8px', borderRadius: '8px', fontSize: '10px', fontWeight: '600', background: task.billed ? '#dbeafe' : '#f1f5f9', color: task.billed ? '#1d4ed8' : '#94a3b8'}}>{task.billed ? 'â‚¹' : '-'}</span>
                                    </td>
                                    <td style={{padding: '10px 12px'}}>{task.financialYear || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        {clientTasks.length === 0 && <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>No tasks found matching the filters</div>}
                      </div>
                    </>
                  );
                })()}
              </>
            )}
          </div>
        )}
        
        {/* ==================== RM REPORT ==================== */}
        {activeReportTab === 'rmReport' && (
          <div>
            {/* Filters & Header */}
            <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                  {reportFilters.selectedRM && (
                    <button onClick={() => setReportFilters({...reportFilters, selectedRM: '', rmDetailView: ''})} style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>â† Back to All RMs</button>
                  )}
                  <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>ðŸ“ˆ {reportFilters.selectedRM || 'Reporting Manager Performance'}</h3>
                </div>
                <button onClick={() => {
                  const rmData = data.staff.filter(s => s.role === 'Reporting Manager').map(rm => {
                    const teamMembers = data.staff.filter(s => s.reportingManager === rm.id || s.reportingManager === rm.name);
                    const teamTasks = allTasks.filter(t => teamMembers.some(m => t.primaryAssignedUser === m.name || t.assignedTo === m.name) || t.taskManager === rm.name);
                    const teamClients = [...new Set(teamTasks.map(t => t.clientName || t.client))].filter(Boolean);
                    const teamInvoices = (data.invoices || []).filter(inv => teamClients.includes(inv.clientName));
                    const teamReceipts = (data.receipts || []).filter(r => teamClients.includes(r.clientName));
                    return {
                      rmName: rm.name,
                      teamSize: teamMembers.length,
                      clientsMapped: teamClients.length,
                      totalTasks: teamTasks.length,
                      completedTasks: teamTasks.filter(t => t.status === 'Completed' || t.completedCheck).length,
                      pendingTasks: teamTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length,
                      totalBilling: teamInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0),
                      totalCollection: teamReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
                    };
                  });
                  exportToCSV(rmData, 'rm_report', ['rmName', 'teamSize', 'clientsMapped', 'totalTasks', 'completedTasks', 'pendingTasks', 'totalBilling', 'totalCollection']);
                }} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>ðŸ“¥ Export CSV</button>
              </div>
              {!reportFilters.selectedRM && (
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px'}}>
                  <div>
                    <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Reporting Manager</label>
                    <select value={reportFilters.reportingManager} onChange={(e) => setReportFilters({...reportFilters, reportingManager: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                      <option value="">All Reporting Managers</option>
                      {reportingManagers.map(rm => <option key={rm} value={rm}>{rm}</option>)}
                    </select>
                  </div>
                  <div>
                    <label style={{fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px'}}>Financial Year</label>
                    <select value={reportFilters.financialYear} onChange={(e) => setReportFilters({...reportFilters, financialYear: e.target.value})} style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}>
                      <option value="">All FY</option>
                      {uniqueFYs.map(fy => <option key={fy} value={fy}>{fy}</option>)}
                    </select>
                  </div>
                </div>
              )}
            </div>
            
            {/* RM Cards - Show when no specific RM selected */}
            {!reportFilters.selectedRM && (
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px'}}>
                {data.staff.filter(s => s.role === 'Reporting Manager' && (!reportFilters.reportingManager || s.name === reportFilters.reportingManager)).map(rm => {
                  const teamMembers = data.staff.filter(s => s.reportingManager === rm.id || s.reportingManager === rm.name || (s.role === 'Seniors' || s.role === 'Articles'));
                  let teamTasks = allTasks.filter(t => 
                    teamMembers.some(m => t.primaryAssignedUser === m.name || t.assignedTo === m.name) || 
                    t.taskManager === rm.name
                  );
                  if (reportFilters.financialYear) teamTasks = teamTasks.filter(t => t.financialYear === reportFilters.financialYear);
                  
                  const teamClients = [...new Set(teamTasks.map(t => t.clientName || t.client))].filter(Boolean);
                  const completed = teamTasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                  const pending = teamTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                  const overdue = teamTasks.filter(t => {
                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                  }).length;
                  
                  const teamInvoices = (data.invoices || []).filter(inv => teamClients.includes(inv.clientName));
                  const teamReceipts = (data.receipts || []).filter(r => teamClients.includes(r.clientName));
                  const totalBilling = teamInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                  const totalCollection = teamReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                  
                  return (
                    <div key={rm.id} style={{background: '#fff', borderRadius: '12px', padding: '24px', border: '1px solid #e2e8f0'}}>
                      {/* RM Header - Clickable */}
                      <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'clients'})} style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px', paddingBottom: '16px', borderBottom: '1px solid #f1f5f9', cursor: 'pointer'}}>
                        <div style={{width: '56px', height: '56px', borderRadius: '50%', background: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', fontWeight: '600'}}>{rm.name.charAt(0)}</div>
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: '600', fontSize: '16px'}}>{rm.name}</div>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Click to view details</div>
                        </div>
                        <div style={{textAlign: 'right'}}>
                          <div style={{fontSize: '11px', color: '#64748b'}}>Team Size</div>
                          <div style={{fontSize: '20px', fontWeight: '700', color: '#3b82f6'}}>{teamMembers.length}</div>
                        </div>
                      </div>
                      
                      {/* Clickable KPI Grid */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '20px'}}>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'clients'})} style={{textAlign: 'center', padding: '12px', background: '#eff6ff', borderRadius: '10px', cursor: 'pointer', transition: 'transform 0.1s', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #3b82f6'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '22px', fontWeight: '700', color: '#3b82f6'}}>{teamClients.length}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Clients</div>
                        </div>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'completed'})} style={{textAlign: 'center', padding: '12px', background: '#f0fdf4', borderRadius: '10px', cursor: 'pointer', transition: 'transform 0.1s', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #10b981'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '22px', fontWeight: '700', color: '#10b981'}}>{completed}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Completed</div>
                        </div>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'pending'})} style={{textAlign: 'center', padding: '12px', background: '#fffbeb', borderRadius: '10px', cursor: 'pointer', transition: 'transform 0.1s', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #f59e0b'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '22px', fontWeight: '700', color: '#f59e0b'}}>{pending}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Pending</div>
                        </div>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'overdue'})} style={{textAlign: 'center', padding: '12px', background: overdue > 0 ? '#fef2f2' : '#f8fafc', borderRadius: '10px', cursor: 'pointer', transition: 'transform 0.1s', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #ef4444'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '22px', fontWeight: '700', color: overdue > 0 ? '#ef4444' : '#94a3b8'}}>{overdue}</div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Overdue</div>
                        </div>
                      </div>
                      
                      {/* Clickable Billing Stats */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px'}}>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'billing'})} style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', cursor: 'pointer', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #3b82f6'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Total Billing</div>
                          <div style={{fontSize: '16px', fontWeight: '600', color: '#3b82f6'}}>â‚¹{totalBilling.toLocaleString('en-IN')}</div>
                        </div>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'collection'})} style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', cursor: 'pointer', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #10b981'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Collection</div>
                          <div style={{fontSize: '16px', fontWeight: '600', color: '#10b981'}}>â‚¹{totalCollection.toLocaleString('en-IN')}</div>
                        </div>
                        <div onClick={() => setReportFilters({...reportFilters, selectedRM: rm.name, rmDetailView: 'outstanding'})} style={{padding: '12px', background: '#f8fafc', borderRadius: '8px', cursor: 'pointer', border: '2px solid transparent'}} onMouseEnter={(e) => e.currentTarget.style.border = '2px solid #ef4444'} onMouseLeave={(e) => e.currentTarget.style.border = '2px solid transparent'}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Outstanding</div>
                          <div style={{fontSize: '16px', fontWeight: '600', color: '#ef4444'}}>â‚¹{(totalBilling - totalCollection).toLocaleString('en-IN')}</div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            
            {/* Detailed RM View - Show when specific RM selected */}
            {reportFilters.selectedRM && (
              <>
                {(() => {
                  const rm = data.staff.find(s => s.name === reportFilters.selectedRM);
                  if (!rm) return <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>RM not found</div>;
                  
                  const teamMembers = data.staff.filter(s => s.reportingManager === rm.id || s.reportingManager === rm.name || (s.role === 'Seniors' || s.role === 'Articles'));
                  let teamTasks = allTasks.filter(t => 
                    teamMembers.some(m => t.primaryAssignedUser === m.name || t.assignedTo === m.name) || 
                    t.taskManager === rm.name
                  );
                  if (reportFilters.financialYear) teamTasks = teamTasks.filter(t => t.financialYear === reportFilters.financialYear);
                  
                  const teamClients = [...new Set(teamTasks.map(t => t.clientName || t.client))].filter(Boolean);
                  const completed = teamTasks.filter(t => t.status === 'Completed' || t.completedCheck).length;
                  const pending = teamTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length;
                  const overdue = teamTasks.filter(t => {
                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                  }).length;
                  
                  const teamInvoices = (data.invoices || []).filter(inv => teamClients.includes(inv.clientName));
                  const teamReceipts = (data.receipts || []).filter(r => teamClients.includes(r.clientName));
                  const totalBilling = teamInvoices.reduce((sum, inv) => sum + (parseFloat(inv.totalAmount) || 0), 0);
                  const totalCollection = teamReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                  
                  // Filter tabs
                  const detailViews = [
                    { id: 'clients', label: 'Clients', count: teamClients.length, color: '#3b82f6' },
                    { id: 'completed', label: 'Completed', count: completed, color: '#10b981' },
                    { id: 'pending', label: 'Pending', count: pending, color: '#f59e0b' },
                    { id: 'overdue', label: 'Overdue', count: overdue, color: '#ef4444' },
                    { id: 'billing', label: 'Billing', count: teamInvoices.length, color: '#3b82f6' },
                    { id: 'collection', label: 'Collection', count: teamReceipts.length, color: '#10b981' },
                    { id: 'outstanding', label: 'Outstanding', count: teamClients.filter(c => {
                      const inv = teamInvoices.filter(i => i.clientName === c).reduce((s, i) => s + (parseFloat(i.totalAmount) || 0), 0);
                      const rec = teamReceipts.filter(r => r.clientName === c).reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
                      return inv - rec > 0;
                    }).length, color: '#ef4444' }
                  ];
                  
                  return (
                    <>
                      {/* Summary Cards */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '12px', marginBottom: '20px'}}>
                        {detailViews.map(view => (
                          <div 
                            key={view.id}
                            onClick={() => setReportFilters({...reportFilters, rmDetailView: view.id})}
                            style={{
                              background: reportFilters.rmDetailView === view.id ? view.color : '#fff', 
                              borderRadius: '10px', 
                              padding: '16px', 
                              border: reportFilters.rmDetailView === view.id ? 'none' : `2px solid ${view.color}`,
                              cursor: 'pointer',
                              textAlign: 'center'
                            }}
                          >
                            <div style={{fontSize: '20px', fontWeight: '700', color: reportFilters.rmDetailView === view.id ? '#fff' : view.color}}>{view.count}</div>
                            <div style={{fontSize: '11px', color: reportFilters.rmDetailView === view.id ? 'rgba(255,255,255,0.8)' : '#64748b'}}>{view.label}</div>
                          </div>
                        ))}
                      </div>
                      
                      {/* Detail Table based on selected view */}
                      <div style={{background: '#fff', borderRadius: '12px', border: '1px solid #e2e8f0', overflow: 'hidden'}}>
                        <div style={{padding: '16px 20px', borderBottom: '1px solid #e2e8f0', background: '#f8fafc'}}>
                          <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>
                            {reportFilters.rmDetailView === 'clients' && 'ðŸ¢ Clients Mapped to ' + rm.name}
                            {reportFilters.rmDetailView === 'completed' && 'âœ… Completed Tasks'}
                            {reportFilters.rmDetailView === 'pending' && 'â³ Pending Tasks'}
                            {reportFilters.rmDetailView === 'overdue' && 'ðŸ”´ Overdue Tasks'}
                            {reportFilters.rmDetailView === 'billing' && 'ðŸ“„ Invoices'}
                            {reportFilters.rmDetailView === 'collection' && 'ðŸ’° Receipts/Collections'}
                            {reportFilters.rmDetailView === 'outstanding' && 'âš ï¸ Outstanding by Client'}
                          </h3>
                        </div>
                        <div style={{maxHeight: '500px', overflowY: 'auto'}}>
                          {/* Clients Table */}
                          {reportFilters.rmDetailView === 'clients' && (
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                  <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Tasks</th>
                                  <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Done</th>
                                  <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Pending</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Billed</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Collected</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Outstanding</th>
                                </tr>
                              </thead>
                              <tbody>
                                {teamClients.map(clientName => {
                                  const clientTasks = teamTasks.filter(t => (t.clientName || t.client) === clientName);
                                  const clientBilled = teamInvoices.filter(i => i.clientName === clientName).reduce((s, i) => s + (parseFloat(i.totalAmount) || 0), 0);
                                  const clientCollected = teamReceipts.filter(r => r.clientName === clientName).reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
                                  return (
                                    <tr key={clientName} style={{borderBottom: '1px solid #f1f5f9'}}>
                                      <td style={{padding: '12px', fontWeight: '500'}}>{clientName}</td>
                                      <td style={{padding: '12px', textAlign: 'center'}}>{clientTasks.length}</td>
                                      <td style={{padding: '12px', textAlign: 'center', color: '#10b981'}}>{clientTasks.filter(t => t.status === 'Completed' || t.completedCheck).length}</td>
                                      <td style={{padding: '12px', textAlign: 'center', color: '#f59e0b'}}>{clientTasks.filter(t => t.status !== 'Completed' && !t.completedCheck).length}</td>
                                      <td style={{padding: '12px', textAlign: 'right'}}>â‚¹{clientBilled.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px', textAlign: 'right', color: '#10b981'}}>â‚¹{clientCollected.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px', textAlign: 'right', color: clientBilled - clientCollected > 0 ? '#ef4444' : '#10b981', fontWeight: '600'}}>â‚¹{(clientBilled - clientCollected).toLocaleString('en-IN')}</td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          )}
                          
                          {/* Completed/Pending/Overdue Tasks Table */}
                          {(reportFilters.rmDetailView === 'completed' || reportFilters.rmDetailView === 'pending' || reportFilters.rmDetailView === 'overdue') && (
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Assigned To</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Date</th>
                                  <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                                </tr>
                              </thead>
                              <tbody>
                                {teamTasks.filter(t => {
                                  if (reportFilters.rmDetailView === 'completed') return t.status === 'Completed' || t.completedCheck;
                                  if (reportFilters.rmDetailView === 'pending') return t.status !== 'Completed' && !t.completedCheck;
                                  if (reportFilters.rmDetailView === 'overdue') {
                                    if (t.status === 'Completed' || t.completedCheck || !t.dueDate) return false;
                                    return new Date(t.dueDate.split('-').reverse().join('-')) < today;
                                  }
                                  return true;
                                }).map(task => (
                                  <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '12px'}}>{task.clientName || task.client || '-'}</td>
                                    <td style={{padding: '12px', fontWeight: '500'}}>{task.childTask || task.parentTask}</td>
                                    <td style={{padding: '12px'}}>{task.primaryAssignedUser || task.assignedTo || '-'}</td>
                                    <td style={{padding: '12px', color: reportFilters.rmDetailView === 'overdue' ? '#ef4444' : 'inherit'}}>{task.dueDate || '-'}</td>
                                    <td style={{padding: '12px', textAlign: 'center'}}>
                                      <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '10px', fontWeight: '600', background: task.status === 'Completed' || task.completedCheck ? '#dcfce7' : reportFilters.rmDetailView === 'overdue' ? '#fee2e2' : '#fef3c7', color: task.status === 'Completed' || task.completedCheck ? '#166534' : reportFilters.rmDetailView === 'overdue' ? '#dc2626' : '#92400e'}}>{task.status === 'Completed' || task.completedCheck ? 'Completed' : reportFilters.rmDetailView === 'overdue' ? 'Overdue' : task.status || 'Open'}</span>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          )}
                          
                          {/* Billing (Invoices) Table */}
                          {reportFilters.rmDetailView === 'billing' && (
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Invoice #</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Date</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Amount</th>
                                </tr>
                              </thead>
                              <tbody>
                                {teamInvoices.map(inv => (
                                  <tr key={inv.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '12px', fontWeight: '500'}}>{inv.invoiceNumber || inv.id?.slice(-8)}</td>
                                    <td style={{padding: '12px'}}>{inv.clientName || '-'}</td>
                                    <td style={{padding: '12px'}}>{inv.date || '-'}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#3b82f6'}}>â‚¹{(parseFloat(inv.totalAmount) || 0).toLocaleString('en-IN')}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          )}
                          
                          {/* Collection (Receipts) Table */}
                          {reportFilters.rmDetailView === 'collection' && (
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Receipt #</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Date</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Mode</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Amount</th>
                                </tr>
                              </thead>
                              <tbody>
                                {teamReceipts.map(r => (
                                  <tr key={r.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '12px', fontWeight: '500'}}>{r.receiptNumber || r.id?.slice(-8)}</td>
                                    <td style={{padding: '12px'}}>{r.clientName || '-'}</td>
                                    <td style={{padding: '12px'}}>{r.date || '-'}</td>
                                    <td style={{padding: '12px'}}>{r.mode || r.paymentMode || 'Bank'}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#10b981'}}>â‚¹{(parseFloat(r.amount) || 0).toLocaleString('en-IN')}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          )}
                          
                          {/* Outstanding Table */}
                          {reportFilters.rmDetailView === 'outstanding' && (
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Total Billed</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Collected</th>
                                  <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Outstanding</th>
                                  <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Collection %</th>
                                </tr>
                              </thead>
                              <tbody>
                                {teamClients.map(clientName => {
                                  const clientBilled = teamInvoices.filter(i => i.clientName === clientName).reduce((s, i) => s + (parseFloat(i.totalAmount) || 0), 0);
                                  const clientCollected = teamReceipts.filter(r => r.clientName === clientName).reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
                                  const outstanding = clientBilled - clientCollected;
                                  if (outstanding <= 0) return null;
                                  return (
                                    <tr key={clientName} style={{borderBottom: '1px solid #f1f5f9'}}>
                                      <td style={{padding: '12px', fontWeight: '500'}}>{clientName}</td>
                                      <td style={{padding: '12px', textAlign: 'right'}}>â‚¹{clientBilled.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px', textAlign: 'right', color: '#10b981'}}>â‚¹{clientCollected.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px', textAlign: 'right', color: '#ef4444', fontWeight: '600'}}>â‚¹{outstanding.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px', textAlign: 'center'}}>
                                        <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '10px', fontWeight: '600', background: clientBilled > 0 && (clientCollected / clientBilled) >= 0.8 ? '#dcfce7' : '#fee2e2', color: clientBilled > 0 && (clientCollected / clientBilled) >= 0.8 ? '#166534' : '#dc2626'}}>{clientBilled > 0 ? Math.round((clientCollected / clientBilled) * 100) : 0}%</span>
                                      </td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          )}
                        </div>
                      </div>
                    </>
                  );
                })()}
              </>
            )}
          </div>
        )}
      </div>
    );
  };

  // Modal Component
  const Modal = () => {
    if (!showModal) return null;

    return (
      <div className="modal-overlay" onClick={closeModal}>
        <div className="modal large-modal" onClick={(e) => e.stopPropagation()}>
          <div className="modal-header">
            <h2>{selectedItem ? 'Edit Task' : 'Add New Task'}</h2>
            <button className="modal-close" onClick={closeModal}>
              <X size={24} />
            </button>
          </div>
          <form onSubmit={handleFormSubmit}>
            <div className="modal-body">
              <div className="form-section">
                <h3 className="form-section-title">Basic Information</h3>
                <div className="form-row">
                  <div className="form-group">
                    <label>Client Name <span className="required">*</span></label>
                    <input
                      type="text"
                      placeholder="Enter client name"
                      value={formData.clientName || ''}
                      onChange={(e) => setFormData({ ...formData, clientName: e.target.value })}
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label>Client Code</label>
                    <input
                      type="text"
                      placeholder="Auto-filled from client"
                      value={formData.fileNo || ''}
                      onChange={(e) => setFormData({ ...formData, fileNo: e.target.value })}
                      readOnly
                      style={{background: '#f8fafc', cursor: 'not-allowed'}}
                    />
                  </div>
                </div>
              </div>

              <div className="form-section">
                <h3 className="form-section-title">Task Details</h3>
                <div className="form-row">
                  <div className="form-group">
                    <label>Parent Task</label>
                    <input type="text" value={selectedParentTask} disabled />
                  </div>
                  <div className="form-group">
                    <label>Child Task</label>
                    <input type="text" value={selectedChildTask} disabled />
                  </div>
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label>Assigned To</label>
                    <select
                      value={formData.assignedTo || ''}
                      onChange={(e) => setFormData({ ...formData, assignedTo: e.target.value })}
                      required
                    >
                      <option value="">Select Staff</option>
                      {data.staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>
                  <div className="form-group">
                    <label>Expected Completion Date</label>
                    <input
                      type="date"
                      value={formData.expectedCompletionDate || ''}
                      onChange={(e) => setFormData({ ...formData, expectedCompletionDate: e.target.value })}
                      required
                    />
                  </div>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button type="button" className="btn-secondary" onClick={closeModal}>
                Cancel
              </button>
              <button type="submit" className="btn-primary">
                {selectedItem ? 'Update Task' : 'Create Task'}
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // Task Management Modal

  const TaskManagementModal = () => {
    if (!showTaskManageModal || !selectedTask) return null;

    const [taskFormData, setTaskFormData] = useState(selectedTask);
    const [isEditMode, setIsEditMode] = useState(false);

    const handleEditTask = () => {
      setIsEditMode(true);
    };

    const handleTaskUpdate = () => {
      setData(prev => ({
        ...prev,
        tasks: prev.tasks.map(t => t.id === selectedTask.id ? taskFormData : t)
      }));
      setIsEditMode(false);
      setSelectedTask(taskFormData);
      alert('Task updated successfully!');
    };

    const handleCancelEdit = () => {
      setTaskFormData(selectedTask);
      setIsEditMode(false);
    };

    const handleCloseTask = () => {
      console.log('=== COMPLETE TASK BUTTON CLICKED ===');
      console.log('Selected Task:', selectedTask);
      console.log('Task Form Data:', taskFormData);
      
      if (window.confirm('Are you sure you want to complete this task?')) {
        console.log('User confirmed completion');
        
        const updatedTask = {
          ...taskFormData,
          status: 'Completed',
          completedCheck: true,
          completedBy: 'Admin',
          currentPosition: 'Task Completed'
        };
        
        console.log('Updated task object:', updatedTask);
        
        setData(prev => {
          console.log('Current tasks:', prev.tasks.length);
          const newTasks = prev.tasks.map(t => t.id === selectedTask.id ? updatedTask : t);
          console.log('Updated tasks array');
          return {
            ...prev,
            tasks: newTasks
          };
        });
        
        setTaskFormData(updatedTask);
        setSelectedTask(updatedTask);
        
        console.log('Closing modal...');
        setShowTaskManageModal(false);
        
        alert('Task completed successfully!');
        console.log('=== TASK COMPLETION COMPLETE ===');
      } else {
        console.log('User cancelled completion');
      }
    };

    const handleReopenTask = () => {
      if (window.confirm('Are you sure you want to re-open this task?')) {
        const updatedTask = {
          ...taskFormData,
          status: 'Pending',
          completedCheck: false,
          completedBy: '',
          currentPosition: 'Task Re-opened'
        };
        setData(prev => ({
          ...prev,
          tasks: prev.tasks.map(t => t.id === selectedTask.id ? updatedTask : t)
        }));
        setTaskFormData(updatedTask);
        setSelectedTask(updatedTask);
        setShowTaskManageModal(false); // Close the modal
        alert('Task re-opened successfully!');
      }
    };

    const handleDownloadPDF = () => {
      alert('Downloading Task Report PDF...');
    };

    const isTaskClosed = selectedTask.status === 'Completed' || selectedTask.completedCheck;
    
    console.log('=== TASK MODAL STATE ===');
    console.log('Selected Task Status:', selectedTask.status);
    console.log('Selected Task completedCheck:', selectedTask.completedCheck);
    console.log('isTaskClosed:', isTaskClosed);
    console.log('Will show:', isTaskClosed ? 'Re-open Task button' : 'Complete Task button');

    return (
      <div className="modal-overlay" onClick={closeTaskManageModal}>
        <div className="task-manage-modal-new" onClick={(e) => e.stopPropagation()}>
          {/* Header */}
          <div className="task-modal-header-new">
            <div className="header-content-new">
              <h2>{selectedTask.childTask}</h2>
              <div className="header-action-buttons">
                {!isTaskClosed ? (
                  <button 
                    className="btn-complete-header"
                    onClick={() => {
                      if (window.confirm('Complete this task?')) {
                        setData(prev => ({
                          ...prev,
                          tasks: prev.tasks.map(t => 
                            t.id === selectedTask.id 
                              ? { ...t, status: 'Completed', completedCheck: true, completedBy: 'Admin' }
                              : t
                          )
                        }));
                        alert('Task completed!');
                        setShowTaskManageModal(false);
                      }
                    }}
                  >
                    âœ“ Complete Task
                  </button>
                ) : (
                  <button 
                    className="btn-reopen-header"
                    onClick={() => {
                      if (window.confirm('Re-open this task?')) {
                        setData(prev => ({
                          ...prev,
                          tasks: prev.tasks.map(t => 
                            t.id === selectedTask.id 
                              ? { ...t, status: 'Pending', completedCheck: false, completedBy: '' }
                              : t
                          )
                        }));
                        alert('Task re-opened!');
                        setShowTaskManageModal(false);
                      }
                    }}
                  >
                    â†» Re-open Task
                  </button>
                )}
              </div>
            </div>
            <button 
              className="btn-close-modal-new" 
              onClick={() => {
                // First ask if they want to complete the task
                if (!isTaskClosed) {
                  const wantsToComplete = window.confirm('Do you want to COMPLETE this task before closing? Click OK to complete, Cancel to just close.');
                  if (wantsToComplete) {
                    // Complete the task
                    setData(prev => ({
                      ...prev,
                      tasks: prev.tasks.map(t => 
                        t.id === selectedTask.id 
                          ? { ...t, status: 'Completed', completedCheck: true, completedBy: 'Admin' }
                          : t
                      )
                    }));
                    alert('Task completed successfully!');
                  }
                }
                // Close modal either way
                closeTaskManageModal();
              }}
            >
              <X size={20} />
            </button>
          </div>

          {/* Task Details Section */}
          <div className="task-details-body-new">
            {!isEditMode ? (
              <>
                <div className="view-mode-header">
                  <h3>Task Details</h3>
                  <div className="view-mode-actions">
                    <button className="btn-action-secondary" onClick={handleEditTask}>
                      <Edit size={16} />
                      Edit Task
                    </button>
                    {isTaskClosed ? (
                      <button 
                        className="btn-action-reopen" 
                        onClick={() => {
                          if (window.confirm('Are you sure you want to re-open this task?')) {
                            const updatedTask = {
                              ...selectedTask,
                              status: 'Pending',
                              completedCheck: false,
                              completedBy: '',
                              currentPosition: 'Task Re-opened'
                            };
                            setData(prev => ({
                              ...prev,
                              tasks: prev.tasks.map(t => t.id === selectedTask.id ? updatedTask : t)
                            }));
                            setShowTaskManageModal(false);
                            alert('Task re-opened successfully!');
                          }
                        }}
                      >
                        <CheckCircle size={16} />
                        Re-open Task
                      </button>
                    ) : (
                      <button 
                        className="btn-action-close"
                        type="button"
                        onMouseEnter={() => console.log('Mouse entered Complete Task button')}
                        onMouseLeave={() => console.log('Mouse left Complete Task button')}
                        onMouseDown={() => console.log('Mouse DOWN on Complete Task button')}
                        onMouseUp={() => console.log('Mouse UP on Complete Task button')}
                        onClick={(e) => {
                          console.log('============ COMPLETE TASK CLICKED ============');
                          console.log('Event object:', e);
                          console.log('Event target:', e.target);
                          console.log('Current target:', e.currentTarget);
                          console.log('Button element:', e.currentTarget.tagName);
                          console.log('selectedTask:', selectedTask);
                          console.log('data.tasks before:', data.tasks.length);
                          
                          try {
                            const confirmed = window.confirm('Are you sure you want to complete this task?');
                            console.log('User confirmed:', confirmed);
                            
                            if (confirmed) {
                              console.log('Starting task update...');
                              const updatedTask = {
                                ...selectedTask,
                                status: 'Completed',
                                completedCheck: true,
                                completedBy: 'Admin',
                                currentPosition: 'Task Completed'
                              };
                              console.log('Updated task object:', updatedTask);
                              
                              setData(prev => {
                                console.log('Inside setData callback');
                                console.log('Previous tasks:', prev.tasks.length);
                                const newTasks = prev.tasks.map(t => {
                                  if (t.id === selectedTask.id) {
                                    console.log('Found matching task, updating...');
                                    return updatedTask;
                                  }
                                  return t;
                                });
                                console.log('New tasks array:', newTasks.length);
                                return {
                                  ...prev,
                                  tasks: newTasks
                                };
                              });
                              
                              console.log('Closing modal...');
                              setShowTaskManageModal(false);
                              console.log('Showing alert...');
                              alert('Task completed successfully!');
                              console.log('============ COMPLETE TASK DONE ============');
                            } else {
                              console.log('User cancelled');
                            }
                          } catch (error) {
                            console.error('ERROR in Complete Task:', error);
                            alert('ERROR: ' + error.message);
                          }
                        }}
                        style={{
                          cursor: 'pointer',
                          userSelect: 'none'
                        }}
                      >
                        <CheckCircle size={16} />
                        Complete Task
                      </button>
                    )}
                  </div>
                </div>

                <div className="details-grid-new">
                  {/* Client Information */}
                  <div className="detail-card-new">
                    <h4><Users size={18} /> Client Information</h4>
                    <div className="detail-rows">
                      <div className="detail-row-new">
                        <span className="label-new">Client Code</span>
                        <span className="value-new">{taskFormData.fileNo || 'N/A'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Client Name</span>
                        <span className="value-new">{taskFormData.clientName}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Group No.</span>
                        <span className="value-new">{taskFormData.fileNo ? taskFormData.fileNo.split('.')[0] : '-'}</span>
                      </div>
                    </div>
                  </div>

                  {/* Task Configuration */}
                  <div className="detail-card-new">
                    <h4><CheckCircle size={18} /> Task Configuration</h4>
                    <div className="detail-rows">
                      <div className="detail-row-new">
                        <span className="label-new">Parent Task</span>
                        <span className="value-new">{taskFormData.parentTask}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Child Task</span>
                        <span className="value-new">{taskFormData.childTask}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Financial Year</span>
                        <span className="value-new">{taskFormData.financialYear}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Period</span>
                        <span className="value-new">{taskFormData.period}</span>
                      </div>
                    </div>
                  </div>

                  {/* Assignment */}
                  <div className="detail-card-new">
                    <h4><User size={18} /> Assignment & Status</h4>
                    <div className="detail-rows">
                      <div className="detail-row-new">
                        <span className="label-new">Task Leader</span>
                        <span className="value-new">{taskFormData.taskLeader || 'Not Assigned'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Task Manager</span>
                        <span className="value-new">{taskFormData.taskManager || 'Not Assigned'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Assigned User</span>
                        <span className="value-new">{taskFormData.primaryAssignedUser || taskFormData.assignedTo || 'Not Assigned'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Status</span>
                        <span className="value-new status-badge" style={{
                          background: taskFormData.status === 'Completed' ? '#dcfce7' : taskFormData.status === 'In Progress' ? '#fef3c7' : '#fee2e2',
                          color: taskFormData.status === 'Completed' ? '#166534' : taskFormData.status === 'In Progress' ? '#92400e' : '#991b1b',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}>
                          {taskFormData.status}
                        </span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Priority</span>
                        <span className="value-new priority-badge" style={{
                          background: taskFormData.priority === 'High' ? '#fee2e2' : taskFormData.priority === 'Medium' ? '#fef3c7' : '#dbeafe',
                          color: taskFormData.priority === 'High' ? '#991b1b' : taskFormData.priority === 'Medium' ? '#92400e' : '#1e3a8a',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}>
                          {taskFormData.priority || 'Medium'}
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Timeline */}
                  <div className="detail-card-new">
                    <h4><Clock size={18} /> Timeline</h4>
                    <div className="detail-rows">
                      <div className="detail-row-new">
                        <span className="label-new">Start Date</span>
                        <span className="value-new">{taskFormData.startDate || 'Not Set'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Expected Completion</span>
                        <span className="value-new">{taskFormData.expectedCompletionDate || 'Not Set'}</span>
                      </div>
                      <div className="detail-row-new">
                        <span className="label-new">Current Position</span>
                        <span className="value-new">{taskFormData.currentPosition || 'In Progress'}</span>
                      </div>
                      {taskFormData.completedBy && (
                        <div className="detail-row-new">
                          <span className="label-new">Completed By</span>
                          <span className="value-new">{taskFormData.completedBy}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Additional Information */}
                  {(taskFormData.taskDescription || taskFormData.comments || taskFormData.pendingIssues) && (
                    <div className="detail-card-new full-width">
                      <h4><FileText size={18} /> Additional Information</h4>
                      <div className="detail-rows">
                        {taskFormData.taskDescription && (
                          <div className="detail-row-new">
                            <span className="label-new">Description</span>
                            <span className="value-new">{taskFormData.taskDescription}</span>
                          </div>
                        )}
                        {taskFormData.comments && (
                          <div className="detail-row-new">
                            <span className="label-new">Comments</span>
                            <span className="value-new">{taskFormData.comments}</span>
                          </div>
                        )}
                        {taskFormData.pendingIssues && (
                          <div className="detail-row-new">
                            <span className="label-new">Pending Issues</span>
                            <span className="value-new">{taskFormData.pendingIssues}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </>
            ) : (
              <>
                {/* Edit Mode */}
                <div className="edit-mode-header">
                  <h3>Edit Task Details</h3>
                  <div className="edit-mode-actions">
                    <button className="btn-cancel" onClick={handleCancelEdit}>Cancel</button>
                    <button className="btn-primary" onClick={handleTaskUpdate}>
                      <CheckCircle size={16} />
                      Save Changes
                    </button>
                  </div>
                </div>

                <div className="edit-form-grid">
                  {/* Parent and Child Task - Added */}
                  <div className="form-field-task">
                    <label>Parent Task (Category)</label>
                    <select 
                      value={taskFormData.parentTask} 
                      onChange={(e) => setTaskFormData({...taskFormData, parentTask: e.target.value, childTask: ''})}
                    >
                      <option value="">Select Parent Task</option>
                      {Object.keys(data.parentChildTasks || {}).map(parent => (
                        <option key={parent} value={parent}>{parent}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Child Task (Task Type)</label>
                    <select 
                      value={taskFormData.childTask} 
                      onChange={(e) => {
                        const childTask = e.target.value;
                        const description = `${childTask} for ${taskFormData.clientName}`;
                        setTaskFormData({...taskFormData, childTask, taskDescription: description, description});
                      }}
                    >
                      <option value="">Select Child Task</option>
                      {(data.parentChildTasks?.[taskFormData.parentTask] || []).map(child => (
                        <option key={child} value={child}>{child}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Status</label>
                    <select value={taskFormData.status} onChange={(e) => setTaskFormData({...taskFormData, status: e.target.value})}>
                      <option value="Pending">Pending</option>
                      <option value="In Progress">In Progress</option>
                      <option value="Completed">Completed</option>
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Priority</label>
                    <select value={taskFormData.priority} onChange={(e) => setTaskFormData({...taskFormData, priority: e.target.value})}>
                      <option value="Low">Low</option>
                      <option value="Medium">Medium</option>
                      <option value="High">High</option>
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Financial Year</label>
                    <select 
                      value={taskFormData.financialYear} 
                      onChange={(e) => setTaskFormData({...taskFormData, financialYear: e.target.value})}
                    >
                      <option value="">Select FY</option>
                      {FINANCIAL_YEARS.map(fy => (
                        <option key={fy} value={fy}>{fy}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Period</label>
                    <select 
                      value={taskFormData.period} 
                      onChange={(e) => setTaskFormData({...taskFormData, period: e.target.value})}
                    >
                      <option value="">Select Period</option>
                      {PERIODS.map(p => (
                        <option key={p} value={p}>{p}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Task Leader</label>
                    <select value={taskFormData.taskLeader} onChange={(e) => setTaskFormData({...taskFormData, taskLeader: e.target.value})}>
                      <option value="">Select Task Leader</option>
                      {data.staff.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Task Manager</label>
                    <select value={taskFormData.taskManager} onChange={(e) => setTaskFormData({...taskFormData, taskManager: e.target.value})}>
                      <option value="">Select Task Manager</option>
                      {data.staff.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Assigned User</label>
                    <select value={taskFormData.primaryAssignedUser || taskFormData.assignedTo} onChange={(e) => setTaskFormData({...taskFormData, primaryAssignedUser: e.target.value, assignedTo: e.target.value})}>
                      <option value="">Select Assigned User</option>
                      {data.staff.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>
                  </div>

                  <div className="form-field-task">
                    <label>Start Date</label>
                    <input type="date" value={taskFormData.startDate} onChange={(e) => setTaskFormData({...taskFormData, startDate: e.target.value})} />
                  </div>

                  <div className="form-field-task">
                    <label>Expected Completion Date</label>
                    <input type="date" value={taskFormData.expectedCompletionDate} onChange={(e) => setTaskFormData({...taskFormData, expectedCompletionDate: e.target.value})} />
                  </div>

                  <div className="form-field-task">
                    <label>Current Position</label>
                    <input type="text" value={taskFormData.currentPosition} onChange={(e) => setTaskFormData({...taskFormData, currentPosition: e.target.value})} />
                  </div>

                  <div className="form-field-task full-width">
                    <label>Task Description</label>
                    <textarea rows="3" value={taskFormData.taskDescription} onChange={(e) => setTaskFormData({...taskFormData, taskDescription: e.target.value})} />
                  </div>

                  <div className="form-field-task full-width">
                    <label>Comments</label>
                    <textarea rows="2" value={taskFormData.comments} onChange={(e) => setTaskFormData({...taskFormData, comments: e.target.value})} />
                  </div>

                  <div className="form-field-task full-width">
                    <label>Pending Issues</label>
                    <textarea rows="2" value={taskFormData.pendingIssues} onChange={(e) => setTaskFormData({...taskFormData, pendingIssues: e.target.value})} />
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Add Task Form Modal
  const AddTaskForm = ({ onClose, onSave, onAddClient, onBulkSave }) => {
    const [taskFormData, setTaskFormData] = useState({
      clientId: '',
      clientName: '',
      groupName: '',
      fileNo: '',
      parentTask: '',
      childTask: '',
      financialYear: '',
      period: '',
      subPeriod: '',
      taskLeader: '',
      taskManager: '',
      primaryAssignedUser: '',
      startDate: '',
      expectedCompletionDate: '',
      taskDescription: '',
      comments: '',
      showTaskSelector: false
    });

    const [availableChildTasks, setAvailableChildTasks] = useState([]);
    const [showQuickClientForm, setShowQuickClientForm] = useState(false);
    const [clientSearchTerm, setClientSearchTerm] = useState('');
    const [showClientDropdown, setShowClientDropdown] = useState(false);
    const [taskSearchTerm, setTaskSearchTerm] = useState('');

    // Filter clients based on search and remove duplicates by name
    const filteredClients = (() => {
      const filtered = data.clients.filter(c => 
        !c.disabled && 
        (c.name?.toLowerCase().includes(clientSearchTerm.toLowerCase()) ||
         c.fileNo?.toLowerCase().includes(clientSearchTerm.toLowerCase()))
      );
      // Remove duplicates by name (keep first occurrence)
      const seen = new Set();
      return filtered.filter(c => {
        const name = (c.name || '').toLowerCase().trim();
        if (seen.has(name)) return false;
        seen.add(name);
        return true;
      });
    })();

    // Filter parent tasks based on search
    const filteredParentTasks = Object.keys(PARENT_CHILD_TASKS).filter(parent =>
      parent.toLowerCase().includes(taskSearchTerm.toLowerCase())
    );

    // Get sub-period options based on period
    const getSubPeriodOptions = () => {
      switch(taskFormData.period) {
        case 'Monthly':
          return ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        case 'Quarterly':
          return ['Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'];
        case 'Half Yearly':
          return ['H1', 'H2'];
        case 'Annual':
          return ['Annual'];
        default:
          return [];
      }
    };

    // Monitor available clients
    React.useEffect(() => {
      console.log('Available clients in dropdown:', data.clients.length);
      console.log('Client names:', data.clients.map(c => c.name));
    }, [data.clients.length]);

    // Handle client selection from search
    const handleClientSelectFromSearch = (client) => {
      setTaskFormData(prev => ({
        ...prev,
        clientId: client.id,
        clientName: client.name,
        groupName: client.groupName || client.name,
        fileNo: client.fileNo || ''
      }));
      setClientSearchTerm(client.fileNo ? `${client.fileNo} - ${client.name}` : client.name);
      setShowClientDropdown(false);
    };

    // Handle client selection
    const handleClientSelect = (e) => {
      const clientId = e.target.value;
      
      if (clientId === 'add-new') {
        setShowQuickClientForm(true);
        return;
      }

      if (clientId) {
        const selectedClient = data.clients.find(c => c.id === clientId);
        if (selectedClient) {
          console.log('Client selected:', selectedClient);
          setTaskFormData(prev => ({
            ...prev,
            clientId: selectedClient.id,
            clientName: selectedClient.name,
            groupName: selectedClient.groupName || selectedClient.name,
            fileNo: selectedClient.fileNo || ''
          }));
        }
      } else {
        setTaskFormData(prev => ({
          ...prev,
          clientId: '',
          clientName: '',
          groupName: '',
          fileNo: ''
        }));
      }
    };

    // Quick add client handler
    const handleQuickAddClient = (newClient) => {
      console.log('Quick add client called with:', newClient);
      
      // Call the onAddClient prop to add client to parent state
      onAddClient(newClient);

      // Auto-fill task form with new client
      setTaskFormData(prev => ({
        ...prev,
        clientId: newClient.id,
        clientName: newClient.name,
        groupName: newClient.groupName || newClient.name,
        fileNo: newClient.fileNo || ''
      }));

      setShowQuickClientForm(false);
      alert('Client added successfully and auto-filled in the form!');
    };

    // Update child tasks when parent task changes
    React.useEffect(() => {
      if (taskFormData.parentTask && PARENT_CHILD_TASKS[taskFormData.parentTask]) {
        setAvailableChildTasks(PARENT_CHILD_TASKS[taskFormData.parentTask]);
        setTaskFormData(prev => ({ ...prev, childTask: '' }));
      } else {
        setAvailableChildTasks([]);
      }
    }, [taskFormData.parentTask]);

    const handleSubmit = (e) => {
      e.preventDefault();
      
      console.log('=== TASK FORM SUBMITTED ===');
      console.log('Task form data:', taskFormData);
      
      // Validation
      if (!taskFormData.clientName) {
        console.log('Validation failed: Client Name missing');
        alert('Client Name is required!');
        return;
      }
      if (!taskFormData.groupName) {
        console.log('Validation failed: Group No. missing');
        alert('Group No. is required!');
        return;
      }
      if (!taskFormData.parentTask || !taskFormData.childTask) {
        console.log('Validation failed: Parent/Child Task missing');
        alert('Parent Task and Child Task are required!');
        return;
      }
      if (!taskFormData.financialYear || !taskFormData.period) {
        console.log('Validation failed: Financial Year/Period missing');
        alert('Financial Year and Period are required!');
        return;
      }
      if (!taskFormData.subPeriod && taskFormData.period !== 'Annual') {
        console.log('Validation failed: Sub-Period missing');
        alert('Sub-Period is required!');
        return;
      }
      if (!taskFormData.taskLeader) {
        console.log('Validation failed: Task Leader missing');
        alert('Task Leader is required!');
        return;
      }
      if (!taskFormData.taskManager) {
        console.log('Validation failed: Task Manager missing');
        alert('Task Manager is required!');
        return;
      }
      if (!taskFormData.primaryAssignedUser) {
        console.log('Validation failed: Primary Assigned User missing');
        alert('Primary Assigned User is required!');
        return;
      }

      console.log('Validation passed! Creating task object...');

      // Combine period and subPeriod for display
      const periodDisplay = taskFormData.period === 'Annual' 
        ? 'Annual' 
        : `${taskFormData.period} - ${taskFormData.subPeriod}`;

      const newTask = {
        id: generateId(),
        fileNo: taskFormData.fileNo,
        clientName: taskFormData.clientName,
        clientId: taskFormData.clientId || '',
        groupName: taskFormData.groupName,
        parentTask: taskFormData.parentTask,
        childTask: taskFormData.childTask,
        financialYear: taskFormData.financialYear,
        period: periodDisplay,
        subPeriod: taskFormData.subPeriod || '',
        taskLeader: taskFormData.taskLeader,
        taskManager: taskFormData.taskManager,
        primaryAssignedUser: taskFormData.primaryAssignedUser,
        assignedTo: taskFormData.primaryAssignedUser,
        startDate: taskFormData.startDate || '',
        expectedCompletionDate: taskFormData.expectedCompletionDate || '',
        taskDescription: taskFormData.taskDescription || '',
        comments: taskFormData.comments || '',
        status: 'Pending',
        priority: 'Medium',
        completedCheck: false,
        completedBy: '',
        currentPosition: 'New Task Created',
        pendingIssues: '',
        checkGroupsName: `${periodDisplay}-${taskFormData.childTask}`
      };

      console.log('New task object created:', newTask);
      console.log('Calling onSave callback...');
      
      onSave(newTask);
      
      console.log('onSave callback completed');
    };

    const financialYears = [
      'FY 2024-25',
      'FY 2025-26',
      'FY 2026-27'
    ];

    const periods = [
      'Monthly',
      'Quarterly',
      'Half Yearly',
      'Annual'
    ];

    // Bulk Upload States
    const [activeMode, setActiveMode] = useState('single'); // single or bulk
    const [bulkPreview, setBulkPreview] = useState([]);
    const [bulkError, setBulkError] = useState('');
    const [bulkWarning, setBulkWarning] = useState('');

    // Download sample CSV
    const downloadSampleTaskCSV = () => {
      // Get staff for sample data
      const superadmins = data.staff.filter(s => s.role === 'Superadmin' && s.status === 'Active');
      const managers = data.staff.filter(s => s.role === 'Reporting Manager' && s.status === 'Active');
      const clients = data.clients.filter(c => !c.disabled);
      
      const taskLeader = superadmins[0]?.name || 'Test1';
      
      // Create sample tasks
      const sampleTasks = [];
      const taskTypes = [
        { parent: 'GST', children: ['Monthly 3B', 'GSTR 1 Monthly', 'GSTR 9'] },
        { parent: 'Income Tax', children: ['IT Return Filing', 'Litigation'] },
        { parent: 'TDS', children: ['24Q', '26Q', '27EQ'] },
        { parent: 'Audit', children: ['Tax Audit', 'Company Audit'] },
        { parent: 'ROC - Company', children: ['Filings', 'Company Registration'] },
        { parent: 'Accounting', children: ['Monthly Accounting', 'Reconciliations'] }
      ];
      
      const financialYears = ['FY 2024-25', 'FY 2025-26'];
      const periods = ['April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'Q1', 'Q2', 'Q3', 'Q4', 'Monthly', 'Yearly'];
      
      let taskCount = 0;
      
      // Generate 50 tasks
      for (let i = 0; i < 50; i++) {
        const taskType = taskTypes[i % taskTypes.length];
        const childTask = taskType.children[i % taskType.children.length];
        const fy = financialYears[i % financialYears.length];
        const period = periods[i % periods.length];
        
        // Rotate through managers
        const manager = managers[i % Math.max(managers.length, 1)]?.name || 'Manager1';
        
        // Get staff under this manager
        const staffUnderManager = data.staff.filter(s => s.reportingManager === manager && s.status === 'Active');
        const assignedUser = staffUnderManager[i % Math.max(staffUnderManager.length, 1)]?.name || 'Staff1';
        
        // Use actual clients or generate sample names
        const clientName = clients[i % Math.max(clients.length, 1)]?.name || `Sample Client ${i + 1}`;
        const fileNo = clients[i % Math.max(clients.length, 1)]?.fileNo || `1.${String(i + 1).padStart(2, '0')}`;
        
        const startDate = new Date();
        startDate.setDate(startDate.getDate() + (i * 2));
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 7);
        
        sampleTasks.push({
          clientName,
          fileNo,
          parentTask: taskType.parent,
          childTask,
          financialYear: fy,
          period,
          taskLeader,
          taskManager: manager,
          primaryAssignedUser: assignedUser,
          startDate: startDate.toISOString().split('T')[0],
          expectedCompletionDate: endDate.toISOString().split('T')[0],
          description: `${childTask} for ${clientName} - ${period} ${fy}`
        });
        
        taskCount++;
        if (taskCount >= 50) break;
      }
      
      // Create CSV
      const headers = 'clientName,fileNo,parentTask,childTask,financialYear,period,taskLeader,taskManager,primaryAssignedUser,startDate,expectedCompletionDate,description';
      const rows = sampleTasks.map(t => 
        `${t.clientName},${t.fileNo},${t.parentTask},${t.childTask},${t.financialYear},${t.period},${t.taskLeader},${t.taskManager},${t.primaryAssignedUser},${t.startDate},${t.expectedCompletionDate},"${t.description}"`
      );
      const csvContent = [headers, ...rows].join('\n');
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'sample_tasks_data.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    };

    // Handle CSV file upload
    const handleTaskFileUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      setBulkError('');
      setBulkWarning('');
      setBulkPreview([]);
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const text = event.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            setBulkError('CSV file is empty or has no data rows');
            return;
          }
          
          // Normalize headers - remove spaces, special chars, lowercase
          const rawHeaders = lines[0].split(',').map(h => h.trim());
          const headers = rawHeaders.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ''));
          console.log('CSV Headers (raw):', rawHeaders);
          console.log('CSV Headers (normalized):', headers);
          
          // Required columns (normalized) - check for partial matches
          const requiredCols = [
            { key: 'clientname', aliases: ['clientname', 'client'] },
            { key: 'parenttask', aliases: ['parenttask', 'parent'] },
            { key: 'childtask', aliases: ['childtask', 'child'] },
            { key: 'financialyear', aliases: ['financialyear', 'fy', 'year'] },
            { key: 'period', aliases: ['period'] },
            { key: 'taskleader', aliases: ['taskleader', 'leader'] },
            { key: 'taskmanager', aliases: ['taskmanager', 'manager'] },
            { key: 'primaryassigneduser', aliases: ['primaryassign', 'primaryuser', 'assigneduser', 'assigned'] }
          ];
          
          const missingCols = requiredCols.filter(req => {
            return !req.aliases.some(alias => 
              headers.some(h => h.startsWith(alias) || alias.startsWith(h))
            );
          }).map(r => r.key);
          
          if (missingCols.length > 0) {
            setBulkError(`Missing required columns: ${missingCols.join(', ')}`);
            return;
          }
          
          // Get column indices
          const colIdx = {};
          headers.forEach((h, i) => colIdx[h] = i);
          
          // ========== VALIDATION REFERENCE DATA ==========
          // Get all valid options from system
          const validClients = data.clients.map(c => c.name?.toLowerCase()).filter(Boolean);
          const validClientCodes = data.clients.map(c => c.fileNo?.toLowerCase()).filter(Boolean);
          const validStaff = data.staff.filter(s => s.status === 'Active').map(s => s.name?.toLowerCase()).filter(Boolean);
          const validSuperadmins = data.staff.filter(s => s.role === 'Superadmin' && s.status === 'Active').map(s => s.name?.toLowerCase());
          const validManagers = data.staff.filter(s => (s.role === 'Reporting Manager' || s.role === 'Superadmin') && s.status === 'Active').map(s => s.name?.toLowerCase());
          const validParentTasks = Object.keys(PARENT_CHILD_TASKS).map(p => p.toLowerCase());
          const validFinancialYears = FINANCIAL_YEARS.map(fy => fy.toLowerCase());
          const validPeriods = ['monthly', 'quarterly', 'half-yearly', 'annually', 'annual'];
          
          // Sub-period validation map
          const validSubPeriods = {
            'monthly': ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december', 'jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'],
            'quarterly': ['q1', 'q2', 'q3', 'q4', 'quarter 1', 'quarter 2', 'quarter 3', 'quarter 4', 'apr-jun', 'jul-sep', 'oct-dec', 'jan-mar'],
            'half-yearly': ['h1', 'h2', 'half 1', 'half 2', 'apr-sep', 'oct-mar'],
            'annually': [],
            'annual': []
          };
          
          const tasks = [];
          const errors = []; // Blocking errors - row will be skipped
          const warnings = []; // Non-blocking warnings - row will still be imported
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Handle quoted values
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let c of line) {
              if (c === '"') {
                inQuotes = !inQuotes;
              } else if (c === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += c;
              }
            }
            values.push(current.trim());
            
            // Flexible getValue that checks for partial matches too
            const getValue = (col) => {
              // Direct match
              if (colIdx[col] !== undefined) return values[colIdx[col]] || '';
              // Partial match - find column that starts with or contains the key
              const partialMatch = Object.keys(colIdx).find(h => h.startsWith(col) || col.startsWith(h));
              if (partialMatch) return values[colIdx[partialMatch]] || '';
              return '';
            };
            
            const rowNum = i + 1;
            const rowErrors = [];
            const rowWarnings = [];
            
            // Extract values
            const clientName = getValue('clientname');
            const clientCode = getValue('fileno') || getValue('clientcode') || getValue('code');
            const parentTask = getValue('parenttask');
            const childTask = getValue('childtask');
            const taskLeader = getValue('taskleader');
            const taskManager = getValue('taskmanager');
            const primaryUser = getValue('primaryassign') || getValue('primaryassigneduser') || getValue('primaryuser') || getValue('assigneduser');
            const financialYear = getValue('financialyear') || getValue('fy');
            const period = getValue('period');
            const subPeriod = getValue('subperiod');
            
            // ========== VALIDATION CHECKS ==========
            
            // 1. Required fields check
            if (!clientName) rowErrors.push('Client Name is required');
            if (!parentTask) rowErrors.push('Parent Task is required');
            if (!childTask) rowErrors.push('Child Task is required');
            
            // 2. Client validation - must exist in system
            if (clientName && !validClients.includes(clientName.toLowerCase())) {
              rowErrors.push(`Client "${clientName}" not found in system`);
            }
            
            // 3. Client Code validation (if provided)
            if (clientCode && !validClientCodes.includes(clientCode.toLowerCase())) {
              // Try to find client by name and check if code matches
              const matchingClient = data.clients.find(c => c.name?.toLowerCase() === clientName.toLowerCase());
              if (matchingClient && matchingClient.fileNo && matchingClient.fileNo.toLowerCase() !== clientCode.toLowerCase()) {
                rowWarnings.push(`Client code "${clientCode}" doesn't match. Expected: "${matchingClient.fileNo}"`);
              }
            }
            
            // 4. Parent Task validation - must be a valid category
            if (parentTask && !validParentTasks.includes(parentTask.toLowerCase())) {
              rowErrors.push(`Parent Task "${parentTask}" is not a valid task category. Valid options: ${Object.keys(PARENT_CHILD_TASKS).join(', ')}`);
            }
            
            // 5. Child Task validation - must be under the selected parent
            if (parentTask && childTask) {
              const parentKey = Object.keys(PARENT_CHILD_TASKS).find(p => p.toLowerCase() === parentTask.toLowerCase());
              if (parentKey) {
                const validChildren = PARENT_CHILD_TASKS[parentKey].map(c => c.toLowerCase());
                if (!validChildren.includes(childTask.toLowerCase())) {
                  rowErrors.push(`Child Task "${childTask}" is not valid under "${parentTask}". Valid options: ${PARENT_CHILD_TASKS[parentKey].join(', ')}`);
                }
              }
            }
            
            // 6. Task Leader validation - must be Superadmin
            if (taskLeader) {
              if (!validStaff.includes(taskLeader.toLowerCase())) {
                rowErrors.push(`Task Leader "${taskLeader}" not found in staff`);
              } else if (!validSuperadmins.includes(taskLeader.toLowerCase())) {
                rowErrors.push(`Task Leader "${taskLeader}" is not a Superadmin`);
              }
            }
            
            // 7. Task Manager validation - must be Reporting Manager or Superadmin
            if (taskManager) {
              if (!validStaff.includes(taskManager.toLowerCase())) {
                rowErrors.push(`Task Manager "${taskManager}" not found in staff`);
              } else if (!validManagers.includes(taskManager.toLowerCase())) {
                rowErrors.push(`Task Manager "${taskManager}" is not a Reporting Manager or Superadmin`);
              }
            }
            
            // 8. Primary Assigned User validation - must exist in staff
            if (primaryUser) {
              if (!validStaff.includes(primaryUser.toLowerCase())) {
                rowErrors.push(`Assigned User "${primaryUser}" not found in staff`);
              } else {
                // Check if user is under the specified manager
                const userStaff = data.staff.find(s => s.name?.toLowerCase() === primaryUser.toLowerCase());
                const managerStaff = data.staff.find(s => s.name?.toLowerCase() === taskManager.toLowerCase());
                if (userStaff && managerStaff && userStaff.reportingManager && 
                    userStaff.reportingManager.toLowerCase() !== taskManager.toLowerCase() &&
                    managerStaff.role !== 'Superadmin') {
                  rowWarnings.push(`"${primaryUser}" reports to "${userStaff.reportingManager}", not "${taskManager}"`);
                }
              }
            }
            
            // 9. Financial Year validation
            if (financialYear && !validFinancialYears.includes(financialYear.toLowerCase())) {
              rowErrors.push(`Financial Year "${financialYear}" is not valid. Valid options: ${FINANCIAL_YEARS.join(', ')}`);
            }
            
            // 10. Period validation
            if (period && !validPeriods.includes(period.toLowerCase())) {
              rowErrors.push(`Period "${period}" is not valid. Valid options: Monthly, Quarterly, Half-Yearly, Annually`);
            }
            
            // 11. Sub-period validation based on period
            if (subPeriod && period) {
              const periodKey = period.toLowerCase();
              const validSubs = validSubPeriods[periodKey] || [];
              if (validSubs.length > 0 && !validSubs.includes(subPeriod.toLowerCase())) {
                rowErrors.push(`Sub-period "${subPeriod}" is not valid for ${period}. Examples: ${validSubs.slice(0, 5).join(', ')}`);
              }
            }
            
            // ========== COLLECT ERRORS/WARNINGS ==========
            if (rowErrors.length > 0) {
              errors.push({ row: rowNum, errors: rowErrors });
              continue; // Skip this row - it has validation errors
            }
            
            if (rowWarnings.length > 0) {
              warnings.push({ row: rowNum, warnings: rowWarnings });
            }
            
            // ========== BUILD VALID TASK DATA ==========
            // Get proper cased values from system
            const matchingClient = data.clients.find(c => c.name?.toLowerCase() === clientName.toLowerCase());
            const leaderStaff = data.staff.find(s => s.name?.toLowerCase() === taskLeader.toLowerCase());
            const managerStaff = data.staff.find(s => s.name?.toLowerCase() === taskManager.toLowerCase());
            const userStaff = data.staff.find(s => s.name?.toLowerCase() === primaryUser.toLowerCase());
            const parentKey = Object.keys(PARENT_CHILD_TASKS).find(p => p.toLowerCase() === parentTask.toLowerCase());
            const childKey = parentKey ? PARENT_CHILD_TASKS[parentKey].find(c => c.toLowerCase() === childTask.toLowerCase()) : childTask;
            const fyKey = FINANCIAL_YEARS.find(fy => fy.toLowerCase() === financialYear.toLowerCase());
            
            const taskData = {
              clientName: matchingClient?.name || clientName,
              clientId: matchingClient?.id || '',
              fileNo: matchingClient?.fileNo || clientCode || '',
              groupName: getValue('groupname') || matchingClient?.groupName || clientName,
              parentTask: parentKey || parentTask,
              childTask: childKey || childTask,
              financialYear: fyKey || financialYear,
              period: period.charAt(0).toUpperCase() + period.slice(1).toLowerCase(),
              subPeriod: subPeriod || '',
              taskLeader: leaderStaff?.name || taskLeader,
              taskManager: managerStaff?.name || taskManager,
              primaryAssignedUser: userStaff?.name || primaryUser,
              startDate: getValue('startdate') || '',
              expectedCompletionDate: getValue('expecteddateofcompletion') || getValue('expectedcompletiondate') || getValue('expecteddat') || getValue('duedate') || getValue('completiondate') || '',
              description: getValue('taskdescription') || getValue('description') || '',
              _rowNum: rowNum // Track original row for reference
            };
            
            tasks.push(taskData);
          }
          
          // ========== SET RESULTS ==========
          if (errors.length > 0) {
            const errorSummary = errors.slice(0, 10).map(e => 
              `Row ${e.row}: ${e.errors.join('; ')}`
            ).join('\n');
            const moreText = errors.length > 10 ? `\n...and ${errors.length - 10} more errors` : '';
            setBulkError(`âŒ ${errors.length} row(s) have validation errors and will be SKIPPED:\n\n${errorSummary}${moreText}`);
          }
          
          if (warnings.length > 0) {
            const warnSummary = warnings.slice(0, 5).map(w => 
              `Row ${w.row}: ${w.warnings.join('; ')}`
            ).join('\n');
            const moreText = warnings.length > 5 ? `\n...and ${warnings.length - 5} more warnings` : '';
            setBulkWarning(`âš ï¸ ${warnings.length} row(s) have warnings (will still be imported):\n\n${warnSummary}${moreText}`);
          }
          
          if (tasks.length === 0) {
            setBulkError(prev => prev + '\n\nðŸš« No valid tasks to import! Please fix the errors above and try again.');
            return;
          }
          
          setBulkPreview(tasks);
          
          // Success message
          if (errors.length === 0 && warnings.length === 0) {
            setBulkWarning(`âœ… All ${tasks.length} rows validated successfully!`);
          } else if (tasks.length > 0) {
            setBulkWarning(prev => prev + `\n\nâœ… ${tasks.length} valid task(s) ready to import.`);
          }
          
        } catch (err) {
          console.error('CSV Parse Error:', err);
          setBulkError('Error parsing CSV file: ' + err.message);
        }
      };
      reader.readAsText(file);
    };

    // Confirm bulk import
    const [bulkSaving, setBulkSaving] = useState(false);
    
    const confirmBulkImport = async () => {
      console.log('=== confirmBulkImport CALLED ===');
      console.log('bulkPreview length:', bulkPreview.length);
      
      if (bulkPreview.length === 0) {
        alert('No tasks to import!');
        return;
      }
      
      setBulkSaving(true); // Show loading
      
      const newTasks = bulkPreview.map(t => {
        // Combine period and subPeriod if both exist
        let periodDisplay = t.period || '';
        if (t.subPeriod && t.period && t.period !== 'Annual') {
          periodDisplay = `${t.period} - ${t.subPeriod}`;
        }
        
        // IMPORTANT: Every field MUST have a value (use empty string for missing values)
        // Firebase does NOT accept undefined values
        return {
          id: generateId(),
          fileNo: t.fileNo || '',
          clientName: t.clientName || '',
          groupName: t.groupName || t.clientName || '',
          parentTask: t.parentTask || '',
          childTask: t.childTask || '',
          financialYear: t.financialYear || '',
          period: periodDisplay || '',
          subPeriod: t.subPeriod || '',
          taskLeader: t.taskLeader || '',
          taskManager: t.taskManager || '',
          primaryAssignedUser: t.primaryAssignedUser || '',
          assignedTo: t.primaryAssignedUser || '',
          startDate: t.startDate || '',
          expectedCompletionDate: t.expectedCompletionDate || '',
          taskDescription: t.description || '',
          comments: '',
          status: 'Pending',
          priority: 'Medium',
          completedCheck: false,
          completedBy: '',
          currentPosition: 'New Task Created',
          pendingIssues: '',
          checkGroupsName: `${periodDisplay || ''}-${t.childTask || ''}`
        };
      });
      
      console.log('=== BULK IMPORT: Created task objects ===');
      console.log('Tasks created:', newTasks.length);
      console.log('First task sample:', JSON.stringify(newTasks[0], null, 2));
      
      // Extra safety: clean tasks with JSON to remove any undefined
      const cleanTasks = JSON.parse(JSON.stringify(newTasks));
      console.log('Tasks cleaned via JSON, count:', cleanTasks.length);
      
      // Use bulk save callback - it handles everything including Firebase save
      if (onBulkSave) {
        console.log('Calling onBulkSave...');
        try {
          await onBulkSave(cleanTasks);  // AWAIT the async function!
          console.log('onBulkSave completed');
        } catch (err) {
          console.error('onBulkSave error:', err);
          alert('Error during save: ' + err.message);
        }
      } else {
        console.error('onBulkSave callback is undefined!');
        alert('Error: Save function not available. Please refresh and try again.');
        onClose();
      }
      
      setBulkSaving(false); // Hide loading
    };

    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="add-task-modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: activeMode === 'bulk' ? '900px' : '700px' }}>
          <div className="modal-header-task" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
            <h2 style={{ margin: 0 }}><Plus size={24} /> Add New Task</h2>
            <button className="btn-close-modal" onClick={onClose} style={{ position: 'absolute', right: '16px', top: '16px' }}>
              <X size={24} />
            </button>
          </div>
          
          {/* Mode Tabs */}
          <div style={{ display: 'flex', gap: '8px', padding: '0 24px 16px', borderBottom: '1px solid #e2e8f0' }}>
            <button 
              type="button"
              onClick={() => { setActiveMode('single'); setBulkPreview([]); setBulkError(''); }}
              style={{
                padding: '10px 20px',
                background: activeMode === 'single' ? '#10b981' : '#f1f5f9',
                color: activeMode === 'single' ? '#fff' : '#475569',
                border: activeMode === 'single' ? 'none' : '1px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: 600,
                cursor: 'pointer'
              }}
            >
              ðŸ“ Single Task
            </button>
            <button 
              type="button"
              onClick={() => { setActiveMode('bulk'); setShowQuickClientForm(false); }}
              style={{
                padding: '10px 20px',
                background: activeMode === 'bulk' ? '#3b82f6' : '#f1f5f9',
                color: activeMode === 'bulk' ? '#fff' : '#475569',
                border: activeMode === 'bulk' ? 'none' : '1px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: 600,
                cursor: 'pointer'
              }}
            >
              ðŸ“¤ Bulk Upload CSV
            </button>
          </div>

          {/* BULK UPLOAD MODE */}
          {activeMode === 'bulk' && (
            <div style={{ padding: '20px 24px', maxHeight: '70vh', overflowY: 'auto' }}>
              {/* Instructions - Compact */}
              <div style={{ 
                background: '#f0f9ff', 
                border: '1px solid #bae6fd', 
                borderRadius: '8px', 
                padding: '12px 16px',
                marginBottom: '16px'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '12px' }}>
                  <div style={{ flex: 1, minWidth: '300px' }}>
                    <h4 style={{ margin: '0 0 6px 0', color: '#0369a1', fontSize: '13px' }}>
                      ðŸ“‹ Required Columns
                    </h4>
                    <code style={{ background: '#e0f2fe', padding: '4px 8px', borderRadius: '4px', fontSize: '11px', display: 'inline-block' }}>
                      clientName, parentTask, childTask, financialYear, period, taskLeader, taskManager, primaryAssignedUser
                    </code>
                  </div>
                  <button
                    type="button"
                    onClick={downloadSampleTaskCSV}
                    style={{
                      padding: '8px 14px',
                      background: '#059669',
                      color: '#fff',
                      border: 'none',
                      borderRadius: '6px',
                      fontSize: '12px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      whiteSpace: 'nowrap'
                    }}
                  >
                    <Download size={14} /> Download Sample
                  </button>
                </div>
              </div>

              {/* File Upload Area - Always visible */}
              <div style={{
                border: bulkPreview.length > 0 ? '2px solid #10b981' : '2px dashed #cbd5e1',
                borderRadius: '8px',
                padding: '16px 20px',
                background: bulkPreview.length > 0 ? '#f0fdf4' : '#f8fafc',
                marginBottom: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                flexWrap: 'wrap'
              }}>
                <Upload size={24} style={{ color: bulkPreview.length > 0 ? '#10b981' : '#94a3b8' }} />
                <div style={{ flex: 1 }}>
                  <input
                    type="file"
                    accept=".csv,.txt"
                    onChange={handleTaskFileUpload}
                    style={{
                      padding: '8px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      width: '100%',
                      maxWidth: '280px'
                    }}
                  />
                </div>
                {bulkPreview.length > 0 && (
                  <span style={{ color: '#10b981', fontWeight: '600', fontSize: '13px' }}>
                    âœ“ {bulkPreview.length} tasks ready to import
                  </span>
                )}
              </div>

              {/* Error */}
              {bulkError && (
                <div style={{
                  padding: '12px',
                  background: '#fef2f2',
                  border: '1px solid #fecaca',
                  borderRadius: '8px',
                  color: '#dc2626',
                  marginBottom: '12px',
                  maxHeight: '150px',
                  overflowY: 'auto'
                }}>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                    <AlertCircle size={18} style={{ flexShrink: 0, marginTop: '2px' }} />
                    <pre style={{ 
                      margin: 0, 
                      fontFamily: 'inherit', 
                      fontSize: '12px', 
                      whiteSpace: 'pre-wrap',
                      wordBreak: 'break-word'
                    }}>{bulkError}</pre>
                  </div>
                </div>
              )}

              {/* Warning/Success */}
              {bulkWarning && (
                <div style={{
                  padding: '12px',
                  background: bulkWarning.includes('âœ…') ? '#f0fdf4' : '#fffbeb',
                  border: `1px solid ${bulkWarning.includes('âœ…') ? '#86efac' : '#fcd34d'}`,
                  borderRadius: '8px',
                  color: bulkWarning.includes('âœ…') ? '#166534' : '#92400e',
                  marginBottom: '12px',
                  maxHeight: '120px',
                  overflowY: 'auto'
                }}>
                  <pre style={{ 
                    margin: 0, 
                    fontFamily: 'inherit', 
                    fontSize: '12px', 
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word'
                  }}>{bulkWarning}</pre>
                </div>
              )}

              {/* Preview Table & Import Button */}
              {bulkPreview.length > 0 && (
                <div>
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center', 
                    marginBottom: '10px',
                    padding: '10px 12px',
                    background: '#f0fdf4',
                    borderRadius: '8px',
                    border: '1px solid #86efac'
                  }}>
                    <h4 style={{ margin: 0, color: '#166534', fontSize: '14px' }}>
                      ðŸ“‹ Preview: {bulkPreview.length} tasks ready
                    </h4>
                    <div style={{ display: 'flex', gap: '10px' }}>
                      <button
                        type="button"
                        onClick={() => { setBulkPreview([]); setBulkError(''); setBulkWarning(''); }}
                        style={{
                          padding: '8px 16px',
                          background: '#f1f5f9',
                          color: '#475569',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '500'
                        }}
                      >
                        Cancel
                      </button>
                      <button
                        type="button"
                        disabled={bulkSaving}
                        onClick={() => {
                          console.log('=== IMPORT & SAVE BUTTON CLICKED ===');
                          confirmBulkImport();
                        }}
                        style={{
                          padding: '8px 20px',
                          background: bulkSaving ? '#9ca3af' : '#10b981',
                          color: '#fff',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: bulkSaving ? 'wait' : 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px',
                          fontWeight: 600,
                          fontSize: '13px'
                        }}
                      >
                        {bulkSaving ? (
                          <>â³ Saving...</>
                        ) : (
                          <><CheckCircle size={16} /> Import & Save {bulkPreview.length} Tasks</>
                        )}
                      </button>
                    </div>
                  </div>
                  
                  <div style={{ maxHeight: '250px', overflow: 'auto', border: '1px solid #e2e8f0', borderRadius: '8px' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '11px' }}>
                      <thead style={{ background: 'linear-gradient(180deg, #10b981 0%, #059669 100%)', position: 'sticky', top: 0 }}>
                        <tr>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>#</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Client</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Parent</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Child</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>FY</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Period</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Manager</th>
                          <th style={{ padding: '8px 6px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase' }}>Assigned</th>
                        </tr>
                      </thead>
                      <tbody>
                        {bulkPreview.map((task, idx) => (
                          <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9', background: idx % 2 === 0 ? '#fff' : '#f8fafc' }}>
                            <td style={{ padding: '6px' }}>{idx + 1}</td>
                            <td style={{ padding: '6px', fontWeight: '500' }}>{task.clientName}</td>
                            <td style={{ padding: '6px' }}><span style={{ background: '#dcfce7', padding: '2px 6px', borderRadius: '4px', fontSize: '10px' }}>{task.parentTask}</span></td>
                            <td style={{ padding: '6px' }}>{task.childTask}</td>
                            <td style={{ padding: '6px' }}>{task.financialYear}</td>
                            <td style={{ padding: '6px' }}>{task.period}</td>
                            <td style={{ padding: '6px', color: '#059669', fontWeight: 500 }}>{task.taskManager}</td>
                            <td style={{ padding: '6px', color: '#7c3aed', fontWeight: 500 }}>{task.primaryAssignedUser}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* SINGLE TASK MODE */}
          {activeMode === 'single' && showQuickClientForm ? (
            <QuickAddClientForm
              onClose={() => setShowQuickClientForm(false)}
              onSave={handleQuickAddClient}
            />
          ) : activeMode === 'single' && (
            <form onSubmit={handleSubmit} className="add-task-form">
              <div className="form-grid-task">
                {/* Client Selection - Searchable */}
                <div className="form-field-task" style={{ position: 'relative' }}>
                  <label>
                    Select Client <span className="required-star">*</span>
                    <span style={{fontSize: '11px', color: '#64748b', fontWeight: 'normal', marginLeft: '8px'}}>
                      ({data.clients.filter(c => !c.disabled).length} clients available)
                    </span>
                  </label>
                  <input
                    type="text"
                    value={clientSearchTerm}
                    onChange={(e) => {
                      setClientSearchTerm(e.target.value);
                      setShowClientDropdown(true);
                      if (!e.target.value) {
                        setTaskFormData(prev => ({
                          ...prev,
                          clientId: '',
                          clientName: '',
                          groupName: '',
                          fileNo: ''
                        }));
                      }
                    }}
                    onFocus={() => setShowClientDropdown(true)}
                    placeholder="Type to search client by name or code..."
                    style={{ width: '100%' }}
                  />
                  {showClientDropdown && (
                    <div style={{
                      position: 'absolute',
                      top: '100%',
                      left: 0,
                      right: 0,
                      background: '#fff',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      maxHeight: '200px',
                      overflowY: 'auto',
                      zIndex: 1000,
                      boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                    }}>
                      {filteredClients.length > 0 ? (
                        <>
                          {filteredClients.slice(0, 10).map(client => (
                            <div
                              key={client.id}
                              onClick={() => handleClientSelectFromSearch(client)}
                              style={{
                                padding: '10px 12px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f1f5f9',
                                fontSize: '13px'
                              }}
                              onMouseEnter={(e) => e.target.style.background = '#f0fdf4'}
                              onMouseLeave={(e) => e.target.style.background = '#fff'}
                            >
                              <div style={{ fontWeight: 600 }}>{client.name}</div>
                              {client.fileNo && <div style={{ fontSize: '11px', color: '#64748b' }}>Code: {formatFileNo(client.fileNo)}</div>}
                            </div>
                          ))}
                          {filteredClients.length > 10 && (
                            <div style={{ padding: '8px 12px', fontSize: '11px', color: '#64748b', textAlign: 'center' }}>
                              +{filteredClients.length - 10} more results...
                            </div>
                          )}
                        </>
                      ) : (
                        <div style={{ padding: '12px', textAlign: 'center', color: '#64748b', fontSize: '13px' }}>
                          No clients found
                        </div>
                      )}
                      <div
                        onClick={() => { setShowQuickClientForm(true); setShowClientDropdown(false); }}
                        style={{
                          padding: '10px 12px',
                          cursor: 'pointer',
                          background: '#f0fdf4',
                          color: '#10b981',
                          fontWeight: 600,
                          fontSize: '13px',
                          borderTop: '1px solid #e2e8f0'
                        }}
                      >
                        + Add New Client
                      </div>
                    </div>
                  )}
                  {showClientDropdown && (
                    <div 
                      style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 999 }}
                      onClick={() => setShowClientDropdown(false)}
                    />
                  )}
                </div>

                {/* Client Name (Auto-filled, read-only) */}
                <div className="form-field-task">
                  <label>Client Name <span className="required-star">*</span></label>
                  <input
                    type="text"
                    value={taskFormData.clientName}
                    readOnly
                    placeholder="Select client first"
                    style={{background: '#f8fafc', cursor: 'not-allowed'}}
                  />
                </div>

                {/* Group No. (Auto-filled, read-only) */}
                <div className="form-field-task">
                  <label>Group No. <span className="required-star">*</span></label>
                  <input
                    type="text"
                    value={taskFormData.groupName}
                    readOnly
                    placeholder="Auto-filled from client"
                    style={{background: '#f8fafc', cursor: 'not-allowed'}}
                  />
                </div>

                {/* Client Code (Auto-filled, read-only) */}
                <div className="form-field-task">
                  <label>Client Code</label>
                  <input
                    type="text"
                    value={taskFormData.fileNo}
                    readOnly
                    placeholder="Auto-filled from client"
                    style={{background: '#f8fafc', cursor: 'not-allowed'}}
                  />
                </div>

                {/* Parent Task - Simple Dropdown */}
                <div className="form-field-task">
                  <label>Parent Task <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.parentTask}
                    onChange={(e) => {
                      const parent = e.target.value;
                      setTaskFormData(prev => ({ 
                        ...prev, 
                        parentTask: parent,
                        childTask: '' // Reset child task when parent changes
                      }));
                    }}
                    required
                  >
                    <option value="">Select Parent Task</option>
                    {Object.keys(PARENT_CHILD_TASKS).map(parent => (
                      <option key={parent} value={parent}>{parent}</option>
                    ))}
                  </select>
                </div>

                {/* Child Task - Simple Dropdown */}
                <div className="form-field-task">
                  <label>Child Task <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.childTask}
                    onChange={(e) => setTaskFormData(prev => ({ ...prev, childTask: e.target.value }))}
                    required
                    disabled={!taskFormData.parentTask}
                  >
                    <option value="">Select Child Task</option>
                    {taskFormData.parentTask && PARENT_CHILD_TASKS[taskFormData.parentTask]?.map(child => (
                      <option key={child} value={child}>{child}</option>
                    ))}
                  </select>
                </div>

                {/* Financial Year */}
                <div className="form-field-task">
                  <label>Financial Year <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.financialYear}
                    onChange={(e) => setTaskFormData({ ...taskFormData, financialYear: e.target.value })}
                    required
                  >
                    <option value="">Select Financial Year</option>
                    {financialYears.map(fy => (
                      <option key={fy} value={fy}>{fy}</option>
                    ))}
                  </select>
                </div>

                {/* Period */}
                <div className="form-field-task">
                  <label>Period <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.period}
                    onChange={(e) => setTaskFormData({ ...taskFormData, period: e.target.value, subPeriod: '' })}
                    required
                  >
                    <option value="">Select Period</option>
                    {periods.map(period => (
                      <option key={period} value={period}>{period}</option>
                    ))}
                  </select>
                </div>

                {/* Sub-Period - Based on Period selection */}
                {taskFormData.period && taskFormData.period !== 'Annual' && (
                  <div className="form-field-task">
                    <label>Sub-Period <span className="required-star">*</span></label>
                    <select
                      value={taskFormData.subPeriod}
                      onChange={(e) => setTaskFormData({ ...taskFormData, subPeriod: e.target.value })}
                      required
                    >
                      <option value="">Select Sub-Period</option>
                      {getSubPeriodOptions().map(sp => (
                        <option key={sp} value={sp}>{sp}</option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Task Leader - Always Superadmin */}
                <div className="form-field-task">
                  <label>Task Leader <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.taskLeader}
                    onChange={(e) => setTaskFormData({ ...taskFormData, taskLeader: e.target.value })}
                    required
                  >
                    <option value="">Select Task Leader</option>
                    {data.staff.filter(s => s.role === 'Superadmin' && s.status === 'Active').map(s => (
                      <option key={s.id} value={s.name}>{s.name} (Superadmin)</option>
                    ))}
                  </select>
                </div>

                {/* Task Manager - Only Reporting Managers */}
                <div className="form-field-task">
                  <label>Task Manager <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.taskManager}
                    onChange={(e) => setTaskFormData({ ...taskFormData, taskManager: e.target.value, primaryAssignedUser: '' })}
                    required
                  >
                    <option value="">Select Task Manager</option>
                    {data.staff.filter(s => s.role === 'Reporting Manager' && s.status === 'Active').map(s => (
                      <option key={s.id} value={s.name}>{s.name}</option>
                    ))}
                  </select>
                </div>

                {/* Primary Assigned User - Staff mapped under selected Task Manager */}
                <div className="form-field-task">
                  <label>Primary Assigned User <span className="required-star">*</span></label>
                  <select
                    value={taskFormData.primaryAssignedUser}
                    onChange={(e) => setTaskFormData({ ...taskFormData, primaryAssignedUser: e.target.value })}
                    required
                    disabled={!taskFormData.taskManager}
                    style={!taskFormData.taskManager ? { background: '#f1f5f9', cursor: 'not-allowed' } : {}}
                  >
                    <option value="">{taskFormData.taskManager ? 'Select Assigned User' : 'Select Task Manager first'}</option>
                    {taskFormData.taskManager && data.staff
                      .filter(s => 
                        s.reportingManager === taskFormData.taskManager && 
                        s.status === 'Active' &&
                        (s.role === 'Seniors' || s.role === 'Articles')
                      )
                      .map(s => (
                        <option key={s.id} value={s.name}>{s.name} ({s.role})</option>
                      ))
                    }
                    {taskFormData.taskManager && 
                      data.staff.filter(s => s.reportingManager === taskFormData.taskManager && s.status === 'Active').length === 0 && (
                      <option value="" disabled>No staff mapped under this manager</option>
                    )}
                  </select>
                  {taskFormData.taskManager && 
                    data.staff.filter(s => s.reportingManager === taskFormData.taskManager && s.status === 'Active').length === 0 && (
                    <p style={{ color: '#dc2626', fontSize: '11px', marginTop: '4px' }}>
                      No staff assigned to {taskFormData.taskManager}. Please assign staff to this manager first.
                    </p>
                  )}
                </div>

                {/* Start Date */}
                <div className="form-field-task">
                  <label>Start Date</label>
                  <input
                    type="date"
                    value={taskFormData.startDate}
                    onChange={(e) => setTaskFormData({ ...taskFormData, startDate: e.target.value })}
                  />
                </div>

                {/* Expected Completion Date */}
                <div className="form-field-task">
                  <label>Expected Date of Completion</label>
                  <input
                    type="date"
                    value={taskFormData.expectedCompletionDate}
                    onChange={(e) => setTaskFormData({ ...taskFormData, expectedCompletionDate: e.target.value })}
                  />
                </div>

                {/* Task Description */}
                <div className="form-field-task full-width">
                  <label>Task Description</label>
                  <textarea
                    rows="3"
                    value={taskFormData.taskDescription}
                    onChange={(e) => setTaskFormData({ ...taskFormData, taskDescription: e.target.value })}
                    placeholder="Enter task description"
                  />
                </div>

                {/* Comments */}
                <div className="form-field-task full-width">
                  <label>Comments</label>
                  <textarea
                    rows="2"
                    value={taskFormData.comments}
                    onChange={(e) => setTaskFormData({ ...taskFormData, comments: e.target.value })}
                    placeholder="Add any comments"
                  />
                </div>
              </div>

              <div className="modal-footer-task">
                <button type="button" className="btn-cancel" onClick={onClose}>
                  Cancel
                </button>
                <button 
                  type="button" 
                  className="btn-primary"
                  onClick={(e) => {
                    console.log('=== CREATE TASK BUTTON CLICKED ===');
                    handleSubmit(e);
                  }}
                >
                  <CheckCircle size={20} />
                  Create Task
                </button>
              </div>
            </form>
          )}
        </div>
      </div>
    );
  };

  // Quick Add Client Form (Compact version)
  const QuickAddClientForm = ({ onClose, onSave }) => {
    // Helper functions for Client Code validation (same as main form)
    const getLastClientCode = (groupCode) => {
      const groupClients = data.clients.filter(c => c.fileNo && c.fileNo.startsWith(groupCode + '.'));
      if (groupClients.length === 0) return null;
      
      const codes = groupClients.map(c => {
        const parts = c.fileNo.split('.');
        return parts.length === 2 ? parseInt(parts[1]) : 0;
      }).filter(n => !isNaN(n));
      
      return codes.length > 0 ? Math.max(...codes) : 0;
    };
    
    const validateClientCode = (code) => {
      if (!code) return { valid: false, message: 'Client Code is required' };
      
      const parts = code.split('.');
      if (parts.length !== 2) {
        return { valid: false, message: 'Format must be: GroupCode.ClientNo (e.g., 1.01)' };
      }
      
      const [groupCode, clientNo] = parts;
      if (!groupCode || !clientNo) {
        return { valid: false, message: 'Invalid Client Code format' };
      }
      
      // Check if code already exists
      const exists = data.clients.some(c => c.fileNo === code);
      if (exists) {
        return { valid: false, message: 'Client Code already exists!' };
      }
      
      // Check if client no is in sequence
      const lastCode = getLastClientCode(groupCode);
      if (lastCode !== null) {
        const currentNum = parseInt(clientNo);
        if (isNaN(currentNum)) {
          return { valid: false, message: 'Client number must be numeric' };
        }
        
        if (currentNum <= lastCode) {
          return { 
            valid: false, 
            message: `Must be ${groupCode}.${String(lastCode + 1).padStart(2, '0')} or higher`
          };
        }
      }
      
      return { valid: true, message: '' };
    };

    const [quickClientData, setQuickClientData] = useState({
      fileNo: '',
      clientName: '',
      groupName: '',
      email: '',
      phone: ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();

      console.log('=== QUICK ADD CLIENT FORM SUBMITTED ===');
      console.log('Quick client data:', quickClientData);

      // Validate Client Code
      const codeValidation = validateClientCode(quickClientData.fileNo);
      if (!codeValidation.valid) {
        alert('âš ï¸ ' + codeValidation.message);
        return;
      }

      if (!quickClientData.clientName) {
        alert('Client Name is required!');
        return;
      }

      const newClient = {
        id: generateId(),
        fileNo: quickClientData.fileNo.trim(),
        name: quickClientData.clientName.trim(),
        groupName: quickClientData.groupName.trim(), // Already auto-generated
        email: quickClientData.email.trim() || '',
        phone: quickClientData.phone.trim() || '',
        address: '',
        gstin: '',
        pan: '',
        aadhaar: '',
        state: '',
        typeOfClient: '',
        fixedAssignedUser: '',
        clientIncharge: '',
        dateOfEnrollment: new Date().toISOString().split('T')[0],
        isOutOfIndia: false,
        country: '',
        notes: '',
        disabled: false,
        services: [],
        outstanding: 0
      };

      console.log('New client object created:', newClient);
      console.log('Calling onSave with new client...');
      
      onSave(newClient);
      
      console.log('onSave called successfully');
    };

    return (
      <div className="quick-client-form">
        <div className="quick-form-header">
          <h3><User size={20} /> Quick Add Client</h3>
          <p>Add essential client details</p>
        </div>

        <form onSubmit={handleSubmit} className="quick-form-body">
          <div className="form-field-task">
            <label>
              Client Code <span className="required-star">*</span>
              <span 
                className="info-icon-task"
                title={(() => {
                  const code = quickClientData.fileNo;
                  if (!code) return 'Format: GroupCode.ClientNo (e.g., 1.01)';
                  const parts = code.split('.');
                  if (parts.length === 2) {
                    const groupCode = parts[0];
                    const lastCode = getLastClientCode(groupCode);
                    if (lastCode) {
                      return `Last Client Code in Group ${groupCode}: ${groupCode}.${String(lastCode).padStart(2, '0')}`;
                    }
                    return `First client in Group ${groupCode}`;
                  }
                  return 'Format: GroupCode.ClientNo';
                })()}
                style={{
                  marginLeft: '6px',
                  cursor: 'help',
                  color: '#10b981',
                  fontWeight: 'bold'
                }}
              >
                â“˜
              </span>
            </label>
            <input
              type="text"
              value={quickClientData.fileNo}
              onChange={(e) => {
                const newCode = e.target.value;
                setQuickClientData({ ...quickClientData, fileNo: newCode });
              }}
              onBlur={() => {
                const validation = validateClientCode(quickClientData.fileNo);
                if (!validation.valid && quickClientData.fileNo) {
                  alert('âš ï¸ ' + validation.message);
                }
              }}
              placeholder="e.g., 1.01, 2.15"
              required
              style={{
                borderColor: (() => {
                  if (!quickClientData.fileNo) return '';
                  const validation = validateClientCode(quickClientData.fileNo);
                  return validation.valid ? '#10b981' : '#ef4444';
                })()
              }}
            />
            {quickClientData.fileNo && (() => {
              const validation = validateClientCode(quickClientData.fileNo);
              return validation.valid ? (
                <small style={{color: '#10b981', fontSize: '11px'}}>âœ“ Valid</small>
              ) : (
                <small style={{color: '#ef4444', fontSize: '11px'}}>{validation.message}</small>
              );
            })()}
          </div>

          <div className="form-field-task">
            <label>Client Name <span className="required-star">*</span></label>
            <input
              type="text"
              value={quickClientData.clientName}
              onChange={(e) => {
                const newName = e.target.value;
                const code = quickClientData.fileNo;
                let newGroupName = quickClientData.groupName;
                
                // Auto-generate group name: Client Name (Group Code)
                if (code && newName) {
                  const parts = code.split('.');
                  if (parts.length === 2) {
                    const groupCode = parts[0];
                    newGroupName = `${newName} (${groupCode})`;
                  }
                }
                
                setQuickClientData({
                  ...quickClientData,
                  clientName: newName,
                  groupName: newGroupName
                });
              }}
              placeholder="Enter client name"
              required
            />
          </div>

          <div className="form-field-task">
            <label>
              Group No. 
              <small style={{color: '#64748b', fontWeight: 'normal', marginLeft: '8px'}}>
                (Auto: Client Name (Group Code))
              </small>
            </label>
            <input
              type="text"
              value={quickClientData.groupName}
              readOnly
              style={{
                background: '#f8fafc',
                cursor: 'not-allowed'
              }}
              placeholder="Will be auto-generated"
            />
          </div>

          <div className="form-field-task">
            <label>Email</label>
            <input
              type="email"
              value={quickClientData.email}
              onChange={(e) => setQuickClientData({ ...quickClientData, email: e.target.value })}
              placeholder="client@example.com"
            />
          </div>

          <div className="form-field-task">
            <label>Phone</label>
            <input
              type="tel"
              value={quickClientData.phone}
              onChange={(e) => setQuickClientData({ ...quickClientData, phone: e.target.value })}
              placeholder="+91 98765 43210"
            />
          </div>

          <div className="quick-form-actions">
            <button type="button" className="btn-cancel" onClick={onClose}>
              Cancel
            </button>
            <button 
              type="button" 
              className="btn-primary"
              onClick={(e) => {
                console.log('Add Client button clicked!');
                handleSubmit(e);
              }}
            >
              <CheckCircle size={18} />
              Add Client
            </button>
          </div>
        </form>
      </div>
    );
  };

  // ==================== INVOICING MODULE ====================
  
  // Invoicing View - Main Component
  const InvoicingView = () => {
    // Use the selectedInvoicingTab from parent state, default to 'dashboard' if not set
    const activeTab = selectedInvoicingTab || 'dashboard';
    const [showOrgModal, setShowOrgModal] = useState(false);
    const [editingOrg, setEditingOrg] = useState(null);
    
    // Dashboard States
    const [dashboardFY, setDashboardFY] = useState('FY 2024-25');
    const [dashboardTab, setDashboardTab] = useState('summary'); // 'summary', 'billRegister', 'receiptRegister'
    const [billRegisterFilters, setBillRegisterFilters] = useState({
      fromDate: '',
      toDate: '',
      organizationId: '',
      clientName: '',
      parentTask: '',
      childTask: '',
      status: ''
    });
    const [receiptRegisterFilters, setReceiptRegisterFilters] = useState({
      fromDate: '',
      toDate: '',
      organizationId: '',
      clientName: '',
      parentTask: '',
      childTask: ''
    });
    const [viewingDashboardInvoice, setViewingDashboardInvoice] = useState(null);
    const [viewingDashboardReceipt, setViewingDashboardReceipt] = useState(null);
    const [selectedBillIds, setSelectedBillIds] = useState([]);
    const [selectedReceiptIds, setSelectedReceiptIds] = useState([]);
    const [showBulkDownloadModal, setShowBulkDownloadModal] = useState(false);
    const [bulkDownloadItems, setBulkDownloadItems] = useState([]);
    const [bulkDownloadType, setBulkDownloadType] = useState('bills'); // 'bills' or 'receipts'
    
    // Unbilled Tasks States
    const [unbilledTasksTab, setUnbilledTasksTab] = useState('unbilled'); // 'unbilled', 'free'
    const [unbilledFilters, setUnbilledFilters] = useState({
      clientName: '',
      clientCode: '',
      parentTask: '',
      childTask: '',
      financialYear: '',
      period: '',
      status: '',
      reportingManager: ''
    });
    const [unbilledSelectedIds, setUnbilledSelectedIds] = useState([]);
    const [showUnbilledInvoiceModal, setShowUnbilledInvoiceModal] = useState(false);
    const [unbilledInvoiceDate, setUnbilledInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
    const [unbilledTaskDetails, setUnbilledTaskDetails] = useState({}); // {taskId: {orgId, amount, tax}}
    const [viewingUnbilledTask, setViewingUnbilledTask] = useState(null); // Task being viewed
    
    // Billing States
    const [billingMode, setBillingMode] = useState('single'); // 'single', 'multiple', 'bulk'
    const [singleTaskMode, setSingleTaskMode] = useState('withTask'); // 'withTask', 'withoutTask'
    const [billingSearchFilters, setBillingSearchFilters] = useState({
      groupName: '',
      clientName: '',
      clientCode: '',
      parentTask: '',
      childTask: '',
      financialYear: '',
      period: '',
      status: ''
    });
    const [searchedTasks, setSearchedTasks] = useState([]);
    const [hasSearched, setHasSearched] = useState(false);
    const [selectedBillingTask, setSelectedBillingTask] = useState(null);
    const [filteredClients, setFilteredClients] = useState([]);
    
    // Without Task Invoice Form States
    const [withoutTaskForm, setWithoutTaskForm] = useState({
      clientId: '',
      clientName: '',
      clientCode: '',
      groupName: '',
      organizationId: '',
      invoiceDate: new Date().toISOString().split('T')[0],
      narration: '',
      amount: '',
      discount: '',
      remark: ''
    });
    const [showWithoutTaskClientSuggestions, setShowWithoutTaskClientSuggestions] = useState(false);
    const [showWithoutTaskGroupSuggestions, setShowWithoutTaskGroupSuggestions] = useState(false);
    
    // Bulk Invoices Log States
    const [viewingBulkBatch, setViewingBulkBatch] = useState(null);
    const [bulkLogViewMode, setBulkLogViewMode] = useState('list'); // 'list', 'detail'
    
    // Latest Invoices Filters
    const [latestInvoiceFilters, setLatestInvoiceFilters] = useState({
      invoiceNo: '',
      clientName: '',
      clientCode: '',
      organizationId: '',
      fromDate: '',
      toDate: '',
      minAmount: '',
      maxAmount: ''
    });
    
    // Multiple Task Billing States
    const [multipleTaskFilters, setMultipleTaskFilters] = useState({
      clientName: '',
      clientCode: '',
      groupName: '',
      invoiceType: 'taskWise' // 'taskWise' or 'combined'
    });
    const [multipleTaskClient, setMultipleTaskClient] = useState(null);
    const [multipleTaskSelectedTasks, setMultipleTaskSelectedTasks] = useState([]);
    const [multipleTaskTempSelected, setMultipleTaskTempSelected] = useState([]);
    const [multipleTaskLineItems, setMultipleTaskLineItems] = useState([]);
    const [multipleTaskOrgId, setMultipleTaskOrgId] = useState('');
    const [multipleTaskInvoiceDate, setMultipleTaskInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
    const [multipleTaskInvoiceNo, setMultipleTaskInvoiceNo] = useState('');
    const [multipleTaskClientBilling, setMultipleTaskClientBilling] = useState([]); // Client-wise billing data
    const [multipleTaskBillingStep, setMultipleTaskBillingStep] = useState('group'); // 'group', 'clients', 'tasks', or 'billing'
    const [multipleTaskSelectedClients, setMultipleTaskSelectedClients] = useState([]); // Selected clients for billing
    const [showClientSuggestions, setShowClientSuggestions] = useState(false);
    const [showCodeSuggestions, setShowCodeSuggestions] = useState(false);
    const [showMultipleTaskGroupSuggestions, setShowMultipleTaskGroupSuggestions] = useState(false);
    
    // Autocomplete states
    const [showClientNameSuggestions, setShowClientNameSuggestions] = useState(false);
    const [showGroupNameSuggestions, setShowGroupNameSuggestions] = useState(false);
    const [clientNameSuggestions, setClientNameSuggestions] = useState([]);
    const [groupNameSuggestions, setGroupNameSuggestions] = useState([]);
    
    // Debtors states
    const [debtorFilters, setDebtorFilters] = useState({
      clientName: '',
      clientCode: '',
      groupName: '',
      fromDate: '',
      toDate: '',
      balanceType: 'all' // 'all', 'pending', 'cleared'
    });
    const [selectedDebtor, setSelectedDebtor] = useState(null);
    const [debtorViewMode, setDebtorViewMode] = useState('list'); // 'list', 'ledger', 'invoice', 'receipt'
    const [viewingReceipt, setViewingReceipt] = useState(null);
    const [showDebtorSuggestions, setShowDebtorSuggestions] = useState(false);
    const [debtorSuggestions, setDebtorSuggestions] = useState([]);
    const [viewingInvoice, setViewingInvoice] = useState(null);
    const [editingInvoiceData, setEditingInvoiceData] = useState(null);
    const [showEditInvoiceModal, setShowEditInvoiceModal] = useState(false);
    
    // Receipt states
    const [receiptMode, setReceiptMode] = useState('post'); // 'post', 'view'
    const [receiptFilters, setReceiptFilters] = useState({
      groupName: '',
      clientName: '',
      fromDate: '',
      toDate: ''
    });
    const [selectedClientsForReceipt, setSelectedClientsForReceipt] = useState([]);
    const [receiptFormData, setReceiptFormData] = useState({
      receiptDate: new Date().toISOString().split('T')[0],
      narration: '',
      organizationId: ''
    });
    const [invoiceReceiptAmounts, setInvoiceReceiptAmounts] = useState({});
    const [showReceiptSummary, setShowReceiptSummary] = useState(false);
    const [generatedReceipts, setGeneratedReceipts] = useState([]);
    
    // Bulk Task Billing States
    const [bulkTaskStep, setBulkTaskStep] = useState('filter'); // 'filter', 'select', 'billing', 'batches'
    const [bulkTaskFilters, setBulkTaskFilters] = useState({
      parentTask: '',
      childTask: '',
      financialYear: '',
      period: '',
      subPeriod: '',
      status: 'Completed',
      groupNo: ''
    });
    const [bulkFilteredTasks, setBulkFilteredTasks] = useState([]);
    const [bulkSelectedTaskIds, setBulkSelectedTaskIds] = useState([]);
    const [bulkBillingData, setBulkBillingData] = useState([]);
    const [bulkInvoiceDate, setBulkInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
    const [bulkBatches, setBulkBatches] = useState([]);
    const [bulkSearchTerm, setBulkSearchTerm] = useState('');
    const [bulkOriginalTasks, setBulkOriginalTasks] = useState([]);
    
    // Bulk Post Bill Handler Function
    const handleBulkPostBill = () => {
      const bills = bulkBillingData.filter(b => b.selected);
      
      if (bills.length === 0) {
        alert('No bills selected! Please check the checkboxes in the table.');
        return;
      }
      
      // Check organization
      const noOrg = bills.filter(b => !b.organizationId);
      if (noOrg.length > 0) {
        alert('Missing Organization for ' + noOrg.length + ' bill(s). Please use "Apply to All" or select individually.');
        return;
      }
      
      // Check amount
      const noAmt = bills.filter(b => !b.amount || Number(b.amount) <= 0);
      if (noAmt.length > 0) {
        alert('Zero or empty Amount for ' + noAmt.length + ' bill(s). Please enter valid amounts.');
        return;
      }
      
      if (!confirm('Create ' + bills.length + ' invoices?')) return;
      
      const batchId = 'BATCH-' + Date.now();
      const invoices = [];
      const counters = {};
      
      for (let idx = 0; idx < bills.length; idx++) {
        const bill = bills[idx];
        const org = (data.organizations || []).find(o => String(o.id) === String(bill.organizationId));
        if (!org) continue;
        
        if (!counters[org.id]) {
          const last = (data.invoices || [])
            .filter(i => String(i.organizationId) === String(org.id))
            .sort((a,b) => (b.invoiceCurrentNo||0) - (a.invoiceCurrentNo||0))[0];
          counters[org.id] = (last?.invoiceCurrentNo || org.invoiceStartNo || 0) + 1;
        }
        
        const num = counters[org.id];
        counters[org.id] = num + 1;
        
        const invNo = (org.invoicePrefix||'INV') + String(num).padStart(org.invoiceDigits||4,'0') + (org.invoiceSuffix||'');
        const client = (data.clients || []).find(c => c.name === bill.clientName);
        const amt = Number(bill.amount) || 0;
        const disc = Number(bill.discount) || 0;
        const net = amt - disc;
        
        let cgst=0, sgst=0, igst=0;
        if (org.gstApplicable === 'yes' && net > 0) {
          const orgSt = (org.state||'').toLowerCase();
          const cliSt = (client?.state||'').toLowerCase();
          if (orgSt && cliSt && orgSt === cliSt) { 
            cgst = Math.round(net * 0.09 * 100) / 100; 
            sgst = Math.round(net * 0.09 * 100) / 100; 
          } else { 
            igst = Math.round(net * 0.18 * 100) / 100; 
          }
        }
        const total = net + cgst + sgst + igst;
        
        invoices.push({
          id: 'INV-' + Date.now() + '-' + idx,
          batchId: batchId,
          invoiceNo: invNo,
          invoiceDate: bulkInvoiceDate,
          invoiceCurrentNo: num,
          organizationId: org.id,
          orgName: org.name,
          organizationName: org.name,
          orgAddress: org.address || '',
          orgState: org.state || '',
          orgGstin: org.gstin || '',
          orgPan: org.panNo || '',
          taskId: bill.taskId,
          clientName: bill.clientName,
          clientCode: bill.clientCode || '',
          clientAddress: client?.address || '',
          clientState: client?.state || '',
          clientGstin: client?.gstin || '',
          serviceDescription: bill.narration,
          narration: bill.narration,
          parentTask: bill.parentTask || '',
          taskType: bill.taskType,
          financialYear: bill.financialYear,
          period: bill.subPeriod || bill.period,
          sac: '998231',
          amount: amt,
          discount: disc,
          netAmount: net,
          gstApplicable: org.gstApplicable === 'yes',
          cgst: cgst,
          sgst: sgst,
          igst: igst,
          totalAmount: total,
          amountInWords: numberToWords(Math.round(total)) + ' Only.',
          createdAt: new Date().toISOString(),
          status: 'Generated'
        });
      }
      
      if (invoices.length === 0) {
        alert('No invoices could be created!');
        return;
      }
      
      // Update state
      setData(prev => ({
        ...prev,
        invoices: [...(prev.invoices || []), ...invoices],
        tasks: (prev.tasks || []).map(t => {
          const inv = invoices.find(i => String(i.taskId) === String(t.id));
          return inv ? {...t, billed: true, invoiceId: inv.id} : t;
        })
      }));
      
      // Create batch
      const batch = {
        id: batchId,
        createdAt: new Date().toISOString(),
        invoiceDate: bulkInvoiceDate,
        taskType: bulkTaskFilters.childTask,
        parentTask: bulkTaskFilters.parentTask,
        invoiceCount: invoices.length,
        totalAmount: invoices.reduce((s,i) => s + i.totalAmount, 0),
        invoiceIds: invoices.map(i => i.id)
      };
      
      // Save batch to data.bulkBatches for persistence
      setData(prev => ({
        ...prev,
        bulkBatches: [batch, ...(prev.bulkBatches || [])]
      }));
      setBulkBatches(prev => [batch, ...prev]);
      
      // Reset
      setBulkBillingData([]);
      setBulkSelectedTaskIds([]);
      setBulkFilteredTasks([]);
      setBulkOriginalTasks([]);
      
      alert('SUCCESS! Created ' + invoices.length + ' invoices. Total Amount: â‚¹' + invoices.reduce((s,i) => s + i.totalAmount, 0).toLocaleString('en-IN'));
      
      // Navigate to Bulk Invoice Log and show the created batch
      setBulkTaskStep('batches');
      setViewingBulkBatch(batch);
    };
    
    const [editingReceipt, setEditingReceipt] = useState(null);
    const [showEditReceiptModal, setShowEditReceiptModal] = useState(false);
    
    const [billingDetails, setBillingDetails] = useState({
      billDate: new Date().toISOString().split('T')[0],
      organizationId: '',
      billNoType: 'numeric', // 'alphabet', 'numeric'
      amount: '',
      discount: '',
      netAmount: '',
      sac: '',
      placeOfSupply: '',
      narration: '',
      remark: '',
      sendWhatsApp: true,
      isPureAgentService: false
    });
    
    // Invoice states
    const [generatedInvoice, setGeneratedInvoice] = useState(null);
    const [showInvoicePreview, setShowInvoicePreview] = useState(false);
    const [editingInvoice, setEditingInvoice] = useState(null);
    
    // Generated Invoices Preview Popup State
    const [showGeneratedInvoicesPreview, setShowGeneratedInvoicesPreview] = useState(false);
    const [generatedInvoicesList, setGeneratedInvoicesList] = useState([]);
    const [editingGeneratedInvoice, setEditingGeneratedInvoice] = useState(null);
    
    const [orgForm, setOrgForm] = useState({
      name: '',
      website: '',
      faxNo: '',
      authorizedSignatory: '',
      phoneNo: '',
      mobileNo: '',
      alternateMobileNo: '',
      emailId: '',
      gstin: '',
      panNo: '',
      upiId: '',
      mmid: '',
      otherMobileNo: '',
      state: '',
      address: '',
      logo: null,
      logoPreview: '',
      signatureImage: null,
      signaturePreview: '',
      qrCode: null,
      qrCodePreview: '',
      bankName: '',
      bankAccountNo: '',
      bankIfsc: '',
      bankBranch: '',
      gstApplicable: 'yes', // 'yes' or 'no'
      invoiceFormat: 'taxInvoice', // taxInvoice, billOfSupply, proformaInvoice, billOfSupplyBlue
      allowBackdatedInvoicing: true,
      displayFileNoInInvoice: true,
      // Invoice/Receipt number configuration
      invoicePrefix: 'INV',
      invoiceStartNo: 1,
      invoiceCurrentNo: 1,
      invoiceSuffix: '',
      receiptPrefix: 'RCP',
      receiptStartNo: 1,
      receiptCurrentNo: 1,
      receiptSuffix: ''
    });

    const INDIAN_STATES = [
      'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 
      'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 
      'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 
      'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 
      'Uttarakhand', 'West Bengal', 'Delhi', 'Jammu and Kashmir', 'Ladakh'
    ];
    
    // SAC codes for CA services
    const SAC_CODES = [
      { code: '998231', desc: 'Financial auditing services' },
      { code: '998232', desc: 'Accounting and bookkeeping services' },
      { code: '998233', desc: 'Tax consultancy and preparation services' },
      { code: '998234', desc: 'Insolvency and receivership services' },
      { code: '998311', desc: 'Management consulting and management services' }
    ];
    
    // Get filtered clients based on search criteria
    const getFilteredClients = () => {
      let clients = data.clients;
      
      if (billingSearchFilters.clientName) {
        clients = clients.filter(c => 
          (c.name || '').toLowerCase().includes(billingSearchFilters.clientName.toLowerCase())
        );
      }
      if (billingSearchFilters.clientCode) {
        clients = clients.filter(c => 
          (c.fileNo || '').toLowerCase().includes(billingSearchFilters.clientCode.toLowerCase())
        );
      }
      if (billingSearchFilters.groupName) {
        clients = clients.filter(c => 
          (c.groupName || c.name || '').toLowerCase().includes(billingSearchFilters.groupName.toLowerCase())
        );
      }
      
      return clients;
    };
    
    // Get tasks for filtered clients
    const getTasksForFilteredClients = () => {
      const clients = getFilteredClients();
      const clientNames = clients.map(c => c.name.toLowerCase());
      
      return data.tasks.filter(t => 
        clientNames.includes((t.clientName || '').toLowerCase())
      );
    };
    
    // Handle client name input change with autocomplete
    const handleClientNameChange = (value) => {
      setBillingSearchFilters({...billingSearchFilters, clientName: value, parentTask: '', childTask: ''});
      
      if (value.length >= 2) {
        const suggestions = data.clients.filter(c => 
          (c.name || '').toLowerCase().includes(value.toLowerCase())
        ).slice(0, 10);
        setClientNameSuggestions(suggestions);
        setShowClientNameSuggestions(suggestions.length > 0);
      } else {
        setClientNameSuggestions([]);
        setShowClientNameSuggestions(false);
      }
    };
    
    // Handle group name input change with autocomplete
    const handleGroupNameChange = (value) => {
      setBillingSearchFilters({...billingSearchFilters, groupName: value, parentTask: '', childTask: ''});
      
      if (value.length >= 1) {
        // Get unique group numbers from clients' fileNo (e.g., "1" from "1.01")
        const uniqueGroups = [...new Set((data.clients || []).map(c => c.fileNo ? c.fileNo.split('.')[0] : '').filter(Boolean))];
        const suggestions = uniqueGroups.filter(g => g.includes(value)).sort((a, b) => parseInt(a) - parseInt(b)).slice(0, 10);
        setGroupNameSuggestions(suggestions);
        setShowGroupNameSuggestions(suggestions.length > 0);
      } else {
        setGroupNameSuggestions([]);
        setShowGroupNameSuggestions(false);
      }
    };
    
    // Select client from suggestions (from client name search)
    const selectClientFromSuggestion = (client) => {
      setBillingSearchFilters({
        ...billingSearchFilters,
        clientName: client.name,
        clientCode: client.fileNo || '',
        groupName: client.fileNo ? client.fileNo.split('.')[0] : '',
        parentTask: '',
        childTask: ''
      });
      setShowClientNameSuggestions(false);
      setClientNameSuggestions([]);
    };
    
    // Select client from group name suggestions
    const selectClientFromGroupSuggestion = (client) => {
      setBillingSearchFilters({
        ...billingSearchFilters,
        groupName: client.groupName || client.name,
        clientName: client.name,
        clientCode: client.fileNo || '',
        parentTask: '',
        childTask: ''
      });
      setShowGroupNameSuggestions(false);
      setGroupNameSuggestions([]);
    };

    // Get unique parent tasks for filtered clients
    const getParentTasksForClients = () => {
      const tasks = getTasksForFilteredClients();
      return [...new Set(tasks.map(t => t.parentTask).filter(Boolean))];
    };
    
    // Get unique child tasks for filtered clients and selected parent
    const getChildTasksForClients = () => {
      let tasks = getTasksForFilteredClients();
      
      if (billingSearchFilters.parentTask) {
        tasks = tasks.filter(t => t.parentTask === billingSearchFilters.parentTask);
      }
      
      return [...new Set(tasks.map(t => t.childTask).filter(Boolean))];
    };
    
    // Get unique statuses from tasks
    const getStatusesFromTasks = () => {
      const tasks = getTasksForFilteredClients();
      return [...new Set(tasks.map(t => t.status).filter(Boolean))];
    };
    
    // Search tasks for billing
    const searchTasksForBilling = () => {
      let filtered = data.tasks;
      
      // Filter by client criteria
      if (billingSearchFilters.groupName) {
        filtered = filtered.filter(t => 
          (t.groupName || '').toLowerCase().includes(billingSearchFilters.groupName.toLowerCase())
        );
      }
      if (billingSearchFilters.clientName) {
        filtered = filtered.filter(t => 
          (t.clientName || '').toLowerCase().includes(billingSearchFilters.clientName.toLowerCase())
        );
      }
      if (billingSearchFilters.clientCode) {
        filtered = filtered.filter(t => 
          (t.fileNo || '').toLowerCase().includes(billingSearchFilters.clientCode.toLowerCase())
        );
      }
      
      // Filter by task criteria
      if (billingSearchFilters.parentTask) {
        filtered = filtered.filter(t => t.parentTask === billingSearchFilters.parentTask);
      }
      if (billingSearchFilters.childTask) {
        filtered = filtered.filter(t => t.childTask === billingSearchFilters.childTask);
      }
      if (billingSearchFilters.financialYear) {
        filtered = filtered.filter(t => t.financialYear === billingSearchFilters.financialYear);
      }
      if (billingSearchFilters.period) {
        filtered = filtered.filter(t => (t.subPeriod || '').toLowerCase().includes(billingSearchFilters.period.toLowerCase()));
      }
      if (billingSearchFilters.status) {
        filtered = filtered.filter(t => t.status === billingSearchFilters.status);
      }
      
      // Exclude already billed tasks
      filtered = filtered.filter(t => !t.billed);
      
      setSearchedTasks(filtered);
      setHasSearched(true);
    };
    
    // Reset billing filters
    const resetBillingFilters = () => {
      setBillingSearchFilters({
        groupName: '',
        clientName: '',
        clientCode: '',
        parentTask: '',
        childTask: '',
        financialYear: 'FY 2024-25',
        period: '',
        status: ''
      });
      setSearchedTasks([]);
      setHasSearched(false);
      setSelectedBillingTask(null);
    };
    
    // Debtor search handler
    const handleDebtorSearch = (value) => {
      setDebtorFilters({...debtorFilters, clientName: value});
      
      if (value.length >= 2) {
        // Get clients who have invoices (debtors)
        const clientsWithInvoices = data.clients.filter(c => {
          const clientInvoices = (data.invoices || []).filter(inv => 
            inv.clientName?.toLowerCase() === c.name?.toLowerCase()
          );
          return clientInvoices.length > 0;
        });
        
        const suggestions = clientsWithInvoices.filter(c => 
          (c.name || '').toLowerCase().includes(value.toLowerCase()) ||
          (c.fileNo || '').toLowerCase().includes(value.toLowerCase()) ||
          (c.groupName || '').toLowerCase().includes(value.toLowerCase())
        ).slice(0, 10);
        
        setDebtorSuggestions(suggestions);
        setShowDebtorSuggestions(suggestions.length > 0);
      } else {
        setDebtorSuggestions([]);
        setShowDebtorSuggestions(false);
      }
    };
    
    // Select debtor
    const selectDebtor = (client) => {
      setSelectedDebtor(client);
      setDebtorFilters({
        ...debtorFilters,
        clientName: client.name,
        clientCode: client.fileNo || '',
        groupName: client.groupName || client.name
      });
      setShowDebtorSuggestions(false);
    };
    
    // Get debtor ledger entries
    const getDebtorLedger = () => {
      if (!selectedDebtor) return { entries: [], totals: {} };
      
      const invoices = (data.invoices || []).filter(inv => 
        inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()
      );
      
      const receipts = (data.receipts || []).filter(rec => 
        rec.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()
      );
      
      // Combine and sort by date
      let entries = [];
      
      invoices.forEach(inv => {
        const invDate = new Date(inv.invoiceDate);
        // Apply date filters
        if (debtorFilters.fromDate && invDate < new Date(debtorFilters.fromDate)) return;
        if (debtorFilters.toDate && invDate > new Date(debtorFilters.toDate)) return;
        
        entries.push({
          id: inv.id,
          date: inv.invoiceDate,
          type: 'Invoice',
          refNo: inv.invoiceNo,
          description: inv.serviceDescription,
          debit: inv.totalAmount,
          credit: 0,
          taskType: inv.taskType,
          period: inv.period
        });
      });
      
      receipts.forEach(rec => {
        const recDate = new Date(rec.receiptDate);
        if (debtorFilters.fromDate && recDate < new Date(debtorFilters.fromDate)) return;
        if (debtorFilters.toDate && recDate > new Date(debtorFilters.toDate)) return;
        
        // Total credit includes amount + TDS + discount
        const totalCredit = (rec.amount || 0) + (rec.tds || 0) + (rec.discount || 0);
        
        let description = rec.narration || 'Payment Received';
        if (rec.tds > 0) description += ` (TDS: â‚¹${rec.tds})`;
        if (rec.discount > 0) description += ` (Disc: â‚¹${rec.discount})`;
        
        entries.push({
          id: rec.id,
          date: rec.receiptDate,
          type: 'Receipt',
          refNo: rec.receiptNo,
          description: description,
          debit: 0,
          credit: totalCredit,
          paymentMode: rec.paymentMode,
          invoiceNo: rec.invoiceNo
        });
      });
      
      // Sort by date
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Calculate running balance
      let runningBalance = 0;
      entries = entries.map(entry => {
        runningBalance += entry.debit - entry.credit;
        return { ...entry, balance: runningBalance };
      });
      
      // Calculate totals
      const totalDebit = entries.reduce((sum, e) => sum + e.debit, 0);
      const totalCredit = entries.reduce((sum, e) => sum + e.credit, 0);
      const closingBalance = totalDebit - totalCredit;
      
      return {
        entries,
        totals: {
          totalDebit,
          totalCredit,
          closingBalance
        }
      };
    };
    
    // Get all debtors with balances
    const getAllDebtors = () => {
      const invoices = data.invoices || [];
      const receipts = data.receipts || [];
      
      // Group by client
      const debtorMap = {};
      
      invoices.forEach(inv => {
        const clientName = inv.clientName;
        if (!clientName) return;
        
        if (!debtorMap[clientName]) {
          const client = data.clients.find(c => c.name?.toLowerCase() === clientName.toLowerCase());
          debtorMap[clientName] = {
            clientName,
            clientCode: inv.clientCode || client?.fileNo || '',
            groupName: inv.clientGroup || client?.groupName || clientName,
            state: client?.state || inv.clientState || '',
            totalInvoiced: 0,
            totalReceived: 0,
            invoiceCount: 0,
            lastInvoiceDate: null,
            client: client
          };
        }
        
        debtorMap[clientName].totalInvoiced += inv.totalAmount || 0;
        debtorMap[clientName].invoiceCount += 1;
        
        const invDate = new Date(inv.invoiceDate);
        if (!debtorMap[clientName].lastInvoiceDate || invDate > new Date(debtorMap[clientName].lastInvoiceDate)) {
          debtorMap[clientName].lastInvoiceDate = inv.invoiceDate;
        }
      });
      
      receipts.forEach(rec => {
        const clientName = rec.clientName;
        if (!clientName || !debtorMap[clientName]) return;
        
        // Include amount + TDS + discount in total received
        debtorMap[clientName].totalReceived += (rec.amount || 0) + (rec.tds || 0) + (rec.discount || 0);
      });
      
      // Convert to array and calculate balance
      let debtors = Object.values(debtorMap).map(d => ({
        ...d,
        balance: d.totalInvoiced - d.totalReceived
      }));
      
      // Apply filters
      if (debtorFilters.clientName) {
        debtors = debtors.filter(d => 
          d.clientName.toLowerCase().includes(debtorFilters.clientName.toLowerCase())
        );
      }
      if (debtorFilters.clientCode) {
        debtors = debtors.filter(d => 
          (d.clientCode || '').toLowerCase().includes(debtorFilters.clientCode.toLowerCase())
        );
      }
      if (debtorFilters.groupName) {
        debtors = debtors.filter(d => 
          (d.groupName || '').toLowerCase().includes(debtorFilters.groupName.toLowerCase())
        );
      }
      if (debtorFilters.balanceType === 'pending') {
        debtors = debtors.filter(d => d.balance > 0);
      } else if (debtorFilters.balanceType === 'cleared') {
        debtors = debtors.filter(d => d.balance <= 0);
      }
      
      // Sort by balance descending
      debtors.sort((a, b) => b.balance - a.balance);
      
      return debtors;
    };
    
    // Open debtor ledger screen
    const openDebtorLedger = (debtor) => {
      const client = debtor.client || data.clients.find(c => c.name?.toLowerCase() === debtor.clientName?.toLowerCase());
      setSelectedDebtor(client || { name: debtor.clientName, fileNo: debtor.clientCode, groupName: debtor.groupName, state: debtor.state });
      setDebtorViewMode('ledger');
    };
    
    // View invoice from ledger
    const viewInvoiceFromLedger = (invoiceId) => {
      const invoice = (data.invoices || []).find(i => i.id === invoiceId);
      if (invoice) {
        // Get org images for display
        const org = data.organizations.find(o => o.id === invoice.organizationId);
        setViewingInvoice({
          ...invoice,
          orgLogo: org?.logo || null,
          orgSignature: org?.signatureImage || null,
          orgQrCode: org?.qrCode || null
        });
        setDebtorViewMode('invoice');
      }
    };
    
    // Go back to debtors list
    const goBackToDebtorsList = () => {
      setDebtorViewMode('list');
      setSelectedDebtor(null);
      setViewingInvoice(null);
    };
    
    // Go back to ledger from invoice
    const goBackToLedger = () => {
      if (selectedDebtor) {
        setDebtorViewMode('ledger');
      } else {
        setDebtorViewMode('list');
      }
      setViewingInvoice(null);
    };
    
    // Print invoice as PDF
    const printInvoicePDF = () => {
      // Add print styles dynamically
      const style = document.createElement('style');
      style.id = 'print-styles';
      style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @page { 
          size: A4 portrait; 
          margin: 10mm;
        }
        @media print {
          body * { visibility: hidden; }
          #invoice-print-content, #invoice-print-content * { visibility: visible; }
          #invoice-print-content { 
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%;
            max-width: 210mm;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      `;
      document.head.appendChild(style);
      
      // Trigger print
      window.print();
      
      // Remove print styles after printing
      setTimeout(() => {
        const printStyle = document.getElementById('print-styles');
        if (printStyle) printStyle.remove();
      }, 1000);
    };
    
    // ============ RECEIPT FUNCTIONS ============
    
    // Get unique groups from clients
    const getUniqueGroups = () => {
      const groups = new Set();
      data.clients.forEach(c => {
        if (c.groupName) groups.add(c.groupName);
      });
      return Array.from(groups).sort();
    };
    
    // Get clients with pending invoices
    const getClientsWithPendingInvoices = () => {
      const clientsWithInvoices = {};
      
      (data.invoices || []).forEach(inv => {
        if (!inv.clientName) return;
        
        // Calculate paid amount for this invoice (including TDS and discount)
        const paidAmount = (data.receipts || [])
          .filter(r => String(r.invoiceId) === String(inv.id))
          .reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
        
        const dueAmount = (inv.totalAmount || 0) - paidAmount;
        
        if (dueAmount > 0.01) { // Small threshold to handle floating point
          if (!clientsWithInvoices[inv.clientName]) {
            const client = data.clients.find(c => c.name?.toLowerCase() === inv.clientName?.toLowerCase());
            clientsWithInvoices[inv.clientName] = {
              clientName: inv.clientName,
              clientCode: inv.clientCode || client?.fileNo || '',
              groupName: inv.clientGroup || client?.groupName || '',
              invoices: []
            };
          }
          clientsWithInvoices[inv.clientName].invoices.push({
            ...inv,
            paidAmount,
            dueAmount
          });
        }
      });
      
      // Apply filters
      let clients = Object.values(clientsWithInvoices);
      
      if (receiptFilters.groupName) {
        clients = clients.filter(c => 
          c.groupName?.toLowerCase().includes(receiptFilters.groupName.toLowerCase())
        );
      }
      if (receiptFilters.clientName) {
        clients = clients.filter(c => 
          c.clientName?.toLowerCase().includes(receiptFilters.clientName.toLowerCase())
        );
      }
      
      return clients;
    };
    
    // Toggle client selection for receipt
    const toggleClientForReceipt = (clientName) => {
      if (selectedClientsForReceipt.includes(clientName)) {
        setSelectedClientsForReceipt(selectedClientsForReceipt.filter(c => c !== clientName));
      } else {
        setSelectedClientsForReceipt([...selectedClientsForReceipt, clientName]);
      }
    };
    
    // Get pending invoices for selected clients
    const getPendingInvoicesForSelectedClients = () => {
      const allClients = getClientsWithPendingInvoices();
      return allClients.filter(c => selectedClientsForReceipt.includes(c.clientName));
    };
    
    // Handle receipt amount change for an invoice
    const handleReceiptAmountChange = (invoiceId, field, value) => {
      setInvoiceReceiptAmounts(prev => ({
        ...prev,
        [invoiceId]: {
          ...prev[invoiceId],
          [field]: value
        }
      }));
    };
    
    // Calculate totals for receipt posting
    const calculateReceiptTotals = () => {
      let totalReceipt = 0;
      let totalTds = 0;
      let totalDiscount = 0;
      
      Object.keys(invoiceReceiptAmounts).forEach(invId => {
        const amounts = invoiceReceiptAmounts[invId];
        totalReceipt += parseFloat(amounts.receiptAmount || 0);
        totalTds += parseFloat(amounts.tds || 0);
        totalDiscount += parseFloat(amounts.discount || 0);
      });
      
      return { totalReceipt, totalTds, totalDiscount };
    };
    
    // Post receipts
    const postReceipts = () => {
      if (!receiptFormData.organizationId) {
        alert('Please select an organization');
        return;
      }
      
      const org = data.organizations.find(o => o.id === receiptFormData.organizationId);
      if (!org) {
        alert('Organization not found');
        return;
      }
      
      const newReceipts = [];
      let receiptCounter = org.receiptCurrentNo || 1;
      
      // Group by client
      const clientInvoices = getPendingInvoicesForSelectedClients();
      
      clientInvoices.forEach(clientData => {
        clientData.invoices.forEach(inv => {
          const amounts = invoiceReceiptAmounts[inv.id];
          
          if (!amounts) return;
          
          const receiptAmount = parseFloat(amounts.receiptAmount || 0);
          const tds = parseFloat(amounts.tds || 0);
          const discount = parseFloat(amounts.discount || 0);
          
          if (receiptAmount > 0 || tds > 0 || discount > 0) {
            const receiptNo = `${org.receiptPrefix || 'RCP'}${String(receiptCounter).padStart(4, '0')}${org.receiptSuffix || ''}`;
            
            const receipt = {
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9) + newReceipts.length,
              receiptNo,
              receiptDate: receiptFormData.receiptDate,
              organizationId: receiptFormData.organizationId,
              orgName: org.name,
              clientName: clientData.clientName,
              clientCode: clientData.clientCode,
              groupName: clientData.groupName,
              invoiceId: inv.id,
              invoiceNo: inv.invoiceNo,
              invoiceAmount: inv.totalAmount,
              amount: receiptAmount,
              tds,
              discount,
              totalSettled: receiptAmount + tds + discount,
              narration: receiptFormData.narration,
              paymentMode: amounts.paymentMode || 'Cash',
              cashAccount: amounts.cashAccount || 'Cash A/c',
              finYear: inv.financialYear,
              billNo: inv.invoiceNo,
              serviceDescription: inv.serviceDescription,
              createdAt: new Date().toISOString()
            };
            
            newReceipts.push(receipt);
            receiptCounter++;
          }
        });
      });
      
      if (newReceipts.length === 0) {
        alert('Please enter receipt amounts for at least one invoice');
        return;
      }
      
      // Check if approval is needed (RM needs Superadmin approval for receipts)
      const userRole = getCurrentUserRole();
      const approvalNeeded = needsApproval('receipt', userRole);
      
      if (approvalNeeded) {
        // Create approval request for each receipt or batch
        const totalAmount = newReceipts.reduce((sum, r) => sum + r.amount, 0);
        const approval = createApprovalRequest(
          'receipt',
          newReceipts.length === 1 ? newReceipts[0] : newReceipts,
          `Receipt${newReceipts.length > 1 ? 's' : ''}: ${newReceipts.length} receipt(s) - Total â‚¹${totalAmount.toLocaleString()}`
        );
        
        if (approval) {
          setData(prev => ({
            ...prev,
            pendingApprovals: [...(prev.pendingApprovals || []), approval]
          }));
          resetReceiptForm();
          alert('ðŸ“ Receipt(s) submitted for approval!\n\nSuperadmin will review and approve.');
          return;
        }
      }
      
      // Direct save for Superadmin
      // Save receipts with proper state update
      setData(prev => {
        const updatedOrgs = prev.organizations.map(o => 
          o.id === receiptFormData.organizationId 
            ? { ...o, receiptCurrentNo: receiptCounter }
            : o
        );
        
        return {
          ...prev,
          receipts: [...(prev.receipts || []), ...newReceipts],
          organizations: updatedOrgs
        };
      });
      
      // Show summary
      setGeneratedReceipts(newReceipts);
      setShowReceiptSummary(true);
    };
    
    // Reset receipt form
    const resetReceiptForm = () => {
      setReceiptFilters({ groupName: '', clientName: '', fromDate: '', toDate: '' });
      setSelectedClientsForReceipt([]);
      setReceiptFormData({
        receiptDate: new Date().toISOString().split('T')[0],
        narration: '',
        organizationId: ''
      });
      setInvoiceReceiptAmounts({});
      setShowReceiptSummary(false);
      setGeneratedReceipts([]);
    };
    
    // Get all receipts with filters
    const getFilteredReceipts = () => {
      let receipts = data.receipts || [];
      
      if (receiptFilters.groupName) {
        receipts = receipts.filter(r => 
          r.groupName?.toLowerCase().includes(receiptFilters.groupName.toLowerCase())
        );
      }
      if (receiptFilters.clientName) {
        receipts = receipts.filter(r => 
          r.clientName?.toLowerCase().includes(receiptFilters.clientName.toLowerCase())
        );
      }
      if (receiptFilters.fromDate) {
        receipts = receipts.filter(r => new Date(r.receiptDate) >= new Date(receiptFilters.fromDate));
      }
      if (receiptFilters.toDate) {
        receipts = receipts.filter(r => new Date(r.receiptDate) <= new Date(receiptFilters.toDate));
      }
      
      // Sort by date desc
      receipts.sort((a, b) => new Date(b.receiptDate) - new Date(a.receiptDate));
      
      return receipts;
    };
    
    // Edit receipt
    const startEditReceipt = (receipt) => {
      setEditingReceipt({ ...receipt });
      setShowEditReceiptModal(true);
    };
    
    // Save edited receipt
    const saveEditedReceipt = () => {
      if (!editingReceipt) return;
      
      setData(prev => ({
        ...prev,
        receipts: prev.receipts.map(r => 
          r.id === editingReceipt.id ? editingReceipt : r
        )
      }));
      
      setShowEditReceiptModal(false);
      setEditingReceipt(null);
    };
    
    // Delete receipt
    const deleteReceipt = (receiptId) => {
      if (!window.confirm('Are you sure you want to delete this receipt?')) return;
      
      setData(prev => ({
        ...prev,
        receipts: prev.receipts.filter(r => r.id !== receiptId)
      }));
    };
    
    // ============ END RECEIPT FUNCTIONS ============
    
    // Edit invoice
    const startEditInvoice = () => {
      if (viewingInvoice) {
        setEditingInvoiceData({
          ...viewingInvoice,
          amount: viewingInvoice.amount?.toString() || '',
          discount: viewingInvoice.discount?.toString() || '0'
        });
        setShowEditInvoiceModal(true);
      }
    };
    
    // Save edited invoice
    const saveEditedInvoice = () => {
      if (!editingInvoiceData) return;
      
      // Get the selected organization
      const selectedOrg = data.organizations.find(o => o.id === editingInvoiceData.organizationId);
      const orgState = selectedOrg?.state || editingInvoiceData.orgState;
      
      // Check if GST is applicable
      const gstApplicable = selectedOrg?.gstApplicable === 'yes';
      
      let netAmount = 0;
      let updatedLineItems = null;
      
      // Handle multiple task invoice with line items
      if (editingInvoiceData.lineItems && editingInvoiceData.lineItems.length > 0) {
        updatedLineItems = editingInvoiceData.lineItems.map(item => ({
          ...item,
          amount: parseFloat(item.amount) || 0,
          discount: parseFloat(item.discount) || 0,
          netAmount: (parseFloat(item.amount) || 0) - (parseFloat(item.discount) || 0)
        }));
        netAmount = updatedLineItems.reduce((sum, item) => sum + item.netAmount, 0);
      } else {
        // Single task invoice
        const amount = parseFloat(editingInvoiceData.amount) || 0;
        const discount = parseFloat(editingInvoiceData.discount) || 0;
        netAmount = amount - discount;
      }
      
      // Recalculate GST based on organization state and gstApplicable
      const isInterState = orgState !== editingInvoiceData.placeOfSupply;
      let cgst = 0, sgst = 0, igst = 0;
      
      if (gstApplicable) {
        if (isInterState) {
          igst = Math.round(netAmount * 0.18 * 100) / 100;
        } else {
          cgst = Math.round(netAmount * 0.09 * 100) / 100;
          sgst = Math.round(netAmount * 0.09 * 100) / 100;
        }
      }
      const totalAmount = netAmount + cgst + sgst + igst;
      
      // Update organization details if changed
      const updatedInvoice = {
        ...editingInvoiceData,
        ...(updatedLineItems ? { lineItems: updatedLineItems } : {
          amount: parseFloat(editingInvoiceData.amount) || 0,
          discount: parseFloat(editingInvoiceData.discount) || 0,
        }),
        netAmount,
        gstApplicable,
        cgst,
        sgst,
        igst,
        totalAmount,
        amountInWords: numberToWords(Math.round(totalAmount)) + ' Only.',
        // Update org details if organization changed
        ...(selectedOrg && {
          orgName: selectedOrg.name,
          orgAddress: selectedOrg.address,
          orgState: selectedOrg.state,
          orgGstin: selectedOrg.gstin,
          orgPan: selectedOrg.panNo,
          orgPhone: selectedOrg.phoneNo,
          orgMobile: selectedOrg.mobileNo,
          orgEmail: selectedOrg.emailId,
          orgWebsite: selectedOrg.website,
          orgBankName: selectedOrg.bankName,
          orgBankAccount: selectedOrg.bankAccountNo,
          orgBankIfsc: selectedOrg.bankIfsc,
          orgBankBranch: selectedOrg.bankBranch,
          orgSignatory: selectedOrg.authorizedSignatory,
          supplierStateCode: STATE_CODES[selectedOrg.state] || ''
        })
      };
      
      // Update in data
      setData(prev => ({
        ...prev,
        invoices: prev.invoices.map(inv => 
          inv.id === updatedInvoice.id ? updatedInvoice : inv
        )
      }));
      
      // Update viewing invoice
      const org = data.organizations.find(o => o.id === updatedInvoice.organizationId);
      setViewingInvoice({
        ...updatedInvoice,
        orgLogo: org?.logo || null,
        orgSignature: org?.signatureImage || null
      });
      
      setShowEditInvoiceModal(false);
      setEditingInvoiceData(null);
    };
    
    // Check if invoice has received any payment
    const invoiceHasPayments = (invoiceId) => {
      if (!invoiceId) return false;
      const receipts = (data.receipts || []).filter(r => String(r.invoiceId) === String(invoiceId));
      return receipts.length > 0;
    };
    
    // Get total paid amount for an invoice
    const getInvoicePaidAmount = (invoiceId) => {
      return (data.receipts || [])
        .filter(r => String(r.invoiceId) === String(invoiceId))
        .reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
    };
    
    // Check if a task is already billed
    const isTaskBilled = (taskId) => {
      return (data.invoices || []).some(inv => 
        String(inv.taskId) === String(taskId) || 
        (inv.taskIds && inv.taskIds.map(String).includes(String(taskId)))
      );
    };
    
    // Delete invoice and go back
    const deleteInvoiceAndGoBack = (invoiceId) => {
      console.log('Delete called with ID:', invoiceId);
      
      if (!invoiceId) {
        alert('Invalid invoice ID');
        return;
      }
      
      // Check if invoice has received any payments
      if (invoiceHasPayments(invoiceId)) {
        alert('Cannot delete this invoice. Payments have been received against it. Please delete the receipts first.');
        return;
      }
      
      const confirmDelete = window.confirm('Are you sure you want to delete this invoice? This action cannot be undone.');
      if (!confirmDelete) return;
      
      const invoice = (data.invoices || []).find(i => String(i.id) === String(invoiceId));
      console.log('Found invoice:', invoice);
      
      if (invoice) {
        // Create updated arrays
        const updatedInvoices = (data.invoices || []).filter(i => String(i.id) !== String(invoiceId));
        const updatedTasks = (data.tasks || []).map(t => {
          if (invoice.taskId && String(t.id) === String(invoice.taskId)) {
            return { ...t, billed: false, invoiceId: null };
          }
          if (invoice.taskIds && invoice.taskIds.map(String).includes(String(t.id))) {
            return { ...t, billed: false, invoiceId: null };
          }
          return t;
        });
        
        // Update state - EXPLICITLY list all fields (no spread operator!)
        setData({
          tasks: updatedTasks,
          clients: data.clients || [],
          staff: data.staff || [],
          timesheets: data.timesheets || [],
          invoices: updatedInvoices,
          receipts: data.receipts || [],
          organizations: data.organizations || [],
          recurringSchedules: data.recurringSchedules || [],
          leaves: data.leaves || [],
          documents: data.documents || [],
          userPermissions: data.userPermissions || {},
          parentChildTasks: data.parentChildTasks || DEFAULT_PARENT_CHILD_TASKS,
          recurringBatches: data.recurringBatches || [],
          checklists: data.checklists || [],
          pendingApprovals: data.pendingApprovals || []
        });
        
        // Navigate back
        setViewingInvoice(null);
        if (selectedDebtor) {
          setDebtorViewMode('ledger');
        } else {
          setDebtorViewMode('list');
        }
        
        alert('Invoice deleted successfully!');
      } else {
        alert('Invoice not found. ID: ' + invoiceId);
      }
    };
    
    // Reset debtor filters
    const resetDebtorFilters = () => {
      setDebtorFilters({
        clientName: '',
        clientCode: '',
        groupName: '',
        fromDate: '',
        toDate: '',
        balanceType: 'all'
      });
      setSelectedDebtor(null);
    };
    
    // State code mapping for GST
    const STATE_CODES = {
      'Andhra Pradesh': '37', 'Arunachal Pradesh': '12', 'Assam': '18', 'Bihar': '10',
      'Chhattisgarh': '22', 'Goa': '30', 'Gujarat': '24', 'Haryana': '06',
      'Himachal Pradesh': '02', 'Jharkhand': '20', 'Karnataka': '29', 'Kerala': '32',
      'Madhya Pradesh': '23', 'Maharashtra': '27', 'Manipur': '14', 'Meghalaya': '17',
      'Mizoram': '15', 'Nagaland': '13', 'Odisha': '21', 'Punjab': '03',
      'Rajasthan': '08', 'Sikkim': '11', 'Tamil Nadu': '33', 'Telangana': '36',
      'Tripura': '16', 'Uttar Pradesh': '09', 'Uttarakhand': '05', 'West Bengal': '19',
      'Delhi': '07', 'Jammu and Kashmir': '01', 'Ladakh': '38'
    };
    
    // Number to words converter
    const numberToWords = (num) => {
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
        'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      
      if (num === 0) return 'Zero';
      if (num < 0) return 'Minus ' + numberToWords(-num);
      
      let words = '';
      
      if (Math.floor(num / 10000000) > 0) {
        words += numberToWords(Math.floor(num / 10000000)) + ' Crore ';
        num %= 10000000;
      }
      if (Math.floor(num / 100000) > 0) {
        words += numberToWords(Math.floor(num / 100000)) + ' Lakh ';
        num %= 100000;
      }
      if (Math.floor(num / 1000) > 0) {
        words += numberToWords(Math.floor(num / 1000)) + ' Thousand ';
        num %= 1000;
      }
      if (Math.floor(num / 100) > 0) {
        words += numberToWords(Math.floor(num / 100)) + ' Hundred ';
        num %= 100;
      }
      if (num > 0) {
        if (num < 20) {
          words += ones[num];
        } else {
          words += tens[Math.floor(num / 10)];
          if (num % 10 > 0) words += ' ' + ones[num % 10];
        }
      }
      
      return words.trim();
    };
    
    // Generate invoice
    const generateInvoice = () => {
      if (!selectedBillingTask) {
        alert('Please select a task to bill');
        return;
      }
      if (!billingDetails.organizationId) {
        alert('Please select an organization');
        return;
      }
      if (!billingDetails.amount || parseFloat(billingDetails.amount) <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const task = searchedTasks.find(t => t.id === selectedBillingTask);
      const client = data.clients.find(c => c.name === task?.clientName);
      const org = data.organizations.find(o => o.id === billingDetails.organizationId);
      
      if (!task || !org) {
        alert('Invalid task or organization');
        return;
      }
      
      // Calculate GST
      const netAmount = parseFloat(billingDetails.netAmount) || parseFloat(billingDetails.amount) - (parseFloat(billingDetails.discount) || 0);
      const supplierState = org.state;
      const receiverState = billingDetails.placeOfSupply || client?.state || '';
      const isInterState = supplierState !== receiverState;
      
      // Check if GST is applicable for this organization
      const gstApplicable = org.gstApplicable === 'yes';
      
      let cgst = 0, sgst = 0, igst = 0;
      if (gstApplicable) {
        if (isInterState) {
          igst = netAmount * 0.18; // 18% IGST
        } else {
          cgst = netAmount * 0.09; // 9% CGST
          sgst = netAmount * 0.09; // 9% SGST
        }
      }
      const totalAmount = netAmount + cgst + sgst + igst;
      
      // Generate invoice number
      const currentNo = org.invoiceCurrentNo || org.invoiceStartNo || 1;
      const invoiceNo = `${org.invoicePrefix || 'INV'}-${currentNo}${org.invoiceSuffix ? '/' + org.invoiceSuffix : ''}`;
      
      // Determine invoice format
      const invoiceFormat = org.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
      console.log('=== generateInvoice ===');
      console.log('org.invoiceFormat:', org.invoiceFormat);
      console.log('gstApplicable:', gstApplicable);
      console.log('Final invoiceFormat:', invoiceFormat);
      
      // Invoice object - NO base64 images stored, only references
      const invoice = {
        id: generateId(),
        invoiceNo,
        invoiceDate: billingDetails.billDate,
        taskId: task.id,
        clientId: client?.id,
        organizationId: org.id, // Reference to org for images
        orgId: org.id, // Alias for consistency
        invoiceFormat, // Added here
        
        // Organization details (text only, no images)
        orgName: org.name,
        orgAddress: org.address,
        orgState: org.state,
        orgGstin: org.gstin,
        orgPan: org.panNo,
        orgPhone: org.phoneNo,
        orgMobile: org.mobileNo,
        orgEmail: org.emailId,
        orgWebsite: org.website,
        orgBankName: org.bankName,
        orgBankAccount: org.bankAccountNo,
        orgBankIfsc: org.bankIfsc,
        orgBankBranch: org.bankBranch,
        orgSignatory: org.authorizedSignatory,
        // Images fetched from org via organizationId - NOT stored here
        
        // Client details
        clientName: client?.name || task.clientName,
        clientAddress: client?.address || '',
        clientState: client?.state || '',
        clientGstin: client?.gstin || '',
        clientCode: client?.fileNo || task.fileNo,
        clientGroup: client?.groupName || task.groupName || client?.name,
        
        // Invoice details
        serviceDescription: billingDetails.narration || `Professional Fees for ${task.childTask}`,
        sac: billingDetails.sac,
        placeOfSupply: billingDetails.placeOfSupply || client?.state,
        supplierStateCode: STATE_CODES[supplierState] || '',
        receiverStateCode: STATE_CODES[receiverState] || '',
        
        // Amounts
        amount: parseFloat(billingDetails.amount),
        discount: parseFloat(billingDetails.discount) || 0,
        netAmount,
        gstApplicable,
        cgst,
        sgst,
        igst,
        totalAmount,
        amountInWords: numberToWords(Math.round(totalAmount)) + ' Only.',
        
        // Additional
        remark: billingDetails.remark,
        isPureAgentService: billingDetails.isPureAgentService,
        sendWhatsApp: billingDetails.sendWhatsApp,
        
        // Task reference
        taskType: task.childTask,
        parentTask: task.parentTask,
        financialYear: task.financialYear,
        period: task.subPeriod,
        
        createdAt: new Date().toISOString(),
        status: 'Generated'
      };
      
      // For preview, add org images temporarily (not saved to localStorage)
      const invoiceForPreview = {
        ...invoice,
        orgLogo: org.logo,
        orgSignature: org.signatureImage
      };
      
      // Check if approval is needed (RM needs Superadmin approval for invoices)
      const userRole = getCurrentUserRole();
      const approvalNeeded = needsApproval('invoice', userRole);
      
      if (approvalNeeded) {
        // Create approval request instead of direct save
        const approval = createApprovalRequest(
          'invoice',
          invoice,
          `Invoice: ${invoiceNo} for ${client?.name || task.clientName} - â‚¹${totalAmount.toLocaleString()}`
        );
        
        if (approval) {
          setData(prev => ({
            ...prev,
            pendingApprovals: [...(prev.pendingApprovals || []), approval]
          }));
          setShowInvoiceModal(false);
          alert('ðŸ“ Invoice submitted for approval!\n\nSuperadmin will review and approve this invoice.');
          return;
        }
      }
      
      // Direct save for Superadmin
      // Save invoice to data (without images)
      setData(prev => ({
        ...prev,
        invoices: [...(prev.invoices || []), invoice],
        organizations: prev.organizations.map(o => 
          o.id === org.id ? { ...o, invoiceCurrentNo: currentNo + 1 } : o
        ),
        tasks: prev.tasks.map(t => 
          t.id === task.id ? { ...t, billed: true, invoiceId: invoice.id } : t
        )
      }));
      
      // Show preview with images
      setGeneratedInvoice(invoiceForPreview);
      setShowInvoicePreview(true);
    };
    
    // Get invoice with org images for display
    const getInvoiceWithImages = (invoice) => {
      const org = data.organizations.find(o => o.id === invoice.organizationId);
      return {
        ...invoice,
        orgLogo: org?.logo || null,
        orgSignature: org?.signatureImage || null
      };
    };
    
    // Delete invoice
    const deleteInvoice = (invoiceId) => {
      if (!invoiceId) {
        alert('Invalid invoice ID');
        return;
      }
      
      // Check if invoice has received any payments
      if (invoiceHasPayments(invoiceId)) {
        alert('Cannot delete this invoice. Payments have been received against it.');
        return;
      }
      
      if (!window.confirm('Are you sure you want to delete this invoice?')) return;
      
      const invoice = (data.invoices || []).find(i => String(i.id) === String(invoiceId));
      if (invoice) {
        setData(prev => {
          const updatedInvoices = (prev.invoices || []).filter(i => String(i.id) !== String(invoiceId));
          const updatedTasks = (prev.tasks || []).map(t => {
            if (invoice.taskId && String(t.id) === String(invoice.taskId)) {
              return { ...t, billed: false, invoiceId: null };
            }
            if (invoice.taskIds && invoice.taskIds.map(String).includes(String(t.id))) {
              return { ...t, billed: false, invoiceId: null };
            }
            return t;
          });
          return {
            ...prev,
            invoices: updatedInvoices,
            tasks: updatedTasks
          };
        });
        setShowInvoicePreview(false);
        setGeneratedInvoice(null);
        alert('Invoice deleted successfully');
      } else {
        alert('Invoice not found');
      }
    };
    
    // Print invoice
    const printInvoice = () => {
      // Add print styles dynamically
      const style = document.createElement('style');
      style.id = 'print-styles-billing';
      style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @page { 
          size: A4 portrait; 
          margin: 10mm;
        }
        @media print {
          body * { visibility: hidden; }
          #invoice-print-area, #invoice-print-area * { visibility: visible; }
          #invoice-print-area { 
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%;
            max-width: 210mm;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      `;
      document.head.appendChild(style);
      
      // Trigger print
      window.print();
      
      // Remove print styles after printing
      setTimeout(() => {
        const printStyle = document.getElementById('print-styles-billing');
        if (printStyle) printStyle.remove();
      }, 1000);
    };
    
    // Download Invoice PDF - generates HTML and opens print dialog for PDF save
    const downloadInvoicePDF = (invoice, orgs, clients) => {
      if (!invoice) return;
      
      const currentOrg = orgs?.find(o => o.id === (invoice.orgId || invoice.organizationId)) || {};
      const client = clients?.find(c => c.id === invoice.clientId) || {};
      
      const gstApplicable = invoice.gstApplicable !== false && currentOrg.gstApplicable === 'yes';
      const invoiceFormat = invoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
      const isDarkTheme = invoiceFormat === 'billOfSupply';
      
      const primaryColor = isDarkTheme ? '#374151' : '#111827';
      const headerBg = isDarkTheme ? '#374151' : '#111827';
      
      let invoiceTitle = 'TAX INVOICE';
      if (invoiceFormat === 'billOfSupply') invoiceTitle = 'BILL OF SUPPLY';
      else if (invoiceFormat === 'proformaInvoice') invoiceTitle = 'PROFORMA INVOICE';
      
      const showGst = gstApplicable && invoiceFormat !== 'billOfSupply';
      
      const displayOrg = {
        name: currentOrg.name || invoice.orgName || invoice.organizationName,
        address: currentOrg.address || invoice.orgAddress,
        mobile: currentOrg.mobile || invoice.orgMobile,
        email: currentOrg.email || invoice.orgEmail,
        gstin: currentOrg.gstin || invoice.orgGstin,
        pan: currentOrg.pan || invoice.orgPan,
        logo: currentOrg.logo || invoice.orgLogo,
        signature: currentOrg.signature || invoice.orgSignature,
        signatory: currentOrg.signatory || invoice.orgSignatory,
        bankName: currentOrg.bankName || invoice.orgBankName,
        bankAccount: currentOrg.bankAccount || invoice.orgBankAccount,
        bankIfsc: currentOrg.bankIfsc || invoice.orgBankIfsc,
      };
      
      const displayClient = {
        name: invoice.clientName || client.name,
        address: invoice.clientAddress || client.address,
        gstin: invoice.clientGstin || client.gstin,
        pan: invoice.clientPan || client.pan,
        state: invoice.clientState || client.state,
      };
      
      const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'});
      const netAmount = (invoice.netAmount || invoice.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
      const totalAmount = (invoice.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
      
      // Build GST rows HTML
      let gstRowsHtml = '';
      if (showGst) {
        if (invoice.cgst > 0 || invoice.sgst > 0) {
          gstRowsHtml = `
            <tr><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">CGST @9%:</td><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">â‚¹${(invoice.cgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
            <tr><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">SGST @9%:</td><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">â‚¹${(invoice.sgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
          `;
        } else if (invoice.igst > 0) {
          gstRowsHtml = `
            <tr><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">IGST @18%:</td><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">â‚¹${(invoice.igst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
          `;
        } else if ((invoice.gstAmount || invoice.taxAmount) > 0) {
          gstRowsHtml = `
            <tr><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">GST @18%:</td><td style="padding:8px 12px;text-align:right;font-size:13px;border-bottom:1px solid #e5e7eb;">â‚¹${(invoice.gstAmount || invoice.taxAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
          `;
        }
      }
      
      const invoiceHtml = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Invoice ${invoice.invoiceNo}</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: Arial, Helvetica, sans-serif; background: #fff; color: #000; font-size: 12px; }
  @page { size: A4 portrait; margin: 15mm; }
  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  }
  .invoice-box { max-width: 800px; margin: 0 auto; border: 2px solid ${primaryColor}; }
  .header { background-color: ${headerBg}; color: #fff; padding: 20px; }
  .header-content { display: table; width: 100%; }
  .header-left { display: table-cell; vertical-align: middle; }
  .header-right { display: table-cell; vertical-align: middle; text-align: right; }
  .logo { height: 60px; vertical-align: middle; background: #fff; padding: 4px; border-radius: 4px; margin-right: 15px; }
  .org-name { font-size: 22px; font-weight: bold; margin-bottom: 4px; }
  .org-address { font-size: 11px; opacity: 0.9; }
  .invoice-title { font-size: 20px; font-weight: bold; letter-spacing: 2px; color: #10b981; }
  .gstin { font-size: 11px; margin-top: 4px; opacity: 0.9; }
  .details-row { display: table; width: 100%; padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid ${primaryColor}; }
  .details-left, .details-right { display: table-cell; vertical-align: middle; }
  .details-right { text-align: right; }
  .label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
  .value { font-size: 16px; font-weight: bold; margin-top: 4px; }
  .bill-to { padding: 16px 20px; border-bottom: 1px solid ${primaryColor}; }
  .bill-to-label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
  .client-name { font-size: 16px; font-weight: bold; }
  .client-address { font-size: 12px; color: #64748b; margin-top: 4px; }
  .client-gstin { font-size: 11px; color: #64748b; margin-top: 4px; }
  .items-section { padding: 16px 20px; }
  .items-table { width: 100%; border-collapse: collapse; }
  .items-header { background-color: ${primaryColor}; color: #fff; }
  .items-header th { padding: 12px; text-align: left; font-weight: 600; }
  .items-header th:last-child { text-align: right; }
  .items-body td { padding: 14px 12px; border-bottom: 1px solid #e5e7eb; }
  .items-body td:last-child { text-align: right; }
  .totals-section { padding: 16px 20px; background: #f8fafc; border-top: 1px solid ${primaryColor}; }
  .totals-table { width: 300px; margin-left: auto; border-collapse: collapse; }
  .totals-table td { padding: 8px 12px; }
  .totals-table .total-row td { font-size: 16px; font-weight: bold; border-top: 2px solid ${primaryColor}; padding-top: 12px; }
  .totals-table .total-row td:last-child { color: #10b981; }
  .footer { display: table; width: 100%; padding: 16px 20px; border-top: 1px solid ${primaryColor}; }
  .bank-details { display: table-cell; vertical-align: top; font-size: 11px; }
  .bank-label { font-weight: bold; margin-bottom: 4px; }
  .signature { display: table-cell; vertical-align: top; text-align: right; }
  .signature img { height: 50px; margin-bottom: 4px; }
  .signature-text { font-size: 12px; font-weight: 600; }
</style>
</head>
<body>
<div class="invoice-box">
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        ${displayOrg.logo ? `<img src="${displayOrg.logo}" class="logo" alt="" />` : ''}
        <span style="display:inline-block;vertical-align:middle;">
          <div class="org-name">${displayOrg.name}</div>
          <div class="org-address">${displayOrg.address || ''}</div>
        </span>
      </div>
      <div class="header-right">
        <div class="invoice-title">${invoiceTitle}</div>
        ${displayOrg.gstin && showGst ? `<div class="gstin">GSTIN: ${displayOrg.gstin}</div>` : ''}
      </div>
    </div>
  </div>
  
  <div class="details-row">
    <div class="details-left">
      <div class="label">Invoice Number</div>
      <div class="value">${invoice.invoiceNo}</div>
    </div>
    <div class="details-right">
      <div class="label">Invoice Date</div>
      <div class="value">${invoiceDate}</div>
    </div>
  </div>
  
  <div class="bill-to">
    <div class="bill-to-label">Bill To</div>
    <div class="client-name">${displayClient.name}</div>
    ${displayClient.address ? `<div class="client-address">${displayClient.address}</div>` : ''}
    ${displayClient.gstin && showGst ? `<div class="client-gstin">GSTIN: ${displayClient.gstin}</div>` : ''}
  </div>
  
  <div class="items-section">
    <table class="items-table">
      <thead class="items-header">
        <tr><th>Description</th><th>Amount</th></tr>
      </thead>
      <tbody class="items-body">
        <tr><td>${invoice.serviceDescription || invoice.narration || invoice.description || 'Professional Services'}</td><td>â‚¹${netAmount}</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="totals-section">
    <table class="totals-table">
      <tr><td style="text-align:right;">Subtotal:</td><td style="text-align:right;">â‚¹${netAmount}</td></tr>
      ${gstRowsHtml}
      <tr class="total-row"><td style="text-align:right;">Total:</td><td style="text-align:right;">â‚¹${totalAmount}</td></tr>
    </table>
  </div>
  
  <div class="footer">
    ${displayOrg.bankName ? `
      <div class="bank-details">
        <div class="bank-label">Bank Details:</div>
        <div>Bank: ${displayOrg.bankName}</div>
        <div>A/C No: ${displayOrg.bankAccount || ''}</div>
        <div>IFSC: ${displayOrg.bankIfsc || ''}</div>
      </div>
    ` : '<div></div>'}
    <div class="signature">
      ${displayOrg.signature ? `<img src="${displayOrg.signature}" alt="Signature" />` : ''}
      <div class="signature-text">For ${displayOrg.name}</div>
      ${displayOrg.signatory ? `<div style="font-size:11px;color:#64748b;">${displayOrg.signatory}</div>` : ''}
    </div>
  </div>
</div>
<script>window.onload=function(){setTimeout(function(){window.print();},300);};</script>
</body>
</html>`;
      
      // Open in new window and trigger print
      const printWindow = window.open('', '_blank', 'width=850,height=1100');
      printWindow.document.write(invoiceHtml);
      printWindow.document.close();
    };
    
    // Download multiple invoices - properly formatted
    const downloadMultipleInvoices = (invoices, orgs, clients, asSingle = false) => {
      if (!invoices || invoices.length === 0) return;
      
      if (asSingle) {
        // Build combined HTML with proper formatting
        let combinedHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Invoices - ${invoices.map(i => i.invoiceNo).join(', ')}</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: Arial, Helvetica, sans-serif; background: #fff; color: #1f2937; font-size: 12px; }
              .invoice-wrapper { max-width: 800px; margin: 0 auto; }
              .invoice-container { border: 2px solid #111827; margin-bottom: 20px; background: #fff; }
              .header { background: #111827; color: #fff; padding: 20px 25px; }
              .header-content { display: table; width: 100%; }
              .header-left { display: table-cell; vertical-align: middle; }
              .header-right { display: table-cell; text-align: right; vertical-align: middle; }
              .org-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
              .org-address { font-size: 11px; opacity: 0.9; max-width: 300px; }
              .invoice-title { font-size: 24px; font-weight: bold; letter-spacing: 2px; }
              .org-contact { font-size: 11px; opacity: 0.9; margin-top: 5px; }
              .meta-row { display: table; width: 100%; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
              .meta-cell { display: table-cell; padding: 12px 15px; border-right: 1px solid #e5e7eb; width: 25%; }
              .meta-cell:last-child { border-right: none; }
              .meta-label { font-size: 9px; color: #6b7280; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
              .meta-value { font-size: 14px; font-weight: 700; color: #111827; margin-top: 2px; }
              .party-row { display: table; width: 100%; border-bottom: 1px solid #e5e7eb; }
              .party-cell { display: table-cell; padding: 15px 20px; vertical-align: top; width: 50%; }
              .party-cell:first-child { border-right: 1px solid #e5e7eb; }
              .party-label { font-size: 10px; color: #fff; background: #111827; display: inline-block; padding: 2px 8px; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 8px; }
              .party-name { font-size: 14px; font-weight: 600; color: #1f2937; }
              .party-detail { font-size: 11px; color: #6b7280; margin-top: 3px; }
              .items-table { width: 100%; border-collapse: collapse; }
              .items-header { background: #111827; }
              .items-header th { padding: 10px 12px; text-align: left; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px; border-right: 1px solid rgba(255,255,255,0.2); }
              .items-header th:last-child { border-right: none; text-align: right; }
              .items-header th:first-child { text-align: center; width: 40px; }
              .items-row td { padding: 14px 12px; border-bottom: 1px solid #e5e7eb; }
              .bottom-row { display: table; width: 100%; border-top: 1px solid #374151; }
              .bottom-left { display: table-cell; padding: 15px 20px; vertical-align: top; width: 55%; border-right: 1px solid #e5e7eb; }
              .bottom-right { display: table-cell; padding: 0; vertical-align: top; width: 45%; }
              .section-label { font-size: 10px; color: #fff; background: #374151; display: inline-block; padding: 2px 8px; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 6px; }
              .amount-words { font-size: 12px; font-weight: 500; color: #1f2937; font-style: italic; margin-bottom: 12px; }
              .bank-details { font-size: 11px; color: #4b5563; line-height: 1.6; }
              .totals-table { width: 100%; border-collapse: collapse; }
              .totals-table td { padding: 8px 15px; border-bottom: 1px solid #e5e7eb; }
              .total-row { background: #111827; }
              .total-row td { color: #fff; font-size: 14px; font-weight: 700; padding: 12px 15px; border: none; }
              .signature-row { display: table; width: 100%; border-top: 1px solid #e5e7eb; }
              .signature-cell { display: table-cell; padding: 15px 20px; text-align: right; vertical-align: bottom; }
              .signature-name { font-size: 12px; font-weight: 600; color: #1f2937; }
              .signatory { font-size: 11px; color: #6b7280; }
              .footer { background: #111827; padding: 8px 20px; font-size: 9px; color: #fff; text-align: center; }
              @media print {
                body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                .page-break { page-break-after: always; }
                .invoice-container { border: 2px solid #111827 !important; margin-bottom: 0; }
                .header, .items-header, .total-row, .party-label, .section-label, .footer { background: #111827 !important; -webkit-print-color-adjust: exact !important; }
              }
            </style>
          </head>
          <body>
        `;
        
        invoices.forEach((invoice, idx) => {
          const currentOrg = orgs?.find(o => o.id === (invoice.orgId || invoice.organizationId)) || {};
          const client = clients?.find(c => c.id === invoice.clientId) || {};
          
          const gstApplicable = invoice.gstApplicable !== false && currentOrg.gstApplicable === 'yes';
          const invoiceFormat = invoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
          const showGst = gstApplicable && invoiceFormat !== 'billOfSupply';
          
          let invoiceTitle = 'TAX INVOICE';
          if (invoiceFormat === 'billOfSupply') invoiceTitle = 'BILL OF SUPPLY';
          else if (invoiceFormat === 'proformaInvoice') invoiceTitle = 'PROFORMA INVOICE';
          
          const displayOrg = {
            name: currentOrg.name || invoice.orgName || invoice.organizationName || '',
            address: currentOrg.address || invoice.orgAddress || '',
            mobile: currentOrg.mobile || '',
            gstin: currentOrg.gstin || invoice.orgGstin || '',
            pan: currentOrg.pan || '',
            bankName: currentOrg.bankName || '',
            bankAccount: currentOrg.bankAccount || currentOrg.bankAccountNo || '',
            bankIfsc: currentOrg.bankIfsc || '',
            signatory: currentOrg.signatory || '',
          };
          
          const displayClient = {
            name: invoice.clientName || client.name || '',
            address: invoice.clientAddress || client.address || '',
            gstin: invoice.clientGstin || client.gstin || '',
            state: invoice.clientState || client.state || '',
            code: invoice.clientCode || '',
          };
          
          const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'});
          const netAmount = invoice.netAmount || invoice.amount || 0;
          const totalAmount = invoice.totalAmount || 0;
          
          // Build line items
          let lineItemsHtml = '';
          if (invoice.lineItems && invoice.lineItems.length > 0) {
            invoice.lineItems.forEach((item, i) => {
              lineItemsHtml += `
                <tr class="items-row" style="background: ${i % 2 === 0 ? '#fff' : '#f9fafb'};">
                  <td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">${i + 1}</td>
                  <td style="font-weight: 500; color: #1f2937; border-right: 1px solid #e5e7eb;">${item.description || 'Professional Services'}</td>
                  ${showGst ? `<td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">998231</td>` : ''}
                  ${showGst ? `<td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">18%</td>` : ''}
                  <td style="text-align: right; font-weight: 600; color: #1f2937;">â‚¹${(item.netAmount || item.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                </tr>
              `;
            });
          } else {
            lineItemsHtml = `
              <tr class="items-row">
                <td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">1</td>
                <td style="font-weight: 500; color: #1f2937; border-right: 1px solid #e5e7eb;">${invoice.serviceDescription || invoice.narration || 'Professional Services'}</td>
                ${showGst ? `<td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">${invoice.sac || '998231'}</td>` : ''}
                ${showGst ? `<td style="text-align: center; color: #6b7280; border-right: 1px solid #e5e7eb;">18%</td>` : ''}
                <td style="text-align: right; font-weight: 600; color: #1f2937;">â‚¹${netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
              </tr>
            `;
          }
          
          // GST rows
          let gstRowsHtml = '';
          if (showGst) {
            if (invoice.cgst > 0) gstRowsHtml += `<tr><td style="color: #6b7280;">CGST @9%</td><td style="text-align: right; font-weight: 600;">â‚¹${(invoice.cgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
            if (invoice.sgst > 0) gstRowsHtml += `<tr><td style="color: #6b7280;">SGST @9%</td><td style="text-align: right; font-weight: 600;">â‚¹${(invoice.sgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
            if (invoice.igst > 0) gstRowsHtml += `<tr><td style="color: #6b7280;">IGST @18%</td><td style="text-align: right; font-weight: 600;">â‚¹${(invoice.igst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
          }
          
          combinedHtml += `
            <div class="invoice-wrapper ${idx < invoices.length - 1 ? 'page-break' : ''}">
              <div class="invoice-container">
                <!-- Header -->
                <div class="header">
                  <div class="header-content">
                    <div class="header-left">
                      <div class="org-name">${displayOrg.name}</div>
                      <div class="org-address">${displayOrg.address}</div>
                    </div>
                    <div class="header-right">
                      <div class="invoice-title">${invoiceTitle}</div>
                      ${displayOrg.mobile ? `<div class="org-contact">Tel: ${displayOrg.mobile}</div>` : ''}
                      ${showGst && displayOrg.gstin ? `<div style="font-size: 11px; margin-top: 3px;">GSTIN: ${displayOrg.gstin}</div>` : ''}
                    </div>
                  </div>
                </div>
                
                <!-- Invoice Meta -->
                <div class="meta-row">
                  <div class="meta-cell">
                    <div class="meta-label">Invoice No.</div>
                    <div class="meta-value">${invoice.invoiceNo}</div>
                  </div>
                  <div class="meta-cell">
                    <div class="meta-label">Date</div>
                    <div class="meta-value">${invoiceDate}</div>
                  </div>
                  <div class="meta-cell">
                    <div class="meta-label">Place of Supply</div>
                    <div class="meta-value">${displayClient.state || '-'}</div>
                  </div>
                  <div class="meta-cell">
                    <div class="meta-label">Client Code</div>
                    <div class="meta-value">${displayClient.code || '-'}</div>
                  </div>
                </div>
                
                <!-- Party Details -->
                <div class="party-row">
                  <div class="party-cell">
                    <div class="party-label">FROM</div>
                    <div class="party-name">${displayOrg.name}</div>
                    ${showGst && displayOrg.gstin ? `<div class="party-detail">GSTIN: <strong>${displayOrg.gstin}</strong></div>` : ''}
                    ${displayOrg.pan ? `<div class="party-detail">PAN: <strong>${displayOrg.pan}</strong></div>` : ''}
                  </div>
                  <div class="party-cell">
                    <div class="party-label">BILL TO</div>
                    <div class="party-name">${displayClient.name}</div>
                    ${displayClient.address ? `<div class="party-detail">${displayClient.address}</div>` : ''}
                    ${showGst && displayClient.gstin ? `<div class="party-detail">GSTIN: <strong>${displayClient.gstin}</strong></div>` : ''}
                  </div>
                </div>
                
                <!-- Items Table -->
                <table class="items-table">
                  <thead>
                    <tr class="items-header">
                      <th style="text-align: center; width: 40px;">S.No</th>
                      <th>Description of Services</th>
                      ${showGst ? '<th style="text-align: center; width: 70px;">SAC</th>' : ''}
                      ${showGst ? '<th style="text-align: center; width: 50px;">Tax%</th>' : ''}
                      <th style="text-align: right; width: 120px;">Amount (â‚¹)</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${lineItemsHtml}
                  </tbody>
                </table>
                
                <!-- Bottom Section -->
                <div class="bottom-row">
                  <div class="bottom-left">
                    <div style="margin-bottom: 12px;">
                      <div class="section-label">AMOUNT IN WORDS</div>
                      <div class="amount-words">${invoice.amountInWords || 'Rupees ' + numberToWords(Math.round(totalAmount)) + ' Only'}</div>
                    </div>
                    <div>
                      <div class="section-label">BANK DETAILS</div>
                      <div class="bank-details">
                        <div>Bank: <strong>${displayOrg.bankName || '-'}</strong></div>
                        <div>A/C No: <strong>${displayOrg.bankAccount || '-'}</strong></div>
                        <div>IFSC: <strong>${displayOrg.bankIfsc || '-'}</strong></div>
                      </div>
                    </div>
                  </div>
                  <div class="bottom-right">
                    <table class="totals-table">
                      <tr>
                        <td style="color: #6b7280;">Subtotal</td>
                        <td style="text-align: right; font-weight: 600;">â‚¹${netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                      </tr>
                      ${invoice.discount > 0 ? `<tr><td style="color: #6b7280;">Discount</td><td style="text-align: right; font-weight: 600; color: #dc2626;">- â‚¹${(invoice.discount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>` : ''}
                      ${gstRowsHtml}
                      <tr class="total-row">
                        <td>TOTAL</td>
                        <td style="text-align: right;">â‚¹${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                      </tr>
                    </table>
                  </div>
                </div>
                
                <!-- Signature -->
                <div class="signature-row">
                  <div class="signature-cell">
                    <div style="margin-bottom: 30px;"></div>
                    <div class="signature-name">For ${displayOrg.name}</div>
                    ${displayOrg.signatory ? `<div class="signatory">${displayOrg.signatory}</div>` : ''}
                    <div class="signatory">Authorized Signatory</div>
                  </div>
                </div>
                
                <!-- Footer -->
                <div class="footer">
                  Computer generated ${invoiceTitle.toLowerCase()}. ${showGst ? 'Subject to local jurisdiction.' : 'GST Not Applicable.'}
                </div>
              </div>
            </div>
          `;
        });
        
        combinedHtml += `
            <script>window.onload = function() { setTimeout(function() { window.print(); }, 500); };</script>
          </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank', 'width=850,height=1100');
        printWindow.document.write(combinedHtml);
        printWindow.document.close();
      } else {
        // For individual PDFs, open each in sequence with a delay
        invoices.forEach((invoice, idx) => {
          setTimeout(() => {
            downloadInvoicePDF(invoice, orgs, clients);
          }, idx * 1500);
        });
      }
    };
    
    // Format date
    const formatInvoiceDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    // Generate invoice HTML with inline styles for PDF generation
    const generateInvoiceHtmlForPdf = (invoice, orgs, clients) => {
      const currentOrg = orgs?.find(o => o.id === (invoice.orgId || invoice.organizationId)) || {};
      const client = clients?.find(c => c.id === invoice.clientId) || {};
      
      const gstApplicable = invoice.gstApplicable !== false && currentOrg.gstApplicable === 'yes';
      const invoiceFormat = invoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
      const showGst = gstApplicable && invoiceFormat !== 'billOfSupply';
      
      let invoiceTitle = 'TAX INVOICE';
      if (invoiceFormat === 'billOfSupply') invoiceTitle = 'BILL OF SUPPLY';
      else if (invoiceFormat === 'proformaInvoice') invoiceTitle = 'PROFORMA INVOICE';
      
      const primaryColor = '#111827';
      
      const displayOrg = {
        name: currentOrg.name || invoice.orgName || invoice.organizationName || '',
        address: currentOrg.address || invoice.orgAddress || '',
        mobile: currentOrg.mobile || currentOrg.mobileNo || '',
        gstin: currentOrg.gstin || invoice.orgGstin || '',
        pan: currentOrg.pan || currentOrg.panNo || '',
        bankName: currentOrg.bankName || '',
        bankAccount: currentOrg.bankAccount || currentOrg.bankAccountNo || '',
        bankIfsc: currentOrg.bankIfsc || '',
        signatory: currentOrg.signatory || currentOrg.authorizedSignatory || '',
        logo: currentOrg.logo || invoice.orgLogo || '',
        signature: currentOrg.signature || currentOrg.signatureImage || invoice.orgSignature || '',
      };
      
      const displayClient = {
        name: invoice.clientName || client.name || '',
        address: invoice.clientAddress || client.address || '',
        gstin: invoice.clientGstin || client.gstin || '',
        state: invoice.clientState || client.state || '',
        code: invoice.clientCode || '',
      };
      
      const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'});
      const netAmount = invoice.netAmount || invoice.amount || 0;
      const totalAmount = invoice.totalAmount || 0;
      
      // Build line items
      let lineItemsHtml = '';
      if (invoice.lineItems && invoice.lineItems.length > 0) {
        invoice.lineItems.forEach((item, i) => {
          lineItemsHtml += `
            <tr style="background: ${i % 2 === 0 ? '#fff' : '#f9fafb'};">
              <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">${i + 1}</td>
              <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 500; color: #1f2937;">${item.description || 'Professional Services'}</td>
              ${showGst ? `<td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">998231</td>` : ''}
              ${showGst ? `<td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">18%</td>` : ''}
              <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¹${(item.netAmount || item.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
            </tr>
          `;
        });
      } else {
        const description = invoice.serviceDescription || invoice.narration || 'Professional Services';
        lineItemsHtml = `
          <tr>
            <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">1</td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 500; color: #1f2937;">${description}</td>
            ${showGst ? `<td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">${invoice.sac || '998231'}</td>` : ''}
            ${showGst ? `<td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #6b7280;">18%</td>` : ''}
            <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¹${netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
          </tr>
        `;
      }
      
      // Build GST rows
      let gstRowsHtml = '';
      if (showGst) {
        if (invoice.cgst > 0) gstRowsHtml += `<tr><td style="padding: 10px 15px; border: 1px solid #e5e7eb; color: #6b7280;">CGST @9%</td><td style="padding: 10px 15px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600;">â‚¹${(invoice.cgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
        if (invoice.sgst > 0) gstRowsHtml += `<tr><td style="padding: 10px 15px; border: 1px solid #e5e7eb; color: #6b7280;">SGST @9%</td><td style="padding: 10px 15px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600;">â‚¹${(invoice.sgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
        if (invoice.igst > 0) gstRowsHtml += `<tr><td style="padding: 10px 15px; border: 1px solid #e5e7eb; color: #6b7280;">IGST @18%</td><td style="padding: 10px 15px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600;">â‚¹${(invoice.igst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
      }
      
      return `
        <div class="invoice-container" style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; border: 2px solid ${primaryColor}; background: #fff;">
          <!-- Header -->
          <div style="background: ${primaryColor}; color: #fff; padding: 20px 25px;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="vertical-align: middle; width: 60%;">
                  ${displayOrg.logo ? `<img src="${displayOrg.logo}" crossorigin="anonymous" style="height: 50px; vertical-align: middle; background: #fff; padding: 4px; border-radius: 4px; margin-right: 15px;" />` : ''}
                  <span style="display: inline-block; vertical-align: middle;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">${displayOrg.name}</div>
                    <div style="font-size: 11px; opacity: 0.9;">${displayOrg.address}</div>
                    ${displayOrg.mobile ? `<div style="font-size: 11px; opacity: 0.9; margin-top: 3px;">Tel: ${displayOrg.mobile}</div>` : ''}
                  </span>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                  <div style="font-size: 22px; font-weight: bold; letter-spacing: 2px; color: #10b981;">${invoiceTitle}</div>
                  ${showGst && displayOrg.gstin ? `<div style="font-size: 11px; margin-top: 5px;">GSTIN: ${displayOrg.gstin}</div>` : ''}
                </td>
              </tr>
            </table>
          </div>
          
          <!-- Invoice Meta -->
          <table style="width: 100%; border-collapse: collapse; background: #f9fafb;">
            <tr>
              <td style="padding: 12px 15px; border: 1px solid #e5e7eb; width: 25%;">
                <div style="font-size: 9px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Invoice No.</div>
                <div style="font-size: 14px; font-weight: 700; color: ${primaryColor}; margin-top: 2px;">${invoice.invoiceNo}</div>
              </td>
              <td style="padding: 12px 15px; border: 1px solid #e5e7eb; width: 25%;">
                <div style="font-size: 9px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Date</div>
                <div style="font-size: 14px; font-weight: 700; color: ${primaryColor}; margin-top: 2px;">${invoiceDate}</div>
              </td>
              <td style="padding: 12px 15px; border: 1px solid #e5e7eb; width: 25%;">
                <div style="font-size: 9px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Place of Supply</div>
                <div style="font-size: 14px; font-weight: 700; color: ${primaryColor}; margin-top: 2px;">${displayClient.state || '-'}</div>
              </td>
              <td style="padding: 12px 15px; border: 1px solid #e5e7eb; width: 25%;">
                <div style="font-size: 9px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Client Code</div>
                <div style="font-size: 14px; font-weight: 700; color: ${primaryColor}; margin-top: 2px;">${displayClient.code || '-'}</div>
              </td>
            </tr>
          </table>
          
          <!-- Party Details -->
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 15px 20px; border: 1px solid #e5e7eb; width: 50%; vertical-align: top;">
                <div style="font-size: 10px; color: #fff; background: ${primaryColor}; display: inline-block; padding: 2px 8px; font-weight: 600; margin-bottom: 8px;">FROM</div>
                <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${displayOrg.name}</div>
                ${showGst && displayOrg.gstin ? `<div style="font-size: 11px; color: #4b5563; margin-top: 4px;">GSTIN: <strong>${displayOrg.gstin}</strong></div>` : ''}
                ${displayOrg.pan ? `<div style="font-size: 11px; color: #4b5563;">PAN: <strong>${displayOrg.pan}</strong></div>` : ''}
              </td>
              <td style="padding: 15px 20px; border: 1px solid #e5e7eb; width: 50%; vertical-align: top;">
                <div style="font-size: 10px; color: #fff; background: ${primaryColor}; display: inline-block; padding: 2px 8px; font-weight: 600; margin-bottom: 8px;">BILL TO</div>
                <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${displayClient.name}</div>
                ${displayClient.address ? `<div style="font-size: 11px; color: #6b7280; margin-top: 3px;">${displayClient.address}</div>` : ''}
                ${showGst && displayClient.gstin ? `<div style="font-size: 11px; color: #4b5563; margin-top: 4px;">GSTIN: <strong>${displayClient.gstin}</strong></div>` : ''}
              </td>
            </tr>
          </table>
          
          <!-- Items Table -->
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: ${primaryColor};">
                <th style="padding: 10px 12px; text-align: center; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; border: 1px solid ${primaryColor}; width: 50px;">S.No</th>
                <th style="padding: 10px 12px; text-align: left; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; border: 1px solid ${primaryColor};">Description of Services</th>
                ${showGst ? `<th style="padding: 10px 12px; text-align: center; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; border: 1px solid ${primaryColor}; width: 70px;">SAC</th>` : ''}
                ${showGst ? `<th style="padding: 10px 12px; text-align: center; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; border: 1px solid ${primaryColor}; width: 50px;">Tax%</th>` : ''}
                <th style="padding: 10px 12px; text-align: right; color: #fff; font-weight: 600; font-size: 10px; text-transform: uppercase; border: 1px solid ${primaryColor}; width: 120px;">Amount (â‚¹)</th>
              </tr>
            </thead>
            <tbody>
              ${lineItemsHtml}
            </tbody>
          </table>
          
          <!-- Bottom Section -->
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 15px 20px; border: 1px solid #e5e7eb; width: 55%; vertical-align: top;">
                <div style="margin-bottom: 12px;">
                  <div style="font-size: 10px; color: #fff; background: #374151; display: inline-block; padding: 2px 8px; font-weight: 600; margin-bottom: 6px;">AMOUNT IN WORDS</div>
                  <div style="font-size: 12px; font-weight: 500; color: #1f2937; font-style: italic;">Rupees ${numberToWords(Math.round(totalAmount))} Only</div>
                </div>
                <div>
                  <div style="font-size: 10px; color: #fff; background: #374151; display: inline-block; padding: 2px 8px; font-weight: 600; margin-bottom: 6px;">BANK DETAILS</div>
                  <div style="font-size: 11px; color: #4b5563; line-height: 1.6;">
                    <div>Bank: <strong>${displayOrg.bankName || '-'}</strong></div>
                    <div>A/C No: <strong>${displayOrg.bankAccount || '-'}</strong></div>
                    <div>IFSC: <strong>${displayOrg.bankIfsc || '-'}</strong></div>
                  </div>
                </div>
              </td>
              <td style="padding: 0; border: 1px solid #e5e7eb; width: 45%; vertical-align: top;">
                <table style="width: 100%; border-collapse: collapse;">
                  <tr><td style="padding: 10px 15px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Subtotal</td><td style="padding: 10px 15px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">â‚¹${netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
                  ${invoice.discount > 0 ? `<tr><td style="padding: 10px 15px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Discount</td><td style="padding: 10px 15px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #dc2626;">- â‚¹${(invoice.discount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>` : ''}
                  ${gstRowsHtml}
                  <tr style="background: ${primaryColor};"><td style="padding: 12px 15px; font-size: 14px; font-weight: 700; color: #fff;">TOTAL</td><td style="padding: 12px 15px; text-align: right; font-size: 14px; font-weight: 700; color: #fff;">â‚¹${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
                </table>
              </td>
            </tr>
          </table>
          
          <!-- Signature -->
          <div style="padding: 15px 20px; text-align: right; border: 1px solid #e5e7eb;">
            ${displayOrg.signature ? `<img src="${displayOrg.signature}" crossorigin="anonymous" style="height: 50px; margin-bottom: 8px;" />` : '<div style="margin-bottom: 40px;"></div>'}
            <div style="font-size: 12px; font-weight: 600; color: #1f2937;">For ${displayOrg.name}</div>
            ${displayOrg.signatory ? `<div style="font-size: 11px; color: #6b7280;">${displayOrg.signatory}</div>` : ''}
            <div style="font-size: 11px; color: #6b7280;">Authorized Signatory</div>
          </div>
          
          <!-- Footer -->
          <div style="background: ${primaryColor}; padding: 8px 20px; font-size: 9px; color: #fff; text-align: center;">
            Computer generated ${invoiceTitle.toLowerCase()}. ${showGst ? 'Subject to local jurisdiction.' : 'GST Not Applicable.'}
          </div>
        </div>
      `;
    };

    // Download invoices as ZIP with individual PDFs
    const downloadInvoicesAsZip = async (invoices, orgs, clients, batchName = 'invoices') => {
      if (!invoices || invoices.length === 0) return;
      
      // Load JSZip dynamically
      if (!window.JSZip) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }
      
      // Load html2pdf dynamically
      if (!window.html2pdf) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }
      
      const zip = new window.JSZip();
      const invoiceFolder = zip.folder('Invoices');
      
      // Show progress
      const progressDiv = document.createElement('div');
      progressDiv.id = 'zip-progress';
      progressDiv.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;">
          <div style="background:#fff;padding:40px;border-radius:16px;text-align:center;min-width:300px;">
            <div style="font-size:48px;margin-bottom:16px;">ðŸ“¦</div>
            <div style="font-size:18px;font-weight:700;color:#1e293b;margin-bottom:8px;">Generating PDFs...</div>
            <div id="zip-progress-text" style="font-size:14px;color:#64748b;">0 of ${invoices.length} invoices</div>
            <div style="margin-top:16px;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
              <div id="zip-progress-bar" style="height:100%;background:#10b981;width:0%;transition:width 0.3s;"></div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(progressDiv);
      
      try {
        for (let idx = 0; idx < invoices.length; idx++) {
          const invoice = invoices[idx];
          
          // Update progress
          document.getElementById('zip-progress-text').innerText = `${idx + 1} of ${invoices.length} invoices`;
          document.getElementById('zip-progress-bar').style.width = `${((idx + 1) / invoices.length) * 100}%`;
          
          // Generate HTML
          const invoiceHtml = generateInvoiceHtmlForPdf(invoice, orgs, clients);
          
          // Create temporary container
          const container = document.createElement('div');
          container.innerHTML = invoiceHtml;
          container.style.position = 'absolute';
          container.style.left = '-9999px';
          container.style.width = '800px';
          container.style.background = '#fff';
          document.body.appendChild(container);
          
          // Wait for render
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Generate PDF
          const opt = {
            margin: [10, 10, 10, 10],
            filename: `${invoice.invoiceNo}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2, 
              useCORS: true, 
              logging: false,
              backgroundColor: '#ffffff'
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          
          const pdfBlob = await window.html2pdf().set(opt).from(container.querySelector('.invoice-container') || container).outputPdf('blob');
          
          // Add to ZIP
          const clientName = (invoice.clientName || 'Client').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
          const fileName = `${invoice.invoiceNo.replace(/[^a-zA-Z0-9]/g, '_')}_${clientName}.pdf`;
          invoiceFolder.file(fileName, pdfBlob);
          
          // Clean up
          document.body.removeChild(container);
          
          // Small delay
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        // Generate ZIP
        document.getElementById('zip-progress-text').innerText = 'Creating ZIP file...';
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        // Download
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.download = `${batchName}_${new Date().toISOString().split('T')[0]}.zip`;
        downloadLink.click();
        
        URL.revokeObjectURL(downloadLink.href);
        document.body.removeChild(progressDiv);
        
        alert(`âœ… Successfully downloaded ${invoices.length} invoices as ZIP!`);
      } catch (error) {
        console.error('Error generating ZIP:', error);
        document.body.removeChild(progressDiv);
        alert('Error generating ZIP: ' + error.message + '\n\nPlease try the Print All option instead.');
      }
    };

    const resetOrgForm = () => {
      setOrgForm({
        name: '',
        website: '',
        faxNo: '',
        authorizedSignatory: '',
        phoneNo: '',
        mobileNo: '',
        alternateMobileNo: '',
        emailId: '',
        gstin: '',
        panNo: '',
        upiId: '',
        mmid: '',
        otherMobileNo: '',
        state: '',
        address: '',
        logo: null,
        logoPreview: '',
        signatureImage: null,
        signaturePreview: '',
        qrCode: null,
        qrCodePreview: '',
        bankName: '',
        bankAccountNo: '',
        bankIfsc: '',
        bankBranch: '',
        gstApplicable: 'yes',
        allowBackdatedInvoicing: true,
        displayFileNoInInvoice: true,
        invoiceFormat: 'taxInvoice', // taxInvoice, billOfSupply, proformaInvoice, billOfSupplyBlue
        invoiceTheme: 'green', // green, blue
        invoicePrefix: 'INV',
        invoiceStartNo: 1,
        invoiceCurrentNo: 1,
        invoiceSuffix: '',
        receiptPrefix: 'RCP',
        receiptStartNo: 1,
        receiptCurrentNo: 1,
        receiptSuffix: ''
      });
      setEditingOrg(null);
    };

    const handleImageUpload = (e, field) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = () => {
          setOrgForm(prev => ({
            ...prev,
            [field]: file,
            [`${field}Preview`]: reader.result
          }));
        };
        reader.readAsDataURL(file);
      }
    };

    // Helper function to upload image to Firebase Storage
    const uploadImageToStorage = async (base64Data, orgId, imageType) => {
      if (!base64Data || !base64Data.startsWith('data:')) {
        return base64Data; // Return as-is if it's already a URL or empty
      }
      
      try {
        // Convert base64 to blob
        const response = await fetch(base64Data);
        const blob = await response.blob();
        
        // Create storage reference
        const storageRef = ref(storage, `organizations/${orgId}/${imageType}_${Date.now()}`);
        
        // Upload
        await uploadBytes(storageRef, blob);
        
        // Get download URL
        const downloadURL = await getDownloadURL(storageRef);
        console.log(`âœ… Uploaded ${imageType} to Storage:`, downloadURL);
        
        return downloadURL;
      } catch (error) {
        console.error(`âŒ Failed to upload ${imageType}:`, error);
        return null; // Return null on failure, don't block save
      }
    };

    const saveOrganization = async () => {
      console.log('=== saveOrganization called ===');
      
      if (!orgForm.name) {
        alert('Organization name is required');
        return;
      }

      const orgId = editingOrg ? editingOrg.id : generateId();
      
      // Show loading message for image upload
      let logoUrl = orgForm.logoPreview || editingOrg?.logo || null;
      let signatureUrl = orgForm.signaturePreview || editingOrg?.signatureImage || null;
      let qrCodeUrl = orgForm.qrCodePreview || editingOrg?.qrCode || null;
      
      // Upload images to Firebase Storage if they are base64
      if (orgForm.logoPreview && orgForm.logoPreview.startsWith('data:')) {
        console.log('Uploading logo to Firebase Storage...');
        logoUrl = await uploadImageToStorage(orgForm.logoPreview, orgId, 'logo');
      }
      
      if (orgForm.signaturePreview && orgForm.signaturePreview.startsWith('data:')) {
        console.log('Uploading signature to Firebase Storage...');
        signatureUrl = await uploadImageToStorage(orgForm.signaturePreview, orgId, 'signature');
      }
      
      if (orgForm.qrCodePreview && orgForm.qrCodePreview.startsWith('data:')) {
        console.log('Uploading QR code to Firebase Storage...');
        qrCodeUrl = await uploadImageToStorage(orgForm.qrCodePreview, orgId, 'qrcode');
      }
      
      // Create clean org data with Storage URLs instead of base64
      const orgData = {
        id: orgId,
        name: orgForm.name || '',
        website: orgForm.website || '',
        faxNo: orgForm.faxNo || '',
        authorizedSignatory: orgForm.authorizedSignatory || '',
        phoneNo: orgForm.phoneNo || '',
        mobileNo: orgForm.mobileNo || '',
        alternateMobileNo: orgForm.alternateMobileNo || '',
        emailId: orgForm.emailId || '',
        gstin: orgForm.gstin || '',
        panNo: orgForm.panNo || '',
        upiId: orgForm.upiId || '',
        mmid: orgForm.mmid || '',
        otherMobileNo: orgForm.otherMobileNo || '',
        state: orgForm.state || '',
        address: orgForm.address || '',
        bankName: orgForm.bankName || '',
        bankAccountNo: orgForm.bankAccountNo || '',
        bankIfsc: orgForm.bankIfsc || '',
        bankBranch: orgForm.bankBranch || '',
        gstApplicable: orgForm.gstApplicable || 'yes',
        invoiceFormat: orgForm.invoiceFormat || (orgForm.gstApplicable === 'yes' ? 'taxInvoice' : 'billOfSupply'),
        allowBackdatedInvoicing: orgForm.allowBackdatedInvoicing !== false,
        displayFileNoInInvoice: orgForm.displayFileNoInInvoice !== false,
        invoicePrefix: orgForm.invoicePrefix || 'INV',
        invoiceStartNo: orgForm.invoiceStartNo || 1,
        invoiceCurrentNo: orgForm.invoiceCurrentNo || orgForm.invoiceStartNo || 1,
        invoiceSuffix: orgForm.invoiceSuffix || '',
        receiptPrefix: orgForm.receiptPrefix || 'RCP',
        receiptStartNo: orgForm.receiptStartNo || 1,
        receiptCurrentNo: orgForm.receiptCurrentNo || orgForm.receiptStartNo || 1,
        receiptSuffix: orgForm.receiptSuffix || '',
        // Store Firebase Storage URLs (not base64)
        logo: logoUrl,
        signatureImage: signatureUrl,
        qrCode: qrCodeUrl,
        createdAt: editingOrg ? editingOrg.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      console.log('Clean orgData to save:', orgData);

      if (editingOrg) {
        setData(prev => ({
          ...prev,
          organizations: prev.organizations.map(o => o.id === editingOrg.id ? orgData : o)
        }));
        alert('Organization updated successfully!');
      } else {
        setData(prev => ({
          ...prev,
          organizations: [...(prev.organizations || []), orgData]
        }));
        alert('Organization created successfully!');
      }

      setShowOrgModal(false);
      resetOrgForm();
    };

    const editOrganization = (org) => {
      setEditingOrg(org);
      
      // Ensure invoiceFormat has a default value
      const gstApplicable = org.gstApplicable || 'yes';
      const invoiceFormat = org.invoiceFormat || (gstApplicable === 'yes' ? 'taxInvoice' : 'billOfSupply');
      
      // Use images from org directly (they're stored in state)
      const logo = org.logo || '';
      const signatureImage = org.signatureImage || '';
      const qrCode = org.qrCode || '';
      
      setOrgForm({
        ...org,
        invoiceFormat,
        logo,
        signatureImage,
        qrCode,
        logoPreview: logo,
        signaturePreview: signatureImage,
        qrCodePreview: qrCode
      });
      setShowOrgModal(true);
    };

    const deleteOrganization = (orgId) => {
      if (window.confirm('Delete this organization?')) {
        setData(prev => ({
          ...prev,
          organizations: prev.organizations.filter(o => o.id !== orgId)
        }));
      }
    };

    // Get page title based on active tab
    const getPageTitle = () => {
      switch(activeTab) {
        case 'dashboard': return 'Billing Dashboard';
        case 'billing': return 'Billing';
        case 'receipts': return 'Receipts';
        case 'debtors': return 'Debtors Ledger';
        case 'organizations': return 'Manage Organizations';
        default: return 'Invoicing';
      }
    };

    return (
      <div className="invoicing-view">
        <div className="view-header">
          <div>
            <h1>{getPageTitle()}</h1>
            <p className="view-subtitle">
              {activeTab === 'dashboard' && 'Overview of billing, collections and outstanding'}
              {activeTab === 'billing' && 'Create and manage invoices'}
              {activeTab === 'unbilledTasks' && 'View and manage unbilled tasks'}
              {activeTab === 'receipts' && 'Create and manage receipts'}
              {activeTab === 'debtors' && 'View debtor ledger and outstanding balances'}
              {activeTab === 'organizations' && 'Manage billing organizations'}
            </p>
          </div>
        </div>

        {/* Dashboard Tab Content */}
        {activeTab === 'dashboard' && (
          <div>
            {/* Financial Year Selector */}
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px'}}>
              <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                <span style={{fontWeight: '600', color: '#1e293b'}}>Select Financial Year:</span>
                <select
                  value={dashboardFY}
                  onChange={(e) => setDashboardFY(e.target.value)}
                  style={{padding: '10px 16px', border: '2px solid #10b981', borderRadius: '8px', fontSize: '14px', fontWeight: '600', color: '#1e293b', background: '#f0fdf4', cursor: 'pointer'}}
                >
                  <option value="FY 2023-24">FY 2023-24</option>
                  <option value="FY 2024-25">FY 2024-25</option>
                  <option value="FY 2025-26">FY 2025-26</option>
                </select>
              </div>
            </div>

            {/* Summary Cards */}
            {(() => {
              const fyStartYear = parseInt(dashboardFY.replace('FY ', '').split('-')[0]);
              const fyStart = new Date(fyStartYear, 3, 1); // April 1
              const fyEnd = new Date(fyStartYear + 1, 2, 31, 23, 59, 59); // March 31
              
              // Filter invoices by invoice date falling within FY (same logic as Bill Register)
              const fyInvoices = (data.invoices || []).filter(inv => {
                if (!inv.invoiceDate) return false;
                const invDate = new Date(inv.invoiceDate);
                return invDate >= fyStart && invDate <= fyEnd;
              });
              
              // Filter receipts by receipt date falling within FY (same logic as Receipt Register)
              const fyReceipts = (data.receipts || []).filter(r => {
                const rDate = new Date(r.receiptDate || r.createdAt);
                return rDate >= fyStart && rDate <= fyEnd;
              });
              
              // Previous FY for opening balance calculation
              const prevFYStart = new Date(fyStartYear - 1, 3, 1); // Previous April 1
              const prevFYEnd = new Date(fyStartYear, 2, 31, 23, 59, 59); // Previous March 31
              
              const prevFYInvoices = (data.invoices || []).filter(inv => {
                if (!inv.invoiceDate) return false;
                const invDate = new Date(inv.invoiceDate);
                return invDate >= prevFYStart && invDate <= prevFYEnd;
              });
              
              // Calculate opening balance (outstanding from previous FY)
              let openingBalance = 0;
              prevFYInvoices.forEach(inv => {
                const invReceipts = (data.receipts || []).filter(r => r.invoiceId === inv.id);
                const collected = invReceipts.reduce((s, r) => s + (parseFloat(r.amount) || 0) + (parseFloat(r.tds) || 0) + (parseFloat(r.discount) || 0), 0);
                openingBalance += (inv.totalAmount || 0) - collected;
              });
              
              const totalBilling = fyInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
              
              // Organization wise breakdown - use FY-filtered invoices and receipts
              const orgBreakdown = (data.organizations || []).map(org => {
                // Invoices for this org within FY (by invoice date)
                const orgInvoices = fyInvoices.filter(inv => String(inv.organizationId) === String(org.id));
                
                // Receipts for this org within FY (by receipt date)
                const orgReceipts = fyReceipts.filter(r => {
                  const inv = (data.invoices || []).find(i => i.id === r.invoiceId);
                  return inv && String(inv.organizationId) === String(org.id);
                });
                
                // Calculate billing breakdown - Amount (net), GST, Total
                const billingNetAmount = orgInvoices.reduce((sum, inv) => sum + (inv.netAmount || inv.amount || 0), 0);
                const billingGstAmount = orgInvoices.reduce((sum, inv) => {
                  const gstTotal = (inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0);
                  return sum + (gstTotal > 0 ? gstTotal : (inv.taxAmount || inv.gstAmount || 0));
                }, 0);
                const billing = orgInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
                
                // Calculate collection breakdown - Amount, TDS, Discount, Total
                const receiptAmount = orgReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                const tdsAmount = orgReceipts.reduce((sum, r) => sum + (parseFloat(r.tds) || 0), 0);
                const discountAmount = orgReceipts.reduce((sum, r) => sum + (parseFloat(r.discount) || 0), 0);
                const collection = receiptAmount + tdsAmount + discountAmount;
                
                return {
                  id: org.id,
                  name: org.name,
                  logo: org.logo,
                  billing: billing,
                  billingNetAmount: billingNetAmount,
                  billingGstAmount: billingGstAmount,
                  collection: collection,
                  receiptAmount: receiptAmount,
                  tdsAmount: tdsAmount,
                  discountAmount: discountAmount,
                  invoiceCount: orgInvoices.length,
                  receiptCount: orgReceipts.length
                };
              }).filter(o => o.billing > 0 || o.collection > 0);
              
              // Calculate totals from org breakdown
              const totalReceipts = orgBreakdown.reduce((sum, o) => sum + o.receiptAmount, 0);
              const totalTDS = orgBreakdown.reduce((sum, o) => sum + o.tdsAmount, 0);
              const totalReceiptDiscount = orgBreakdown.reduce((sum, o) => sum + o.discountAmount, 0);
              const totalCollection = orgBreakdown.reduce((sum, o) => sum + o.collection, 0);
              const netOutstanding = openingBalance + totalBilling - totalCollection;
              
              return (
                <>
                  {/* Summary Cards Row */}
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '32px'}}>
                    {/* Opening Balance Card */}
                    <div style={{background: 'linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)', borderRadius: '16px', padding: '20px', border: '1px solid #c084fc', position: 'relative', overflow: 'hidden'}}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', background: '#a855f7', borderRadius: '10px', padding: '8px'}}>
                        <Briefcase size={20} color="#fff" />
                      </div>
                      <div style={{fontSize: '12px', color: '#6b21a8', fontWeight: '600', marginBottom: '6px'}}>Opening Balance</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#7c3aed'}}>â‚¹ {openingBalance.toLocaleString('en-IN')}</div>
                      <div style={{fontSize: '10px', color: '#8b5cf6', marginTop: '6px'}}>From previous FY</div>
                    </div>
                    
                    {/* Total Billing Card */}
                    <div style={{background: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)', borderRadius: '16px', padding: '20px', border: '1px solid #6ee7b7', position: 'relative', overflow: 'hidden'}}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', background: '#10b981', borderRadius: '10px', padding: '8px'}}>
                        <FileText size={20} color="#fff" />
                      </div>
                      <div style={{fontSize: '12px', color: '#065f46', fontWeight: '600', marginBottom: '6px'}}>Total Billing</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#047857'}}>â‚¹ {totalBilling.toLocaleString('en-IN')}</div>
                      <div style={{fontSize: '10px', color: '#059669', marginTop: '6px'}}>{fyInvoices.length} invoices</div>
                    </div>
                    
                    {/* Total Collection Card */}
                    <div style={{background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)', borderRadius: '16px', padding: '20px', border: '1px solid #93c5fd', position: 'relative', overflow: 'hidden'}}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', background: '#3b82f6', borderRadius: '10px', padding: '8px'}}>
                        <DollarSign size={20} color="#fff" />
                      </div>
                      <div style={{fontSize: '12px', color: '#1e40af', fontWeight: '600', marginBottom: '6px'}}>Total Collection</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#1d4ed8'}}>â‚¹ {totalReceipts.toLocaleString('en-IN')}</div>
                      <div style={{fontSize: '10px', color: '#2563eb', marginTop: '6px'}}>{fyReceipts.length} receipts</div>
                    </div>
                    
                    {/* TDS & Discount Card */}
                    <div style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderRadius: '16px', padding: '20px', border: '1px solid #fbbf24', position: 'relative', overflow: 'hidden'}}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', background: '#f59e0b', borderRadius: '10px', padding: '8px'}}>
                        <Percent size={20} color="#fff" />
                      </div>
                      <div style={{fontSize: '12px', color: '#92400e', fontWeight: '600', marginBottom: '6px'}}>TDS & Discount</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#b45309'}}>â‚¹ {(totalTDS + totalReceiptDiscount).toLocaleString('en-IN')}</div>
                      <div style={{fontSize: '10px', color: '#d97706', marginTop: '6px'}}>TDS: â‚¹{totalTDS.toLocaleString('en-IN')} | Disc: â‚¹{totalReceiptDiscount.toLocaleString('en-IN')}</div>
                    </div>
                    
                    {/* Outstanding Card */}
                    <div style={{background: 'linear-gradient(135deg, #fef2f2 0%, #fecaca 100%)', borderRadius: '16px', padding: '20px', border: '1px solid #f87171', position: 'relative', overflow: 'hidden'}}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', background: '#ef4444', borderRadius: '10px', padding: '8px'}}>
                        <AlertCircle size={20} color="#fff" />
                      </div>
                      <div style={{fontSize: '12px', color: '#991b1b', fontWeight: '600', marginBottom: '6px'}}>Net Outstanding</div>
                      <div style={{fontSize: '24px', fontWeight: '700', color: '#dc2626'}}>â‚¹ {netOutstanding.toLocaleString('en-IN')}</div>
                      <div style={{fontSize: '10px', color: '#ef4444', marginTop: '6px'}}>Op.Bal + Billing - Collection</div>
                    </div>
                  </div>
                  
                  {/* Dashboard Tabs */}
                  <div style={{display: 'flex', gap: '8px', marginBottom: '20px', borderBottom: '2px solid #e2e8f0', paddingBottom: '0'}}>
                    {[
                      { id: 'summary', label: 'Organization Summary' },
                      { id: 'billRegister', label: 'Bill Register' },
                      { id: 'receiptRegister', label: 'Receipt Register' }
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setDashboardTab(tab.id)}
                        style={{
                          padding: '12px 24px',
                          background: dashboardTab === tab.id ? '#10b981' : 'transparent',
                          color: dashboardTab === tab.id ? '#fff' : '#64748b',
                          border: 'none',
                          borderRadius: '8px 8px 0 0',
                          cursor: 'pointer',
                          fontWeight: '600',
                          fontSize: '13px',
                          marginBottom: '-2px',
                          borderBottom: dashboardTab === tab.id ? '2px solid #10b981' : '2px solid transparent'
                        }}
                      >
                        {tab.label}
                      </button>
                    ))}
                  </div>
                  
                  {/* Organization Summary Table */}
                  {dashboardTab === 'summary' && (
                    <div>
                      {/* Organization Wise */}
                      <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', marginBottom: '20px', border: '1px solid #e5e7eb'}}>
                        <div style={{padding: '14px 18px', borderBottom: '1px solid #e5e7eb', background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'}}>
                          <h3 style={{margin: 0, fontSize: '15px', fontWeight: '700', color: '#065f46'}}>ðŸ¢ Organization Wise Billing & Collection</h3>
                        </div>
                        <div style={{overflowX: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead>
                              {/* Main Headers Row */}
                              <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Organization</th>
                                <th colSpan={3} style={{padding: '8px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Total Billing</th>
                                <th colSpan={4} style={{padding: '8px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Total Collection</th>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Outstanding</th>
                              </tr>
                              {/* Sub-Headers Row */}
                              <tr style={{background: '#d1fae5'}}>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Amount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>GST</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Total</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Amount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>TDS</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Discount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              {orgBreakdown.length === 0 ? (
                                <tr>
                                  <td colSpan={9} style={{padding: '30px', textAlign: 'center', color: '#64748b', border: '1px solid #e5e7eb'}}>
                                    No billing data available for {dashboardFY}
                                  </td>
                                </tr>
                              ) : (
                                <>
                                  {orgBreakdown.map((org, idx) => (
                                    <tr key={org.id} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                          {org.logo ? (
                                            <img src={org.logo} alt="" style={{width: '28px', height: '28px', objectFit: 'contain', borderRadius: '4px', border: '1px solid #e2e8f0'}} />
                                          ) : (
                                            <div style={{width: '28px', height: '28px', background: '#f1f5f9', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                              <Building size={14} color="#64748b" />
                                            </div>
                                          )}
                                          <span style={{fontWeight: '500', fontSize: '11px'}}>{org.name}</span>
                                        </div>
                                      </td>
                                      {/* Billing Columns */}
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.billingNetAmount.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.billingGstAmount.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#059669', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.billing.toLocaleString('en-IN')}</td>
                                      {/* Collection Columns */}
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.receiptAmount.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.tdsAmount.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.discountAmount.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#2563eb', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{org.collection.toLocaleString('en-IN')}</td>
                                      {/* Outstanding */}
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: org.billing - org.collection > 0 ? '#dc2626' : '#059669', border: '1px solid #e5e7eb', fontSize: '11px'}}>
                                        â‚¹{(org.billing - org.collection).toLocaleString('en-IN')}
                                      </td>
                                    </tr>
                                  ))}
                                  {/* Totals Row */}
                                  <tr style={{background: '#dcfce7', fontWeight: '700'}}>
                                    <td style={{padding: '8px 12px', border: '1px solid #86efac', fontWeight: '700', color: '#065f46'}}>Total</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.billingNetAmount, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.billingGstAmount, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#059669', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.billing, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.receiptAmount, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.tdsAmount, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.discountAmount, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#2563eb', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + o.collection, 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#dc2626', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{orgBreakdown.reduce((s, o) => s + (o.billing - o.collection), 0).toLocaleString('en-IN')}</td>
                                  </tr>
                                </>
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* Child Task Wise Breakdown */}
                      <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', border: '1px solid #e5e7eb'}}>
                        <div style={{padding: '14px 18px', borderBottom: '1px solid #e5e7eb', background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'}}>
                          <h3 style={{margin: 0, fontSize: '15px', fontWeight: '700', color: '#065f46'}}>ðŸ“‹ Task Type Wise Billing & Collection</h3>
                        </div>
                        <div style={{overflowX: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                            <thead>
                              {/* Main Headers Row */}
                              <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Parent Task</th>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Child Task</th>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Invoices</th>
                                <th colSpan={3} style={{padding: '8px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Total Billing</th>
                                <th colSpan={4} style={{padding: '8px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Total Collection</th>
                                <th rowSpan={2} style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669', verticalAlign: 'middle'}}>Outstanding</th>
                              </tr>
                              {/* Sub-Headers Row */}
                              <tr style={{background: '#d1fae5'}}>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Amount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>GST</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Total</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Amount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>TDS</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Discount</th>
                                <th style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#065f46', border: '1px solid #86efac', fontSize: '10px'}}>Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              {(() => {
                                // Helper function to find parent task for a child task
                                const findParentTask = (childTask) => {
                                  for (const [parent, children] of Object.entries(PARENT_CHILD_TASKS)) {
                                    if (children.includes(childTask)) {
                                      return parent;
                                    }
                                  }
                                  return null;
                                };
                                
                                // Group by child task (taskType)
                                const taskBreakdown = {};
                                fyInvoices.forEach(inv => {
                                  // Try to get parent task from multiple sources
                                  let parentTask = inv.parentTask;
                                  let childTask = inv.taskType;
                                  
                                  // If no parentTask, try to derive from serviceDescription (format: "ParentTask - ChildTask")
                                  if (!parentTask && inv.serviceDescription && inv.serviceDescription.includes(' - ')) {
                                    const parts = inv.serviceDescription.split(' - ');
                                    if (parts.length >= 2) {
                                      parentTask = parts[0].trim();
                                      if (!childTask) childTask = parts.slice(1).join(' - ').trim();
                                    }
                                  }
                                  
                                  // If still no parentTask, try to find it from PARENT_CHILD_TASKS
                                  if (!parentTask && childTask) {
                                    parentTask = findParentTask(childTask);
                                  }
                                  
                                  // Try to get from linked task
                                  if (!parentTask && inv.taskId) {
                                    const linkedTask = (data.tasks || []).find(t => t.id === inv.taskId);
                                    if (linkedTask) {
                                      parentTask = linkedTask.parentTask;
                                      if (!childTask) childTask = linkedTask.childTask;
                                    }
                                  }
                                  
                                  // Default values
                                  parentTask = parentTask || 'Other';
                                  childTask = childTask || 'Other';
                                  
                                  const key = `${parentTask}|${childTask}`;
                                  if (!taskBreakdown[key]) {
                                    taskBreakdown[key] = {
                                      parentTask: parentTask,
                                      childTask: childTask,
                                      invoiceCount: 0,
                                      billingNetAmount: 0,
                                      billingGstAmount: 0,
                                      billing: 0,
                                      receiptAmount: 0,
                                      tdsAmount: 0,
                                      discountAmount: 0,
                                      collection: 0
                                    };
                                  }
                                  taskBreakdown[key].invoiceCount++;
                                  taskBreakdown[key].billingNetAmount += (inv.netAmount || inv.amount || 0);
                                  const gstTotal = (inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0);
                                  taskBreakdown[key].billingGstAmount += (gstTotal > 0 ? gstTotal : (inv.taxAmount || inv.gstAmount || 0));
                                  taskBreakdown[key].billing += (inv.totalAmount || 0);
                                  
                                  // Get collection breakdown for this invoice
                                  const invReceipts = fyReceipts.filter(r => r.invoiceId === inv.id);
                                  taskBreakdown[key].receiptAmount += invReceipts.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
                                  taskBreakdown[key].tdsAmount += invReceipts.reduce((s, r) => s + (parseFloat(r.tds) || 0), 0);
                                  taskBreakdown[key].discountAmount += invReceipts.reduce((s, r) => s + (parseFloat(r.discount) || 0), 0);
                                  taskBreakdown[key].collection += invReceipts.reduce((s, r) => s + (parseFloat(r.amount) || 0) + (parseFloat(r.tds) || 0) + (parseFloat(r.discount) || 0), 0);
                                });
                                
                                const taskList = Object.values(taskBreakdown).sort((a, b) => b.billing - a.billing);
                                
                                if (taskList.length === 0) {
                                  return (
                                    <tr>
                                      <td colSpan={11} style={{padding: '30px', textAlign: 'center', color: '#64748b', border: '1px solid #e5e7eb'}}>
                                        No task-wise data available for {dashboardFY}
                                      </td>
                                    </tr>
                                  );
                                }
                                
                                return (
                                  <>
                                    {taskList.map((task, idx) => (
                                      <tr key={idx} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                                        <td style={{padding: '6px 10px', fontWeight: '500', color: '#6366f1', border: '1px solid #e5e7eb', fontSize: '11px'}}>{task.parentTask}</td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb', fontSize: '11px'}}>{task.childTask}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <span style={{background: '#e0e7ff', color: '#4338ca', padding: '2px 8px', borderRadius: '10px', fontSize: '10px', fontWeight: '600'}}>
                                            {task.invoiceCount}
                                          </span>
                                        </td>
                                        {/* Billing Columns */}
                                        <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.billingNetAmount.toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.billingGstAmount.toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#059669', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.billing.toLocaleString('en-IN')}</td>
                                        {/* Collection Columns */}
                                        <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.receiptAmount.toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.tdsAmount.toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.discountAmount.toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: '#2563eb', border: '1px solid #e5e7eb', fontSize: '11px'}}>â‚¹{task.collection.toLocaleString('en-IN')}</td>
                                        {/* Outstanding */}
                                        <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '600', color: task.billing - task.collection > 0 ? '#dc2626' : '#059669', border: '1px solid #e5e7eb', fontSize: '11px'}}>
                                          â‚¹{(task.billing - task.collection).toLocaleString('en-IN')}
                                        </td>
                                      </tr>
                                    ))}
                                    {/* Totals Row */}
                                    <tr style={{background: '#dcfce7', fontWeight: '700'}}>
                                      <td colSpan={2} style={{padding: '8px 12px', border: '1px solid #86efac', fontWeight: '700', color: '#065f46'}}>Total</td>
                                      <td style={{padding: '6px 8px', textAlign: 'center', border: '1px solid #86efac', fontWeight: '600'}}>{taskList.reduce((s, t) => s + t.invoiceCount, 0)}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.billingNetAmount, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.billingGstAmount, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#059669', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.billing, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.receiptAmount, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.tdsAmount, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', color: '#374151', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.discountAmount, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#2563eb', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + t.collection, 0).toLocaleString('en-IN')}</td>
                                      <td style={{padding: '6px 8px', textAlign: 'right', fontWeight: '700', color: '#dc2626', border: '1px solid #86efac', fontSize: '11px'}}>â‚¹{taskList.reduce((s, t) => s + (t.billing - t.collection), 0).toLocaleString('en-IN')}</td>
                                    </tr>
                                  </>
                                );
                              })()}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Bill Register */}
                  {dashboardTab === 'billRegister' && (
                    <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                      {/* Filters */}
                      <div style={{padding: '16px 20px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                        <div style={{display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'flex-end'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>From Date</label>
                            <input type="date" value={billRegisterFilters.fromDate} onChange={(e) => setBillRegisterFilters(p => ({...p, fromDate: e.target.value}))} 
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>To Date</label>
                            <input type="date" value={billRegisterFilters.toDate} onChange={(e) => setBillRegisterFilters(p => ({...p, toDate: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Organization</label>
                            <select value={billRegisterFilters.organizationId} onChange={(e) => setBillRegisterFilters(p => ({...p, organizationId: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', minWidth: '140px'}}>
                              <option value="">All Organizations</option>
                              {(data.organizations || []).map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Parent Task</label>
                            <select value={billRegisterFilters.parentTask} onChange={(e) => setBillRegisterFilters(p => ({...p, parentTask: e.target.value, childTask: ''}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', minWidth: '120px'}}>
                              <option value="">All</option>
                              {Object.keys(PARENT_CHILD_TASKS).map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Child Task</label>
                            <select value={billRegisterFilters.childTask} onChange={(e) => setBillRegisterFilters(p => ({...p, childTask: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', minWidth: '120px'}}>
                              <option value="">All</option>
                              {(PARENT_CHILD_TASKS[billRegisterFilters.parentTask] || []).map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Client Name</label>
                            <input type="text" value={billRegisterFilters.clientName} onChange={(e) => setBillRegisterFilters(p => ({...p, clientName: e.target.value}))}
                              placeholder="Search client..." style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Status</label>
                            <select value={billRegisterFilters.status} onChange={(e) => setBillRegisterFilters(p => ({...p, status: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', minWidth: '100px'}}>
                              <option value="">All</option>
                              <option value="Pending">Pending</option>
                              <option value="Partial">Partial</option>
                              <option value="Paid">Paid</option>
                            </select>
                          </div>
                          <button onClick={() => { setBillRegisterFilters({fromDate: '', toDate: '', organizationId: '', clientName: '', parentTask: '', childTask: '', status: ''}); setSelectedBillIds([]); }}
                            style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>
                            Clear
                          </button>
                        </div>
                        {/* Download Buttons */}
                        {selectedBillIds.length > 0 && (
                          <div style={{marginTop: '12px', display: 'flex', gap: '10px', alignItems: 'center', paddingTop: '12px', borderTop: '1px dashed #e2e8f0'}}>
                            <span style={{fontSize: '12px', color: '#64748b'}}>{selectedBillIds.length} selected</span>
                            <button onClick={() => {
                              const selectedInvoices = (data.invoices || []).filter(inv => selectedBillIds.includes(inv.id));
                              if (selectedInvoices.length === 1) {
                                // Single invoice - direct download
                                downloadInvoicePDF(selectedInvoices[0], data.organizations, data.clients);
                                setSelectedBillIds([]);
                              } else {
                                // Multiple invoices - show download options modal
                                setBulkDownloadItems(selectedInvoices);
                                setBulkDownloadType('bills');
                                setShowBulkDownloadModal(true);
                              }
                            }} style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '4px'}}>
                              <Download size={12} /> Download Selected
                            </button>
                            <button onClick={() => {
                              // View selected invoices
                              const selectedInvoices = (data.invoices || []).filter(inv => selectedBillIds.includes(inv.id));
                              if (selectedInvoices.length > 0) {
                                setGeneratedInvoice(selectedInvoices[0]);
                                setShowInvoicePreview(true);
                              }
                            }} style={{padding: '6px 12px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '4px'}}>
                              <Eye size={12} /> View Selected
                            </button>
                            <button onClick={() => setSelectedBillIds([])} style={{padding: '6px 12px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px'}}>
                              Clear Selection
                            </button>
                          </div>
                        )}
                      </div>
                      
                      {/* Bills Table */}
                      <div style={{overflowX: 'auto'}}>
                        <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                          <thead>
                            <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                              <th style={{padding: '8px 6px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669', width: '30px'}}>
                                <input type="checkbox" onChange={(e) => {
                                  // Get filtered invoices for select all
                                  const fyStartYear = parseInt(dashboardFY.split(' ')[1].split('-')[0]);
                                  const fyStart = new Date(fyStartYear, 3, 1);
                                  const fyEnd = new Date(fyStartYear + 1, 2, 31, 23, 59, 59);
                                  let allInvoices = (data.invoices || []).filter(inv => {
                                    const invDate = new Date(inv.invoiceDate);
                                    return invDate >= fyStart && invDate <= fyEnd;
                                  });
                                  if (e.target.checked) {
                                    setSelectedBillIds(allInvoices.map(i => i.id));
                                  } else {
                                    setSelectedBillIds([]);
                                  }
                                }} checked={selectedBillIds.length > 0} style={{cursor: 'pointer'}} />
                              </th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>S.No</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Invoice No</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Date</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Client Code</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Client Name</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Task</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Description</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Organization</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Amount</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>GST</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Total</th>
                              <th style={{padding: '8px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Status</th>
                              <th style={{padding: '8px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {(() => {
                              // FY-based filtering - filter by invoice date
                              const fyStartYear = parseInt(dashboardFY.split(' ')[1].split('-')[0]);
                              const fyStart = new Date(fyStartYear, 3, 1); // April 1
                              const fyEnd = new Date(fyStartYear + 1, 2, 31, 23, 59, 59); // March 31
                              
                              // Helper function to find parent task for a child task
                              const findParentForChild = (childTask) => {
                                for (const [parent, children] of Object.entries(PARENT_CHILD_TASKS)) {
                                  if (children.includes(childTask)) return parent;
                                }
                                return null;
                              };
                              
                              // Get payment status for invoice
                              const getInvoiceStatus = (inv) => {
                                const paidAmt = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((s, r) => s + (parseFloat(r.amount) || 0) + (parseFloat(r.tds) || 0) + (parseFloat(r.discount) || 0), 0);
                                if (paidAmt >= (inv.totalAmount || 0)) return 'Paid';
                                if (paidAmt > 0) return 'Partial';
                                return 'Pending';
                              };
                              
                              // Start with FY-filtered invoices based on invoice date
                              let enrichedInvoices = (data.invoices || []).filter(inv => {
                                const invDate = new Date(inv.invoiceDate);
                                return invDate >= fyStart && invDate <= fyEnd;
                              }).map(inv => {
                                let parentTask = inv.parentTask;
                                let childTask = inv.taskType;
                                
                                // Try to derive from serviceDescription
                                if (!parentTask && inv.serviceDescription && inv.serviceDescription.includes(' - ')) {
                                  const parts = inv.serviceDescription.split(' - ');
                                  if (parts.length >= 2) {
                                    parentTask = parts[0].trim();
                                    if (!childTask) childTask = parts.slice(1).join(' - ').trim();
                                  }
                                }
                                
                                // Try to find parent from PARENT_CHILD_TASKS
                                if (!parentTask && childTask) {
                                  parentTask = findParentForChild(childTask);
                                }
                                
                                // Try to get from linked task
                                if (!parentTask && inv.taskId) {
                                  const linkedTask = (data.tasks || []).find(t => t.id === inv.taskId);
                                  if (linkedTask) {
                                    parentTask = linkedTask.parentTask;
                                    if (!childTask) childTask = linkedTask.childTask;
                                  }
                                }
                                
                                return {
                                  ...inv,
                                  parentTask: parentTask || 'Other',
                                  childTask: childTask || inv.serviceDescription || 'Other',
                                  paymentStatus: getInvoiceStatus(inv)
                                };
                              });
                              
                              let filtered = enrichedInvoices;
                              if (billRegisterFilters.fromDate) filtered = filtered.filter(inv => new Date(inv.invoiceDate) >= new Date(billRegisterFilters.fromDate));
                              if (billRegisterFilters.toDate) filtered = filtered.filter(inv => new Date(inv.invoiceDate) <= new Date(billRegisterFilters.toDate));
                              if (billRegisterFilters.organizationId) filtered = filtered.filter(inv => String(inv.organizationId) === billRegisterFilters.organizationId);
                              if (billRegisterFilters.clientName) filtered = filtered.filter(inv => (inv.clientName || '').toLowerCase().includes(billRegisterFilters.clientName.toLowerCase()));
                              if (billRegisterFilters.parentTask) filtered = filtered.filter(inv => inv.parentTask.toLowerCase() === billRegisterFilters.parentTask.toLowerCase());
                              if (billRegisterFilters.childTask) filtered = filtered.filter(inv => (inv.childTask || '').toLowerCase().includes(billRegisterFilters.childTask.toLowerCase()));
                              if (billRegisterFilters.status) filtered = filtered.filter(inv => inv.paymentStatus === billRegisterFilters.status);
                              
                              if (filtered.length === 0) {
                                return <tr><td colSpan={14} style={{padding: '30px', textAlign: 'center', color: '#64748b', border: '1px solid #e5e7eb'}}>No invoices found for {dashboardFY}</td></tr>;
                              }
                              
                              const totalAmount = filtered.reduce((s, i) => s + (i.netAmount || i.amount || 0), 0);
                              const totalGST = filtered.reduce((s, i) => {
                                const gstTotal = (i.cgst || 0) + (i.sgst || 0) + (i.igst || 0);
                                return s + (gstTotal > 0 ? gstTotal : (i.taxAmount || 0));
                              }, 0);
                              const totalTotal = filtered.reduce((s, i) => s + (i.totalAmount || 0), 0);
                              
                              return (
                                <>
                                  {filtered.sort((a,b) => new Date(b.invoiceDate) - new Date(a.invoiceDate)).map((inv, idx) => {
                                    const isPaid = inv.paymentStatus === 'Paid';
                                    const isPartial = inv.paymentStatus === 'Partial';
                                    return (
                                      <tr key={inv.id} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4'}}>
                                        <td style={{padding: '6px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <input type="checkbox" checked={selectedBillIds.includes(inv.id)} onChange={(e) => {
                                            if (e.target.checked) {
                                              setSelectedBillIds(prev => [...prev, inv.id]);
                                            } else {
                                              setSelectedBillIds(prev => prev.filter(id => id !== inv.id));
                                            }
                                          }} style={{cursor: 'pointer'}} />
                                        </td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{idx + 1}</td>
                                        <td style={{padding: '6px 10px', fontWeight: '500', color: '#10b981', border: '1px solid #e5e7eb'}}>{inv.invoiceNo}</td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#6366f1', fontWeight: '500', border: '1px solid #e5e7eb'}}>{inv.clientCode || '-'}</td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{inv.clientName}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', border: '1px solid #e5e7eb'}}>{inv.parentTask !== 'Other' ? `${inv.parentTask} - ` : ''}{inv.childTask}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#64748b', border: '1px solid #e5e7eb', maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}} title={inv.serviceDescription || inv.description || '-'}>{inv.serviceDescription || inv.description || '-'}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#64748b', border: '1px solid #e5e7eb'}}>{inv.orgName}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{(inv.netAmount || inv.amount || 0).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{(() => {
                                          const gstTotal = (inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0);
                                          return gstTotal > 0 ? gstTotal : (inv.taxAmount || 0);
                                        })().toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', fontWeight: '600', border: '1px solid #e5e7eb'}}>â‚¹{(inv.totalAmount || 0).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <span style={{padding: '2px 8px', borderRadius: '10px', fontSize: '9px', fontWeight: '600',
                                            background: isPaid ? '#d1fae5' : isPartial ? '#fef3c7' : '#fee2e2',
                                            color: isPaid ? '#065f46' : isPartial ? '#92400e' : '#991b1b'
                                          }}>
                                            {inv.paymentStatus}
                                          </span>
                                        </td>
                                        <td style={{padding: '6px 10px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <div style={{display: 'flex', gap: '3px', justifyContent: 'center'}}>
                                            <button 
                                              onClick={() => {
                                                // Set the invoice for preview using the professional format
                                                setGeneratedInvoice(inv);
                                                setShowInvoicePreview(true);
                                              }}
                                              style={{padding: '3px 6px', background: '#eff6ff', color: '#2563eb', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="View Invoice"
                                            >
                                              <Eye size={10} />
                                            </button>
                                            <button 
                                              onClick={() => {
                                                // Direct download PDF
                                                downloadInvoicePDF(inv, data.organizations, data.clients);
                                              }}
                                              style={{padding: '3px 6px', background: '#dcfce7', color: '#16a34a', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Download PDF"
                                            >
                                              <Download size={10} />
                                            </button>
                                            <button 
                                              onClick={() => {
                                                setEditingInvoiceData(inv);
                                                setShowEditInvoiceModal(true);
                                              }}
                                              style={{padding: '3px 6px', background: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Edit"
                                            >
                                              <Edit size={10} />
                                            </button>
                                            <button 
                                              onClick={() => {
                                                if (window.confirm(`Delete invoice ${inv.invoiceNo}? This cannot be undone.`)) {
                                                  setData(prev => ({
                                                    ...prev,
                                                    invoices: (prev.invoices || []).filter(i => i.id !== inv.id),
                                                    tasks: (prev.tasks || []).map(t => t.invoiceId === inv.id ? {...t, billed: false, invoiceId: null} : t)
                                                  }));
                                                }
                                              }}
                                              style={{padding: '3px 6px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Delete"
                                            >
                                              <Trash2 size={10} />
                                            </button>
                                          </div>
                                        </td>
                                      </tr>
                                    );
                                  })}
                                  <tr style={{background: '#dcfce7', fontWeight: '700'}}>
                                    <td colSpan={9} style={{padding: '8px 10px', border: '1px solid #e5e7eb'}}>Total ({filtered.length} invoices)</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalAmount.toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalGST.toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalTotal.toLocaleString('en-IN')}</td>
                                    <td colSpan={2} style={{border: '1px solid #e5e7eb'}}></td>
                                  </tr>
                                </>
                              );
                            })()}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                  
                  {/* Receipt Register */}
                  {dashboardTab === 'receiptRegister' && (
                    <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                      {/* Filters */}
                      <div style={{padding: '16px 20px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                        <div style={{display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'flex-end'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>From Date</label>
                            <input type="date" value={receiptRegisterFilters.fromDate} onChange={(e) => setReceiptRegisterFilters(p => ({...p, fromDate: e.target.value}))} 
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>To Date</label>
                            <input type="date" value={receiptRegisterFilters.toDate} onChange={(e) => setReceiptRegisterFilters(p => ({...p, toDate: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Organization</label>
                            <select value={receiptRegisterFilters.organizationId} onChange={(e) => setReceiptRegisterFilters(p => ({...p, organizationId: e.target.value}))}
                              style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', minWidth: '140px'}}>
                              <option value="">All Organizations</option>
                              {(data.organizations || []).map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Client Name</label>
                            <input type="text" value={receiptRegisterFilters.clientName} onChange={(e) => setReceiptRegisterFilters(p => ({...p, clientName: e.target.value}))}
                              placeholder="Search client..." style={{padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <button onClick={() => { setReceiptRegisterFilters({fromDate: '', toDate: '', organizationId: '', clientName: '', parentTask: '', childTask: ''}); setSelectedReceiptIds([]); }}
                            style={{padding: '8px 16px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}>
                            Clear
                          </button>
                        </div>
                        {/* Download Buttons */}
                        {selectedReceiptIds.length > 0 && (
                          <div style={{marginTop: '12px', display: 'flex', gap: '10px', alignItems: 'center', paddingTop: '12px', borderTop: '1px dashed #e2e8f0'}}>
                            <span style={{fontSize: '12px', color: '#64748b'}}>{selectedReceiptIds.length} selected</span>
                            <button onClick={() => {
                              const selectedReceipts = (data.receipts || []).filter(r => selectedReceiptIds.includes(r.id));
                              if (selectedReceipts.length === 1) {
                                // Single receipt - show preview directly
                                setViewingReceipt(selectedReceipts[0]);
                              } else {
                                // Multiple receipts - show download options modal
                                setBulkDownloadItems(selectedReceipts);
                                setBulkDownloadType('receipts');
                                setShowBulkDownloadModal(true);
                              }
                            }} style={{padding: '6px 12px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '4px'}}>
                              <Download size={12} /> Download Selected
                            </button>
                            <button onClick={() => setSelectedReceiptIds([])} style={{padding: '6px 12px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px'}}>
                              Clear Selection
                            </button>
                          </div>
                        )}
                      </div>
                      
                      {/* Receipts Table */}
                      <div style={{overflowX: 'auto'}}>
                        <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '11px'}}>
                          <thead>
                            <tr style={{background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'}}>
                              <th style={{padding: '8px 6px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #2563eb', width: '30px'}}>
                                <input type="checkbox" onChange={(e) => {
                                  // Get FY-filtered receipts for select all
                                  const fyStartYear = parseInt(dashboardFY.split(' ')[1].split('-')[0]);
                                  const fyStart = new Date(fyStartYear, 3, 1);
                                  const fyEnd = new Date(fyStartYear + 1, 2, 31, 23, 59, 59);
                                  let allReceipts = (data.receipts || []).filter(r => {
                                    const rDate = new Date(r.receiptDate || r.createdAt);
                                    return rDate >= fyStart && rDate <= fyEnd;
                                  });
                                  if (e.target.checked) {
                                    setSelectedReceiptIds(allReceipts.map(r => r.id));
                                  } else {
                                    setSelectedReceiptIds([]);
                                  }
                                }} checked={selectedReceiptIds.length > 0} style={{cursor: 'pointer'}} />
                              </th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>S.No</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Receipt No</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Date</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Client Code</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Client Name</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Invoice No</th>
                              <th style={{padding: '8px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Organization</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Amount</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>TDS</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Discount</th>
                              <th style={{padding: '8px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Total</th>
                              <th style={{padding: '8px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #2563eb'}}>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {(() => {
                              // FY-based filtering - filter by receipt date
                              const fyStartYear = parseInt(dashboardFY.split(' ')[1].split('-')[0]);
                              const fyStart = new Date(fyStartYear, 3, 1); // April 1
                              const fyEnd = new Date(fyStartYear + 1, 2, 31, 23, 59, 59); // March 31
                              
                              // Start with FY-filtered receipts based on receipt date
                              let enrichedReceipts = (data.receipts || []).filter(r => {
                                const rDate = new Date(r.receiptDate || r.createdAt);
                                return rDate >= fyStart && rDate <= fyEnd;
                              }).map(r => {
                                const inv = (data.invoices || []).find(i => i.id === r.invoiceId);
                                const organizationId = inv?.organizationId || r.organizationId;
                                const org = (data.organizations || []).find(o => String(o.id) === String(organizationId));
                                const orgName = inv?.orgName || org?.name || r.orgName || '';
                                
                                return {
                                  ...r,
                                  organizationId: organizationId,
                                  orgName: orgName,
                                  clientCode: inv?.clientCode || r.clientCode,
                                  invoiceNo: inv?.invoiceNo || ''
                                };
                              });
                              
                              let filtered = enrichedReceipts;
                              if (receiptRegisterFilters.fromDate) filtered = filtered.filter(r => new Date(r.receiptDate || r.createdAt) >= new Date(receiptRegisterFilters.fromDate));
                              if (receiptRegisterFilters.toDate) filtered = filtered.filter(r => new Date(r.receiptDate || r.createdAt) <= new Date(receiptRegisterFilters.toDate));
                              if (receiptRegisterFilters.organizationId) filtered = filtered.filter(r => String(r.organizationId) === receiptRegisterFilters.organizationId);
                              if (receiptRegisterFilters.clientName) filtered = filtered.filter(r => (r.clientName || '').toLowerCase().includes(receiptRegisterFilters.clientName.toLowerCase()));
                              
                              if (filtered.length === 0) {
                                return <tr><td colSpan={13} style={{padding: '30px', textAlign: 'center', color: '#64748b', border: '1px solid #e5e7eb'}}>No receipts found for {dashboardFY}</td></tr>;
                              }
                              
                              const totalAmount = filtered.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
                              const totalTDS = filtered.reduce((s, r) => s + (parseFloat(r.tds) || 0), 0);
                              const totalDisc = filtered.reduce((s, r) => s + (parseFloat(r.discount) || 0), 0);
                              const totalTotal = totalAmount + totalTDS + totalDisc;
                              
                              return (
                                <>
                                  {filtered.sort((a,b) => new Date(b.receiptDate || b.createdAt) - new Date(a.receiptDate || a.createdAt)).map((r, idx) => {
                                    return (
                                      <tr key={r.id} style={{background: idx % 2 === 0 ? '#fff' : '#eff6ff'}}>
                                        <td style={{padding: '6px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <input type="checkbox" checked={selectedReceiptIds.includes(r.id)} onChange={(e) => {
                                            if (e.target.checked) {
                                              setSelectedReceiptIds(prev => [...prev, r.id]);
                                            } else {
                                              setSelectedReceiptIds(prev => prev.filter(id => id !== r.id));
                                            }
                                          }} style={{cursor: 'pointer'}} />
                                        </td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{idx + 1}</td>
                                        <td style={{padding: '6px 10px', fontWeight: '500', color: '#3b82f6', border: '1px solid #e5e7eb'}}>{r.receiptNo}</td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{new Date(r.receiptDate || r.createdAt).toLocaleDateString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#6366f1', fontWeight: '500', border: '1px solid #e5e7eb'}}>{r.clientCode || '-'}</td>
                                        <td style={{padding: '6px 10px', border: '1px solid #e5e7eb'}}>{r.clientName}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#10b981', border: '1px solid #e5e7eb'}}>{r.invoiceNo || '-'}</td>
                                        <td style={{padding: '6px 10px', fontSize: '10px', color: '#64748b', border: '1px solid #e5e7eb'}}>{r.orgName || '-'}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{(parseFloat(r.amount) || 0).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{(parseFloat(r.tds) || 0).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{(parseFloat(r.discount) || 0).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'right', fontWeight: '600', border: '1px solid #e5e7eb'}}>â‚¹{((parseFloat(r.amount) || 0) + (parseFloat(r.tds) || 0) + (parseFloat(r.discount) || 0)).toLocaleString('en-IN')}</td>
                                        <td style={{padding: '6px 10px', textAlign: 'center', border: '1px solid #e5e7eb'}}>
                                          <div style={{display: 'flex', gap: '3px', justifyContent: 'center'}}>
                                            <button 
                                              onClick={() => setViewingReceipt(r)}
                                              style={{padding: '3px 6px', background: '#eff6ff', color: '#2563eb', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="View Receipt"
                                            >
                                              <Eye size={10} />
                                            </button>
                                            <button 
                                              onClick={() => setViewingReceipt(r)}
                                              style={{padding: '3px 6px', background: '#dcfce7', color: '#16a34a', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Download PDF"
                                            >
                                              <Download size={10} />
                                            </button>
                                            <button 
                                              onClick={() => {
                                                setEditingReceipt({...r});
                                                setShowEditReceiptModal(true);
                                              }}
                                              style={{padding: '3px 6px', background: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Edit"
                                            >
                                              <Edit size={10} />
                                            </button>
                                            <button 
                                              onClick={() => {
                                                if (window.confirm(`Delete receipt ${r.receiptNo}? This cannot be undone.`)) {
                                                  setData(prev => ({
                                                    ...prev,
                                                    receipts: (prev.receipts || []).filter(rec => rec.id !== r.id)
                                                  }));
                                                }
                                              }}
                                              style={{padding: '3px 6px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '9px', fontWeight: '500'}}
                                              title="Delete"
                                            >
                                              <Trash2 size={10} />
                                            </button>
                                          </div>
                                        </td>
                                      </tr>
                                    );
                                  })}
                                  <tr style={{background: '#dbeafe', fontWeight: '700'}}>
                                    <td colSpan={8} style={{padding: '8px 10px', border: '1px solid #e5e7eb'}}>Total ({filtered.length} receipts)</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalAmount.toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalTDS.toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalDisc.toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'right', border: '1px solid #e5e7eb'}}>â‚¹{totalTotal.toLocaleString('en-IN')}</td>
                                    <td style={{border: '1px solid #e5e7eb'}}></td>
                                  </tr>
                                </>
                              );
                            })()}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                  
                  {/* Invoice View Modal */}
                  {viewingDashboardInvoice && (
                    <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
                      <div style={{background: '#fff', borderRadius: '12px', width: '90%', maxWidth: '800px', maxHeight: '90vh', overflow: 'auto', position: 'relative'}}>
                        <div style={{position: 'sticky', top: 0, background: '#fff', padding: '16px 20px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                          <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Invoice: {viewingDashboardInvoice.invoiceNo}</h3>
                          <button onClick={() => setViewingDashboardInvoice(null)} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '8px'}}>
                            <X size={20} />
                          </button>
                        </div>
                        <div style={{padding: '24px'}}>
                          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px'}}>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Organization</div>
                              <div style={{fontWeight: '600'}}>{viewingDashboardInvoice.orgName}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Invoice Date</div>
                              <div style={{fontWeight: '600'}}>{new Date(viewingDashboardInvoice.invoiceDate).toLocaleDateString('en-IN')}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Client Name</div>
                              <div style={{fontWeight: '600'}}>{viewingDashboardInvoice.clientName}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Client Code</div>
                              <div style={{fontWeight: '600'}}>{viewingDashboardInvoice.clientCode || '-'}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Service Description</div>
                              <div style={{fontWeight: '600'}}>{viewingDashboardInvoice.serviceDescription || viewingDashboardInvoice.taskType || '-'}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Period</div>
                              <div style={{fontWeight: '600'}}>{viewingDashboardInvoice.financialYear} | {viewingDashboardInvoice.period || '-'}</div>
                            </div>
                          </div>
                          <div style={{background: '#f8fafc', borderRadius: '8px', padding: '16px'}}>
                            <table style={{width: '100%', fontSize: '13px'}}>
                              <tbody>
                                <tr><td style={{padding: '8px 0'}}>Amount</td><td style={{textAlign: 'right', fontWeight: '500'}}>â‚¹{(viewingDashboardInvoice.netAmount || viewingDashboardInvoice.amount || 0).toLocaleString('en-IN')}</td></tr>
                                {viewingDashboardInvoice.discount > 0 && <tr><td style={{padding: '8px 0'}}>Discount</td><td style={{textAlign: 'right', color: '#dc2626'}}>- â‚¹{viewingDashboardInvoice.discount.toLocaleString('en-IN')}</td></tr>}
                                {viewingDashboardInvoice.cgst > 0 && <tr><td style={{padding: '8px 0'}}>CGST</td><td style={{textAlign: 'right'}}>â‚¹{viewingDashboardInvoice.cgst.toLocaleString('en-IN')}</td></tr>}
                                {viewingDashboardInvoice.sgst > 0 && <tr><td style={{padding: '8px 0'}}>SGST</td><td style={{textAlign: 'right'}}>â‚¹{viewingDashboardInvoice.sgst.toLocaleString('en-IN')}</td></tr>}
                                {viewingDashboardInvoice.igst > 0 && <tr><td style={{padding: '8px 0'}}>{viewingDashboardInvoice.gstApplicable ? 'IGST' : 'Tax'}</td><td style={{textAlign: 'right'}}>â‚¹{viewingDashboardInvoice.igst.toLocaleString('en-IN')}</td></tr>}
                                {viewingDashboardInvoice.taxAmount > 0 && !viewingDashboardInvoice.cgst && !viewingDashboardInvoice.sgst && !viewingDashboardInvoice.igst && <tr><td style={{padding: '8px 0'}}>Tax</td><td style={{textAlign: 'right'}}>â‚¹{viewingDashboardInvoice.taxAmount.toLocaleString('en-IN')}</td></tr>}
                                <tr style={{borderTop: '2px solid #e2e8f0'}}><td style={{padding: '12px 0', fontWeight: '700', fontSize: '16px'}}>Total Amount</td><td style={{textAlign: 'right', fontWeight: '700', fontSize: '16px', color: '#10b981'}}>â‚¹{(viewingDashboardInvoice.totalAmount || 0).toLocaleString('en-IN')}</td></tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Receipt View Modal */}
                  {viewingDashboardReceipt && (
                    <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
                      <div style={{background: '#fff', borderRadius: '12px', width: '90%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', position: 'relative'}}>
                        <div style={{position: 'sticky', top: 0, background: '#fff', padding: '16px 20px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                          <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Receipt: {viewingDashboardReceipt.receiptNo}</h3>
                          <button onClick={() => setViewingDashboardReceipt(null)} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '8px'}}>
                            <X size={20} />
                          </button>
                        </div>
                        <div style={{padding: '24px'}}>
                          {(() => {
                            const inv = (data.invoices || []).find(i => i.id === viewingDashboardReceipt.invoiceId);
                            return (
                              <>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px'}}>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Organization</div>
                                    <div style={{fontWeight: '600'}}>{inv?.orgName || viewingDashboardReceipt.orgName || '-'}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Receipt Date</div>
                                    <div style={{fontWeight: '600'}}>{new Date(viewingDashboardReceipt.receiptDate || viewingDashboardReceipt.createdAt).toLocaleDateString('en-IN')}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Client Name</div>
                                    <div style={{fontWeight: '600'}}>{viewingDashboardReceipt.clientName}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Client Code</div>
                                    <div style={{fontWeight: '600'}}>{inv?.clientCode || viewingDashboardReceipt.clientCode || '-'}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Against Invoice</div>
                                    <div style={{fontWeight: '600', color: '#10b981'}}>{inv?.invoiceNo || '-'}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Narration</div>
                                    <div style={{fontWeight: '600'}}>{viewingDashboardReceipt.narration || '-'}</div>
                                  </div>
                                </div>
                                <div style={{background: '#eff6ff', borderRadius: '8px', padding: '16px'}}>
                                  <table style={{width: '100%', fontSize: '13px'}}>
                                    <tbody>
                                      <tr><td style={{padding: '8px 0'}}>Amount Received</td><td style={{textAlign: 'right', fontWeight: '500'}}>â‚¹{(parseFloat(viewingDashboardReceipt.amount) || 0).toLocaleString('en-IN')}</td></tr>
                                      {parseFloat(viewingDashboardReceipt.tds) > 0 && <tr><td style={{padding: '8px 0'}}>TDS Deducted</td><td style={{textAlign: 'right'}}>â‚¹{parseFloat(viewingDashboardReceipt.tds).toLocaleString('en-IN')}</td></tr>}
                                      {parseFloat(viewingDashboardReceipt.discount) > 0 && <tr><td style={{padding: '8px 0'}}>Discount</td><td style={{textAlign: 'right'}}>â‚¹{parseFloat(viewingDashboardReceipt.discount).toLocaleString('en-IN')}</td></tr>}
                                      <tr style={{borderTop: '2px solid #bfdbfe'}}><td style={{padding: '12px 0', fontWeight: '700', fontSize: '16px'}}>Total Settlement</td><td style={{textAlign: 'right', fontWeight: '700', fontSize: '16px', color: '#2563eb'}}>â‚¹{((parseFloat(viewingDashboardReceipt.amount) || 0) + (parseFloat(viewingDashboardReceipt.tds) || 0) + (parseFloat(viewingDashboardReceipt.discount) || 0)).toLocaleString('en-IN')}</td></tr>
                                    </tbody>
                                  </table>
                                </div>
                              </>
                            );
                          })()}
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Bulk Download Modal */}
                  {showBulkDownloadModal && bulkDownloadItems.length > 0 && (
                    <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000}}>
                      <div style={{background: '#fff', borderRadius: '16px', width: '90%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto'}}>
                        <div style={{padding: '20px 24px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                          <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#1e293b'}}>
                            ðŸ“¥ Download {bulkDownloadType === 'bills' ? 'Invoices' : 'Receipts'}
                          </h3>
                          <button onClick={() => { setShowBulkDownloadModal(false); setBulkDownloadItems([]); }} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '8px'}}>
                            <X size={20} />
                          </button>
                        </div>
                        <div style={{padding: '24px'}}>
                          <div style={{background: '#f8fafc', borderRadius: '12px', padding: '16px', marginBottom: '20px'}}>
                            <div style={{fontSize: '14px', color: '#64748b', marginBottom: '8px'}}>Selected Items:</div>
                            <div style={{fontSize: '24px', fontWeight: '700', color: '#10b981'}}>{bulkDownloadItems.length} {bulkDownloadType === 'bills' ? 'Invoices' : 'Receipts'}</div>
                            <div style={{fontSize: '12px', color: '#64748b', marginTop: '4px', maxHeight: '60px', overflow: 'auto'}}>
                              {bulkDownloadType === 'bills' 
                                ? bulkDownloadItems.map(i => i.invoiceNo).join(', ')
                                : bulkDownloadItems.map(r => r.receiptNo).join(', ')
                              }
                            </div>
                          </div>
                          
                          <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#1e293b'}}>Choose Download Option:</div>
                          
                          <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                            <button 
                              onClick={() => {
                                // Download as individual PDFs
                                if (bulkDownloadType === 'bills') {
                                  downloadMultipleInvoices(bulkDownloadItems, data.organizations, data.clients, false);
                                }
                                setShowBulkDownloadModal(false);
                                setBulkDownloadItems([]);
                                setSelectedBillIds([]);
                              }}
                              style={{padding: '16px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '10px', cursor: 'pointer', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '12px', justifyContent: 'flex-start'}}
                            >
                              <span style={{background: 'rgba(255,255,255,0.2)', padding: '8px', borderRadius: '8px'}}>ðŸ“„</span>
                              <div style={{textAlign: 'left'}}>
                                <div>Download as Individual PDFs</div>
                                <div style={{fontSize: '11px', fontWeight: '400', opacity: 0.9}}>{bulkDownloadItems.length} separate PDF files (opens one at a time)</div>
                              </div>
                            </button>
                            
                            <button 
                              onClick={() => {
                                // Download as single combined PDF
                                if (bulkDownloadType === 'bills') {
                                  downloadMultipleInvoices(bulkDownloadItems, data.organizations, data.clients, true);
                                }
                                setShowBulkDownloadModal(false);
                                setBulkDownloadItems([]);
                                setSelectedBillIds([]);
                              }}
                              style={{padding: '16px 20px', background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', color: '#fff', border: 'none', borderRadius: '10px', cursor: 'pointer', fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '12px', justifyContent: 'flex-start'}}
                            >
                              <span style={{background: 'rgba(255,255,255,0.2)', padding: '8px', borderRadius: '8px'}}>ðŸ“‘</span>
                              <div style={{textAlign: 'left'}}>
                                <div>Download as Single PDF</div>
                                <div style={{fontSize: '11px', fontWeight: '400', opacity: 0.9}}>All {bulkDownloadItems.length} items in one file</div>
                              </div>
                            </button>
                          </div>
                          
                          <button 
                            onClick={() => { setShowBulkDownloadModal(false); setBulkDownloadItems([]); }}
                            style={{marginTop: '16px', width: '100%', padding: '12px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Invoice Preview Modal for Dashboard Bill Register */}
                  {showInvoicePreview && generatedInvoice && (
                    <div style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      background: 'rgba(0,0,0,0.6)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 2000,
                      padding: '20px'
                    }}>
                      <div style={{
                        background: '#f8fafc',
                        borderRadius: '12px',
                        width: '100%',
                        maxWidth: '850px',
                        maxHeight: '95vh',
                        overflow: 'auto',
                        boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                      }}>
                        {/* Action Buttons */}
                        <div style={{
                          display: 'flex',
                          gap: '8px',
                          padding: '12px 16px',
                          background: '#fff',
                          borderBottom: '1px solid #e2e8f0',
                          position: 'sticky',
                          top: 0,
                          zIndex: 10,
                          alignItems: 'center'
                        }}>
                          <div style={{color: '#1e293b', fontSize: '14px', fontWeight: '600'}}>
                            Invoice Preview: <span style={{color: '#10b981'}}>{generatedInvoice.invoiceNo}</span>
                          </div>
                          <div style={{flex: 1}} />
                          <button
                            onClick={() => {
                              const printContent = document.getElementById('dashboard-invoice-print-area');
                              if (printContent) {
                                const printWindow = window.open('', '_blank');
                                printWindow.document.write('<html><head><title>Invoice ' + generatedInvoice.invoiceNo + '</title>');
                                printWindow.document.write('<style>@media print { body { margin: 0; } }</style>');
                                printWindow.document.write('</head><body>');
                                printWindow.document.write(printContent.innerHTML);
                                printWindow.document.write('</body></html>');
                                printWindow.document.close();
                                printWindow.print();
                              }
                            }}
                            style={{padding: '8px 16px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            ðŸ–¨ï¸ Print
                          </button>
                          <button
                            style={{padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            ðŸ“¥ Download PDF
                          </button>
                          <button
                            onClick={() => { setShowInvoicePreview(false); setGeneratedInvoice(null); }}
                            style={{padding: '8px 16px', background: '#64748b', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            âœ• Close
                          </button>
                        </div>
                        
                        {/* Invoice Template */}
                        <div id="dashboard-invoice-print-area" style={{padding: '20px'}}>
                          {(() => {
                            const currentOrg = data.organizations?.find(o => o.id === (generatedInvoice.orgId || generatedInvoice.organizationId)) || {};
                            const client = data.clients?.find(c => c.id === generatedInvoice.clientId) || {};
                            
                            const gstApplicable = generatedInvoice.gstApplicable !== false && currentOrg.gstApplicable === 'yes';
                            const invoiceFormat = generatedInvoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
                            const isDarkTheme = invoiceFormat === 'billOfSupply';
                            
                            const primaryColor = isDarkTheme ? '#374151' : '#111827';
                            const headerGradient = isDarkTheme 
                              ? 'linear-gradient(135deg, #374151 0%, #4b5563 50%, #6b7280 100%)'
                              : 'linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%)';
                            
                            let invoiceTitle = 'TAX INVOICE';
                            if (invoiceFormat === 'billOfSupply') invoiceTitle = 'BILL OF SUPPLY';
                            else if (invoiceFormat === 'proformaInvoice') invoiceTitle = 'PROFORMA INVOICE';
                            
                            const showGst = gstApplicable && invoiceFormat !== 'billOfSupply';
                            
                            const displayOrg = {
                              name: currentOrg.name || generatedInvoice.orgName || generatedInvoice.organizationName,
                              address: currentOrg.address || generatedInvoice.orgAddress,
                              mobile: currentOrg.mobile || generatedInvoice.orgMobile,
                              email: currentOrg.email || generatedInvoice.orgEmail,
                              gstin: currentOrg.gstin || generatedInvoice.orgGstin,
                              pan: currentOrg.pan || generatedInvoice.orgPan,
                              logo: currentOrg.logo || generatedInvoice.orgLogo,
                              signature: currentOrg.signature || generatedInvoice.orgSignature,
                              signatory: currentOrg.signatory || generatedInvoice.orgSignatory,
                              bankName: currentOrg.bankName || generatedInvoice.orgBankName,
                              bankAccount: currentOrg.bankAccount || generatedInvoice.orgBankAccount,
                              bankIfsc: currentOrg.bankIfsc || generatedInvoice.orgBankIfsc,
                            };
                            
                            const displayClient = {
                              name: generatedInvoice.clientName || client.name,
                              address: generatedInvoice.clientAddress || client.address,
                              gstin: generatedInvoice.clientGstin || client.gstin,
                              pan: generatedInvoice.clientPan || client.pan,
                              state: generatedInvoice.clientState || client.state,
                            };
                            
                            return (
                              <div style={{background: '#fff', border: `2px solid ${primaryColor}`, borderRadius: '0'}}>
                                {/* Header */}
                                <div style={{background: headerGradient, padding: '20px 24px', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                  <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                                    {displayOrg.logo && <img src={displayOrg.logo} alt="" style={{height: '60px', objectFit: 'contain', background: '#fff', padding: '4px', borderRadius: '4px'}} />}
                                    <div>
                                      <h1 style={{margin: 0, fontSize: '22px', fontWeight: '800', color: '#fff', letterSpacing: '0.5px'}}>{displayOrg.name}</h1>
                                      <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.85)', marginTop: '4px'}}>{displayOrg.address}</div>
                                    </div>
                                  </div>
                                  <div style={{textAlign: 'right'}}>
                                    <div style={{fontSize: '20px', fontWeight: '800', color: '#fff', letterSpacing: '2px'}}>{invoiceTitle}</div>
                                    {displayOrg.gstin && showGst && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.9)', marginTop: '4px'}}>GSTIN: {displayOrg.gstin}</div>}
                                  </div>
                                </div>
                                
                                {/* Invoice Details Row */}
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '16px 24px', borderBottom: `1px solid ${primaryColor}`, background: '#f8fafc'}}>
                                  <div>
                                    <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Invoice Number</div>
                                    <div style={{fontSize: '16px', fontWeight: '700', color: primaryColor}}>{generatedInvoice.invoiceNo}</div>
                                  </div>
                                  <div style={{textAlign: 'right'}}>
                                    <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Invoice Date</div>
                                    <div style={{fontSize: '16px', fontWeight: '700', color: primaryColor}}>{new Date(generatedInvoice.invoiceDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})}</div>
                                  </div>
                                </div>
                                
                                {/* Bill To */}
                                <div style={{padding: '16px 24px', borderBottom: `1px solid ${primaryColor}`}}>
                                  <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px'}}>Bill To</div>
                                  <div style={{fontSize: '15px', fontWeight: '700', color: primaryColor}}>{displayClient.name}</div>
                                  {displayClient.address && <div style={{fontSize: '12px', color: '#64748b', marginTop: '2px'}}>{displayClient.address}</div>}
                                  {displayClient.gstin && showGst && <div style={{fontSize: '11px', color: '#64748b', marginTop: '4px'}}>GSTIN: {displayClient.gstin}</div>}
                                </div>
                                
                                {/* Services Table */}
                                <div style={{padding: '16px 24px'}}>
                                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                    <thead>
                                      <tr style={{background: primaryColor}}>
                                        <th style={{padding: '10px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Description</th>
                                        <th style={{padding: '10px', textAlign: 'right', color: '#fff', fontWeight: '600'}}>Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr>
                                        <td style={{padding: '12px 10px', borderBottom: '1px solid #e5e7eb'}}>
                                          {generatedInvoice.serviceDescription || generatedInvoice.narration || generatedInvoice.description || 'Professional Services'}
                                        </td>
                                        <td style={{padding: '12px 10px', textAlign: 'right', borderBottom: '1px solid #e5e7eb'}}>
                                          â‚¹{(generatedInvoice.netAmount || generatedInvoice.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                
                                {/* Totals */}
                                <div style={{padding: '16px 24px', background: '#f8fafc', borderTop: `1px solid ${primaryColor}`}}>
                                  <div style={{display: 'flex', justifyContent: 'flex-end'}}>
                                    <div style={{width: '250px'}}>
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px'}}>
                                        <span>Subtotal:</span>
                                        <span>â‚¹{(generatedInvoice.netAmount || generatedInvoice.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                      {showGst && (generatedInvoice.cgst > 0 || generatedInvoice.sgst > 0) && (
                                        <>
                                          <div style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px'}}>
                                            <span>CGST @9%:</span>
                                            <span>â‚¹{(generatedInvoice.cgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                          </div>
                                          <div style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px'}}>
                                            <span>SGST @9%:</span>
                                            <span>â‚¹{(generatedInvoice.sgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                          </div>
                                        </>
                                      )}
                                      {showGst && generatedInvoice.igst > 0 && (
                                        <div style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px'}}>
                                          <span>IGST @18%:</span>
                                          <span>â‚¹{(generatedInvoice.igst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                        </div>
                                      )}
                                      {showGst && !generatedInvoice.cgst && !generatedInvoice.igst && (generatedInvoice.gstAmount || generatedInvoice.taxAmount) > 0 && (
                                        <div style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px'}}>
                                          <span>GST @18%:</span>
                                          <span>â‚¹{(generatedInvoice.gstAmount || generatedInvoice.taxAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                        </div>
                                      )}
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', fontSize: '16px', fontWeight: '700', borderTop: `2px solid ${primaryColor}`, marginTop: '8px'}}>
                                        <span>Total:</span>
                                        <span style={{color: '#10b981'}}>â‚¹{(generatedInvoice.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Bank Details & Signature */}
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '16px 24px', borderTop: `1px solid ${primaryColor}`}}>
                                  {displayOrg.bankName && (
                                    <div style={{fontSize: '11px'}}>
                                      <div style={{fontWeight: '600', marginBottom: '4px'}}>Bank Details:</div>
                                      <div>Bank: {displayOrg.bankName}</div>
                                      <div>A/C No: {displayOrg.bankAccount}</div>
                                      <div>IFSC: {displayOrg.bankIfsc}</div>
                                    </div>
                                  )}
                                  <div style={{textAlign: 'right'}}>
                                    {displayOrg.signature && <img src={displayOrg.signature} alt="Signature" style={{height: '50px', marginBottom: '4px'}} />}
                                    <div style={{fontSize: '12px', fontWeight: '600'}}>For {displayOrg.name}</div>
                                    {displayOrg.signatory && <div style={{fontSize: '11px', color: '#64748b'}}>{displayOrg.signatory}</div>}
                                  </div>
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                      </div>
                    </div>
                  )}
                </>
              );
            })()}
          </div>
        )}

        {/* Organizations Tab Content */}
        {activeTab === 'organizations' && (
          <div>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
              <h2 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Organizations</h2>
              <button
                onClick={() => { resetOrgForm(); setShowOrgModal(true); }}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '10px 20px',
                  background: '#10b981',
                  color: '#fff',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '500'
                }}
              >
                <Plus size={18} /> Add Organization
              </button>
            </div>

            {/* Organizations Table */}
            <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
              <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                <thead>
                  <tr style={{background: '#f8fafc'}}>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Organization</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Address Details</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Contact Details</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Website Details</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>GSTIN/PAN No.</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Bank Details</th>
                    <th style={{padding: '14px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Authorized Signatory</th>
                    <th style={{padding: '14px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Logo</th>
                    <th style={{padding: '14px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {(data.organizations || []).length === 0 ? (
                    <tr>
                      <td colSpan={9} style={{padding: '40px', textAlign: 'center', color: '#64748b'}}>
                        No organizations added yet. Click "Add Organization" to create one.
                      </td>
                    </tr>
                  ) : (
                    (data.organizations || []).map(org => (
                      <tr key={org.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                        <td style={{padding: '14px', fontWeight: '500', color: '#0ea5e9'}}>{org.name}</td>
                        <td style={{padding: '14px'}}>
                          <div style={{fontSize: '12px'}}>
                            <strong>Address:</strong> {org.address || '-'}<br/>
                            <strong>State:</strong> {org.state || '-'}
                          </div>
                        </td>
                        <td style={{padding: '14px'}}>
                          <div style={{fontSize: '12px'}}>
                            <strong>Phone:</strong> {org.phoneNo || '-'}<br/>
                            <strong>Mobile:</strong> {org.mobileNo || '-'}<br/>
                            <strong>Email:</strong> {org.emailId || '-'}
                          </div>
                        </td>
                        <td style={{padding: '14px'}}>
                          <div style={{fontSize: '12px'}}>
                            <strong>Website:</strong> {org.website || '-'}<br/>
                            <strong>Fax:</strong> {org.faxNo || '-'}
                          </div>
                        </td>
                        <td style={{padding: '14px'}}>
                          <div style={{fontSize: '12px'}}>
                            <div style={{marginBottom: '6px'}}>
                              <span style={{
                                padding: '3px 8px',
                                borderRadius: '4px',
                                fontSize: '10px',
                                fontWeight: '600',
                                background: org.gstApplicable === 'yes' ? '#dcfce7' : '#fef2f2',
                                color: org.gstApplicable === 'yes' ? '#166534' : '#dc2626'
                              }}>
                                GST: {org.gstApplicable === 'yes' ? 'Applicable' : 'Not Applicable'}
                              </span>
                            </div>
                            <strong>GSTIN:</strong> {org.gstin || 'Not Available'}<br/>
                            <strong>PAN:</strong> {org.panNo || '-'}
                          </div>
                        </td>
                        <td style={{padding: '14px'}}>
                          <div style={{fontSize: '12px'}}>
                            <strong>Bank:</strong> {org.bankName || '-'}<br/>
                            <strong>A/C:</strong> {org.bankAccountNo || '-'}
                          </div>
                        </td>
                        <td style={{padding: '14px'}}>{org.authorizedSignatory || '-'}</td>
                        <td style={{padding: '14px', textAlign: 'center'}}>
                          {org.logo ? (
                            <img src={org.logo} alt="Logo" style={{maxWidth: '50px', maxHeight: '50px', objectFit: 'contain'}} />
                          ) : '-'}
                        </td>
                        <td style={{padding: '14px', textAlign: 'center'}}>
                          <div style={{display: 'flex', gap: '8px', justifyContent: 'center'}}>
                            <button
                              onClick={() => editOrganization(org)}
                              style={{padding: '6px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer'}}
                              title="Edit"
                            >
                              <Edit size={14} />
                            </button>
                            <button
                              onClick={() => deleteOrganization(org.id)}
                              style={{padding: '6px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer'}}
                              title="Delete"
                            >
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Billing Tab */}
        {activeTab === 'billing' && (
          <div>
            {/* Check if organization exists */}
            {(data.organizations || []).length === 0 ? (
              <div style={{background: '#fff', padding: '40px', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', textAlign: 'center'}}>
                <Briefcase size={48} style={{marginBottom: '16px', opacity: 0.5, color: '#64748b'}} />
                <p style={{color: '#64748b'}}>Please add an organization first before creating invoices.</p>
                <button
                  onClick={() => setSelectedInvoicingTab('organizations')}
                  style={{marginTop: '12px', padding: '10px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '600'}}
                >
                  Go to Organization
                </button>
              </div>
            ) : (
              <>
                {/* Billing Mode Tabs - Enhanced Green Theme */}
                <div style={{
                  display: 'flex',
                  gap: '0',
                  marginBottom: '24px',
                  background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
                  borderRadius: '12px',
                  overflow: 'hidden',
                  boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                  border: '1px solid #86efac'
                }}>
                  {[
                    { id: 'single', label: 'ðŸ“ Single Task', icon: 'ðŸ“' },
                    { id: 'multiple', label: 'ðŸ“‹ Multiple Task', icon: 'ðŸ“‹' },
                    { id: 'bulk', label: 'ðŸ“¦ Bulk Invoice', icon: 'ðŸ“¦' },
                    { id: 'latest', label: `ðŸ§¾ Latest Invoices (${(data.latestGeneratedInvoices || []).length})`, icon: 'ðŸ§¾' }
                  ].map((mode, idx) => (
                    <button
                      key={mode.id}
                      onClick={() => setBillingMode(mode.id)}
                      style={{
                        flex: 1,
                        padding: '16px 20px',
                        background: billingMode === mode.id ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'transparent',
                        color: billingMode === mode.id ? '#fff' : '#065f46',
                        border: 'none',
                        borderRight: idx < 3 ? '1px solid #86efac' : 'none',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px'
                      }}
                    >
                      {mode.label}
                    </button>
                  ))}
                </div>

                {/* Single Task Mode */}
                {billingMode === 'single' && (
                  <div>
                    {/* With Task / Without Task Toggle - Green Theme */}
                    <div style={{
                      display: 'flex',
                      gap: '0',
                      marginBottom: '20px',
                      background: '#fff',
                      borderRadius: '10px',
                      overflow: 'hidden',
                      border: '2px solid #e2e8f0',
                      width: 'fit-content'
                    }}>
                      <button
                        onClick={() => { setSingleTaskMode('withTask'); setHasSearched(false); setSearchedTasks([]); setSelectedBillingTask(null); }}
                        style={{
                          padding: '12px 28px',
                          background: singleTaskMode === 'withTask' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#fff',
                          color: singleTaskMode === 'withTask' ? '#fff' : '#64748b',
                          border: 'none',
                          borderRight: '1px solid #e2e8f0',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '600',
                          transition: 'all 0.2s'
                        }}
                      >
                        âœ“ With Task
                      </button>
                      <button
                        onClick={() => { setSingleTaskMode('withoutTask'); setHasSearched(false); setSearchedTasks([]); setSelectedBillingTask(null); setWithoutTaskForm({
                          clientId: '', clientName: '', clientCode: '', groupName: '', organizationId: '',
                          invoiceDate: new Date().toISOString().split('T')[0], narration: '', amount: '', discount: '', remark: ''
                        }); }}
                        style={{
                          padding: '12px 28px',
                          background: singleTaskMode === 'withoutTask' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#fff',
                          color: singleTaskMode === 'withoutTask' ? '#fff' : '#64748b',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '600',
                          transition: 'all 0.2s'
                        }}
                      >
                        âœ• Without Task
                      </button>
                    </div>

                    {/* With Task - Search Form */}
                    {singleTaskMode === 'withTask' && (
                      <>
                        {/* Search Task Section - Enhanced Green Theme */}
                        <div style={{background: '#fff', borderRadius: '16px', padding: '24px', marginBottom: '20px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                          <h3 style={{margin: '0 0 20px 0', fontSize: '16px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <Search size={20} style={{color: '#10b981'}} /> Search Task
                          </h3>
                          
                          {/* Row 1: Client Filters */}
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '16px'}}>
                            {/* Group No. with Autocomplete */}
                            <div style={{position: 'relative'}}>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Group No.</label>
                              <input
                                type="text"
                                value={billingSearchFilters.groupName}
                                onChange={(e) => handleGroupNameChange(e.target.value)}
                                onFocus={() => {
                                  if (billingSearchFilters.groupName.length >= 1) {
                                    handleGroupNameChange(billingSearchFilters.groupName);
                                  }
                                }}
                                onBlur={() => setTimeout(() => setShowGroupNameSuggestions(false), 200)}
                                placeholder="Type group no. (e.g., 1, 2...)"
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4', transition: 'border 0.2s'}}
                              />
                              {showGroupNameSuggestions && groupNameSuggestions.length > 0 && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  background: '#fff',
                                  border: '2px solid #10b981',
                                  borderRadius: '8px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 100,
                                  maxHeight: '200px',
                                  overflow: 'auto'
                                }}>
                                  {groupNameSuggestions.map(group => (
                                    <div
                                      key={group}
                                      onClick={() => {
                                        setBillingSearchFilters({...billingSearchFilters, groupName: group});
                                        setShowGroupNameSuggestions(false);
                                      }}
                                      style={{padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '13px', color: '#065f46'}}
                                      onMouseEnter={(e) => e.target.style.background = '#f0fdf4'}
                                      onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                      Group {group}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                            
                            {/* Client Name with Autocomplete */}
                            <div style={{position: 'relative'}}>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Client Name</label>
                              <input
                                type="text"
                                value={billingSearchFilters.clientName}
                                onChange={(e) => handleClientNameChange(e.target.value)}
                                onFocus={() => {
                                  if (billingSearchFilters.clientName.length >= 2) {
                                    handleClientNameChange(billingSearchFilters.clientName);
                                  }
                                }}
                                onBlur={() => setTimeout(() => setShowClientNameSuggestions(false), 200)}
                                placeholder="Type 2+ letters..."
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              />
                              {showClientNameSuggestions && clientNameSuggestions.length > 0 && (
                                <div style={{position: 'absolute', top: '100%', left: 0, right: 0, background: '#fff', border: '2px solid #10b981', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 100, maxHeight: '200px', overflow: 'auto'}}>
                                  {clientNameSuggestions.map(client => (
                                    <div
                                      key={client.id}
                                      onClick={() => {
                                        setBillingSearchFilters({...billingSearchFilters, clientName: client.name, clientCode: client.fileNo || '', groupName: client.fileNo ? client.fileNo.split('.')[0] : ''});
                                        setShowClientNameSuggestions(false);
                                      }}
                                      style={{padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '13px'}}
                                      onMouseEnter={(e) => e.target.style.background = '#f0fdf4'}
                                      onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                      <div style={{fontWeight: '600', color: '#065f46'}}>{client.name}</div>
                                      <div style={{fontSize: '11px', color: '#64748b'}}>{client.fileNo} {client.fileNo ? `â€¢ Group ${client.fileNo.split('.')[0]}` : ''}</div>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                            
                            {/* Client Code */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Client Code</label>
                              <input
                                type="text"
                                value={billingSearchFilters.clientCode}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, clientCode: e.target.value})}
                                placeholder="Enter code..."
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              />
                            </div>
                          </div>
                          
                          {/* Row 2: Task Filters */}
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '16px'}}>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Parent Task</label>
                              <select
                                value={billingSearchFilters.parentTask}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, parentTask: e.target.value, childTask: ''})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              >
                                <option value="">All Parent Tasks</option>
                                {[...new Set((data.tasks || []).map(t => t.parentTask).filter(Boolean))].map(pt => (
                                  <option key={pt} value={pt}>{pt}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Child Task</label>
                              <select
                                value={billingSearchFilters.childTask}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, childTask: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              >
                                <option value="">All Child Tasks</option>
                                {[...new Set((data.tasks || []).filter(t => !billingSearchFilters.parentTask || t.parentTask === billingSearchFilters.parentTask).map(t => t.childTask).filter(Boolean))].map(ct => (
                                  <option key={ct} value={ct}>{ct}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Financial Year</label>
                              <select
                                value={billingSearchFilters.financialYear}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, financialYear: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              >
                                <option value="">All Years</option>
                                <option value="FY 2024-25">FY 2024-25</option>
                                <option value="FY 2023-24">FY 2023-24</option>
                                <option value="FY 2025-26">FY 2025-26</option>
                              </select>
                            </div>
                          </div>
                          
                          {/* Row 3: Period & Status */}
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '20px'}}>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Period</label>
                              <select
                                value={billingSearchFilters.period}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, period: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              >
                                <option value="">All Periods</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Half Yearly">Half Yearly</option>
                                <option value="Annual">Annual</option>
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Status</label>
                              <select
                                value={billingSearchFilters.status}
                                onChange={(e) => setBillingSearchFilters({...billingSearchFilters, status: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                              >
                                <option value="">All Status</option>
                                <option value="Completed">Completed</option>
                                <option value="In Progress">In Progress</option>
                              </select>
                            </div>
                            <div style={{display: 'flex', alignItems: 'flex-end', gap: '12px'}}>
                              <button
                                onClick={() => {
                                  const filtered = (data.tasks || []).filter(t => {
                                    if (t.billed) return false;
                                    if (t.markedFree) return false;
                                    // Group No. filter - compare against first part of fileNo (e.g., "1" from "1.01")
                                    if (billingSearchFilters.groupName) {
                                      const taskGroupNo = t.fileNo ? t.fileNo.split('.')[0] : '';
                                      if (!taskGroupNo.toLowerCase().includes(billingSearchFilters.groupName.toLowerCase())) return false;
                                    }
                                    if (billingSearchFilters.clientName && !(t.clientName || '').toLowerCase().includes(billingSearchFilters.clientName.toLowerCase())) return false;
                                    if (billingSearchFilters.clientCode && !(t.fileNo || '').toLowerCase().includes(billingSearchFilters.clientCode.toLowerCase())) return false;
                                    if (billingSearchFilters.parentTask && t.parentTask !== billingSearchFilters.parentTask) return false;
                                    if (billingSearchFilters.childTask && t.childTask !== billingSearchFilters.childTask) return false;
                                    if (billingSearchFilters.financialYear && t.financialYear !== billingSearchFilters.financialYear) return false;
                                    if (billingSearchFilters.period && t.period !== billingSearchFilters.period) return false;
                                    if (billingSearchFilters.status && t.status !== billingSearchFilters.status) return false;
                                    return true;
                                  });
                                  console.log('Search results:', filtered.length, 'unbilled tasks found');
                                  setSearchedTasks(filtered);
                                  setHasSearched(true);
                                }}
                                style={{flex: 1, padding: '10px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', boxShadow: '0 2px 8px rgba(16,185,129,0.3)'}}
                              >
                                ðŸ” Search Tasks
                              </button>
                              <button
                                onClick={() => {
                                  // Show all unbilled tasks that match current filters (but not requiring any specific filter)
                                  const allUnbilled = (data.tasks || []).filter(t => {
                                    if (t.billed) return false;
                                    if (t.markedFree) return false;
                                    // Apply any filters that are set
                                    if (billingSearchFilters.groupName) {
                                      const taskGroupNo = t.fileNo ? t.fileNo.split('.')[0] : '';
                                      if (!taskGroupNo.toLowerCase().includes(billingSearchFilters.groupName.toLowerCase())) return false;
                                    }
                                    if (billingSearchFilters.clientName && !(t.clientName || '').toLowerCase().includes(billingSearchFilters.clientName.toLowerCase())) return false;
                                    if (billingSearchFilters.clientCode && !(t.fileNo || '').toLowerCase().includes(billingSearchFilters.clientCode.toLowerCase())) return false;
                                    if (billingSearchFilters.parentTask && t.parentTask !== billingSearchFilters.parentTask) return false;
                                    if (billingSearchFilters.childTask && t.childTask !== billingSearchFilters.childTask) return false;
                                    if (billingSearchFilters.financialYear && t.financialYear !== billingSearchFilters.financialYear) return false;
                                    if (billingSearchFilters.period && t.period !== billingSearchFilters.period) return false;
                                    if (billingSearchFilters.status && t.status !== billingSearchFilters.status) return false;
                                    return true;
                                  });
                                  console.log('Filtered unbilled tasks:', allUnbilled.length);
                                  setSearchedTasks(allUnbilled);
                                  setHasSearched(true);
                                }}
                                style={{padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}
                              >
                                Show All Unbilled ({(data.tasks || []).filter(t => !t.billed && !t.markedFree).length})
                              </button>
                              <button
                                onClick={() => {
                                  setBillingSearchFilters({groupName: '', clientName: '', clientCode: '', parentTask: '', childTask: '', financialYear: '', period: '', status: ''});
                                  setSearchedTasks([]);
                                  setHasSearched(false);
                                }}
                                style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                              >
                                Reset
                              </button>
                            </div>
                          </div>
                        </div>

                        {/* Search Results */}
                        {hasSearched && (
                          <div style={{background: '#fff', borderRadius: '16px', padding: '24px', marginBottom: '20px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                            <h3 style={{margin: '0 0 16px 0', fontSize: '16px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                              ðŸ“‹ Search Results ({searchedTasks.length} unbilled tasks)
                            </h3>
                            {searchedTasks.length === 0 ? (
                              <div style={{textAlign: 'center', padding: '40px', background: '#f8fafc', borderRadius: '12px'}}>
                                <div style={{fontSize: '48px', marginBottom: '12px'}}>ðŸ”</div>
                                <div style={{color: '#64748b', fontSize: '14px'}}>No unbilled tasks found matching your criteria</div>
                              </div>
                            ) : (
                              <div style={{border: '1px solid #e2e8f0', borderRadius: '10px', overflow: 'hidden'}}>
                                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                  <thead>
                                    <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                      <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                                      <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Task</th>
                                      <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>FY / Period</th>
                                      <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Status</th>
                                      <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Action</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {searchedTasks.slice(0, 20).map((task, idx) => (
                                      <tr key={task.id} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4', borderBottom: '1px solid #e2e8f0'}}>
                                        <td style={{padding: '10px'}}>
                                          <div style={{fontWeight: '600', color: '#065f46'}}>{task.clientName}</div>
                                          <div style={{fontSize: '11px', color: '#64748b'}}>{task.fileNo} {task.fileNo ? `â€¢ Group ${task.fileNo.split('.')[0]}` : ''}</div>
                                        </td>
                                        <td style={{padding: '10px'}}>
                                          <div>{task.childTask || task.parentTask}</div>
                                          <div style={{fontSize: '10px', color: '#64748b'}}>{task.parentTask}</div>
                                        </td>
                                        <td style={{padding: '10px', textAlign: 'center'}}>
                                          <div style={{fontSize: '11px'}}>{task.financialYear}</div>
                                          <div style={{fontSize: '10px', color: '#64748b'}}>{task.period} {task.subPeriod}</div>
                                        </td>
                                        <td style={{padding: '10px', textAlign: 'center'}}>
                                          <span style={{padding: '4px 10px', borderRadius: '20px', fontSize: '10px', fontWeight: '600', background: task.status === 'Completed' ? '#dcfce7' : '#fef3c7', color: task.status === 'Completed' ? '#166534' : '#92400e'}}>{task.status}</span>
                                        </td>
                                        <td style={{padding: '10px', textAlign: 'center'}}>
                                          <button
                                            onClick={() => setSelectedBillingTask(task)}
                                            style={{padding: '6px 16px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: '600'}}
                                          >
                                            Generate Invoice
                                          </button>
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Billing Form for Selected Task */}
                        {selectedBillingTask && (
                          <div style={{background: '#fff', borderRadius: '16px', padding: '24px', boxShadow: '0 4px 20px rgba(0,0,0,0.12)', border: '2px solid #10b981'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px'}}>
                              <div>
                                <h3 style={{margin: '0 0 8px 0', fontSize: '18px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                                  ðŸ“„ Generate Invoice
                                </h3>
                                <div style={{fontSize: '14px', color: '#1e293b'}}>
                                  <strong>{selectedBillingTask.clientName}</strong> â€¢ {selectedBillingTask.fileNo}
                                </div>
                                <div style={{fontSize: '13px', color: '#64748b', marginTop: '4px'}}>
                                  {selectedBillingTask.parentTask} â†’ {selectedBillingTask.childTask} â€¢ {selectedBillingTask.financialYear} {selectedBillingTask.subPeriod || selectedBillingTask.period}
                                </div>
                              </div>
                              <button
                                onClick={() => setSelectedBillingTask(null)}
                                style={{padding: '6px 12px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}
                              >
                                âœ• Cancel
                              </button>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '20px'}}>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Organization <span style={{color: '#dc2626'}}>*</span></label>
                                <select
                                  value={billingDetails.organizationId}
                                  onChange={(e) => setBillingDetails({...billingDetails, organizationId: e.target.value})}
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                                >
                                  <option value="">Select Organization</option>
                                  {(data.organizations || []).map(org => (
                                    <option key={org.id} value={org.id}>{org.name}</option>
                                  ))}
                                </select>
                              </div>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Invoice Date <span style={{color: '#dc2626'}}>*</span></label>
                                <input
                                  type="date"
                                  value={billingDetails.billDate}
                                  onChange={(e) => setBillingDetails({...billingDetails, billDate: e.target.value})}
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                                />
                              </div>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Place of Supply</label>
                                <select
                                  value={billingDetails.placeOfSupply}
                                  onChange={(e) => setBillingDetails({...billingDetails, placeOfSupply: e.target.value})}
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                                >
                                  <option value="">Select State</option>
                                  {INDIAN_STATES.map(state => (
                                    <option key={state} value={state}>{state}</option>
                                  ))}
                                </select>
                              </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '20px'}}>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Amount <span style={{color: '#dc2626'}}>*</span></label>
                                <input
                                  type="number"
                                  value={billingDetails.amount}
                                  onChange={(e) => {
                                    const amt = e.target.value;
                                    const disc = parseFloat(billingDetails.discount) || 0;
                                    setBillingDetails({...billingDetails, amount: amt, netAmount: (parseFloat(amt) || 0) - disc});
                                  }}
                                  placeholder="Enter amount"
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                                />
                              </div>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Discount</label>
                                <input
                                  type="number"
                                  value={billingDetails.discount}
                                  onChange={(e) => {
                                    const disc = e.target.value;
                                    const amt = parseFloat(billingDetails.amount) || 0;
                                    setBillingDetails({...billingDetails, discount: disc, netAmount: amt - (parseFloat(disc) || 0)});
                                  }}
                                  placeholder="0"
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                                />
                              </div>
                              <div>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Net Amount</label>
                                <input
                                  type="text"
                                  value={`â‚¹ ${(billingDetails.netAmount || 0).toLocaleString('en-IN')}`}
                                  readOnly
                                  style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#dcfce7', fontWeight: '600', color: '#065f46'}}
                                />
                              </div>
                            </div>

                            <div style={{marginBottom: '20px'}}>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Narration / Description</label>
                              <textarea
                                value={billingDetails.narration}
                                onChange={(e) => setBillingDetails({...billingDetails, narration: e.target.value})}
                                placeholder={`Professional Fees for ${selectedBillingTask.childTask || selectedBillingTask.parentTask}`}
                                rows={2}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #d1fae5', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4', resize: 'vertical'}}
                              />
                            </div>

                            <div style={{display: 'flex', justifyContent: 'flex-end', gap: '12px'}}>
                              <button
                                onClick={() => setSelectedBillingTask(null)}
                                style={{padding: '12px 24px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}
                              >
                                Cancel
                              </button>
                              <button
                                onClick={() => {
                                  // Validate
                                  if (!billingDetails.organizationId) {
                                    alert('Please select an organization');
                                    return;
                                  }
                                  if (!billingDetails.amount || parseFloat(billingDetails.amount) <= 0) {
                                    alert('Please enter a valid amount');
                                    return;
                                  }

                                  const task = selectedBillingTask;
                                  const client = (data.clients || []).find(c => c.name === task.clientName || c.id === task.clientId);
                                  const org = (data.organizations || []).find(o => o.id === billingDetails.organizationId);

                                  if (!org) {
                                    alert('Organization not found');
                                    return;
                                  }

                                  // Calculate amounts and GST
                                  const netAmount = parseFloat(billingDetails.netAmount) || parseFloat(billingDetails.amount) - (parseFloat(billingDetails.discount) || 0);
                                  const supplierState = (org.state || '').toLowerCase();
                                  const receiverState = (billingDetails.placeOfSupply || client?.state || '').toLowerCase();
                                  const isInterState = supplierState && receiverState && supplierState !== receiverState;
                                  const gstApplicable = org.gstApplicable === 'yes';

                                  let cgst = 0, sgst = 0, igst = 0;
                                  if (gstApplicable && netAmount > 0) {
                                    if (isInterState) {
                                      igst = Math.round(netAmount * 0.18 * 100) / 100;
                                    } else {
                                      cgst = Math.round(netAmount * 0.09 * 100) / 100;
                                      sgst = Math.round(netAmount * 0.09 * 100) / 100;
                                    }
                                  }
                                  const totalAmount = netAmount + cgst + sgst + igst;

                                  // Generate invoice number
                                  const currentNo = org.invoiceCurrentNo || org.invoiceStartNo || 1;
                                  const invoiceNo = `${org.invoicePrefix || 'INV'}${String(currentNo).padStart(org.invoiceDigits || 4, '0')}${org.invoiceSuffix || ''}`;

                                  const newInvoice = {
                                    id: Date.now().toString(),
                                    invoiceNo,
                                    invoiceCurrentNo: currentNo,
                                    invoiceDate: billingDetails.billDate,
                                    taskId: task.id,
                                    taskIds: [task.id], // Array for consistency with multi-task invoices
                                    clientId: client?.id,
                                    organizationId: org.id,
                                    orgId: org.id,
                                    invoiceFormat: gstApplicable ? 'taxInvoice' : 'billOfSupply',
                                    gstApplicable,
                                    orgName: org.name,
                                    orgAddress: org.address,
                                    orgState: org.state,
                                    orgGstin: org.gstin,
                                    orgPan: org.panNo,
                                    orgBankName: org.bankName,
                                    orgBankAccount: org.bankAccountNo,
                                    orgBankIfsc: org.bankIfsc,
                                    orgSignatory: org.authorizedSignatory,
                                    clientName: client?.name || task.clientName,
                                    clientAddress: client?.address || '',
                                    clientState: client?.state || billingDetails.placeOfSupply || '',
                                    clientGstin: client?.gstin || '',
                                    clientCode: client?.fileNo || task.fileNo,
                                    serviceDescription: billingDetails.narration || `Professional Fees for ${task.childTask || task.parentTask}`,
                                    narration: billingDetails.narration || `Professional Fees for ${task.childTask || task.parentTask}`,
                                    placeOfSupply: billingDetails.placeOfSupply || client?.state,
                                    amount: parseFloat(billingDetails.amount),
                                    discount: parseFloat(billingDetails.discount) || 0,
                                    netAmount,
                                    cgst,
                                    sgst,
                                    igst,
                                    totalAmount,
                                    taskType: task.childTask,
                                    parentTask: task.parentTask,
                                    financialYear: task.financialYear,
                                    period: task.subPeriod || task.period,
                                    createdAt: new Date().toISOString(),
                                    status: 'Generated'
                                  };

                                  // Save invoice and update task
                                  setData(prev => ({
                                    ...prev,
                                    invoices: [...(prev.invoices || []), newInvoice],
                                    organizations: prev.organizations.map(o =>
                                      o.id === org.id ? {...o, invoiceCurrentNo: currentNo + 1} : o
                                    ),
                                    tasks: prev.tasks.map(t =>
                                      t.id === task.id ? {...t, billed: true, invoiceId: newInvoice.id} : t
                                    ),
                                    latestGeneratedInvoices: [newInvoice, ...(prev.latestGeneratedInvoices || [])].slice(0, 50) // Keep last 50
                                  }));

                                  // Show success message first
                                  alert(`Invoice ${newInvoice.invoiceNo} generated successfully!`);
                                  
                                  // Navigate to Latest Invoices tab
                                  setBillingMode('latest');

                                  // Reset form
                                  setSelectedBillingTask(null);
                                  setBillingDetails({
                                    billDate: new Date().toISOString().split('T')[0],
                                    organizationId: '',
                                    amount: '',
                                    discount: '',
                                    netAmount: '',
                                    placeOfSupply: '',
                                    narration: '',
                                    remark: ''
                                  });
                                  setSearchedTasks(prev => prev.filter(t => t.id !== task.id));
                                }}
                                style={{padding: '12px 32px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 4px 12px rgba(16,185,129,0.4)'}}
                              >
                                âœ“ Generate Invoice
                              </button>
                            </div>
                          </div>
                        )}
                      </>
                    )}

                    {/* Without Task - Direct Invoice Form */}
                    {singleTaskMode === 'withoutTask' && (
                      <div style={{background: '#fff', padding: '28px', borderRadius: '16px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                        {/* Header with Green Gradient */}
                        <div style={{marginBottom: '24px', paddingBottom: '16px', borderBottom: '2px solid #d1fae5'}}>
                          <h3 style={{margin: '0', fontSize: '18px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <FileText size={22} style={{color: '#10b981'}} />
                            Create Invoice Without Task
                          </h3>
                          <p style={{margin: '8px 0 0', fontSize: '13px', color: '#64748b'}}>Generate an invoice directly without linking to a specific task</p>
                        </div>
                        
                        {/* Client Selection Section */}
                        <div style={{background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', padding: '20px', borderRadius: '12px', marginBottom: '24px', border: '1px solid #86efac'}}>
                          <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#065f46'}}>ðŸ“‹ Client Selection</h4>
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                            {/* Group No. with Typeahead */}
                            <div style={{position: 'relative'}}>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Group No.</label>
                              <input
                                type="text"
                                value={withoutTaskForm.groupName}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  setWithoutTaskForm({...withoutTaskForm, groupName: val});
                                  setShowWithoutTaskGroupSuggestions(val.length >= 2);
                                }}
                                onFocus={() => setShowWithoutTaskGroupSuggestions(withoutTaskForm.groupName.length >= 2)}
                                onBlur={() => setTimeout(() => setShowWithoutTaskGroupSuggestions(false), 200)}
                                placeholder="Type 2-3 letters..."
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #86efac', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                              {showWithoutTaskGroupSuggestions && (
                                <div style={{position: 'absolute', top: '100%', left: 0, right: 0, background: '#fff', border: '2px solid #10b981', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 100, maxHeight: '200px', overflow: 'auto'}}>
                                  {[...new Set((data.clients || []).map(c => c.groupName).filter(g => g && g.toLowerCase().includes(withoutTaskForm.groupName.toLowerCase())))].slice(0, 10).map(group => (
                                    <div
                                      key={group}
                                      onClick={() => {
                                        setWithoutTaskForm({...withoutTaskForm, groupName: group});
                                        setShowWithoutTaskGroupSuggestions(false);
                                      }}
                                      style={{padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '13px', color: '#065f46'}}
                                      onMouseEnter={(e) => e.target.style.background = '#f0fdf4'}
                                      onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                      {group}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                            
                            {/* Client Name with Typeahead */}
                            <div style={{position: 'relative'}}>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>
                                Client Name <span style={{color: '#dc2626'}}>*</span>
                              </label>
                              <input
                                type="text"
                                value={withoutTaskForm.clientName}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  setWithoutTaskForm({...withoutTaskForm, clientName: val});
                                  setShowWithoutTaskClientSuggestions(val.length >= 2);
                                }}
                                onFocus={() => setShowWithoutTaskClientSuggestions(withoutTaskForm.clientName.length >= 2)}
                                onBlur={() => setTimeout(() => setShowWithoutTaskClientSuggestions(false), 200)}
                                placeholder="Type 2-3 letters to search..."
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #86efac', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                              {showWithoutTaskClientSuggestions && (
                                <div style={{position: 'absolute', top: '100%', left: 0, right: 0, background: '#fff', border: '2px solid #10b981', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 100, maxHeight: '200px', overflow: 'auto'}}>
                                  {(data.clients || []).filter(c => {
                                    const matchName = c.name?.toLowerCase().includes(withoutTaskForm.clientName.toLowerCase());
                                    const matchGroup = !withoutTaskForm.groupName || c.groupName?.toLowerCase().includes(withoutTaskForm.groupName.toLowerCase());
                                    return matchName && matchGroup;
                                  }).slice(0, 10).map(client => (
                                    <div
                                      key={client.id}
                                      onClick={() => {
                                        setWithoutTaskForm({
                                          ...withoutTaskForm,
                                          clientId: client.id,
                                          clientName: client.name,
                                          clientCode: client.fileNo || '',
                                          groupName: client.fileNo ? client.fileNo.split('.')[0] : ''
                                        });
                                        setShowWithoutTaskClientSuggestions(false);
                                      }}
                                      style={{padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '13px'}}
                                      onMouseEnter={(e) => e.target.style.background = '#f0fdf4'}
                                      onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                      <div style={{fontWeight: '600', color: '#065f46'}}>{client.name}</div>
                                      <div style={{fontSize: '11px', color: '#64748b'}}>{client.fileNo} â€¢ Group {client.fileNo ? client.fileNo.split('.')[0] : '-'}</div>
                                    </div>
                                  ))}
                                  {(data.clients || []).filter(c => c.name?.toLowerCase().includes(withoutTaskForm.clientName.toLowerCase())).length === 0 && (
                                    <div style={{padding: '12px', color: '#64748b', textAlign: 'center', fontSize: '12px'}}>No clients found</div>
                                  )}
                                </div>
                              )}
                            </div>
                            
                            {/* Client Code (Read-only after selection) */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Client Code</label>
                              <input
                                type="text"
                                value={withoutTaskForm.clientCode}
                                readOnly
                                placeholder="Auto-filled"
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#f8fafc', color: '#64748b'}}
                              />
                            </div>
                          </div>
                        </div>
                        
                        {/* Invoice Details Section */}
                        <div style={{background: '#f8fafc', padding: '20px', borderRadius: '12px', marginBottom: '24px', border: '1px solid #e2e8f0'}}>
                          <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#374151'}}>ðŸ“„ Invoice Details</h4>
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '16px'}}>
                            {/* Organization */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                Organization <span style={{color: '#dc2626'}}>*</span>
                              </label>
                              <select
                                value={withoutTaskForm.organizationId}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, organizationId: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">Select Organization</option>
                                {(data.organizations || []).map(org => (
                                  <option key={org.id} value={org.id}>{org.name}</option>
                                ))}
                              </select>
                            </div>
                            
                            {/* Invoice Date */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                Invoice Date <span style={{color: '#dc2626'}}>*</span>
                              </label>
                              <input
                                type="date"
                                value={withoutTaskForm.invoiceDate}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, invoiceDate: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                            </div>
                            
                            {/* Narration */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                Narration <span style={{color: '#dc2626'}}>*</span>
                              </label>
                              <input
                                type="text"
                                value={withoutTaskForm.narration}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, narration: e.target.value})}
                                placeholder="e.g., Professional Fees"
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                            </div>
                          </div>
                          
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                            {/* Amount */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                Amount (â‚¹) <span style={{color: '#dc2626'}}>*</span>
                              </label>
                              <input
                                type="number"
                                value={withoutTaskForm.amount}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, amount: e.target.value})}
                                placeholder="0.00"
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                            </div>
                            
                            {/* Discount */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>Discount (â‚¹)</label>
                              <input
                                type="number"
                                value={withoutTaskForm.discount}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, discount: e.target.value})}
                                placeholder="0.00"
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                            </div>
                            
                            {/* Remark */}
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>Remark</label>
                              <input
                                type="text"
                                value={withoutTaskForm.remark}
                                onChange={(e) => setWithoutTaskForm({...withoutTaskForm, remark: e.target.value})}
                                placeholder="Optional note..."
                                style={{width: '100%', padding: '10px 12px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', background: '#fff'}}
                              />
                            </div>
                          </div>
                        </div>
                        
                        {/* Summary & Actions */}
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', padding: '16px 20px', borderRadius: '12px', border: '1px solid #86efac'}}>
                          <div>
                            {(() => {
                              const amount = parseFloat(withoutTaskForm.amount) || 0;
                              const discount = parseFloat(withoutTaskForm.discount) || 0;
                              const net = amount - discount;
                              const org = (data.organizations || []).find(o => o.id === withoutTaskForm.organizationId);
                              const client = (data.clients || []).find(c => c.id === withoutTaskForm.clientId);
                              const gstApplicable = org?.gstApplicable === 'yes';
                              
                              // Proper GST calculation based on state
                              let cgst = 0, sgst = 0, igst = 0;
                              const orgState = (org?.state || '').toLowerCase().trim();
                              const clientState = (client?.state || '').toLowerCase().trim();
                              
                              if (gstApplicable && net > 0) {
                                if (orgState && clientState && orgState === clientState) {
                                  cgst = Math.round(net * 0.09 * 100) / 100;
                                  sgst = Math.round(net * 0.09 * 100) / 100;
                                } else {
                                  igst = Math.round(net * 0.18 * 100) / 100;
                                }
                              }
                              const gst = cgst + sgst + igst;
                              const total = net + gst;
                              
                              return (
                                <div style={{display: 'flex', gap: '20px', fontSize: '13px', flexWrap: 'wrap', alignItems: 'center'}}>
                                  <div><span style={{color: '#64748b'}}>Net Amount:</span> <strong style={{color: '#065f46'}}>â‚¹{net.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></div>
                                  {gstApplicable && cgst > 0 && (
                                    <>
                                      <div><span style={{color: '#64748b'}}>CGST @9%:</span> <strong style={{color: '#059669'}}>â‚¹{cgst.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></div>
                                      <div><span style={{color: '#64748b'}}>SGST @9%:</span> <strong style={{color: '#059669'}}>â‚¹{sgst.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></div>
                                    </>
                                  )}
                                  {gstApplicable && igst > 0 && (
                                    <div><span style={{color: '#64748b'}}>IGST @18%:</span> <strong style={{color: '#059669'}}>â‚¹{igst.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></div>
                                  )}
                                  {!gstApplicable && org && (
                                    <div><span style={{color: '#d97706', fontSize: '11px'}}>GST Not Applicable</span></div>
                                  )}
                                  <div style={{paddingLeft: '12px', borderLeft: '2px solid #86efac'}}><span style={{color: '#64748b'}}>Total:</span> <strong style={{color: '#10b981', fontSize: '16px'}}>â‚¹{total.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></div>
                                </div>
                              );
                            })()}
                          </div>
                          <div style={{display: 'flex', gap: '12px'}}>
                            <button
                              onClick={() => setWithoutTaskForm({
                                clientId: '', clientName: '', clientCode: '', groupName: '', organizationId: '',
                                invoiceDate: new Date().toISOString().split('T')[0], narration: '', amount: '', discount: '', remark: ''
                              })}
                              style={{padding: '10px 20px', background: '#fff', color: '#64748b', border: '1px solid #e2e8f0', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                            >
                              Reset
                            </button>
                            <button
                              onClick={() => {
                                if (!withoutTaskForm.clientName || !withoutTaskForm.organizationId || !withoutTaskForm.narration || !withoutTaskForm.amount) {
                                  alert('Please fill all required fields: Client Name, Organization, Narration, and Amount');
                                  return;
                                }
                                
                                const org = (data.organizations || []).find(o => o.id === withoutTaskForm.organizationId);
                                const client = (data.clients || []).find(c => c.id === withoutTaskForm.clientId);
                                const amount = parseFloat(withoutTaskForm.amount) || 0;
                                const discount = parseFloat(withoutTaskForm.discount) || 0;
                                const net = amount - discount;
                                const gstApplicable = org?.gstApplicable === 'yes';
                                
                                // Proper CGST/SGST/IGST calculation based on state
                                let cgst = 0, sgst = 0, igst = 0, gst = 0;
                                if (gstApplicable && net > 0) {
                                  const orgState = (org?.state || '').toLowerCase().trim();
                                  const clientState = (client?.state || '').toLowerCase().trim();
                                  
                                  if (orgState && clientState && orgState === clientState) {
                                    // Same state - CGST + SGST
                                    cgst = Math.round(net * 0.09 * 100) / 100;
                                    sgst = Math.round(net * 0.09 * 100) / 100;
                                    gst = cgst + sgst;
                                  } else {
                                    // Different state or state not set - IGST
                                    igst = Math.round(net * 0.18 * 100) / 100;
                                    gst = igst;
                                  }
                                }
                                const total = net + gst;
                                
                                // Generate invoice number
                                const lastInv = (data.invoices || []).filter(i => i.organizationId === withoutTaskForm.organizationId).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                                const nextNum = lastInv ? (parseInt(lastInv.invoiceNo?.replace(/\D/g, '') || '0') + 1) : 1;
                                const invoiceNo = `${org?.prefix || 'INV'}-${String(nextNum).padStart(4, '0')}`;
                                
                                // Determine financial year based on invoice date
                                const invDate = new Date(withoutTaskForm.invoiceDate);
                                const invMonth = invDate.getMonth();
                                const invYear = invDate.getFullYear();
                                const fyStartYear = invMonth >= 3 ? invYear : invYear - 1;
                                const financialYear = `FY ${fyStartYear}-${String(fyStartYear + 1).slice(2)}`;
                                
                                const newInvoice = {
                                  id: generateId(),
                                  invoiceNo,
                                  organizationId: withoutTaskForm.organizationId,
                                  organizationName: org?.name,
                                  orgName: org?.name,
                                  clientId: withoutTaskForm.clientId,
                                  clientName: withoutTaskForm.clientName,
                                  clientCode: withoutTaskForm.clientCode,
                                  groupName: withoutTaskForm.groupName,
                                  invoiceDate: withoutTaskForm.invoiceDate,
                                  narration: withoutTaskForm.narration,
                                  serviceDescription: withoutTaskForm.narration,
                                  amount: amount,
                                  discount: discount,
                                  netAmount: net,
                                  cgst: cgst,
                                  sgst: sgst,
                                  igst: igst,
                                  gstAmount: gst,
                                  taxAmount: gst,
                                  totalAmount: total,
                                  remark: withoutTaskForm.remark,
                                  financialYear: financialYear,
                                  taskId: null,
                                  isWithoutTask: true,
                                  createdAt: new Date().toISOString(),
                                  createdBy: currentUser?.name || 'Unknown',
                                  status: 'Pending'
                                };
                                
                                setData(prev => ({
                                  ...prev, 
                                  invoices: [...(prev.invoices || []), newInvoice],
                                  latestGeneratedInvoices: [newInvoice, ...(prev.latestGeneratedInvoices || [])].slice(0, 50)
                                }));
                                
                                // Show success message first
                                alert(`Invoice ${newInvoice.invoiceNo} generated successfully!`);
                                
                                // Navigate to Latest Invoices tab
                                setBillingMode('latest');
                                
                                setWithoutTaskForm({
                                  clientId: '', clientName: '', clientCode: '', groupName: '', organizationId: '',
                                  invoiceDate: new Date().toISOString().split('T')[0], narration: '', amount: '', discount: '', remark: ''
                                });
                              }}
                              style={{padding: '10px 28px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 2px 8px rgba(16,185,129,0.4)'}}
                            >
                              âœ“ Generate Invoice
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Multiple Task Mode */}
                {billingMode === 'multiple' && (
                  <div>
                    {/* Step 1: Group Selection */}
                    {multipleTaskBillingStep === 'group' && (
                      <div style={{background: '#fff', padding: '28px', borderRadius: '16px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                        <div style={{marginBottom: '24px', paddingBottom: '16px', borderBottom: '2px solid #d1fae5'}}>
                          <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <Users size={22} style={{color: '#10b981'}} /> Multiple Task Billing - Select Group
                          </h3>
                          <p style={{margin: '8px 0 0', fontSize: '13px', color: '#64748b'}}>Select a group to view all clients with unbilled tasks</p>
                        </div>
                        
                        <div style={{background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', padding: '20px', borderRadius: '12px', marginBottom: '20px', border: '1px solid #86efac'}}>
                          <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#065f46'}}>ðŸ“‹ Select Group No.</h4>
                          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', alignItems: 'end'}}>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Group No. <span style={{color: '#dc2626'}}>*</span></label>
                              <div style={{position: 'relative'}}>
                                <input
                                  type="text"
                                  value={multipleTaskFilters.groupName}
                                  onChange={(e) => {
                                    const val = e.target.value;
                                    setMultipleTaskFilters({...multipleTaskFilters, groupName: val, clientName: '', clientCode: ''});
                                    setShowMultipleTaskGroupSuggestions(val.length >= 0);
                                  }}
                                  onFocus={() => setShowMultipleTaskGroupSuggestions(true)}
                                  onBlur={() => setTimeout(() => setShowMultipleTaskGroupSuggestions(false), 200)}
                                  placeholder="Type group no. (e.g., 1, 2, 3...)"
                                  style={{width: '100%', padding: '12px', border: '2px solid #86efac', borderRadius: '8px', fontSize: '14px', background: '#fff', fontWeight: '600'}}
                                />
                                {showMultipleTaskGroupSuggestions && (
                                  <div style={{position: 'absolute', top: '100%', left: 0, right: 0, background: '#fff', border: '2px solid #10b981', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 100, maxHeight: '250px', overflow: 'auto'}}>
                                    {[...new Set((data.clients || []).map(c => c.fileNo ? c.fileNo.split('.')[0] : '').filter(Boolean))]
                                      .filter(g => !multipleTaskFilters.groupName || g.includes(multipleTaskFilters.groupName))
                                      .sort((a, b) => parseInt(a) - parseInt(b))
                                      .slice(0, 15)
                                      .map(g => {
                                        const clientCount = (data.clients || []).filter(c => c.fileNo && c.fileNo.split('.')[0] === g).length;
                                        return (
                                          <div
                                            key={g}
                                            onClick={() => {
                                              setMultipleTaskFilters({...multipleTaskFilters, groupName: g, clientName: '', clientCode: ''});
                                              setShowMultipleTaskGroupSuggestions(false);
                                            }}
                                            style={{padding: '12px 16px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '13px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}
                                            onMouseEnter={(e) => e.currentTarget.style.background = '#f0fdf4'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                          >
                                            <span style={{fontWeight: '600', color: '#065f46'}}>Group {g}</span>
                                            <span style={{fontSize: '11px', color: '#64748b', background: '#f1f5f9', padding: '2px 8px', borderRadius: '10px'}}>{clientCount} clients</span>
                                          </div>
                                        );
                                      })}
                                    {[...new Set((data.clients || []).map(c => c.fileNo ? c.fileNo.split('.')[0] : '').filter(Boolean))]
                                      .filter(g => !multipleTaskFilters.groupName || g.includes(multipleTaskFilters.groupName)).length === 0 && (
                                      <div style={{padding: '16px', textAlign: 'center', color: '#64748b', fontSize: '13px'}}>
                                        No matching groups found.
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Invoice Type</label>
                              <select
                                value={multipleTaskFilters.invoiceType}
                                onChange={(e) => setMultipleTaskFilters({...multipleTaskFilters, invoiceType: e.target.value})}
                                style={{width: '100%', padding: '12px', border: '2px solid #86efac', borderRadius: '8px', fontSize: '14px', background: '#fff'}}
                              >
                                <option value="taskWise">Task Wise (Separate invoice per task)</option>
                                <option value="combined">Combined (All tasks in one invoice per client)</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        
                        <div style={{display: 'flex', gap: '12px'}}>
                          <button
                            onClick={() => {
                              if (!multipleTaskFilters.groupName) {
                                alert('Please select a group');
                                return;
                              }
                              // Clear all selections and move to client selection
                              setMultipleTaskSelectedClients([]);
                              setMultipleTaskSelectedTasks([]);
                              setMultipleTaskClientBilling([]);
                              setMultipleTaskBillingStep('clients');
                            }}
                            disabled={!multipleTaskFilters.groupName}
                            style={{
                              padding: '14px 32px',
                              background: multipleTaskFilters.groupName ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#e2e8f0',
                              color: multipleTaskFilters.groupName ? '#fff' : '#94a3b8',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: multipleTaskFilters.groupName ? 'pointer' : 'not-allowed',
                              fontSize: '14px',
                              fontWeight: '700',
                              boxShadow: multipleTaskFilters.groupName ? '0 2px 8px rgba(16,185,129,0.3)' : 'none'
                            }}
                          >
                            ðŸ” View Clients â†’
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {/* Step 2: Client Selection */}
                    {multipleTaskBillingStep === 'clients' && multipleTaskFilters.groupName && (
                      <div style={{background: '#fff', padding: '24px', borderRadius: '16px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                        {/* Header */}
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                          <div>
                            <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#065f46'}}>
                              Group {multipleTaskFilters.groupName} - Select Clients
                            </h3>
                            <p style={{margin: '4px 0 0', fontSize: '13px', color: '#64748b'}}>
                              Select clients to generate invoices for
                            </p>
                          </div>
                          <button
                            onClick={() => {
                              setMultipleTaskBillingStep('group');
                              setMultipleTaskSelectedClients([]);
                              setMultipleTaskSelectedTasks([]);
                            }}
                            style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            â† Back to Group Selection
                          </button>
                        </div>
                        
                        {/* Client List */}
                        {(() => {
                          const groupClients = (data.clients || []).filter(c => c.fileNo && c.fileNo.split('.')[0] === multipleTaskFilters.groupName);
                          const clientsWithTasks = groupClients.map(client => {
                            const unbilledTasks = (data.tasks || []).filter(t => 
                              (t.clientName === client.name || t.clientId === client.id || t.fileNo === client.fileNo) && 
                              !t.billed
                            );
                            const openTasks = unbilledTasks.filter(t => t.status !== 'Completed').length;
                            const completedTasks = unbilledTasks.filter(t => t.status === 'Completed').length;
                            return { client, unbilledTasks, openTasks, completedTasks, totalTasks: unbilledTasks.length };
                          }).filter(c => c.totalTasks > 0);
                          
                          if (clientsWithTasks.length === 0) {
                            return (
                              <div style={{textAlign: 'center', padding: '60px 20px', background: '#f8fafc', borderRadius: '12px', border: '2px dashed #e2e8f0'}}>
                                <div style={{fontSize: '48px', marginBottom: '16px'}}>ðŸ“‹</div>
                                <div style={{fontSize: '16px', fontWeight: '600', color: '#64748b', marginBottom: '8px'}}>No Unbilled Tasks</div>
                                <div style={{fontSize: '13px', color: '#94a3b8'}}>All tasks for clients in this group have been billed</div>
                              </div>
                            );
                          }
                          
                          const allSelected = clientsWithTasks.every(c => multipleTaskSelectedClients.some(sc => sc.id === c.client.id));
                          
                          return (
                            <div>
                              {/* Client Table */}
                              <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden'}}>
                                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                                  <thead>
                                    <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                      <th style={{padding: '14px 12px', textAlign: 'center', width: '50px'}}>
                                        <input
                                          type="checkbox"
                                          checked={allSelected}
                                          onChange={(e) => {
                                            if (e.target.checked) {
                                              setMultipleTaskSelectedClients(clientsWithTasks.map(c => c.client));
                                            } else {
                                              setMultipleTaskSelectedClients([]);
                                            }
                                          }}
                                          style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                        />
                                      </th>
                                      <th style={{padding: '14px 12px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Client Name</th>
                                      <th style={{padding: '14px 12px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Client Code</th>
                                      <th style={{padding: '14px 12px', textAlign: 'center', color: '#fff', fontWeight: '600'}}>Completed</th>
                                      <th style={{padding: '14px 12px', textAlign: 'center', color: '#fff', fontWeight: '600'}}>Open</th>
                                      <th style={{padding: '14px 12px', textAlign: 'center', color: '#fff', fontWeight: '600'}}>Total Tasks</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {clientsWithTasks.map(({ client, openTasks, completedTasks, totalTasks }, idx) => {
                                      const isSelected = multipleTaskSelectedClients.some(sc => sc.id === client.id);
                                      return (
                                        <tr 
                                          key={client.id}
                                          onClick={() => {
                                            if (isSelected) {
                                              setMultipleTaskSelectedClients(prev => prev.filter(c => c.id !== client.id));
                                            } else {
                                              setMultipleTaskSelectedClients(prev => [...prev, client]);
                                            }
                                          }}
                                          style={{
                                            borderBottom: '1px solid #e2e8f0', 
                                            background: isSelected ? '#f0fdf4' : (idx % 2 === 0 ? '#fff' : '#f8fafc'),
                                            cursor: 'pointer',
                                            transition: 'background 0.15s ease'
                                          }}
                                          onMouseEnter={(e) => { if (!isSelected) e.currentTarget.style.background = '#f0fdf4'; }}
                                          onMouseLeave={(e) => { if (!isSelected) e.currentTarget.style.background = idx % 2 === 0 ? '#fff' : '#f8fafc'; }}
                                        >
                                          <td style={{padding: '12px', textAlign: 'center'}}>
                                            <input
                                              type="checkbox"
                                              checked={isSelected}
                                              onChange={() => {}}
                                              style={{width: '16px', height: '16px', cursor: 'pointer'}}
                                            />
                                          </td>
                                          <td style={{padding: '12px', fontWeight: '600', color: '#1e293b'}}>{client.name}</td>
                                          <td style={{padding: '12px', color: '#64748b'}}>{client.fileNo}</td>
                                          <td style={{padding: '12px', textAlign: 'center'}}>
                                            <span style={{padding: '4px 12px', background: '#dcfce7', color: '#166534', borderRadius: '12px', fontWeight: '600', fontSize: '12px'}}>{completedTasks}</span>
                                          </td>
                                          <td style={{padding: '12px', textAlign: 'center'}}>
                                            <span style={{padding: '4px 12px', background: '#fef3c7', color: '#92400e', borderRadius: '12px', fontWeight: '600', fontSize: '12px'}}>{openTasks}</span>
                                          </td>
                                          <td style={{padding: '12px', textAlign: 'center'}}>
                                            <span style={{padding: '4px 12px', background: '#e0f2fe', color: '#0369a1', borderRadius: '12px', fontWeight: '600', fontSize: '12px'}}>{totalTasks}</span>
                                          </td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                </table>
                              </div>
                              
                              {/* Selection Summary */}
                              <div style={{marginTop: '12px', fontSize: '12px', color: '#64748b', textAlign: 'right'}}>
                                {multipleTaskSelectedClients.length} of {clientsWithTasks.length} clients selected
                              </div>
                              
                              {/* Proceed Button */}
                              {multipleTaskSelectedClients.length > 0 && (
                                <div style={{position: 'sticky', bottom: 0, background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', padding: '16px 24px', borderRadius: '12px', marginTop: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', color: '#fff', boxShadow: '0 -4px 20px rgba(16,185,129,0.3)'}}>
                                  <div>
                                    <span style={{fontSize: '15px', fontWeight: '600'}}>{multipleTaskSelectedClients.length} client(s) selected</span>
                                    <span style={{fontSize: '13px', marginLeft: '16px', opacity: 0.9}}>
                                      {clientsWithTasks.filter(c => multipleTaskSelectedClients.some(sc => sc.id === c.client.id)).reduce((sum, c) => sum + c.totalTasks, 0)} total unbilled tasks
                                    </span>
                                  </div>
                                  <button
                                    onClick={() => {
                                      setMultipleTaskBillingStep('tasks');
                                    }}
                                    style={{padding: '12px 28px', background: '#fff', color: '#10b981', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 2px 8px rgba(0,0,0,0.15)'}}
                                  >
                                    Select Tasks â†’
                                  </button>
                                </div>
                              )}
                            </div>
                          );
                        })()}
                      </div>
                    )}
                    
                    {/* Step 3: Task Selection - Grouped by Client */}
                    {(multipleTaskBillingStep === 'tasks' || multipleTaskBillingStep === 'billing') && multipleTaskFilters.groupName && (
                      <div style={{background: '#fff', padding: '24px', borderRadius: '16px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                        {/* Header */}
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                          <div>
                            <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#065f46'}}>
                              {multipleTaskBillingStep === 'billing' ? 'ðŸ“‹ Generate Invoices' : 'Select Tasks'} - Group {multipleTaskFilters.groupName}
                            </h3>
                            <p style={{margin: '4px 0 0', fontSize: '13px', color: '#64748b'}}>
                              {multipleTaskSelectedClients.length} client(s) selected | 
                              <span style={{marginLeft: '8px', padding: '2px 8px', borderRadius: '4px', background: multipleTaskFilters.invoiceType === 'taskWise' ? '#fef3c7' : '#dbeafe', color: multipleTaskFilters.invoiceType === 'taskWise' ? '#92400e' : '#1e40af', fontWeight: '600', fontSize: '11px'}}>
                                {multipleTaskFilters.invoiceType === 'taskWise' ? 'Task Wise' : 'Combined'}
                              </span>
                            </p>
                          </div>
                          <button
                            onClick={() => {
                              // Clear selections and go back to client selection
                              setMultipleTaskSelectedTasks([]);
                              setMultipleTaskClientBilling([]);
                              setMultipleTaskBillingStep('clients');
                            }}
                            style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                          >
                            â† Back to Client Selection
                          </button>
                        </div>
                        
                        {/* Tasks grouped by Client - Only show selected clients */}
                        {(() => {
                          // Only show clients that were selected in the previous step
                          const selectedClientIds = multipleTaskSelectedClients.map(c => c.id);
                          const groupClients = multipleTaskSelectedClients;
                          const clientTasks = {};
                          
                          groupClients.forEach(client => {
                            const tasks = (data.tasks || []).filter(t => 
                              (t.clientName === client.name || t.clientId === client.id || t.fileNo === client.fileNo) && 
                              !t.billed
                            );
                            if (tasks.length > 0) {
                              const key = `${client.name}|${client.fileNo}`;
                              clientTasks[key] = { client, tasks };
                            }
                          });
                          
                          if (Object.keys(clientTasks).length === 0) {
                            return (
                              <div style={{textAlign: 'center', padding: '60px 20px', background: '#f8fafc', borderRadius: '12px', border: '2px dashed #e2e8f0'}}>
                                <div style={{fontSize: '48px', marginBottom: '16px'}}>ðŸ“‹</div>
                                <div style={{fontSize: '16px', fontWeight: '600', color: '#64748b', marginBottom: '8px'}}>No Unbilled Tasks</div>
                                <div style={{fontSize: '13px', color: '#94a3b8'}}>All tasks for selected clients have been billed</div>
                              </div>
                            );
                          }
                          
                          return Object.entries(clientTasks).map(([key, { client, tasks }]) => {
                            // Check if this client has selected tasks
                            const clientSelectedTasks = multipleTaskSelectedTasks.filter(st => 
                              tasks.some(t => t.id === st.id)
                            );
                            const hasSelectedTasks = clientSelectedTasks.length > 0;
                            
                            // Get billing data for this client if in billing mode
                            const clientBillingData = multipleTaskClientBilling.find(cb => cb.clientName === client.name);
                            const showBillingForm = multipleTaskBillingStep === 'billing' && clientBillingData;
                            
                            // Calculate totals for this client if billing
                            let clientTotal = 0;
                            let clientGst = 0;
                            let clientGrandTotal = 0;
                            if (showBillingForm) {
                              const org = (data.organizations || []).find(o => String(o.id) === String(clientBillingData.organizationId));
                              if (multipleTaskFilters.invoiceType === 'taskWise') {
                                clientBillingData.tasks.forEach(task => {
                                  const net = (parseFloat(task.amount) || 0) - (parseFloat(task.discount) || 0);
                                  clientTotal += net;
                                });
                              } else {
                                clientTotal = (parseFloat(clientBillingData.combinedAmount) || 0) - (parseFloat(clientBillingData.combinedDiscount) || 0);
                                (clientBillingData.extraNarrations || []).forEach(extra => {
                                  clientTotal += (parseFloat(extra.amount) || 0) - (parseFloat(extra.discount) || 0);
                                });
                              }
                              if (org?.gstApplicable === 'yes' && clientTotal > 0) {
                                clientGst = Math.round(clientTotal * 0.18 * 100) / 100;
                              }
                              clientGrandTotal = clientTotal + clientGst;
                            }
                            
                            return (
                              <div key={key} style={{marginBottom: '20px', background: '#fff', borderRadius: '12px', overflow: 'hidden', border: showBillingForm ? '2px solid #10b981' : '1px solid #e2e8f0', boxShadow: showBillingForm ? '0 4px 12px rgba(16,185,129,0.15)' : 'none'}}>
                                {/* Client Header - Green Theme */}
                                <div style={{padding: '14px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                  <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                    <input
                                      type="checkbox"
                                      checked={tasks.every(t => multipleTaskSelectedTasks.some(st => st.id === t.id))}
                                      onChange={(e) => {
                                        if (e.target.checked) {
                                          setMultipleTaskSelectedTasks(prev => [...prev.filter(t => !tasks.some(ct => ct.id === t.id)), ...tasks]);
                                        } else {
                                          setMultipleTaskSelectedTasks(prev => prev.filter(t => !tasks.some(ct => ct.id === t.id)));
                                        }
                                      }}
                                      disabled={multipleTaskBillingStep === 'billing'}
                                      style={{width: '18px', height: '18px', cursor: multipleTaskBillingStep === 'billing' ? 'not-allowed' : 'pointer', accentColor: '#fff'}}
                                    />
                                    <div>
                                      <div style={{fontWeight: '700', fontSize: '15px', color: '#fff'}}>{client.name}</div>
                                      <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.85)'}}>Code: {client.fileNo}</div>
                                    </div>
                                  </div>
                                  <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                    {showBillingForm && (
                                      <div style={{textAlign: 'right', marginRight: '8px'}}>
                                        <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.7)'}}>Invoice Total</div>
                                        <div style={{fontSize: '18px', fontWeight: '700', color: '#fff'}}>â‚¹{clientGrandTotal.toLocaleString('en-IN')}</div>
                                      </div>
                                    )}
                                    <span style={{background: 'rgba(255,255,255,0.2)', color: '#fff', padding: '6px 14px', borderRadius: '20px', fontSize: '12px', fontWeight: '600', border: '1px solid rgba(255,255,255,0.3)'}}>
                                      {hasSelectedTasks ? `${clientSelectedTasks.length} selected` : `${tasks.length} task${tasks.length > 1 ? 's' : ''}`}
                                    </span>
                                  </div>
                                </div>
                                
                                {/* Tasks Table */}
                                <div style={{overflowX: 'auto'}}>
                                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px', minWidth: '700px'}}>
                                    <thead>
                                      <tr style={{background: '#f0fdf4'}}>
                                        <th style={{padding: '10px 12px', textAlign: 'center', width: '40px', borderBottom: '2px solid #d1fae5'}}></th>
                                        <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Task Type</th>
                                        <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Task Description</th>
                                        <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>FY</th>
                                        <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Period</th>
                                        <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Status</th>
                                        <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Agreed Fees</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {tasks.map((task, i) => (
                                        <tr key={task.id} style={{borderBottom: '1px solid #e2e8f0', background: multipleTaskSelectedTasks.some(t => t.id === task.id) ? '#f0fdf4' : (i % 2 === 0 ? '#fff' : '#fafafa')}}>
                                          <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                            <input
                                              type="checkbox"
                                              checked={multipleTaskSelectedTasks.some(t => t.id === task.id)}
                                              onChange={(e) => {
                                                if (e.target.checked) {
                                                  setMultipleTaskSelectedTasks(prev => [...prev, task]);
                                                } else {
                                                  setMultipleTaskSelectedTasks(prev => prev.filter(t => t.id !== task.id));
                                                }
                                              }}
                                              disabled={multipleTaskBillingStep === 'billing'}
                                              style={{cursor: multipleTaskBillingStep === 'billing' ? 'not-allowed' : 'pointer'}}
                                            />
                                          </td>
                                          <td style={{padding: '10px 12px'}}>
                                            <div style={{fontWeight: '600', color: '#1e293b'}}>{task.childTask}</div>
                                            <div style={{fontSize: '11px', color: '#64748b'}}>{task.parentTask}</div>
                                          </td>
                                          <td style={{padding: '10px 12px', color: '#64748b', fontSize: '11px', maxWidth: '150px'}}>
                                            {task.taskDescription || '-'}
                                          </td>
                                          <td style={{padding: '10px 12px', fontSize: '11px'}}>{task.financialYear || '-'}</td>
                                          <td style={{padding: '10px 12px', fontSize: '11px'}}>{task.period || '-'} {task.subPeriod ? `(${task.subPeriod})` : ''}</td>
                                          <td style={{padding: '10px 12px'}}>
                                            <span style={{
                                              padding: '3px 8px',
                                              borderRadius: '12px',
                                              fontSize: '10px',
                                              fontWeight: '600',
                                              background: task.status === 'Completed' ? '#dcfce7' : task.status === 'In Progress' ? '#fef3c7' : '#fee2e2',
                                              color: task.status === 'Completed' ? '#166534' : task.status === 'In Progress' ? '#92400e' : '#991b1b'
                                            }}>
                                              {task.status}
                                            </span>
                                          </td>
                                          <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#10b981'}}>
                                            â‚¹{(parseFloat(task.agreedFees) || 0).toLocaleString('en-IN')}
                                          </td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                                
                                {/* Inline Billing Form - Shows when in billing mode */}
                                {showBillingForm && (
                                  <div style={{borderTop: '2px solid #10b981', padding: '20px', background: '#f8fafc'}}>
                                    {/* Organization Selector */}
                                    <div style={{marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '16px'}}>
                                      <div style={{flex: 1, maxWidth: '300px'}}>
                                        <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Organisation *</label>
                                        <select
                                          value={clientBillingData.organizationId}
                                          onChange={(e) => {
                                            const updated = multipleTaskClientBilling.map(cb => 
                                              cb.clientName === client.name ? {...cb, organizationId: e.target.value} : cb
                                            );
                                            setMultipleTaskClientBilling(updated);
                                          }}
                                          style={{width: '100%', padding: '10px 12px', border: '2px solid #10b981', borderRadius: '8px', fontSize: '13px', background: '#fff', fontWeight: '500'}}
                                        >
                                          <option value="">Select Organisation</option>
                                          {(data.organizations || []).map(o => (
                                            <option key={o.id} value={o.id}>{o.name}</option>
                                          ))}
                                        </select>
                                      </div>
                                      <div style={{background: '#dcfce7', padding: '12px 20px', borderRadius: '8px', marginLeft: 'auto'}}>
                                        <div style={{fontSize: '10px', color: '#065f46'}}>Invoice Total</div>
                                        <div style={{fontSize: '18px', fontWeight: '700', color: '#166534'}}>â‚¹{clientGrandTotal.toLocaleString('en-IN')}</div>
                                      </div>
                                    </div>
                                    
                                    {/* Task Wise Mode */}
                                    {multipleTaskFilters.invoiceType === 'taskWise' && (
                                      <div style={{background: '#fff', borderRadius: '8px', border: '1px solid #d1fae5', overflow: 'hidden'}}>
                                        <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                          <thead>
                                            <tr style={{background: '#f0fdf4'}}>
                                              <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Task</th>
                                              <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Description</th>
                                              <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5', minWidth: '200px'}}>Narration</th>
                                              <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5'}}>Agreed</th>
                                              <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5', width: '100px'}}>Amount</th>
                                              <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5', width: '90px'}}>Discount</th>
                                              <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', color: '#065f46', borderBottom: '2px solid #d1fae5', width: '100px'}}>Net</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {clientBillingData.tasks.map((task, taskIdx) => {
                                              const taskNet = (parseFloat(task.amount) || 0) - (parseFloat(task.discount) || 0);
                                              return (
                                                <tr key={taskIdx} style={{borderBottom: '1px solid #e2e8f0', background: taskIdx % 2 === 0 ? '#fff' : '#f8fafc'}}>
                                                  <td style={{padding: '12px'}}>
                                                    <div style={{fontWeight: '600', color: '#1e293b'}}>{task.taskType}</div>
                                                    <div style={{fontSize: '10px', color: '#64748b'}}>{task.period} {task.subPeriod}</div>
                                                  </td>
                                                  <td style={{padding: '12px', color: '#64748b', fontSize: '11px'}}>{task.taskDescription || '-'}</td>
                                                  <td style={{padding: '12px'}}>
                                                    <input
                                                      type="text"
                                                      value={task.narration}
                                                      onChange={(e) => {
                                                        const updated = multipleTaskClientBilling.map(cb => {
                                                          if (cb.clientName === client.name) {
                                                            const newTasks = [...cb.tasks];
                                                            newTasks[taskIdx] = {...newTasks[taskIdx], narration: e.target.value};
                                                            return {...cb, tasks: newTasks};
                                                          }
                                                          return cb;
                                                        });
                                                        setMultipleTaskClientBilling(updated);
                                                      }}
                                                      style={{width: '100%', padding: '8px 10px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '11px', background: '#f0fdf4'}}
                                                    />
                                                  </td>
                                                  <td style={{padding: '12px', textAlign: 'right', color: '#64748b', fontSize: '11px'}}>â‚¹{(task.agreedFees || 0).toLocaleString('en-IN')}</td>
                                                  <td style={{padding: '12px', textAlign: 'right'}}>
                                                    <input
                                                      type="number"
                                                      value={task.amount}
                                                      onChange={(e) => {
                                                        const updated = multipleTaskClientBilling.map(cb => {
                                                          if (cb.clientName === client.name) {
                                                            const newTasks = [...cb.tasks];
                                                            newTasks[taskIdx] = {...newTasks[taskIdx], amount: parseFloat(e.target.value) || 0};
                                                            return {...cb, tasks: newTasks};
                                                          }
                                                          return cb;
                                                        });
                                                        setMultipleTaskClientBilling(updated);
                                                      }}
                                                      style={{width: '100%', padding: '8px', border: '1px solid #d1fae5', borderRadius: '6px', textAlign: 'right', fontSize: '11px', background: '#f0fdf4'}}
                                                    />
                                                  </td>
                                                  <td style={{padding: '12px', textAlign: 'right'}}>
                                                    <input
                                                      type="number"
                                                      value={task.discount}
                                                      onChange={(e) => {
                                                        const updated = multipleTaskClientBilling.map(cb => {
                                                          if (cb.clientName === client.name) {
                                                            const newTasks = [...cb.tasks];
                                                            newTasks[taskIdx] = {...newTasks[taskIdx], discount: parseFloat(e.target.value) || 0};
                                                            return {...cb, tasks: newTasks};
                                                          }
                                                          return cb;
                                                        });
                                                        setMultipleTaskClientBilling(updated);
                                                      }}
                                                      style={{width: '100%', padding: '8px', border: '1px solid #d1fae5', borderRadius: '6px', textAlign: 'right', fontSize: '11px', background: '#f0fdf4'}}
                                                    />
                                                  </td>
                                                  <td style={{padding: '12px', textAlign: 'right', fontWeight: '700', color: '#10b981', fontSize: '13px'}}>â‚¹{taskNet.toLocaleString('en-IN')}</td>
                                                </tr>
                                              );
                                            })}
                                          </tbody>
                                        </table>
                                      </div>
                                    )}
                                    
                                    {/* Combined Mode */}
                                    {multipleTaskFilters.invoiceType === 'combined' && (
                                      <div>
                                        {/* Combined Tasks Info */}
                                        <div style={{fontSize: '11px', color: '#64748b', marginBottom: '12px', padding: '10px 14px', background: '#fff', borderRadius: '6px', borderLeft: '4px solid #10b981'}}>
                                          <strong>Combined Tasks:</strong> {clientBillingData.tasks.map(t => t.taskType).join(', ')}
                                          <span style={{display: 'block', marginTop: '4px'}}><strong>Descriptions:</strong> {clientBillingData.tasks.map(t => t.taskDescription || t.taskType).join('; ')}</span>
                                        </div>
                                        
                                        {/* Main Narration Row */}
                                        <div style={{background: '#fff', padding: '16px', borderRadius: '8px', marginBottom: '12px', border: '1px solid #d1fae5'}}>
                                          <div style={{display: 'grid', gridTemplateColumns: '1fr 140px 120px 120px', gap: '16px', alignItems: 'end'}}>
                                            <div>
                                              <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Narration</label>
                                              <input
                                                type="text"
                                                value={clientBillingData.combinedNarration}
                                                onChange={(e) => {
                                                  const updated = multipleTaskClientBilling.map(cb => 
                                                    cb.clientName === client.name ? {...cb, combinedNarration: e.target.value} : cb
                                                  );
                                                  setMultipleTaskClientBilling(updated);
                                                }}
                                                style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', background: '#f0fdf4'}}
                                              />
                                            </div>
                                            <div>
                                              <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Amount</label>
                                              <input
                                                type="number"
                                                value={clientBillingData.combinedAmount}
                                                onChange={(e) => {
                                                  const updated = multipleTaskClientBilling.map(cb => 
                                                    cb.clientName === client.name ? {...cb, combinedAmount: parseFloat(e.target.value) || 0} : cb
                                                  );
                                                  setMultipleTaskClientBilling(updated);
                                                }}
                                                style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', textAlign: 'right', background: '#f0fdf4'}}
                                              />
                                            </div>
                                            <div>
                                              <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Discount</label>
                                              <input
                                                type="number"
                                                value={clientBillingData.combinedDiscount}
                                                onChange={(e) => {
                                                  const updated = multipleTaskClientBilling.map(cb => 
                                                    cb.clientName === client.name ? {...cb, combinedDiscount: parseFloat(e.target.value) || 0} : cb
                                                  );
                                                  setMultipleTaskClientBilling(updated);
                                                }}
                                                style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', textAlign: 'right', background: '#f0fdf4'}}
                                              />
                                            </div>
                                            <div>
                                              <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Net</label>
                                              <div style={{padding: '10px 12px', background: '#dcfce7', borderRadius: '6px', textAlign: 'right', fontWeight: '700', color: '#166534', fontSize: '13px'}}>
                                                â‚¹{((clientBillingData.combinedAmount || 0) - (clientBillingData.combinedDiscount || 0)).toLocaleString('en-IN')}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        {/* Extra Narrations - Same format as main */}
                                        {(clientBillingData.extraNarrations || []).map((extra, extraIdx) => (
                                          <div key={extraIdx} style={{background: '#fff', padding: '16px', borderRadius: '8px', marginBottom: '12px', border: '1px solid #d1fae5'}}>
                                            <div style={{display: 'grid', gridTemplateColumns: '1fr 140px 120px 120px 50px', gap: '16px', alignItems: 'end'}}>
                                              <div>
                                                <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Extra Narration {extraIdx + 1}</label>
                                                <input
                                                  type="text"
                                                  value={extra.narration || ''}
                                                  onChange={(e) => {
                                                    const updated = multipleTaskClientBilling.map(cb => {
                                                      if (cb.clientName === client.name) {
                                                        const newExtras = [...(cb.extraNarrations || [])];
                                                        newExtras[extraIdx] = {...newExtras[extraIdx], narration: e.target.value};
                                                        return {...cb, extraNarrations: newExtras};
                                                      }
                                                      return cb;
                                                    });
                                                    setMultipleTaskClientBilling(updated);
                                                  }}
                                                  placeholder="Enter narration"
                                                  style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', background: '#f0fdf4'}}
                                                />
                                              </div>
                                              <div>
                                                <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Amount</label>
                                                <input
                                                  type="number"
                                                  value={extra.amount || 0}
                                                  onChange={(e) => {
                                                    const updated = multipleTaskClientBilling.map(cb => {
                                                      if (cb.clientName === client.name) {
                                                        const newExtras = [...(cb.extraNarrations || [])];
                                                        newExtras[extraIdx] = {...newExtras[extraIdx], amount: parseFloat(e.target.value) || 0};
                                                        return {...cb, extraNarrations: newExtras};
                                                      }
                                                      return cb;
                                                    });
                                                    setMultipleTaskClientBilling(updated);
                                                  }}
                                                  style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', textAlign: 'right', background: '#f0fdf4'}}
                                                />
                                              </div>
                                              <div>
                                                <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Discount</label>
                                                <input
                                                  type="number"
                                                  value={extra.discount || 0}
                                                  onChange={(e) => {
                                                    const updated = multipleTaskClientBilling.map(cb => {
                                                      if (cb.clientName === client.name) {
                                                        const newExtras = [...(cb.extraNarrations || [])];
                                                        newExtras[extraIdx] = {...newExtras[extraIdx], discount: parseFloat(e.target.value) || 0};
                                                        return {...cb, extraNarrations: newExtras};
                                                      }
                                                      return cb;
                                                    });
                                                    setMultipleTaskClientBilling(updated);
                                                  }}
                                                  style={{width: '100%', padding: '10px 12px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', textAlign: 'right', background: '#f0fdf4'}}
                                                />
                                              </div>
                                              <div>
                                                <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Net</label>
                                                <div style={{padding: '10px 12px', background: '#dcfce7', borderRadius: '6px', textAlign: 'right', fontWeight: '700', color: '#166534', fontSize: '13px'}}>
                                                  â‚¹{((extra.amount || 0) - (extra.discount || 0)).toLocaleString('en-IN')}
                                                </div>
                                              </div>
                                              <div>
                                                <label style={{display: 'block', fontSize: '11px', marginBottom: '6px', color: 'transparent'}}>X</label>
                                                <button
                                                  onClick={() => {
                                                    const updated = multipleTaskClientBilling.map(cb => {
                                                      if (cb.clientName === client.name) {
                                                        const newExtras = [...(cb.extraNarrations || [])];
                                                        newExtras.splice(extraIdx, 1);
                                                        return {...cb, extraNarrations: newExtras};
                                                      }
                                                      return cb;
                                                    });
                                                    setMultipleTaskClientBilling(updated);
                                                  }}
                                                  style={{width: '100%', padding: '10px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '14px', fontWeight: '600'}}
                                                >
                                                  âœ•
                                                </button>
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                        
                                        {/* Add Extra Narration Button */}
                                        <button
                                          onClick={() => {
                                            const updated = multipleTaskClientBilling.map(cb => {
                                              if (cb.clientName === client.name) {
                                                return {...cb, extraNarrations: [...(cb.extraNarrations || []), {narration: '', amount: 0, discount: 0}]};
                                              }
                                              return cb;
                                            });
                                            setMultipleTaskClientBilling(updated);
                                          }}
                                          style={{padding: '10px 20px', background: '#f0fdf4', color: '#10b981', border: '2px dashed #10b981', borderRadius: '8px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                                        >
                                          + Add Extra Narration
                                        </button>
                                      </div>
                                    )}
                                    
                                    {/* Client Total Summary */}
                                    <div style={{marginTop: '16px', padding: '12px 16px', background: '#dcfce7', borderRadius: '8px', display: 'flex', justifyContent: 'flex-end', gap: '24px'}}>
                                      <div style={{textAlign: 'right'}}>
                                        <div style={{fontSize: '10px', color: '#065f46'}}>Subtotal</div>
                                        <div style={{fontWeight: '600', color: '#166534'}}>â‚¹{clientTotal.toLocaleString('en-IN')}</div>
                                      </div>
                                      <div style={{textAlign: 'right'}}>
                                        <div style={{fontSize: '10px', color: '#065f46'}}>GST (18%)</div>
                                        <div style={{fontWeight: '600', color: '#166534'}}>â‚¹{clientGst.toLocaleString('en-IN')}</div>
                                      </div>
                                      <div style={{textAlign: 'right', background: '#10b981', padding: '8px 16px', borderRadius: '6px', marginLeft: '8px'}}>
                                        <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.8)'}}>Total</div>
                                        <div style={{fontWeight: '700', fontSize: '16px', color: '#fff'}}>â‚¹{clientGrandTotal.toLocaleString('en-IN')}</div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          });
                        })()}
                        
                        {/* Summary Bar - Different modes for tasks vs billing */}
                        {multipleTaskSelectedTasks.length > 0 && (
                          <div style={{position: 'sticky', bottom: 0, background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', padding: '16px 24px', borderRadius: '12px', marginTop: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', color: '#fff', boxShadow: '0 -4px 20px rgba(16,185,129,0.3)'}}>
                            {multipleTaskBillingStep === 'tasks' ? (
                              <>
                                <div>
                                  <span style={{fontSize: '15px', fontWeight: '600'}}>{multipleTaskSelectedTasks.length} tasks selected</span>
                                  <span style={{fontSize: '13px', marginLeft: '16px', opacity: 0.9}}>
                                    from {[...new Set(multipleTaskSelectedTasks.map(t => t.clientName))].length} client(s)
                                  </span>
                                </div>
                                <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                                  <div style={{fontSize: '18px', fontWeight: '700'}}>
                                    â‚¹{multipleTaskSelectedTasks.reduce((sum, t) => sum + (parseFloat(t.agreedFees) || 0), 0).toLocaleString('en-IN')}
                                  </div>
                                  <button
                                    onClick={() => {
                                      // Prepare billing data grouped by client
                                      const clientGroups = {};
                                      multipleTaskSelectedTasks.forEach(task => {
                                        const clientKey = task.clientName || task.clientId;
                                        if (!clientGroups[clientKey]) {
                                          const client = (data.clients || []).find(c => c.name === task.clientName || c.id === task.clientId);
                                          clientGroups[clientKey] = {
                                            clientId: client?.id || task.clientId,
                                            clientName: task.clientName,
                                            clientCode: task.fileNo || client?.fileNo || '',
                                            clientAddress: client?.address || '',
                                            clientGstin: client?.gstin || '',
                                            clientState: client?.state || '',
                                            organizationId: multipleTaskOrgId || '',
                                            tasks: []
                                          };
                                        }
                                        clientGroups[clientKey].tasks.push({
                                          taskId: task.id,
                                          parentTask: task.parentTask || '',
                                          taskType: task.childTask || '',
                                          taskDescription: task.taskDescription || task.childTask || '',
                                          financialYear: task.financialYear || '',
                                          period: task.period || '',
                                          subPeriod: task.subPeriod || '',
                                          agreedFees: parseFloat(task.agreedFees) || 0,
                                          amount: parseFloat(task.agreedFees) || 0,
                                          discount: 0,
                                          narration: `${task.parentTask || ''} - ${task.childTask || ''}`.trim().replace(/^- /, ''),
                                          sacCode: '998231',
                                          remark: ''
                                        });
                                      });
                                      
                                      const billingData = Object.values(clientGroups).map(client => ({
                                        ...client,
                                        combinedAmount: client.tasks.reduce((sum, t) => sum + t.amount, 0),
                                        combinedDiscount: 0,
                                        combinedNarration: client.tasks.map(t => t.narration).join('; '),
                                        extraNarrations: []
                                      }));
                                      
                                      setMultipleTaskClientBilling(billingData);
                                      setMultipleTaskBillingStep('billing');
                                    }}
                                    style={{padding: '12px 28px', background: '#fff', color: '#10b981', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 2px 8px rgba(0,0,0,0.15)'}}
                                  >
                                    Proceed to Billing â†’
                                  </button>
                                </div>
                              </>
                            ) : (
                              <>
                                <div>
                                  <div style={{fontSize: '11px', opacity: 0.8, marginBottom: '2px'}}>Invoice Date</div>
                                  <input
                                    type="date"
                                    value={multipleTaskInvoiceDate}
                                    onChange={(e) => setMultipleTaskInvoiceDate(e.target.value)}
                                    style={{padding: '8px 12px', border: 'none', borderRadius: '6px', fontSize: '13px', background: 'rgba(255,255,255,0.95)', fontWeight: '500'}}
                                  />
                                </div>
                                <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                                  <div style={{textAlign: 'right'}}>
                                    <div style={{fontSize: '11px', opacity: 0.8}}>Grand Total ({multipleTaskClientBilling.length} invoices)</div>
                                    <div style={{fontSize: '24px', fontWeight: '700'}}>
                                      â‚¹{multipleTaskClientBilling.reduce((sum, client) => {
                                        const org = (data.organizations || []).find(o => String(o.id) === String(client.organizationId));
                                        let clientTotal = 0;
                                        if (multipleTaskFilters.invoiceType === 'taskWise') {
                                          client.tasks.forEach(task => {
                                            clientTotal += (parseFloat(task.amount) || 0) - (parseFloat(task.discount) || 0);
                                          });
                                        } else {
                                          clientTotal = (parseFloat(client.combinedAmount) || 0) - (parseFloat(client.combinedDiscount) || 0);
                                          (client.extraNarrations || []).forEach(extra => {
                                            clientTotal += (parseFloat(extra.amount) || 0) - (parseFloat(extra.discount) || 0);
                                          });
                                        }
                                        const gst = org?.gstApplicable === 'yes' && clientTotal > 0 ? Math.round(clientTotal * 0.18 * 100) / 100 : 0;
                                        return sum + clientTotal + gst;
                                      }, 0).toLocaleString('en-IN')}
                                    </div>
                                  </div>
                                  <div style={{display: 'flex', gap: '10px'}}>
                                    <button
                                      onClick={() => {
                                        setMultipleTaskBillingStep('tasks');
                                        setMultipleTaskClientBilling([]);
                                      }}
                                      style={{padding: '12px 20px', background: 'rgba(255,255,255,0.2)', color: '#fff', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                                    >
                                      â† Back
                                    </button>
                                    <button
                                      onClick={() => {
                                        // Validate organizations
                                        const missingOrg = multipleTaskClientBilling.filter(c => !c.organizationId);
                                        if (missingOrg.length > 0) {
                                          alert(`Please select organization for:\n${missingOrg.map(c => 'â€¢ ' + c.clientName).join('\n')}`);
                                          return;
                                        }
                                        
                                        if (!multipleTaskInvoiceDate) {
                                          alert('Please select invoice date');
                                          return;
                                        }
                                        
                                        // Generate invoices
                                        const newInvoices = [];
                                        const taskUpdates = {};
                                        const counters = {};
                                        
                                        multipleTaskClientBilling.forEach((clientData, clientIdx) => {
                                          const org = (data.organizations || []).find(o => String(o.id) === String(clientData.organizationId));
                                          if (!org) return;
                                          
                                          if (!counters[org.id]) {
                                            const lastInv = (data.invoices || [])
                                              .filter(i => String(i.organizationId) === String(org.id))
                                              .sort((a, b) => (b.invoiceCurrentNo || 0) - (a.invoiceCurrentNo || 0))[0];
                                            counters[org.id] = (lastInv?.invoiceCurrentNo || org.invoiceStartNo || 0) + 1;
                                          }
                                          const invoiceCurrentNo = counters[org.id]++;
                                          const invoiceNo = `${org.invoicePrefix || 'INV'}${String(invoiceCurrentNo).padStart(org.invoiceDigits || 4, '0')}${org.invoiceSuffix || ''}`;
                                          
                                          let netAmount = 0;
                                          let lineItems = [];
                                          const taskIds = clientData.tasks.map(t => t.taskId);
                                          
                                          if (multipleTaskFilters.invoiceType === 'taskWise') {
                                            clientData.tasks.forEach(task => {
                                              const taskNet = (parseFloat(task.amount) || 0) - (parseFloat(task.discount) || 0);
                                              netAmount += taskNet;
                                              lineItems.push({
                                                description: task.narration,
                                                amount: parseFloat(task.amount) || 0,
                                                discount: parseFloat(task.discount) || 0,
                                                netAmount: taskNet,
                                                taskId: task.taskId
                                              });
                                            });
                                          } else {
                                            const combinedNet = (parseFloat(clientData.combinedAmount) || 0) - (parseFloat(clientData.combinedDiscount) || 0);
                                            netAmount = combinedNet;
                                            lineItems.push({
                                              description: clientData.combinedNarration,
                                              amount: parseFloat(clientData.combinedAmount) || 0,
                                              discount: parseFloat(clientData.combinedDiscount) || 0,
                                              netAmount: combinedNet,
                                              taskIds: taskIds
                                            });
                                            (clientData.extraNarrations || []).forEach(extra => {
                                              const extraNet = (parseFloat(extra.amount) || 0) - (parseFloat(extra.discount) || 0);
                                              netAmount += extraNet;
                                              lineItems.push({
                                                description: extra.narration,
                                                amount: parseFloat(extra.amount) || 0,
                                                discount: parseFloat(extra.discount) || 0,
                                                netAmount: extraNet
                                              });
                                            });
                                          }
                                          
                                          let cgst = 0, sgst = 0, igst = 0;
                                          const gstApplicable = org.gstApplicable === 'yes';
                                          if (gstApplicable && netAmount > 0) {
                                            const orgState = (org.state || '').toLowerCase();
                                            const clientState = (clientData.clientState || '').toLowerCase();
                                            if (orgState && clientState && orgState === clientState) {
                                              cgst = Math.round(netAmount * 0.09 * 100) / 100;
                                              sgst = Math.round(netAmount * 0.09 * 100) / 100;
                                            } else {
                                              igst = Math.round(netAmount * 0.18 * 100) / 100;
                                            }
                                          }
                                          const totalAmount = netAmount + cgst + sgst + igst;
                                          
                                          const newInvoice = {
                                            id: Date.now().toString() + '-' + clientIdx,
                                            invoiceNo,
                                            invoiceCurrentNo,
                                            invoiceDate: multipleTaskInvoiceDate,
                                            organizationId: org.id,
                                            orgName: org.name,
                                            organizationName: org.name,
                                            orgAddress: org.address,
                                            orgGstin: org.gstin,
                                            orgState: org.state,
                                            orgBankName: org.bankName,
                                            orgBankAccount: org.bankAccountNo,
                                            orgBankIfsc: org.bankIfsc,
                                            orgLogo: org.logo,
                                            orgSignature: org.signatureImage,
                                            orgSignatory: org.authorizedSignatory,
                                            clientId: clientData.clientId,
                                            clientName: clientData.clientName,
                                            clientCode: clientData.clientCode,
                                            clientAddress: clientData.clientAddress,
                                            clientGstin: clientData.clientGstin,
                                            clientState: clientData.clientState,
                                            gstApplicable,
                                            lineItems,
                                            netAmount,
                                            cgst,
                                            sgst,
                                            igst,
                                            totalAmount,
                                            serviceDescription: lineItems.map(l => l.description).join('; '),
                                            narration: lineItems.map(l => l.description).join('; '),
                                            invoiceType: multipleTaskFilters.invoiceType,
                                            taskIds,
                                            groupNo: multipleTaskFilters.groupName,
                                            createdAt: new Date().toISOString()
                                          };
                                          
                                          newInvoices.push(newInvoice);
                                          taskIds.forEach(tid => { taskUpdates[tid] = newInvoice.id; });
                                        });
                                        
                                        if (newInvoices.length === 0) {
                                          alert('No invoices to generate');
                                          return;
                                        }
                                        
                                        setData(prev => ({
                                          ...prev,
                                          invoices: [...(prev.invoices || []), ...newInvoices],
                                          tasks: (prev.tasks || []).map(t => 
                                            taskUpdates[t.id] ? { ...t, billed: true, invoiceId: taskUpdates[t.id] } : t
                                          ),
                                          latestGeneratedInvoices: [...newInvoices, ...(prev.latestGeneratedInvoices || [])].slice(0, 50)
                                        }));
                                        
                                        // Show success message first
                                        alert(`Successfully generated ${newInvoices.length} invoice(s)!`);
                                        
                                        // Navigate to Latest Invoices tab
                                        setBillingMode('latest');
                                        
                                        // Reset all states
                                        setMultipleTaskClient(null);
                                        setMultipleTaskSelectedTasks([]);
                                        setMultipleTaskClientBilling([]);
                                        setMultipleTaskSelectedClients([]);
                                        setMultipleTaskBillingStep('group');
                                        setMultipleTaskOrgId('');
                                        setMultipleTaskFilters({clientName: '', clientCode: '', groupName: '', invoiceType: 'taskWise'});
                                      }}
                                      style={{padding: '12px 32px', background: '#fff', color: '#10b981', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 4px 12px rgba(0,0,0,0.2)'}}
                                    >
                                      âœ“ Generate {multipleTaskClientBilling.length} Invoice(s)
                                    </button>
                                  </div>
                                </div>
                              </>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* Single Client Mode (backward compatibility) */}
                    {multipleTaskClient && !multipleTaskClient.groupMode && multipleTaskSelectedTasks.length === 0 && (
                      <div style={{background: '#fff', padding: '28px', borderRadius: '16px', boxShadow: '0 2px 12px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                        {/* Client Info Header - Green Theme */}
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', padding: '16px 20px', background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', borderRadius: '12px', border: '1px solid #86efac'}}>
                          <div>
                            <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#065f46'}}>{multipleTaskClient.name}</h3>
                            <div style={{fontSize: '13px', color: '#047857', marginTop: '4px'}}>
                              Code: {multipleTaskClient.fileNo} | Group: {multipleTaskClient.groupName} | Invoice Type: <span style={{fontWeight: '700', padding: '2px 8px', borderRadius: '4px', background: multipleTaskFilters.invoiceType === 'taskWise' ? '#fef3c7' : '#dbeafe', color: multipleTaskFilters.invoiceType === 'taskWise' ? '#92400e' : '#1e40af'}}>{multipleTaskFilters.invoiceType === 'taskWise' ? 'Task Wise' : 'Combined Task'}</span>
                            </div>
                          </div>
                          <button
                            onClick={() => { setMultipleTaskClient(null); setMultipleTaskSelectedTasks([]); }}
                            style={{padding: '8px 16px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}
                          >
                            â† Change Client
                          </button>
                        </div>
                        
                        <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#475569'}}>Select Tasks for Invoice</h4>
                        
                        {/* Tasks Table */}
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden', marginBottom: '20px'}}>
                          <div style={{overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px', minWidth: '900px'}}>
                            <thead>
                              <tr style={{background: '#f8fafc'}}>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0', width: '40px'}}>
                                  <input
                                    type="checkbox"
                                    onChange={(e) => {
                                      const clientTasks = (data.tasks || []).filter(t => 
                                        t.clientName?.toLowerCase() === multipleTaskClient.name?.toLowerCase() && 
                                        !isTaskBilled(t.id)
                                      );
                                      if (e.target.checked) {
                                        setMultipleTaskTempSelected(clientTasks.map(t => t.id));
                                      } else {
                                        setMultipleTaskTempSelected([]);
                                      }
                                    }}
                                  />
                                </th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Type</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Task Description</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Financial Year</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Period</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Sub Period</th>
                                <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Billable</th>
                                <th style={{padding: '12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Agreed Fees</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Status</th>
                              </tr>
                            </thead>
                            <tbody>
                              {(() => {
                                // Filter only UNBILLED tasks for this client
                                const clientTasks = (data.tasks || []).filter(t => 
                                  t.clientName?.toLowerCase() === multipleTaskClient.name?.toLowerCase() &&
                                  !isTaskBilled(t.id)
                                );
                                if (clientTasks.length === 0) {
                                  return <tr><td colSpan={9} style={{padding: '40px', textAlign: 'center', color: '#64748b'}}>No unbilled tasks found for this client. All tasks have already been invoiced.</td></tr>;
                                }
                                return clientTasks.map(task => (
                                  <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '12px', textAlign: 'center'}}>
                                      <input
                                        type="checkbox"
                                        checked={multipleTaskTempSelected.includes(task.id)}
                                        onChange={(e) => {
                                          if (e.target.checked) {
                                            setMultipleTaskTempSelected([...multipleTaskTempSelected, task.id]);
                                          } else {
                                            setMultipleTaskTempSelected(multipleTaskTempSelected.filter(id => id !== task.id));
                                          }
                                        }}
                                      />
                                    </td>
                                    <td style={{padding: '12px', fontWeight: '500'}}>{task.taskType || task.parentTask}</td>
                                    <td style={{padding: '12px', color: '#64748b', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{task.taskDescription || task.childTask || '-'}</td>
                                    <td style={{padding: '12px'}}>{task.financialYear}</td>
                                    <td style={{padding: '12px'}}>{task.period}</td>
                                    <td style={{padding: '12px'}}>{task.subPeriod || '-'}</td>
                                    <td style={{padding: '12px', textAlign: 'right'}}>â‚¹{(task.billableCosting || 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '12px', textAlign: 'right'}}>â‚¹{(parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '12px', textAlign: 'center'}}>
                                      <span style={{
                                        padding: '4px 10px',
                                        borderRadius: '12px',
                                        fontSize: '11px',
                                        fontWeight: '500',
                                        background: task.status === 'Completed' ? '#dcfce7' : task.status === 'Running' ? '#fef3c7' : '#e0f2fe',
                                        color: task.status === 'Completed' ? '#166534' : task.status === 'Running' ? '#92400e' : '#0369a1'
                                      }}>
                                        {task.status}
                                      </span>
                                    </td>
                                  </tr>
                                ));
                              })()}
                            </tbody>
                          </table>
                          </div>
                        </div>
                        
                        <div style={{display: 'flex', gap: '12px'}}>
                          <button
                            onClick={() => {
                              if (multipleTaskTempSelected.length === 0) {
                                alert('Please select at least one task');
                                return;
                              }
                              const selectedTasks = (data.tasks || []).filter(t => multipleTaskTempSelected.includes(t.id));
                              setMultipleTaskSelectedTasks(selectedTasks);
                              
                              // Initialize line items based on invoice type
                              if (multipleTaskFilters.invoiceType === 'taskWise') {
                                // Each task gets its own line item
                                const lineItems = selectedTasks.map(task => ({
                                  taskId: task.id,
                                  taskType: task.taskType || task.parentTask,
                                  period: task.period,
                                  financialYear: task.financialYear,
                                  narration: `${task.taskType || task.parentTask} - ${task.period}`,
                                  sacCode: '',
                                  amount: parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || task.billableCosting || 0,
                                  discount: 0,
                                  netAmount: parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || task.billableCosting || 0,
                                  remark: ''
                                }));
                                setMultipleTaskLineItems(lineItems);
                              } else {
                                // Combined: single line item with all tasks
                                const combinedNarration = selectedTasks.map(t => `${t.taskType || t.parentTask} - ${t.period}`).join(', ');
                                const totalAmount = selectedTasks.reduce((sum, t) => sum + (parseFloat(t.agreedFees) || getClientAgreedFee(t.clientId, t.parentTask || t.taskType, t.childTask || t.subTask) || t.billableCosting || 0), 0);
                                setMultipleTaskLineItems([{
                                  taskIds: selectedTasks.map(t => t.id),
                                  narrations: [{text: combinedNarration, amount: totalAmount, discount: 0}],
                                  sacCode: '',
                                  totalAmount: totalAmount,
                                  totalDiscount: 0,
                                  netAmount: totalAmount,
                                  remark: ''
                                }]);
                              }
                            }}
                            disabled={multipleTaskTempSelected.length === 0}
                            style={{
                              padding: '10px 24px',
                              background: multipleTaskTempSelected.length > 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#e2e8f0',
                              color: multipleTaskTempSelected.length > 0 ? '#fff' : '#94a3b8',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: multipleTaskTempSelected.length > 0 ? 'pointer' : 'not-allowed',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            Next â†’ ({multipleTaskTempSelected.length} tasks selected)
                          </button>
                          <button
                            onClick={() => { setMultipleTaskClient(null); }}
                            style={{padding: '10px 20px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px'}}
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}
                    
                  </div>
                )}

                {/* Bulk Invoice Mode */}
                {billingMode === 'bulk' && (
                  <div style={{background: '#fff', padding: '24px', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                    {/* Tab Navigation for Bulk */}
                    <div style={{display: 'flex', gap: '8px', marginBottom: '20px', borderBottom: '2px solid #e2e8f0', paddingBottom: '12px'}}>
                      <button
                        onClick={() => setBulkTaskStep('filter')}
                        style={{
                          padding: '10px 20px',
                          background: bulkTaskStep === 'filter' || bulkTaskStep === 'select' || bulkTaskStep === 'billing' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#f1f5f9',
                          color: bulkTaskStep === 'filter' || bulkTaskStep === 'select' || bulkTaskStep === 'billing' ? '#fff' : '#64748b',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '600'
                        }}
                      >
                        ðŸ“ Create Bulk Invoice
                      </button>
                      <button
                        onClick={() => setBulkTaskStep('batches')}
                        style={{
                          padding: '10px 20px',
                          background: bulkTaskStep === 'batches' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#f1f5f9',
                          color: bulkTaskStep === 'batches' ? '#fff' : '#64748b',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '600'
                        }}
                      >
                        ðŸ“‹ Bulk Invoice Log ({(data.bulkBatches || []).length})
                      </button>
                    </div>

                    {/* Step 1: Filter Tasks */}
                    {bulkTaskStep === 'filter' && (
                      <div>
                        <div style={{background: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', padding: '20px', borderRadius: '10px', marginBottom: '20px'}}>
                          <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#065f46'}}>Search By:</h4>
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Category (Parent Task) *</label>
                              <select
                                value={bulkTaskFilters.parentTask}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, parentTask: e.target.value, childTask: ''})}
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">Select Category</option>
                                {[...new Set((data.tasks || []).map(t => t.parentTask).filter(Boolean))].sort().map(pt => (
                                  <option key={pt} value={pt}>{pt}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Task Type (Child Task) *</label>
                              <select
                                value={bulkTaskFilters.childTask}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, childTask: e.target.value})}
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">Select Task Type</option>
                                {[...new Set((data.tasks || [])
                                  .filter(t => !bulkTaskFilters.parentTask || t.parentTask === bulkTaskFilters.parentTask)
                                  .map(t => t.childTask).filter(Boolean))].sort().map(ct => (
                                  <option key={ct} value={ct}>{ct}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Group No.</label>
                              <input
                                type="text"
                                value={bulkTaskFilters.groupNo || ''}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, groupNo: e.target.value})}
                                placeholder="e.g., 1, 2, 3..."
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px'}}
                              />
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Status</label>
                              <select
                                value={bulkTaskFilters.status}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, status: e.target.value})}
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">All Status</option>
                                <option value="Completed">Completed</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Pending">Pending</option>
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Financial Year</label>
                              <select
                                value={bulkTaskFilters.financialYear}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, financialYear: e.target.value})}
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">All Years</option>
                                {['FY 2025-26', 'FY 2024-25', 'FY 2023-24', 'FY 2022-23'].map(fy => (
                                  <option key={fy} value={fy}>{fy}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Period</label>
                              <select
                                value={bulkTaskFilters.period}
                                onChange={(e) => setBulkTaskFilters({...bulkTaskFilters, period: e.target.value})}
                                style={{width: '100%', padding: '10px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                              >
                                <option value="">All Periods</option>
                                {['Monthly', 'Quarterly', 'Half Yearly', 'Yearly', 'One Time', 'As & when required'].map(p => (
                                  <option key={p} value={p}>{p}</option>
                                ))}
                              </select>
                            </div>
                          </div>
                          <div style={{display: 'flex', justifyContent: 'flex-end', marginTop: '16px'}}>
                            <button
                              onClick={() => {
                                if (!bulkTaskFilters.parentTask || !bulkTaskFilters.childTask) {
                                  alert('Please select Category and Task Type');
                                  return;
                                }
                                // Filter tasks - use groupNo derived from fileNo
                                const filtered = (data.tasks || []).filter(t => {
                                  if (t.billed) return false;
                                  if (bulkTaskFilters.parentTask && t.parentTask !== bulkTaskFilters.parentTask) return false;
                                  if (bulkTaskFilters.childTask && t.childTask !== bulkTaskFilters.childTask) return false;
                                  if (bulkTaskFilters.status && t.status !== bulkTaskFilters.status) return false;
                                  if (bulkTaskFilters.financialYear && t.financialYear !== bulkTaskFilters.financialYear) return false;
                                  if (bulkTaskFilters.period && t.period !== bulkTaskFilters.period) return false;
                                  if (bulkTaskFilters.groupNo) {
                                    const taskGroupNo = t.fileNo ? t.fileNo.split('.')[0] : '';
                                    if (taskGroupNo !== bulkTaskFilters.groupNo.trim()) return false;
                                  }
                                  return true;
                                });
                                setBulkFilteredTasks(filtered);
                                setBulkOriginalTasks(filtered);
                                setBulkSelectedTaskIds([]);
                                setBulkSearchTerm('');
                                setBulkTaskStep('select');
                              }}
                              style={{padding: '10px 24px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}
                            >
                              Search
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Step 2: Select Tasks */}
                    {bulkTaskStep === 'select' && (
                      <div>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                          <div>
                            <span style={{fontSize: '14px', fontWeight: '600'}}>Found {bulkFilteredTasks.length} Tasks</span>
                            <span style={{fontSize: '12px', color: '#64748b', marginLeft: '12px'}}>
                              {bulkTaskFilters.parentTask} â†’ {bulkTaskFilters.childTask}
                            </span>
                          </div>
                          <div style={{display: 'flex', gap: '8px'}}>
                            <button
                              onClick={() => setBulkTaskStep('filter')}
                              style={{padding: '8px 16px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}
                            >
                              â† Back to Filter
                            </button>
                            <button
                              onClick={() => {
                                if (bulkSelectedTaskIds.length === 0) {
                                  alert('Please select at least one task');
                                  return;
                                }
                                // Prepare billing data
                                const selectedTasks = bulkOriginalTasks.filter(t => bulkSelectedTaskIds.includes(t.id));
                                const billingData = selectedTasks.map(task => {
                                  const client = (data.clients || []).find(c => c.name === task.clientName || c.fileNo === task.fileNo);
                                  return {
                                    taskId: task.id,
                                    selected: true,
                                    clientCode: task.fileNo || client?.fileNo || '',
                                    clientName: task.clientName || client?.name || '',
                                    groupNo: task.fileNo ? task.fileNo.split('.')[0] : '',
                                    parentTask: task.parentTask || '',
                                    taskType: task.childTask || '',
                                    financialYear: task.financialYear || '',
                                    period: task.period || '',
                                    subPeriod: task.subPeriod || '',
                                    taskDescription: task.taskDescription || task.childTask || '',
                                    organizationId: '',
                                    billableCosting: task.billableCosting || '0.00',
                                    agreedFees: parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || task.fees || 0,
                                    billNo: '',
                                    amount: parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || task.fees || 0,
                                    discount: '0',
                                    narration: `${task.parentTask} - ${task.childTask}`,
                                    remark: ''
                                  };
                                });
                                setBulkBillingData(billingData);
                                setBulkTaskStep('billing');
                              }}
                              disabled={bulkSelectedTaskIds.length === 0}
                              style={{
                                padding: '8px 20px',
                                background: bulkSelectedTaskIds.length > 0 ? '#10b981' : '#e2e8f0',
                                color: bulkSelectedTaskIds.length > 0 ? '#fff' : '#94a3b8',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: bulkSelectedTaskIds.length > 0 ? 'pointer' : 'not-allowed',
                                fontSize: '12px',
                                fontWeight: '600'
                              }}
                            >
                              Proceed with {bulkSelectedTaskIds.length} Tasks â†’
                            </button>
                          </div>
                        </div>

                        {/* Search Box */}
                        <div style={{marginBottom: '16px'}}>
                          <input
                            type="text"
                            placeholder="ðŸ” Search by client name, code, period..."
                            value={bulkSearchTerm}
                            onChange={(e) => {
                              const search = e.target.value;
                              setBulkSearchTerm(search);
                              if (!search.trim()) {
                                setBulkFilteredTasks(bulkOriginalTasks);
                              } else {
                                const searchLower = search.toLowerCase();
                                setBulkFilteredTasks(bulkOriginalTasks.filter(t => 
                                  t.clientName?.toLowerCase().includes(searchLower) ||
                                  t.fileNo?.toLowerCase().includes(searchLower) ||
                                  t.subPeriod?.toLowerCase().includes(searchLower)
                                ));
                              }
                            }}
                            style={{width: '300px', padding: '10px 16px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                          />
                        </div>

                        {/* Tasks Table */}
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden'}}>
                          <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', position: 'sticky', top: 0}}>
                                <tr>
                                  <th style={{padding: '12px 8px', textAlign: 'center', borderBottom: '2px solid #10b981', width: '40px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                    <input
                                      type="checkbox"
                                      checked={bulkSelectedTaskIds.length === bulkFilteredTasks.length && bulkFilteredTasks.length > 0}
                                      onChange={(e) => {
                                        if (e.target.checked) {
                                          setBulkSelectedTaskIds(bulkFilteredTasks.map(t => t.id));
                                        } else {
                                          setBulkSelectedTaskIds([]);
                                        }
                                      }}
                                    />
                                  </th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>S.No</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Group No.</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Client Code</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Client Name</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Task Type</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Task Description</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>FY</th>
                                  <th style={{padding: '12px 8px', textAlign: 'left', color: '#fff', fontWeight: '600'}}>Period</th>
                                </tr>
                              </thead>
                              <tbody>
                                {bulkFilteredTasks.length === 0 ? (
                                  <tr>
                                    <td colSpan={10} style={{padding: '40px', textAlign: 'center', color: '#64748b'}}>
                                      No tasks found matching the criteria
                                    </td>
                                  </tr>
                                ) : (
                                  bulkFilteredTasks.map((task, idx) => (
                                    <tr 
                                      key={task.id}
                                      style={{
                                        background: bulkSelectedTaskIds.includes(task.id) ? '#f0fdf4' : (idx % 2 === 0 ? '#fff' : '#fafafa'),
                                        borderLeft: bulkSelectedTaskIds.includes(task.id) ? '3px solid #10b981' : '3px solid transparent'
                                      }}
                                    >
                                      <td style={{padding: '10px 8px', textAlign: 'center', borderBottom: '1px solid #f1f5f9'}}>
                                        <input
                                          type="checkbox"
                                          checked={bulkSelectedTaskIds.includes(task.id)}
                                          onChange={(e) => {
                                            if (e.target.checked) {
                                              setBulkSelectedTaskIds([...bulkSelectedTaskIds, task.id]);
                                            } else {
                                              setBulkSelectedTaskIds(bulkSelectedTaskIds.filter(id => id !== task.id));
                                            }
                                          }}
                                        />
                                      </td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9'}}>{idx + 1}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9', fontWeight: '600', color: '#10b981'}}>{task.fileNo ? task.fileNo.split('.')[0] : '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9', fontWeight: '500'}}>{task.fileNo || '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9'}}>{task.clientName || '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9'}}>{task.childTask || '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{task.taskDescription || task.childTask || '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9'}}>{task.financialYear || '-'}</td>
                                      <td style={{padding: '10px 8px', borderBottom: '1px solid #f1f5f9'}}>{task.subPeriod || task.period || '-'}</td>
                                    </tr>
                                  ))
                                )}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Step 3: Billing Sheet */}
                    {bulkTaskStep === 'billing' && (
                      <div>
                        {/* Action Buttons Row */}
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', padding: '16px', background: '#f0fdf4', borderRadius: '8px', border: '2px solid #10b981'}}>
                          <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                            <button
                              onClick={() => setBulkTaskStep('select')}
                              style={{padding: '8px 16px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px'}}
                            >
                              â† Back
                            </button>
                            <label style={{fontSize: '13px', fontWeight: '600'}}>Invoice Date:</label>
                            <input
                              type="date"
                              value={bulkInvoiceDate}
                              onChange={(e) => setBulkInvoiceDate(e.target.value)}
                              style={{padding: '8px 12px', border: '1px solid #10b981', borderRadius: '6px', fontSize: '13px'}}
                            />
                          </div>
                          <div style={{display: 'flex', gap: '12px'}}>
                            <button
                              type="button"
                              onClick={() => {
                                const csv = 'S.No,Group No.,Client Code,Client,Amount\n' + bulkBillingData.map((b,i) => `${i+1},${b.groupNo},${b.clientCode},${b.clientName},${b.amount}`).join('\n');
                                const blob = new Blob([csv], {type: 'text/csv'});
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = 'bulk-bills.csv';
                                a.click();
                              }}
                              style={{padding: '12px 20px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '700'}}
                            >
                              ðŸ“¥ Export Excel
                            </button>
                            <button
                              type="button"
                              onClick={handleBulkPostBill}
                              style={{padding: '12px 24px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '700', boxShadow: '0 2px 8px rgba(16,185,129,0.4)'}}
                            >
                              âœ“ POST BILL
                            </button>
                          </div>
                        </div>
                        
                        {/* Apply Organization Row */}
                        <div style={{display: 'flex', gap: '16px', marginBottom: '20px'}}>
                          <div style={{flex: 1, padding: '12px', background: '#ecfdf5', borderRadius: '8px', border: '1px solid #6ee7b7'}}>
                            <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '8px', color: '#065f46'}}>Apply Organisation to All Bills:</label>
                            <div style={{display: 'flex', gap: '8px'}}>
                              <select
                                id="bulkOrgSelect"
                                style={{flex: 1, padding: '8px', border: '1px solid #6ee7b7', borderRadius: '6px', fontSize: '12px'}}
                              >
                                <option value="">Select Organisation</option>
                                {(data.organizations || []).map(o => (
                                  <option key={o.id} value={o.id}>{o.name}</option>
                                ))}
                              </select>
                              <button
                                type="button"
                                onClick={() => {
                                  const orgId = document.getElementById('bulkOrgSelect')?.value;
                                  if (!orgId) { alert('Select organisation first'); return; }
                                  setBulkBillingData(prev => prev.map(b => ({...b, organizationId: orgId})));
                                }}
                                style={{padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                              >
                                Apply to All
                              </button>
                            </div>
                          </div>
                        </div>

                        {/* Billing Table */}
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden'}}>
                          <div style={{maxHeight: '550px', overflowY: 'auto', overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px', minWidth: '1400px'}}>
                              <thead style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', position: 'sticky', top: 0}}>
                                <tr>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'center', width: '40px'}}>âœ“</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'center', width: '50px'}}>S.No</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'center', width: '50px'}}>Grp</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', width: '70px'}}>Code</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', minWidth: '150px'}}>Client Name</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', width: '100px'}}>Task</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', minWidth: '150px'}}>Task Description</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', minWidth: '180px'}}>Narration</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', width: '80px'}}>Period</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'left', minWidth: '180px'}}>Organisation</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '100px'}}>Agreed Fees</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '100px'}}>Amount</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '80px'}}>Disc</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '90px'}}>Net</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '80px'}}>GST</th>
                                  <th style={{padding: '14px 10px', color: '#fff', fontWeight: '600', textAlign: 'right', width: '100px'}}>Total</th>
                                </tr>
                              </thead>
                              <tbody>
                                {bulkBillingData.map((row, idx) => {
                                  const org = (data.organizations || []).find(o => String(o.id) === String(row.organizationId));
                                  const client = (data.clients || []).find(c => c.name === row.clientName);
                                  const amt = parseFloat(row.amount) || 0;
                                  const disc = parseFloat(row.discount) || 0;
                                  const net = amt - disc;
                                  let gst = 0;
                                  if (org?.gstApplicable === 'yes' && net > 0) {
                                    gst = Math.round(net * 0.18 * 100) / 100;
                                  }
                                  const total = net + gst;
                                  
                                  return (
                                    <tr key={idx} style={{background: row.selected ? '#f0fdf4' : '#fef2f2', borderBottom: '1px solid #e2e8f0'}}>
                                      <td style={{padding: '12px 10px', textAlign: 'center'}}>
                                        <input
                                          type="checkbox"
                                          checked={row.selected}
                                          onChange={(e) => {
                                            const updated = [...bulkBillingData];
                                            updated[idx].selected = e.target.checked;
                                            setBulkBillingData(updated);
                                          }}
                                          style={{width: '16px', height: '16px', cursor: 'pointer'}}
                                        />
                                      </td>
                                      <td style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600'}}>{idx + 1}</td>
                                      <td style={{padding: '12px 10px', textAlign: 'center', fontWeight: '700', color: '#10b981'}}>{row.groupNo || '-'}</td>
                                      <td style={{padding: '12px 10px', fontSize: '12px', color: '#64748b'}}>{row.clientCode}</td>
                                      <td style={{padding: '12px 10px', fontWeight: '600', color: '#1e293b'}}>{row.clientName}</td>
                                      <td style={{padding: '12px 10px', fontSize: '12px'}}>{row.taskType}</td>
                                      <td style={{padding: '12px 10px', fontSize: '12px', color: '#64748b'}}>{row.taskDescription || '-'}</td>
                                      <td style={{padding: '12px 10px'}}>
                                        <input
                                          type="text"
                                          value={row.narration || ''}
                                          onChange={(e) => {
                                            const updated = [...bulkBillingData];
                                            updated[idx].narration = e.target.value;
                                            setBulkBillingData(updated);
                                          }}
                                          style={{width: '100%', padding: '8px 10px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', background: '#f0fdf4'}}
                                          placeholder="Auto-generated"
                                        />
                                      </td>
                                      <td style={{padding: '12px 10px', fontSize: '12px'}}>{row.subPeriod || row.period}</td>
                                      <td style={{padding: '12px 10px'}}>
                                        <select
                                          value={row.organizationId}
                                          onChange={(e) => {
                                            const updated = [...bulkBillingData];
                                            updated[idx].organizationId = e.target.value;
                                            setBulkBillingData(updated);
                                          }}
                                          style={{width: '100%', padding: '8px 10px', border: '1px solid #d1fae5', borderRadius: '6px', fontSize: '12px', background: '#f0fdf4'}}
                                        >
                                          <option value="">Select</option>
                                          {(data.organizations || []).map(o => (
                                            <option key={o.id} value={o.id}>{o.name}</option>
                                          ))}
                                        </select>
                                      </td>
                                      <td style={{padding: '12px 10px', textAlign: 'right', color: '#64748b'}}>
                                        â‚¹{(row.agreedFees || 0).toLocaleString('en-IN')}
                                      </td>
                                      <td style={{padding: '12px 10px', textAlign: 'right'}}>
                                        <input
                                          type="number"
                                          value={row.amount}
                                          onChange={(e) => {
                                            const updated = [...bulkBillingData];
                                            updated[idx].amount = parseFloat(e.target.value) || 0;
                                            setBulkBillingData(updated);
                                          }}
                                          style={{width: '80px', padding: '8px', border: '1px solid #d1fae5', borderRadius: '6px', textAlign: 'right', fontSize: '12px', background: '#f0fdf4'}}
                                        />
                                      </td>
                                      <td style={{padding: '12px 10px', textAlign: 'right'}}>
                                        <input
                                          type="number"
                                          value={row.discount || 0}
                                          onChange={(e) => {
                                            const updated = [...bulkBillingData];
                                            updated[idx].discount = parseFloat(e.target.value) || 0;
                                            setBulkBillingData(updated);
                                          }}
                                          style={{width: '70px', padding: '8px', border: '1px solid #d1fae5', borderRadius: '6px', textAlign: 'right', fontSize: '12px', background: '#f0fdf4'}}
                                        />
                                      </td>
                                      <td style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600'}}>â‚¹{net.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px 10px', textAlign: 'right', color: '#64748b'}}>â‚¹{gst.toLocaleString('en-IN')}</td>
                                      <td style={{padding: '12px 10px', textAlign: 'right', fontWeight: '700', color: '#10b981', fontSize: '14px'}}>â‚¹{total.toLocaleString('en-IN')}</td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                              <tfoot style={{background: '#f0fdf4', borderTop: '2px solid #10b981'}}>
                                <tr>
                                  <td colSpan={11} style={{padding: '14px', fontWeight: '700', textAlign: 'right', fontSize: '14px', color: '#065f46'}}>Selected Total:</td>
                                  <td style={{padding: '14px', fontWeight: '600', textAlign: 'right', fontSize: '13px'}}>
                                    â‚¹{bulkBillingData.filter(b => b.selected).reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0).toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', fontWeight: '600', textAlign: 'right', fontSize: '13px'}}>
                                    â‚¹{bulkBillingData.filter(b => b.selected).reduce((sum, b) => sum + (parseFloat(b.discount) || 0), 0).toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', fontWeight: '600', textAlign: 'right', fontSize: '13px'}}>
                                    â‚¹{bulkBillingData.filter(b => b.selected).reduce((sum, b) => {
                                      const amt = parseFloat(b.amount) || 0;
                                      const disc = parseFloat(b.discount) || 0;
                                      return sum + (amt - disc);
                                    }, 0).toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', fontWeight: '600', textAlign: 'right', fontSize: '13px'}}>
                                    â‚¹{bulkBillingData.filter(b => b.selected).reduce((sum, b) => {
                                      const org = (data.organizations || []).find(o => String(o.id) === String(b.organizationId));
                                      const net = (parseFloat(b.amount) || 0) - (parseFloat(b.discount) || 0);
                                      return sum + (org?.gstApplicable === 'yes' && net > 0 ? Math.round(net * 0.18 * 100) / 100 : 0);
                                    }, 0).toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', fontWeight: '700', color: '#10b981', textAlign: 'right', fontSize: '15px'}}>
                                    â‚¹{bulkBillingData.filter(b => b.selected).reduce((sum, b) => {
                                      const org = (data.organizations || []).find(o => String(o.id) === String(b.organizationId));
                                      const net = (parseFloat(b.amount) || 0) - (parseFloat(b.discount) || 0);
                                      const gst = org?.gstApplicable === 'yes' && net > 0 ? Math.round(net * 0.18 * 100) / 100 : 0;
                                      return sum + net + gst;
                                    }, 0).toLocaleString('en-IN')}
                                  </td>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Bulk Invoice Log View */}
                    {bulkTaskStep === 'batches' && (
                      <div>
                        {(data.bulkBatches || []).length === 0 ? (
                          <div style={{textAlign: 'center', padding: '80px 20px', background: '#fff', borderRadius: '20px', border: '2px dashed #86efac'}}>
                            <div style={{fontSize: '72px', marginBottom: '20px'}}>ðŸ“‹</div>
                            <div style={{fontSize: '20px', fontWeight: '700', color: '#065f46', marginBottom: '10px'}}>No Bulk Invoices Yet</div>
                            <div style={{fontSize: '14px', color: '#64748b', marginBottom: '24px'}}>Create your first bulk invoice batch to see it here</div>
                            <button
                              onClick={() => setBulkTaskStep('filter')}
                              style={{padding: '12px 24px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}
                            >
                              + Create First Batch
                            </button>
                          </div>
                        ) : (
                          <>
                            {!viewingBulkBatch ? (
                              <div style={{background: '#fff', borderRadius: '16px', overflow: 'hidden', border: '1px solid #e2e8f0', boxShadow: '0 2px 12px rgba(0,0,0,0.06)'}}>
                                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                                  <thead>
                                    <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                      <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Batch ID</th>
                                      <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Date</th>
                                      <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Task Type</th>
                                      <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff', minWidth: '250px'}}>Organizations</th>
                                      <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>No. of Invoices</th>
                                      <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Total Amount</th>
                                      <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Actions</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {(data.bulkBatches || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map((batch, idx) => {
                                      const batchInvoices = (data.invoices || []).filter(inv => batch.invoiceIds?.includes(inv.id));
                                      const orgBreakdown = {};
                                      batchInvoices.forEach(inv => {
                                        const orgName = inv.organizationName || inv.orgName || 'Unknown';
                                        if (!orgBreakdown[orgName]) orgBreakdown[orgName] = { count: 0, amount: 0 };
                                        orgBreakdown[orgName].count++;
                                        orgBreakdown[orgName].amount += (inv.totalAmount || 0);
                                      });
                                      const batchDate = batch.invoiceDate || new Date(batch.createdAt).toISOString().split('T')[0];
                                      
                                      return (
                                        <tr key={batch.id} style={{background: idx % 2 === 0 ? '#fff' : '#f0fdf4', borderBottom: '1px solid #e2e8f0'}}>
                                          <td style={{padding: '16px'}}>
                                            <div style={{fontFamily: 'monospace', fontSize: '12px', background: '#f1f5f9', padding: '6px 10px', borderRadius: '6px', display: 'inline-block', color: '#475569', fontWeight: '600'}}>
                                              {batch.id?.substring(0, 12).toUpperCase()}
                                            </div>
                                          </td>
                                          <td style={{padding: '16px'}}>
                                            <div style={{fontWeight: '600', color: '#1e293b'}}>{new Date(batchDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})}</div>
                                            <div style={{fontSize: '11px', color: '#64748b'}}>{new Date(batch.createdAt).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
                                          </td>
                                          <td style={{padding: '16px'}}>
                                            <div style={{fontWeight: '600', color: '#065f46'}}>{batch.taskType || batch.childTask || '-'}</div>
                                            <div style={{fontSize: '11px', color: '#64748b'}}>{batch.parentTask || ''}</div>
                                          </td>
                                          <td style={{padding: '16px', minWidth: '250px'}}>
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '4px'}}>
                                              {Object.keys(orgBreakdown).slice(0, 5).map((orgName, i) => (
                                                <div key={i} style={{display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px'}}>
                                                  <span style={{background: '#dcfce7', color: '#065f46', padding: '2px 8px', borderRadius: '12px', fontWeight: '500'}}>{orgBreakdown[orgName].count}</span>
                                                  <span style={{color: '#374151'}}>{orgName}</span>
                                                </div>
                                              ))}
                                              {Object.keys(orgBreakdown).length > 5 && (
                                                <div style={{fontSize: '11px', color: '#64748b'}}>+{Object.keys(orgBreakdown).length - 5} more org(s)</div>
                                              )}
                                            </div>
                                          </td>
                                          <td style={{padding: '16px', textAlign: 'center'}}>
                                            <button
                                              onClick={() => setViewingBulkBatch(batch)}
                                              style={{background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', color: '#fff', border: 'none', borderRadius: '20px', padding: '8px 18px', fontSize: '14px', fontWeight: '700', cursor: 'pointer', boxShadow: '0 2px 6px rgba(59,130,246,0.3)'}}
                                            >
                                              {batch.invoiceCount || batchInvoices.length} invoices
                                            </button>
                                          </td>
                                          <td style={{padding: '16px', textAlign: 'right'}}>
                                            <span style={{fontWeight: '700', color: '#10b981', fontSize: '15px'}}>â‚¹{(batch.totalAmount || batchInvoices.reduce((s, i) => s + (i.totalAmount || 0), 0)).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                          </td>
                                          <td style={{padding: '16px', textAlign: 'center'}}>
                                            <div style={{display: 'flex', gap: '8px', justifyContent: 'center'}}>
                                              <button onClick={() => setViewingBulkBatch(batch)} style={{padding: '8px 14px', background: '#eff6ff', color: '#2563eb', border: '1px solid #bfdbfe', borderRadius: '8px', cursor: 'pointer', fontSize: '12px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '4px'}}>
                                                <Eye size={14} /> View
                                              </button>
                                              <button
                                                onClick={() => {
                                                  if (!window.confirm(`Delete this batch of ${batch.invoiceCount || batchInvoices.length} invoices? This cannot be undone.`)) return;
                                                  const batchInvs = (data.invoices || []).filter(inv => batch.invoiceIds?.includes(inv.id));
                                                  const hasPayments = batchInvs.some(inv => (data.receipts || []).some(r => String(r.invoiceId) === String(inv.id)));
                                                  if (hasPayments) { alert('Cannot delete. Some invoices have payments recorded.'); return; }
                                                  setData(prev => ({
                                                    ...prev,
                                                    invoices: (prev.invoices || []).filter(inv => !batch.invoiceIds?.includes(inv.id)),
                                                    tasks: (prev.tasks || []).map(t => batch.invoiceIds?.includes(t.invoiceId) ? {...t, billed: false, invoiceId: null} : t),
                                                    bulkBatches: (prev.bulkBatches || []).filter(b => b.id !== batch.id)
                                                  }));
                                                  setBulkBatches(prev => prev.filter(b => b.id !== batch.id));
                                                  alert('Batch deleted successfully!');
                                                }}
                                                style={{padding: '8px 14px', background: '#fef2f2', color: '#dc2626', border: '1px solid #fecaca', borderRadius: '8px', cursor: 'pointer', fontSize: '12px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '4px'}}
                                              >
                                                <Trash2 size={14} /> Delete
                                              </button>
                                            </div>
                                          </td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                </table>
                              </div>
                            ) : (
                              <div>
                                {/* Back Button */}
                                <button onClick={() => setViewingBulkBatch(null)} style={{marginBottom: '20px', padding: '10px 20px', background: '#f1f5f9', color: '#475569', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                  â† Back to Batch List
                                </button>
                                
                                {/* Batch Header */}
                                <div style={{background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', padding: '20px', borderRadius: '16px', marginBottom: '20px', border: '2px solid #86efac'}}>
                                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                    <div>
                                      <h4 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#065f46'}}>
                                        Batch: {viewingBulkBatch.id?.substring(0, 12).toUpperCase()}
                                      </h4>
                                      <p style={{margin: '4px 0 0', fontSize: '13px', color: '#047857'}}>
                                        {viewingBulkBatch.taskType || viewingBulkBatch.childTask} â€¢ {new Date(viewingBulkBatch.invoiceDate || viewingBulkBatch.createdAt).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})}
                                      </p>
                                    </div>
                                    <div style={{display: 'flex', gap: '12px'}}>
                                      <button
                                        onClick={() => {
                                          const batchInvoices = (data.invoices || []).filter(inv => viewingBulkBatch.invoiceIds?.includes(inv.id));
                                          const csv = 'Invoice No,Client,Group No,Amount,GST,Total\n' + batchInvoices.map(inv => 
                                            `${inv.invoiceNo},${inv.clientName},${inv.clientCode ? inv.clientCode.split('.')[0] : ''},${inv.netAmount || inv.amount},${(inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0)},${inv.totalAmount}`
                                          ).join('\n');
                                          const blob = new Blob([csv], {type: 'text/csv'});
                                          const a = document.createElement('a');
                                          a.href = URL.createObjectURL(blob);
                                          a.download = `batch-${viewingBulkBatch.id?.substring(0, 8)}.csv`;
                                          a.click();
                                        }}
                                        style={{padding: '10px 20px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                                      >
                                        <Download size={14} /> Export CSV
                                      </button>
                                      <button
                                        onClick={() => {
                                          const batchInvoices = (data.invoices || []).filter(inv => viewingBulkBatch.invoiceIds?.includes(inv.id));
                                          downloadInvoicesAsZip(batchInvoices, data.organizations, data.clients, `Batch_${viewingBulkBatch.id?.substring(6, 14)}`);
                                        }}
                                        style={{padding: '10px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px', boxShadow: '0 2px 8px rgba(16,185,129,0.3)'}}
                                      >
                                        <Download size={14} /> Download ZIP (PDFs)
                                      </button>
                                      <button
                                        onClick={() => {
                                          const batchInvoices = (data.invoices || []).filter(inv => viewingBulkBatch.invoiceIds?.includes(inv.id));
                                          downloadMultipleInvoices(batchInvoices, data.organizations, data.clients, true);
                                        }}
                                        style={{padding: '10px 20px', background: '#6366f1', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                                      >
                                        <Eye size={14} /> Print All
                                      </button>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Invoices grouped by organization */}
                                {(() => {
                                  const batchInvoices = (data.invoices || []).filter(inv => viewingBulkBatch.invoiceIds?.includes(inv.id));
                                  const byOrg = {};
                                  batchInvoices.forEach(inv => {
                                    const orgName = inv.organizationName || inv.orgName || 'Unknown';
                                    if (!byOrg[orgName]) byOrg[orgName] = [];
                                    byOrg[orgName].push(inv);
                                  });
                                  
                                  return Object.entries(byOrg).map(([orgName, invoices]) => (
                                    <div key={orgName} style={{marginBottom: '20px', background: '#fff', borderRadius: '12px', overflow: 'hidden', border: '1px solid #e2e8f0'}}>
                                      <div style={{padding: '14px 20px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <h5 style={{margin: 0, fontSize: '15px', fontWeight: '600', color: '#1e293b'}}>{orgName}</h5>
                                        <span style={{background: '#dcfce7', color: '#065f46', padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: '600'}}>
                                          {invoices.length} invoices â€¢ â‚¹{invoices.reduce((s, i) => s + (i.totalAmount || 0), 0).toLocaleString('en-IN')}
                                        </span>
                                      </div>
                                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                        <thead>
                                          <tr style={{background: '#f1f5f9'}}>
                                            <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#475569'}}>Invoice No</th>
                                            <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#475569'}}>Group</th>
                                            <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#475569'}}>Client</th>
                                            <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#475569'}}>Task</th>
                                            <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#475569'}}>Amount</th>
                                            <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#475569'}}>GST</th>
                                            <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#475569'}}>Total</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {invoices.map((inv, i) => (
                                            <tr key={inv.id} style={{borderBottom: '1px solid #f1f5f9', background: i % 2 === 0 ? '#fff' : '#fafafa'}}>
                                              <td style={{padding: '10px 12px', fontWeight: '600', color: '#10b981'}}>{inv.invoiceNo}</td>
                                              <td style={{padding: '10px 12px', fontWeight: '600', color: '#10b981'}}>{inv.clientCode ? inv.clientCode.split('.')[0] : '-'}</td>
                                              <td style={{padding: '10px 12px'}}>{inv.clientName}</td>
                                              <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.narration || inv.serviceDescription || '-'}</td>
                                              <td style={{padding: '10px 12px', textAlign: 'right'}}>â‚¹{(inv.netAmount || inv.amount || 0).toLocaleString('en-IN')}</td>
                                              <td style={{padding: '10px 12px', textAlign: 'right'}}>â‚¹{((inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0)).toLocaleString('en-IN')}</td>
                                              <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#10b981'}}>â‚¹{(inv.totalAmount || 0).toLocaleString('en-IN')}</td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  ));
                                })()}
                                
                                {/* Summary */}
                                <div style={{background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', padding: '16px 20px', borderRadius: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', border: '1px solid #86efac'}}>
                                  <div style={{fontSize: '14px', color: '#065f46'}}>
                                    <strong>Total Invoices:</strong> {viewingBulkBatch.invoiceCount || (data.invoices || []).filter(inv => viewingBulkBatch.invoiceIds?.includes(inv.id)).length}
                                  </div>
                                  <div style={{fontSize: '18px', fontWeight: '700', color: '#10b981'}}>
                                    Grand Total: â‚¹{(viewingBulkBatch.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                  </div>
                                </div>
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    )}
                  </div>
                )}
                {/* Invoice Preview Modal - Multiple Formats */}
                {showInvoicePreview && generatedInvoice && (
                  <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.6)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 2000,
                    padding: '20px'
                  }}>
                    <div style={{
                      background: '#f8fafc',
                      borderRadius: '12px',
                      width: '100%',
                      maxWidth: '850px',
                      maxHeight: '95vh',
                      overflow: 'auto',
                      boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                    }}>
                      {/* Action Buttons */}
                      <div style={{
                        display: 'flex',
                        gap: '8px',
                        padding: '12px 16px',
                        background: '#fff',
                        borderBottom: '1px solid #e2e8f0',
                        position: 'sticky',
                        top: 0,
                        zIndex: 10,
                        alignItems: 'center'
                      }}>
                        <div style={{color: '#1e293b', fontSize: '14px', fontWeight: '600'}}>
                          Preview: <span style={{color: generatedInvoice.gstApplicable !== false ? '#10b981' : '#3b82f6'}}>{generatedInvoice.invoiceNo}</span>
                        </div>
                        <div style={{flex: 1}} />
                        <button
                          onClick={printInvoice}
                          style={{padding: '8px 16px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                        >
                          ðŸ–¨ï¸ Print
                        </button>
                        <button
                          style={{padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                        >
                          ðŸ“¥ Download PDF
                        </button>
                        <button
                          onClick={() => { setShowInvoicePreview(false); setGeneratedInvoice(null); }}
                          style={{padding: '8px 16px', background: '#64748b', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                        >
                          âœ• Close
                        </button>
                      </div>
                      
                      {/* Invoice Template - Dark Grey/Black Theme */}
                      <div id="invoice-print-area" style={{padding: '20px'}}>
                        {(() => {
                          // Get current org for live data
                          const currentOrg = data.organizations?.find(o => o.id === (generatedInvoice.orgId || generatedInvoice.organizationId)) || {};
                          
                          // Determine invoice type and theme - Black vs Dark Grey
                          const gstApplicable = generatedInvoice.gstApplicable !== false;
                          const invoiceFormat = generatedInvoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
                          const isDarkTheme = invoiceFormat === 'billOfSupply' || invoiceFormat === 'billOfSupplyBlue';
                          
                          // Colors: Black for Tax/Proforma, Dark Grey for Bill of Supply
                          const primaryColor = isDarkTheme ? '#374151' : '#111827';
                          const secondaryColor = isDarkTheme ? '#6b7280' : '#374151';
                          const headerGradient = isDarkTheme 
                            ? 'linear-gradient(135deg, #374151 0%, #4b5563 50%, #6b7280 100%)'
                            : 'linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%)';
                          const accentColor = isDarkTheme ? '#9ca3af' : '#6b7280';
                          
                          let invoiceTitle = 'TAX INVOICE';
                          if (invoiceFormat === 'billOfSupply' || invoiceFormat === 'billOfSupplyBlue') {
                            invoiceTitle = 'BILL OF SUPPLY';
                          } else if (invoiceFormat === 'proformaInvoice') {
                            invoiceTitle = 'PROFORMA INVOICE';
                          }
                          
                          const showGst = gstApplicable && invoiceFormat !== 'billOfSupply' && invoiceFormat !== 'billOfSupplyBlue';
                          
                          // Use current org data for display (reflects changes)
                          const displayOrg = {
                            name: currentOrg.name || generatedInvoice.orgName,
                            address: currentOrg.address || generatedInvoice.orgAddress,
                            mobile: currentOrg.mobile || generatedInvoice.orgMobile,
                            email: currentOrg.email || generatedInvoice.orgEmail,
                            gstin: currentOrg.gstin || generatedInvoice.orgGstin,
                            pan: currentOrg.pan || generatedInvoice.orgPan,
                            logo: currentOrg.logo || generatedInvoice.orgLogo,
                            signature: currentOrg.signature || generatedInvoice.orgSignature,
                            signatory: currentOrg.signatory || generatedInvoice.orgSignatory,
                            bankName: currentOrg.bankName || generatedInvoice.orgBankName,
                            bankAccount: currentOrg.bankAccount || generatedInvoice.orgBankAccount,
                            bankIfsc: currentOrg.bankIfsc || generatedInvoice.orgBankIfsc,
                            bankBranch: currentOrg.bankBranch || generatedInvoice.orgBankBranch,
                          };
                          
                          return (
                            <div style={{background: '#fff', fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif", border: `2px solid ${primaryColor}`, maxWidth: '210mm'}}>
                              
                              {/* ===== HEADER - Compact Dark Bar ===== */}
                              <div style={{background: headerGradient, padding: '20px 25px', color: '#fff'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                  <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                    {displayOrg.logo ? (
                                      <div style={{background: '#fff', padding: '6px', borderRadius: '6px'}}>
                                        <img src={displayOrg.logo} alt="Logo" style={{width: '50px', height: '50px', objectFit: 'contain'}} />
                                      </div>
                                    ) : (
                                      <div style={{width: '55px', height: '55px', background: 'rgba(255,255,255,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '6px', fontSize: '26px', fontWeight: '700', border: '1px solid rgba(255,255,255,0.3)'}}>
                                        {displayOrg.name?.[0] || 'O'}
                                      </div>
                                    )}
                                    <div>
                                      <h1 style={{margin: 0, fontSize: '20px', fontWeight: '700', letterSpacing: '0.3px'}}>{displayOrg.name}</h1>
                                      <div style={{fontSize: '11px', opacity: 0.85, marginTop: '3px', maxWidth: '280px'}}>{displayOrg.address}</div>
                                    </div>
                                  </div>
                                  <div style={{textAlign: 'right'}}>
                                    <div style={{fontSize: '24px', fontWeight: '800', letterSpacing: '2px'}}>{invoiceTitle}</div>
                                    <div style={{fontSize: '11px', opacity: 0.85, marginTop: '5px'}}>
                                      {displayOrg.mobile && <span>Tel: {displayOrg.mobile}</span>}
                                      {displayOrg.email && <span style={{marginLeft: '10px'}}>Email: {displayOrg.email}</span>}
                                    </div>
                                  </div>
                                </div>
                              </div>
                              
                              {/* ===== INVOICE META BAR ===== */}
                              <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', background: '#f9fafb', borderBottom: `1px solid ${accentColor}`}}>
                                <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                                  <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Invoice No.</div>
                                  <div style={{fontSize: '14px', fontWeight: '700', color: primaryColor, marginTop: '2px'}}>{generatedInvoice.invoiceNo}</div>
                                </div>
                                <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                                  <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Date</div>
                                  <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{formatInvoiceDate(generatedInvoice.invoiceDate)}</div>
                                </div>
                                <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                                  <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Place of Supply</div>
                                  <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{generatedInvoice.placeOfSupply || '-'}</div>
                                </div>
                                <div style={{padding: '12px 15px'}}>
                                  <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>State Code</div>
                                  <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{generatedInvoice.receiverStateCode || '-'}</div>
                                </div>
                              </div>
                              
                              {/* ===== PARTY DETAILS ===== */}
                              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', borderBottom: '1px solid #e5e7eb'}}>
                                {/* From */}
                                <div style={{padding: '15px 20px', borderRight: '1px solid #e5e7eb'}}>
                                  <div style={{fontSize: '10px', color: '#fff', background: primaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '8px'}}>FROM</div>
                                  <div style={{fontSize: '14px', fontWeight: '600', color: '#1f2937'}}>{displayOrg.name}</div>
                                  {showGst && displayOrg.gstin && <div style={{fontSize: '12px', color: '#4b5563', marginTop: '4px'}}>GSTIN: <strong>{displayOrg.gstin}</strong></div>}
                                  {displayOrg.pan && <div style={{fontSize: '12px', color: '#4b5563'}}>PAN: <strong>{displayOrg.pan}</strong></div>}
                                </div>
                                {/* Bill To */}
                                <div style={{padding: '15px 20px'}}>
                                  <div style={{fontSize: '10px', color: '#fff', background: primaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '8px'}}>BILL TO</div>
                                  <div style={{fontSize: '14px', fontWeight: '600', color: '#1f2937'}}>{generatedInvoice.clientName}</div>
                                  {generatedInvoice.clientAddress && <div style={{fontSize: '11px', color: '#6b7280', marginTop: '3px'}}>{generatedInvoice.clientAddress}</div>}
                                  {showGst && generatedInvoice.clientGstin && <div style={{fontSize: '12px', color: '#4b5563', marginTop: '4px'}}>GSTIN: <strong>{generatedInvoice.clientGstin}</strong></div>}
                                  {generatedInvoice.clientCode && <div style={{fontSize: '12px', color: '#4b5563'}}>Code: <strong>{generatedInvoice.clientCode}</strong></div>}
                                </div>
                              </div>
                              
                              {/* ===== SERVICES TABLE ===== */}
                              <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                <thead>
                                  <tr style={{background: headerGradient}}>
                                    <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '40px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>S.No</th>
                                    <th style={{padding: '10px 12px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>Description of Services</th>
                                    {showGst && <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '70px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>SAC</th>}
                                    {showGst && <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '50px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>Tax%</th>}
                                    <th style={{padding: '10px 12px', textAlign: 'right', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '100px'}}>Amount (â‚¹)</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {generatedInvoice.lineItems && generatedInvoice.lineItems.length > 0 ? (
                                    generatedInvoice.lineItems.map((item, idx) => (
                                      <tr key={idx} style={{borderBottom: '1px solid #e5e7eb', background: idx % 2 === 0 ? '#fff' : '#f9fafb'}}>
                                        <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontWeight: '500', fontSize: '12px'}}>{idx + 1}</td>
                                        <td style={{padding: '12px'}}>
                                          <div style={{fontWeight: '500', fontSize: '12px', color: '#1f2937'}}>{item.description}</div>
                                          {item.remark && <div style={{fontSize: '10px', color: '#9ca3af', marginTop: '2px', fontStyle: 'italic'}}>{item.remark}</div>}
                                        </td>
                                        {showGst && <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>{item.sacCode || '998231'}</td>}
                                        {showGst && <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>18%</td>}
                                        <td style={{padding: '12px', textAlign: 'right', fontWeight: '600', fontSize: '12px', color: '#1f2937'}}>{(item.netAmount || item.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                      </tr>
                                    ))
                                  ) : (
                                    <tr style={{borderBottom: '1px solid #e5e7eb'}}>
                                      <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontWeight: '500'}}>1</td>
                                      <td style={{padding: '14px 12px'}}>
                                        <div style={{fontWeight: '500', fontSize: '13px', color: '#1f2937'}}>{generatedInvoice.serviceDescription}</div>
                                        {generatedInvoice.remark && <div style={{fontSize: '10px', color: '#9ca3af', marginTop: '3px', fontStyle: 'italic'}}>{generatedInvoice.remark}</div>}
                                      </td>
                                      {showGst && <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>{generatedInvoice.sac || '998231'}</td>}
                                      {showGst && <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>18%</td>}
                                      <td style={{padding: '14px 12px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: '#1f2937'}}>{generatedInvoice.netAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                  )}
                                </tbody>
                              </table>
                              
                              {/* ===== AMOUNT & BANK SECTION ===== */}
                              <div style={{display: 'flex', borderTop: `1px solid ${accentColor}`}}>
                                {/* Left: Bank Details & Amount in Words */}
                                <div style={{flex: 1, padding: '15px 20px', borderRight: '1px solid #e5e7eb'}}>
                                  <div style={{marginBottom: '12px'}}>
                                    <div style={{fontSize: '10px', color: '#fff', background: secondaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '6px'}}>AMOUNT IN WORDS</div>
                                    <div style={{fontSize: '12px', fontWeight: '500', color: '#1f2937', fontStyle: 'italic'}}>{generatedInvoice.amountInWords}</div>
                                  </div>
                                  <div>
                                    <div style={{fontSize: '10px', color: '#fff', background: secondaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '6px'}}>BANK DETAILS</div>
                                    <div style={{fontSize: '11px', color: '#4b5563', lineHeight: '1.6'}}>
                                      <div><span style={{color: '#9ca3af'}}>Bank:</span> <strong>{displayOrg.bankName || '-'}</strong></div>
                                      <div><span style={{color: '#9ca3af'}}>A/C No:</span> <strong>{displayOrg.bankAccount || '-'}</strong></div>
                                      <div><span style={{color: '#9ca3af'}}>IFSC:</span> <strong>{displayOrg.bankIfsc || '-'}</strong></div>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Right: Totals */}
                                <div style={{width: '280px'}}>
                                  <div style={{padding: '10px 15px', background: '#f9fafb'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                      <span style={{color: '#6b7280', fontSize: '12px'}}>Subtotal</span>
                                      <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{generatedInvoice.netAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                    </div>
                                    {generatedInvoice.discount > 0 && (
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                        <span style={{color: '#6b7280', fontSize: '12px'}}>Discount</span>
                                        <span style={{fontWeight: '600', fontSize: '12px', color: '#dc2626'}}>- â‚¹{generatedInvoice.discount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                    )}
                                    {showGst && generatedInvoice.cgst > 0 && (
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                        <span style={{color: '#6b7280', fontSize: '12px'}}>CGST @9%</span>
                                        <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{generatedInvoice.cgst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                    )}
                                    {showGst && generatedInvoice.sgst > 0 && (
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                        <span style={{color: '#6b7280', fontSize: '12px'}}>SGST @9%</span>
                                        <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{generatedInvoice.sgst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                    )}
                                    {showGst && generatedInvoice.igst > 0 && (
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                        <span style={{color: '#6b7280', fontSize: '12px'}}>IGST @18%</span>
                                        <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{generatedInvoice.igst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                      </div>
                                    )}
                                    {!showGst && (
                                      <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                        <span style={{color: '#6b7280', fontSize: '12px'}}>GST</span>
                                        <span style={{fontWeight: '600', fontSize: '12px', color: '#f59e0b'}}>N/A</span>
                                      </div>
                                    )}
                                  </div>
                                  {/* Grand Total */}
                                  <div style={{background: headerGradient, padding: '12px 15px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                    <span style={{color: '#fff', fontWeight: '700', fontSize: '13px', letterSpacing: '0.5px'}}>GRAND TOTAL</span>
                                    <span style={{color: '#fff', fontWeight: '800', fontSize: '18px'}}>â‚¹{generatedInvoice.totalAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                  </div>
                                </div>
                              </div>
                              
                              {/* ===== SIGNATURE & TERMS ===== */}
                              <div style={{display: 'flex', borderTop: '1px solid #e5e7eb'}}>
                                <div style={{flex: 1, padding: '12px 20px', fontSize: '10px', color: '#6b7280'}}>
                                  <strong style={{color: '#4b5563'}}>Terms:</strong> Payment due within 15 days. Quote invoice number in correspondence.
                                </div>
                                <div style={{width: '180px', padding: '12px 20px', textAlign: 'center', borderLeft: '1px solid #e5e7eb'}}>
                                  <div style={{fontSize: '9px', color: '#9ca3af', marginBottom: '6px'}}>For {displayOrg.name}</div>
                                  {displayOrg.signature ? (
                                    <img src={displayOrg.signature} alt="Signature" style={{maxHeight: '35px', marginBottom: '6px'}} />
                                  ) : (
                                    <div style={{height: '35px', marginBottom: '6px', borderBottom: `1px dashed ${accentColor}`}}></div>
                                  )}
                                  <div style={{borderTop: `1px solid ${primaryColor}`, paddingTop: '4px', fontWeight: '600', fontSize: '10px', color: primaryColor}}>
                                    {displayOrg.signatory || 'Authorized Signatory'}
                                  </div>
                                </div>
                              </div>
                              
                              {/* ===== FOOTER ===== */}
                              <div style={{background: primaryColor, padding: '8px 20px', fontSize: '9px', color: '#fff', textAlign: 'center'}}>
                                Computer generated {invoiceTitle.toLowerCase()}. {showGst ? `Subject to ${generatedInvoice.placeOfSupply || 'local'} jurisdiction.` : 'GST Not Applicable.'}
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  </div>
                )}

                {/* Latest Generated Invoices Mode */}
                {billingMode === 'latest' && (
                  <div style={{background: '#fff', padding: '24px', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                      <h3 style={{margin: 0, fontSize: '16px', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <CheckCircle size={20} style={{color: '#10b981'}} />
                        Latest Generated Invoices ({(data.latestGeneratedInvoices || []).length})
                      </h3>
                      {(data.latestGeneratedInvoices || []).length > 0 && (
                        <div style={{display: 'flex', gap: '8px'}}>
                          <button
                            onClick={() => {
                              const filtered = (data.latestGeneratedInvoices || []).filter(inv => {
                                if (latestInvoiceFilters.invoiceNo && !inv.invoiceNo.toLowerCase().includes(latestInvoiceFilters.invoiceNo.toLowerCase())) return false;
                                if (latestInvoiceFilters.clientName && !(inv.clientName || '').toLowerCase().includes(latestInvoiceFilters.clientName.toLowerCase())) return false;
                                if (latestInvoiceFilters.fromDate && inv.invoiceDate < latestInvoiceFilters.fromDate) return false;
                                if (latestInvoiceFilters.toDate && inv.invoiceDate > latestInvoiceFilters.toDate) return false;
                                if (latestInvoiceFilters.minAmount && (inv.totalAmount || 0) < parseFloat(latestInvoiceFilters.minAmount)) return false;
                                if (latestInvoiceFilters.maxAmount && (inv.totalAmount || 0) > parseFloat(latestInvoiceFilters.maxAmount)) return false;
                                return true;
                              });
                              downloadInvoicesAsZip(filtered, data.organizations, data.clients, `Invoices_${new Date().toISOString().split('T')[0]}`);
                            }}
                            style={{padding: '8px 16px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                          >
                            <Download size={14} /> ZIP
                          </button>
                          <button
                            onClick={() => { if (window.confirm('Clear all from this list?')) setData(prev => ({ ...prev, latestGeneratedInvoices: [] })); }}
                            style={{padding: '8px 16px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                          >
                            Clear
                          </button>
                        </div>
                      )}
                    </div>

                    {/* Filters Row */}
                    {(data.latestGeneratedInvoices || []).length > 0 && !editingGeneratedInvoice && (
                      <div style={{background: '#f8fafc', padding: '12px 16px', borderRadius: '8px', marginBottom: '16px', border: '1px solid #e2e8f0'}}>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(8, 1fr) auto', gap: '10px', alignItems: 'end'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Invoice No</label>
                            <input type="text" value={latestInvoiceFilters.invoiceNo} onChange={(e) => setLatestInvoiceFilters(p => ({...p, invoiceNo: e.target.value}))} placeholder="Search..." style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Client Name</label>
                            <input type="text" value={latestInvoiceFilters.clientName} onChange={(e) => setLatestInvoiceFilters(p => ({...p, clientName: e.target.value}))} placeholder="Search..." style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Client Code</label>
                            <input type="text" value={latestInvoiceFilters.clientCode} onChange={(e) => setLatestInvoiceFilters(p => ({...p, clientCode: e.target.value}))} placeholder="Code..." style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Organization</label>
                            <select value={latestInvoiceFilters.organizationId} onChange={(e) => setLatestInvoiceFilters(p => ({...p, organizationId: e.target.value}))} style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px', background: '#fff'}}>
                              <option value="">All</option>
                              {(data.organizations || []).map(org => <option key={org.id} value={org.id}>{org.name}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>From Date</label>
                            <input type="date" value={latestInvoiceFilters.fromDate} onChange={(e) => setLatestInvoiceFilters(p => ({...p, fromDate: e.target.value}))} style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>To Date</label>
                            <input type="date" value={latestInvoiceFilters.toDate} onChange={(e) => setLatestInvoiceFilters(p => ({...p, toDate: e.target.value}))} style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Min Amt</label>
                            <input type="number" value={latestInvoiceFilters.minAmount} onChange={(e) => setLatestInvoiceFilters(p => ({...p, minAmount: e.target.value}))} placeholder="â‚¹" style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '4px', color: '#64748b'}}>Max Amt</label>
                            <input type="number" value={latestInvoiceFilters.maxAmount} onChange={(e) => setLatestInvoiceFilters(p => ({...p, maxAmount: e.target.value}))} placeholder="â‚¹" style={{width: '100%', padding: '6px 8px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '11px'}} />
                          </div>
                          <button onClick={() => setLatestInvoiceFilters({invoiceNo: '', clientName: '', clientCode: '', organizationId: '', fromDate: '', toDate: '', minAmount: '', maxAmount: ''})} style={{padding: '6px 12px', background: '#e2e8f0', color: '#64748b', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontWeight: '500'}}>Reset</button>
                        </div>
                      </div>
                    )}

                    {(data.latestGeneratedInvoices || []).length === 0 ? (
                      <div style={{textAlign: 'center', padding: '40px', background: '#f8fafc', borderRadius: '8px', border: '1px dashed #d1d5db'}}>
                        <FileText size={36} style={{color: '#94a3b8', marginBottom: '12px'}} />
                        <p style={{margin: 0, color: '#64748b', fontSize: '13px'}}>No recent invoices. Generate invoices from Single or Multiple Task modes.</p>
                      </div>
                    ) : editingGeneratedInvoice ? (
                      /* Comprehensive Edit Invoice Form */
                      <div style={{background: '#f8fafc', border: '2px solid #10b981', borderRadius: '10px', padding: '20px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', paddingBottom: '12px', borderBottom: '1px solid #e2e8f0'}}>
                          <h4 style={{margin: 0, fontSize: '15px', fontWeight: '700', color: '#065f46'}}>âœï¸ Edit Invoice: {editingGeneratedInvoice.invoiceNo}</h4>
                          <button onClick={() => setEditingGeneratedInvoice(null)} style={{padding: '6px 12px', background: '#e2e8f0', color: '#64748b', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px'}}>âœ• Cancel</button>
                        </div>
                        
                        {/* Row 1: Basic Info */}
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '12px'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Invoice No <span style={{color: '#dc2626'}}>*</span></label>
                            <input type="text" value={editingGeneratedInvoice.invoiceNo} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, invoiceNo: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Invoice Date <span style={{color: '#dc2626'}}>*</span></label>
                            <input type="date" value={editingGeneratedInvoice.invoiceDate} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, invoiceDate: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Organization</label>
                            <select value={editingGeneratedInvoice.organizationId} onChange={(e) => {
                              const org = (data.organizations || []).find(o => o.id === e.target.value);
                              setEditingGeneratedInvoice(p => ({...p, organizationId: e.target.value, orgId: e.target.value, orgName: org?.name || '', orgAddress: org?.address || '', orgState: org?.state || '', orgGstin: org?.gstin || ''}));
                            }} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}}>
                              <option value="">Select</option>
                              {(data.organizations || []).map(org => <option key={org.id} value={org.id}>{org.name}</option>)}
                            </select>
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Place of Supply</label>
                            <select value={editingGeneratedInvoice.placeOfSupply || editingGeneratedInvoice.clientState || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, placeOfSupply: e.target.value, clientState: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}}>
                              <option value="">Select State</option>
                              {INDIAN_STATES.map(state => <option key={state} value={state}>{state}</option>)}
                            </select>
                          </div>
                        </div>

                        {/* Row 2: Client Info */}
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '12px'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Client Name <span style={{color: '#dc2626'}}>*</span></label>
                            <input type="text" value={editingGeneratedInvoice.clientName} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, clientName: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Client Code</label>
                            <input type="text" value={editingGeneratedInvoice.clientCode || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, clientCode: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Client GSTIN</label>
                            <input type="text" value={editingGeneratedInvoice.clientGstin || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, clientGstin: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Client Address</label>
                            <input type="text" value={editingGeneratedInvoice.clientAddress || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, clientAddress: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                        </div>

                        {/* Row 3: Amounts */}
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '12px', marginBottom: '12px'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Amount <span style={{color: '#dc2626'}}>*</span></label>
                            <input type="number" value={editingGeneratedInvoice.amount || editingGeneratedInvoice.netAmount || 0} onChange={(e) => {
                              const amt = parseFloat(e.target.value) || 0;
                              const disc = parseFloat(editingGeneratedInvoice.discount) || 0;
                              const net = amt - disc;
                              const org = (data.organizations || []).find(o => String(o.id) === String(editingGeneratedInvoice.organizationId));
                              let cgst = 0, sgst = 0, igst = 0;
                              if (org?.gstApplicable === 'yes' && net > 0) {
                                const orgState = (org.state || '').toLowerCase();
                                const clientState = (editingGeneratedInvoice.clientState || editingGeneratedInvoice.placeOfSupply || '').toLowerCase();
                                if (orgState && clientState && orgState === clientState) { cgst = Math.round(net * 0.09 * 100) / 100; sgst = Math.round(net * 0.09 * 100) / 100; }
                                else { igst = Math.round(net * 0.18 * 100) / 100; }
                              }
                              setEditingGeneratedInvoice(p => ({...p, amount: amt, netAmount: net, cgst, sgst, igst, totalAmount: net + cgst + sgst + igst}));
                            }} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Discount</label>
                            <input type="number" value={editingGeneratedInvoice.discount || 0} onChange={(e) => {
                              const disc = parseFloat(e.target.value) || 0;
                              const amt = parseFloat(editingGeneratedInvoice.amount) || 0;
                              const net = amt - disc;
                              const org = (data.organizations || []).find(o => String(o.id) === String(editingGeneratedInvoice.organizationId));
                              let cgst = 0, sgst = 0, igst = 0;
                              if (org?.gstApplicable === 'yes' && net > 0) {
                                const orgState = (org.state || '').toLowerCase();
                                const clientState = (editingGeneratedInvoice.clientState || editingGeneratedInvoice.placeOfSupply || '').toLowerCase();
                                if (orgState && clientState && orgState === clientState) { cgst = Math.round(net * 0.09 * 100) / 100; sgst = Math.round(net * 0.09 * 100) / 100; }
                                else { igst = Math.round(net * 0.18 * 100) / 100; }
                              }
                              setEditingGeneratedInvoice(p => ({...p, discount: disc, netAmount: net, cgst, sgst, igst, totalAmount: net + cgst + sgst + igst}));
                            }} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Net Amount</label>
                            <input type="number" value={editingGeneratedInvoice.netAmount || 0} readOnly style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px', background: '#f0fdf4'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>CGST (9%)</label>
                            <input type="number" value={editingGeneratedInvoice.cgst || 0} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, cgst: parseFloat(e.target.value) || 0, totalAmount: (p.netAmount || 0) + (parseFloat(e.target.value) || 0) + (p.sgst || 0) + (p.igst || 0)}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>SGST (9%)</label>
                            <input type="number" value={editingGeneratedInvoice.sgst || 0} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, sgst: parseFloat(e.target.value) || 0, totalAmount: (p.netAmount || 0) + (p.cgst || 0) + (parseFloat(e.target.value) || 0) + (p.igst || 0)}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>IGST (18%)</label>
                            <input type="number" value={editingGeneratedInvoice.igst || 0} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, igst: parseFloat(e.target.value) || 0, totalAmount: (p.netAmount || 0) + (p.cgst || 0) + (p.sgst || 0) + (parseFloat(e.target.value) || 0)}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                        </div>

                        {/* Row 4: Total & Task Info */}
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '12px', marginBottom: '12px'}}>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Total Amount</label>
                            <input type="text" value={`â‚¹${(editingGeneratedInvoice.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`} readOnly style={{width: '100%', padding: '8px', border: '2px solid #10b981', borderRadius: '6px', fontSize: '13px', background: '#f0fdf4', fontWeight: '700', color: '#10b981'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Parent Task</label>
                            <input type="text" value={editingGeneratedInvoice.parentTask || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, parentTask: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Task Type / Child Task</label>
                            <input type="text" value={editingGeneratedInvoice.taskType || editingGeneratedInvoice.childTask || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, taskType: e.target.value, childTask: e.target.value}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                          <div>
                            <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>FY / Period</label>
                            <input type="text" value={`${editingGeneratedInvoice.financialYear || ''} ${editingGeneratedInvoice.period || ''}`} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, financialYear: e.target.value.split(' ')[0], period: e.target.value.split(' ').slice(1).join(' ')}))} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px'}} />
                          </div>
                        </div>

                        {/* Row 5: Narration */}
                        <div style={{marginBottom: '16px'}}>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '4px', color: '#065f46'}}>Service Description / Narration</label>
                          <textarea value={editingGeneratedInvoice.narration || editingGeneratedInvoice.serviceDescription || ''} onChange={(e) => setEditingGeneratedInvoice(p => ({...p, narration: e.target.value, serviceDescription: e.target.value}))} rows={2} style={{width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px', resize: 'vertical'}} />
                        </div>

                        {/* Action Buttons */}
                        <div style={{display: 'flex', gap: '8px', justifyContent: 'flex-end', paddingTop: '12px', borderTop: '1px solid #e2e8f0'}}>
                          <button onClick={() => setEditingGeneratedInvoice(null)} style={{padding: '10px 20px', background: '#e2e8f0', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>Cancel</button>
                          <button onClick={() => {
                            setData(prev => ({
                              ...prev,
                              invoices: (prev.invoices || []).map(inv => inv.id === editingGeneratedInvoice.id ? editingGeneratedInvoice : inv),
                              latestGeneratedInvoices: (prev.latestGeneratedInvoices || []).map(inv => inv.id === editingGeneratedInvoice.id ? editingGeneratedInvoice : inv)
                            }));
                            setEditingGeneratedInvoice(null);
                            alert('Invoice updated successfully!');
                          }} style={{padding: '10px 24px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>ðŸ’¾ Save Changes</button>
                        </div>
                      </div>
                    ) : (() => {
                      // Apply filters
                      const filteredInvoices = (data.latestGeneratedInvoices || []).filter(inv => {
                        if (latestInvoiceFilters.invoiceNo && !inv.invoiceNo.toLowerCase().includes(latestInvoiceFilters.invoiceNo.toLowerCase())) return false;
                        if (latestInvoiceFilters.clientName && !(inv.clientName || '').toLowerCase().includes(latestInvoiceFilters.clientName.toLowerCase())) return false;
                        if (latestInvoiceFilters.clientCode && !(inv.clientCode || '').toLowerCase().includes(latestInvoiceFilters.clientCode.toLowerCase())) return false;
                        if (latestInvoiceFilters.organizationId && String(inv.organizationId) !== String(latestInvoiceFilters.organizationId)) return false;
                        if (latestInvoiceFilters.fromDate && inv.invoiceDate < latestInvoiceFilters.fromDate) return false;
                        if (latestInvoiceFilters.toDate && inv.invoiceDate > latestInvoiceFilters.toDate) return false;
                        if (latestInvoiceFilters.minAmount && (inv.totalAmount || 0) < parseFloat(latestInvoiceFilters.minAmount)) return false;
                        if (latestInvoiceFilters.maxAmount && (inv.totalAmount || 0) > parseFloat(latestInvoiceFilters.maxAmount)) return false;
                        return true;
                      });
                      return (
                        <>
                          {/* Summary Row */}
                          <div style={{display: 'flex', gap: '16px', marginBottom: '16px'}}>
                            <div style={{flex: 1, background: '#f0fdf4', padding: '12px 16px', borderRadius: '8px', border: '1px solid #86efac'}}>
                              <div style={{fontSize: '11px', color: '#065f46', fontWeight: '600'}}>Showing</div>
                              <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>{filteredInvoices.length} <span style={{fontSize: '12px', fontWeight: '400', color: '#64748b'}}>of {(data.latestGeneratedInvoices || []).length}</span></div>
                            </div>
                            <div style={{flex: 1, background: '#f0fdf4', padding: '12px 16px', borderRadius: '8px', border: '1px solid #86efac'}}>
                              <div style={{fontSize: '11px', color: '#065f46', fontWeight: '600'}}>Filtered Total</div>
                              <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>â‚¹{filteredInvoices.reduce((s, i) => s + (i.totalAmount || 0), 0).toLocaleString('en-IN')}</div>
                            </div>
                          </div>

                          {/* Table */}
                          <div style={{border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead>
                                <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                                  <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px'}}>#</th>
                                  <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Invoice No</th>
                                  <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Date</th>
                                  <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Client Code</th>
                                  <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Client Name</th>
                                  <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Organization</th>
                                  <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Net</th>
                                  <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', fontSize: '11px'}}>GST</th>
                                  <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Total</th>
                                  <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px'}}>Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                {filteredInvoices.length === 0 ? (
                                  <tr><td colSpan={10} style={{padding: '40px', textAlign: 'center', color: '#64748b', fontSize: '13px'}}>No invoices match the filters</td></tr>
                                ) : filteredInvoices.map((invoice, idx) => {
                                  const org = (data.organizations || []).find(o => String(o.id) === String(invoice.organizationId));
                                  return (
                                  <tr key={invoice.id} style={{background: idx % 2 === 0 ? '#fff' : '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                                    <td style={{padding: '10px', color: '#64748b', textAlign: 'center', fontSize: '12px'}}>{idx + 1}</td>
                                    <td style={{padding: '10px', fontWeight: '600', color: '#10b981', fontSize: '12px'}}>{invoice.invoiceNo}</td>
                                    <td style={{padding: '10px', color: '#64748b', fontSize: '12px'}}>{new Date(invoice.invoiceDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: '2-digit'})}</td>
                                    <td style={{padding: '10px', fontWeight: '600', color: '#4f46e5', fontFamily: 'monospace', fontSize: '12px'}}>{invoice.clientCode || '-'}</td>
                                    <td style={{padding: '10px', fontWeight: '500', color: '#1e293b', fontSize: '12px'}}>{invoice.clientName}</td>
                                    <td style={{padding: '10px', color: '#64748b', fontSize: '12px'}}>{org?.name || invoice.orgName || '-'}</td>
                                    <td style={{padding: '10px', textAlign: 'right', color: '#64748b', fontSize: '12px'}}>â‚¹{(invoice.netAmount || 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '10px', textAlign: 'right', color: '#64748b', fontSize: '12px'}}>â‚¹{((invoice.cgst || 0) + (invoice.sgst || 0) + (invoice.igst || 0)).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '10px', textAlign: 'right', fontWeight: '700', color: '#10b981', fontSize: '12px'}}>â‚¹{(invoice.totalAmount || 0).toLocaleString('en-IN')}</td>
                                    <td style={{padding: '8px 10px', textAlign: 'center'}}>
                                      <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                                        <button onClick={() => { setGeneratedInvoice(invoice); setShowInvoicePreview(true); }} title="View" style={{padding: '5px 8px', background: '#eff6ff', color: '#3b82f6', border: 'none', borderRadius: '4px', cursor: 'pointer'}}><Eye size={14} /></button>
                                        <button onClick={() => downloadInvoicePDF(invoice, data.organizations, data.clients)} title="Download" style={{padding: '5px 8px', background: '#f0fdf4', color: '#10b981', border: 'none', borderRadius: '4px', cursor: 'pointer'}}><Download size={14} /></button>
                                        <button onClick={() => setEditingGeneratedInvoice({...invoice})} title="Edit" style={{padding: '5px 8px', background: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '4px', cursor: 'pointer'}}><Edit size={14} /></button>
                                        <button onClick={() => {
                                          if (!window.confirm(`Delete invoice ${invoice.invoiceNo}?\n\nThis will also unbill associated tasks.`)) return;
                                          setData(prev => ({
                                            ...prev,
                                            invoices: (prev.invoices || []).filter(i => i.id !== invoice.id),
                                            latestGeneratedInvoices: (prev.latestGeneratedInvoices || []).filter(i => i.id !== invoice.id),
                                            tasks: (prev.tasks || []).map(t => (invoice.taskIds && invoice.taskIds.includes(t.id)) || t.invoiceId === invoice.id ? {...t, billed: false, invoiceId: null} : t)
                                          }));
                                        }} title="Delete" style={{padding: '5px 8px', background: '#fef2f2', color: '#ef4444', border: 'none', borderRadius: '4px', cursor: 'pointer'}}><Trash2 size={14} /></button>
                                      </div>
                                    </td>
                                  </tr>
                                );})}
                              </tbody>
                            </table>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                )}


                {/* Popup moved to end of InvoicingView */}


              </>
            )}
          </div>
        )}

        {/* Unbilled Tasks Tab */}
        {activeTab === 'unbilledTasks' && (
          <div>
            {/* Sub-tab Toggle */}
            <div style={{display: 'flex', gap: '12px', marginBottom: '24px'}}>
              <button
                onClick={() => setUnbilledTasksTab('unbilled')}
                style={{
                  padding: '14px 28px',
                  background: unbilledTasksTab === 'unbilled' ? '#10b981' : '#f1f5f9',
                  color: unbilledTasksTab === 'unbilled' ? '#fff' : '#64748b',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px'
                }}
              >
                <Clock size={18} style={{marginRight: '8px', verticalAlign: 'middle'}} />
                Unbilled Tasks
              </button>
              <button
                onClick={() => setUnbilledTasksTab('free')}
                style={{
                  padding: '14px 28px',
                  background: unbilledTasksTab === 'free' ? '#8b5cf6' : '#f1f5f9',
                  color: unbilledTasksTab === 'free' ? '#fff' : '#64748b',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px'
                }}
              >
                <Check size={18} style={{marginRight: '8px', verticalAlign: 'middle'}} />
                Free Tasks
              </button>
            </div>

            {/* Unbilled Tasks List */}
            {unbilledTasksTab === 'unbilled' && (
              <div style={{background: '#fff', borderRadius: '12px', boxShadow: '0 4px 20px rgba(0,0,0,0.08)', border: '1px solid #e2e8f0'}}>
                {/* Filters - Compact Bar */}
                <div style={{padding: '12px 16px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0', borderRadius: '12px 12px 0 0'}}>
                  <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap', alignItems: 'flex-end'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Client Name</label>
                      <input 
                        type="text" 
                        value={unbilledFilters.clientName} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, clientName: e.target.value}))}
                        placeholder="Search..."
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', width: '120px', outline: 'none'}} 
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Client Code</label>
                      <input 
                        type="text" 
                        value={unbilledFilters.clientCode} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, clientCode: e.target.value}))}
                        placeholder="Code..."
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', width: '80px', outline: 'none'}} 
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Parent Task</label>
                      <select 
                        value={unbilledFilters.parentTask} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, parentTask: e.target.value, childTask: ''}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', minWidth: '100px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        {Object.keys(PARENT_CHILD_TASKS).map(p => <option key={p} value={p}>{p}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Child Task</label>
                      <select 
                        value={unbilledFilters.childTask} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, childTask: e.target.value}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', minWidth: '100px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        {(PARENT_CHILD_TASKS[unbilledFilters.parentTask] || []).map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Financial Year</label>
                      <select 
                        value={unbilledFilters.financialYear} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, financialYear: e.target.value}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        <option value="FY 2023-24">FY 2023-24</option>
                        <option value="FY 2024-25">FY 2024-25</option>
                        <option value="FY 2025-26">FY 2025-26</option>
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Period</label>
                      <select 
                        value={unbilledFilters.period} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, period: e.target.value}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Annual">Annual</option>
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Status</label>
                      <select 
                        value={unbilledFilters.status} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, status: e.target.value}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        <option value="Completed">Completed</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Open">Open</option>
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '10px', fontWeight: '600', marginBottom: '3px', color: '#64748b'}}>Reporting Manager</label>
                      <select 
                        value={unbilledFilters.reportingManager} 
                        onChange={(e) => setUnbilledFilters(p => ({...p, reportingManager: e.target.value}))}
                        style={{padding: '6px 10px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', minWidth: '120px', background: '#fff', cursor: 'pointer'}}
                      >
                        <option value="">All</option>
                        {[...new Set((data.staff || []).map(s => s.name).filter(Boolean))].map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    <button 
                      onClick={() => setUnbilledFilters({clientName: '', clientCode: '', parentTask: '', childTask: '', financialYear: '', period: '', status: '', reportingManager: ''})}
                      style={{padding: '6px 12px', background: '#f1f5f9', border: '1px solid #e2e8f0', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontWeight: '500', color: '#64748b'}}
                    >
                      Clear
                    </button>
                  </div>
                </div>

                {/* Action Bar - Selected Tasks */}
                {unbilledSelectedIds.length > 0 && (
                  <div style={{padding: '12px 20px', background: '#ecfdf5', borderBottom: '1px solid #6ee7b7', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                    <span style={{fontSize: '13px', fontWeight: '600', color: '#065f46'}}>
                      âœ“ {unbilledSelectedIds.length} task(s) selected
                    </span>
                    <div style={{display: 'flex', gap: '10px'}}>
                      <button
                        onClick={() => {
                          const count = unbilledSelectedIds.length;
                          setData(prev => ({
                            ...prev,
                            tasks: (prev.tasks || []).map(t => 
                              unbilledSelectedIds.includes(t.id) ? {...t, markedFree: true, freeMarkedAt: new Date().toISOString()} : t
                            )
                          }));
                          setUnbilledSelectedIds([]);
                          alert(`${count} task(s) marked as FREE successfully!`);
                        }}
                        style={{padding: '8px 16px', background: '#8b5cf6', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                      >
                        <Check size={14} style={{marginRight: '6px', verticalAlign: 'middle'}} />
                        Mark as Free
                      </button>
                      <button
                        onClick={() => {
                          // Initialize details for each task
                          const details = {};
                          (data.tasks || []).filter(t => unbilledSelectedIds.includes(t.id)).forEach(task => {
                            details[task.id] = {
                              orgId: '',
                              amount: parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || 0,
                              tax: 0
                            };
                          });
                          setUnbilledTaskDetails(details);
                          setShowUnbilledInvoiceModal(true);
                        }}
                        style={{padding: '8px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                      >
                        <FileText size={14} style={{marginRight: '6px', verticalAlign: 'middle'}} />
                        Generate Invoice
                      </button>
                    </div>
                  </div>
                )}

                {/* Tasks Table */}
                <div style={{overflowX: 'auto'}}>
                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px', minWidth: '1500px'}}>
                    <thead>
                      <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                        <th style={{padding: '12px 8px', width: '40px', borderRight: '1px solid #34d399'}}>
                          <input 
                            type="checkbox"
                            style={{width: '16px', height: '16px', cursor: 'pointer', accentColor: '#fff'}}
                            onChange={(e) => {
                              const unbilledTasks = (data.tasks || []).filter(t => !t.billed && !t.markedFree);
                              let filtered = unbilledTasks;
                              if (unbilledFilters.clientName) filtered = filtered.filter(t => (t.clientName || '').toLowerCase().includes(unbilledFilters.clientName.toLowerCase()));
                              if (unbilledFilters.clientCode) filtered = filtered.filter(t => (t.fileNo || '').toLowerCase().includes(unbilledFilters.clientCode.toLowerCase()));
                              if (unbilledFilters.parentTask) filtered = filtered.filter(t => t.parentTask === unbilledFilters.parentTask);
                              if (unbilledFilters.childTask) filtered = filtered.filter(t => t.childTask === unbilledFilters.childTask);
                              if (unbilledFilters.financialYear) filtered = filtered.filter(t => t.financialYear === unbilledFilters.financialYear);
                              if (unbilledFilters.period) filtered = filtered.filter(t => t.period === unbilledFilters.period);
                              if (unbilledFilters.status) {
                                filtered = filtered.filter(t => {
                                  const taskStatus = t.status === 'Completed' || t.completedCheck ? 'Completed' : t.status === 'In Progress' ? 'In Progress' : 'Open';
                                  return taskStatus === unbilledFilters.status;
                                });
                              }
                              if (unbilledFilters.reportingManager) filtered = filtered.filter(t => t.taskManager === unbilledFilters.reportingManager || t.taskLeader === unbilledFilters.reportingManager);
                              setUnbilledSelectedIds(e.target.checked ? filtered.map(t => t.id) : []);
                            }}
                            checked={(() => {
                              const unbilledTasks = (data.tasks || []).filter(t => !t.billed && !t.markedFree);
                              let filtered = unbilledTasks;
                              if (unbilledFilters.clientName) filtered = filtered.filter(t => (t.clientName || '').toLowerCase().includes(unbilledFilters.clientName.toLowerCase()));
                              if (unbilledFilters.clientCode) filtered = filtered.filter(t => (t.fileNo || '').toLowerCase().includes(unbilledFilters.clientCode.toLowerCase()));
                              if (unbilledFilters.parentTask) filtered = filtered.filter(t => t.parentTask === unbilledFilters.parentTask);
                              if (unbilledFilters.childTask) filtered = filtered.filter(t => t.childTask === unbilledFilters.childTask);
                              if (unbilledFilters.financialYear) filtered = filtered.filter(t => t.financialYear === unbilledFilters.financialYear);
                              if (unbilledFilters.period) filtered = filtered.filter(t => t.period === unbilledFilters.period);
                              if (unbilledFilters.status) {
                                filtered = filtered.filter(t => {
                                  const taskStatus = t.status === 'Completed' || t.completedCheck ? 'Completed' : t.status === 'In Progress' ? 'In Progress' : 'Open';
                                  return taskStatus === unbilledFilters.status;
                                });
                              }
                              if (unbilledFilters.reportingManager) filtered = filtered.filter(t => t.taskManager === unbilledFilters.reportingManager || t.taskLeader === unbilledFilters.reportingManager);
                              return filtered.length > 0 && unbilledSelectedIds.length === filtered.length;
                            })()}
                          />
                        </th>
                        <th style={{padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', width: '45px'}}>S.No</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '70px'}}>Code</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '140px'}}>Client Name</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '100px'}}>Parent Task</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '110px'}}>Child Task</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '200px'}}>Task Description</th>
                        <th style={{padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '80px'}}>Fin. Year</th>
                        <th style={{padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '70px'}}>Period</th>
                        <th style={{padding: '12px 8px', textAlign: 'left', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '100px'}}>Reporting Mgr</th>
                        <th style={{padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '80px'}}>Status</th>
                        <th style={{padding: '12px 8px', textAlign: 'right', fontWeight: '600', color: '#fff', fontSize: '11px', borderRight: '1px solid #34d399', minWidth: '100px'}}>Agreed Fees</th>
                        <th style={{padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: '#fff', fontSize: '11px', minWidth: '60px'}}>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const unbilledTasks = (data.tasks || []).filter(t => !t.billed && !t.markedFree);
                        let filtered = unbilledTasks;
                        if (unbilledFilters.clientName) filtered = filtered.filter(t => (t.clientName || '').toLowerCase().includes(unbilledFilters.clientName.toLowerCase()));
                        if (unbilledFilters.clientCode) filtered = filtered.filter(t => (t.fileNo || '').toLowerCase().includes(unbilledFilters.clientCode.toLowerCase()));
                        if (unbilledFilters.parentTask) filtered = filtered.filter(t => t.parentTask === unbilledFilters.parentTask);
                        if (unbilledFilters.childTask) filtered = filtered.filter(t => t.childTask === unbilledFilters.childTask);
                        if (unbilledFilters.financialYear) filtered = filtered.filter(t => t.financialYear === unbilledFilters.financialYear);
                        if (unbilledFilters.period) filtered = filtered.filter(t => t.period === unbilledFilters.period);
                        if (unbilledFilters.status) {
                          filtered = filtered.filter(t => {
                            const ts = t.status === 'Completed' || t.completedCheck ? 'Completed' : t.status === 'In Progress' ? 'In Progress' : 'Open';
                            return ts === unbilledFilters.status;
                          });
                        }
                        if (unbilledFilters.reportingManager) filtered = filtered.filter(t => t.taskManager === unbilledFilters.reportingManager || t.taskLeader === unbilledFilters.reportingManager);
                        
                        if (filtered.length === 0) {
                          return <tr><td colSpan={13} style={{padding: '40px', textAlign: 'center', color: '#94a3b8', fontSize: '13px', background: '#f8fafc'}}>
                            No unbilled tasks found
                          </td></tr>;
                        }
                        
                        return filtered.map((task, idx) => {
                          const taskStatus = task.status === 'Completed' || task.completedCheck ? 'Completed' : task.status === 'In Progress' ? 'In Progress' : 'Open';
                          const isSelected = unbilledSelectedIds.includes(task.id);
                          const isEven = idx % 2 === 0;
                          return (
                          <tr 
                            key={task.id} 
                            style={{
                              borderBottom: '1px solid #e2e8f0', 
                              background: isSelected ? '#dcfce7' : isEven ? '#ffffff' : '#f8fafc'
                            }}
                          >
                            <td style={{padding: '10px 8px', borderRight: '1px solid #e2e8f0', textAlign: 'center'}}>
                              <input 
                                type="checkbox"
                                style={{width: '16px', height: '16px', cursor: 'pointer', accentColor: '#10b981'}}
                                checked={isSelected}
                                onChange={(e) => {
                                  setUnbilledSelectedIds(prev => 
                                    e.target.checked ? [...prev, task.id] : prev.filter(id => id !== task.id)
                                  );
                                }}
                              />
                            </td>
                            <td style={{padding: '10px 8px', textAlign: 'center', color: '#64748b', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{idx + 1}</td>
                            <td style={{padding: '10px 8px', fontWeight: '600', color: '#4f46e5', borderRight: '1px solid #e2e8f0', fontSize: '12px', fontFamily: 'monospace'}}>{task.fileNo || '-'}</td>
                            <td style={{padding: '10px 8px', fontWeight: '500', color: '#1e293b', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{task.clientName}</td>
                            <td style={{padding: '10px 8px', borderRight: '1px solid #e2e8f0', fontSize: '12px', color: '#166534', fontWeight: '500'}}>{task.parentTask}</td>
                            <td style={{padding: '10px 8px', color: '#475569', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{task.childTask}</td>
                            <td style={{padding: '10px 8px', color: '#64748b', borderRight: '1px solid #e2e8f0', fontSize: '11px', maxWidth: '200px', lineHeight: '1.4'}}>{task.taskDescription || '-'}</td>
                            <td style={{padding: '10px 8px', textAlign: 'center', color: '#475569', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{task.financialYear}</td>
                            <td style={{padding: '10px 8px', textAlign: 'center', color: '#475569', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{task.period}</td>
                            <td style={{padding: '10px 8px', color: '#475569', borderRight: '1px solid #e2e8f0', fontSize: '12px'}}>{task.taskManager || task.taskLeader || '-'}</td>
                            <td style={{padding: '10px 8px', textAlign: 'center', borderRight: '1px solid #e2e8f0'}}>
                              <span style={{
                                padding: '4px 10px', 
                                borderRadius: '12px', 
                                fontSize: '11px', 
                                fontWeight: '600',
                                background: taskStatus === 'Completed' ? '#dcfce7' : taskStatus === 'In Progress' ? '#fef3c7' : '#dbeafe',
                                color: taskStatus === 'Completed' ? '#166534' : taskStatus === 'In Progress' ? '#92400e' : '#1e40af'
                              }}>
                                {taskStatus}
                              </span>
                            </td>
                            <td style={{padding: '10px 8px', textAlign: 'right', fontWeight: '600', fontSize: '12px', color: '#0f172a', borderRight: '1px solid #e2e8f0'}}>
                              â‚¹{(parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || 0).toLocaleString('en-IN')}
                            </td>
                            <td style={{padding: '10px 8px', textAlign: 'center'}}>
                              <button
                                onClick={() => setViewingUnbilledTask(task)}
                                style={{padding: '6px 12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontWeight: '600'}}
                              >
                                View
                              </button>
                            </td>
                          </tr>
                        );});
                      })()}
                    </tbody>
                  </table>
                </div>
                
                {/* Table Footer with Count */}
                <div style={{
                  padding: '12px 20px', 
                  background: '#f8fafc', 
                  borderTop: '1px solid #e2e8f0',
                  borderRadius: '0 0 12px 12px',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <span style={{fontSize: '12px', color: '#64748b', fontWeight: '500'}}>
                    Showing {(() => {
                      const unbilledTasks = (data.tasks || []).filter(t => !t.billed && !t.markedFree);
                      let filtered = unbilledTasks;
                      if (unbilledFilters.clientName) filtered = filtered.filter(t => (t.clientName || '').toLowerCase().includes(unbilledFilters.clientName.toLowerCase()));
                      if (unbilledFilters.clientCode) filtered = filtered.filter(t => (t.fileNo || '').toLowerCase().includes(unbilledFilters.clientCode.toLowerCase()));
                      if (unbilledFilters.parentTask) filtered = filtered.filter(t => t.parentTask === unbilledFilters.parentTask);
                      if (unbilledFilters.childTask) filtered = filtered.filter(t => t.childTask === unbilledFilters.childTask);
                      if (unbilledFilters.financialYear) filtered = filtered.filter(t => t.financialYear === unbilledFilters.financialYear);
                      if (unbilledFilters.period) filtered = filtered.filter(t => t.period === unbilledFilters.period);
                      if (unbilledFilters.reportingManager) filtered = filtered.filter(t => t.taskManager === unbilledFilters.reportingManager || t.taskLeader === unbilledFilters.reportingManager);
                      return filtered.length;
                    })()} of {(data.tasks || []).filter(t => !t.billed && !t.markedFree).length} unbilled tasks
                  </span>
                  <span style={{fontSize: '12px', color: '#10b981', fontWeight: '600'}}>
                    Total Fees: â‚¹{(() => {
                      const unbilledTasks = (data.tasks || []).filter(t => !t.billed && !t.markedFree);
                      let filtered = unbilledTasks;
                      if (unbilledFilters.clientName) filtered = filtered.filter(t => (t.clientName || '').toLowerCase().includes(unbilledFilters.clientName.toLowerCase()));
                      if (unbilledFilters.clientCode) filtered = filtered.filter(t => (t.fileNo || '').toLowerCase().includes(unbilledFilters.clientCode.toLowerCase()));
                      if (unbilledFilters.parentTask) filtered = filtered.filter(t => t.parentTask === unbilledFilters.parentTask);
                      if (unbilledFilters.childTask) filtered = filtered.filter(t => t.childTask === unbilledFilters.childTask);
                      if (unbilledFilters.financialYear) filtered = filtered.filter(t => t.financialYear === unbilledFilters.financialYear);
                      if (unbilledFilters.period) filtered = filtered.filter(t => t.period === unbilledFilters.period);
                      if (unbilledFilters.reportingManager) filtered = filtered.filter(t => t.taskManager === unbilledFilters.reportingManager || t.taskLeader === unbilledFilters.reportingManager);
                      return filtered.reduce((sum, t) => sum + (parseFloat(t.agreedFees) || getClientAgreedFee(t.clientId, t.parentTask || t.taskType, t.childTask || t.subTask) || 0), 0).toLocaleString('en-IN');
                    })()}
                  </span>
                </div>
              </div>
            )}

            {/* Task View Modal */}
            {viewingUnbilledTask && (
              <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
                <div style={{background: '#fff', borderRadius: '12px', width: '600px', maxWidth: '95%', maxHeight: '90vh', overflow: 'auto'}}>
                  <div style={{padding: '16px 20px', borderBottom: '1px solid #e2e8f0', background: '#f8fafc', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>Task Details</h3>
                    <button onClick={() => setViewingUnbilledTask(null)} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px'}}><X size={20} /></button>
                  </div>
                  <div style={{padding: '20px'}}>
                    {/* Client Info */}
                    <div style={{marginBottom: '20px', padding: '16px', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #bae6fd'}}>
                      <div style={{fontSize: '11px', color: '#0369a1', fontWeight: '600', marginBottom: '8px'}}>CLIENT INFORMATION</div>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Client Name</div>
                          <div style={{fontSize: '14px', fontWeight: '600'}}>{viewingUnbilledTask.clientName}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Client Code</div>
                          <div style={{fontSize: '14px', fontWeight: '600', color: '#6366f1'}}>{viewingUnbilledTask.fileNo || '-'}</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Task Info */}
                    <div style={{marginBottom: '20px', padding: '16px', background: '#faf5ff', borderRadius: '8px', border: '1px solid #e9d5ff'}}>
                      <div style={{fontSize: '11px', color: '#7c3aed', fontWeight: '600', marginBottom: '8px'}}>TASK INFORMATION</div>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Parent Task</div>
                          <div style={{fontSize: '13px', fontWeight: '600', color: '#8b5cf6'}}>{viewingUnbilledTask.parentTask}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Child Task</div>
                          <div style={{fontSize: '13px', fontWeight: '600'}}>{viewingUnbilledTask.childTask}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Financial Year</div>
                          <div style={{fontSize: '13px', fontWeight: '500'}}>{viewingUnbilledTask.financialYear}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Period</div>
                          <div style={{fontSize: '13px', fontWeight: '500'}}>{viewingUnbilledTask.period || '-'}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Status</div>
                          <div>
                            <span style={{
                              padding: '3px 10px', 
                              borderRadius: '12px', 
                              fontSize: '11px', 
                              fontWeight: '600',
                              background: viewingUnbilledTask.status === 'Completed' || viewingUnbilledTask.completedCheck ? '#d1fae5' : viewingUnbilledTask.status === 'In Progress' ? '#fef3c7' : '#fee2e2',
                              color: viewingUnbilledTask.status === 'Completed' || viewingUnbilledTask.completedCheck ? '#065f46' : viewingUnbilledTask.status === 'In Progress' ? '#92400e' : '#991b1b'
                            }}>
                              {viewingUnbilledTask.status === 'Completed' || viewingUnbilledTask.completedCheck ? 'Completed' : viewingUnbilledTask.status || 'Open'}
                            </span>
                          </div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Assigned To</div>
                          <div style={{fontSize: '13px', fontWeight: '500'}}>{viewingUnbilledTask.assignedTo || '-'}</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Billing Info */}
                    <div style={{marginBottom: '20px', padding: '16px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #bbf7d0'}}>
                      <div style={{fontSize: '11px', color: '#166534', fontWeight: '600', marginBottom: '8px'}}>BILLING INFORMATION</div>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Agreed Fees</div>
                          <div style={{fontSize: '16px', fontWeight: '700', color: '#10b981'}}>â‚¹{(parseFloat(viewingUnbilledTask.agreedFees) || getClientAgreedFee(viewingUnbilledTask.clientId, viewingUnbilledTask.parentTask || viewingUnbilledTask.taskType, viewingUnbilledTask.childTask || viewingUnbilledTask.subTask) || 0).toLocaleString('en-IN')}</div>
                        </div>
                        <div>
                          <div style={{fontSize: '10px', color: '#64748b'}}>Govt. Fees</div>
                          <div style={{fontSize: '14px', fontWeight: '500'}}>â‚¹{(parseFloat(viewingUnbilledTask.govtFees) || 0).toLocaleString('en-IN')}</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Dates */}
                    {(viewingUnbilledTask.startDate || viewingUnbilledTask.dueDate) && (
                      <div style={{marginBottom: '20px', padding: '16px', background: '#fff7ed', borderRadius: '8px', border: '1px solid #fed7aa'}}>
                        <div style={{fontSize: '11px', color: '#c2410c', fontWeight: '600', marginBottom: '8px'}}>DATES</div>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                          {viewingUnbilledTask.startDate && (
                            <div>
                              <div style={{fontSize: '10px', color: '#64748b'}}>Start Date</div>
                              <div style={{fontSize: '13px', fontWeight: '500'}}>{new Date(viewingUnbilledTask.startDate).toLocaleDateString('en-IN')}</div>
                            </div>
                          )}
                          {viewingUnbilledTask.dueDate && (
                            <div>
                              <div style={{fontSize: '10px', color: '#64748b'}}>Due Date</div>
                              <div style={{fontSize: '13px', fontWeight: '500'}}>{new Date(viewingUnbilledTask.dueDate).toLocaleDateString('en-IN')}</div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {/* Notes */}
                    {viewingUnbilledTask.notes && (
                      <div style={{marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0'}}>
                        <div style={{fontSize: '11px', color: '#475569', fontWeight: '600', marginBottom: '8px'}}>NOTES</div>
                        <div style={{fontSize: '13px', color: '#334155'}}>{viewingUnbilledTask.notes}</div>
                      </div>
                    )}
                    
                    {/* Action Buttons */}
                    <div style={{display: 'flex', gap: '12px', justifyContent: 'flex-end', paddingTop: '12px', borderTop: '1px solid #e2e8f0'}}>
                      <button
                        onClick={() => {
                          setData(prev => ({
                            ...prev,
                            tasks: (prev.tasks || []).map(t => 
                              t.id === viewingUnbilledTask.id ? {...t, markedFree: true, freeMarkedAt: new Date().toISOString()} : t
                            )
                          }));
                          setViewingUnbilledTask(null);
                          alert('Task marked as FREE!');
                        }}
                        style={{padding: '10px 20px', background: '#f3e8ff', color: '#7c3aed', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                      >
                        Mark as Free
                      </button>
                      <button
                        onClick={() => setViewingUnbilledTask(null)}
                        style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Free Tasks List */}
            {unbilledTasksTab === 'free' && (
              <div style={{background: '#fff', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                <div style={{padding: '16px 20px', background: '#f3e8ff', borderBottom: '1px solid #c4b5fd', borderRadius: '12px 12px 0 0'}}>
                  <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600', color: '#6b21a8'}}>Tasks Marked as Free (No Billing)</h3>
                </div>
                <div style={{overflowX: 'auto'}}>
                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                    <thead>
                      <tr style={{background: '#f8fafc'}}>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>S.No</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client Code</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client Name</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Parent Task</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Child Task</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Fin. Year</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Period</th>
                        <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Marked Free On</th>
                        <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const freeTasks = (data.tasks || []).filter(t => t.markedFree === true);
                        
                        if (freeTasks.length === 0) {
                          return <tr><td colSpan={9} style={{padding: '40px', textAlign: 'center', color: '#64748b'}}>No tasks marked as free</td></tr>;
                        }
                        
                        return freeTasks.map((task, idx) => (
                          <tr key={task.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                            <td style={{padding: '12px'}}>{idx + 1}</td>
                            <td style={{padding: '12px', fontWeight: '500', color: '#6366f1'}}>{task.fileNo || '-'}</td>
                            <td style={{padding: '12px'}}>{task.clientName}</td>
                            <td style={{padding: '12px', fontSize: '11px', color: '#8b5cf6'}}>{task.parentTask}</td>
                            <td style={{padding: '12px', fontSize: '11px'}}>{task.childTask}</td>
                            <td style={{padding: '12px', fontSize: '11px'}}>{task.financialYear}</td>
                            <td style={{padding: '12px', fontSize: '11px'}}>{task.period}</td>
                            <td style={{padding: '12px', fontSize: '11px', color: '#64748b'}}>{task.freeMarkedAt ? new Date(task.freeMarkedAt).toLocaleDateString('en-IN') : '-'}</td>
                            <td style={{padding: '12px', textAlign: 'center'}}>
                              <div style={{display: 'flex', gap: '6px', justifyContent: 'center'}}>
                                <button
                                  onClick={() => setViewingUnbilledTask(task)}
                                  style={{padding: '4px 10px', background: '#eff6ff', color: '#2563eb', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', fontWeight: '500'}}
                                >
                                  View
                                </button>
                                <button
                                  onClick={() => {
                                    setData(prev => ({
                                      ...prev,
                                      tasks: (prev.tasks || []).map(t => 
                                        t.id === task.id ? {...t, markedFree: false, freeMarkedAt: null} : t
                                      )
                                    }));
                                    alert('Task moved back to Unbilled!');
                                  }}
                                  style={{padding: '4px 10px', background: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', fontWeight: '500'}}
                                >
                                  Restore
                                </button>
                              </div>
                            </td>
                          </tr>
                        ));
                      })()}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Generate Invoice Modal */}
            {showUnbilledInvoiceModal && (
              <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000}}>
                <div style={{background: '#fff', borderRadius: '12px', width: '95%', maxWidth: '1200px', maxHeight: '90vh', overflow: 'auto', border: '2px solid #10b981'}}>
                  {/* Green Header */}
                  <div style={{padding: '20px 24px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <h3 style={{margin: 0, fontSize: '18px', fontWeight: '700', color: '#fff', display: 'flex', alignItems: 'center', gap: '10px'}}>
                      <FileText size={22} />
                      Generate Invoice for {unbilledSelectedIds.length} Task(s)
                    </h3>
                    <button onClick={() => setShowUnbilledInvoiceModal(false)} style={{background: 'rgba(255,255,255,0.2)', border: 'none', cursor: 'pointer', borderRadius: '50%', padding: '6px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}><X size={20} color="#fff" /></button>
                  </div>
                  <div style={{padding: '24px'}}>
                    {/* Common Invoice Date */}
                    <div style={{marginBottom: '20px', display: 'flex', gap: '20px', alignItems: 'flex-end'}}>
                      <div>
                        <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#065f46'}}>Invoice Date *</label>
                        <input
                          type="date"
                          value={unbilledInvoiceDate}
                          onChange={(e) => setUnbilledInvoiceDate(e.target.value)}
                          style={{width: '180px', padding: '10px 12px', border: '2px solid #86efac', borderRadius: '8px', fontSize: '13px', background: '#f0fdf4'}}
                        />
                      </div>
                    </div>
                    
                    {/* Apply to All Row */}
                    <div style={{marginBottom: '16px', padding: '14px 16px', background: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)', borderRadius: '8px', border: '1px solid #86efac', display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap'}}>
                      <span style={{fontSize: '12px', fontWeight: '700', color: '#065f46'}}>âš¡ Quick Apply to All:</span>
                      <select
                        onChange={(e) => {
                          if (e.target.value) {
                            setUnbilledTaskDetails(prev => {
                              const updated = {...prev};
                              Object.keys(updated).forEach(id => {
                                updated[id] = {...updated[id], orgId: e.target.value};
                              });
                              return updated;
                            });
                          }
                        }}
                        style={{padding: '8px 12px', border: '2px solid #86efac', borderRadius: '6px', fontSize: '12px', minWidth: '200px', background: '#fff', color: '#065f46', fontWeight: '500'}}
                      >
                        <option value="">Select Organization for All</option>
                        {(data.organizations || []).map(org => (
                          <option key={org.id} value={org.id}>{org.name}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* Tasks Table with Individual Fields */}
                    <div style={{marginBottom: '20px'}}>
                      <div style={{border: '1px solid #e2e8f0', borderRadius: '10px', overflow: 'hidden'}}>
                        <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                          <thead>
                            <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                              <th style={{padding: '12px 10px', textAlign: 'center', fontWeight: '600', color: '#fff', width: '45px'}}>S.No</th>
                              <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', minWidth: '120px'}}>Client</th>
                              <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', minWidth: '120px'}}>Task</th>
                              <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', minWidth: '150px'}}>Task Description</th>
                              <th style={{padding: '12px 10px', textAlign: 'left', fontWeight: '600', color: '#fff', minWidth: '160px'}}>Organization *</th>
                              <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', width: '90px'}}>Agreed Fees</th>
                              <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', width: '110px'}}>Amount *</th>
                              <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', width: '100px'}}>GST (Auto)</th>
                              <th style={{padding: '12px 10px', textAlign: 'right', fontWeight: '600', color: '#fff', width: '100px'}}>Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            {(data.tasks || []).filter(t => unbilledSelectedIds.includes(t.id)).map((task, idx) => {
                              const taskDetail = unbilledTaskDetails[task.id] || {orgId: '', amount: 0, tax: 0};
                              const selectedOrg = (data.organizations || []).find(o => o.id === taskDetail.orgId);
                              const client = (data.clients || []).find(c => c.name === task.clientName);
                              
                              // Auto-calculate tax based on org GST settings
                              const amount = Number(taskDetail.amount) || 0;
                              const gstApplicable = selectedOrg?.gstApplicable === 'yes' || selectedOrg?.gstApplicable === true;
                              const calculatedTax = gstApplicable ? Math.round(amount * 0.18 * 100) / 100 : 0;
                              const rowTotal = amount + calculatedTax;
                              
                              // Determine GST type
                              const orgState = (selectedOrg?.state || '').toLowerCase().trim();
                              const clientState = (client?.state || '').toLowerCase().trim();
                              const isSameState = orgState && clientState && orgState === clientState;
                              const gstLabel = gstApplicable ? (isSameState ? 'CGST+SGST' : 'IGST 18%') : 'No GST';
                              
                              return (
                              <tr key={task.id} style={{borderBottom: '1px solid #e2e8f0', background: idx % 2 === 0 ? '#fff' : '#f8fafc'}}>
                                <td style={{padding: '10px', textAlign: 'center', color: '#64748b', fontWeight: '500'}}>{idx + 1}</td>
                                <td style={{padding: '10px'}}>
                                  <div style={{fontWeight: '600', fontSize: '12px', color: '#1e293b'}}>{task.clientName}</div>
                                  <div style={{fontSize: '11px', color: '#4f46e5', fontFamily: 'monospace'}}>{task.fileNo || '-'}</div>
                                </td>
                                <td style={{padding: '10px'}}>
                                  <div style={{color: '#166534', fontSize: '11px', fontWeight: '600'}}>{task.parentTask}</div>
                                  <div style={{fontSize: '11px', color: '#475569'}}>{task.childTask}</div>
                                  <div style={{fontSize: '10px', color: '#94a3b8'}}>{task.financialYear} â€¢ {task.period}</div>
                                </td>
                                <td style={{padding: '10px'}}>
                                  <div style={{fontSize: '11px', color: '#64748b', lineHeight: '1.4'}}>{task.taskDescription || '-'}</div>
                                </td>
                                <td style={{padding: '8px 10px'}}>
                                  <select
                                    value={taskDetail.orgId || ''}
                                    onChange={(e) => {
                                      setUnbilledTaskDetails(prev => ({
                                        ...prev, 
                                        [task.id]: {
                                          orgId: e.target.value,
                                          amount: prev[task.id]?.amount || 0,
                                          tax: prev[task.id]?.tax || 0
                                        }
                                      }));
                                    }}
                                    style={{width: '100%', padding: '8px 10px', border: '2px solid #e2e8f0', borderRadius: '6px', fontSize: '11px', background: taskDetail.orgId ? '#f0fdf4' : '#fff'}}
                                  >
                                    <option value="">Select Org</option>
                                    {(data.organizations || []).map(org => (
                                      <option key={org.id} value={org.id}>{org.name}</option>
                                    ))}
                                  </select>
                                </td>
                                <td style={{padding: '10px', textAlign: 'right', color: '#64748b', fontSize: '11px'}}>
                                  â‚¹{(parseFloat(task.agreedFees) || getClientAgreedFee(task.clientId, task.parentTask || task.taskType, task.childTask || task.subTask) || 0).toLocaleString('en-IN')}
                                </td>
                                <td style={{padding: '8px 10px'}}>
                                  <input
                                    type="number"
                                    value={taskDetail.amount}
                                    onChange={(e) => {
                                      setUnbilledTaskDetails(prev => ({
                                        ...prev, 
                                        [task.id]: {
                                          orgId: prev[task.id]?.orgId || '',
                                          amount: e.target.value,
                                          tax: prev[task.id]?.tax || 0
                                        }
                                      }));
                                    }}
                                    placeholder="0"
                                    style={{width: '100%', padding: '8px 10px', border: '2px solid #e2e8f0', borderRadius: '6px', fontSize: '12px', textAlign: 'right', background: taskDetail.amount > 0 ? '#f0fdf4' : '#fff'}}
                                  />
                                </td>
                                <td style={{padding: '10px', textAlign: 'right'}}>
                                  <div style={{fontSize: '12px', fontWeight: '600', color: gstApplicable ? '#059669' : '#94a3b8'}}>
                                    â‚¹{calculatedTax.toLocaleString('en-IN')}
                                  </div>
                                  <div style={{fontSize: '9px', color: '#64748b'}}>{gstLabel}</div>
                                </td>
                                <td style={{padding: '10px', textAlign: 'right', fontWeight: '700', color: '#10b981', fontSize: '13px'}}>
                                  â‚¹{rowTotal.toLocaleString('en-IN')}
                                </td>
                              </tr>
                            );})}
                          </tbody>
                          <tfoot>
                            {(() => {
                              // Calculate totals with auto-calculated tax
                              let totalAmount = 0;
                              let totalTax = 0;
                              
                              (data.tasks || []).filter(t => unbilledSelectedIds.includes(t.id)).forEach(task => {
                                const detail = unbilledTaskDetails[task.id] || {};
                                const org = (data.organizations || []).find(o => o.id === detail.orgId);
                                const amt = Number(detail.amount) || 0;
                                const gstApplicable = org?.gstApplicable === 'yes' || org?.gstApplicable === true;
                                const tax = gstApplicable ? Math.round(amt * 0.18 * 100) / 100 : 0;
                                totalAmount += amt;
                                totalTax += tax;
                              });
                              
                              return (
                                <tr style={{background: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)'}}>
                                  <td colSpan={6} style={{padding: '14px', textAlign: 'right', fontWeight: '700', color: '#065f46', fontSize: '13px'}}>Grand Total:</td>
                                  <td style={{padding: '14px', textAlign: 'right', fontWeight: '700', color: '#047857', fontSize: '14px'}}>
                                    â‚¹{totalAmount.toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', textAlign: 'right', fontWeight: '700', color: '#d97706', fontSize: '14px'}}>
                                    â‚¹{totalTax.toLocaleString('en-IN')}
                                  </td>
                                  <td style={{padding: '14px', textAlign: 'right', fontWeight: '700', color: '#10b981', fontSize: '16px'}}>
                                    â‚¹{(totalAmount + totalTax).toLocaleString('en-IN')}
                                  </td>
                                </tr>
                              );
                            })()}
                          </tfoot>
                        </table>
                      </div>
                    </div>
                    
                    <div style={{display: 'flex', gap: '12px', justifyContent: 'flex-end'}}>
                      <button
                        onClick={() => setShowUnbilledInvoiceModal(false)}
                        style={{padding: '12px 28px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', fontSize: '13px'}}
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          // Validate all tasks have organization and amount
                          const selectedTasks = (data.tasks || []).filter(t => unbilledSelectedIds.includes(t.id));
                          const missingOrg = selectedTasks.filter(t => !unbilledTaskDetails[t.id]?.orgId);
                          if (missingOrg.length > 0) {
                            alert('Please select organization for all tasks');
                            return;
                          }
                          
                          const missingAmount = selectedTasks.filter(t => {
                            const amt = Number(unbilledTaskDetails[t.id]?.amount);
                            return !amt || amt <= 0;
                          });
                          if (missingAmount.length > 0) {
                            alert('Please enter amount for all tasks');
                            return;
                          }
                          
                          // Group by client + organization combination
                          const invoiceGroups = {};
                          
                          selectedTasks.forEach(task => {
                            const detail = unbilledTaskDetails[task.id] || {};
                            const taskAmount = Number(detail.amount) || 0;
                            const org = (data.organizations || []).find(o => o.id === detail.orgId);
                            const gstApplicable = org?.gstApplicable === 'yes' || org?.gstApplicable === true;
                            const taskTax = gstApplicable ? Math.round(taskAmount * 0.18 * 100) / 100 : 0;
                            
                            const groupKey = `${task.clientName}___${detail.orgId}`;
                            if (!invoiceGroups[groupKey]) {
                              invoiceGroups[groupKey] = {
                                clientName: task.clientName,
                                orgId: detail.orgId,
                                tasks: []
                              };
                            }
                            invoiceGroups[groupKey].tasks.push({
                              ...task,
                              invoiceAmount: taskAmount,
                              taxAmount: taskTax
                            });
                          });
                          
                          const invoices = [];
                          const orgInvoiceNos = {}; // Track invoice numbers per org
                          
                          Object.values(invoiceGroups).forEach(group => {
                            const org = (data.organizations || []).find(o => o.id === group.orgId);
                            if (!org) return;
                            
                            const client = (data.clients || []).find(c => c.name === group.clientName);
                            const totalAmount = group.tasks.reduce((s, t) => s + t.invoiceAmount, 0);
                            const totalTax = group.tasks.reduce((s, t) => s + t.taxAmount, 0);
                            
                            // Calculate GST split based on org settings and state comparison
                            let cgst = 0, sgst = 0, igst = 0;
                            const gstApplicable = org.gstApplicable === 'yes' || org.gstApplicable === true;
                            
                            if (totalTax > 0) {
                              if (gstApplicable) {
                                const orgState = (org.state || '').toLowerCase().trim();
                                const clientState = (client?.state || '').toLowerCase().trim();
                                
                                if (orgState && clientState && orgState === clientState) {
                                  // Same state - split into CGST and SGST (50% each)
                                  cgst = Math.round(totalTax / 2 * 100) / 100;
                                  sgst = Math.round(totalTax / 2 * 100) / 100;
                                } else {
                                  // Different state or states not set - full IGST
                                  igst = totalTax;
                                }
                              } else {
                                // Non-GST org - still store tax as IGST for display
                                igst = totalTax;
                              }
                            }
                            
                            const grandTotal = totalAmount + totalTax;
                            
                            // Get next invoice number for this org
                            if (!orgInvoiceNos[org.id]) {
                              orgInvoiceNos[org.id] = org.invoiceCurrentNo || 1;
                            }
                            const currentNo = orgInvoiceNos[org.id];
                            const invNo = `${org.invoicePrefix || 'INV'}${String(currentNo).padStart(4, '0')}`;
                            orgInvoiceNos[org.id]++;
                            
                            // Build service description including task descriptions
                            const serviceDesc = group.tasks.map(t => {
                              const desc = t.taskDescription ? ` - ${t.taskDescription}` : '';
                              return `${t.parentTask} - ${t.childTask}${desc}`;
                            }).join('; ');
                            
                            invoices.push({
                              id: 'INV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                              invoiceNo: invNo,
                              invoiceDate: unbilledInvoiceDate,
                              invoiceCurrentNo: currentNo,
                              organizationId: org.id,
                              orgName: org.name,
                              orgAddress: org.address || '',
                              orgState: org.state || '',
                              orgGstin: org.gstin || '',
                              orgPan: org.panNo || '',
                              clientName: group.clientName,
                              clientCode: client?.fileNo || group.tasks[0]?.fileNo || '',
                              clientAddress: client?.address || '',
                              clientState: client?.state || '',
                              clientGstin: client?.gstin || '',
                              serviceDescription: serviceDesc,
                              taskDescription: group.tasks.map(t => t.taskDescription).filter(Boolean).join('; '),
                              parentTask: group.tasks[0]?.parentTask || '',
                              taskType: group.tasks[0]?.childTask || '',
                              financialYear: group.tasks[0]?.financialYear || '',
                              taskIds: group.tasks.map(t => t.id),
                              lineItems: group.tasks.map(t => ({
                                description: `${t.parentTask} - ${t.childTask} (${t.financialYear})${t.taskDescription ? ' - ' + t.taskDescription : ''}`,
                                amount: t.invoiceAmount,
                                tax: t.taxAmount
                              })),
                              amount: totalAmount,
                              netAmount: totalAmount,
                              gstApplicable: gstApplicable,
                              taxAmount: totalTax,
                              cgst: cgst,
                              sgst: sgst,
                              igst: igst,
                              totalAmount: grandTotal,
                              createdAt: new Date().toISOString(),
                              status: 'Generated'
                            });
                          });
                          
                          // Update state
                          const taskIdsToMark = selectedTasks.map(t => t.id);
                          const totalTaxGenerated = invoices.reduce((s, inv) => s + (inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0), 0);
                          const totalAmountGenerated = invoices.reduce((s, inv) => s + (inv.totalAmount || 0), 0);
                          
                          setData(prev => ({
                            ...prev,
                            invoices: [...(prev.invoices || []), ...invoices],
                            latestGeneratedInvoices: [...invoices, ...(prev.latestGeneratedInvoices || [])].slice(0, 50),
                            organizations: prev.organizations.map(o => 
                              orgInvoiceNos[o.id] ? {...o, invoiceCurrentNo: orgInvoiceNos[o.id]} : o
                            ),
                            tasks: (prev.tasks || []).map(t => 
                              taskIdsToMark.includes(t.id) ? {...t, billed: true, invoiceId: invoices.find(inv => inv.taskIds?.includes(t.id))?.id} : t
                            )
                          }));
                          
                          setShowUnbilledInvoiceModal(false);
                          setUnbilledSelectedIds([]);
                          setUnbilledTaskDetails({});
                          alert(`${invoices.length} invoice(s) generated successfully!\n\nTotal Amount: â‚¹${totalAmountGenerated.toLocaleString('en-IN')}\nTotal GST: â‚¹${totalTaxGenerated.toLocaleString('en-IN')}`);
                        }}
                        style={{padding: '12px 28px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '700', fontSize: '13px', boxShadow: '0 4px 12px rgba(16,185,129,0.4)'}}
                      >
                        âœ“ Generate Invoice(s)
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Receipts Tab */}
        {activeTab === 'receipts' && (
          <div>
            {/* Sub-tab Toggle */}
            <div style={{display: 'flex', gap: '12px', marginBottom: '24px'}}>
              <button
                onClick={() => setReceiptMode('post')}
                style={{
                  padding: '14px 28px',
                  background: receiptMode === 'post' ? '#10b981' : '#f1f5f9',
                  color: receiptMode === 'post' ? '#fff' : '#64748b',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px',
                  transition: 'all 0.2s'
                }}
              >
                ðŸ“ Post Receipts
              </button>
              <button
                onClick={() => setReceiptMode('view')}
                style={{
                  padding: '14px 28px',
                  background: receiptMode === 'view' ? '#3b82f6' : '#f1f5f9',
                  color: receiptMode === 'view' ? '#fff' : '#64748b',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px',
                  transition: 'all 0.2s'
                }}
              >
                ðŸ“‹ View Receipts
              </button>
            </div>

            {/* POST RECEIPTS MODE */}
            {receiptMode === 'post' && (
              <div>
                {/* Step 1: Filters */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '24px', marginBottom: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                  <h3 style={{margin: '0 0 20px 0', fontSize: '16px', fontWeight: '600', color: '#1e293b'}}>Step 1: Select Clients</h3>
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr auto', gap: '16px', alignItems: 'end'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>Group No.</label>
                      <select
                        value={receiptFilters.groupName}
                        onChange={(e) => { setReceiptFilters({...receiptFilters, groupName: e.target.value}); setSelectedClientsForReceipt([]); }}
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '14px', background: '#fff'}}
                      >
                        <option value="">All Groups</option>
                        {[...new Set(data.clients.map(c => c.groupName).filter(Boolean))].sort().map(g => 
                          <option key={g} value={g}>{g}</option>
                        )}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>Client Name</label>
                      <input
                        type="text"
                        value={receiptFilters.clientName}
                        onChange={(e) => { setReceiptFilters({...receiptFilters, clientName: e.target.value}); setSelectedClientsForReceipt([]); }}
                        placeholder="Search client..."
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '14px'}}
                      />
                    </div>
                    <button
                      onClick={() => { setReceiptFilters({groupName: '', clientName: '', fromDate: '', toDate: ''}); setSelectedClientsForReceipt([]); }}
                      style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '500'}}
                    >
                      Reset
                    </button>
                  </div>
                </div>

                {/* Client Selection - Only show if no clients selected yet */}
                {selectedClientsForReceipt.length === 0 && (
                  <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', marginBottom: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                    <div style={{padding: '16px 24px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0'}}>
                      <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600', color: '#1e293b'}}>
                        Clients with Pending Invoices ({(() => {
                          const clients = {};
                          (data.invoices || []).forEach(inv => {
                            if (!inv.clientName) return;
                            const paid = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((s, r) => s + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                            const due = (inv.totalAmount || 0) - paid;
                            if (due > 0.01) {
                              if (!clients[inv.clientName]) clients[inv.clientName] = { count: 0, total: 0 };
                              clients[inv.clientName].count++;
                              clients[inv.clientName].total += due;
                            }
                          });
                          let filtered = Object.entries(clients);
                          if (receiptFilters.groupName) {
                            filtered = filtered.filter(([name]) => {
                              const client = data.clients.find(c => c.name === name);
                              return client?.groupName?.toLowerCase().includes(receiptFilters.groupName.toLowerCase());
                            });
                          }
                          if (receiptFilters.clientName) {
                            filtered = filtered.filter(([name]) => name.toLowerCase().includes(receiptFilters.clientName.toLowerCase()));
                          }
                          return filtered.length;
                        })()})
                      </h3>
                    </div>
                    <div style={{maxHeight: '400px', overflow: 'auto'}}>
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                        <thead>
                          <tr style={{background: '#f8fafc', position: 'sticky', top: 0}}>
                            <th style={{padding: '12px 16px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0', width: '50px'}}>Select</th>
                            <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Client Name</th>
                            <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>File No</th>
                            <th style={{padding: '12px 16px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Group</th>
                            <th style={{padding: '12px 16px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Invoices</th>
                            <th style={{padding: '12px 16px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(() => {
                            const clientsData = {};
                            (data.invoices || []).forEach(inv => {
                              if (!inv.clientName) return;
                              const paid = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((s, r) => s + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                              const due = (inv.totalAmount || 0) - paid;
                              if (due > 0.01) {
                                if (!clientsData[inv.clientName]) {
                                  const client = data.clients.find(c => c.name?.toLowerCase() === inv.clientName?.toLowerCase());
                                  clientsData[inv.clientName] = {
                                    name: inv.clientName,
                                    code: inv.clientCode || client?.fileNo || '',
                                    group: inv.clientGroup || client?.groupName || '',
                                    count: 0,
                                    total: 0
                                  };
                                }
                                clientsData[inv.clientName].count++;
                                clientsData[inv.clientName].total += due;
                              }
                            });
                            let filtered = Object.values(clientsData);
                            if (receiptFilters.groupName) {
                              filtered = filtered.filter(c => c.group?.toLowerCase().includes(receiptFilters.groupName.toLowerCase()));
                            }
                            if (receiptFilters.clientName) {
                              filtered = filtered.filter(c => c.name?.toLowerCase().includes(receiptFilters.clientName.toLowerCase()));
                            }
                            if (filtered.length === 0) {
                              return (
                                <tr>
                                  <td colSpan={6} style={{padding: '40px', textAlign: 'center', color: '#64748b'}}>
                                    No clients with pending invoices found
                                  </td>
                                </tr>
                              );
                            }
                            return filtered.map((client, idx) => (
                              <tr key={idx} style={{borderBottom: '1px solid #f1f5f9', cursor: 'pointer'}} onClick={() => setSelectedClientsForReceipt([client.name])}>
                                <td style={{padding: '12px 16px', textAlign: 'center'}}>
                                  <input type="checkbox" checked={selectedClientsForReceipt.includes(client.name)} onChange={() => {}} />
                                </td>
                                <td style={{padding: '12px 16px', fontWeight: '500'}}>{client.name}</td>
                                <td style={{padding: '12px 16px', color: '#64748b'}}>{client.code}</td>
                                <td style={{padding: '12px 16px', color: '#64748b'}}>{client.group}</td>
                                <td style={{padding: '12px 16px', textAlign: 'center'}}>
                                  <span style={{padding: '4px 12px', background: '#fef3c7', color: '#92400e', borderRadius: '12px', fontSize: '12px', fontWeight: '600'}}>{client.count}</span>
                                </td>
                                <td style={{padding: '12px 16px', textAlign: 'right', fontWeight: '600', color: '#dc2626'}}>â‚¹{client.total.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                              </tr>
                            ));
                          })()}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Step 2: Enter Receipt Details - Show when client selected */}
                {selectedClientsForReceipt.length > 0 && (
                  <div>
                    {/* Receipt Header */}
                    <div style={{background: '#ecfdf5', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #a7f3d0'}}>
                      <h3 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#065f46'}}>Step 2: Receipt Details</h3>
                      <div style={{display: 'grid', gridTemplateColumns: '200px 1fr', gap: '16px'}}>
                        <div>
                          <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#065f46'}}>Receipt Date</label>
                          <input
                            type="date"
                            value={receiptFormData.receiptDate}
                            onChange={(e) => setReceiptFormData({...receiptFormData, receiptDate: e.target.value})}
                            style={{width: '100%', padding: '10px 12px', border: '1px solid #a7f3d0', borderRadius: '8px', fontSize: '14px', background: '#fff'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#065f46'}}>Narration</label>
                          <input
                            type="text"
                            value={receiptFormData.narration}
                            onChange={(e) => setReceiptFormData({...receiptFormData, narration: e.target.value})}
                            placeholder="Enter narration..."
                            style={{width: '100%', padding: '10px 12px', border: '1px solid #a7f3d0', borderRadius: '8px', fontSize: '14px'}}
                          />
                        </div>
                      </div>
                    </div>

                    {/* Invoice Table */}
                    {selectedClientsForReceipt.map(clientName => {
                      const clientInvoices = (data.invoices || []).filter(inv => {
                        if (inv.clientName !== clientName) return false;
                        const paid = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((s, r) => s + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                        return (inv.totalAmount || 0) - paid > 0.01;
                      }).map(inv => {
                        const paid = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((s, r) => s + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                        return { ...inv, paidAmount: paid, dueAmount: (inv.totalAmount || 0) - paid };
                      });
                      const client = data.clients.find(c => c.name?.toLowerCase() === clientName.toLowerCase());
                      
                      return (
                        <div key={clientName} style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', marginBottom: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                          <div style={{padding: '16px 24px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                              <div>
                                <h4 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>{clientName}</h4>
                                <div style={{fontSize: '12px', opacity: 0.9, marginTop: '4px'}}>File No: {client?.fileNo || 'N/A'} | Group: {client?.groupName || 'N/A'}</div>
                              </div>
                              <div style={{textAlign: 'right'}}>
                                <div style={{fontSize: '11px', opacity: 0.9}}>Total Due</div>
                                <div style={{fontSize: '20px', fontWeight: '700'}}>â‚¹{clientInvoices.reduce((s, i) => s + i.dueAmount, 0).toLocaleString('en-IN')}</div>
                              </div>
                            </div>
                          </div>
                          <div style={{overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead>
                                <tr style={{background: '#f8fafc'}}>
                                  <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Sr.No</th>
                                  <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Bill Date</th>
                                  <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Fin.Year</th>
                                  <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Bill No</th>
                                  <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Bill Amount</th>
                                  <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Narration</th>
                                  <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Due Amount</th>
                                  <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Receipt Amt</th>
                                  <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>TDS</th>
                                  <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Discount</th>
                                  <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>Mode</th>
                                  <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', borderBottom: '2px solid #e2e8f0'}}>View</th>
                                </tr>
                              </thead>
                              <tbody>
                                {clientInvoices.map((inv, idx) => (
                                  <tr key={inv.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '10px 12px'}}>{idx + 1}</td>
                                    <td style={{padding: '10px 12px'}}>{inv.invoiceDate ? new Date(inv.invoiceDate).toLocaleDateString('en-IN') : '-'}</td>
                                    <td style={{padding: '10px 12px'}}>{inv.financialYear || '-'}</td>
                                    <td style={{padding: '10px 12px', fontWeight: '500', color: '#3b82f6'}}>{inv.invoiceNo}</td>
                                    <td style={{padding: '10px 12px', textAlign: 'right'}}>{inv.totalAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                    <td style={{padding: '10px 12px', maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{inv.serviceDescription || '-'}</td>
                                    <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#dc2626'}}>{inv.dueAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                    <td style={{padding: '8px 6px'}}>
                                      <input
                                        type="number"
                                        value={invoiceReceiptAmounts[inv.id]?.receiptAmount || ''}
                                        onChange={(e) => setInvoiceReceiptAmounts(prev => ({...prev, [inv.id]: {...prev[inv.id], receiptAmount: e.target.value}}))}
                                        placeholder="0.00"
                                        style={{width: '85px', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px', textAlign: 'right'}}
                                      />
                                    </td>
                                    <td style={{padding: '8px 6px'}}>
                                      <input
                                        type="number"
                                        value={invoiceReceiptAmounts[inv.id]?.tds || ''}
                                        onChange={(e) => setInvoiceReceiptAmounts(prev => ({...prev, [inv.id]: {...prev[inv.id], tds: e.target.value}}))}
                                        placeholder="0.00"
                                        style={{width: '65px', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px', textAlign: 'right'}}
                                      />
                                    </td>
                                    <td style={{padding: '8px 6px'}}>
                                      <input
                                        type="number"
                                        value={invoiceReceiptAmounts[inv.id]?.discount || ''}
                                        onChange={(e) => setInvoiceReceiptAmounts(prev => ({...prev, [inv.id]: {...prev[inv.id], discount: e.target.value}}))}
                                        placeholder="0.00"
                                        style={{width: '65px', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px', textAlign: 'right'}}
                                      />
                                    </td>
                                    <td style={{padding: '8px 6px'}}>
                                      <select
                                        value={invoiceReceiptAmounts[inv.id]?.paymentMode || 'Cash'}
                                        onChange={(e) => setInvoiceReceiptAmounts(prev => ({...prev, [inv.id]: {...prev[inv.id], paymentMode: e.target.value}}))}
                                        style={{width: '75px', padding: '6px 4px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px'}}
                                      >
                                        <option value="Cash">Cash</option>
                                        <option value="Bank">Bank</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Cheque">Cheque</option>
                                      </select>
                                    </td>
                                    <td style={{padding: '8px 6px', textAlign: 'center'}}>
                                      <button
                                        onClick={() => { setViewingInvoice(inv); setDebtorViewMode('invoice'); setSelectedInvoicingTab('debtors'); }}
                                        style={{padding: '4px 8px', background: '#e0f2fe', color: '#0369a1', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                      >
                                        <Eye size={14} />
                                      </button>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      );
                    })}

                    {/* Totals & Submit */}
                    <div style={{background: '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div style={{display: 'flex', gap: '32px'}}>
                          <div>
                            <div style={{fontSize: '12px', color: '#64748b'}}>Total Receipt</div>
                            <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>
                              â‚¹{Object.values(invoiceReceiptAmounts).reduce((s, a) => s + parseFloat(a?.receiptAmount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                            </div>
                          </div>
                          <div>
                            <div style={{fontSize: '12px', color: '#64748b'}}>Total TDS</div>
                            <div style={{fontSize: '20px', fontWeight: '700', color: '#f59e0b'}}>
                              â‚¹{Object.values(invoiceReceiptAmounts).reduce((s, a) => s + parseFloat(a?.tds || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                            </div>
                          </div>
                          <div>
                            <div style={{fontSize: '12px', color: '#64748b'}}>Total Discount</div>
                            <div style={{fontSize: '20px', fontWeight: '700', color: '#3b82f6'}}>
                              â‚¹{Object.values(invoiceReceiptAmounts).reduce((s, a) => s + parseFloat(a?.discount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                            </div>
                          </div>
                        </div>
                        <div style={{display: 'flex', gap: '12px'}}>
                          <button
                            onClick={() => { setSelectedClientsForReceipt([]); setInvoiceReceiptAmounts({}); }}
                            style={{padding: '12px 24px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '500'}}
                          >
                            â† Back
                          </button>
                          <button
                            onClick={() => {
                              const newReceipts = [];
                              // Get next receipt number based on existing receipts
                              let counter = (data.receipts || []).length + 1;
                              
                              selectedClientsForReceipt.forEach(clientName => {
                                const clientInvoices = (data.invoices || []).filter(inv => inv.clientName === clientName);
                                const client = data.clients.find(c => c.name?.toLowerCase() === clientName.toLowerCase());
                                
                                clientInvoices.forEach(inv => {
                                  const amounts = invoiceReceiptAmounts[inv.id];
                                  if (!amounts) return;
                                  const amt = parseFloat(amounts.receiptAmount || 0);
                                  const tds = parseFloat(amounts.tds || 0);
                                  const disc = parseFloat(amounts.discount || 0);
                                  
                                  if (amt > 0 || tds > 0 || disc > 0) {
                                    newReceipts.push({
                                      id: Date.now().toString() + Math.random().toString(36).substr(2, 9) + counter,
                                      receiptNo: 'RCP' + String(counter).padStart(4, '0'),
                                      receiptDate: receiptFormData.receiptDate,
                                      clientName: clientName,
                                      clientCode: client?.fileNo || '',
                                      groupName: client?.groupName || '',
                                      invoiceId: inv.id,
                                      invoiceNo: inv.invoiceNo,
                                      invoiceAmount: inv.totalAmount,
                                      amount: amt,
                                      tds: tds,
                                      discount: disc,
                                      totalSettled: amt + tds + disc,
                                      narration: receiptFormData.narration,
                                      paymentMode: amounts.paymentMode || 'Cash',
                                      finYear: inv.financialYear,
                                      serviceDescription: inv.serviceDescription,
                                      createdAt: new Date().toISOString()
                                    });
                                    counter++;
                                  }
                                });
                              });
                              
                              if (newReceipts.length === 0) { alert('Please enter receipt amounts'); return; }
                              
                              setData(prev => ({
                                ...prev,
                                receipts: [...(prev.receipts || []), ...newReceipts]
                              }));
                              
                              setGeneratedReceipts(newReceipts);
                              setShowReceiptSummary(true);
                              setSelectedClientsForReceipt([]);
                              setInvoiceReceiptAmounts({});
                            }}
                            style={{padding: '12px 32px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '600'}}
                          >
                            âœ“ Submit Receipts
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Success Summary */}
                {showReceiptSummary && (
                  <div style={{background: '#fff', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center'}}>
                    <div style={{width: '64px', height: '64px', background: '#dcfce7', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px'}}>
                      <Check size={32} style={{color: '#16a34a'}} />
                    </div>
                    <h2 style={{margin: '0 0 8px', color: '#16a34a'}}>Receipts Posted Successfully!</h2>
                    <p style={{color: '#64748b', marginBottom: '24px'}}>{generatedReceipts.length} receipt(s) posted</p>
                    
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px', marginBottom: '24px', textAlign: 'left'}}>
                      <thead>
                        <tr style={{background: '#f8fafc'}}>
                          <th style={{padding: '12px', borderBottom: '2px solid #e2e8f0'}}>Receipt No</th>
                          <th style={{padding: '12px', borderBottom: '2px solid #e2e8f0'}}>Client</th>
                          <th style={{padding: '12px', borderBottom: '2px solid #e2e8f0'}}>Invoice No</th>
                          <th style={{padding: '12px', textAlign: 'right', borderBottom: '2px solid #e2e8f0'}}>Amount</th>
                          <th style={{padding: '12px', borderBottom: '2px solid #e2e8f0'}}>Mode</th>
                        </tr>
                      </thead>
                      <tbody>
                        {generatedReceipts.map((r, i) => (
                          <tr key={i} style={{borderBottom: '1px solid #f1f5f9'}}>
                            <td style={{padding: '12px', fontWeight: '600', color: '#10b981'}}>{r.receiptNo}</td>
                            <td style={{padding: '12px'}}>{r.clientName}</td>
                            <td style={{padding: '12px', color: '#3b82f6'}}>{r.invoiceNo}</td>
                            <td style={{padding: '12px', textAlign: 'right', fontWeight: '600'}}>â‚¹{r.amount?.toLocaleString('en-IN')}</td>
                            <td style={{padding: '12px'}}>{r.paymentMode}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    
                    <div style={{display: 'flex', gap: '12px', justifyContent: 'center'}}>
                      <button onClick={() => { setShowReceiptSummary(false); setGeneratedReceipts([]); }} style={{padding: '12px 24px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '8px', cursor: 'pointer'}}>Post More</button>
                      <button onClick={() => setReceiptMode('view')} style={{padding: '12px 24px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer'}}>View All Receipts</button>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* VIEW RECEIPTS MODE */}
            {receiptMode === 'view' && (
              <div>
                {/* Filters */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>Group No.</label>
                      <select value={receiptFilters.groupName} onChange={(e) => setReceiptFilters({...receiptFilters, groupName: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}}>
                        <option value="">All Groups</option>
                        {[...new Set((data.receipts || []).map(r => r.groupName).filter(Boolean))].map(g => <option key={g} value={g}>{g}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>Client Name</label>
                      <input type="text" value={receiptFilters.clientName} onChange={(e) => setReceiptFilters({...receiptFilters, clientName: e.target.value})} placeholder="Search..." style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>From Date</label>
                      <input type="date" value={receiptFilters.fromDate} onChange={(e) => setReceiptFilters({...receiptFilters, fromDate: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#64748b'}}>To Date</label>
                      <input type="date" value={receiptFilters.toDate} onChange={(e) => setReceiptFilters({...receiptFilters, toDate: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                    </div>
                    <div style={{display: 'flex', alignItems: 'flex-end'}}>
                      <button onClick={() => setReceiptFilters({groupName: '', clientName: '', fromDate: '', toDate: ''})} style={{width: '100%', padding: '10px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer'}}>Reset</button>
                    </div>
                  </div>
                </div>

                {/* Receipts Table */}
                <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.06)'}}>
                  <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                    <thead>
                      <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Receipt No</th>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Date</th>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client</th>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Group</th>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Invoice No</th>
                        <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>View Receipt</th>
                        <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Amount</th>
                        <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>TDS</th>
                        <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Mode</th>
                        <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        let receipts = data.receipts || [];
                        if (receiptFilters.groupName) receipts = receipts.filter(r => r.groupName?.toLowerCase().includes(receiptFilters.groupName.toLowerCase()));
                        if (receiptFilters.clientName) receipts = receipts.filter(r => r.clientName?.toLowerCase().includes(receiptFilters.clientName.toLowerCase()));
                        if (receiptFilters.fromDate) receipts = receipts.filter(r => new Date(r.receiptDate) >= new Date(receiptFilters.fromDate));
                        if (receiptFilters.toDate) receipts = receipts.filter(r => new Date(r.receiptDate) <= new Date(receiptFilters.toDate));
                        receipts = receipts.sort((a, b) => new Date(b.receiptDate) - new Date(a.receiptDate));
                        
                        if (receipts.length === 0) {
                          return <tr><td colSpan={10} style={{padding: '60px', textAlign: 'center', color: '#64748b'}}>No receipts found</td></tr>;
                        }
                        return receipts.map(r => {
                          return (
                            <tr key={r.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                              <td style={{padding: '14px 16px', fontWeight: '600', color: '#10b981'}}>{r.receiptNo}</td>
                              <td style={{padding: '14px 16px'}}>{r.receiptDate ? new Date(r.receiptDate).toLocaleDateString('en-IN') : '-'}</td>
                              <td style={{padding: '14px 16px', fontWeight: '500'}}>{r.clientName}</td>
                              <td style={{padding: '14px 16px', color: '#64748b'}}>{r.groupName || '-'}</td>
                              <td style={{padding: '14px 16px', color: '#3b82f6'}}>{r.invoiceNo}</td>
                              <td style={{padding: '14px 16px', textAlign: 'center'}}>
                                <button
                                  onClick={() => setViewingReceipt(r)}
                                  style={{padding: '4px 10px', background: '#dcfce7', color: '#166534', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                >
                                  <Eye size={14} />
                                </button>
                              </td>
                              <td style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600'}}>â‚¹{r.amount?.toLocaleString('en-IN')}</td>
                              <td style={{padding: '14px 16px', textAlign: 'right', color: '#64748b'}}>{r.tds > 0 ? `â‚¹${r.tds}` : '-'}</td>
                              <td style={{padding: '14px 16px'}}>{r.paymentMode}</td>
                              <td style={{padding: '14px 16px', textAlign: 'center'}}>
                                <button onClick={() => { setEditingReceipt({...r}); setShowEditReceiptModal(true); }} style={{padding: '6px 12px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', marginRight: '6px'}}>Edit</button>
                                <button onClick={() => { if (window.confirm('Delete this receipt?')) setData(prev => ({...prev, receipts: prev.receipts.filter(x => x.id !== r.id)})); }} style={{padding: '6px 12px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}>Delete</button>
                              </td>
                            </tr>
                          );
                        });
                      })()}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Edit Receipt Modal */}
            {showEditReceiptModal && editingReceipt && (
              <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000}}>
                <div style={{background: '#fff', borderRadius: '12px', width: '450px', padding: '24px'}}>
                  <h3 style={{margin: '0 0 20px'}}>Edit Receipt - {editingReceipt.receiptNo}</h3>
                  <div style={{display: 'grid', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>Receipt Date</label>
                      <input type="date" value={editingReceipt.receiptDate} onChange={(e) => setEditingReceipt({...editingReceipt, receiptDate: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                    </div>
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px'}}>
                      <div>
                        <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>Amount</label>
                        <input type="number" value={editingReceipt.amount} onChange={(e) => setEditingReceipt({...editingReceipt, amount: parseFloat(e.target.value) || 0})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                      </div>
                      <div>
                        <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>TDS</label>
                        <input type="number" value={editingReceipt.tds} onChange={(e) => setEditingReceipt({...editingReceipt, tds: parseFloat(e.target.value) || 0})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                      </div>
                      <div>
                        <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>Discount</label>
                        <input type="number" value={editingReceipt.discount} onChange={(e) => setEditingReceipt({...editingReceipt, discount: parseFloat(e.target.value) || 0})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                      </div>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>Payment Mode</label>
                      <select value={editingReceipt.paymentMode} onChange={(e) => setEditingReceipt({...editingReceipt, paymentMode: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}}>
                        <option value="Cash">Cash</option>
                        <option value="Bank">Bank</option>
                        <option value="UPI">UPI</option>
                        <option value="Cheque">Cheque</option>
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', marginBottom: '6px'}}>Narration</label>
                      <input type="text" value={editingReceipt.narration || ''} onChange={(e) => setEditingReceipt({...editingReceipt, narration: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px'}} />
                    </div>
                  </div>
                  <div style={{display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px'}}>
                    <button onClick={() => { setShowEditReceiptModal(false); setEditingReceipt(null); }} style={{padding: '10px 20px', background: '#f1f5f9', color: '#64748b', border: 'none', borderRadius: '6px', cursor: 'pointer'}}>Cancel</button>
                    <button onClick={() => { setData(prev => ({...prev, receipts: prev.receipts.map(r => r.id === editingReceipt.id ? editingReceipt : r)})); setShowEditReceiptModal(false); setEditingReceipt(null); }} style={{padding: '10px 20px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer'}}>Save</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
        {/* Debtors Tab */}
        {activeTab === 'debtors' && (
          <div>
            {/* Debtors List View */}
            {debtorViewMode === 'list' && (
              <>
                {/* Summary Cards */}
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '20px'}}>
                  <div style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', padding: '20px', borderRadius: '12px', color: '#fff'}}>
                    <div style={{fontSize: '12px', opacity: 0.9, marginBottom: '4px'}}>Total Debtors</div>
                    <div style={{fontSize: '32px', fontWeight: '700'}}>{getAllDebtors().length}</div>
                  </div>
                  <div style={{background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', padding: '20px', borderRadius: '12px', color: '#fff'}}>
                    <div style={{fontSize: '12px', opacity: 0.9, marginBottom: '4px'}}>Total Outstanding</div>
                    <div style={{fontSize: '32px', fontWeight: '700'}}>
                      â‚¹{getAllDebtors().reduce((sum, d) => sum + Math.max(0, d.balance), 0).toLocaleString('en-IN')}
                    </div>
                  </div>
                  <div style={{background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', padding: '20px', borderRadius: '12px', color: '#fff'}}>
                    <div style={{fontSize: '12px', opacity: 0.9, marginBottom: '4px'}}>With Pending Balance</div>
                    <div style={{fontSize: '32px', fontWeight: '700'}}>
                      {getAllDebtors().filter(d => d.balance > 0).length}
                    </div>
                  </div>
                  <div style={{background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', padding: '20px', borderRadius: '12px', color: '#fff'}}>
                    <div style={{fontSize: '12px', opacity: 0.9, marginBottom: '4px'}}>Fully Paid</div>
                    <div style={{fontSize: '32px', fontWeight: '700'}}>
                      {getAllDebtors().filter(d => d.balance <= 0).length}
                    </div>
                  </div>
                </div>
                
                {/* Filters Section */}
                <div style={{background: '#fff', borderRadius: '12px', padding: '20px', marginBottom: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', alignItems: 'flex-end'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Client Name</label>
                      <input
                        type="text"
                        value={debtorFilters.clientName}
                        onChange={(e) => setDebtorFilters({...debtorFilters, clientName: e.target.value})}
                        placeholder="Search by name..."
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Client Code</label>
                      <input
                        type="text"
                        value={debtorFilters.clientCode}
                        onChange={(e) => setDebtorFilters({...debtorFilters, clientCode: e.target.value})}
                        placeholder="Search by code..."
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Group No.</label>
                      <input
                        type="text"
                        value={debtorFilters.groupName}
                        onChange={(e) => setDebtorFilters({...debtorFilters, groupName: e.target.value})}
                        placeholder="Search by group..."
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Balance Status</label>
                      <select
                        value={debtorFilters.balanceType}
                        onChange={(e) => setDebtorFilters({...debtorFilters, balanceType: e.target.value})}
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      >
                        <option value="all">All Debtors</option>
                        <option value="pending">Pending Balance</option>
                        <option value="cleared">Cleared</option>
                      </select>
                    </div>
                    <div>
                      <button
                        onClick={resetDebtorFilters}
                        style={{
                          padding: '10px 20px',
                          background: '#f1f5f9',
                          color: '#64748b',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '500',
                          width: '100%'
                        }}
                      >
                        Reset Filters
                      </button>
                    </div>
                  </div>
                </div>
                
                {/* Debtors Table */}
                <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                  <div style={{overflowX: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '13px'}}>
                      <thead>
                        <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                          <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client Name</th>
                          <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Client Code</th>
                          <th style={{padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: '#fff'}}>Group No.</th>
                          <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Invoices</th>
                          <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Total Billed</th>
                          <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Received</th>
                          <th style={{padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: '#fff'}}>Balance</th>
                          <th style={{padding: '14px 16px', textAlign: 'center', fontWeight: '600', color: '#fff'}}>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {getAllDebtors().length === 0 ? (
                          <tr>
                            <td colSpan={8} style={{padding: '60px', textAlign: 'center', color: '#64748b'}}>
                              <Users size={48} style={{marginBottom: '16px', opacity: 0.5}} />
                              <div style={{fontSize: '16px', fontWeight: '500'}}>No debtors found</div>
                              <div style={{fontSize: '13px', marginTop: '8px'}}>Create invoices to see debtors here</div>
                            </td>
                          </tr>
                        ) : (
                          getAllDebtors().map((debtor, idx) => (
                            <tr 
                              key={idx} 
                              style={{borderBottom: '1px solid #f1f5f9'}}
                              onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                              onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                            >
                              <td style={{padding: '14px 16px', fontWeight: '500'}}>{debtor.clientName}</td>
                              <td style={{padding: '14px 16px', color: '#64748b'}}>{debtor.clientCode || '-'}</td>
                              <td style={{padding: '14px 16px', color: '#64748b'}}>{debtor.groupName || '-'}</td>
                              <td style={{padding: '14px 16px', textAlign: 'center'}}>
                                <span style={{
                                  padding: '4px 12px',
                                  background: '#e0f2fe',
                                  color: '#0369a1',
                                  borderRadius: '20px',
                                  fontSize: '12px',
                                  fontWeight: '600'
                                }}>
                                  {debtor.invoiceCount}
                                </span>
                              </td>
                              <td style={{padding: '14px 16px', textAlign: 'right', fontWeight: '500'}}>
                                â‚¹{debtor.totalInvoiced.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                              </td>
                              <td style={{padding: '14px 16px', textAlign: 'right', color: '#10b981', fontWeight: '500'}}>
                                â‚¹{debtor.totalReceived.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                              </td>
                              <td style={{padding: '14px 16px', textAlign: 'right'}}>
                                <span style={{
                                  padding: '4px 12px',
                                  background: debtor.balance > 0 ? '#fef2f2' : '#f0fdf4',
                                  color: debtor.balance > 0 ? '#dc2626' : '#16a34a',
                                  borderRadius: '6px',
                                  fontWeight: '700',
                                  fontSize: '13px'
                                }}>
                                  â‚¹{debtor.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                </span>
                              </td>
                              <td style={{padding: '14px 16px', textAlign: 'center'}}>
                                <button
                                  onClick={() => openDebtorLedger(debtor)}
                                  style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                  }}
                                >
                                  View Ledger â†’
                                </button>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            )}
            
            {/* Debtor Ledger Screen */}
            {debtorViewMode === 'ledger' && selectedDebtor && (
              <div>
                {/* Header with Back Button */}
                <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px'}}>
                  <button
                    onClick={goBackToDebtorsList}
                    style={{
                      padding: '10px 16px',
                      background: '#f1f5f9',
                      border: 'none',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      fontSize: '13px',
                      fontWeight: '500',
                      color: '#475569'
                    }}
                  >
                    â† Back to Debtors
                  </button>
                  <div style={{flex: 1}}>
                    <h2 style={{margin: 0, fontSize: '24px', fontWeight: '700', color: '#1e293b'}}>{selectedDebtor.name}</h2>
                    <div style={{fontSize: '13px', color: '#64748b', marginTop: '4px'}}>
                      Code: {selectedDebtor.fileNo || 'N/A'} | Group: {selectedDebtor.groupName || selectedDebtor.name}
                      {selectedDebtor.state && ` | State: ${selectedDebtor.state}`}
                    </div>
                  </div>
                  <div style={{textAlign: 'right', background: getDebtorLedger().totals.closingBalance > 0 ? '#fef2f2' : '#f0fdf4', padding: '12px 20px', borderRadius: '8px'}}>
                    <div style={{fontSize: '11px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Outstanding Balance</div>
                    <div style={{fontSize: '28px', fontWeight: '700', color: getDebtorLedger().totals.closingBalance > 0 ? '#dc2626' : '#16a34a'}}>
                      â‚¹{(getDebtorLedger().totals.closingBalance || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                    </div>
                  </div>
                </div>

                {/* 1. INVOICES TABLE */}
                <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', marginBottom: '24px'}}>
                  <div style={{padding: '16px 20px', background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', color: '#fff'}}>
                    <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <FileText size={18} /> Invoices
                    </h3>
                  </div>
                  <div style={{overflowX: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                      <thead>
                        <tr style={{background: '#fef3c7'}}>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Date</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Invoice No</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Organization</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Description</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Sub-Period</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#92400e'}}>Fin Year</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#92400e'}}>Amount (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#92400e'}}>Status</th>
                          <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#92400e'}}>View Invoice</th>
                          <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#92400e'}}>View Receipt</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          const clientInvoices = (data.invoices || []).filter(inv => 
                            inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()
                          ).sort((a, b) => new Date(a.invoiceDate) - new Date(b.invoiceDate));
                          
                          if (clientInvoices.length === 0) {
                            return <tr><td colSpan={10} style={{padding: '30px', textAlign: 'center', color: '#64748b'}}>No invoices found</td></tr>;
                          }
                          
                          return clientInvoices.map(inv => {
                            const org = (data.organizations || []).find(o => o.id === inv.organizationId);
                            const paidAmount = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                            const invoiceReceipts = (data.receipts || []).filter(r => r.invoiceId === inv.id);
                            const balanceDue = (inv.totalAmount || 0) - paidAmount;
                            const status = balanceDue <= 0.01 ? 'Paid' : paidAmount > 0 ? 'Partial' : 'Pending';
                            
                            return (
                              <tr key={inv.id} style={{borderBottom: '1px solid #fef3c7'}}>
                                <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.invoiceDate ? new Date(inv.invoiceDate).toLocaleDateString('en-IN') : '-'}</td>
                                <td style={{padding: '10px 12px', fontWeight: '600', color: '#d97706'}}>{inv.invoiceNo}</td>
                                <td style={{padding: '10px 12px', color: '#64748b'}}>{org?.name || inv.orgName || '-'}</td>
                                <td style={{padding: '10px 12px', maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{inv.serviceDescription || '-'}</td>
                                <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.subPeriod || inv.period || '-'}</td>
                                <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.financialYear || '-'}</td>
                                <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600'}}>â‚¹{(inv.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                  <span style={{
                                    padding: '4px 10px',
                                    borderRadius: '12px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    background: status === 'Paid' ? '#dcfce7' : status === 'Partial' ? '#fef3c7' : '#fef2f2',
                                    color: status === 'Paid' ? '#166534' : status === 'Partial' ? '#92400e' : '#991b1b'
                                  }}>
                                    {status}
                                  </span>
                                </td>
                                <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                  <button
                                    onClick={() => viewInvoiceFromLedger(inv.id)}
                                    style={{padding: '4px 8px', background: '#fef3c7', color: '#92400e', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                  >
                                    <Eye size={12} />
                                  </button>
                                </td>
                                <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                  {(status === 'Paid' || status === 'Partial') && invoiceReceipts.length > 0 ? (
                                    <button
                                      onClick={() => setViewingReceipt(invoiceReceipts[0])}
                                      style={{padding: '4px 8px', background: '#dcfce7', color: '#166534', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                    >
                                      <Eye size={12} />
                                    </button>
                                  ) : '-'}
                                </td>
                              </tr>
                            );
                          });
                        })()}
                      </tbody>
                      <tfoot>
                        <tr style={{background: '#fef3c7'}}>
                          <td colSpan={6} style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right'}}>Total Invoices:</td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#d97706'}}>
                            â‚¹{(data.invoices || []).filter(inv => inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()).reduce((sum, inv) => sum + (inv.totalAmount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                          <td colSpan={3}></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                {/* 2. RECEIPTS TABLE */}
                <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', marginBottom: '24px'}}>
                  <div style={{padding: '16px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: '#fff'}}>
                    <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <DollarSign size={18} /> Receipts / Payments
                    </h3>
                  </div>
                  <div style={{overflowX: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                      <thead>
                        <tr style={{background: '#dcfce7'}}>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#166534'}}>Date</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#166534'}}>Receipt No</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#166534'}}>Against Invoice</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#166534'}}>Mode</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#166534'}}>Narration</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#166534'}}>Amount (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#166534'}}>TDS (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#166534'}}>Discount (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#166534'}}>Total (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#166534'}}>View Receipt</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          const clientReceipts = (data.receipts || []).filter(r => 
                            r.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()
                          ).sort((a, b) => new Date(a.receiptDate) - new Date(b.receiptDate));
                          
                          if (clientReceipts.length === 0) {
                            return <tr><td colSpan={10} style={{padding: '30px', textAlign: 'center', color: '#64748b'}}>No receipts found</td></tr>;
                          }
                          
                          return clientReceipts.map(r => {
                            const totalReceived = (r.amount || 0) + (r.tds || 0) + (r.discount || 0);
                            return (
                              <tr key={r.id} style={{borderBottom: '1px solid #dcfce7'}}>
                                <td style={{padding: '10px 12px', color: '#64748b'}}>{r.receiptDate ? new Date(r.receiptDate).toLocaleDateString('en-IN') : '-'}</td>
                                <td style={{padding: '10px 12px', fontWeight: '600', color: '#059669'}}>{r.receiptNo}</td>
                                <td style={{padding: '10px 12px', color: '#3b82f6'}}>{r.invoiceNo}</td>
                                <td style={{padding: '10px 12px'}}>{r.paymentMode || '-'}</td>
                                <td style={{padding: '10px 12px', color: '#64748b', maxWidth: '120px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{r.narration || '-'}</td>
                                <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600'}}>â‚¹{(r.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                <td style={{padding: '10px 12px', textAlign: 'right', color: '#f59e0b'}}>{r.tds > 0 ? `â‚¹${r.tds.toLocaleString('en-IN')}` : '-'}</td>
                                <td style={{padding: '10px 12px', textAlign: 'right', color: '#3b82f6'}}>{r.discount > 0 ? `â‚¹${r.discount.toLocaleString('en-IN')}` : '-'}</td>
                                <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '700', color: '#059669'}}>â‚¹{totalReceived.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                  <button
                                    onClick={() => setViewingReceipt(r)}
                                    style={{padding: '4px 8px', background: '#dcfce7', color: '#166534', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                  >
                                    <Eye size={12} />
                                  </button>
                                </td>
                              </tr>
                            );
                          });
                        })()}
                      </tbody>
                      <tfoot>
                        <tr style={{background: '#dcfce7'}}>
                          <td colSpan={5} style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right'}}>Total Received:</td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#059669'}}>
                            â‚¹{(data.receipts || []).filter(r => r.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()).reduce((sum, r) => sum + (r.amount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#f59e0b'}}>
                            â‚¹{(data.receipts || []).filter(r => r.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()).reduce((sum, r) => sum + (r.tds || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#3b82f6'}}>
                            â‚¹{(data.receipts || []).filter(r => r.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()).reduce((sum, r) => sum + (r.discount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#059669', fontSize: '13px'}}>
                            â‚¹{(data.receipts || []).filter(r => r.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()).reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                {/* 3. OUTSTANDING INVOICES TABLE */}
                <div style={{background: '#fff', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                  <div style={{padding: '16px 20px', background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', color: '#fff'}}>
                    <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <AlertCircle size={18} /> Outstanding Invoices
                    </h3>
                  </div>
                  <div style={{overflowX: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                      <thead>
                        <tr style={{background: '#fef2f2'}}>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#991b1b'}}>Date</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#991b1b'}}>Invoice No</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#991b1b'}}>Organization</th>
                          <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#991b1b'}}>Description</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#991b1b'}}>Invoice Amt (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#991b1b'}}>Received (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#991b1b'}}>Balance Due (â‚¹)</th>
                          <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#991b1b'}}>View Invoice</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          const clientInvoices = (data.invoices || []).filter(inv => 
                            inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase()
                          );
                          
                          const outstandingInvoices = clientInvoices.map(inv => {
                            const org = (data.organizations || []).find(o => o.id === inv.organizationId);
                            const paidAmount = (data.receipts || [])
                              .filter(r => r.invoiceId === inv.id)
                              .reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                            const balanceDue = (inv.totalAmount || 0) - paidAmount;
                            return { ...inv, orgName: org?.name || inv.orgName || '-', paidAmount, balanceDue };
                          }).filter(inv => inv.balanceDue > 0.01).sort((a, b) => new Date(a.invoiceDate) - new Date(b.invoiceDate));
                          
                          if (outstandingInvoices.length === 0) {
                            return <tr><td colSpan={8} style={{padding: '30px', textAlign: 'center', color: '#16a34a', fontWeight: '600'}}>âœ“ All invoices are fully paid!</td></tr>;
                          }
                          
                          return outstandingInvoices.map(inv => (
                            <tr key={inv.id} style={{borderBottom: '1px solid #fef2f2'}}>
                              <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.invoiceDate ? new Date(inv.invoiceDate).toLocaleDateString('en-IN') : '-'}</td>
                              <td style={{padding: '10px 12px', fontWeight: '600', color: '#dc2626'}}>{inv.invoiceNo}</td>
                              <td style={{padding: '10px 12px', color: '#64748b'}}>{inv.orgName}</td>
                              <td style={{padding: '10px 12px', maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{inv.serviceDescription || '-'}</td>
                              <td style={{padding: '10px 12px', textAlign: 'right'}}>â‚¹{(inv.totalAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                              <td style={{padding: '10px 12px', textAlign: 'right', color: '#16a34a'}}>â‚¹{(inv.paidAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                              <td style={{padding: '10px 12px', textAlign: 'right', fontWeight: '700', color: '#dc2626'}}>â‚¹{(inv.balanceDue || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                              <td style={{padding: '10px 12px', textAlign: 'center'}}>
                                <button
                                  onClick={() => viewInvoiceFromLedger(inv.id)}
                                  style={{padding: '4px 8px', background: '#fef2f2', color: '#991b1b', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '11px'}}
                                >
                                  <Eye size={12} />
                                </button>
                              </td>
                            </tr>
                          ));
                        })()}
                      </tbody>
                      <tfoot>
                        <tr style={{background: '#fef2f2'}}>
                          <td colSpan={4} style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right'}}>Total Outstanding:</td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right'}}>
                            â‚¹{(() => {
                              const clientInvoices = (data.invoices || []).filter(inv => inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase());
                              return clientInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                            })()}
                          </td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#16a34a'}}>
                            â‚¹{(() => {
                              const clientInvoices = (data.invoices || []).filter(inv => inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase());
                              return clientInvoices.reduce((total, inv) => {
                                const paidAmount = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                                return total + paidAmount;
                              }, 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                            })()}
                          </td>
                          <td style={{padding: '10px 12px', fontWeight: '700', textAlign: 'right', color: '#dc2626', fontSize: '13px'}}>
                            â‚¹{(() => {
                              const clientInvoices = (data.invoices || []).filter(inv => inv.clientName?.toLowerCase() === selectedDebtor.name?.toLowerCase());
                              return clientInvoices.reduce((total, inv) => {
                                const paidAmount = (data.receipts || []).filter(r => r.invoiceId === inv.id).reduce((sum, r) => sum + (r.amount || 0) + (r.tds || 0) + (r.discount || 0), 0);
                                const balance = Math.max(0, (inv.totalAmount || 0) - paidAmount);
                                return total + balance;
                              }, 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                            })()}
                          </td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            )}
            
            {/* Invoice View Screen */}
            {debtorViewMode === 'invoice' && viewingInvoice && (
              <div>
                {/* Action Bar */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  marginBottom: '20px',
                  padding: '16px 20px',
                  background: (viewingInvoice.invoiceFormat === 'billOfSupplyBlue' ? 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)'),
                  borderRadius: '12px'
                }}>
                  <button
                    onClick={goBackToLedger}
                    style={{
                      padding: '10px 16px',
                      background: 'rgba(255,255,255,0.1)',
                      border: '1px solid rgba(255,255,255,0.2)',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      fontSize: '13px',
                      fontWeight: '500',
                      color: '#fff'
                    }}
                  >
                    â† Back to Ledger
                  </button>
                  <div style={{flex: 1, color: '#fff'}}>
                    <span style={{fontSize: '14px', opacity: 0.7}}>Invoice</span>
                    <span style={{fontSize: '18px', fontWeight: '700', marginLeft: '8px'}}>{viewingInvoice.invoiceNo}</span>
                  </div>
                  <button
                    onClick={printInvoicePDF}
                    style={{padding: '10px 20px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                  >
                    ðŸ–¨ï¸ Print
                  </button>
                  <button
                    onClick={downloadInvoicePDF}
                    style={{padding: '10px 20px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                  >
                    ðŸ“¥ Download PDF
                  </button>
                  {!invoiceHasPayments(viewingInvoice.id) ? (
                    <>
                      <button
                        onClick={startEditInvoice}
                        style={{padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                      >
                        âœï¸ Edit
                      </button>
                      <button
                        onClick={() => {
                          const invoiceId = viewingInvoice.id;
                          
                          // Check for payments first
                          const hasPayments = (data.receipts || []).some(r => String(r.invoiceId) === String(invoiceId));
                          if (hasPayments) {
                            alert('Cannot delete this invoice. Payments have been received against it.');
                            return;
                          }
                          
                          if (!window.confirm('Are you sure you want to delete this invoice?')) {
                            return;
                          }
                          
                          // Find the invoice
                          const invoice = (data.invoices || []).find(i => String(i.id) === String(invoiceId));
                          if (!invoice) {
                            alert('Invoice not found');
                            return;
                          }
                          
                          // Delete invoice and update tasks
                          const newInvoices = (data.invoices || []).filter(i => String(i.id) !== String(invoiceId));
                          const newTasks = (data.tasks || []).map(t => {
                            if (invoice.taskId && String(t.id) === String(invoice.taskId)) {
                              return { ...t, billed: false, invoiceId: null };
                            }
                            if (invoice.taskIds && invoice.taskIds.map(String).includes(String(t.id))) {
                              return { ...t, billed: false, invoiceId: null };
                            }
                            return t;
                          });
                          
                          // Update state
                          setData(prev => ({
                            ...prev,
                            invoices: newInvoices,
                            tasks: newTasks
                          }));
                          
                          // Navigate back
                          setViewingInvoice(null);
                          if (selectedDebtor) {
                            setDebtorViewMode('ledger');
                          } else {
                            setDebtorViewMode('list');
                          }
                          
                          alert('Invoice deleted successfully!');
                        }}
                        style={{padding: '10px 20px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                      >
                        ðŸ—‘ï¸ Delete
                      </button>
                    </>
                  ) : (
                    <div style={{padding: '10px 16px', background: 'rgba(255,255,255,0.1)', borderRadius: '8px', fontSize: '12px', color: '#fcd34d'}}>
                      âš ï¸ Payment received - Cannot edit/delete
                    </div>
                  )}
                </div>
                
                {/* Dark Grey/Black Professional Invoice Design */}
                <div id="invoice-print-content" style={{background: '#fff', overflow: 'hidden', boxShadow: '0 4px 20px rgba(0,0,0,0.15)'}}>
                  {(() => {
                    // Get current org for live data (reflects any changes)
                    const currentOrg = data.organizations?.find(o => o.id === (viewingInvoice.orgId || viewingInvoice.organizationId)) || {};
                    
                    const gstApplicable = viewingInvoice.gstApplicable !== false;
                    const invoiceFormat = viewingInvoice.invoiceFormat || (gstApplicable ? 'taxInvoice' : 'billOfSupply');
                    const isDarkTheme = invoiceFormat === 'billOfSupply' || invoiceFormat === 'billOfSupplyBlue';
                    
                    // Colors: Black for Tax/Proforma, Dark Grey for Bill of Supply
                    const primaryColor = isDarkTheme ? '#374151' : '#111827';
                    const secondaryColor = isDarkTheme ? '#6b7280' : '#374151';
                    const headerGradient = isDarkTheme 
                      ? 'linear-gradient(135deg, #374151 0%, #4b5563 50%, #6b7280 100%)'
                      : 'linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%)';
                    const accentColor = isDarkTheme ? '#9ca3af' : '#6b7280';
                    
                    let invoiceTitle = 'TAX INVOICE';
                    if (invoiceFormat === 'billOfSupply' || invoiceFormat === 'billOfSupplyBlue') {
                      invoiceTitle = 'BILL OF SUPPLY';
                    } else if (invoiceFormat === 'proformaInvoice') {
                      invoiceTitle = 'PROFORMA INVOICE';
                    }
                    
                    const showGst = gstApplicable && invoiceFormat !== 'billOfSupply' && invoiceFormat !== 'billOfSupplyBlue';
                    
                    // Use current org data for display (reflects changes)
                    const displayOrg = {
                      name: currentOrg.name || viewingInvoice.orgName,
                      address: currentOrg.address || viewingInvoice.orgAddress,
                      mobile: currentOrg.mobile || viewingInvoice.orgMobile,
                      email: currentOrg.email || viewingInvoice.orgEmail,
                      gstin: currentOrg.gstin || viewingInvoice.orgGstin,
                      pan: currentOrg.pan || viewingInvoice.orgPan,
                      logo: currentOrg.logo || viewingInvoice.orgLogo,
                      signature: currentOrg.signature || viewingInvoice.orgSignature,
                      signatory: currentOrg.signatory || viewingInvoice.orgSignatory,
                      bankName: currentOrg.bankName || viewingInvoice.orgBankName,
                      bankAccount: currentOrg.bankAccount || viewingInvoice.orgBankAccount,
                      bankIfsc: currentOrg.bankIfsc || viewingInvoice.orgBankIfsc,
                      bankBranch: currentOrg.bankBranch || viewingInvoice.orgBankBranch,
                    };
                    
                    return (
                      <div style={{fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif", border: `2px solid ${primaryColor}`, maxWidth: '210mm'}}>
                        
                        {/* ===== HEADER ===== */}
                        <div style={{background: headerGradient, padding: '20px 25px', color: '#fff'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                              {displayOrg.logo ? (
                                <div style={{background: '#fff', padding: '6px', borderRadius: '6px'}}>
                                  <img src={displayOrg.logo} alt="Logo" style={{width: '50px', height: '50px', objectFit: 'contain'}} />
                                </div>
                              ) : (
                                <div style={{width: '55px', height: '55px', background: 'rgba(255,255,255,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '6px', fontSize: '26px', fontWeight: '700', border: '1px solid rgba(255,255,255,0.3)'}}>
                                  {displayOrg.name?.[0] || 'O'}
                                </div>
                              )}
                              <div>
                                <h1 style={{margin: 0, fontSize: '20px', fontWeight: '700', letterSpacing: '0.3px'}}>{displayOrg.name}</h1>
                                <div style={{fontSize: '11px', opacity: 0.85, marginTop: '3px', maxWidth: '280px'}}>{displayOrg.address}</div>
                              </div>
                            </div>
                            <div style={{textAlign: 'right'}}>
                              <div style={{fontSize: '24px', fontWeight: '800', letterSpacing: '2px'}}>{invoiceTitle}</div>
                              <div style={{fontSize: '11px', opacity: 0.85, marginTop: '5px'}}>
                                {displayOrg.mobile && <span>Tel: {displayOrg.mobile}</span>}
                                {displayOrg.email && <span style={{marginLeft: '10px'}}>Email: {displayOrg.email}</span>}
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        {/* ===== INVOICE META BAR ===== */}
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', background: '#f9fafb', borderBottom: `1px solid ${accentColor}`}}>
                          <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                            <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Invoice No.</div>
                            <div style={{fontSize: '14px', fontWeight: '700', color: primaryColor, marginTop: '2px'}}>{viewingInvoice.invoiceNo}</div>
                          </div>
                          <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                            <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Date</div>
                            <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{formatInvoiceDate(viewingInvoice.invoiceDate)}</div>
                          </div>
                          <div style={{padding: '12px 15px', borderRight: '1px solid #e5e7eb'}}>
                            <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>Place of Supply</div>
                            <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{viewingInvoice.placeOfSupply || '-'}</div>
                          </div>
                          <div style={{padding: '12px 15px'}}>
                            <div style={{fontSize: '9px', color: '#6b7280', textTransform: 'uppercase', fontWeight: '600', letterSpacing: '0.5px'}}>State Code</div>
                            <div style={{fontSize: '14px', fontWeight: '700', color: '#1f2937', marginTop: '2px'}}>{viewingInvoice.receiverStateCode || '-'}</div>
                          </div>
                        </div>
                        
                        {/* ===== PARTY DETAILS ===== */}
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', borderBottom: '1px solid #e5e7eb'}}>
                          <div style={{padding: '15px 20px', borderRight: '1px solid #e5e7eb'}}>
                            <div style={{fontSize: '10px', color: '#fff', background: primaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '8px'}}>FROM</div>
                            <div style={{fontSize: '14px', fontWeight: '600', color: '#1f2937'}}>{displayOrg.name}</div>
                            {showGst && displayOrg.gstin && <div style={{fontSize: '12px', color: '#4b5563', marginTop: '4px'}}>GSTIN: <strong>{displayOrg.gstin}</strong></div>}
                            {displayOrg.pan && <div style={{fontSize: '12px', color: '#4b5563'}}>PAN: <strong>{displayOrg.pan}</strong></div>}
                          </div>
                          <div style={{padding: '15px 20px'}}>
                            <div style={{fontSize: '10px', color: '#fff', background: primaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '8px'}}>BILL TO</div>
                            <div style={{fontSize: '14px', fontWeight: '600', color: '#1f2937'}}>{viewingInvoice.clientName}</div>
                            {viewingInvoice.clientAddress && <div style={{fontSize: '11px', color: '#6b7280', marginTop: '3px'}}>{viewingInvoice.clientAddress}</div>}
                            {showGst && viewingInvoice.clientGstin && <div style={{fontSize: '12px', color: '#4b5563', marginTop: '4px'}}>GSTIN: <strong>{viewingInvoice.clientGstin}</strong></div>}
                            {viewingInvoice.clientCode && <div style={{fontSize: '12px', color: '#4b5563'}}>Code: <strong>{viewingInvoice.clientCode}</strong></div>}
                          </div>
                        </div>
                        
                        {/* ===== SERVICES TABLE ===== */}
                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                          <thead>
                            <tr style={{background: headerGradient}}>
                              <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '40px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>S.No</th>
                              <th style={{padding: '10px 12px', textAlign: 'left', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>Description of Services</th>
                              {showGst && <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '70px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>SAC</th>}
                              {showGst && <th style={{padding: '10px 12px', textAlign: 'center', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '50px', borderRight: '1px solid rgba(255,255,255,0.2)'}}>Tax%</th>}
                              <th style={{padding: '10px 12px', textAlign: 'right', color: '#fff', fontWeight: '600', fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px', width: '100px'}}>Amount (â‚¹)</th>
                            </tr>
                          </thead>
                          <tbody>
                            {viewingInvoice.lineItems && viewingInvoice.lineItems.length > 0 ? (
                              viewingInvoice.lineItems.map((item, idx) => (
                                <tr key={idx} style={{borderBottom: '1px solid #e5e7eb', background: idx % 2 === 0 ? '#fff' : '#f9fafb'}}>
                                  <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontWeight: '500', fontSize: '12px'}}>{idx + 1}</td>
                                  <td style={{padding: '12px'}}>
                                    <div style={{fontWeight: '500', fontSize: '12px', color: '#1f2937'}}>{item.description}</div>
                                    {item.remark && <div style={{fontSize: '10px', color: '#9ca3af', marginTop: '2px', fontStyle: 'italic'}}>{item.remark}</div>}
                                  </td>
                                  {showGst && <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>{item.sacCode || '998231'}</td>}
                                  {showGst && <td style={{padding: '12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>18%</td>}
                                  <td style={{padding: '12px', textAlign: 'right', fontWeight: '600', fontSize: '12px', color: '#1f2937'}}>{(item.netAmount || item.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                </tr>
                              ))
                            ) : (
                              <tr style={{borderBottom: '1px solid #e5e7eb'}}>
                                <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontWeight: '500'}}>1</td>
                                <td style={{padding: '14px 12px'}}>
                                  <div style={{fontWeight: '500', fontSize: '13px', color: '#1f2937'}}>{viewingInvoice.serviceDescription}</div>
                                  {viewingInvoice.remark && <div style={{fontSize: '10px', color: '#9ca3af', marginTop: '3px', fontStyle: 'italic'}}>{viewingInvoice.remark}</div>}
                                </td>
                                {showGst && <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>{viewingInvoice.sac || '998231'}</td>}
                                {showGst && <td style={{padding: '14px 12px', textAlign: 'center', color: '#6b7280', fontSize: '11px'}}>18%</td>}
                                <td style={{padding: '14px 12px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: '#1f2937'}}>{viewingInvoice.netAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                        
                        {/* ===== AMOUNT & BANK SECTION ===== */}
                        <div style={{display: 'flex', borderTop: `1px solid ${accentColor}`}}>
                          <div style={{flex: 1, padding: '15px 20px', borderRight: '1px solid #e5e7eb'}}>
                            <div style={{marginBottom: '12px'}}>
                              <div style={{fontSize: '10px', color: '#fff', background: secondaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '6px'}}>AMOUNT IN WORDS</div>
                              <div style={{fontSize: '12px', fontWeight: '500', color: '#1f2937', fontStyle: 'italic'}}>{viewingInvoice.amountInWords}</div>
                            </div>
                            <div>
                              <div style={{fontSize: '10px', color: '#fff', background: secondaryColor, display: 'inline-block', padding: '2px 8px', fontWeight: '600', letterSpacing: '0.5px', marginBottom: '6px'}}>BANK DETAILS</div>
                              <div style={{fontSize: '11px', color: '#4b5563', lineHeight: '1.6'}}>
                                <div><span style={{color: '#9ca3af'}}>Bank:</span> <strong>{displayOrg.bankName || '-'}</strong></div>
                                <div><span style={{color: '#9ca3af'}}>A/C No:</span> <strong>{displayOrg.bankAccount || '-'}</strong></div>
                                <div><span style={{color: '#9ca3af'}}>IFSC:</span> <strong>{displayOrg.bankIfsc || '-'}</strong></div>
                              </div>
                            </div>
                          </div>
                          
                          <div style={{width: '280px'}}>
                            <div style={{padding: '10px 15px', background: '#f9fafb'}}>
                              <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                <span style={{color: '#6b7280', fontSize: '12px'}}>Subtotal</span>
                                <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{viewingInvoice.netAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                              </div>
                              {viewingInvoice.discount > 0 && (
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                  <span style={{color: '#6b7280', fontSize: '12px'}}>Discount</span>
                                  <span style={{fontWeight: '600', fontSize: '12px', color: '#dc2626'}}>- â‚¹{viewingInvoice.discount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                </div>
                              )}
                              {showGst && viewingInvoice.cgst > 0 && (
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                  <span style={{color: '#6b7280', fontSize: '12px'}}>CGST @9%</span>
                                  <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{viewingInvoice.cgst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                </div>
                              )}
                              {showGst && viewingInvoice.sgst > 0 && (
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                  <span style={{color: '#6b7280', fontSize: '12px'}}>SGST @9%</span>
                                  <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{viewingInvoice.sgst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                </div>
                              )}
                              {showGst && viewingInvoice.igst > 0 && (
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                  <span style={{color: '#6b7280', fontSize: '12px'}}>IGST @18%</span>
                                  <span style={{fontWeight: '600', fontSize: '12px'}}>â‚¹{viewingInvoice.igst?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                                </div>
                              )}
                              {!showGst && (
                                <div style={{display: 'flex', justifyContent: 'space-between', padding: '5px 0', borderBottom: '1px solid #e5e7eb'}}>
                                  <span style={{color: '#6b7280', fontSize: '12px'}}>GST</span>
                                  <span style={{fontWeight: '600', fontSize: '12px', color: '#f59e0b'}}>N/A</span>
                                </div>
                              )}
                            </div>
                            <div style={{background: headerGradient, padding: '12px 15px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                              <span style={{color: '#fff', fontWeight: '700', fontSize: '13px', letterSpacing: '0.5px'}}>GRAND TOTAL</span>
                              <span style={{color: '#fff', fontWeight: '800', fontSize: '18px'}}>â‚¹{viewingInvoice.totalAmount?.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                            </div>
                          </div>
                        </div>
                        
                        {/* ===== SIGNATURE & TERMS ===== */}
                        <div style={{display: 'flex', borderTop: '1px solid #e5e7eb'}}>
                          <div style={{flex: 1, padding: '12px 20px', fontSize: '10px', color: '#6b7280'}}>
                            <strong style={{color: '#4b5563'}}>Terms:</strong> Payment due within 15 days. Quote invoice number in correspondence.
                          </div>
                          <div style={{width: '180px', padding: '12px 20px', textAlign: 'center', borderLeft: '1px solid #e5e7eb'}}>
                            <div style={{fontSize: '9px', color: '#9ca3af', marginBottom: '6px'}}>For {displayOrg.name}</div>
                            {displayOrg.signature ? (
                              <img src={displayOrg.signature} alt="Signature" style={{maxHeight: '35px', marginBottom: '6px'}} />
                            ) : (
                              <div style={{height: '35px', marginBottom: '6px', borderBottom: `1px dashed ${accentColor}`}}></div>
                            )}
                            <div style={{borderTop: `1px solid ${primaryColor}`, paddingTop: '4px', fontWeight: '600', fontSize: '10px', color: primaryColor}}>
                              {displayOrg.signatory || 'Authorized Signatory'}
                            </div>
                          </div>
                        </div>
                        
                        {/* ===== FOOTER ===== */}
                        <div style={{background: primaryColor, padding: '8px 20px', fontSize: '9px', color: '#fff', textAlign: 'center'}}>
                          Computer generated {invoiceTitle.toLowerCase()}. {showGst ? `Subject to ${viewingInvoice.placeOfSupply || 'local'} jurisdiction.` : 'GST Not Applicable.'}
                        </div>
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}
          </div>
        )}
        
        {/* Receipt View Screen - Shows as overlay from any tab */}
        {viewingReceipt && (
          <div style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 2000, overflow: 'auto', padding: '40px 20px'}}>
            <div style={{maxWidth: '850px', margin: '0 auto'}}>
              {/* Action Bar */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                marginBottom: '20px',
                padding: '16px 20px',
                background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                borderRadius: '12px'
              }}>
                <button
                  onClick={() => { setViewingReceipt(null); }}
                  style={{
                    padding: '10px 16px',
                    background: 'rgba(255,255,255,0.1)',
                    border: '1px solid rgba(255,255,255,0.2)',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontSize: '13px',
                    fontWeight: '500',
                    color: '#fff'
                  }}
                >
                  âœ• Close
                </button>
                <div style={{flex: 1, color: '#fff'}}>
                  <span style={{fontSize: '14px', opacity: 0.7}}>Receipt</span>
                  <span style={{fontSize: '18px', fontWeight: '700', marginLeft: '8px'}}>{viewingReceipt.receiptNo}</span>
                </div>
                <button
                  onClick={() => window.print()}
                  style={{padding: '10px 20px', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}
                >
                  ðŸ–¨ï¸ Print
                </button>
              </div>

              {/* Receipt Design */}
              <div style={{background: '#fff', borderRadius: '12px', boxShadow: '0 4px 20px rgba(0,0,0,0.1)', overflow: 'hidden'}} className="print-receipt">
                {/* Receipt Header */}
                <div style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', padding: '30px', color: '#fff', textAlign: 'center'}}>
                  <h1 style={{margin: 0, fontSize: '28px', fontWeight: '700', letterSpacing: '1px'}}>RECEIPT</h1>
                  <div style={{fontSize: '14px', opacity: 0.9, marginTop: '8px'}}>Payment Acknowledgement</div>
                </div>
                
                {/* Receipt Details */}
                <div style={{padding: '30px'}}>
                  {/* Receipt Info Row */}
                  <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '30px', padding: '20px', background: '#f8fafc', borderRadius: '8px'}}>
                    <div>
                      <div style={{fontSize: '12px', color: '#64748b', marginBottom: '4px'}}>Receipt No.</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#10b981'}}>{viewingReceipt.receiptNo}</div>
                    </div>
                    <div style={{textAlign: 'right'}}>
                      <div style={{fontSize: '12px', color: '#64748b', marginBottom: '4px'}}>Receipt Date</div>
                      <div style={{fontSize: '20px', fontWeight: '700', color: '#1e293b'}}>
                        {viewingReceipt.receiptDate ? new Date(viewingReceipt.receiptDate).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'}) : '-'}
                      </div>
                    </div>
                  </div>

                  {/* Received From */}
                  <div style={{marginBottom: '30px'}}>
                    <div style={{fontSize: '12px', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Received From</div>
                    <div style={{padding: '20px', border: '2px solid #e2e8f0', borderRadius: '8px'}}>
                      <div style={{fontSize: '18px', fontWeight: '700', color: '#1e293b'}}>{viewingReceipt.clientName}</div>
                      {viewingReceipt.clientCode && <div style={{fontSize: '13px', color: '#64748b', marginTop: '4px'}}>File No: {viewingReceipt.clientCode}</div>}
                      {viewingReceipt.groupName && <div style={{fontSize: '13px', color: '#64748b'}}>Group: {viewingReceipt.groupName}</div>}
                    </div>
                  </div>

                  {/* Against Invoice */}
                  <div style={{marginBottom: '30px'}}>
                    <div style={{fontSize: '12px', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Against Invoice</div>
                    <div style={{padding: '20px', border: '2px solid #fef3c7', borderRadius: '8px', background: '#fffbeb'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div>
                          <div style={{fontSize: '16px', fontWeight: '700', color: '#d97706'}}>{viewingReceipt.invoiceNo}</div>
                          {viewingReceipt.finYear && <div style={{fontSize: '12px', color: '#92400e', marginTop: '4px'}}>F.Y. {viewingReceipt.finYear}</div>}
                        </div>
                        <div style={{textAlign: 'right'}}>
                          <div style={{fontSize: '12px', color: '#64748b'}}>Invoice Amount</div>
                          <div style={{fontSize: '16px', fontWeight: '600', color: '#1e293b'}}>â‚¹{(viewingReceipt.invoiceAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
                        </div>
                      </div>
                      {viewingReceipt.serviceDescription && (
                        <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px dashed #fcd34d', fontSize: '13px', color: '#64748b'}}>
                          {viewingReceipt.serviceDescription}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Payment Details */}
                  <div style={{marginBottom: '30px'}}>
                    <div style={{fontSize: '12px', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Payment Details</div>
                    <table style={{width: '100%', borderCollapse: 'collapse', border: '2px solid #e2e8f0', borderRadius: '8px'}}>
                      <tbody>
                        <tr style={{borderBottom: '1px solid #e2e8f0'}}>
                          <td style={{padding: '14px 16px', fontWeight: '500', background: '#f8fafc', width: '40%'}}>Payment Mode</td>
                          <td style={{padding: '14px 16px', fontWeight: '600'}}>{viewingReceipt.paymentMode || 'Cash'}</td>
                        </tr>
                        <tr style={{borderBottom: '1px solid #e2e8f0'}}>
                          <td style={{padding: '14px 16px', fontWeight: '500', background: '#f8fafc'}}>Amount Received (Cash/Bank)</td>
                          <td style={{padding: '14px 16px', fontWeight: '700', color: '#10b981', fontSize: '16px'}}>â‚¹{(viewingReceipt.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        </tr>
                        {viewingReceipt.tds > 0 && (
                          <tr style={{borderBottom: '1px solid #e2e8f0'}}>
                            <td style={{padding: '14px 16px', fontWeight: '500', background: '#f8fafc'}}>TDS Deducted</td>
                            <td style={{padding: '14px 16px', fontWeight: '600', color: '#f59e0b'}}>â‚¹{(viewingReceipt.tds || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                          </tr>
                        )}
                        {viewingReceipt.discount > 0 && (
                          <tr style={{borderBottom: '1px solid #e2e8f0'}}>
                            <td style={{padding: '14px 16px', fontWeight: '500', background: '#f8fafc'}}>Discount Given</td>
                            <td style={{padding: '14px 16px', fontWeight: '600', color: '#3b82f6'}}>â‚¹{(viewingReceipt.discount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                          </tr>
                        )}
                        <tr style={{background: '#dcfce7'}}>
                          <td style={{padding: '16px', fontWeight: '700', fontSize: '15px'}}>Total Settlement</td>
                          <td style={{padding: '16px', fontWeight: '700', color: '#059669', fontSize: '18px'}}>
                            â‚¹{((viewingReceipt.amount || 0) + (viewingReceipt.tds || 0) + (viewingReceipt.discount || 0)).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  {/* Narration */}
                  {viewingReceipt.narration && (
                    <div style={{marginBottom: '30px'}}>
                      <div style={{fontSize: '12px', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Narration</div>
                      <div style={{padding: '16px', border: '1px solid #e2e8f0', borderRadius: '8px', background: '#f8fafc', fontStyle: 'italic', color: '#64748b'}}>
                        {viewingReceipt.narration}
                      </div>
                    </div>
                  )}

                  {/* Amount in Words */}
                  <div style={{padding: '20px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #a7f3d0'}}>
                    <div style={{fontSize: '12px', color: '#166534', marginBottom: '4px'}}>Amount Received (in words)</div>
                    <div style={{fontSize: '14px', fontWeight: '600', color: '#065f46'}}>
                      Rupees {(() => {
                        const num = viewingReceipt.amount || 0;
                        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
                        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                        if (num === 0) return 'Zero';
                        const numStr = Math.floor(num).toString();
                        if (numStr.length > 9) return 'Amount too large';
                        const n = ('000000000' + numStr).substr(-9).match(/.{1,2}/g);
                        let str = '';
                        str += (n[0] != 0) ? (ones[Number(n[0])] || tens[n[0][0]] + ' ' + ones[n[0][1]]) + ' Crore ' : '';
                        str += (n[1] != 0) ? (ones[Number(n[1])] || tens[n[1][0]] + ' ' + ones[n[1][1]]) + ' Lakh ' : '';
                        str += (n[2] != 0) ? (ones[Number(n[2])] || tens[n[2][0]] + ' ' + ones[n[2][1]]) + ' Thousand ' : '';
                        str += (n[3] != 0) ? (ones[Number(n[3])] || tens[n[3][0]] + ' ' + ones[n[3][1]]) + ' Hundred ' : '';
                        str += (n[4] != 0) ? ((str != '') ? 'and ' : '') + (ones[Number(n[4])] || tens[n[4][0]] + ' ' + ones[n[4][1]]) : '';
                        return str.trim() + ' Only';
                      })()}
                    </div>
                  </div>
                </div>

                {/* Footer */}
                <div style={{background: '#f8fafc', padding: '20px 30px', borderTop: '1px solid #e2e8f0'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <div style={{fontSize: '11px', color: '#64748b'}}>
                      This is a computer generated receipt.
                    </div>
                    <div style={{textAlign: 'right'}}>
                      <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>For any queries</div>
                      <div style={{fontSize: '12px', fontWeight: '500'}}>Thank you for your payment!</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* Edit Invoice Modal */}
        {showEditInvoiceModal && editingInvoiceData && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 3000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '12px',
              width: '650px',
              maxWidth: '95%',
              maxHeight: '90vh',
              overflow: 'auto',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              <div style={{padding: '20px 24px', borderBottom: '1px solid #e2e8f0', background: '#f8fafc'}}>
                <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Edit Invoice</h3>
                <div style={{fontSize: '13px', color: '#64748b', marginTop: '4px'}}>Invoice No: {editingInvoiceData.invoiceNo}</div>
              </div>
              
              <div style={{padding: '24px'}}>
                {/* Organization Selection */}
                <div style={{marginBottom: '20px', padding: '16px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #bbf7d0'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '8px', color: '#166534'}}>Organization</label>
                  <select
                    value={editingInvoiceData.organizationId}
                    onChange={(e) => setEditingInvoiceData({...editingInvoiceData, organizationId: e.target.value})}
                    style={{width: '100%', padding: '10px 12px', border: '1px solid #bbf7d0', borderRadius: '6px', fontSize: '13px', background: '#fff'}}
                  >
                    {(data.organizations || []).map(org => (
                      <option key={org.id} value={org.id}>{org.name} - {org.state}</option>
                    ))}
                  </select>
                </div>
                
                {/* Service Description */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Service Description</label>
                  <input
                    type="text"
                    value={editingInvoiceData.serviceDescription}
                    onChange={(e) => setEditingInvoiceData({...editingInvoiceData, serviceDescription: e.target.value})}
                    style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                  />
                </div>
                
                {/* Multiple Task Invoice - Line Items */}
                {editingInvoiceData.lineItems && editingInvoiceData.lineItems.length > 0 ? (
                  <div style={{marginBottom: '16px'}}>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '10px', color: '#374151'}}>
                      Line Items ({editingInvoiceData.lineItems.length} tasks)
                    </label>
                    <div style={{border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden'}}>
                      <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                        <thead>
                          <tr style={{background: '#f8fafc'}}>
                            <th style={{padding: '10px', textAlign: 'left', borderBottom: '1px solid #e2e8f0'}}>Description</th>
                            <th style={{padding: '10px', textAlign: 'right', width: '100px', borderBottom: '1px solid #e2e8f0'}}>Amount (â‚¹)</th>
                            <th style={{padding: '10px', textAlign: 'right', width: '100px', borderBottom: '1px solid #e2e8f0'}}>Discount (â‚¹)</th>
                            <th style={{padding: '10px', textAlign: 'right', width: '100px', borderBottom: '1px solid #e2e8f0'}}>Net (â‚¹)</th>
                          </tr>
                        </thead>
                        <tbody>
                          {editingInvoiceData.lineItems.map((item, idx) => (
                            <tr key={idx} style={{borderBottom: '1px solid #f1f5f9'}}>
                              <td style={{padding: '10px'}}>
                                <input
                                  type="text"
                                  value={item.description || ''}
                                  onChange={(e) => {
                                    const newLineItems = [...editingInvoiceData.lineItems];
                                    newLineItems[idx] = {...newLineItems[idx], description: e.target.value};
                                    setEditingInvoiceData({...editingInvoiceData, lineItems: newLineItems});
                                  }}
                                  style={{width: '100%', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px'}}
                                />
                              </td>
                              <td style={{padding: '10px'}}>
                                <input
                                  type="number"
                                  value={item.amount || ''}
                                  onChange={(e) => {
                                    const newLineItems = [...editingInvoiceData.lineItems];
                                    newLineItems[idx] = {
                                      ...newLineItems[idx], 
                                      amount: e.target.value,
                                      netAmount: (parseFloat(e.target.value) || 0) - (parseFloat(newLineItems[idx].discount) || 0)
                                    };
                                    setEditingInvoiceData({...editingInvoiceData, lineItems: newLineItems});
                                  }}
                                  style={{width: '100%', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px', textAlign: 'right'}}
                                />
                              </td>
                              <td style={{padding: '10px'}}>
                                <input
                                  type="number"
                                  value={item.discount || ''}
                                  onChange={(e) => {
                                    const newLineItems = [...editingInvoiceData.lineItems];
                                    newLineItems[idx] = {
                                      ...newLineItems[idx], 
                                      discount: e.target.value,
                                      netAmount: (parseFloat(newLineItems[idx].amount) || 0) - (parseFloat(e.target.value) || 0)
                                    };
                                    setEditingInvoiceData({...editingInvoiceData, lineItems: newLineItems});
                                  }}
                                  style={{width: '100%', padding: '6px 8px', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '12px', textAlign: 'right'}}
                                />
                              </td>
                              <td style={{padding: '10px', textAlign: 'right', fontWeight: '600', color: '#166534'}}>
                                {((parseFloat(item.amount) || 0) - (parseFloat(item.discount) || 0)).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                        <tfoot>
                          <tr style={{background: '#f0fdf4'}}>
                            <td colSpan={3} style={{padding: '12px', textAlign: 'right', fontWeight: '700'}}>Total:</td>
                            <td style={{padding: '12px', textAlign: 'right', fontWeight: '700', color: '#166534', fontSize: '14px'}}>
                              â‚¹{editingInvoiceData.lineItems.reduce((sum, item) => sum + ((parseFloat(item.amount) || 0) - (parseFloat(item.discount) || 0)), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                ) : (
                  /* Single Task Invoice - Amount & Discount */
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Amount (â‚¹)</label>
                      <input
                        type="number"
                        value={editingInvoiceData.amount}
                        onChange={(e) => setEditingInvoiceData({...editingInvoiceData, amount: e.target.value})}
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Discount (â‚¹)</label>
                      <input
                        type="number"
                        value={editingInvoiceData.discount}
                        onChange={(e) => setEditingInvoiceData({...editingInvoiceData, discount: e.target.value})}
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Net Amount (â‚¹)</label>
                      <input
                        type="text"
                        value={(parseFloat(editingInvoiceData.amount || 0) - parseFloat(editingInvoiceData.discount || 0)).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                        readOnly
                        style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', background: '#f8fafc', fontWeight: '600'}}
                      />
                    </div>
                  </div>
                )}
                
                {/* SAC & Place of Supply */}
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px'}}>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>SAC Code</label>
                    <select
                      value={editingInvoiceData.sac || ''}
                      onChange={(e) => setEditingInvoiceData({...editingInvoiceData, sac: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    >
                      <option value="">Select SAC</option>
                      <option value="998231">998231 - Financial auditing services</option>
                      <option value="998232">998232 - Accounting and bookkeeping</option>
                      <option value="998233">998233 - Tax consultancy and preparation</option>
                      <option value="998234">998234 - Insolvency and receivership</option>
                      <option value="998311">998311 - Management consulting</option>
                    </select>
                  </div>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Place of Supply</label>
                    <select
                      value={editingInvoiceData.placeOfSupply || ''}
                      onChange={(e) => setEditingInvoiceData({...editingInvoiceData, placeOfSupply: e.target.value})}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    >
                      <option value="">Select State</option>
                      {['Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal', 'Delhi', 'Jammu and Kashmir', 'Ladakh'].map(state => (
                        <option key={state} value={state}>{state}</option>
                      ))}
                    </select>
                  </div>
                </div>
                
                {/* Remark */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Remark</label>
                  <input
                    type="text"
                    value={editingInvoiceData.remark || ''}
                    onChange={(e) => setEditingInvoiceData({...editingInvoiceData, remark: e.target.value})}
                    style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                  />
                </div>
                
                {/* Invoice Date */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '6px', color: '#374151'}}>Invoice Date</label>
                  <input
                    type="date"
                    value={editingInvoiceData.invoiceDate || ''}
                    onChange={(e) => setEditingInvoiceData({...editingInvoiceData, invoiceDate: e.target.value})}
                    style={{width: '200px', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                  />
                </div>
                
                {/* GST Preview */}
                <div style={{padding: '16px', background: '#f8fafc', borderRadius: '8px', marginBottom: '16px'}}>
                  <div style={{fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '12px'}}>Tax Calculation Preview</div>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', fontSize: '13px'}}>
                    {(() => {
                      // Calculate net amount based on line items or single amount
                      let net = 0;
                      if (editingInvoiceData.lineItems && editingInvoiceData.lineItems.length > 0) {
                        net = editingInvoiceData.lineItems.reduce((sum, item) => 
                          sum + ((parseFloat(item.amount) || 0) - (parseFloat(item.discount) || 0)), 0);
                      } else {
                        const amt = parseFloat(editingInvoiceData.amount || 0);
                        const disc = parseFloat(editingInvoiceData.discount || 0);
                        net = amt - disc;
                      }
                      
                      const selectedOrg = data.organizations.find(o => o.id === editingInvoiceData.organizationId);
                      const gstApplicable = selectedOrg?.gstApplicable === 'yes';
                      const orgState = selectedOrg?.state || editingInvoiceData.orgState || '';
                      const clientState = editingInvoiceData.placeOfSupply || '';
                      const sameState = orgState && clientState && orgState.toLowerCase() === clientState.toLowerCase();
                      
                      let cgst = 0, sgst = 0, igst = 0;
                      if (gstApplicable && net > 0) {
                        if (sameState) {
                          cgst = Math.round(net * 0.09 * 100) / 100;
                          sgst = Math.round(net * 0.09 * 100) / 100;
                        } else {
                          igst = Math.round(net * 0.18 * 100) / 100;
                        }
                      }
                      const total = net + cgst + sgst + igst;
                      
                      return (
                        <>
                          <div><span style={{color: '#64748b'}}>Net:</span> <strong>â‚¹{net.toLocaleString('en-IN')}</strong></div>
                          {gstApplicable && cgst > 0 && <div><span style={{color: '#64748b'}}>CGST 9%:</span> <strong>â‚¹{cgst.toLocaleString('en-IN')}</strong></div>}
                          {gstApplicable && sgst > 0 && <div><span style={{color: '#64748b'}}>SGST 9%:</span> <strong>â‚¹{sgst.toLocaleString('en-IN')}</strong></div>}
                          {gstApplicable && igst > 0 && <div><span style={{color: '#64748b'}}>IGST 18%:</span> <strong>â‚¹{igst.toLocaleString('en-IN')}</strong></div>}
                          {!gstApplicable && <div><span style={{color: '#64748b'}}>GST:</span> <strong style={{color: '#f59e0b'}}>Not Applicable</strong></div>}
                          <div><span style={{color: '#64748b'}}>Total:</span> <strong style={{color: '#10b981'}}>â‚¹{total.toLocaleString('en-IN')}</strong></div>
                        </>
                      );
                    })()}
                  </div>
                </div>
              </div>
              
              <div style={{display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 24px', borderTop: '1px solid #e2e8f0', background: '#f8fafc'}}>
                <button
                  onClick={() => { setShowEditInvoiceModal(false); setEditingInvoiceData(null); }}
                  style={{padding: '10px 20px', background: '#fff', color: '#64748b', border: '1px solid #e2e8f0', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '500'}}
                >
                  Cancel
                </button>
                <button
                  onClick={saveEditedInvoice}
                  style={{padding: '10px 24px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        )}



        {/* Organization Modal */}
        {showOrgModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '12px',
              width: '900px',
              maxWidth: '95%',
              maxHeight: '90vh',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column'
            }}>
              <div style={{padding: '20px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                  {editingOrg ? 'Edit Organization' : 'Add New Organization'}
                </h3>
                <button onClick={() => { setShowOrgModal(false); resetOrgForm(); }} style={{background: 'none', border: 'none', cursor: 'pointer'}}>
                  <X size={24} />
                </button>
              </div>
              
              <div style={{flex: 1, overflow: 'auto', padding: '20px'}}>
                {/* Basic Information */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Basic Information
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        Organization Name <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <input
                        type="text"
                        value={orgForm.name}
                        onChange={(e) => setOrgForm({...orgForm, name: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Website</label>
                      <input
                        type="text"
                        value={orgForm.website}
                        onChange={(e) => setOrgForm({...orgForm, website: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>FAX No.</label>
                      <input
                        type="text"
                        value={orgForm.faxNo}
                        onChange={(e) => setOrgForm({...orgForm, faxNo: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Authorized Signatory Name</label>
                      <input
                        type="text"
                        value={orgForm.authorizedSignatory}
                        onChange={(e) => setOrgForm({...orgForm, authorizedSignatory: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                </div>

                {/* Contact Information */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Contact Information
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Phone No.</label>
                      <input
                        type="text"
                        value={orgForm.phoneNo}
                        onChange={(e) => setOrgForm({...orgForm, phoneNo: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Mobile No.</label>
                      <input
                        type="text"
                        value={orgForm.mobileNo}
                        onChange={(e) => setOrgForm({...orgForm, mobileNo: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Alternate Mobile No.</label>
                      <input
                        type="text"
                        value={orgForm.alternateMobileNo}
                        onChange={(e) => setOrgForm({...orgForm, alternateMobileNo: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Email Id</label>
                      <input
                        type="email"
                        value={orgForm.emailId}
                        onChange={(e) => setOrgForm({...orgForm, emailId: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                </div>

                {/* Tax & Payment Information */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Tax & Payment Information
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        GST Applicable <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <select
                        value={orgForm.gstApplicable}
                        onChange={(e) => setOrgForm({...orgForm, gstApplicable: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', fontWeight: '500', background: orgForm.gstApplicable === 'yes' ? '#dcfce7' : '#fef2f2', color: orgForm.gstApplicable === 'yes' ? '#166534' : '#dc2626'}}
                      >
                        <option value="yes">Yes - Charge GST</option>
                        <option value="no">No - GST Not Applicable</option>
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        Invoice Format <span style={{color: '#ef4444'}}>*</span>
                      </label>
                      <select
                        value={orgForm.invoiceFormat || (orgForm.gstApplicable === 'yes' ? 'taxInvoice' : 'billOfSupply')}
                        onChange={(e) => setOrgForm({...orgForm, invoiceFormat: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      >
                        {orgForm.gstApplicable === 'yes' ? (
                          <>
                            <option value="taxInvoice">Tax Invoice (Green)</option>
                            <option value="proformaInvoice">Proforma Invoice (Green)</option>
                          </>
                        ) : (
                          <>
                            <option value="billOfSupply">Bill of Supply (Green)</option>
                            <option value="billOfSupplyBlue">Bill of Supply (Blue)</option>
                          </>
                        )}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>GSTIN</label>
                      <input
                        type="text"
                        value={orgForm.gstin}
                        onChange={(e) => setOrgForm({...orgForm, gstin: e.target.value.toUpperCase()})}
                        maxLength={15}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>PAN No.</label>
                      <input
                        type="text"
                        value={orgForm.panNo}
                        onChange={(e) => setOrgForm({...orgForm, panNo: e.target.value.toUpperCase()})}
                        maxLength={10}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginTop: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>UPI ID</label>
                      <input
                        type="text"
                        value={orgForm.upiId}
                        onChange={(e) => setOrgForm({...orgForm, upiId: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>MMID</label>
                      <input
                        type="text"
                        value={orgForm.mmid}
                        onChange={(e) => setOrgForm({...orgForm, mmid: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                  {orgForm.gstApplicable === 'yes' && (
                    <div style={{marginTop: '12px', padding: '12px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #a7f3d0'}}>
                      <div style={{fontSize: '12px', color: '#166534'}}>
                        <strong>GST Calculation Rules:</strong><br/>
                        â€¢ Same State (Client & Organization) â†’ CGST 9% + SGST 9%<br/>
                        â€¢ Different State â†’ IGST 18%
                      </div>
                    </div>
                  )}
                </div>

                {/* Bank Details */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Bank Details
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Bank Name</label>
                      <input
                        type="text"
                        value={orgForm.bankName}
                        onChange={(e) => setOrgForm({...orgForm, bankName: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Account No.</label>
                      <input
                        type="text"
                        value={orgForm.bankAccountNo}
                        onChange={(e) => setOrgForm({...orgForm, bankAccountNo: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>IFSC Code</label>
                      <input
                        type="text"
                        value={orgForm.bankIfsc}
                        onChange={(e) => setOrgForm({...orgForm, bankIfsc: e.target.value.toUpperCase()})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Branch</label>
                      <input
                        type="text"
                        value={orgForm.bankBranch}
                        onChange={(e) => setOrgForm({...orgForm, bankBranch: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                </div>

                {/* Address Information */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Address Information
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>State</label>
                      <select
                        value={orgForm.state}
                        onChange={(e) => setOrgForm({...orgForm, state: e.target.value})}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      >
                        <option value="">Select State</option>
                        {INDIAN_STATES.map(state => <option key={state} value={state}>{state}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Address</label>
                      <textarea
                        value={orgForm.address}
                        onChange={(e) => setOrgForm({...orgForm, address: e.target.value})}
                        rows={2}
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', resize: 'vertical'}}
                      />
                    </div>
                  </div>
                </div>

                {/* Invoice/Receipt Number Configuration */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#8b5cf6', borderBottom: '2px solid #8b5cf6', paddingBottom: '8px'}}>
                    Invoice & Receipt Number Configuration
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px'}}>
                    {/* Invoice Config */}
                    <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px'}}>
                      <h5 style={{margin: '0 0 12px 0', fontSize: '13px', fontWeight: '600'}}>Invoice Number Format</h5>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Prefix</label>
                          <input
                            type="text"
                            value={orgForm.invoicePrefix}
                            onChange={(e) => setOrgForm({...orgForm, invoicePrefix: e.target.value})}
                            placeholder="INV"
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Start Number</label>
                          <input
                            type="number"
                            value={orgForm.invoiceStartNo}
                            onChange={(e) => setOrgForm({...orgForm, invoiceStartNo: parseInt(e.target.value) || 1, invoiceCurrentNo: parseInt(e.target.value) || 1})}
                            min={1}
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Suffix (Optional)</label>
                          <input
                            type="text"
                            value={orgForm.invoiceSuffix}
                            onChange={(e) => setOrgForm({...orgForm, invoiceSuffix: e.target.value})}
                            placeholder="e.g., /24-25"
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Preview</label>
                          <div style={{padding: '8px', background: '#e0f2fe', borderRadius: '6px', fontSize: '12px', fontWeight: '600', color: '#0369a1'}}>
                            {orgForm.invoicePrefix}{String(orgForm.invoiceStartNo).padStart(4, '0')}{orgForm.invoiceSuffix}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Receipt Config */}
                    <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px'}}>
                      <h5 style={{margin: '0 0 12px 0', fontSize: '13px', fontWeight: '600'}}>Receipt Number Format</h5>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Prefix</label>
                          <input
                            type="text"
                            value={orgForm.receiptPrefix}
                            onChange={(e) => setOrgForm({...orgForm, receiptPrefix: e.target.value})}
                            placeholder="RCP"
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Start Number</label>
                          <input
                            type="number"
                            value={orgForm.receiptStartNo}
                            onChange={(e) => setOrgForm({...orgForm, receiptStartNo: parseInt(e.target.value) || 1, receiptCurrentNo: parseInt(e.target.value) || 1})}
                            min={1}
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Suffix (Optional)</label>
                          <input
                            type="text"
                            value={orgForm.receiptSuffix}
                            onChange={(e) => setOrgForm({...orgForm, receiptSuffix: e.target.value})}
                            placeholder="e.g., /24-25"
                            style={{width: '100%', padding: '8px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '12px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px'}}>Preview</label>
                          <div style={{padding: '8px', background: '#dcfce7', borderRadius: '6px', fontSize: '12px', fontWeight: '600', color: '#166534'}}>
                            {orgForm.receiptPrefix}{String(orgForm.receiptStartNo).padStart(4, '0')}{orgForm.receiptSuffix}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* File Uploads */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Images & Documents
                  </h4>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                    {/* Logo Upload */}
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        Upload Logo (Max 200x200px)
                      </label>
                      <div style={{border: '2px dashed #e2e8f0', borderRadius: '8px', padding: '16px', textAlign: 'center'}}>
                        {orgForm.logoPreview ? (
                          <div>
                            <img src={orgForm.logoPreview} alt="Logo" style={{maxWidth: '100px', maxHeight: '100px', marginBottom: '8px'}} />
                            <br/>
                            <button onClick={() => setOrgForm({...orgForm, logo: null, logoPreview: ''})} style={{fontSize: '11px', color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer'}}>
                              Remove
                            </button>
                          </div>
                        ) : (
                          <label style={{cursor: 'pointer'}}>
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'logo')} style={{display: 'none'}} />
                            <Upload size={24} style={{color: '#9ca3af', marginBottom: '4px'}} />
                            <div style={{fontSize: '12px', color: '#64748b'}}>Choose File</div>
                          </label>
                        )}
                      </div>
                    </div>

                    {/* Signature Upload */}
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        Authorized Signatory Image (100x200px)
                      </label>
                      <div style={{border: '2px dashed #e2e8f0', borderRadius: '8px', padding: '16px', textAlign: 'center'}}>
                        {orgForm.signaturePreview ? (
                          <div>
                            <img src={orgForm.signaturePreview} alt="Signature" style={{maxWidth: '100px', maxHeight: '50px', marginBottom: '8px'}} />
                            <br/>
                            <button onClick={() => setOrgForm({...orgForm, signatureImage: null, signaturePreview: ''})} style={{fontSize: '11px', color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer'}}>
                              Remove
                            </button>
                          </div>
                        ) : (
                          <label style={{cursor: 'pointer'}}>
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'signature')} style={{display: 'none'}} />
                            <Upload size={24} style={{color: '#9ca3af', marginBottom: '4px'}} />
                            <div style={{fontSize: '12px', color: '#64748b'}}>Choose File</div>
                          </label>
                        )}
                      </div>
                    </div>

                    {/* QR Code Upload */}
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>
                        Payment QR Code (100x200px)
                      </label>
                      <div style={{border: '2px dashed #e2e8f0', borderRadius: '8px', padding: '16px', textAlign: 'center'}}>
                        {orgForm.qrCodePreview ? (
                          <div>
                            <img src={orgForm.qrCodePreview} alt="QR Code" style={{maxWidth: '100px', maxHeight: '100px', marginBottom: '8px'}} />
                            <br/>
                            <button onClick={() => setOrgForm({...orgForm, qrCode: null, qrCodePreview: ''})} style={{fontSize: '11px', color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer'}}>
                              Remove
                            </button>
                          </div>
                        ) : (
                          <label style={{cursor: 'pointer'}}>
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'qrCode')} style={{display: 'none'}} />
                            <Upload size={24} style={{color: '#9ca3af', marginBottom: '4px'}} />
                            <div style={{fontSize: '12px', color: '#64748b'}}>Choose File</div>
                          </label>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Settings */}
                <div style={{marginBottom: '24px'}}>
                  <h4 style={{margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: '#10b981', borderBottom: '2px solid #10b981', paddingBottom: '8px'}}>
                    Invoice Settings
                  </h4>
                  <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: '#f8fafc', borderRadius: '8px'}}>
                      <span style={{fontSize: '13px', flex: 1}}>Allow Backdated Invoicing?</span>
                      <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer'}}>
                        <input
                          type="radio"
                          name="backdated"
                          checked={orgForm.allowBackdatedInvoicing}
                          onChange={() => setOrgForm({...orgForm, allowBackdatedInvoicing: true})}
                        /> Yes
                      </label>
                      <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer'}}>
                        <input
                          type="radio"
                          name="backdated"
                          checked={!orgForm.allowBackdatedInvoicing}
                          onChange={() => setOrgForm({...orgForm, allowBackdatedInvoicing: false})}
                        /> No
                      </label>
                    </div>

                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: '#f8fafc', borderRadius: '8px'}}>
                      <span style={{fontSize: '13px', flex: 1}}>Display File No. & Group No. in Invoice, Service Estimate, Debit and Credit Note?</span>
                      <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer'}}>
                        <input
                          type="radio"
                          name="displayFileNo"
                          checked={orgForm.displayFileNoInInvoice}
                          onChange={() => setOrgForm({...orgForm, displayFileNoInInvoice: true})}
                        /> Yes
                      </label>
                      <label style={{display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer'}}>
                        <input
                          type="radio"
                          name="displayFileNo"
                          checked={!orgForm.displayFileNoInInvoice}
                          onChange={() => setOrgForm({...orgForm, displayFileNoInInvoice: false})}
                        /> No
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div style={{display: 'flex', gap: '12px', padding: '20px', borderTop: '1px solid #e2e8f0'}}>
                <button
                  onClick={() => { setShowOrgModal(false); resetOrgForm(); }}
                  style={{flex: 1, padding: '12px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  Cancel
                </button>
                <button
                  onClick={saveOrganization}
                  style={{flex: 1, padding: '12px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  {editingOrg ? 'Update Organization' : 'Save Organization'}
                </button>
              </div>
            </div>
          </div>
        )}

      </div>
    );
  };

  // Templates View
  const TemplatesView = () => {
    const downloadTemplate = (templateType) => {
      let csvContent = '';
      let filename = '';

      if (templateType === 'clients') {
        filename = 'Client_Import_Template.csv';
        csvContent = 'Name,Email,Phone,File No,Group No.,Address,GSTIN,PAN,Aadhaar,State\n';
        csvContent += 'John Doe,john@example.com,9876543210,1.01,Group A,123 Main Street Delhi,22AAAAA0000A1Z5,ABCDE1234F,123456789012,Delhi\n';
        csvContent += 'Jane Smith,jane@example.com,9876543211,1.02,Group B,456 Park Avenue Mumbai,27BBBBB0000B1Z5,XYZPQ5678R,987654321098,Maharashtra\n';
      }

      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    return (
      <div className="templates-view">
        <div className="view-header">
          <div>
            <h1>Import Templates</h1>
            <p className="view-subtitle">Download templates for bulk data import</p>
          </div>
        </div>

        <div className="templates-grid">
          <div className="template-card">
            <div className="template-icon">
              <Users size={48} color="#10b981" />
            </div>
            <div className="template-content">
              <h3>Client Import Template</h3>
              <p>Download CSV template for importing multiple clients at once</p>
              <div className="template-details">
                <div className="template-detail-item">
                  <strong>Columns:</strong> Name, Email, Phone, File No, Group No., Address, GSTIN, PAN, Aadhaar, State
                </div>
                <div className="template-detail-item">
                  <strong>Format:</strong> CSV (Comma-separated values)
                </div>
                <div className="template-detail-item">
                  <strong>Sample Rows:</strong> 2 example clients included
                </div>
              </div>
            </div>
            <button className="btn-download-template" onClick={() => downloadTemplate('clients')}>
              <Download size={20} />
              Download Template
            </button>
          </div>

          <div className="template-card disabled">
            <div className="template-icon">
              <FileText size={48} color="#94a3b8" />
            </div>
            <div className="template-content">
              <h3>Task Import Template</h3>
              <p>Download CSV template for importing multiple tasks</p>
              <div className="template-details">
                <div className="template-detail-item">
                  <strong>Status:</strong> Coming Soon
                </div>
              </div>
            </div>
            <button className="btn-download-template" disabled>
              <Download size={20} />
              Coming Soon
            </button>
          </div>

          <div className="template-card disabled">
            <div className="template-icon">
              <Users size={48} color="#94a3b8" />
            </div>
            <div className="template-content">
              <h3>Staff Import Template</h3>
              <p>Download CSV template for importing staff members</p>
              <div className="template-details">
                <div className="template-detail-item">
                  <strong>Status:</strong> Coming Soon
                </div>
              </div>
            </div>
            <button className="btn-download-template" disabled>
              <Download size={20} />
              Coming Soon
            </button>
          </div>
        </div>

        <div className="template-instructions">
          <h2>How to Use Import Templates</h2>
          <div className="instructions-grid">
            <div className="instruction-step">
              <div className="step-number">1</div>
              <div className="step-content">
                <h4>Download Template</h4>
                <p>Click the "Download Template" button above to get the CSV file with sample data</p>
              </div>
            </div>
            <div className="instruction-step">
              <div className="step-number">2</div>
              <div className="step-content">
                <h4>Fill Your Data</h4>
                <p>Open the CSV file in Excel or any spreadsheet software and replace sample data with your actual data</p>
              </div>
            </div>
            <div className="instruction-step">
              <div className="step-number">3</div>
              <div className="step-content">
                <h4>Save as CSV</h4>
                <p>Make sure to save the file in CSV format (not Excel format)</p>
              </div>
            </div>
            <div className="instruction-step">
              <div className="step-number">4</div>
              <div className="step-content">
                <h4>Import File</h4>
                <p>Go to the respective section (Clients, Tasks, etc.) and click "Import" button to upload your file</p>
              </div>
            </div>
          </div>

          <div className="template-notes">
            <h3>Important Notes:</h3>
            <ul>
              <li>Do not change the column headers in the first row</li>
              <li>Required fields must be filled (Name, Email for clients)</li>
              <li>Keep the file format as CSV for successful import</li>
              <li>Remove sample data rows before importing your actual data</li>
              <li>Special characters in data should be properly escaped</li>
            </ul>
          </div>
        </div>
      </div>
    );
  };

  // ========== APPROVALS VIEW ==========
  const ApprovalsView = () => {
    const [activeTab, setActiveTab] = useState('pending'); // pending, myRequests, all
    const [selectedApprovalType, setSelectedApprovalType] = useState('all'); // all, tasks, clients, billing, receipts, staff
    const [viewingApproval, setViewingApproval] = useState(null);
    const [editingApproval, setEditingApproval] = useState(null);
    const [editedData, setEditedData] = useState(null);
    const [rejectComment, setRejectComment] = useState('');
    
    const userRole = getCurrentUserRole();
    const isSuperAdmin = currentUser?.isSuperAdmin || userRole === 'Superadmin';
    const isRM = userRole === 'Reporting Manager';
    
    // Get pending approvals for current user
    const pendingApprovals = getPendingApprovalsForUser();
    
    // Get my submitted requests
    const myRequests = getMyApprovalRequests();
    
    // Filter by type
    const filterByType = (approvals) => {
      if (selectedApprovalType === 'all') return approvals;
      return approvals.filter(a => {
        if (selectedApprovalType === 'tasks') return a.type === 'task' || a.type === 'bulk_task';
        if (selectedApprovalType === 'clients') return a.type === 'client_add' || a.type === 'client_disable';
        if (selectedApprovalType === 'billing') return a.type === 'invoice';
        if (selectedApprovalType === 'receipts') return a.type === 'receipt';
        if (selectedApprovalType === 'staff') return a.type === 'staff_add' || a.type === 'staff_disable';
        return true;
      });
    };
    
    const getTypeLabel = (type) => {
      const labels = {
        'task': 'ðŸ“‹ Task Creation',
        'bulk_task': 'ðŸ“‹ Bulk Tasks',
        'client_add': 'ðŸ‘¤ New Client',
        'client_disable': 'ðŸš« Client Disable',
        'invoice': 'ðŸ’° Invoice',
        'receipt': 'ðŸ§¾ Receipt',
        'staff_add': 'ðŸ‘¥ New Staff',
        'staff_disable': 'ðŸš« Staff Disable'
      };
      return labels[type] || type;
    };
    
    const getStatusBadge = (status) => {
      const styles = {
        pending: { bg: '#fef3c7', color: '#d97706', label: 'â³ Pending' },
        approved: { bg: '#dcfce7', color: '#16a34a', label: 'âœ“ Approved' },
        rejected: { bg: '#fef2f2', color: '#ef4444', label: 'âœ— Rejected' }
      };
      const s = styles[status] || styles.pending;
      return (
        <span style={{
          padding: '4px 10px',
          borderRadius: '12px',
          fontSize: '11px',
          fontWeight: '600',
          background: s.bg,
          color: s.color
        }}>
          {s.label}
        </span>
      );
    };
    
    const renderApprovalDetails = (approval) => {
      const d = approval.data;
      switch (approval.type) {
        case 'task':
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', fontSize: '13px'}}>
                <div><strong>Client:</strong> {d.clientName}</div>
                <div><strong>Task:</strong> {d.parentTask} â†’ {d.childTask}</div>
                <div><strong>Period:</strong> {d.period}</div>
                <div><strong>FY:</strong> {d.financialYear}</div>
                <div><strong>Task Manager:</strong> {d.taskManager}</div>
                <div><strong>Assigned To:</strong> {d.primaryAssignedUser}</div>
              </div>
            </div>
          );
        case 'bulk_task':
          const tasks = Array.isArray(d) ? d : [d];
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{fontWeight: '600', marginBottom: '8px'}}>{tasks.length} Tasks:</div>
              <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                {tasks.slice(0, 10).map((t, i) => (
                  <div key={i} style={{padding: '8px', borderBottom: '1px solid #e2e8f0', fontSize: '12px'}}>
                    {t.clientName} - {t.parentTask} â†’ {t.childTask} ({t.period})
                  </div>
                ))}
                {tasks.length > 10 && (
                  <div style={{padding: '8px', color: '#64748b', fontSize: '12px'}}>
                    ...and {tasks.length - 10} more tasks
                  </div>
                )}
              </div>
            </div>
          );
        case 'client_add':
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', fontSize: '13px'}}>
                <div><strong>File No:</strong> {d.fileNo}</div>
                <div><strong>Name:</strong> {d.name}</div>
                <div><strong>PAN:</strong> {d.pan || '-'}</div>
                <div><strong>Email:</strong> {d.email || '-'}</div>
                <div><strong>Mobile:</strong> {d.mobile || '-'}</div>
                <div><strong>Group:</strong> {d.groupName || d.name}</div>
              </div>
            </div>
          );
        case 'client_disable':
          return (
            <div style={{background: '#fef2f2', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{fontSize: '13px'}}>
                <strong>Client to Disable:</strong> {d.clientName} (File No: {d.fileNo || d.clientId})
                <div style={{marginTop: '8px', color: '#ef4444'}}>
                  <strong>Reason:</strong> {d.reason || 'No reason provided'}
                </div>
              </div>
            </div>
          );
        case 'invoice':
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', fontSize: '13px'}}>
                <div><strong>Invoice No:</strong> {d.invoiceNo}</div>
                <div><strong>Client:</strong> {d.clientName}</div>
                <div><strong>Amount:</strong> â‚¹{(d.totalAmount || d.amount || 0).toLocaleString()}</div>
                <div><strong>Date:</strong> {d.invoiceDate}</div>
              </div>
            </div>
          );
        case 'receipt':
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', fontSize: '13px'}}>
                <div><strong>Receipt No:</strong> {d.receiptNo}</div>
                <div><strong>Client:</strong> {d.clientName}</div>
                <div><strong>Amount:</strong> â‚¹{(d.amount || 0).toLocaleString()}</div>
                <div><strong>Date:</strong> {d.receiptDate}</div>
                <div><strong>Mode:</strong> {d.paymentMode}</div>
              </div>
            </div>
          );
        case 'staff_add':
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', fontSize: '13px'}}>
                <div><strong>Name:</strong> {d.name}</div>
                <div><strong>Email:</strong> {d.email}</div>
                <div><strong>Role:</strong> {d.role}</div>
                <div><strong>Reporting To:</strong> {d.reportingManager || '-'}</div>
              </div>
            </div>
          );
        case 'staff_disable':
          return (
            <div style={{background: '#fef2f2', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <div style={{fontSize: '13px'}}>
                <strong>Staff to Disable:</strong> {d.staffName} ({d.staffEmail || d.staffId})
                <div style={{marginTop: '8px', color: '#ef4444'}}>
                  <strong>Reason:</strong> {d.reason || 'No reason provided'}
                </div>
              </div>
            </div>
          );
        default:
          return (
            <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginTop: '12px'}}>
              <pre style={{fontSize: '11px', overflow: 'auto'}}>{JSON.stringify(d, null, 2)}</pre>
            </div>
          );
      }
    };
    
    return (
      <div style={{padding: '24px'}}>
        {/* Header */}
        <div style={{marginBottom: '24px'}}>
          <h1 style={{fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0}}>
            âœ… Approvals
          </h1>
          <p style={{color: '#64748b', marginTop: '4px'}}>
            Review and manage pending approval requests
          </p>
        </div>
        
        {/* Stats Cards */}
        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px'}}>
          <div style={{background: '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
            <div style={{fontSize: '28px', fontWeight: '700', color: '#d97706'}}>{pendingApprovals.length}</div>
            <div style={{fontSize: '13px', color: '#64748b'}}>Pending Your Review</div>
          </div>
          <div style={{background: '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
            <div style={{fontSize: '28px', fontWeight: '700', color: '#3b82f6'}}>{myRequests.filter(r => r.status === 'pending').length}</div>
            <div style={{fontSize: '13px', color: '#64748b'}}>My Pending Requests</div>
          </div>
          <div style={{background: '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
            <div style={{fontSize: '28px', fontWeight: '700', color: '#16a34a'}}>{myRequests.filter(r => r.status === 'approved').length}</div>
            <div style={{fontSize: '13px', color: '#64748b'}}>Approved</div>
          </div>
          <div style={{background: '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
            <div style={{fontSize: '28px', fontWeight: '700', color: '#ef4444'}}>{myRequests.filter(r => r.status === 'rejected').length}</div>
            <div style={{fontSize: '13px', color: '#64748b'}}>Rejected</div>
          </div>
        </div>
        
        {/* Main Tabs */}
        <div style={{background: '#fff', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', overflow: 'hidden'}}>
          {/* Tab Headers */}
          <div style={{display: 'flex', borderBottom: '1px solid #e2e8f0'}}>
            {[
              {id: 'pending', label: 'Pending Review', count: pendingApprovals.length},
              {id: 'myRequests', label: 'My Requests', count: myRequests.length},
              ...(isSuperAdmin ? [{id: 'all', label: 'All Approvals', count: (data.pendingApprovals || []).length}] : [])
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                style={{
                  padding: '16px 24px',
                  background: activeTab === tab.id ? '#fff' : '#f8fafc',
                  border: 'none',
                  borderBottom: activeTab === tab.id ? '3px solid #3b82f6' : '3px solid transparent',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: activeTab === tab.id ? '600' : '500',
                  color: activeTab === tab.id ? '#3b82f6' : '#64748b',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                {tab.label}
                {tab.count > 0 && (
                  <span style={{
                    background: activeTab === tab.id ? '#3b82f6' : '#e2e8f0',
                    color: activeTab === tab.id ? '#fff' : '#64748b',
                    padding: '2px 8px',
                    borderRadius: '10px',
                    fontSize: '11px',
                    fontWeight: '600'
                  }}>
                    {tab.count}
                  </span>
                )}
              </button>
            ))}
          </div>
          
          {/* Type Filter */}
          <div style={{padding: '16px', borderBottom: '1px solid #e2e8f0', display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
            {[
              {id: 'all', label: 'All Types'},
              {id: 'tasks', label: 'ðŸ“‹ Tasks'},
              {id: 'clients', label: 'ðŸ‘¤ Clients'},
              {id: 'billing', label: 'ðŸ’° Billing'},
              {id: 'receipts', label: 'ðŸ§¾ Receipts'},
              {id: 'staff', label: 'ðŸ‘¥ Staff'}
            ].map(type => (
              <button
                key={type.id}
                onClick={() => setSelectedApprovalType(type.id)}
                style={{
                  padding: '6px 14px',
                  borderRadius: '20px',
                  border: '1px solid',
                  borderColor: selectedApprovalType === type.id ? '#3b82f6' : '#e2e8f0',
                  background: selectedApprovalType === type.id ? '#eff6ff' : '#fff',
                  color: selectedApprovalType === type.id ? '#3b82f6' : '#64748b',
                  fontSize: '12px',
                  fontWeight: '500',
                  cursor: 'pointer'
                }}
              >
                {type.label}
              </button>
            ))}
          </div>
          
          {/* Content */}
          <div style={{padding: '20px'}}>
            {activeTab === 'pending' && (
              <>
                {filterByType(pendingApprovals).length === 0 ? (
                  <div style={{textAlign: 'center', padding: '60px', color: '#94a3b8'}}>
                    <CheckCircle size={48} style={{marginBottom: '16px', opacity: 0.5}} />
                    <div style={{fontSize: '16px', fontWeight: '500'}}>No Pending Approvals</div>
                    <div style={{fontSize: '13px', marginTop: '4px'}}>All caught up! Nothing requires your approval.</div>
                  </div>
                ) : (
                  <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                    {filterByType(pendingApprovals).map(approval => (
                      <div key={approval.id} style={{
                        border: '1px solid #e2e8f0',
                        borderRadius: '12px',
                        overflow: 'hidden'
                      }}>
                        {/* Approval Header */}
                        <div style={{
                          padding: '16px',
                          background: '#f8fafc',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                            <div style={{
                              width: '40px',
                              height: '40px',
                              borderRadius: '10px',
                              background: '#fef3c7',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '18px'
                            }}>
                              {approval.type.includes('task') ? 'ðŸ“‹' : 
                               approval.type.includes('client') ? 'ðŸ‘¤' : 
                               approval.type === 'invoice' ? 'ðŸ’°' : 
                               approval.type === 'receipt' ? 'ðŸ§¾' : 'ðŸ‘¥'}
                            </div>
                            <div>
                              <div style={{fontWeight: '600', fontSize: '14px'}}>{getTypeLabel(approval.type)}</div>
                              <div style={{fontSize: '12px', color: '#64748b'}}>
                                Requested by <strong>{approval.requestedBy}</strong> ({approval.requestedByRole}) â€¢ {new Date(approval.createdAt).toLocaleDateString()}
                              </div>
                            </div>
                          </div>
                          {getStatusBadge(approval.status)}
                        </div>
                        
                        {/* Approval Body */}
                        <div style={{padding: '16px'}}>
                          {approval.description && (
                            <div style={{fontSize: '13px', color: '#475569', marginBottom: '12px'}}>
                              {approval.description}
                            </div>
                          )}
                          {renderApprovalDetails(approval)}
                        </div>
                        
                        {/* Action Buttons */}
                        <div style={{
                          padding: '16px',
                          background: '#f8fafc',
                          display: 'flex',
                          gap: '12px',
                          justifyContent: 'flex-end'
                        }}>
                          <button
                            onClick={() => {
                              const comment = prompt('Reason for rejection (optional):');
                              handleApprovalAction(approval.id, 'reject', null, comment || '');
                            }}
                            style={{
                              padding: '10px 20px',
                              background: '#fef2f2',
                              color: '#ef4444',
                              border: '1px solid #fecaca',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            âœ— Reject
                          </button>
                          <button
                            onClick={() => {
                              setEditingApproval(approval);
                              setEditedData(JSON.parse(JSON.stringify(approval.data)));
                            }}
                            style={{
                              padding: '10px 20px',
                              background: '#fef3c7',
                              color: '#d97706',
                              border: '1px solid #fde68a',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            âœŽ Edit & Approve
                          </button>
                          <button
                            onClick={() => handleApprovalAction(approval.id, 'approve')}
                            style={{
                              padding: '10px 20px',
                              background: '#16a34a',
                              color: '#fff',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            âœ“ Approve
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
            
            {activeTab === 'myRequests' && (
              <>
                {filterByType(myRequests).length === 0 ? (
                  <div style={{textAlign: 'center', padding: '60px', color: '#94a3b8'}}>
                    <FileText size={48} style={{marginBottom: '16px', opacity: 0.5}} />
                    <div style={{fontSize: '16px', fontWeight: '500'}}>No Requests</div>
                    <div style={{fontSize: '13px', marginTop: '4px'}}>You haven't submitted any approval requests yet.</div>
                  </div>
                ) : (
                  <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                    {filterByType(myRequests).map(approval => (
                      <div key={approval.id} style={{
                        border: '1px solid #e2e8f0',
                        borderRadius: '12px',
                        padding: '16px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: approval.status === 'pending' ? '#fffbeb' : '#fff'
                      }}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                          <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '8px',
                            background: approval.status === 'approved' ? '#dcfce7' : approval.status === 'rejected' ? '#fef2f2' : '#fef3c7',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '16px'
                          }}>
                            {approval.status === 'approved' ? 'âœ“' : approval.status === 'rejected' ? 'âœ—' : 'â³'}
                          </div>
                          <div>
                            <div style={{fontWeight: '500', fontSize: '13px'}}>{getTypeLabel(approval.type)}</div>
                            <div style={{fontSize: '11px', color: '#64748b'}}>
                              {new Date(approval.createdAt).toLocaleDateString()}
                              {approval.actionedBy && ` â€¢ Reviewed by ${approval.actionedBy}`}
                            </div>
                            {approval.comments && (
                              <div style={{fontSize: '11px', color: '#ef4444', marginTop: '4px'}}>
                                Comment: {approval.comments}
                              </div>
                            )}
                          </div>
                        </div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                          {getStatusBadge(approval.status)}
                          <button
                            onClick={() => setViewingApproval(approval)}
                            style={{
                              padding: '6px 12px',
                              background: '#f1f5f9',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '12px'
                            }}
                          >
                            View Details
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
            
            {activeTab === 'all' && isSuperAdmin && (
              <>
                {filterByType(data.pendingApprovals || []).length === 0 ? (
                  <div style={{textAlign: 'center', padding: '60px', color: '#94a3b8'}}>
                    <FileText size={48} style={{marginBottom: '16px', opacity: 0.5}} />
                    <div style={{fontSize: '16px', fontWeight: '500'}}>No Approvals</div>
                  </div>
                ) : (
                  <div style={{overflowX: 'auto'}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                      <thead>
                        <tr style={{background: '#f8fafc'}}>
                          <th style={{padding: '12px', textAlign: 'left', fontWeight: '600'}}>Type</th>
                          <th style={{padding: '12px', textAlign: 'left', fontWeight: '600'}}>Requested By</th>
                          <th style={{padding: '12px', textAlign: 'left', fontWeight: '600'}}>Date</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600'}}>Status</th>
                          <th style={{padding: '12px', textAlign: 'left', fontWeight: '600'}}>Reviewed By</th>
                          <th style={{padding: '12px', textAlign: 'center', fontWeight: '600'}}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filterByType(data.pendingApprovals || []).map(approval => (
                          <tr key={approval.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                            <td style={{padding: '12px'}}>{getTypeLabel(approval.type)}</td>
                            <td style={{padding: '12px'}}>{approval.requestedBy} ({approval.requestedByRole})</td>
                            <td style={{padding: '12px'}}>{new Date(approval.createdAt).toLocaleDateString()}</td>
                            <td style={{padding: '12px', textAlign: 'center'}}>{getStatusBadge(approval.status)}</td>
                            <td style={{padding: '12px'}}>{approval.actionedBy || '-'}</td>
                            <td style={{padding: '12px', textAlign: 'center'}}>
                              <button
                                onClick={() => setViewingApproval(approval)}
                                style={{
                                  padding: '6px 12px',
                                  background: '#e0f2fe',
                                  color: '#0369a1',
                                  border: 'none',
                                  borderRadius: '6px',
                                  cursor: 'pointer',
                                  fontSize: '11px'
                                }}
                              >
                                View
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
        
        {/* View Details Modal */}
        {viewingApproval && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 2000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '16px',
              width: '90%',
              maxWidth: '600px',
              maxHeight: '80vh',
              overflow: 'auto'
            }}>
              <div style={{
                padding: '20px',
                borderBottom: '1px solid #e2e8f0',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>Approval Details</h3>
                <button
                  onClick={() => setViewingApproval(null)}
                  style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px'}}
                >
                  <X size={20} />
                </button>
              </div>
              <div style={{padding: '20px'}}>
                <div style={{marginBottom: '16px'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <span style={{fontWeight: '600'}}>{getTypeLabel(viewingApproval.type)}</span>
                    {getStatusBadge(viewingApproval.status)}
                  </div>
                  <div style={{fontSize: '12px', color: '#64748b', marginTop: '4px'}}>
                    Requested by {viewingApproval.requestedBy} on {new Date(viewingApproval.createdAt).toLocaleString()}
                  </div>
                </div>
                {renderApprovalDetails(viewingApproval)}
                {viewingApproval.comments && (
                  <div style={{marginTop: '16px', padding: '12px', background: '#fef2f2', borderRadius: '8px'}}>
                    <strong>Reviewer Comment:</strong> {viewingApproval.comments}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
        
        {/* Edit & Approve Modal */}
        {editingApproval && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 2000
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '16px',
              width: '90%',
              maxWidth: '700px',
              maxHeight: '85vh',
              overflow: 'auto'
            }}>
              <div style={{
                padding: '20px',
                borderBottom: '1px solid #e2e8f0',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                background: '#fef3c7'
              }}>
                <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>âœŽ Edit Before Approving</h3>
                <button
                  onClick={() => {
                    setEditingApproval(null);
                    setEditedData(null);
                  }}
                  style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px'}}
                >
                  <X size={20} />
                </button>
              </div>
              <div style={{padding: '20px'}}>
                <div style={{marginBottom: '16px', color: '#64748b', fontSize: '13px'}}>
                  Make any necessary changes before approving this request.
                </div>
                
                {/* Edit form based on type */}
                {editingApproval.type === 'task' && editedData && (
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Client Name</label>
                      <input
                        type="text"
                        value={editedData.clientName || ''}
                        onChange={(e) => setEditedData({...editedData, clientName: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Task Manager</label>
                      <input
                        type="text"
                        value={editedData.taskManager || ''}
                        onChange={(e) => setEditedData({...editedData, taskManager: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Assigned To</label>
                      <input
                        type="text"
                        value={editedData.primaryAssignedUser || ''}
                        onChange={(e) => setEditedData({...editedData, primaryAssignedUser: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Period</label>
                      <input
                        type="text"
                        value={editedData.period || ''}
                        onChange={(e) => setEditedData({...editedData, period: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                )}
                
                {editingApproval.type === 'client_add' && editedData && (
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>File No</label>
                      <input
                        type="text"
                        value={editedData.fileNo || ''}
                        onChange={(e) => setEditedData({...editedData, fileNo: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Client Name</label>
                      <input
                        type="text"
                        value={editedData.name || ''}
                        onChange={(e) => setEditedData({...editedData, name: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Email</label>
                      <input
                        type="email"
                        value={editedData.email || ''}
                        onChange={(e) => setEditedData({...editedData, email: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px'}}>Mobile</label>
                      <input
                        type="text"
                        value={editedData.mobile || ''}
                        onChange={(e) => setEditedData({...editedData, mobile: e.target.value})}
                        style={{width: '100%', padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                )}
                
                {/* Generic JSON editor for other types */}
                {!['task', 'client_add'].includes(editingApproval.type) && editedData && (
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '8px'}}>Edit Data (JSON)</label>
                    <textarea
                      value={JSON.stringify(editedData, null, 2)}
                      onChange={(e) => {
                        try {
                          setEditedData(JSON.parse(e.target.value));
                        } catch (err) {}
                      }}
                      style={{
                        width: '100%',
                        minHeight: '200px',
                        padding: '12px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontFamily: 'monospace',
                        fontSize: '12px'
                      }}
                    />
                  </div>
                )}
              </div>
              <div style={{padding: '16px 20px', borderTop: '1px solid #e2e8f0', display: 'flex', justifyContent: 'flex-end', gap: '12px'}}>
                <button
                  onClick={() => {
                    setEditingApproval(null);
                    setEditedData(null);
                  }}
                  style={{
                    padding: '10px 20px',
                    background: '#f1f5f9',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '13px',
                    fontWeight: '500'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={() => {
                    handleApprovalAction(editingApproval.id, 'approve', editedData, 'Approved with modifications');
                    setEditingApproval(null);
                    setEditedData(null);
                  }}
                  style={{
                    padding: '10px 20px',
                    background: '#16a34a',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '13px',
                    fontWeight: '600'
                  }}
                >
                  âœ“ Approve with Changes
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };


  // ==================== DSC REGISTER VIEW ====================
  const DSCRegisterView = () => {
    const [dscSearch, setDscSearch] = useState('');
    const [dscStatusFilter, setDscStatusFilter] = useState('all');
    const [dscExpiryFilter, setDscExpiryFilter] = useState('all');
    const [showDscForm, setShowDscForm] = useState(false);
    const [editingDsc, setEditingDsc] = useState(null);
    const [viewingDsc, setViewingDsc] = useState(null);
    const [showPassword, setShowPassword] = useState({});
    
    const [dscFormData, setDscFormData] = useState({
      clientId: '',
      clientName: '',
      holderName: '',
      dscType: 'Signing', // Signing, Encryption, Both
      tokenSerialNo: '',
      issuingAuthority: '',
      issueDate: '',
      validity: '2 Years', // 1 Year, 2 Years, 3 Years
      expiryDate: '',
      password: '',
      physicalLocation: '',
      location: 'In Office', // In Office, With Client
      status: 'Pending for Verification', // Pending for Verification, Downloaded, Expired
      remarks: ''
    });
    
    const issuingAuthorities = ['eMudhra', 'Sify', 'nCode', 'Capricorn', 'CDAC', 'IDRBT', 'SafeScrypt', 'Other'];
    const dscTypes = ['Signing', 'Encryption', 'Both'];
    const dscStatuses = ['Pending for Verification', 'Downloaded'];
    const validityOptions = ['1 Year', '2 Years', '3 Years'];
    
    // Calculate expiry date from issue date and validity
    const calculateExpiryDate = (issueDate, validity) => {
      if (!issueDate) return '';
      const issue = new Date(issueDate);
      const years = parseInt(validity) || 2;
      issue.setFullYear(issue.getFullYear() + years);
      return issue.toISOString().split('T')[0];
    };
    
    // Get DSC records from data
    const dscRecords = data.dscRegister || [];
    
    // Calculate expiry status
    const getExpiryStatus = (expiryDate) => {
      if (!expiryDate) return 'unknown';
      const today = new Date();
      const expiry = new Date(expiryDate);
      const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
      
      if (daysUntilExpiry < 0) return 'expired';
      if (daysUntilExpiry <= 30) return 'expiring-soon';
      if (daysUntilExpiry <= 60) return 'expiring-60';
      return 'valid';
    };
    
    // Get effective status (auto-set to Expired if validity ends)
    const getEffectiveStatus = (dsc) => {
      if (getExpiryStatus(dsc.expiryDate) === 'expired') return 'Expired';
      return dsc.status || 'Pending for Verification';
    };
    
    // Filter DSC records
    const filteredDscRecords = dscRecords.filter(dsc => {
      // Search filter - works with 2+ letters
      const searchLower = dscSearch.toLowerCase().trim();
      const matchesSearch = searchLower.length < 2 || 
        (dsc.clientName || '').toLowerCase().includes(searchLower) ||
        (dsc.holderName || '').toLowerCase().includes(searchLower) ||
        (dsc.tokenSerialNo || '').toLowerCase().includes(searchLower) ||
        (dsc.issuingAuthority || '').toLowerCase().includes(searchLower);
      
      // Status filter (use effective status)
      const effectiveStatus = getEffectiveStatus(dsc);
      let matchesStatus = true;
      if (dscStatusFilter !== 'all') {
        if (dscStatusFilter === 'Expired') {
          matchesStatus = effectiveStatus === 'Expired';
        } else if (dscStatusFilter === 'Downloaded') {
          matchesStatus = dsc.status === 'Downloaded' && effectiveStatus !== 'Expired';
        } else if (dscStatusFilter === 'Pending for Verification') {
          matchesStatus = dsc.status === 'Pending for Verification' && effectiveStatus !== 'Expired';
        }
      }
      
      // Expiry filter
      let matchesExpiry = true;
      if (dscExpiryFilter !== 'all') {
        const expiryStatus = getExpiryStatus(dsc.expiryDate);
        if (dscExpiryFilter === 'expired') matchesExpiry = expiryStatus === 'expired';
        else if (dscExpiryFilter === 'expiring-soon') matchesExpiry = expiryStatus === 'expiring-soon';
        else if (dscExpiryFilter === 'expiring-60') matchesExpiry = expiryStatus === 'expiring-60' || expiryStatus === 'expiring-soon';
        else if (dscExpiryFilter === 'valid') matchesExpiry = expiryStatus === 'valid';
      }
      
      return matchesSearch && matchesStatus && matchesExpiry;
    });
    
    // Summary stats
    const totalDsc = dscRecords.length;
    const downloadedDsc = dscRecords.filter(d => d.status === 'Downloaded' && getExpiryStatus(d.expiryDate) !== 'expired').length;
    const expiredDsc = dscRecords.filter(d => getExpiryStatus(d.expiryDate) === 'expired').length;
    const expiringSoonDsc = dscRecords.filter(d => getExpiryStatus(d.expiryDate) === 'expiring-soon').length;
    
    // Reset form
    const resetDscForm = () => {
      setDscFormData({
        clientId: '',
        clientName: '',
        holderName: '',
        dscType: 'Signing',
        tokenSerialNo: '',
        issuingAuthority: '',
        issueDate: '',
        validity: '2 Years',
        expiryDate: '',
        password: '',
        physicalLocation: '',
        location: 'In Office',
        status: 'Pending for Verification',
        remarks: ''
      });
      setEditingDsc(null);
    };
    
    // Handle form submit
    const handleDscSubmit = () => {
      if (!dscFormData.clientName || !dscFormData.holderName || !dscFormData.issueDate) {
        alert('Please fill in required fields: Client Name, Holder Name, and Issue Date');
        return;
      }
      
      const now = new Date().toISOString();
      // Calculate expiry date from issue date and validity
      const calculatedExpiryDate = calculateExpiryDate(dscFormData.issueDate, dscFormData.validity);
      
      const dscData = {
        ...dscFormData,
        expiryDate: calculatedExpiryDate
      };
      
      if (editingDsc) {
        // Update existing
        const updatedDsc = dscRecords.map(dsc => 
          dsc.id === editingDsc.id 
            ? { ...dsc, ...dscData, updatedAt: now }
            : dsc
        );
        setData(prev => ({ ...prev, dscRegister: updatedDsc }));
      } else {
        // Add new
        const newDsc = {
          id: generateId(),
          ...dscData,
          createdAt: now,
          updatedAt: now,
          createdBy: currentUser?.name || 'Unknown'
        };
        setData(prev => ({ ...prev, dscRegister: [...(prev.dscRegister || []), newDsc] }));
      }
      
      setShowDscForm(false);
      resetDscForm();
    };
    
    // Handle edit
    const handleEditDsc = (dsc) => {
      // Calculate validity from issue and expiry dates
      let validity = '2 Years';
      if (dsc.issueDate && dsc.expiryDate) {
        const issue = new Date(dsc.issueDate);
        const expiry = new Date(dsc.expiryDate);
        const years = Math.round((expiry - issue) / (365 * 24 * 60 * 60 * 1000));
        if (years === 1) validity = '1 Year';
        else if (years === 3) validity = '3 Years';
        else validity = '2 Years';
      }
      
      setDscFormData({
        clientId: dsc.clientId || '',
        clientName: dsc.clientName || '',
        holderName: dsc.holderName || '',
        dscType: dsc.dscType || 'Signing',
        tokenSerialNo: dsc.tokenSerialNo || '',
        issuingAuthority: dsc.issuingAuthority || '',
        issueDate: dsc.issueDate || '',
        validity: dsc.validity || validity,
        expiryDate: dsc.expiryDate || '',
        password: dsc.password || '',
        physicalLocation: dsc.physicalLocation || '',
        location: dsc.location || 'In Office',
        status: dsc.status || 'Pending for Verification',
        remarks: dsc.remarks || ''
      });
      setEditingDsc(dsc);
      setShowDscForm(true);
    };
    
    // Handle delete
    const handleDeleteDsc = (dscId) => {
      if (window.confirm('Are you sure you want to delete this DSC record?')) {
        const updatedDsc = dscRecords.filter(dsc => dsc.id !== dscId);
        setData(prev => ({ ...prev, dscRegister: updatedDsc }));
      }
    };
    
    // Toggle location (In Office / With Client)
    const toggleDscLocation = (dscId) => {
      const updatedDsc = dscRecords.map(dsc => 
        dsc.id === dscId 
          ? { ...dsc, location: dsc.location === 'In Office' ? 'With Client' : 'In Office', updatedAt: new Date().toISOString() }
          : dsc
      );
      setData(prev => ({ ...prev, dscRegister: updatedDsc }));
    };
    
    // Toggle password visibility
    const togglePasswordVisibility = (dscId) => {
      setShowPassword(prev => ({ ...prev, [dscId]: !prev[dscId] }));
    };
    
    // Get expiry badge style
    const getExpiryBadgeStyle = (expiryDate) => {
      const status = getExpiryStatus(expiryDate);
      switch (status) {
        case 'expired': return { background: '#fee2e2', color: '#dc2626' };
        case 'expiring-soon': return { background: '#fef3c7', color: '#d97706' };
        case 'expiring-60': return { background: '#fef9c3', color: '#ca8a04' };
        case 'valid': return { background: '#dcfce7', color: '#16a34a' };
        default: return { background: '#f1f5f9', color: '#64748b' };
      }
    };
    
    // Get days until expiry text
    const getExpiryText = (expiryDate) => {
      if (!expiryDate) return 'No expiry set';
      const today = new Date();
      const expiry = new Date(expiryDate);
      const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
      
      if (daysUntilExpiry < 0) return `Expired ${Math.abs(daysUntilExpiry)} days ago`;
      if (daysUntilExpiry === 0) return 'Expires today';
      if (daysUntilExpiry === 1) return 'Expires tomorrow';
      if (daysUntilExpiry <= 30) return `Expires in ${daysUntilExpiry} days`;
      if (daysUntilExpiry <= 60) return `Expires in ${daysUntilExpiry} days`;
      return `Valid (${daysUntilExpiry} days)`;
    };
    
    return (
      <div style={{ padding: '24px', maxWidth: '1600px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ marginBottom: '24px' }}>
          <h1 style={{ fontSize: '24px', fontWeight: '700', color: '#0f172a', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '12px' }}>
            <Key size={28} color="#10b981" />
            DSC Register
          </h1>
          <p style={{ color: '#64748b', fontSize: '14px' }}>Manage Digital Signature Certificates for your clients</p>
        </div>
        
        {/* Summary Cards - Clickable */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
          <div 
            onClick={() => { setDscStatusFilter('all'); setDscExpiryFilter('all'); }}
            style={{ background: dscStatusFilter === 'all' && dscExpiryFilter === 'all' ? '#eff6ff' : '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: dscStatusFilter === 'all' && dscExpiryFilter === 'all' ? '2px solid #3b82f6' : '1px solid #e2e8f0', cursor: 'pointer', transition: 'all 0.2s' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: '#eff6ff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Key size={24} color="#3b82f6" />
              </div>
              <div>
                <div style={{ fontSize: '28px', fontWeight: '700', color: '#0f172a' }}>{totalDsc}</div>
                <div style={{ fontSize: '13px', color: '#64748b' }}>Total DSCs</div>
              </div>
            </div>
          </div>
          
          <div 
            onClick={() => { setDscStatusFilter('Downloaded'); setDscExpiryFilter('all'); }}
            style={{ background: dscStatusFilter === 'Downloaded' ? '#dcfce7' : '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: dscStatusFilter === 'Downloaded' ? '2px solid #16a34a' : '1px solid #e2e8f0', cursor: 'pointer', transition: 'all 0.2s' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: '#dcfce7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <CheckCircle size={24} color="#16a34a" />
              </div>
              <div>
                <div style={{ fontSize: '28px', fontWeight: '700', color: '#16a34a' }}>{downloadedDsc}</div>
                <div style={{ fontSize: '13px', color: '#64748b' }}>Downloaded DSCs</div>
              </div>
            </div>
          </div>
          
          <div 
            onClick={() => { setDscStatusFilter('all'); setDscExpiryFilter('expiring-soon'); }}
            style={{ background: dscExpiryFilter === 'expiring-soon' ? '#fef3c7' : '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: dscExpiryFilter === 'expiring-soon' ? '2px solid #d97706' : '1px solid #e2e8f0', cursor: 'pointer', transition: 'all 0.2s' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <AlertCircle size={24} color="#d97706" />
              </div>
              <div>
                <div style={{ fontSize: '28px', fontWeight: '700', color: '#d97706' }}>{expiringSoonDsc}</div>
                <div style={{ fontSize: '13px', color: '#64748b' }}>Due for Renewal (30 days)</div>
              </div>
            </div>
          </div>
          
          <div 
            onClick={() => { setDscStatusFilter('all'); setDscExpiryFilter('expired'); }}
            style={{ background: dscExpiryFilter === 'expired' ? '#fee2e2' : '#fff', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: dscExpiryFilter === 'expired' ? '2px solid #dc2626' : '1px solid #e2e8f0', cursor: 'pointer', transition: 'all 0.2s' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: '#fee2e2', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <XCircle size={24} color="#dc2626" />
              </div>
              <div>
                <div style={{ fontSize: '28px', fontWeight: '700', color: '#dc2626' }}>{expiredDsc}</div>
                <div style={{ fontSize: '13px', color: '#64748b' }}>Expired DSCs</div>
              </div>
            </div>
          </div>
        </div>
        
        {/* Action Bar */}
        <div style={{ background: '#fff', borderRadius: '12px', padding: '16px 20px', marginBottom: '24px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: '1px solid #e2e8f0', display: 'flex', flexWrap: 'wrap', gap: '12px', alignItems: 'center', justifyContent: 'space-between' }}>
          <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap', flex: 1 }}>
            {/* Search */}
            <div style={{ position: 'relative', minWidth: '250px' }}>
              <Search size={18} style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8' }} />
              <input
                type="text"
                placeholder="Type 2-3 letters to search client, holder..."
                value={dscSearch}
                onChange={(e) => setDscSearch(e.target.value)}
                style={{
                  width: '100%',
                  padding: '10px 12px 10px 40px',
                  border: '1px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '14px',
                  outline: 'none'
                }}
              />
            </div>
            
            {/* Status Filter */}
            <select
              value={dscStatusFilter}
              onChange={(e) => setDscStatusFilter(e.target.value)}
              style={{
                padding: '10px 12px',
                border: '1px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '14px',
                background: '#fff',
                cursor: 'pointer',
                minWidth: '160px'
              }}
            >
              <option value="all">All Status</option>
              <option value="Pending for Verification">Pending for Verification</option>
              <option value="Downloaded">Downloaded</option>
              <option value="Expired">Expired</option>
            </select>
            
            {/* Expiry Filter */}
            <select
              value={dscExpiryFilter}
              onChange={(e) => setDscExpiryFilter(e.target.value)}
              style={{
                padding: '10px 12px',
                border: '1px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '14px',
                background: '#fff',
                cursor: 'pointer',
                minWidth: '160px'
              }}
            >
              <option value="all">All Expiry</option>
              <option value="expired">Expired</option>
              <option value="expiring-soon">Due in 30 days</option>
              <option value="expiring-60">Due in 60 days</option>
              <option value="valid">Valid</option>
            </select>
          </div>
          
          {/* Add Button */}
          <button
            onClick={() => { resetDscForm(); setShowDscForm(true); }}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              padding: '10px 20px',
              background: '#10b981',
              color: '#fff',
              border: 'none',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'background 0.15s'
            }}
            onMouseEnter={(e) => e.currentTarget.style.background = '#059669'}
            onMouseLeave={(e) => e.currentTarget.style.background = '#10b981'}
          >
            <Plus size={18} />
            Add DSC
          </button>
        </div>
        
        {/* DSC Table */}
        <div style={{ background: '#fff', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', border: '1px solid #e2e8f0', overflow: 'hidden' }}>
          {filteredDscRecords.length === 0 ? (
            <div style={{ padding: '50px 24px', textAlign: 'center' }}>
              <Key size={40} color="#e2e8f0" style={{ marginBottom: '12px' }} />
              <h3 style={{ color: '#64748b', marginBottom: '8px', fontSize: '14px' }}>No DSC Records Found</h3>
              <p style={{ color: '#94a3b8', fontSize: '12px' }}>
                {dscSearch || dscStatusFilter !== 'all' || dscExpiryFilter !== 'all' 
                  ? 'Try adjusting your search or filters'
                  : 'Click "Add DSC" to register a new Digital Signature Certificate'}
              </p>
            </div>
          ) : (
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '1100px', fontSize: '12px' }}>
                <thead>
                  <tr style={{ background: 'linear-gradient(180deg, #10b981 0%, #059669 100%)' }}>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Client / Holder</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Type</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Token Serial</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Issuing Authority</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Expiry</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Password</th>
                    <th style={{ padding: '12px 14px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Location</th>
                    <th style={{ padding: '12px 14px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px', borderRight: '1px solid #34d399' }}>Status</th>
                    <th style={{ padding: '12px 14px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: '#fff', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredDscRecords.map((dsc, index) => (
                    <tr 
                      key={dsc.id} 
                      style={{ 
                        background: index % 2 === 0 ? '#fff' : '#f8fafc',
                        transition: 'background 0.15s',
                        borderBottom: '1px solid #e2e8f0'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#f0fdf4'}
                      onMouseLeave={(e) => e.currentTarget.style.background = index % 2 === 0 ? '#fff' : '#f8fafc'}
                    >
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0' }}>
                        <div style={{ fontWeight: '600', color: '#0f172a', marginBottom: '2px', fontSize: '12px' }}>{dsc.clientName}</div>
                        <div style={{ fontSize: '11px', color: '#64748b' }}>{dsc.holderName}</div>
                      </td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0' }}>
                        <span style={{
                          padding: '3px 8px',
                          borderRadius: '4px',
                          fontSize: '11px',
                          fontWeight: '600',
                          background: dsc.dscType === 'Both' ? '#ede9fe' : dsc.dscType === 'Encryption' ? '#fef3c7' : '#dcfce7',
                          color: dsc.dscType === 'Both' ? '#7c3aed' : dsc.dscType === 'Encryption' ? '#d97706' : '#16a34a'
                        }}>
                          {dsc.dscType}
                        </span>
                      </td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0', fontFamily: 'monospace', fontSize: '12px' }}>{dsc.tokenSerialNo || '-'}</td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0', fontSize: '12px' }}>{dsc.issuingAuthority || '-'}</td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0' }}>
                        <div style={{ marginBottom: '3px', fontSize: '12px' }}>{dsc.expiryDate ? new Date(dsc.expiryDate).toLocaleDateString('en-IN') : '-'}</div>
                        <span style={{
                          padding: '2px 6px',
                          borderRadius: '4px',
                          fontSize: '10px',
                          fontWeight: '600',
                          ...getExpiryBadgeStyle(dsc.expiryDate)
                        }}>
                          {getExpiryText(dsc.expiryDate)}
                        </span>
                      </td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ fontFamily: 'monospace', fontSize: '12px' }}>
                            {showPassword[dsc.id] ? (dsc.password || '-') : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}
                          </span>
                          {dsc.password && (
                            <button
                              onClick={() => togglePasswordVisibility(dsc.id)}
                              style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '2px' }}
                              title={showPassword[dsc.id] ? 'Hide password' : 'Show password'}
                            >
                              <Eye size={12} color="#64748b" />
                            </button>
                          )}
                        </div>
                      </td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0', textAlign: 'center' }}>
                        {/* Location Toggle Switch */}
                        <div 
                          onClick={() => toggleDscLocation(dsc.id)}
                          style={{
                            display: 'inline-flex',
                            alignItems: 'center',
                            cursor: 'pointer',
                            background: (dsc.location || 'In Office') === 'In Office' ? '#dcfce7' : '#fef3c7',
                            borderRadius: '20px',
                            padding: '4px',
                            position: 'relative',
                            width: '90px',
                            border: `1px solid ${(dsc.location || 'In Office') === 'In Office' ? '#10b981' : '#f59e0b'}`
                          }}
                        >
                          <div style={{
                            position: 'absolute',
                            left: (dsc.location || 'In Office') === 'In Office' ? '4px' : 'calc(100% - 44px)',
                            width: '40px',
                            height: '20px',
                            background: (dsc.location || 'In Office') === 'In Office' ? '#10b981' : '#f59e0b',
                            borderRadius: '16px',
                            transition: 'left 0.2s ease'
                          }} />
                          <span style={{
                            flex: 1,
                            textAlign: 'center',
                            fontSize: '9px',
                            fontWeight: '600',
                            color: (dsc.location || 'In Office') === 'In Office' ? '#fff' : '#92400e',
                            position: 'relative',
                            zIndex: 1,
                            padding: '2px 4px'
                          }}>
                            Office
                          </span>
                          <span style={{
                            flex: 1,
                            textAlign: 'center',
                            fontSize: '9px',
                            fontWeight: '600',
                            color: (dsc.location || 'In Office') === 'With Client' ? '#fff' : '#065f46',
                            position: 'relative',
                            zIndex: 1,
                            padding: '2px 4px'
                          }}>
                            Client
                          </span>
                        </div>
                      </td>
                      <td style={{ padding: '12px 14px', borderRight: '1px solid #e2e8f0' }}>
                        <span style={{
                          padding: '3px 8px',
                          borderRadius: '4px',
                          fontSize: '10px',
                          fontWeight: '600',
                          background: getEffectiveStatus(dsc) === 'Downloaded' ? '#dcfce7' : getEffectiveStatus(dsc) === 'Expired' ? '#fee2e2' : '#fef3c7',
                          color: getEffectiveStatus(dsc) === 'Downloaded' ? '#16a34a' : getEffectiveStatus(dsc) === 'Expired' ? '#dc2626' : '#d97706'
                        }}>
                          {getEffectiveStatus(dsc)}
                        </span>
                      </td>
                      <td style={{ padding: '12px 14px' }}>
                        <div style={{ display: 'flex', gap: '6px', justifyContent: 'center' }}>
                          <button
                            onClick={() => setViewingDsc(dsc)}
                            style={{ padding: '5px', background: '#eff6ff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                            title="View Details"
                          >
                            <Eye size={14} color="#3b82f6" />
                          </button>
                          <button
                            onClick={() => handleEditDsc(dsc)}
                            style={{ padding: '5px', background: '#fef3c7', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                            title="Edit"
                          >
                            <Edit size={14} color="#d97706" />
                          </button>
                          <button
                            onClick={() => handleDeleteDsc(dsc.id)}
                            style={{ padding: '5px', background: '#fee2e2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                            title="Delete"
                          >
                            <Trash2 size={14} color="#dc2626" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
        
        {/* Add/Edit DSC Modal */}
        {showDscForm && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px'
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '16px',
              width: '100%',
              maxWidth: '700px',
              maxHeight: '90vh',
              overflow: 'hidden',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              {/* Modal Header */}
              <div style={{
                padding: '20px 24px',
                background: '#10b981',
                color: '#fff',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
              }}>
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <Key size={22} />
                  {editingDsc ? 'Edit DSC Record' : 'Add New DSC'}
                </h2>
                <button
                  onClick={() => { setShowDscForm(false); resetDscForm(); }}
                  style={{ background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', padding: '8px', cursor: 'pointer', color: '#fff' }}
                >
                  <X size={20} />
                </button>
              </div>
              
              {/* Modal Body */}
              <div style={{ padding: '24px', overflowY: 'auto', maxHeight: 'calc(90vh - 140px)' }}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  {/* Client Selection */}
                  <div style={{ gridColumn: '1 / -1' }}>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Client Name <span style={{ color: '#dc2626' }}>*</span>
                    </label>
                    <select
                      value={dscFormData.clientId}
                      onChange={(e) => {
                        const selectedClient = data.clients.find(c => c.id === e.target.value);
                        setDscFormData({
                          ...dscFormData,
                          clientId: e.target.value,
                          clientName: selectedClient ? selectedClient.name : e.target.value
                        });
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#fff'
                      }}
                    >
                      <option value="">Select Client or Type Below</option>
                      {data.clients.map(client => (
                        <option key={client.id} value={client.id}>{client.name}</option>
                      ))}
                    </select>
                    <input
                      type="text"
                      placeholder="Or type client name manually..."
                      value={dscFormData.clientName}
                      onChange={(e) => setDscFormData({ ...dscFormData, clientName: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        marginTop: '8px'
                      }}
                    />
                  </div>
                  
                  {/* Holder Name */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      DSC Holder Name <span style={{ color: '#dc2626' }}>*</span>
                    </label>
                    <input
                      type="text"
                      placeholder="Name on DSC"
                      value={dscFormData.holderName}
                      onChange={(e) => setDscFormData({ ...dscFormData, holderName: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* DSC Type */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      DSC Type
                    </label>
                    <select
                      value={dscFormData.dscType}
                      onChange={(e) => setDscFormData({ ...dscFormData, dscType: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#fff'
                      }}
                    >
                      {dscTypes.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Token Serial */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Token/Dongle Serial No.
                    </label>
                    <input
                      type="text"
                      placeholder="Serial number"
                      value={dscFormData.tokenSerialNo}
                      onChange={(e) => setDscFormData({ ...dscFormData, tokenSerialNo: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* Issuing Authority */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Issuing Authority
                    </label>
                    <select
                      value={dscFormData.issuingAuthority}
                      onChange={(e) => setDscFormData({ ...dscFormData, issuingAuthority: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#fff'
                      }}
                    >
                      <option value="">Select Authority</option>
                      {issuingAuthorities.map(auth => (
                        <option key={auth} value={auth}>{auth}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Issue Date */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Issue Date <span style={{ color: '#dc2626' }}>*</span>
                    </label>
                    <input
                      type="date"
                      value={dscFormData.issueDate}
                      onChange={(e) => {
                        const newIssueDate = e.target.value;
                        const newExpiryDate = calculateExpiryDate(newIssueDate, dscFormData.validity);
                        setDscFormData({ ...dscFormData, issueDate: newIssueDate, expiryDate: newExpiryDate });
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* Validity */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Validity
                    </label>
                    <select
                      value={dscFormData.validity}
                      onChange={(e) => {
                        const newValidity = e.target.value;
                        const newExpiryDate = calculateExpiryDate(dscFormData.issueDate, newValidity);
                        setDscFormData({ ...dscFormData, validity: newValidity, expiryDate: newExpiryDate });
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#fff'
                      }}
                    >
                      {validityOptions.map(opt => (
                        <option key={opt} value={opt}>{opt}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Expiry Date (Auto-calculated) */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Expiry Date <span style={{ fontSize: '11px', color: '#64748b', fontWeight: '400' }}>(Auto-calculated)</span>
                    </label>
                    <input
                      type="date"
                      value={dscFormData.expiryDate || calculateExpiryDate(dscFormData.issueDate, dscFormData.validity)}
                      readOnly
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#f3f4f6',
                        color: '#6b7280'
                      }}
                    />
                  </div>
                  
                  {/* Password */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      DSC Password
                    </label>
                    <input
                      type="text"
                      placeholder="DSC password"
                      value={dscFormData.password}
                      onChange={(e) => setDscFormData({ ...dscFormData, password: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* Physical Location */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Physical Location
                    </label>
                    <input
                      type="text"
                      placeholder="Where is the token stored?"
                      value={dscFormData.physicalLocation}
                      onChange={(e) => setDscFormData({ ...dscFormData, physicalLocation: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* Status */}
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Status
                    </label>
                    <select
                      value={dscFormData.status}
                      onChange={(e) => setDscFormData({ ...dscFormData, status: e.target.value })}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: '#fff'
                      }}
                    >
                      {dscStatuses.map(status => (
                        <option key={status} value={status}>{status}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Remarks */}
                  <div style={{ gridColumn: '1 / -1' }}>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#374151' }}>
                      Remarks
                    </label>
                    <textarea
                      placeholder="Additional notes..."
                      value={dscFormData.remarks}
                      onChange={(e) => setDscFormData({ ...dscFormData, remarks: e.target.value })}
                      rows={3}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        resize: 'vertical'
                      }}
                    />
                  </div>
                </div>
              </div>
              
              {/* Modal Footer */}
              <div style={{
                padding: '16px 24px',
                borderTop: '1px solid #e5e7eb',
                display: 'flex',
                gap: '12px',
                justifyContent: 'flex-end',
                background: '#f9fafb'
              }}>
                <button
                  onClick={() => { setShowDscForm(false); resetDscForm(); }}
                  style={{
                    padding: '10px 20px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    background: '#fff',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleDscSubmit}
                  style={{
                    padding: '10px 20px',
                    border: 'none',
                    borderRadius: '8px',
                    background: '#10b981',
                    color: '#fff',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  {editingDsc ? 'Update DSC' : 'Add DSC'}
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* View DSC Details Modal */}
        {viewingDsc && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px'
          }}>
            <div style={{
              background: '#fff',
              borderRadius: '16px',
              width: '100%',
              maxWidth: '600px',
              maxHeight: '90vh',
              overflow: 'hidden',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              {/* Modal Header */}
              <div style={{
                padding: '20px 24px',
                background: '#3b82f6',
                color: '#fff',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
              }}>
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <Shield size={22} />
                  DSC Details
                </h2>
                <button
                  onClick={() => setViewingDsc(null)}
                  style={{ background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', padding: '8px', cursor: 'pointer', color: '#fff' }}
                >
                  <X size={20} />
                </button>
              </div>
              
              {/* Modal Body */}
              <div style={{ padding: '24px', overflowY: 'auto', maxHeight: 'calc(90vh - 80px)' }}>
                <div style={{ display: 'grid', gap: '16px' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Client Name</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.clientName}</div>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>DSC Holder</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.holderName}</div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>DSC Type</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.dscType}</div>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Validity</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.validity || '2 Years'}</div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Token Serial No.</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a', fontFamily: 'monospace' }}>{viewingDsc.tokenSerialNo || '-'}</div>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Issuing Authority</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.issuingAuthority || '-'}</div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Issue Date</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.issueDate ? new Date(viewingDsc.issueDate).toLocaleDateString('en-IN') : '-'}</div>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Expiry Date</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.expiryDate ? new Date(viewingDsc.expiryDate).toLocaleDateString('en-IN') : '-'}</div>
                      <span style={{
                        display: 'inline-block',
                        marginTop: '6px',
                        padding: '3px 8px',
                        borderRadius: '4px',
                        fontSize: '11px',
                        fontWeight: '600',
                        ...getExpiryBadgeStyle(viewingDsc.expiryDate)
                      }}>
                        {getExpiryText(viewingDsc.expiryDate)}
                      </span>
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Password</div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a', fontFamily: 'monospace' }}>
                          {showPassword[viewingDsc.id] ? (viewingDsc.password || '-') : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}
                        </span>
                        {viewingDsc.password && (
                          <button
                            onClick={() => togglePasswordVisibility(viewingDsc.id)}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '4px' }}
                          >
                            <Eye size={16} color="#64748b" />
                          </button>
                        )}
                      </div>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Status</div>
                      <span style={{
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '13px',
                        fontWeight: '600',
                        background: getEffectiveStatus(viewingDsc) === 'Downloaded' ? '#dcfce7' : getEffectiveStatus(viewingDsc) === 'Expired' ? '#fee2e2' : '#fef3c7',
                        color: getEffectiveStatus(viewingDsc) === 'Downloaded' ? '#16a34a' : getEffectiveStatus(viewingDsc) === 'Expired' ? '#dc2626' : '#d97706'
                      }}>
                        {getEffectiveStatus(viewingDsc)}
                      </span>
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Location</div>
                      <span style={{
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '13px',
                        fontWeight: '600',
                        background: (viewingDsc.location || 'In Office') === 'In Office' ? '#dcfce7' : '#fef3c7',
                        color: (viewingDsc.location || 'In Office') === 'In Office' ? '#16a34a' : '#d97706'
                      }}>
                        {viewingDsc.location || 'In Office'}
                      </span>
                    </div>
                    <div style={{ background: '#f8fafc', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px', textTransform: 'uppercase' }}>Physical Location</div>
                      <div style={{ fontSize: '15px', fontWeight: '600', color: '#0f172a' }}>{viewingDsc.physicalLocation || '-'}</div>
                    </div>
                  </div>
                  
                  {viewingDsc.remarks && (
                    <div style={{ background: '#fef3c7', padding: '16px', borderRadius: '10px' }}>
                      <div style={{ fontSize: '11px', color: '#92400e', marginBottom: '4px', textTransform: 'uppercase' }}>Remarks</div>
                      <div style={{ fontSize: '14px', color: '#78350f' }}>{viewingDsc.remarks}</div>
                    </div>
                  )}
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginTop: '8px', paddingTop: '16px', borderTop: '1px solid #e2e8f0' }}>
                    <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                      Created: {viewingDsc.createdAt ? new Date(viewingDsc.createdAt).toLocaleString('en-IN') : '-'}
                      {viewingDsc.createdBy && ` by ${viewingDsc.createdBy}`}
                    </div>
                    <div style={{ fontSize: '12px', color: '#94a3b8', textAlign: 'right' }}>
                      Updated: {viewingDsc.updatedAt ? new Date(viewingDsc.updatedAt).toLocaleString('en-IN') : '-'}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Packages View Component
  const PackagesView = () => {
    const [showAddPackageModal, setShowAddPackageModal] = useState(false);
    const [editingPackage, setEditingPackage] = useState(null);
    const [packageFilter, setPackageFilter] = useState('all'); // all, billed, unbilled, dueRenewal
    const [searchTerm, setSearchTerm] = useState('');
    
    const PACKAGE_SERVICES = [
      { id: 'retainership', name: 'Retainership' },
      { id: 'gstReturn', name: 'GST Return' },
      { id: 'itr', name: 'Income Tax Return' },
      { id: 'itrPersonal', name: 'Income Tax Return (Personal)' },
      { id: 'epfEsic', name: 'EPF-ESIC Return' },
      { id: 'advisory', name: 'Advisory' }
    ];
    
    const FREQUENCIES = ['Monthly', 'Quarterly', 'Half Yearly', 'Annual'];
    
    const [packageForm, setPackageForm] = useState({
      clientId: '',
      clientName: '',
      groupNo: '',
      clientCode: '',
      startDate: new Date().toISOString().split('T')[0],
      frequency: 'Monthly',
      services: [],
      amount: '',
      billed: false,
      notes: ''
    });
    
    // Calculate statistics
    const packages = data.packages || [];
    const today = new Date();
    const sixtyDaysFromNow = new Date(today.getTime() + (60 * 24 * 60 * 60 * 1000));
    
    // Current packages = packages that haven't been renewed (active packages)
    const currentPackages = packages.filter(p => !p.renewed);
    
    const totalPackageClients = currentPackages.length;
    const dueForRenewal = currentPackages.filter(p => {
      const endDate = new Date(p.endDate);
      return endDate <= sixtyDaysFromNow && endDate >= today;
    });
    const expiredPackages = currentPackages.filter(p => new Date(p.endDate) < today);
    
    // Billed shows ALL billed packages (including historical/renewed ones)
    const billedPackages = packages.filter(p => p.billed);
    
    // Unbilled shows only current unbilled packages
    const unbilledPackages = currentPackages.filter(p => !p.billed);
    
    // Filter packages for display
    const filteredPackages = packages.filter(p => {
      // For "all" filter, show only current packages
      if (packageFilter === 'all' && p.renewed) return false;
      
      // For "billed" filter, show ALL billed packages (including historical)
      if (packageFilter === 'billed') {
        if (!p.billed) return false;
      }
      
      // For "unbilled" filter, show only current unbilled packages
      if (packageFilter === 'unbilled') {
        if (p.billed || p.renewed) return false;
      }
      
      // For "dueRenewal" filter, show only current packages due for renewal
      if (packageFilter === 'dueRenewal') {
        if (p.renewed) return false;
        const endDate = new Date(p.endDate);
        if (endDate > sixtyDaysFromNow || endDate < today) return false;
      }
      
      // For "expired" filter, show only current expired packages
      if (packageFilter === 'expired') {
        if (p.renewed) return false;
        if (new Date(p.endDate) >= today) return false;
      }
      
      if (searchTerm) {
        const search = searchTerm.toLowerCase();
        return (p.clientName || '').toLowerCase().includes(search) ||
               (p.clientCode || '').toLowerCase().includes(search) ||
               (p.groupNo || '').toString().includes(search);
      }
      return true;
    });
    
    // Handle client selection
    const handleClientSelect = (clientId) => {
      const client = data.clients.find(c => c.id === clientId);
      if (client) {
        const groupNo = client.fileNo ? client.fileNo.split('.')[0] : '';
        setPackageForm(prev => ({
          ...prev,
          clientId: client.id,
          clientName: client.name,
          groupNo: groupNo,
          clientCode: formatFileNo(client.fileNo)
        }));
      }
    };
    
    // Calculate end date based on frequency
    const calculateEndDate = (startDate, frequency) => {
      if (!startDate) return '';
      const start = new Date(startDate);
      let end = new Date(start);
      switch (frequency) {
        case 'Monthly': end.setMonth(end.getMonth() + 1); break;
        case 'Quarterly': end.setMonth(end.getMonth() + 3); break;
        case 'Half Yearly': end.setMonth(end.getMonth() + 6); break;
        case 'Annual': end.setFullYear(end.getFullYear() + 1); break;
        default: end.setMonth(end.getMonth() + 1);
      }
      end.setDate(end.getDate() - 1);
      return end.toISOString().split('T')[0];
    };
    
    // Save package
    const savePackage = () => {
      if (!packageForm.clientId) {
        alert('Please select a client');
        return;
      }
      if (packageForm.services.length === 0) {
        alert('Please select at least one service');
        return;
      }
      if (!packageForm.amount || parseFloat(packageForm.amount) <= 0) {
        alert('Please enter package amount');
        return;
      }
      
      const endDate = calculateEndDate(packageForm.startDate, packageForm.frequency);
      
      const packageData = {
        id: editingPackage ? editingPackage.id : `pkg_${Date.now()}`,
        clientId: packageForm.clientId,
        clientName: packageForm.clientName,
        groupNo: packageForm.groupNo,
        clientCode: packageForm.clientCode,
        startDate: packageForm.startDate,
        endDate: endDate,
        frequency: packageForm.frequency,
        services: packageForm.services,
        totalAmount: parseFloat(packageForm.amount) || 0,
        billed: packageForm.billed,
        notes: packageForm.notes,
        createdAt: editingPackage ? editingPackage.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: currentUser?.name || 'Unknown',
        renewalCount: editingPackage ? editingPackage.renewalCount : 0
      };
      
      setData(prev => ({
        ...prev,
        packages: editingPackage 
          ? prev.packages.map(p => p.id === editingPackage.id ? packageData : p)
          : [...(prev.packages || []), packageData]
      }));
      
      resetForm();
    };
    
    // Reset form
    const resetForm = () => {
      setPackageForm({
        clientId: '',
        clientName: '',
        groupNo: '',
        clientCode: '',
        startDate: new Date().toISOString().split('T')[0],
        frequency: 'Monthly',
        services: [],
        amount: '',
        billed: false,
        notes: ''
      });
      setEditingPackage(null);
      setShowAddPackageModal(false);
    };
    
    // Edit package
    const handleEdit = (pkg) => {
      setPackageForm({
        clientId: pkg.clientId,
        clientName: pkg.clientName,
        groupNo: pkg.groupNo,
        clientCode: pkg.clientCode,
        startDate: pkg.startDate,
        frequency: pkg.frequency || 'Monthly',
        services: pkg.services || [],
        amount: pkg.totalAmount?.toString() || '',
        billed: pkg.billed,
        notes: pkg.notes || ''
      });
      setEditingPackage(pkg);
      setShowAddPackageModal(true);
    };
    
    // Delete package
    const handleDelete = (pkgId) => {
      if (window.confirm('Are you sure you want to delete this package?')) {
        setData(prev => ({
          ...prev,
          packages: prev.packages.filter(p => p.id !== pkgId)
        }));
      }
    };
    
    // Renew package
    const handleRenew = (pkg) => {
      const oldEndDate = new Date(pkg.endDate);
      const newStartDate = new Date(oldEndDate);
      newStartDate.setDate(newStartDate.getDate() + 1);
      const newEndDate = calculateEndDate(newStartDate.toISOString().split('T')[0], pkg.frequency || 'Monthly');
      
      // Create a NEW package for the renewed period
      const newPackage = {
        id: 'pkg_' + Date.now(),
        clientId: pkg.clientId,
        clientName: pkg.clientName,
        groupNo: pkg.groupNo,
        clientCode: pkg.clientCode,
        startDate: newStartDate.toISOString().split('T')[0],
        endDate: newEndDate,
        frequency: pkg.frequency || 'Monthly',
        services: [...(pkg.services || [])],
        totalAmount: pkg.totalAmount,
        billed: false,
        notes: pkg.notes || '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: currentUser?.name || 'System',
        renewalCount: (pkg.renewalCount || 0) + 1,
        previousPackageId: pkg.id // Link to previous package
      };
      
      // Mark the old package as renewed (historical) - it stays in billed list if it was billed
      const updatedOldPackage = {
        ...pkg,
        renewed: true, // Mark as historical/renewed
        renewedToId: newPackage.id, // Link to new package
        updatedAt: new Date().toISOString()
      };
      
      setData(prev => ({
        ...prev,
        packages: [
          ...prev.packages.map(p => p.id === pkg.id ? updatedOldPackage : p),
          newPackage
        ]
      }));
      
      alert(`Package renewed!\nNew period: ${newStartDate.toLocaleDateString('en-IN')} to ${new Date(newEndDate).toLocaleDateString('en-IN')}\n\nThe previous package record has been preserved.`);
    };
    
    // Toggle billed status
    const toggleBilled = (pkgId) => {
      setData(prev => ({
        ...prev,
        packages: prev.packages.map(p => p.id === pkgId ? {...p, billed: !p.billed, updatedAt: new Date().toISOString()} : p)
      }));
    };
    
    // Get service names from package
    const getServiceNames = (services) => {
      if (!services || services.length === 0) return '-';
      return services.map(svcId => {
        const svc = PACKAGE_SERVICES.find(s => s.id === svcId);
        return svc ? svc.name : svcId;
      }).join(', ');
    };
    
    // Toggle service selection
    const toggleService = (serviceId) => {
      setPackageForm(prev => ({
        ...prev,
        services: prev.services.includes(serviceId)
          ? prev.services.filter(s => s !== serviceId)
          : [...prev.services, serviceId]
      }));
    };
    
    return (
      <div style={{padding: '24px 40px', background: '#f8fafc', minHeight: '100%'}}>
        {/* Header */}
        <div className="view-header">
          <div>
            <div className="breadcrumb">
              <span onClick={() => setCurrentView('dashboard')} style={{cursor: 'pointer', color: '#10b981'}}>Dashboard</span>
              <ChevronRight size={16} />
              <span className="current">Client Packages</span>
            </div>
            <h1>Client Packages</h1>
          </div>
          <button className="btn-primary" onClick={() => setShowAddPackageModal(true)}>
            <Plus size={20} /> Add Package
          </button>
        </div>
        
        {/* Statistics Cards */}
        <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px'}}>
          <div 
            onClick={() => setPackageFilter('all')}
            style={{
              background: packageFilter === 'all' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)',
              color: packageFilter === 'all' ? '#fff' : '#065f46',
              padding: '16px 20px',
              borderRadius: '12px',
              cursor: 'pointer',
              boxShadow: packageFilter === 'all' ? '0 4px 12px rgba(16,185,129,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
              transition: 'all 0.2s'
            }}
          >
            <div style={{fontSize: '28px', fontWeight: '700'}}>{totalPackageClients}</div>
            <div style={{fontSize: '12px', fontWeight: '600'}}>Total Package Clients</div>
          </div>
          
          <div 
            onClick={() => setPackageFilter('dueRenewal')}
            style={{
              background: packageFilter === 'dueRenewal' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
              color: packageFilter === 'dueRenewal' ? '#fff' : '#92400e',
              padding: '16px 20px',
              borderRadius: '12px',
              cursor: 'pointer',
              boxShadow: packageFilter === 'dueRenewal' ? '0 4px 12px rgba(245,158,11,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
              transition: 'all 0.2s'
            }}
          >
            <div style={{fontSize: '28px', fontWeight: '700'}}>{dueForRenewal.length}</div>
            <div style={{fontSize: '12px', fontWeight: '600'}}>Due for Renewal (60 days)</div>
          </div>
          
          <div 
            onClick={() => setPackageFilter('billed')}
            style={{
              background: packageFilter === 'billed' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
              color: packageFilter === 'billed' ? '#fff' : '#1e40af',
              padding: '16px 20px',
              borderRadius: '12px',
              cursor: 'pointer',
              boxShadow: packageFilter === 'billed' ? '0 4px 12px rgba(59,130,246,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
              transition: 'all 0.2s'
            }}
          >
            <div style={{fontSize: '28px', fontWeight: '700'}}>{billedPackages.length}</div>
            <div style={{fontSize: '12px', fontWeight: '600'}}>Billed</div>
          </div>
          
          <div 
            onClick={() => setPackageFilter('unbilled')}
            style={{
              background: packageFilter === 'unbilled' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
              color: packageFilter === 'unbilled' ? '#fff' : '#92400e',
              padding: '16px 20px',
              borderRadius: '12px',
              cursor: 'pointer',
              boxShadow: packageFilter === 'unbilled' ? '0 4px 12px rgba(245,158,11,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
              transition: 'all 0.2s'
            }}
          >
            <div style={{fontSize: '28px', fontWeight: '700'}}>{unbilledPackages.length}</div>
            <div style={{fontSize: '12px', fontWeight: '600'}}>Unbilled</div>
          </div>
          
          <div 
            onClick={() => setPackageFilter('expired')}
            style={{
              background: packageFilter === 'expired' ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
              color: packageFilter === 'expired' ? '#fff' : '#991b1b',
              padding: '16px 20px',
              borderRadius: '12px',
              cursor: 'pointer',
              boxShadow: packageFilter === 'expired' ? '0 4px 12px rgba(239,68,68,0.3)' : '0 2px 8px rgba(0,0,0,0.06)',
              transition: 'all 0.2s'
            }}
          >
            <div style={{fontSize: '28px', fontWeight: '700'}}>{expiredPackages.length}</div>
            <div style={{fontSize: '12px', fontWeight: '600'}}>Expired</div>
          </div>
        </div>
        
        {/* Search */}
        <div style={{marginBottom: '16px'}}>
          <input
            type="text"
            placeholder="Search by client name, code, or group no..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            style={{
              width: '300px',
              padding: '10px 16px',
              border: '1px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '13px'
            }}
          />
        </div>
        
        {/* Packages Table */}
        <div style={{background: '#fff', borderRadius: '8px', overflow: 'hidden', boxShadow: '0 1px 4px rgba(0,0,0,0.08)', border: '1px solid #e5e7eb'}}>
          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
            <thead>
              <tr style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>
                <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>S.No</th>
                <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Group No.</th>
                <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Client Code</th>
                <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Client Name</th>
                <th style={{padding: '10px 12px', textAlign: 'left', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Services</th>
                <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Frequency</th>
                <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Start Date</th>
                <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>End Date</th>
                <th style={{padding: '10px 12px', textAlign: 'right', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Amount</th>
                <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Status</th>
                <th style={{padding: '10px 12px', textAlign: 'center', fontWeight: '600', color: '#fff', border: '1px solid #059669'}}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {filteredPackages.length === 0 ? (
                <tr>
                  <td colSpan={11} style={{padding: '40px', textAlign: 'center', color: '#64748b', border: '1px solid #e5e7eb'}}>
                    No packages found
                  </td>
                </tr>
              ) : (
                filteredPackages.map((pkg, idx) => {
                  const endDate = new Date(pkg.endDate);
                  const isDueForRenewal = !pkg.renewed && endDate <= sixtyDaysFromNow && endDate >= today;
                  const isExpired = !pkg.renewed && endDate < today;
                  const isHistorical = pkg.renewed;
                  
                  return (
                    <tr key={pkg.id} style={{
                      background: isHistorical ? '#fef9e7' : (idx % 2 === 0 ? '#fff' : '#f0fdf4'),
                      opacity: isHistorical ? 0.85 : 1
                    }}>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb'}}>{idx + 1}</td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', fontWeight: '600'}}>{pkg.groupNo}</td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', color: '#6366f1', fontWeight: '500'}}>{pkg.clientCode}</td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', fontWeight: '500'}}>
                        {pkg.clientName}
                        {isHistorical && (
                          <span style={{marginLeft: '6px', padding: '2px 6px', borderRadius: '8px', fontSize: '9px', fontWeight: '600', background: '#fde68a', color: '#92400e'}}>
                            Historical
                          </span>
                        )}
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', fontSize: '11px', maxWidth: '180px'}}>
                        {getServiceNames(pkg.services)}
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                        <span style={{padding: '3px 8px', borderRadius: '10px', fontSize: '10px', fontWeight: '600', background: '#e0e7ff', color: '#4338ca'}}>
                          {pkg.frequency || 'Monthly'}
                        </span>
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px'}}>
                        {new Date(pkg.startDate).toLocaleDateString('en-IN')}
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'center', fontSize: '11px',
                        color: isExpired ? '#dc2626' : isDueForRenewal ? '#d97706' : '#1e293b',
                        fontWeight: isExpired || isDueForRenewal ? '600' : '400'
                      }}>
                        {new Date(pkg.endDate).toLocaleDateString('en-IN')}
                        {isDueForRenewal && <span style={{display: 'block', fontSize: '9px'}}>Due for renewal</span>}
                        {isExpired && <span style={{display: 'block', fontSize: '9px'}}>Expired</span>}
                        {isHistorical && <span style={{display: 'block', fontSize: '9px', color: '#92400e'}}>Renewed</span>}
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'right', fontWeight: '600', color: '#059669'}}>
                        â‚¹{(pkg.totalAmount || 0).toLocaleString('en-IN')}
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                        <span 
                          onClick={() => !isHistorical && toggleBilled(pkg.id)}
                          style={{
                            padding: '3px 10px',
                            borderRadius: '12px',
                            fontSize: '10px',
                            fontWeight: '600',
                            cursor: isHistorical ? 'default' : 'pointer',
                            background: pkg.billed ? '#d1fae5' : '#fee2e2',
                            color: pkg.billed ? '#065f46' : '#991b1b'
                          }}
                        >
                          {pkg.billed ? 'Billed' : 'Unbilled'}
                        </span>
                      </td>
                      <td style={{padding: '8px 12px', border: '1px solid #e5e7eb', textAlign: 'center'}}>
                        <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                          {!isHistorical && (
                            <>
                              <button
                                onClick={() => handleEdit(pkg)}
                                style={{padding: '4px 8px', background: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px'}}
                                title="Edit"
                              >
                                <Edit size={12} />
                              </button>
                              <button
                                onClick={() => handleRenew(pkg)}
                                style={{padding: '4px 8px', background: '#dbeafe', color: '#2563eb', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px'}}
                                title="Renew"
                              >
                                <RefreshCw size={12} />
                              </button>
                            </>
                          )}
                          <button
                            onClick={() => handleDelete(pkg.id)}
                            style={{padding: '4px 8px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px'}}
                            title="Delete"
                          >
                            <Trash2 size={12} />
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
        
        {/* Add/Edit Package Modal */}
        {showAddPackageModal && (
          <div style={{
            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
            background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000
          }}>
            <div style={{
              background: '#fff', borderRadius: '12px', width: '600px', maxWidth: '95%',
              maxHeight: '90vh', overflow: 'auto'
            }}>
              <div style={{padding: '20px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <h2 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                  {editingPackage ? 'Edit Package' : 'Add New Package'}
                </h2>
                <button onClick={resetForm} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px'}}>
                  <X size={20} />
                </button>
              </div>
              
              <div style={{padding: '20px'}}>
                {/* Client Selection */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                    Select Client <span style={{color: '#ef4444'}}>*</span>
                  </label>
                  <select
                    value={packageForm.clientId}
                    onChange={(e) => handleClientSelect(e.target.value)}
                    style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                  >
                    <option value="">-- Select Client --</option>
                    {data.clients.filter(c => !c.disabled).map(c => (
                      <option key={c.id} value={c.id}>{c.name} ({formatFileNo(c.fileNo)})</option>
                    ))}
                  </select>
                </div>
                
                {/* Auto-filled fields */}
                {packageForm.clientId && (
                  <div style={{display: 'grid', gridTemplateColumns: '80px 100px 1fr', gap: '12px', marginBottom: '16px'}}>
                    <div>
                      <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px', color: '#64748b'}}>Group No.</label>
                      <input
                        type="text"
                        value={packageForm.groupNo}
                        readOnly
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', background: '#f8fafc', fontSize: '13px', fontWeight: '600', textAlign: 'center'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px', color: '#64748b'}}>Client Code</label>
                      <input
                        type="text"
                        value={packageForm.clientCode}
                        readOnly
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', background: '#f0fdf4', fontSize: '13px', fontWeight: '600', color: '#166534', textAlign: 'center'}}
                      />
                    </div>
                    <div>
                      <label style={{display: 'block', fontSize: '11px', fontWeight: '500', marginBottom: '4px', color: '#64748b'}}>Client Name</label>
                      <input
                        type="text"
                        value={packageForm.clientName}
                        readOnly
                        style={{width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px', background: '#f8fafc', fontSize: '13px'}}
                      />
                    </div>
                  </div>
                )}
                
                {/* Services Selection */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '8px', color: '#374151'}}>
                    Services <span style={{color: '#ef4444'}}>*</span>
                  </label>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px'}}>
                    {PACKAGE_SERVICES.map(svc => (
                      <label 
                        key={svc.id}
                        style={{
                          display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 12px',
                          border: packageForm.services.includes(svc.id) ? '2px solid #10b981' : '1px solid #e2e8f0',
                          borderRadius: '8px', cursor: 'pointer',
                          background: packageForm.services.includes(svc.id) ? '#f0fdf4' : '#fff',
                          transition: 'all 0.15s'
                        }}
                      >
                        <input
                          type="checkbox"
                          checked={packageForm.services.includes(svc.id)}
                          onChange={() => toggleService(svc.id)}
                          style={{width: '16px', height: '16px', accentColor: '#10b981'}}
                        />
                        <span style={{fontSize: '12px', fontWeight: packageForm.services.includes(svc.id) ? '600' : '400'}}>{svc.name}</span>
                      </label>
                    ))}
                  </div>
                </div>
                
                {/* Frequency and Amount */}
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                      Frequency <span style={{color: '#ef4444'}}>*</span>
                    </label>
                    <select
                      value={packageForm.frequency}
                      onChange={(e) => setPackageForm(prev => ({...prev, frequency: e.target.value}))}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    >
                      {FREQUENCIES.map(f => <option key={f} value={f}>{f}</option>)}
                    </select>
                  </div>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                      Package Amount (â‚¹) <span style={{color: '#ef4444'}}>*</span>
                    </label>
                    <input
                      type="number"
                      value={packageForm.amount}
                      onChange={(e) => setPackageForm(prev => ({...prev, amount: e.target.value}))}
                      placeholder="Enter total package amount"
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>
                </div>
                
                {/* Dates */}
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>Start Date</label>
                    <input
                      type="date"
                      value={packageForm.startDate}
                      onChange={(e) => setPackageForm(prev => ({...prev, startDate: e.target.value}))}
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px'}}
                    />
                  </div>
                  <div>
                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>End Date (Auto-calculated)</label>
                    <input
                      type="text"
                      value={packageForm.startDate ? new Date(calculateEndDate(packageForm.startDate, packageForm.frequency)).toLocaleDateString('en-IN') : ''}
                      readOnly
                      style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', background: '#f8fafc', fontWeight: '600', color: '#059669'}}
                    />
                  </div>
                </div>
                
                {/* Notes */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'block', fontSize: '12px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>Notes</label>
                  <textarea
                    value={packageForm.notes}
                    onChange={(e) => setPackageForm(prev => ({...prev, notes: e.target.value}))}
                    placeholder="Any additional notes..."
                    rows={2}
                    style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '6px', fontSize: '13px', resize: 'none'}}
                  />
                </div>
                
                {/* Billed Status */}
                <div style={{marginBottom: '16px'}}>
                  <label style={{display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer'}}>
                    <input
                      type="checkbox"
                      checked={packageForm.billed}
                      onChange={(e) => setPackageForm(prev => ({...prev, billed: e.target.checked}))}
                      style={{width: '16px', height: '16px', accentColor: '#10b981'}}
                    />
                    <span style={{fontSize: '13px', fontWeight: '500'}}>Mark as Billed</span>
                  </label>
                </div>
              </div>
              
              <div style={{padding: '16px 20px', borderTop: '1px solid #e2e8f0', display: 'flex', gap: '12px', justifyContent: 'flex-end'}}>
                <button
                  onClick={resetForm}
                  style={{padding: '10px 20px', background: '#f1f5f9', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  Cancel
                </button>
                <button
                  onClick={savePackage}
                  style={{padding: '10px 20px', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '500'}}
                >
                  {editingPackage ? 'Update Package' : 'Save Package'}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Render current view
  const renderView = () => {
    switch(currentView) {
      case 'login': return null; // Login is rendered separately
      case 'dashboard': return <DashboardView />;
      case 'task-detail': return <TaskDetailView />;
      case 'clients': return <ClientsView />;
      case 'staff': return <StaffView />;
      case 'invoicing': return <InvoicingView />;
      case 'timesheetReports': return <TimesheetReportsView />;
      case 'templates': return <TemplatesView />;
      case 'reports': return <ReportsView />;
      case 'approvals': return <ApprovalsView />;
      case 'dscRegister': return <DSCRegisterView />;
      case 'packages': return <PackagesView />;
      default: return <DashboardView />;
    }
  };

  // Show loading screen while Firebase initializes
  if (firebaseLoading) {
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #d1fae5 100%)',
        zIndex: 9999
      }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{
            width: '60px',
            height: '60px',
            border: '4px solid #e2e8f0',
            borderTopColor: '#10b981',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            margin: '0 auto 20px'
          }} />
          <h2 style={{ color: '#166534', marginBottom: '8px' }}>CA Hub Pro</h2>
          <p style={{ color: '#64748b', fontSize: '14px' }}>Loading...</p>
          <style>{`
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          `}</style>
        </div>
      </div>
    );
  }

  // Show login overlay if on login view
  if (currentView === 'login') {
    return <LoginView />;
  }

  return (
    <div className="app">
      <Sidebar />
      <main className="main-content">
        {/* Top Bar with Notifications */}
        <div style={{
          height: '50px',
          background: '#fff',
          borderBottom: '1px solid #e2e8f0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'flex-end',
          padding: '0 24px',
          gap: '16px',
          position: 'sticky',
          top: 0,
          zIndex: 100
        }}>
          {/* Notification Bell */}
          <div style={{position: 'relative'}}>
            <button
              onClick={() => setShowNotificationDropdown(!showNotificationDropdown)}
              style={{
                background: 'none',
                border: 'none',
                cursor: 'pointer',
                padding: '8px',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                position: 'relative'
              }}
              onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
              onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
            >
              <Bell size={22} color="#64748b" />
              {(() => {
                const pendingCount = getPendingApprovalsForUser().length;
                const myPendingCount = getMyApprovalRequests().filter(a => a.status === 'pending').length;
                const myActionedCount = getMyApprovalRequests().filter(a => 
                  (a.status === 'approved' || a.status === 'rejected') && 
                  !a.seenByRequester
                ).length;
                const totalBadge = pendingCount + myActionedCount;
                
                if (totalBadge > 0) {
                  return (
                    <span style={{
                      position: 'absolute',
                      top: '2px',
                      right: '2px',
                      background: '#ef4444',
                      color: '#fff',
                      borderRadius: '50%',
                      width: '18px',
                      height: '18px',
                      fontSize: '10px',
                      fontWeight: '700',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      {totalBadge > 9 ? '9+' : totalBadge}
                    </span>
                  );
                }
                return null;
              })()}
            </button>
            
            {/* Notification Dropdown */}
            {showNotificationDropdown && (
              <div style={{
                position: 'absolute',
                top: '100%',
                right: 0,
                marginTop: '8px',
                width: '380px',
                background: '#fff',
                borderRadius: '12px',
                boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
                border: '1px solid #e2e8f0',
                maxHeight: '450px',
                overflow: 'hidden',
                zIndex: 1000
              }}>
                <div style={{
                  padding: '16px',
                  borderBottom: '1px solid #e2e8f0',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <h3 style={{margin: 0, fontSize: '14px', fontWeight: '600'}}>ðŸ”” Notifications</h3>
                  <button
                    onClick={() => setShowNotificationDropdown(false)}
                    style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px'}}
                  >
                    <X size={16} color="#64748b" />
                  </button>
                </div>
                
                <div style={{maxHeight: '350px', overflowY: 'auto'}}>
                  {/* Pending Approvals for Current User */}
                  {getPendingApprovalsForUser().length > 0 && (
                    <div>
                      <div style={{padding: '8px 16px', background: '#f8fafc', fontSize: '11px', fontWeight: '600', color: '#64748b'}}>
                        PENDING YOUR APPROVAL
                      </div>
                      {getPendingApprovalsForUser().slice(0, 5).map(approval => (
                        <div
                          key={approval.id}
                          onClick={() => {
                            setShowNotificationDropdown(false);
                            setCurrentView('approvals');
                          }}
                          style={{
                            padding: '12px 16px',
                            borderBottom: '1px solid #f1f5f9',
                            cursor: 'pointer',
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'flex-start'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                          onMouseLeave={(e) => e.currentTarget.style.background = '#fff'}
                        >
                          <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '50%',
                            background: '#fef3c7',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                          }}>
                            <Clock size={18} color="#d97706" />
                          </div>
                          <div style={{flex: 1, minWidth: 0}}>
                            <div style={{fontSize: '13px', fontWeight: '500', marginBottom: '2px'}}>
                              {approval.description}
                            </div>
                            <div style={{fontSize: '11px', color: '#64748b'}}>
                              By {approval.requestedBy} â€¢ {new Date(approval.createdAt).toLocaleDateString()}
                            </div>
                          </div>
                          <span style={{
                            padding: '2px 8px',
                            background: '#fef3c7',
                            color: '#d97706',
                            borderRadius: '4px',
                            fontSize: '10px',
                            fontWeight: '600'
                          }}>
                            Pending
                          </span>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* My Request Updates */}
                  {getMyApprovalRequests().filter(a => a.status !== 'pending').slice(0, 5).map(approval => (
                    <div
                      key={approval.id}
                      style={{
                        padding: '12px 16px',
                        borderBottom: '1px solid #f1f5f9',
                        display: 'flex',
                        gap: '12px',
                        alignItems: 'flex-start',
                        background: !approval.seenByRequester ? '#eff6ff' : '#fff'
                      }}
                    >
                      <div style={{
                        width: '36px',
                        height: '36px',
                        borderRadius: '50%',
                        background: approval.status === 'approved' ? '#dcfce7' : '#fef2f2',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }}>
                        {approval.status === 'approved' ? 
                          <CheckCircle size={18} color="#16a34a" /> : 
                          <XCircle size={18} color="#ef4444" />
                        }
                      </div>
                      <div style={{flex: 1, minWidth: 0}}>
                        <div style={{fontSize: '13px', fontWeight: '500', marginBottom: '2px'}}>
                          {approval.description}
                        </div>
                        <div style={{fontSize: '11px', color: '#64748b'}}>
                          {approval.status === 'approved' ? 'Approved' : 'Rejected'} by {approval.actionedBy}
                        </div>
                      </div>
                      <span style={{
                        padding: '2px 8px',
                        background: approval.status === 'approved' ? '#dcfce7' : '#fef2f2',
                        color: approval.status === 'approved' ? '#16a34a' : '#ef4444',
                        borderRadius: '4px',
                        fontSize: '10px',
                        fontWeight: '600'
                      }}>
                        {approval.status === 'approved' ? 'âœ“ Approved' : 'âœ— Rejected'}
                      </span>
                    </div>
                  ))}
                  
                  {getPendingApprovalsForUser().length === 0 && getMyApprovalRequests().length === 0 && (
                    <div style={{padding: '40px 20px', textAlign: 'center', color: '#94a3b8'}}>
                      <Bell size={32} style={{marginBottom: '12px', opacity: 0.5}} />
                      <div>No notifications</div>
                    </div>
                  )}
                </div>
                
                {(getPendingApprovalsForUser().length > 0 || getMyApprovalRequests().length > 0) && (
                  <div style={{padding: '12px', borderTop: '1px solid #e2e8f0', textAlign: 'center'}}>
                    <button
                      onClick={() => {
                        setShowNotificationDropdown(false);
                        setCurrentView('approvals');
                      }}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#3b82f6',
                        fontSize: '13px',
                        fontWeight: '600',
                        cursor: 'pointer'
                      }}
                    >
                      View All Approvals â†’
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
          
          {/* User Info */}
          <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
            <div style={{
              width: '32px',
              height: '32px',
              borderRadius: '50%',
              background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              color: '#fff',
              fontSize: '13px',
              fontWeight: '600'
            }}>
              {currentUser?.name?.[0] || 'U'}
            </div>
            <div>
              <div style={{fontSize: '13px', fontWeight: '500', color: '#1e293b'}}>{currentUser?.name}</div>
              <div style={{fontSize: '10px', color: '#64748b'}}>{currentUser?.role}</div>
            </div>
          </div>
        </div>
        
        {renderView()}
      </main>
      <Modal />
      <TaskManagementModal />
      
      {/* Add Task Modal */}
      {showAddTaskModal && (
        <AddTaskForm
          onClose={() => setShowAddTaskModal(false)}
          onAddClient={(newClient) => {
            console.log('=== ADDING NEW CLIENT FROM TASK FORM ===');
            console.log('New client:', newClient);
            setData(prev => {
              const updatedClients = [...prev.clients, newClient];
              console.log('Clients updated. New count:', updatedClients.length);
              return {
                ...prev,
                clients: updatedClients
              };
            });
          }}
          onSave={(newTask) => {
            console.log('=== SAVING NEW TASK ===');
            console.log('New task received:', newTask);
            console.log('Current tasks count:', data.tasks.length);
            
            // Check for duplicate task
            if (isDuplicateTask(newTask, data.tasks)) {
              alert(`âš ï¸ Duplicate Task!\n\nA task already exists for:\nâ€¢ Client: ${newTask.clientName}\nâ€¢ Task: ${newTask.parentTask} â†’ ${newTask.childTask}\nâ€¢ Period: ${newTask.subPeriod || newTask.period}\n\nPlease check existing tasks.`);
              return;
            }
            
            // Check if approval is needed (Seniors/Articles need RM approval)
            const userRole = getCurrentUserRole();
            const approvalNeeded = needsApproval('task', userRole);
            
            if (approvalNeeded) {
              // Create approval request instead of direct save
              const approval = createApprovalRequest(
                'task',
                newTask,
                `New Task: ${newTask.parentTask} â†’ ${newTask.childTask} for ${newTask.clientName}`
              );
              
              if (approval) {
                setData(prev => ({
                  ...prev,
                  pendingApprovals: [...(prev.pendingApprovals || []), approval]
                }));
                setShowAddTaskModal(false);
                alert('ðŸ“ Task submitted for approval!\n\nYour Reporting Manager will review and approve this task.');
                return;
              }
            }
            
            // Direct save for Superadmin/RM
            setData(prev => {
              const updatedTasks = [...prev.tasks, newTask];
              console.log('Updated tasks count:', updatedTasks.length);
              console.log('Task added successfully');
              return {
                ...prev,
                tasks: updatedTasks
              };
            });
            
            setShowAddTaskModal(false);
            alert('Task created successfully! You can view it in the task list.');
          }}
          onBulkSave={async (newTasks) => {
            console.log('=== BULK SAVE V15 - WITH ALERTS ===');
            console.log('New tasks count:', newTasks.length);
            
            // Skip duplicate check for now - just save
            const tasksToAdd = newTasks;
            
            if (tasksToAdd.length === 0) {
              alert('No tasks to import.');
              return;
            }
            
            // Combine with existing tasks
            const allTasks = [...(data.tasks || []), ...tasksToAdd];
            console.log('Total tasks after merge:', allTasks.length);
            
            // Build the SIMPLEST possible data object for Firebase
            const dataForFirebase = {
              tasks: allTasks,
              clients: data.clients || [],
              staff: data.staff || [],
              timesheets: data.timesheets || [],
              invoices: data.invoices || [],
              receipts: data.receipts || [],
              organizations: (data.organizations || []).map(org => {
                const o = JSON.parse(JSON.stringify(org || {}));
                if (o.logo && o.logo.startsWith && o.logo.startsWith('data:')) o.logo = '[IMG]';
                if (o.signatureImage && o.signatureImage.startsWith && o.signatureImage.startsWith('data:')) o.signatureImage = '[IMG]';
                if (o.qrCode && o.qrCode.startsWith && o.qrCode.startsWith('data:')) o.qrCode = '[IMG]';
                return o;
              }),
              recurringSchedules: data.recurringSchedules || [],
              leaves: data.leaves || [],
              documents: data.documents || [],
              userPermissions: data.userPermissions || {},
              parentChildTasks: data.parentChildTasks || {},
              recurringBatches: data.recurringBatches || [],
              checklists: data.checklists || [],
              pendingApprovals: data.pendingApprovals || [],
              lastUpdated: new Date().toISOString()
            };
            
            // THE KEY: JSON.parse(JSON.stringify()) GUARANTEES no undefined
            const cleanData = JSON.parse(JSON.stringify(dataForFirebase));
            
            console.log('Clean data prepared, tasks count:', cleanData.tasks.length);
            
            // DEBUG: Show alert before Firebase save
            // alert('About to save ' + cleanData.tasks.length + ' tasks to Firebase...');
            
            try {
              // Direct Firebase save
              console.log('Calling setDoc NOW...');
              await setDoc(doc(db, 'appData', 'mainData'), cleanData);
              console.log('âœ… Firebase setDoc completed!');
              
              // Update local state
              setData(prev => ({
                ...prev,
                tasks: allTasks
              }));
              
              setShowAddTaskModal(false);
              alert(`âœ… Successfully imported and saved ${tasksToAdd.length} task(s) to database!`);
            } catch (err) {
              console.error('âŒ Firebase save FAILED:', err);
              console.error('Error name:', err.name);
              console.error('Error message:', err.message);
              console.error('Error code:', err.code);
              alert('âŒ Error saving to Firebase: ' + err.message);
            }
          }}
        />
      )}

      {/* Timesheet Modal */}
      {showTimesheetModal && (
        <TimesheetModal
          onClose={() => setShowTimesheetModal(false)}
        />
      )}

      {/* Task Configuration Modal */}
      {showTaskConfigModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 2000
        }}>
          <div style={{
            background: '#fff',
            borderRadius: '16px',
            width: '95%',
            maxWidth: '1200px',
            maxHeight: '90vh',
            overflow: 'hidden',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Modal Header - Dynamic based on selected option */}
            <div style={{
              padding: '16px 24px',
              borderBottom: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
              color: '#fff'
            }}>
              <h2 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                {taskConfigActiveTab === 'categories' && 'ðŸ“ Task Categories Configuration'}
                {taskConfigActiveTab === 'batches' && 'ðŸ”„ Recurring Batches'}
                {taskConfigActiveTab === 'checklists' && 'âœ… Checklists'}
              </h2>
              <button onClick={() => {
                setShowTaskConfigModal(false);
                setShowBatchForm(false);
                setShowChecklistForm(false);
                setSelectedBatch(null);
                setSelectedChecklist(null);
              }} style={{
                background: 'rgba(255,255,255,0.2)',
                border: 'none',
                cursor: 'pointer',
                padding: '8px',
                borderRadius: '8px',
                color: '#fff'
              }}>
                <X size={20} />
              </button>
            </div>
            
            {/* Modal Body */}
            <div style={{flex: 1, overflow: 'auto', padding: '20px'}}>
              
              {/* ============ TASK CATEGORIES TAB ============ */}
              {taskConfigActiveTab === 'categories' && (
                <div style={{display: 'flex', gap: '20px', height: '100%', minHeight: '400px'}}>
                  {/* Left Panel - Parent Tasks */}
                  <div style={{width: '280px', borderRight: '1px solid #e2e8f0', paddingRight: '20px'}}>
                    <div style={{marginBottom: '16px'}}>
                      <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#374151'}}>Parent Tasks ({Object.keys(PARENT_CHILD_TASKS).length})</h3>
                      <div style={{display: 'flex', gap: '8px', marginBottom: '12px'}}>
                        <input
                          type="text"
                          placeholder="New parent task..."
                          value={taskConfigNewParent}
                          onChange={(e) => setTaskConfigNewParent(e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              if (!taskConfigNewParent.trim()) return;
                              if (PARENT_CHILD_TASKS[taskConfigNewParent.trim()]) {
                                alert('This parent task already exists!');
                                return;
                              }
                              setData(prev => {
                                const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                                return {
                                  ...prev,
                                  parentChildTasks: {
                                    ...currentTasks,
                                    [taskConfigNewParent.trim()]: []
                                  }
                                };
                              });
                              setTaskConfigSelectedParent(taskConfigNewParent.trim());
                              setTaskConfigNewParent('');
                            }
                          }}
                          style={{
                            flex: 1,
                            padding: '8px 12px',
                            border: '1px solid #e2e8f0',
                            borderRadius: '6px',
                            fontSize: '12px'
                          }}
                        />
                        <button
                          onClick={() => {
                            if (!taskConfigNewParent.trim()) return;
                            if (PARENT_CHILD_TASKS[taskConfigNewParent.trim()]) {
                              alert('This parent task already exists!');
                              return;
                            }
                            setData(prev => {
                              const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                              return {
                                ...prev,
                                parentChildTasks: {
                                  ...currentTasks,
                                  [taskConfigNewParent.trim()]: []
                                }
                              };
                            });
                            setTaskConfigSelectedParent(taskConfigNewParent.trim());
                            setTaskConfigNewParent('');
                          }}
                          style={{
                            padding: '8px 12px',
                            background: '#10b981',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: '600'
                          }}
                        >
                          Add
                        </button>
                      </div>
                    </div>
                    
                    <div style={{maxHeight: '350px', overflowY: 'auto'}}>
                      {Object.keys(PARENT_CHILD_TASKS).map(parent => (
                        <div
                          key={parent}
                          onClick={() => setTaskConfigSelectedParent(parent)}
                          style={{
                            padding: '10px 12px',
                            marginBottom: '4px',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            background: taskConfigSelectedParent === parent ? '#3b82f6' : '#f8fafc',
                            color: taskConfigSelectedParent === parent ? '#fff' : '#374151',
                            fontSize: '13px',
                            fontWeight: taskConfigSelectedParent === parent ? '600' : '500'
                          }}
                        >
                          <span>{parent}</span>
                          <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span style={{
                              background: taskConfigSelectedParent === parent ? 'rgba(255,255,255,0.3)' : '#e2e8f0',
                              padding: '2px 8px',
                              borderRadius: '10px',
                              fontSize: '10px'
                            }}>
                              {PARENT_CHILD_TASKS[parent]?.length || 0}
                            </span>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                if (!window.confirm(`Delete "${parent}" and all its child tasks?`)) return;
                                setData(prev => {
                                  const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                                  const newTasks = { ...currentTasks };
                                  delete newTasks[parent];
                                  return {
                                    ...prev,
                                    parentChildTasks: newTasks
                                  };
                                });
                                setTimeout(() => {
                                  if (taskConfigSelectedParent === parent) {
                                    const remainingParents = Object.keys(PARENT_CHILD_TASKS).filter(p => p !== parent);
                                    setTaskConfigSelectedParent(remainingParents[0] || '');
                                  }
                                }, 0);
                              }}
                              style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '2px',
                                color: taskConfigSelectedParent === parent ? '#fca5a5' : '#ef4444',
                                opacity: 0.7
                              }}
                            >
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Right Panel - Child Tasks */}
                  <div style={{flex: 1}}>
                    <div style={{marginBottom: '16px'}}>
                      <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#374151'}}>
                        Child Tasks for: <span style={{color: '#3b82f6'}}>{taskConfigSelectedParent || 'Select a parent'}</span>
                        {taskConfigSelectedParent && ` (${PARENT_CHILD_TASKS[taskConfigSelectedParent]?.length || 0})`}
                      </h3>
                      {taskConfigSelectedParent && (
                        <div style={{display: 'flex', gap: '8px', marginBottom: '12px'}}>
                          <input
                            type="text"
                            placeholder="New child task..."
                            value={taskConfigNewChild}
                            onChange={(e) => setTaskConfigNewChild(e.target.value)}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter') {
                                if (!taskConfigSelectedParent || !taskConfigNewChild.trim()) return;
                                if (PARENT_CHILD_TASKS[taskConfigSelectedParent]?.includes(taskConfigNewChild.trim())) {
                                  alert('This child task already exists!');
                                  return;
                                }
                                setData(prev => {
                                  const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                                  return {
                                    ...prev,
                                    parentChildTasks: {
                                      ...currentTasks,
                                      [taskConfigSelectedParent]: [
                                        ...(currentTasks[taskConfigSelectedParent] || []),
                                        taskConfigNewChild.trim()
                                      ]
                                    }
                                  };
                                });
                                setTaskConfigNewChild('');
                              }
                            }}
                            style={{
                              flex: 1,
                              padding: '8px 12px',
                              border: '1px solid #e2e8f0',
                              borderRadius: '6px',
                              fontSize: '12px'
                            }}
                          />
                          <button
                            onClick={() => {
                              if (!taskConfigSelectedParent || !taskConfigNewChild.trim()) return;
                              if (PARENT_CHILD_TASKS[taskConfigSelectedParent]?.includes(taskConfigNewChild.trim())) {
                                alert('This child task already exists!');
                                return;
                              }
                              setData(prev => {
                                const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                                return {
                                  ...prev,
                                  parentChildTasks: {
                                    ...currentTasks,
                                    [taskConfigSelectedParent]: [
                                      ...(currentTasks[taskConfigSelectedParent] || []),
                                      taskConfigNewChild.trim()
                                    ]
                                  }
                                };
                              });
                              setTaskConfigNewChild('');
                            }}
                            style={{
                              padding: '8px 12px',
                              background: '#8b5cf6',
                              color: '#fff',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '12px',
                              fontWeight: '600'
                            }}
                          >
                            Add Child
                          </button>
                        </div>
                      )}
                    </div>
                    
                    {taskConfigSelectedParent ? (
                      <div style={{maxHeight: '350px', overflowY: 'auto'}}>
                        {PARENT_CHILD_TASKS[taskConfigSelectedParent]?.length === 0 ? (
                          <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>
                            No child tasks. Add one above.
                          </div>
                        ) : (
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px'}}>
                            {PARENT_CHILD_TASKS[taskConfigSelectedParent]?.map(child => (
                              <div
                                key={child}
                                style={{
                                  padding: '10px 12px',
                                  background: '#f8fafc',
                                  borderRadius: '8px',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  fontSize: '12px',
                                  color: '#374151'
                                }}
                              >
                                <span>{child}</span>
                                <button
                                  onClick={() => {
                                    if (!window.confirm(`Delete "${child}" from "${taskConfigSelectedParent}"?`)) return;
                                    setData(prev => {
                                      const currentTasks = prev.parentChildTasks || { ...DEFAULT_PARENT_CHILD_TASKS };
                                      return {
                                        ...prev,
                                        parentChildTasks: {
                                          ...currentTasks,
                                          [taskConfigSelectedParent]: (currentTasks[taskConfigSelectedParent] || []).filter(c => c !== child)
                                        }
                                      };
                                    });
                                  }}
                                  style={{
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '2px',
                                    color: '#ef4444',
                                    opacity: 0.7
                                  }}
                                >
                                  <X size={14} />
                                </button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>
                        Select a parent task to view/add child tasks
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* ============ RECURRING BATCHES TAB ============ */}
              {taskConfigActiveTab === 'batches' && (
                <div>
                  {!showBatchForm && !selectedBatch ? (
                    <>
                      {/* Header with Add Button */}
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600', color: '#374151'}}>
                          Recurring Task Batches ({(data.recurringBatches || []).length})
                        </h3>
                        <button
                          onClick={() => {
                            setBatchFormData({
                              name: '',
                              parentTask: Object.keys(PARENT_CHILD_TASKS)[0] || '',
                              childTask: '',
                              taskManager: '',
                              taskLeader: '',
                              financialYear: 'FY 2024-25',
                              taskDescription: '',
                              startDate: '',
                              dueDate: '',
                              period: '',
                              subPeriod: '',
                              frequency: 'Monthly',
                              executionDay: '1',
                              clients: [],
                              isActive: true
                            });
                            setBatchFormStep(1);
                            setBatchClientSearch('');
                            setShowBatchForm(true);
                          }}
                          style={{
                            padding: '10px 16px',
                            background: '#10b981',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <Plus size={16} /> Create Batch
                        </button>
                      </div>
                      
                      {/* Batches Table */}
                      {(data.recurringBatches || []).length === 0 ? (
                        <div style={{padding: '60px', textAlign: 'center', color: '#94a3b8', background: '#f8fafc', borderRadius: '12px'}}>
                          <div style={{fontSize: '48px', marginBottom: '16px'}}>ðŸ“¦</div>
                          <div style={{fontSize: '16px', fontWeight: '500', marginBottom: '8px'}}>No Batches Created</div>
                          <div style={{fontSize: '13px'}}>Create a batch to automate recurring task creation for multiple clients</div>
                        </div>
                      ) : (
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                            <thead>
                              <tr style={{background: '#f8fafc'}}>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Sr.</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Batch Name</th>
                                <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Task Type</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Clients</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Frequency</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Status</th>
                                <th style={{padding: '12px', textAlign: 'center', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {(data.recurringBatches || []).map((batch, idx) => (
                                <tr key={batch.id} style={{borderBottom: '1px solid #e2e8f0'}}>
                                  <td style={{padding: '12px'}}>{idx + 1}</td>
                                  <td style={{padding: '12px', fontWeight: '500'}}>{batch.name}</td>
                                  <td style={{padding: '12px'}}>
                                    <span style={{color: '#64748b'}}>{batch.parentTask}</span>
                                    {batch.childTask && <span style={{color: '#94a3b8'}}> â†’ {batch.childTask}</span>}
                                  </td>
                                  <td style={{padding: '12px', textAlign: 'center'}}>
                                    <span style={{
                                      background: '#e0f2fe',
                                      color: '#0369a1',
                                      padding: '4px 10px',
                                      borderRadius: '12px',
                                      fontWeight: '600'
                                    }}>
                                      {batch.clients?.length || 0}
                                    </span>
                                  </td>
                                  <td style={{padding: '12px', textAlign: 'center'}}>
                                    <span style={{
                                      background: '#f3e8ff',
                                      color: '#7c3aed',
                                      padding: '4px 8px',
                                      borderRadius: '6px',
                                      fontSize: '11px',
                                      fontWeight: '500'
                                    }}>
                                      {batch.frequency} (Day {batch.executionDay})
                                    </span>
                                  </td>
                                  <td style={{padding: '12px', textAlign: 'center'}}>
                                    <button
                                      onClick={() => {
                                        setData(prev => ({
                                          ...prev,
                                          recurringBatches: prev.recurringBatches.map(b =>
                                            b.id === batch.id ? {...b, isActive: !b.isActive} : b
                                          )
                                        }));
                                      }}
                                      style={{
                                        width: '44px',
                                        height: '24px',
                                        borderRadius: '12px',
                                        border: 'none',
                                        cursor: 'pointer',
                                        background: batch.isActive ? '#10b981' : '#e2e8f0',
                                        position: 'relative',
                                        transition: 'all 0.2s'
                                      }}
                                    >
                                      <div style={{
                                        width: '18px',
                                        height: '18px',
                                        borderRadius: '50%',
                                        background: '#fff',
                                        position: 'absolute',
                                        top: '3px',
                                        left: batch.isActive ? '23px' : '3px',
                                        transition: 'all 0.2s',
                                        boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                                      }} />
                                    </button>
                                  </td>
                                  <td style={{padding: '12px', textAlign: 'center'}}>
                                    <div style={{display: 'flex', gap: '6px', justifyContent: 'center'}}>
                                      <button
                                        onClick={() => setSelectedBatch(batch)}
                                        title="View Clients"
                                        style={{
                                          padding: '6px 8px',
                                          background: '#e0f2fe',
                                          color: '#0369a1',
                                          border: 'none',
                                          borderRadius: '6px',
                                          cursor: 'pointer',
                                          fontSize: '11px'
                                        }}
                                      >
                                        <Eye size={14} />
                                      </button>
                                      <button
                                        onClick={() => {
                                          // Manual run - create tasks for this batch
                                          const newTasks = (batch.clients || []).map(clientData => {
                                            const client = data.clients.find(c => c.id === (clientData.clientId || clientData));
                                            return {
                                              id: generateId(),
                                              clientName: client?.name || 'Unknown',
                                              clientId: clientData.clientId || clientData,
                                              parentTask: batch.parentTask,
                                              childTask: batch.childTask,
                                              taskManager: batch.taskManager,
                                              taskLeader: batch.taskLeader,
                                              primaryAssignedUser: clientData.primaryAssignedUser || '',
                                              financialYear: batch.financialYear,
                                              period: batch.period,
                                              subPeriod: batch.subPeriod,
                                              description: batch.taskDescription,
                                              startDate: batch.startDate || new Date().toISOString().split('T')[0],
                                              dueDate: batch.dueDate || '',
                                              status: 'Data Pending',
                                              createdAt: new Date().toISOString(),
                                              batchId: batch.id,
                                              batchName: batch.name
                                            };
                                          });
                                          
                                          // Filter out duplicates
                                          const { validTasks, duplicates } = filterDuplicateTasks(newTasks, data.tasks);
                                          
                                          if (duplicates.length > 0 && validTasks.length === 0) {
                                            alert(`âš ï¸ All ${duplicates.length} tasks already exist!\n\nNo new tasks were created.`);
                                            return;
                                          }
                                          
                                          let confirmMsg = `Run batch "${batch.name}" manually?`;
                                          if (duplicates.length > 0) {
                                            confirmMsg += `\n\nâš ï¸ ${duplicates.length} duplicate task(s) will be skipped.\nâœ… ${validTasks.length} new task(s) will be created.`;
                                          } else {
                                            confirmMsg += `\n\nâœ… ${validTasks.length} task(s) will be created.`;
                                          }
                                          
                                          if (window.confirm(confirmMsg)) {
                                            setData(prev => ({
                                              ...prev,
                                              tasks: [...prev.tasks, ...validTasks]
                                            }));
                                            
                                            if (duplicates.length > 0) {
                                              alert(`âœ… Created ${validTasks.length} task(s).\nâš ï¸ Skipped ${duplicates.length} duplicate(s).`);
                                            } else {
                                              alert(`âœ… Created ${validTasks.length} tasks successfully!`);
                                            }
                                          }
                                        }}
                                        title="Run Manually"
                                        style={{
                                          padding: '6px 8px',
                                          background: '#dcfce7',
                                          color: '#16a34a',
                                          border: 'none',
                                          borderRadius: '6px',
                                          cursor: 'pointer',
                                          fontSize: '11px'
                                        }}
                                      >
                                        â–¶
                                      </button>
                                      <button
                                        onClick={() => {
                                          setBatchFormData({...batch});
                                          setBatchFormStep(1);
                                          setBatchClientSearch('');
                                          setShowBatchForm(true);
                                        }}
                                        title="Edit"
                                        style={{
                                          padding: '6px 8px',
                                          background: '#fef3c7',
                                          color: '#d97706',
                                          border: 'none',
                                          borderRadius: '6px',
                                          cursor: 'pointer',
                                          fontSize: '11px'
                                        }}
                                      >
                                        <Edit size={14} />
                                      </button>
                                      <button
                                        onClick={() => {
                                          if (window.confirm(`Delete batch "${batch.name}"?`)) {
                                            setData(prev => ({
                                              ...prev,
                                              recurringBatches: prev.recurringBatches.filter(b => b.id !== batch.id)
                                            }));
                                          }
                                        }}
                                        title="Delete"
                                        style={{
                                          padding: '6px 8px',
                                          background: '#fef2f2',
                                          color: '#ef4444',
                                          border: 'none',
                                          borderRadius: '6px',
                                          cursor: 'pointer',
                                          fontSize: '11px'
                                        }}
                                      >
                                        <Trash2 size={14} />
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </>
                  ) : selectedBatch ? (
                    /* View Batch Details & Clients */
                    <div>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px'}}>
                        <button
                          onClick={() => setSelectedBatch(null)}
                          style={{
                            padding: '8px 12px',
                            background: '#f1f5f9',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <ChevronLeft size={16} /> Back
                        </button>
                        <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>
                          Batch: <span style={{color: '#3b82f6'}}>{selectedBatch.name}</span>
                        </h3>
                        <button
                          onClick={() => {
                            const newTasks = (selectedBatch.clients || []).map(clientData => {
                              const client = data.clients.find(c => c.id === (clientData.clientId || clientData));
                              return {
                                id: generateId(),
                                clientName: client?.name || 'Unknown',
                                clientId: clientData.clientId || clientData,
                                parentTask: selectedBatch.parentTask,
                                childTask: selectedBatch.childTask,
                                taskManager: selectedBatch.taskManager,
                                taskLeader: selectedBatch.taskLeader,
                                primaryAssignedUser: clientData.primaryAssignedUser || '',
                                financialYear: selectedBatch.financialYear,
                                period: selectedBatch.period,
                                subPeriod: selectedBatch.subPeriod,
                                description: selectedBatch.taskDescription,
                                startDate: selectedBatch.startDate || new Date().toISOString().split('T')[0],
                                dueDate: selectedBatch.dueDate || '',
                                status: 'Data Pending',
                                createdAt: new Date().toISOString(),
                                batchId: selectedBatch.id,
                                batchName: selectedBatch.name
                              };
                            });
                            
                            // Filter out duplicates
                            const { validTasks, duplicates } = filterDuplicateTasks(newTasks, data.tasks);
                            
                            if (duplicates.length > 0 && validTasks.length === 0) {
                              alert(`âš ï¸ All ${duplicates.length} tasks already exist!\n\nNo new tasks were created.`);
                              return;
                            }
                            
                            let confirmMsg = `Run batch "${selectedBatch.name}" manually?`;
                            if (duplicates.length > 0) {
                              confirmMsg += `\n\nâš ï¸ ${duplicates.length} duplicate task(s) will be skipped.\nâœ… ${validTasks.length} new task(s) will be created.`;
                            } else {
                              confirmMsg += `\n\nâœ… ${validTasks.length} task(s) will be created.`;
                            }
                            
                            if (window.confirm(confirmMsg)) {
                              setData(prev => ({
                                ...prev,
                                tasks: [...prev.tasks, ...validTasks]
                              }));
                              
                              if (duplicates.length > 0) {
                                alert(`âœ… Created ${validTasks.length} task(s).\nâš ï¸ Skipped ${duplicates.length} duplicate(s).`);
                              } else {
                                alert(`âœ… Created ${validTasks.length} tasks!`);
                              }
                            }
                          }}
                          style={{
                            marginLeft: 'auto',
                            padding: '8px 16px',
                            background: '#10b981',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: '600'
                          }}
                        >
                          â–¶ Run Batch Manually
                        </button>
                      </div>
                      
                      {/* Batch Info Cards */}
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '20px'}}>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Task Type</div>
                          <div style={{fontWeight: '600', fontSize: '13px'}}>{selectedBatch.parentTask} â†’ {selectedBatch.childTask || 'All'}</div>
                        </div>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Financial Year</div>
                          <div style={{fontWeight: '600', fontSize: '13px'}}>{selectedBatch.financialYear || '-'}</div>
                        </div>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Frequency</div>
                          <div style={{fontWeight: '600', fontSize: '13px'}}>{selectedBatch.frequency} (Day {selectedBatch.executionDay})</div>
                        </div>
                        <div style={{background: selectedBatch.isActive ? '#dcfce7' : '#fef2f2', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Status</div>
                          <div style={{fontWeight: '600', fontSize: '13px', color: selectedBatch.isActive ? '#16a34a' : '#ef4444'}}>
                            {selectedBatch.isActive ? 'â— Active' : 'â—‹ Disabled'}
                          </div>
                        </div>
                      </div>
                      
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px'}}>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Task Manager</div>
                          <div style={{fontWeight: '500', fontSize: '12px'}}>{selectedBatch.taskManager || '-'}</div>
                        </div>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Task Leader</div>
                          <div style={{fontWeight: '500', fontSize: '12px'}}>{selectedBatch.taskLeader || '-'}</div>
                        </div>
                        <div style={{background: '#f8fafc', borderRadius: '8px', padding: '12px'}}>
                          <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Total Clients</div>
                          <div style={{fontWeight: '600', fontSize: '13px'}}>{selectedBatch.clients?.length || 0}</div>
                        </div>
                      </div>
                      
                      {/* Clients Table */}
                      <h4 style={{margin: '0 0 12px', fontSize: '14px', fontWeight: '600'}}>Clients in Batch</h4>
                      {(selectedBatch.clients || []).length === 0 ? (
                        <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8', background: '#f8fafc', borderRadius: '8px'}}>
                          No clients in this batch.
                        </div>
                      ) : (
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden', maxHeight: '300px', overflowY: 'auto'}}>
                          <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                            <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                              <tr>
                                <th style={{padding: '10px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>S.No</th>
                                <th style={{padding: '10px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>File No.</th>
                                <th style={{padding: '10px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Client Name</th>
                                <th style={{padding: '10px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Group No.</th>
                                <th style={{padding: '10px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Primary Assigned User</th>
                              </tr>
                            </thead>
                            <tbody>
                              {selectedBatch.clients.map((clientData, idx) => {
                                const clientId = clientData.clientId || clientData;
                                const client = data.clients.find(c => c.id === clientId);
                                return (
                                  <tr key={clientId} style={{borderBottom: '1px solid #f1f5f9'}}>
                                    <td style={{padding: '10px'}}>{idx + 1}</td>
                                    <td style={{padding: '10px'}}>{client?.fileNo || '-'}</td>
                                    <td style={{padding: '10px', fontWeight: '500'}}>{client?.name || 'Unknown'}</td>
                                    <td style={{padding: '10px', color: '#64748b'}}>{client?.groupName || client?.name || '-'}</td>
                                    <td style={{padding: '10px', color: '#3b82f6'}}>{clientData.primaryAssignedUser || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  ) : (
                    /* Multi-Step Batch Form */
                    <div>
                      {/* Step Indicator */}
                      <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '24px'}}>
                        <button
                          onClick={() => {
                            if (batchFormStep === 1) {
                              setShowBatchForm(false);
                            } else {
                              setBatchFormStep(batchFormStep - 1);
                            }
                          }}
                          style={{
                            padding: '8px 12px',
                            background: '#f1f5f9',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <ChevronLeft size={16} /> Back
                        </button>
                        
                        <div style={{flex: 1, display: 'flex', justifyContent: 'center', gap: '8px'}}>
                          {['Batch Details', 'Select Clients', 'Preview & Assign'].map((step, idx) => (
                            <div key={step} style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                              <div style={{
                                width: '28px',
                                height: '28px',
                                borderRadius: '50%',
                                background: batchFormStep > idx + 1 ? '#10b981' : batchFormStep === idx + 1 ? '#3b82f6' : '#e2e8f0',
                                color: batchFormStep >= idx + 1 ? '#fff' : '#64748b',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '12px',
                                fontWeight: '600'
                              }}>
                                {batchFormStep > idx + 1 ? 'âœ“' : idx + 1}
                              </div>
                              <span style={{
                                fontSize: '12px',
                                fontWeight: batchFormStep === idx + 1 ? '600' : '400',
                                color: batchFormStep === idx + 1 ? '#1e293b' : '#64748b'
                              }}>{step}</span>
                              {idx < 2 && <div style={{width: '40px', height: '2px', background: batchFormStep > idx + 1 ? '#10b981' : '#e2e8f0'}} />}
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* Step 1: Batch Details */}
                      {batchFormStep === 1 && (
                        <div>
                          <h3 style={{margin: '0 0 20px', fontSize: '16px', fontWeight: '600'}}>
                            {batchFormData.id ? 'Edit Batch Details' : 'Create New Batch'}
                          </h3>
                          
                          <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Batch Name *</label>
                              <input
                                type="text"
                                value={batchFormData.name}
                                onChange={(e) => setBatchFormData({...batchFormData, name: e.target.value})}
                                placeholder="e.g., GST 3B Monthly Clients"
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              />
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Parent Task *</label>
                              <select
                                value={batchFormData.parentTask}
                                onChange={(e) => setBatchFormData({...batchFormData, parentTask: e.target.value, childTask: ''})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                <option value="">Select Parent Task</option>
                                {Object.keys(PARENT_CHILD_TASKS).map(p => (
                                  <option key={p} value={p}>{p}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Child Task *</label>
                              <select
                                value={batchFormData.childTask}
                                onChange={(e) => setBatchFormData({...batchFormData, childTask: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                                disabled={!batchFormData.parentTask}
                              >
                                <option value="">Select Child Task</option>
                                {(PARENT_CHILD_TASKS[batchFormData.parentTask] || []).map(c => (
                                  <option key={c} value={c}>{c}</option>
                                ))}
                              </select>
                            </div>
                            
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Task Manager (RM) *</label>
                              <select
                                value={batchFormData.taskManager}
                                onChange={(e) => setBatchFormData({...batchFormData, taskManager: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                <option value="">Select Task Manager</option>
                                {data.staff.filter(s => s.status === 'Active' && s.role === 'Reporting Manager').map(s => (
                                  <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Task Leader (Superadmin)</label>
                              <select
                                value={batchFormData.taskLeader}
                                onChange={(e) => setBatchFormData({...batchFormData, taskLeader: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                <option value="">Select Task Leader</option>
                                {data.staff.filter(s => s.status === 'Active' && (s.role === 'Superadmin' || s.isSuperAdmin)).map(s => (
                                  <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Financial Year *</label>
                              <select
                                value={batchFormData.financialYear}
                                onChange={(e) => setBatchFormData({...batchFormData, financialYear: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                {FINANCIAL_YEARS.map(fy => (
                                  <option key={fy} value={fy}>{fy}</option>
                                ))}
                              </select>
                            </div>
                            
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Period</label>
                              <select
                                value={batchFormData.period}
                                onChange={(e) => setBatchFormData({...batchFormData, period: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                <option value="">Select Period</option>
                                {PERIODS.map(p => (
                                  <option key={p} value={p}>{p}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Sub-Period</label>
                              <input
                                type="text"
                                value={batchFormData.subPeriod}
                                onChange={(e) => setBatchFormData({...batchFormData, subPeriod: e.target.value})}
                                placeholder="e.g., January, Q1"
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              />
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Frequency *</label>
                              <select
                                value={batchFormData.frequency}
                                onChange={(e) => setBatchFormData({...batchFormData, frequency: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                <option value="Monthly">Every Month</option>
                                <option value="Quarterly">Every Quarter</option>
                                <option value="Half-Yearly">Every Half Year</option>
                                <option value="Annually">Annually</option>
                              </select>
                            </div>
                            
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Date of Execution *</label>
                              <select
                                value={batchFormData.executionDay}
                                onChange={(e) => setBatchFormData({...batchFormData, executionDay: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              >
                                {[...Array(28)].map((_, i) => (
                                  <option key={i+1} value={String(i+1)}>{i+1}{['st','nd','rd'][i] || 'th'} of each {batchFormData.frequency === 'Monthly' ? 'month' : 'period'}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Start Date</label>
                              <input
                                type="date"
                                value={batchFormData.startDate}
                                onChange={(e) => setBatchFormData({...batchFormData, startDate: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              />
                            </div>
                            <div>
                              <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Due Date</label>
                              <input
                                type="date"
                                value={batchFormData.dueDate}
                                onChange={(e) => setBatchFormData({...batchFormData, dueDate: e.target.value})}
                                style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                              />
                            </div>
                          </div>
                          
                          <div style={{marginTop: '16px'}}>
                            <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Task Description</label>
                            <textarea
                              value={batchFormData.taskDescription}
                              onChange={(e) => setBatchFormData({...batchFormData, taskDescription: e.target.value})}
                              placeholder="Enter task description..."
                              rows={3}
                              style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px', resize: 'vertical'}}
                            />
                          </div>
                          
                          <div style={{marginTop: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <label style={{display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer'}}>
                              <input
                                type="checkbox"
                                checked={batchFormData.isActive}
                                onChange={(e) => setBatchFormData({...batchFormData, isActive: e.target.checked})}
                                style={{width: '18px', height: '18px'}}
                              />
                              <span style={{fontSize: '13px', fontWeight: '500'}}>Enable this batch (auto-create tasks)</span>
                            </label>
                            
                            <button
                              onClick={() => {
                                if (!batchFormData.name.trim()) { alert('Batch name is required'); return; }
                                if (!batchFormData.parentTask) { alert('Please select a parent task'); return; }
                                if (!batchFormData.childTask) { alert('Please select a child task'); return; }
                                if (!batchFormData.taskManager) { alert('Please select a Task Manager (RM)'); return; }
                                setBatchFormStep(2);
                              }}
                              style={{
                                padding: '12px 24px',
                                background: '#3b82f6',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '600'
                              }}
                            >
                              Next: Select Clients â†’
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {/* Step 2: Client Selection */}
                      {batchFormStep === 2 && (
                        <div>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                            <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>
                              Select Clients ({batchFormData.clients?.length || 0} selected)
                            </h3>
                            <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                              <div style={{position: 'relative'}}>
                                <Search size={16} style={{position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8'}} />
                                <input
                                  type="text"
                                  placeholder="Search clients..."
                                  value={batchClientSearch}
                                  onChange={(e) => setBatchClientSearch(e.target.value)}
                                  style={{
                                    padding: '10px 12px 10px 36px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    width: '250px'
                                  }}
                                />
                              </div>
                            </div>
                          </div>
                          
                          <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', maxHeight: '400px', overflowY: 'auto'}}>
                            {(() => {
                              const filteredClients = data.clients.filter(c => 
                                !c.disabled && 
                                (c.name?.toLowerCase().includes(batchClientSearch.toLowerCase()) ||
                                 c.fileNo?.toLowerCase().includes(batchClientSearch.toLowerCase()))
                              );
                              
                              if (filteredClients.length === 0) {
                                return (
                                  <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>
                                    {batchClientSearch ? 'No clients match your search' : 'No active clients available'}
                                  </div>
                                );
                              }
                              
                              return (
                                <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                  <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                    <tr>
                                      <th style={{padding: '12px', textAlign: 'center', width: '50px', borderBottom: '1px solid #e2e8f0'}}>
                                        <input
                                          type="checkbox"
                                          checked={batchFormData.clients?.length === filteredClients.length && filteredClients.length > 0}
                                          onChange={(e) => {
                                            if (e.target.checked) {
                                              setBatchFormData({
                                                ...batchFormData,
                                                clients: filteredClients.map(c => ({clientId: c.id, primaryAssignedUser: ''}))
                                              });
                                            } else {
                                              setBatchFormData({...batchFormData, clients: []});
                                            }
                                          }}
                                        />
                                      </th>
                                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>File No.</th>
                                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Client Name</th>
                                      <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Group No.</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {filteredClients.map(client => {
                                      const isSelected = batchFormData.clients?.some(c => c.clientId === client.id);
                                      return (
                                        <tr key={client.id} style={{borderBottom: '1px solid #f1f5f9', background: isSelected ? '#eff6ff' : 'transparent'}}>
                                          <td style={{padding: '10px', textAlign: 'center'}}>
                                            <input
                                              type="checkbox"
                                              checked={isSelected}
                                              onChange={(e) => {
                                                if (e.target.checked) {
                                                  setBatchFormData({
                                                    ...batchFormData,
                                                    clients: [...(batchFormData.clients || []), {clientId: client.id, primaryAssignedUser: ''}]
                                                  });
                                                } else {
                                                  setBatchFormData({
                                                    ...batchFormData,
                                                    clients: (batchFormData.clients || []).filter(c => c.clientId !== client.id)
                                                  });
                                                }
                                              }}
                                            />
                                          </td>
                                          <td style={{padding: '10px'}}>{client.fileNo || '-'}</td>
                                          <td style={{padding: '10px', fontWeight: '500'}}>{client.name}</td>
                                          <td style={{padding: '10px', color: '#64748b'}}>{client.groupName || client.name}</td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                </table>
                              );
                            })()}
                          </div>
                          
                          <div style={{marginTop: '24px', display: 'flex', justifyContent: 'flex-end'}}>
                            <button
                              onClick={() => {
                                if ((batchFormData.clients || []).length === 0) {
                                  alert('Please select at least one client');
                                  return;
                                }
                                setBatchFormStep(3);
                              }}
                              style={{
                                padding: '12px 24px',
                                background: '#3b82f6',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '600'
                              }}
                            >
                              Next: Preview & Assign â†’
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {/* Step 3: Preview & Assign Primary Users */}
                      {batchFormStep === 3 && (
                        <div>
                          <h3 style={{margin: '0 0 16px', fontSize: '16px', fontWeight: '600'}}>Preview & Assign Primary Users</h3>
                          
                          {/* Batch Summary */}
                          <div style={{background: '#f8fafc', borderRadius: '12px', padding: '16px', marginBottom: '20px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px'}}>
                              <div>
                                <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Batch Name</div>
                                <div style={{fontWeight: '600', fontSize: '13px'}}>{batchFormData.name}</div>
                              </div>
                              <div>
                                <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Task Type</div>
                                <div style={{fontWeight: '500', fontSize: '12px'}}>{batchFormData.parentTask} â†’ {batchFormData.childTask}</div>
                              </div>
                              <div>
                                <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Frequency</div>
                                <div style={{fontWeight: '500', fontSize: '12px'}}>{batchFormData.frequency} (Day {batchFormData.executionDay})</div>
                              </div>
                              <div>
                                <div style={{fontSize: '10px', color: '#64748b', marginBottom: '4px'}}>Total Clients</div>
                                <div style={{fontWeight: '600', fontSize: '13px'}}>{batchFormData.clients?.length || 0}</div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Clients with Primary User Assignment */}
                          <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', maxHeight: '350px', overflowY: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                              <thead style={{position: 'sticky', top: 0, background: '#f8fafc'}}>
                                <tr>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>S.No</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>File No.</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0'}}>Client Name</th>
                                  <th style={{padding: '12px', textAlign: 'left', fontWeight: '600', borderBottom: '1px solid #e2e8f0', width: '200px'}}>Primary Assigned User</th>
                                </tr>
                              </thead>
                              <tbody>
                                {(batchFormData.clients || []).map((clientData, idx) => {
                                  const client = data.clients.find(c => c.id === clientData.clientId);
                                  // Filter staff based on selected Task Manager (RM)
                                  const assignableStaff = data.staff.filter(s => 
                                    s.status === 'Active' &&
                                    s.reportingManager === batchFormData.taskManager &&
                                    (s.role === 'Seniors' || s.role === 'Articles')
                                  );
                                  return (
                                    <tr key={clientData.clientId} style={{borderBottom: '1px solid #f1f5f9'}}>
                                      <td style={{padding: '10px'}}>{idx + 1}</td>
                                      <td style={{padding: '10px'}}>{client?.fileNo || '-'}</td>
                                      <td style={{padding: '10px', fontWeight: '500'}}>{client?.name || 'Unknown'}</td>
                                      <td style={{padding: '10px'}}>
                                        <select
                                          value={clientData.primaryAssignedUser || ''}
                                          onChange={(e) => {
                                            setBatchFormData({
                                              ...batchFormData,
                                              clients: batchFormData.clients.map(c =>
                                                c.clientId === clientData.clientId
                                                  ? {...c, primaryAssignedUser: e.target.value}
                                                  : c
                                              )
                                            });
                                          }}
                                          disabled={!batchFormData.taskManager}
                                          style={{
                                            width: '100%',
                                            padding: '8px 10px',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '6px',
                                            fontSize: '12px',
                                            background: !batchFormData.taskManager ? '#f1f5f9' : '#fff'
                                          }}
                                        >
                                          <option value="">{batchFormData.taskManager ? 'Select User' : 'Select Task Manager first'}</option>
                                          {assignableStaff.map(s => (
                                            <option key={s.id} value={s.name}>{s.name} ({s.role})</option>
                                          ))}
                                          {batchFormData.taskManager && assignableStaff.length === 0 && (
                                            <option value="" disabled>No staff under this RM</option>
                                          )}
                                        </select>
                                      </td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                            {batchFormData.taskManager && data.staff.filter(s => 
                              s.status === 'Active' &&
                              s.reportingManager === batchFormData.taskManager &&
                              (s.role === 'Seniors' || s.role === 'Articles')
                            ).length === 0 && (
                              <div style={{padding: '12px', background: '#fef2f2', color: '#dc2626', fontSize: '12px', textAlign: 'center'}}>
                                âš ï¸ No staff (Seniors/Articles) assigned to {batchFormData.taskManager}. Please assign staff to this RM first.
                              </div>
                            )}
                          </div>
                          
                          {/* Save Button */}
                          <div style={{marginTop: '24px', display: 'flex', justifyContent: 'flex-end', gap: '12px'}}>
                            <button
                              onClick={() => setShowBatchForm(false)}
                              style={{
                                padding: '12px 24px',
                                background: '#f1f5f9',
                                color: '#64748b',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '600'
                              }}
                            >
                              Cancel
                            </button>
                            <button
                              onClick={() => {
                                if (batchFormData.id) {
                                  // Update existing
                                  setData(prev => ({
                                    ...prev,
                                    recurringBatches: prev.recurringBatches.map(b =>
                                      b.id === batchFormData.id ? {...batchFormData} : b
                                    )
                                  }));
                                } else {
                                  // Create new
                                  setData(prev => ({
                                    ...prev,
                                    recurringBatches: [
                                      ...prev.recurringBatches,
                                      {...batchFormData, id: generateId(), createdAt: new Date().toISOString()}
                                    ]
                                  }));
                                }
                                setShowBatchForm(false);
                                setBatchFormStep(1);
                              }}
                              style={{
                                padding: '12px 24px',
                                background: '#10b981',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '600'
                              }}
                            >
                              {batchFormData.id ? 'Update Batch' : 'Create Batch'}
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
              {/* ============ CHECKLISTS TAB ============ */}
              {taskConfigActiveTab === 'checklists' && (
                <div>
                  {!showChecklistForm && !selectedChecklist ? (
                    <>
                      {/* Header with Add Button */}
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600', color: '#374151'}}>
                          Task Checklists ({(data.checklists || []).length})
                        </h3>
                        <button
                          onClick={() => {
                            setChecklistFormData({
                              name: '',
                              parentTask: Object.keys(PARENT_CHILD_TASKS)[0] || '',
                              childTask: '',
                              items: [],
                              isActive: true
                            });
                            setNewChecklistItem('');
                            setShowChecklistForm(true);
                          }}
                          style={{
                            padding: '10px 16px',
                            background: '#8b5cf6',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <Plus size={16} /> Create Checklist
                        </button>
                      </div>
                      
                      {/* Checklists Grid */}
                      {(data.checklists || []).length === 0 ? (
                        <div style={{padding: '60px', textAlign: 'center', color: '#94a3b8', background: '#f8fafc', borderRadius: '12px'}}>
                          <div style={{fontSize: '48px', marginBottom: '16px'}}>âœ…</div>
                          <div style={{fontSize: '16px', fontWeight: '500', marginBottom: '8px'}}>No Checklists Created</div>
                          <div style={{fontSize: '13px'}}>Create checklists to standardize task completion requirements</div>
                        </div>
                      ) : (
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '16px'}}>
                          {(data.checklists || []).map(checklist => (
                            <div
                              key={checklist.id}
                              style={{
                                border: '1px solid #e2e8f0',
                                borderRadius: '12px',
                                padding: '16px',
                                background: '#fff'
                              }}
                            >
                              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px'}}>
                                <div>
                                  <h4 style={{margin: '0 0 4px 0', fontSize: '14px', fontWeight: '600'}}>{checklist.name}</h4>
                                  <div style={{fontSize: '11px', color: '#64748b'}}>
                                    {checklist.parentTask} {checklist.childTask && `â†’ ${checklist.childTask}`}
                                  </div>
                                </div>
                                <span style={{
                                  padding: '4px 8px',
                                  borderRadius: '6px',
                                  fontSize: '10px',
                                  fontWeight: '600',
                                  background: checklist.isActive ? '#dcfce7' : '#f1f5f9',
                                  color: checklist.isActive ? '#16a34a' : '#94a3b8'
                                }}>
                                  {checklist.isActive ? 'Active' : 'Inactive'}
                                </span>
                              </div>
                              
                              <div style={{fontSize: '12px', color: '#64748b', marginBottom: '12px'}}>
                                {checklist.items?.length || 0} checklist items
                              </div>
                              
                              <div style={{display: 'flex', gap: '8px'}}>
                                <button
                                  onClick={() => setSelectedChecklist(checklist)}
                                  style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#f1f5f9',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '11px',
                                    fontWeight: '500'
                                  }}
                                >
                                  View Items
                                </button>
                                <button
                                  onClick={() => {
                                    setChecklistFormData({...checklist});
                                    setNewChecklistItem('');
                                    setShowChecklistForm(true);
                                  }}
                                  style={{
                                    padding: '8px 12px',
                                    background: '#fef3c7',
                                    color: '#d97706',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                  }}
                                >
                                  <Edit size={14} />
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Delete checklist "${checklist.name}"?`)) {
                                      setData(prev => ({
                                        ...prev,
                                        checklists: prev.checklists.filter(c => c.id !== checklist.id)
                                      }));
                                    }
                                  }}
                                  style={{
                                    padding: '8px 12px',
                                    background: '#fef2f2',
                                    color: '#ef4444',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                  }}
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </>
                  ) : selectedChecklist ? (
                    /* View Checklist Items */
                    <div>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px'}}>
                        <button
                          onClick={() => setSelectedChecklist(null)}
                          style={{
                            padding: '8px 12px',
                            background: '#f1f5f9',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <ChevronLeft size={16} /> Back
                        </button>
                        <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>
                          Checklist: <span style={{color: '#8b5cf6'}}>{selectedChecklist.name}</span>
                        </h3>
                      </div>
                      
                      <div style={{background: '#f8fafc', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px'}}>
                          <div>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>For Task</div>
                            <div style={{fontWeight: '500'}}>{selectedChecklist.parentTask} {selectedChecklist.childTask && `â†’ ${selectedChecklist.childTask}`}</div>
                          </div>
                          <div>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Items</div>
                            <div style={{fontWeight: '500'}}>{selectedChecklist.items?.length || 0}</div>
                          </div>
                          <div>
                            <div style={{fontSize: '11px', color: '#64748b', marginBottom: '4px'}}>Status</div>
                            <div style={{fontWeight: '500', color: selectedChecklist.isActive ? '#10b981' : '#94a3b8'}}>
                              {selectedChecklist.isActive ? 'â— Active' : 'â—‹ Inactive'}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {(selectedChecklist.items || []).length === 0 ? (
                        <div style={{padding: '40px', textAlign: 'center', color: '#94a3b8'}}>
                          No items in this checklist.
                        </div>
                      ) : (
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', overflow: 'hidden'}}>
                          {selectedChecklist.items.map((item, idx) => (
                            <div
                              key={item.id}
                              style={{
                                padding: '12px 16px',
                                borderBottom: idx < selectedChecklist.items.length - 1 ? '1px solid #e2e8f0' : 'none',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                              }}
                            >
                              <span style={{
                                width: '24px',
                                height: '24px',
                                borderRadius: '50%',
                                background: '#e2e8f0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '11px',
                                fontWeight: '600'
                              }}>
                                {idx + 1}
                              </span>
                              <span style={{flex: 1, fontSize: '13px'}}>{item.text}</span>
                              {item.required && (
                                <span style={{
                                  padding: '2px 8px',
                                  background: '#fef2f2',
                                  color: '#ef4444',
                                  borderRadius: '4px',
                                  fontSize: '10px',
                                  fontWeight: '600'
                                }}>
                                  Required
                                </span>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ) : (
                    /* Checklist Form */
                    <div>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px'}}>
                        <button
                          onClick={() => setShowChecklistForm(false)}
                          style={{
                            padding: '8px 12px',
                            background: '#f1f5f9',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <ChevronLeft size={16} /> Back
                        </button>
                        <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>
                          {checklistFormData.id ? 'Edit Checklist' : 'Create New Checklist'}
                        </h3>
                      </div>
                      
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px', marginBottom: '24px'}}>
                        <div>
                          <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Checklist Name *</label>
                          <input
                            type="text"
                            value={checklistFormData.name}
                            onChange={(e) => setChecklistFormData({...checklistFormData, name: e.target.value})}
                            placeholder="e.g., GST Filing Checklist"
                            style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                          />
                        </div>
                        <div>
                          <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Parent Task *</label>
                          <select
                            value={checklistFormData.parentTask}
                            onChange={(e) => setChecklistFormData({...checklistFormData, parentTask: e.target.value, childTask: ''})}
                            style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                          >
                            <option value="">Select Parent Task</option>
                            {Object.keys(PARENT_CHILD_TASKS).map(p => (
                              <option key={p} value={p}>{p}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label style={{display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '500'}}>Child Task</label>
                          <select
                            value={checklistFormData.childTask}
                            onChange={(e) => setChecklistFormData({...checklistFormData, childTask: e.target.value})}
                            style={{width: '100%', padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                            disabled={!checklistFormData.parentTask}
                          >
                            <option value="">All Child Tasks</option>
                            {(PARENT_CHILD_TASKS[checklistFormData.parentTask] || []).map(c => (
                              <option key={c} value={c}>{c}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                      
                      {/* Checklist Items */}
                      <div>
                        <label style={{display: 'block', marginBottom: '12px', fontSize: '14px', fontWeight: '600'}}>
                          Checklist Items ({checklistFormData.items?.length || 0})
                        </label>
                        
                        {/* Add Item */}
                        <div style={{display: 'flex', gap: '8px', marginBottom: '16px'}}>
                          <input
                            type="text"
                            value={newChecklistItem}
                            onChange={(e) => setNewChecklistItem(e.target.value)}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter' && newChecklistItem.trim()) {
                                setChecklistFormData({
                                  ...checklistFormData,
                                  items: [
                                    ...(checklistFormData.items || []),
                                    {id: generateId(), text: newChecklistItem.trim(), required: false}
                                  ]
                                });
                                setNewChecklistItem('');
                              }
                            }}
                            placeholder="Add checklist item..."
                            style={{flex: 1, padding: '10px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '13px'}}
                          />
                          <button
                            onClick={() => {
                              if (newChecklistItem.trim()) {
                                setChecklistFormData({
                                  ...checklistFormData,
                                  items: [
                                    ...(checklistFormData.items || []),
                                    {id: generateId(), text: newChecklistItem.trim(), required: false}
                                  ]
                                });
                                setNewChecklistItem('');
                              }
                            }}
                            style={{
                              padding: '10px 16px',
                              background: '#8b5cf6',
                              color: '#fff',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '12px',
                              fontWeight: '600'
                            }}
                          >
                            Add
                          </button>
                        </div>
                        
                        {/* Items List */}
                        <div style={{border: '1px solid #e2e8f0', borderRadius: '12px', maxHeight: '250px', overflowY: 'auto'}}>
                          {(checklistFormData.items || []).length === 0 ? (
                            <div style={{padding: '30px', textAlign: 'center', color: '#94a3b8', fontSize: '13px'}}>
                              No items added yet. Add items above.
                            </div>
                          ) : (
                            checklistFormData.items.map((item, idx) => (
                              <div
                                key={item.id}
                                style={{
                                  padding: '12px 16px',
                                  borderBottom: idx < checklistFormData.items.length - 1 ? '1px solid #e2e8f0' : 'none',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '12px'
                                }}
                              >
                                <span style={{fontSize: '12px', color: '#94a3b8', width: '20px'}}>{idx + 1}.</span>
                                <span style={{flex: 1, fontSize: '13px'}}>{item.text}</span>
                                <label style={{display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', fontSize: '11px', color: '#64748b'}}>
                                  <input
                                    type="checkbox"
                                    checked={item.required}
                                    onChange={(e) => {
                                      setChecklistFormData({
                                        ...checklistFormData,
                                        items: checklistFormData.items.map(i =>
                                          i.id === item.id ? {...i, required: e.target.checked} : i
                                        )
                                      });
                                    }}
                                  />
                                  Required
                                </label>
                                <button
                                  onClick={() => {
                                    setChecklistFormData({
                                      ...checklistFormData,
                                      items: checklistFormData.items.filter(i => i.id !== item.id)
                                    });
                                  }}
                                  style={{
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    color: '#ef4444',
                                    padding: '4px'
                                  }}
                                >
                                  <X size={16} />
                                </button>
                              </div>
                            ))
                          )}
                        </div>
                      </div>
                      
                      {/* Active Toggle & Save */}
                      <div style={{marginTop: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <label style={{display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer'}}>
                          <input
                            type="checkbox"
                            checked={checklistFormData.isActive}
                            onChange={(e) => setChecklistFormData({...checklistFormData, isActive: e.target.checked})}
                            style={{width: '18px', height: '18px'}}
                          />
                          <span style={{fontSize: '13px', fontWeight: '500'}}>Active</span>
                        </label>
                        
                        <div style={{display: 'flex', gap: '12px'}}>
                          <button
                            onClick={() => setShowChecklistForm(false)}
                            style={{
                              padding: '12px 24px',
                              background: '#f1f5f9',
                              color: '#64748b',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            Cancel
                          </button>
                          <button
                            onClick={() => {
                              if (!checklistFormData.name.trim()) {
                                alert('Checklist name is required');
                                return;
                              }
                              if (!checklistFormData.parentTask) {
                                alert('Please select a parent task');
                                return;
                              }
                              
                              if (checklistFormData.id) {
                                // Update existing
                                setData(prev => ({
                                  ...prev,
                                  checklists: prev.checklists.map(c =>
                                    c.id === checklistFormData.id ? {...checklistFormData} : c
                                  )
                                }));
                              } else {
                                // Create new
                                setData(prev => ({
                                  ...prev,
                                  checklists: [
                                    ...prev.checklists,
                                    {...checklistFormData, id: generateId(), createdAt: new Date().toISOString()}
                                  ]
                                }));
                              }
                              setShowChecklistForm(false);
                            }}
                            style={{
                              padding: '12px 24px',
                              background: '#8b5cf6',
                              color: '#fff',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '600'
                            }}
                          >
                            {checklistFormData.id ? 'Update Checklist' : 'Create Checklist'}
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            {/* Modal Footer - Only show for Categories tab */}
            {taskConfigActiveTab === 'categories' && (
              <div style={{
                padding: '16px 24px',
                borderTop: '1px solid #e2e8f0',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <button
                  onClick={() => {
                    if (window.confirm('Reset all task categories to defaults?')) {
                      setData(prev => ({
                        ...prev,
                        parentChildTasks: { ...DEFAULT_PARENT_CHILD_TASKS }
                      }));
                      setTaskConfigSelectedParent(Object.keys(DEFAULT_PARENT_CHILD_TASKS)[0] || '');
                    }
                  }}
                  style={{
                    padding: '10px 16px',
                    background: '#fef2f2',
                    color: '#ef4444',
                    border: '1px solid #fecaca',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '600'
                  }}
                >
                  Reset to Defaults
                </button>
                <button
                  onClick={() => setShowTaskConfigModal(false)}
                  style={{
                    padding: '10px 20px',
                    background: '#3b82f6',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '600'
                  }}
                >
                  Done
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f8fafc;
          color: #1a1a1a;
        }

        .app {
          display: flex;
          height: 100vh;
          overflow: hidden;
          gap: 0;
          background: #f8fafc;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Sidebar Styles - Light Theme */
        .sidebar {
          width: 220px;
          min-width: 220px;
          background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
          color: #334155;
          display: flex;
          flex-direction: column;
          transition: all 0.15s ease;
          border-right: 1px solid #e2e8f0;
          z-index: 100;
          overflow-y: auto;
          flex-shrink: 0;
        }

        .sidebar.closed {
          width: 60px;
          min-width: 60px;
        }

        .sidebar-header {
          padding: 14px 16px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          border-bottom: 1px solid #e2e8f0;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .logo {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 18px;
          font-weight: 700;
          color: white;
        }

        .sidebar.closed .logo-text {
          display: none;
        }

        .sidebar-toggle {
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          padding: 6px;
          border-radius: 6px;
          transition: all 0.2s;
        }

        .sidebar-toggle:hover {
          background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-nav {
          flex: 1;
          padding: 8px 0;
          overflow-y: auto;
        }

        .sidebar-nav > button {
          width: 100%;
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 16px;
          background: none;
          border: none;
          color: #64748b;
          font-size: 13px;
          cursor: pointer;
          transition: all 0.2s;
          border-left: 3px solid transparent;
        }

        .sidebar-nav > button:hover {
          background: #f1f5f9;
          color: #334155;
        }

        .sidebar-nav > button.active {
          background: linear-gradient(90deg, #dcfce7 0%, #f0fdf4 100%);
          color: #16a34a;
          border-left-color: #10b981;
        }

        .nav-section {
          margin: 6px 0;
        }

        .nav-section-header {
          width: 100%;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 16px;
          background: none;
          border: none;
          color: #94a3b8;
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          cursor: pointer;
          transition: all 0.2s;
          text-align: left;
        }

        .nav-section-header:hover {
          background: #f1f5f9;
          color: #64748b;
        }

        .nav-section-header.expanded {
          color: #475569;
        }

        .nav-section-header svg:last-child {
          margin-left: auto;
        }

        .task-categories {
          max-height: 350px;
          overflow-y: auto;
        }

        .parent-task-item {
          margin: 2px 0;
        }

        .parent-task-btn {
          width: 100%;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 9px 16px;
          background: none;
          border: none;
          color: #475569;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          text-align: left;
        }

        .parent-task-btn:hover {
          background: #f1f5f9;
          color: #334155;
        }

        .parent-task-btn.expanded {
          color: #16a34a;
          background: #f0fdf4;
        }

        .child-tasks {
          background: #f8fafc;
          padding: 4px 0;
          border-left: 2px solid #e2e8f0;
          margin-left: 16px;
        }

        .child-task-btn {
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 8px 20px 8px 32px;
          background: none;
          border: none;
          color: #64748b;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.2s;
          text-align: left;
        }

        .child-task-btn:hover {
          background: #f1f5f9;
          color: #334155;
        }

        .child-task-btn.active {
          background: #dcfce7;
          color: #16a34a;
        }

        .child-task-name {
          flex: 1;
        }

        .task-count {
          background: #dcfce7;
          color: #16a34a;
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 11px;
          font-weight: 600;
        }

        .sidebar-footer {
          padding: 12px 14px;
          border-top: 1px solid #e2e8f0;
          display: flex;
          align-items: center;
          gap: 10px;
          background: #f8fafc;
        }

        .user-profile {
          display: flex;
          align-items: center;
          gap: 8px;
          flex: 1;
        }

        .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 12px;
          color: white;
        }

        .user-info {
          flex: 1;
        }

        .user-name {
          font-size: 12px;
          font-weight: 600;
          color: #334155;
        }

        .user-role {
          font-size: 10px;
          color: #64748b;
        }

        .logout-btn {
          background: none;
          border: none;
          color: #94a3b8;
          cursor: pointer;
          padding: 5px;
          border-radius: 5px;
          transition: all 0.2s;
        }

        .logout-btn:hover {
          background: #fee2e2;
          color: #ef4444;
        }

        /* Main Content */
        .main-content {
          flex: 1;
          overflow-y: auto;
          padding: 0;
          margin: 0;
          background: #f8fafc;
          min-width: 0;
          border: none;
        }

        /* All Views Padding - Increased */
        .dashboard-view,
        .clients-view,
        .staff-view,
        .invoicing-view,
        .reports-view,
        .templates-view,
        .approvals-view,
        .tasks-view {
          padding: 24px 40px;
          margin: 0;
          background: #f8fafc;
        }

        .view-header {
          margin-bottom: 24px;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
        }

        .view-header h1 {
          font-size: 28px;
          font-weight: 700;
          color: #1a1a1a;
          margin-bottom: 4px;
        }

        .view-subtitle {
          font-size: 14px;
          color: #64748b;
        }

        .breadcrumb {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 12px;
          font-size: 13px;
          color: #64748b;
        }

        .breadcrumb .current {
          color: #1a1a1a;
          font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 20px;
          margin-bottom: 32px;
        }

        .stat-card {
          background: white;
          border-radius: 12px;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 16px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }

        .stat-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
          width: 48px;
          height: 48px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .stat-card.primary .stat-icon {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .stat-card.success .stat-icon {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }

        .stat-card.warning .stat-icon {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
        }

        .stat-card.accent .stat-icon {
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          color: white;
        }

        .stat-content {
          flex: 1;
        }

        .stat-value {
          font-size: 28px;
          font-weight: 700;
          color: #1a1a1a;
          line-height: 1;
          margin-bottom: 4px;
        }

        .stat-label {
          font-size: 13px;
          color: #64748b;
          margin-bottom: 2px;
        }

        .stat-detail {
          font-size: 12px;
          color: #94a3b8;
        }

        /* Dashboard Quick Access */
        .dashboard-quick-access {
          margin-top: 32px;
        }

        .dashboard-quick-access h2 {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 20px;
          color: #1a1a1a;
        }

        .category-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 20px;
        }

        .category-card {
          background: white;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .category-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .category-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .category-header h3 {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .category-count {
          background: #10b981;
          color: white;
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 13px;
          font-weight: 600;
        }

        .category-children {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
        }

        .child-tag {
          background: #f1f5f9;
          color: #475569;
          padding: 4px 10px;
          border-radius: 6px;
          font-size: 11px;
        }

        .more-tag {
          background: #e2e8f0;
          color: #64748b;
          padding: 4px 10px;
          border-radius: 6px;
          font-size: 11px;
          font-weight: 600;
        }

        /* Task Detail View */
        .search-filters-section {
          background: #e8f5f1;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .section-title {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 16px;
        }

        .filters-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 16px;
          margin-bottom: 16px;
        }

        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .filter-group label {
          font-size: 13px;
          font-weight: 600;
          color: #334155;
        }

        .filter-group input,
        .filter-group select {
          padding: 10px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 8px;
          font-size: 14px;
          outline: none;
          background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
          border-color: #10b981;
        }

        .filter-actions {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
        }

        .btn-search, .btn-reset {
          padding: 10px 24px;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-search {
          background: #10b981;
          color: white;
        }

        .btn-search:hover {
          background: #059669;
        }

        .btn-reset {
          background: #64748b;
          color: white;
        }

        .btn-reset:hover {
          background: #475569;
        }

        .action-buttons-section {
          display: flex;
          gap: 12px;
          margin-bottom: 20px;
        }

        .btn-action {
          padding: 10px 20px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-action:hover {
          background: #059669;
        }

        .table-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
          background: white;
          padding: 16px;
          border-radius: 12px;
        }

        .entries-control {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 14px;
        }

        .entries-control select {
          padding: 6px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 6px;
          outline: none;
        }

        .table-search {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 14px;
        }

        .table-search input {
          padding: 6px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 6px;
          outline: none;
          width: 200px;
        }

        /* Tasks Table */
        .tasks-table-wrapper {
          background: white;
          border-radius: 12px;
          overflow-x: auto;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tasks-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .tasks-table thead {
          background: #f8fafc;
          position: sticky;
          top: 0;
        }

        .tasks-table th {
          padding: 12px;
          text-align: left;
          font-weight: 600;
          color: #475569;
          border-bottom: 2px solid #e2e8f0;
          white-space: nowrap;
        }

        .tasks-table td {
          padding: 12px;
          border-bottom: 1px solid #f1f5f9;
          color: #334155;
        }

        .tasks-table tbody tr:hover {
          background: #f8fafc;
        }

        .client-cell {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .client-cell strong {
          color: #1a1a1a;
        }

        .contact-link {
          color: #10b981;
          font-size: 11px;
          text-decoration: none;
        }

        .contact-link:hover {
          text-decoration: underline;
        }

        .manage-btn {
          background: #10b981;
          color: white;
          border: none;
          padding: 6px;
          border-radius: 6px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .manage-btn:hover {
          background: #059669;
        }

        .delete-btn-table {
          background: #ef4444;
          color: white;
          border: none;
          padding: 6px;
          border-radius: 6px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .delete-btn-table:hover {
          background: #dc2626;
          transform: scale(1.1);
        }

        .status-badge-table {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          display: inline-block;
        }

        .status-badge-table.status-open {
          background: #fef3c7;
          color: #92400e;
        }

        .status-badge-table.status-completed {
          background: #dcfce7;
          color: #166534;
        }

        .status-badge-table.status-deleted {
          background: #fee2e2;
          color: #991b1b;
        }

        .status-badge-table.status-in-progress {
          background: #dbeafe;
          color: #1e40af;
        }

        .table-footer {
          background: white;
          padding: 16px;
          border-radius: 0 0 12px 12px;
          font-size: 14px;
          color: #64748b;
        }

        /* Buttons */
        .btn-primary {
          padding: 12px 24px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
          padding: 10px 20px;
          background: white;
          color: #10b981;
          border: 2px solid #10b981;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-secondary:hover {
          background: #10b981;
          color: white;
        }

        /* Clients Grid */
        .clients-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 20px;
        }

        .client-card {
          background: white;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }

        .client-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .client-header {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 16px;
        }

        .client-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          font-weight: 700;
        }

        .client-info h3 {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 4px;
        }

        .client-info p {
          font-size: 13px;
          color: #64748b;
        }

        .client-details {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .detail-row {
          display: flex;
          justify-content: space-between;
          font-size: 13px;
        }

        .detail-row span:first-child {
          color: #64748b;
        }

        .detail-row span:last-child {
          font-weight: 600;
          color: #1a1a1a;
        }

        /* Staff Grid */
        /* Staff Management Styles */
        .staff-categories-tabs {
          display: flex;
          gap: 8px;
          margin-bottom: 24px;
          flex-wrap: wrap;
        }

        .category-tab {
          padding: 12px 24px;
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 12px;
          font-weight: 600;
          color: #64748b;
        }

        .category-tab:hover {
          border-color: #10b981;
          background: #f0fdf4;
        }

        .category-tab.active {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border-color: #10b981;
        }

        .tab-label {
          font-size: 14px;
        }

        .tab-count {
          background: rgba(255, 255, 255, 0.2);
          padding: 2px 10px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 700;
        }

        .category-tab.active .tab-count {
          background: rgba(255, 255, 255, 0.3);
        }

        .staff-search-bar {
          display: flex;
          align-items: center;
          gap: 16px;
          margin-bottom: 20px;
          background: white;
          padding: 16px;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-input-wrapper {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 12px;
          background: #f8fafc;
          padding: 10px 16px;
          border-radius: 8px;
          border: 2px solid transparent;
          transition: all 0.2s;
        }

        .search-input-wrapper:focus-within {
          border-color: #10b981;
          background: white;
        }

        .search-input-wrapper input {
          flex: 1;
          border: none;
          background: transparent;
          outline: none;
          font-size: 14px;
          color: #1a1a1a;
        }

        .staff-count-display {
          color: #64748b;
          font-size: 14px;
        }

        .staff-count-display strong {
          color: #10b981;
          font-size: 18px;
        }

        .staff-table-container {
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-table {
          width: 100%;
          border-collapse: collapse;
        }

        .staff-table thead {
          background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .staff-table th {
          padding: 14px 16px;
          text-align: left;
          font-size: 12px;
          font-weight: 700;
          color: #475569;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border-bottom: 2px solid #e2e8f0;
        }

        .staff-table td {
          padding: 16px;
          font-size: 14px;
          color: #334155;
          border-bottom: 1px solid #f1f5f9;
        }

        .staff-table tbody tr {
          transition: all 0.2s;
        }

        .staff-table tbody tr:hover {
          background: #f8fafc;
        }

        .staff-name-cell {
          display: flex;
          align-items: center;
          gap: 12px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .staff-avatar-small {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          font-weight: 700;
        }

        .icon-btn-staff {
          padding: 8px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        .icon-btn-staff.edit-btn {
          background: #10b981;
          color: white;
        }

        .icon-btn-staff.edit-btn:hover {
          background: #059669;
          transform: scale(1.1);
        }

        .icon-btn-staff.controls-btn {
          background: #64748b;
          color: white;
        }

        .icon-btn-staff.controls-btn:hover {
          background: #475569;
          transform: scale(1.1);
        }

        .status-badge-staff {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          display: inline-block;
        }

        .status-badge-staff.status-active {
          background: #dcfce7;
          color: #166534;
        }

        .status-badge-staff.status-disabled {
          background: #fee2e2;
          color: #991b1b;
        }

        .empty-state {
          padding: 60px 20px;
          text-align: center;
          color: #64748b;
        }

        .empty-state h3 {
          margin: 16px 0 8px;
          color: #334155;
          font-size: 20px;
        }

        .empty-state p {
          margin-bottom: 24px;
          font-size: 14px;
        }

        /* Staff Modal Styles */
        .staff-modal {
          background: white;
          border-radius: 16px;
          width: 90%;
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
        }

        /* Upload Modal Styles */
        .upload-modal {
          background: #fff;
          border-radius: 16px;
          width: 95%;
          max-width: 700px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
        }

        .upload-modal-header {
          padding: 20px 24px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-radius: 16px 16px 0 0;
        }

        .upload-modal-header h2 {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 18px;
          font-weight: 600;
          margin: 0;
        }

        .upload-modal-body {
          padding: 24px;
          overflow-y: auto;
          flex: 1;
        }

        .upload-instructions {
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .upload-instructions h3 {
          font-size: 16px;
          font-weight: 600;
          color: #0f172a;
          margin: 0 0 10px 0;
        }

        .upload-instructions p {
          font-size: 14px;
          color: #64748b;
          margin: 0 0 12px 0;
        }

        .csv-columns {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-bottom: 12px;
        }

        .csv-col {
          padding: 6px 12px;
          background: #e2e8f0;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          color: #475569;
          font-family: monospace;
        }

        .csv-col.required {
          background: #dbeafe;
          color: #1d4ed8;
        }

        .hint {
          font-size: 12px;
          color: #94a3b8;
        }

        .upload-area {
          margin-bottom: 20px;
        }

        .upload-dropzone {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 12px;
          padding: 40px;
          border: 2px dashed #cbd5e1;
          border-radius: 12px;
          background: #f8fafc;
          cursor: pointer;
          transition: all 0.2s;
          color: #64748b;
        }

        .upload-dropzone:hover {
          border-color: #3b82f6;
          background: #eff6ff;
          color: #3b82f6;
        }

        .upload-dropzone span {
          font-size: 14px;
          font-weight: 500;
        }

        .upload-error {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 16px;
          background: #fef2f2;
          border: 1px solid #fecaca;
          border-radius: 8px;
          color: #dc2626;
          font-size: 14px;
          margin-bottom: 20px;
        }

        .upload-warning {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 16px;
          background: #fffbeb;
          border: 1px solid #fcd34d;
          border-radius: 8px;
          color: #b45309;
          font-size: 13px;
          margin-bottom: 16px;
        }

        .upload-sample {
          text-align: center;
          padding-top: 16px;
          border-top: 1px solid #e2e8f0;
        }

        .btn-download-sample {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 12px 24px;
          background: #fff;
          border: 2px solid #10b981;
          border-radius: 8px;
          color: #10b981;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-download-sample:hover {
          background: #10b981;
          color: #fff;
        }

        .upload-preview-header {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 16px;
          background: #f0fdf4;
          border: 1px solid #86efac;
          border-radius: 8px;
          margin-bottom: 16px;
          font-size: 15px;
          font-weight: 600;
          color: #166534;
        }

        .upload-preview-table {
          max-height: 350px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
        }

        .upload-preview-table table {
          width: 100%;
          border-collapse: collapse;
        }

        .upload-preview-table th {
          padding: 12px 14px;
          text-align: left;
          background: #f1f5f9;
          font-size: 11px;
          font-weight: 600;
          color: #475569;
          text-transform: uppercase;
          position: sticky;
          top: 0;
        }

        .upload-preview-table td {
          padding: 10px 14px;
          font-size: 13px;
          border-bottom: 1px solid #f1f5f9;
        }

        .role-badge {
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 11px;
          font-weight: 600;
        }

        .role-badge.role-partner { background: #fef3c7; color: #92400e; }
        .role-badge.role-manager { background: #dbeafe; color: #1e40af; }
        .role-badge.role-senior-associate { background: #f3e8ff; color: #7c3aed; }
        .role-badge.role-articles { background: #d1fae5; color: #065f46; }

        .upload-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 16px 24px;
          background: #f8fafc;
          border-top: 1px solid #e2e8f0;
          border-radius: 0 0 16px 16px;
        }

        .btn-confirm-upload {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 24px;
          background: #10b981;
          border: none;
          border-radius: 8px;
          color: #fff;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-confirm-upload:hover {
          background: #059669;
        }

        .header-actions {
          display: flex;
          gap: 12px;
        }

        .btn-secondary {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 20px;
          background: #fff;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          color: #475569;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-secondary:hover {
          border-color: #3b82f6;
          color: #3b82f6;
          background: #eff6ff;
        }

        .staff-modal-header {
          padding: 20px 28px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: none;
        }

        .staff-modal-header h2 {
          font-size: 20px;
          font-weight: 700;
          margin: 0;
        }

        .staff-modal-body {
          padding: 24px 28px;
        }

        .form-section-staff {
          margin-bottom: 28px;
        }

        .section-label-staff {
          font-size: 16px;
          font-weight: 700;
          color: #1a1a1a;
          margin-bottom: 16px;
          padding-bottom: 8px;
          border-bottom: 2px solid #e2e8f0;
        }

        .form-row-staff {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
          margin-bottom: 16px;
        }

        .form-field-staff {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .form-field-staff label {
          font-size: 13px;
          font-weight: 600;
          color: #475569;
        }

        .form-field-staff input,
        .form-field-staff select {
          padding: 10px 14px;
          border: 2px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          transition: all 0.2s;
          background: white;
        }

        .form-field-staff input:focus,
        .form-field-staff select:focus {
          outline: none;
          border-color: #10b981;
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .manage-actions-staff {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .manage-item-staff {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px;
          background: #f8fafc;
          border-radius: 8px;
        }

        .manage-item-staff label {
          font-size: 14px;
          font-weight: 600;
          color: #334155;
        }

        .btn-action-staff {
          padding: 8px 20px;
          border: none;
          border-radius: 6px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-action-staff.btn-reset {
          background: #f59e0b;
          color: white;
        }

        .btn-action-staff.btn-reset:hover {
          background: #d97706;
          transform: scale(1.05);
        }

        .btn-action-staff.btn-toggle {
          background: #64748b;
          color: white;
        }

        .btn-action-staff.btn-toggle:hover {
          background: #475569;
          transform: scale(1.05);
        }

        .staff-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 20px 28px;
          border-top: 2px solid #f1f5f9;
          background: #f8fafc;
        }

        @media (max-width: 768px) {
          .form-row-staff {
            grid-template-columns: 1fr;
          }

          .category-tab {
            flex: 1;
            justify-content: center;
          }
        }
          transition: width 0.3s ease;
        }

        /* Reports Grid */
        .reports-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
        }

        .report-card {
          background: white;
          border-radius: 12px;
          padding: 24px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          text-align: center;
          transition: all 0.3s ease;
        }

        .report-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .report-icon {
          width: 56px;
          height: 56px;
          margin: 0 auto 16px;
          border-radius: 12px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .report-card h3 {
          font-size: 18px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 6px;
        }

        .report-card p {
          font-size: 13px;
          color: #64748b;
          margin-bottom: 16px;
        }

        /* Modal */
        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

        .modal {
          background: white;
          border-radius: 16px;
          width: 90%;
          max-width: 600px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
        }

        .large-modal {
          max-width: 800px;
        }

        @keyframes slideUp {
          from {
            transform: translateY(50px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .modal-header {
          padding: 20px 24px;
          border-bottom: 1px solid #f1f5f9;
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: sticky;
          top: 0;
          background: white;
          z-index: 10;
        }

        .modal-header h2 {
          font-size: 20px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .modal-close {
          background: none;
          border: none;
          color: #64748b;
          cursor: pointer;
          padding: 6px;
          border-radius: 6px;
          transition: all 0.2s;
        }

        .modal-close:hover {
          background: #f8fafc;
          color: #1a1a1a;
        }

        .modal-body {
          padding: 24px;
        }

        .form-section {
          margin-bottom: 24px;
          padding-bottom: 20px;
          border-bottom: 1px solid #f1f5f9;
        }

        .form-section:last-child {
          border-bottom: none;
          margin-bottom: 0;
        }

        .form-section-title {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 16px;
        }

        .form-group {
          margin-bottom: 16px;
        }

        .form-group label {
          display: block;
          margin-bottom: 6px;
          font-size: 13px;
          font-weight: 600;
          color: #475569;
        }

        .required {
          color: #ef4444;
          margin-left: 2px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
          width: 100%;
          padding: 10px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 8px;
          font-size: 14px;
          outline: none;
          transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
          border-color: #10b981;
        }

        .form-group input:disabled,
        .form-group select:disabled {
          background: #f8fafc;
          cursor: not-allowed;
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }

        .modal-footer {
          padding: 16px 24px;
          border-top: 1px solid #f1f5f9;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          position: sticky;
          bottom: 0;
          background: white;
        }

        /* Task Management Modal */
        .task-manage-modal {
          background: white;
          border-radius: 16px;
          width: 95%;
          max-width: 1400px;
          max-height: 95vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
        }

        .task-manage-header {
          padding: 20px 28px;
          border-bottom: 2px solid #e2e8f0;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8fafc;
          position: sticky;
          top: 0;
          z-index: 10;
        }

        .task-manage-header h2 {
          font-size: 22px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .header-actions {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .bill-status {
          background: #10b981;
          color: white;
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
        }

        .btn-edit {
          padding: 8px 16px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-edit:hover {
          background: #059669;
        }

        .action-cards {
          padding: 20px 28px;
          display: flex;
          gap: 16px;
        }

        .action-card-row {
          flex: 1;
          display: flex;
          gap: 16px;
        }

        .action-card {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 12px;
          padding: 24px;
          border: 2px solid #10b981;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s;
          text-align: center;
        }

        .action-card:hover {
          background: #f0fdf4;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .action-card span {
          font-size: 13px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .task-details-section {
          padding: 20px 28px;
          display: grid;
          grid-template-columns: 2fr 1fr;
          gap: 20px;
        }

        .task-details-card {
          background: #f8fafc;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          padding: 20px;
        }

        .task-details-card h3 {
          font-size: 18px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .details-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }

        .detail-item {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .detail-item label {
          font-size: 12px;
          font-weight: 600;
          color: #64748b;
        }

        .detail-item span {
          font-size: 14px;
          color: #1a1a1a;
        }

        .btn-change-group {
          padding: 8px 16px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          width: fit-content;
        }

        .btn-change-group:hover {
          background: #059669;
        }

        .signature-card {
          background: #e0f2fe;
          border: 2px solid #0ea5e9;
          border-radius: 12px;
          padding: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 16px;
        }

        .signature-card h3 {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .btn-view-details {
          padding: 10px 20px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-view-details:hover {
          background: #059669;
        }

        .task-tabs {
          border-top: 2px solid #e2e8f0;
        }

        .tabs-header {
          display: flex;
          background: #f8fafc;
          border-bottom: 2px solid #e2e8f0;
          overflow-x: auto;
          position: sticky;
          top: 80px;
          z-index: 9;
        }

        .tab-btn {
          padding: 14px 20px;
          background: none;
          border: none;
          border-bottom: 3px solid transparent;
          font-size: 13px;
          font-weight: 600;
          color: #64748b;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }

        .tab-btn:hover {
          background: #e2e8f0;
          color: #1a1a1a;
        }

        .tab-btn.active {
          color: #10b981;
          border-bottom-color: #10b981;
          background: white;
        }

        .tabs-content {
          padding: 24px 28px;
          min-height: 400px;
        }

        .milestones-content {
          background: #f0fdf4;
          border-radius: 12px;
          padding: 20px;
        }

        .milestone-header {
          margin-bottom: 16px;
        }

        .milestone-header h3 {
          font-size: 18px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .milestone-table {
          width: 100%;
          background: white;
          border-radius: 8px;
          overflow: hidden;
          border-collapse: collapse;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .milestone-table thead {
          background: #f8fafc;
        }

        .milestone-table th {
          padding: 12px;
          text-align: left;
          font-size: 13px;
          font-weight: 600;
          color: #475569;
          border-bottom: 2px solid #e2e8f0;
        }

        .milestone-table td {
          padding: 12px;
          font-size: 13px;
          color: #334155;
          border-bottom: 1px solid #f1f5f9;
        }

        .milestone-table tbody tr:hover {
          background: #f8fafc;
        }

        .icon-btn {
          background: none;
          border: none;
          color: #64748b;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .icon-btn:hover {
          background: #f1f5f9;
          color: #10b981;
        }

        .icon-btn.delete-btn:hover {
          color: #ef4444;
        }

        .milestone-footer {
          margin-top: 16px;
          display: flex;
          justify-content: flex-end;
        }

        .btn-reopen {
          padding: 10px 20px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-reopen:hover {
          background: #059669;
        }

        .tab-content {
          background: #f8fafc;
          border-radius: 12px;
          padding: 24px;
        }

        .tab-content h3 {
          font-size: 18px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 12px;
        }

        .tab-content p {
          color: #64748b;
          font-size: 14px;
        }

        .task-details-form {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .task-details-form h3 {
          font-size: 20px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 24px;
          padding-bottom: 12px;
          border-bottom: 2px solid #e2e8f0;
        }

        .form-subsection-title {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .form-subsection-title::before {
          content: '';
          width: 4px;
          height: 18px;
          background: #10b981;
          border-radius: 2px;
        }

        .form-actions {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          margin-top: 24px;
          padding-top: 24px;
          border-top: 2px solid #e2e8f0;
        }

        .icon-btn:disabled {
          opacity: 0.3;
          cursor: not-allowed;
        }

        .icon-btn:disabled:hover {
          background: none;
          color: #64748b;
        }

        /* Task Details View Only Mode */
        .task-details-view-only {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .view-only-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding-bottom: 16px;
          border-bottom: 2px solid #e2e8f0;
        }

        .view-only-header h3 {
          font-size: 20px;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0;
        }

        .details-compact-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 24px;
        }

        /* Client Management Styles */
        .header-buttons-group {
          display: flex;
          gap: 12px;
          align-items: center;
        }

        .client-search-section {
          background: white;
          border-radius: 12px;
          padding: 24px;
          margin-bottom: 24px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .client-search-section h3 {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 16px;
          color: #1a1a1a;
        }

        .search-controls {
          display: flex;
          gap: 12px;
          margin-bottom: 16px;
        }

        .search-type-select {
          padding: 10px 16px;
          border: 1px solid #cbd5e1;
          border-radius: 8px;
          font-size: 14px;
          min-width: 150px;
          outline: none;
        }

        .search-input {
          flex: 1;
          padding: 10px 16px;
          border: 1px solid #cbd5e1;
          border-radius: 8px;
          font-size: 14px;
          outline: none;
        }

        .search-input:focus {
          border-color: #10b981;
        }

        .client-stats {
          font-size: 14px;
          color: #1a1a1a;
          font-weight: 600;
          margin-bottom: 8px;
        }

        .last-files {
          font-size: 14px;
          color: #64748b;
        }

        .client-tabs {
          display: flex;
          gap: 4px;
          margin-bottom: 24px;
          border-bottom: 2px solid #e2e8f0;
        }

        .client-tab-btn {
          padding: 12px 24px;
          background: none;
          border: none;
          border-bottom: 3px solid transparent;
          font-size: 14px;
          font-weight: 600;
          color: #64748b;
          cursor: pointer;
          transition: all 0.2s;
        }

        .client-tab-btn:hover {
          color: #1a1a1a;
          background: #f8fafc;
        }

        .client-tab-btn.active {
          color: #10b981;
          border-bottom-color: #10b981;
        }

        .clients-table-section {
          background: white;
          border-radius: 12px;
          padding: 24px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-header-actions {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        }

        .table-header-actions h3 {
          font-size: 20px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .header-actions-right {
          display: flex;
          gap: 16px;
          align-items: center;
        }

        .sorting-control {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 14px;
        }

        .sorting-control label {
          font-weight: 600;
          color: #64748b;
        }

        .sorting-control select {
          padding: 8px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 6px;
          outline: none;
        }

        .clients-table-wrapper {
          overflow-x: auto;
          border-radius: 8px;
          border: 1px solid #e2e8f0;
        }

        .clients-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .clients-table thead {
          background: #f8fafc;
        }

        .clients-table th {
          padding: 12px;
          text-align: left;
          font-weight: 600;
          color: #475569;
          border-bottom: 2px solid #e2e8f0;
          white-space: nowrap;
        }

        .clients-table td {
          padding: 12px;
          border-bottom: 1px solid #f1f5f9;
          color: #334155;
        }

        .clients-table tbody tr:hover {
          background: #f8fafc;
        }

        .edit-icon-btn {
          background: #10b981;
          color: white;
          border: none;
          padding: 6px;
          border-radius: 6px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .edit-icon-btn:hover {
          background: #059669;
        }

        /* Create Client Form Styles - Professional */
        .create-client-professional {
          background: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          overflow: hidden;
        }

        .client-form-header {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          padding: 24px 32px;
          border-bottom: none;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .header-left {
          display: flex;
          align-items: center;
          gap: 16px;
        }

        .header-icon {
          color: #fff;
        }

        .client-form-header h2 {
          font-size: 22px;
          font-weight: 600;
          color: #fff;
          margin: 0 0 4px 0;
        }

        .client-form-header p {
          font-size: 13px;
          color: rgba(255, 255, 255, 0.85);
          margin: 0;
        }

        .btn-close-professional {
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          color: #fff;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .btn-close-professional:hover {
          background: rgba(255, 255, 255, 0.3);
          border-color: rgba(255, 255, 255, 0.5);
          color: #fff;
        }

        .professional-tabs {
          background: #fff;
          padding: 0 16px;
          display: flex;
          gap: 0;
          border-bottom: 2px solid #e2e8f0;
        }

        .professional-tab {
          flex: 1;
          min-width: 100px;
          padding: 10px 12px;
          background: transparent;
          border: none;
          border-bottom: 3px solid transparent;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 12px;
          font-weight: 500;
          color: #64748b;
          white-space: nowrap;
        }

        .professional-tab:hover {
          background: #f8fafc;
          color: #1e293b;
        }

        .professional-tab.active {
          background: #fff;
          color: #10b981;
          border-bottom-color: #10b981;
          font-weight: 600;
        }

        .tab-number {
          width: 18px;
          height: 18px;
          border-radius: 50%;
          background: #f1f5f9;
          color: #64748b;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: 600;
          transition: all 0.2s;
        }

        .professional-tab.active .tab-number {
          background: #10b981;
          color: white;
        }

        .tab-text {
          flex: 1;
        }

        .professional-form-body {
          padding: 24px 32px;
          max-height: 600px;
          overflow-y: auto;
          background: #f8fafc;
        }

        .info-banner {
          background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
          border-left: 4px solid #10b981;
          padding: 14px 18px;
          border-radius: 8px;
          margin-bottom: 24px;
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 13px;
          color: #065f46;
        }

        .info-banner strong {
          font-weight: 600;
        }

        .mandatory-fields-note {
          background: #fef3c7;
          border-left: 4px solid #f59e0b;
          padding: 12px 16px;
          border-radius: 6px;
          margin-bottom: 24px;
          font-size: 13px;
          color: #92400e;
        }

        .mandatory-fields-note strong {
          font-weight: 600;
          color: #78350f;
        }

        .form-section-pro {
          margin-bottom: 28px;
          background: #fff;
          border-radius: 10px;
          padding: 20px;
          border: 1px solid #e5e7eb;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .form-section-pro:last-child {
          margin-bottom: 0;
        }

        .section-title-pro {
          font-size: 15px;
          font-weight: 600;
          color: #065f46;
          margin: 0 0 18px 0;
          padding: 10px 14px;
          background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
          border-radius: 8px;
          display: flex;
          align-items: center;
          gap: 10px;
          border-left: 4px solid #10b981;
        }

        .section-title-pro::before {
          content: '';
          display: none;
        }

        .form-grid-pro {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 12px 16px;
          align-items: start;
        }

        .form-field-pro {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .form-field-pro.span-1 {
          grid-column: span 1;
        }

        .form-field-pro.span-2 {
          grid-column: span 2;
        }

        .form-field-pro.span-3 {
          grid-column: span 3;
        }
        
        .form-field-pro.span-4 {
          grid-column: span 4;
        }

        .form-field-pro label {
          font-size: 12px;
          font-weight: 600;
          color: #334155;
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .required-star {
          color: #ef4444;
          font-size: 14px;
        }

        .optional-tag {
          font-size: 11px;
          font-weight: 400;
          color: #94a3b8;
          font-style: italic;
        }

        .form-field-pro input,
        .form-field-pro select,
        .form-field-pro textarea {
          padding: 11px 14px;
          border: 1.5px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          color: #1a1a1a;
          outline: none;
          background: white;
          transition: all 0.2s;
          font-family: inherit;
        }

        .form-field-pro input:focus,
        .form-field-pro select:focus,
        .form-field-pro textarea:focus {
          border-color: #10b981;
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-field-pro input::placeholder,
        .form-field-pro textarea::placeholder {
          color: #94a3b8;
        }

        .form-field-pro input:disabled,
        .form-field-pro select:disabled {
          background: #f8fafc;
          cursor: not-allowed;
          color: #94a3b8;
        }

        .input-with-addon {
          display: flex;
          gap: 8px;
        }

        .input-with-addon select {
          flex: 1;
        }

        .addon-btn {
          padding: 11px 14px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .addon-btn:hover {
          background: #059669;
          transform: scale(1.05);
        }

        .inline-checkbox {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 13px;
          font-weight: 500;
          color: #64748b;
          margin-top: 4px;
          cursor: pointer;
        }

        .inline-checkbox input[type="checkbox"] {
          width: 16px;
          height: 16px;
          margin: 0;
          cursor: pointer;
          accent-color: #10b981;
        }

        .inline-checkbox.checkbox-only {
          margin-top: 28px;
          padding: 11px 14px;
          background: #f8fafc;
          border-radius: 8px;
          border: 1.5px solid #e2e8f0;
        }

        .field-hint {
          font-size: 12px;
          color: #94a3b8;
          font-style: italic;
        }

        .btn-add-section {
          padding: 12px 20px;
          background: white;
          color: #10b981;
          border: 2px dashed #10b981;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
        }

        .btn-add-section:hover {
          background: #f0fdf4;
          border-style: solid;
        }

        .placeholder-content {
          padding: 80px 40px;
          text-align: center;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
        }

        .placeholder-content h3 {
          font-size: 20px;
          font-weight: 600;
          color: #94a3b8;
          margin: 0;
        }

        .placeholder-content p {
          font-size: 14px;
          color: #cbd5e1;
          margin: 0;
        }

        .professional-form-footer {
          background: #f8fafc;
          border-top: 1px solid #e2e8f0;
          padding: 20px 32px;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
        }

        .btn-cancel-pro {
          padding: 12px 28px;
          background: white;
          color: #64748b;
          border: 1.5px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-cancel-pro:hover {
          background: #f8fafc;
          border-color: #cbd5e1;
          color: #475569;
        }

        .btn-submit-pro {
          padding: 12px 32px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .btn-submit-pro:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .btn-submit-pro:active {
          transform: translateY(0);
        }

        /* Auto Bulk Task Batches Tab */
        .bulk-tasks-content {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
        }

        .bulk-section {
          background: white;
          border: 2px solid #10b981;
          border-radius: 12px;
          padding: 20px;
        }

        .bulk-section-title {
          font-size: 16px;
          font-weight: 600;
          color: #10b981;
          margin: 0 0 16px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .bulk-task-list {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .bulk-list-header {
          font-size: 13px;
          font-weight: 600;
          color: #10b981;
          padding: 8px 12px;
          background: #f0fdf4;
          border-radius: 6px;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .task-items-scroll {
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 8px;
        }

        .task-item {
          padding: 10px 12px;
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: pointer;
          transition: all 0.2s;
          font-size: 13px;
          color: #64748b;
        }

        .task-item:hover {
          background: #f8fafc;
          border-color: #10b981;
          color: #10b981;
        }

        .task-item svg {
          flex-shrink: 0;
        }

        /* User IDs & Passwords Tab */
        .userids-content {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .userids-title {
          font-size: 18px;
          font-weight: 600;
          color: #64748b;
          margin: 0 0 24px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .credentials-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 32px;
          border: 1px solid #e5e7eb;
        }

        .credentials-table thead {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .credentials-table th {
          padding: 12px 14px;
          text-align: left;
          font-size: 13px;
          font-weight: 600;
          color: #fff;
          border: 1px solid #059669;
        }

        .credentials-table th:first-child {
          width: 150px;
        }

        .credentials-table td {
          padding: 10px 14px;
          border: 1px solid #e5e7eb;
          background: #fff;
        }

        .credential-label {
          font-weight: 600;
          color: #1a1a1a;
          font-size: 13px;
          background: #f0fdf4 !important;
        }

        .credentials-table input {
          width: 100%;
          padding: 9px 11px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 13px;
          outline: none;
        }

        .credentials-table input:focus {
          border-color: #10b981;
        }

        .other-credentials-title {
          font-size: 14px;
          font-weight: 600;
          color: #064e3b;
          text-align: center;
          margin: 24px 0 16px 0;
          padding: 12px;
          background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
          border-radius: 8px;
        }

        .other-credentials-table {
          width: 100%;
          border-collapse: collapse;
          border: 1px solid #e5e7eb;
        }

        .other-credentials-table thead {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .other-credentials-table th {
          padding: 10px 12px;
          text-align: left;
          font-size: 12px;
          font-weight: 600;
          color: #fff;
          border: 1px solid #059669;
        }

        .other-credentials-table td {
          padding: 8px 12px;
          border: 1px solid #e5e7eb;
          background: #fff;
        }

        .other-credentials-table input {
          width: 100%;
          padding: 8px 10px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 12px;
          outline: none;
        }

        .other-credentials-table input:focus {
          border-color: #10b981;
        }

        /* Contact Information Tab */
        .contact-info-content {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .contact-title {
          font-size: 18px;
          font-weight: 600;
          color: #64748b;
          margin: 0 0 24px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .contact-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 24px;
          border: 1px solid #e5e7eb;
        }

        .contact-table thead {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .contact-table th {
          padding: 12px 10px;
          text-align: center;
          font-size: 12px;
          font-weight: 600;
          color: #fff;
          border: 1px solid #059669;
        }

        .contact-table th:first-child {
          width: 130px;
          text-align: left;
        }

        .contact-table td {
          padding: 8px 10px;
          border: 1px solid #e5e7eb;
          background: #fff;
        }

        .contact-row-label {
          font-weight: 600;
          color: #1a1a1a;
          font-size: 12px;
          text-align: left;
          background: #f0fdf4 !important;
        }

        .contact-table input {
          width: 100%;
          padding: 8px 10px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 12px;
          outline: none;
        }

        .contact-table input:focus {
          border-color: #10b981;
        }

        .update-contact-list {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
          background: #f0fdf4;
          border-radius: 8px;
          border: 1px solid #bbf7d0;
        }

        .update-contact-list label {
          font-size: 14px;
          font-weight: 600;
          color: #1a1a1a;
        }

        .update-contact-list select {
          padding: 10px 14px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 14px;
          outline: none;
          min-width: 120px;
        }

        /* Agreed Fees Tab */
        .fees-content {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .fees-title {
          font-size: 18px;
          font-weight: 600;
          color: #64748b;
          margin: 0 0 24px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .fees-table {
          width: 100%;
          border-collapse: collapse;
        }

        .fees-table thead {
          background: #f8fafc;
        }

        .fees-table th {
          padding: 14px 10px;
          text-align: left;
          font-size: 13px;
          font-weight: 600;
          color: #475569;
          border-bottom: 2px solid #10b981;
        }

        .fees-table th:first-child {
          width: 80px;
        }

        .fees-table td {
          padding: 10px;
          border-bottom: 1px solid #f1f5f9;
        }

        .fees-table select,
        .fees-table input[type="number"],
        .fees-table input[type="text"] {
          width: 100%;
          padding: 9px 11px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 13px;
          outline: none;
        }

        .fees-table select:focus,
        .fees-table input:focus {
          border-color: #10b981;
        }

        /* KYC Documents Tab */
        .kyc-content {
          background: white;
          border-radius: 12px;
          padding: 24px;
        }

        .kyc-title {
          font-size: 18px;
          font-weight: 600;
          color: #64748b;
          margin: 0 0 16px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .kyc-note {
          background: #fef3c7;
          border-left: 4px solid #f59e0b;
          padding: 12px 16px;
          border-radius: 6px;
          margin-bottom: 24px;
          display: flex;
          align-items: flex-start;
          gap: 10px;
          font-size: 12px;
          color: #92400e;
        }

        .kyc-note svg {
          flex-shrink: 0;
          margin-top: 2px;
        }

        .kyc-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
          border: 1px solid #e5e7eb;
        }

        .kyc-table thead {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kyc-table th {
          padding: 12px;
          text-align: left;
          font-size: 12px;
          font-weight: 600;
          color: #fff;
          border: 1px solid #059669;
        }

        .kyc-table th:first-child {
          width: 80px;
        }

        .kyc-table th:nth-child(2) {
          width: 180px;
        }

        .kyc-table td {
          padding: 10px 12px;
          border: 1px solid #e5e7eb;
          background: #fff;
        }

        .doc-name {
          font-weight: 600;
          color: #1a1a1a;
          background: #f0fdf4 !important;
        }

        .kyc-table input[type="file"] {
          font-size: 12px;
          padding: 6px;
        }

        .kyc-table input[type="text"] {
          width: 100%;
          padding: 8px 10px;
          border: 1.5px solid #e2e8f0;
          border-radius: 6px;
          font-size: 12px;
          outline: none;
        }

        .kyc-table input[type="text"]:focus {
          border-color: #10b981;
        }

        .btn-add-more-kyc {
          padding: 10px 24px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          float: right;
        }

        .btn-add-more-kyc:hover {
          background: #059669;
        }

        .details-compact-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 24px;
        }

        .details-section {
          background: #f8fafc;
          border-radius: 10px;
          padding: 20px;
          border: 1px solid #e2e8f0;
        }

        .details-section.full-width {
          grid-column: 1 / -1;
        }

        .details-section h4 {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 16px;
          padding-bottom: 8px;
          border-bottom: 2px solid #10b981;
        }

        .compact-detail-row {
          display: grid;
          grid-template-columns: 180px 1fr;
          gap: 12px;
          padding: 10px 0;
          border-bottom: 1px solid #e2e8f0;
          align-items: start;
        }

        .compact-detail-row:last-child {
          border-bottom: none;
        }

        .compact-detail-row .label {
          font-size: 13px;
          font-weight: 600;
          color: #64748b;
        }

        .compact-detail-row .value {
          font-size: 14px;
          color: #1a1a1a;
          font-weight: 500;
        }

        .compact-detail-row .value.priority-high {
          color: #ef4444;
          font-weight: 600;
        }

        .compact-detail-row .value.priority-critical {
          color: #dc2626;
          font-weight: 700;
        }

        .compact-detail-row .value.priority-medium {
          color: #f59e0b;
          font-weight: 600;
        }

        .compact-detail-row .value.priority-low {
          color: #3b82f6;
          font-weight: 600;
        }

        /* Add Task Modal Styles */
        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          backdrop-filter: blur(8px);
          animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slideUp {
          from {
            transform: translateY(20px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .add-task-modal {
          background: white;
          border-radius: 12px;
          width: 85%;
          max-width: 850px;
          max-height: 85vh;
          overflow: hidden;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
          animation: slideUp 0.3s ease-out;
          display: flex;
          flex-direction: column;
        }

        .modal-header-task {
          padding: 18px 28px;
          border-bottom: 2px solid #e2e8f0;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          position: relative;
          overflow: hidden;
        }

        .modal-header-task::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
          opacity: 1;
        }

        .modal-header-task h2 {
          font-size: 20px;
          font-weight: 700;
          color: white;
          display: flex;
          align-items: center;
          gap: 10px;
          margin: 0;
          position: relative;
          z-index: 1;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-header-task h2 svg {
          width: 22px;
          height: 22px;
        }

        .btn-close-modal {
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          color: white;
          cursor: pointer;
          padding: 6px;
          border-radius: 8px;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          z-index: 1;
        }

        .btn-close-modal:hover {
          background: rgba(255, 255, 255, 0.3);
          border-color: rgba(255, 255, 255, 0.5);
          transform: rotate(90deg);
        }

        .btn-close-modal svg {
          width: 18px;
          height: 18px;
        }

        .add-task-form {
          padding: 24px 28px;
          overflow-y: auto;
          flex: 1;
          background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        }

        .form-grid-task {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
          margin-bottom: 20px;
        }

        .form-field-task {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .form-field-task.full-width {
          grid-column: 1 / -1;
        }

        .form-field-task label {
          font-size: 12px;
          font-weight: 600;
          color: #1e293b;
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .form-field-task input,
        .form-field-task select,
        .form-field-task textarea {
          padding: 9px 12px;
          border: 1.5px solid #e2e8f0;
          border-radius: 8px;
          font-size: 13px;
          color: #1a1a1a;
          outline: none;
          background: white;
          transition: all 0.2s ease;
          font-family: inherit;
        }

        .form-field-task input:focus,
        .form-field-task select:focus,
        .form-field-task textarea:focus {
          border-color: #10b981;
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
          transform: translateY(-1px);
        }

        .form-field-task input:disabled,
        .form-field-task select:disabled {
          background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
          cursor: not-allowed;
          color: #64748b;
          border-color: #e2e8f0;
        }

        .form-field-task select {
          cursor: pointer;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2310b981' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 12px center;
          padding-right: 32px;
          appearance: none;
        }

        .form-field-task select:disabled {
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2394a3b8' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
        }

        .form-field-task textarea {
          resize: vertical;
          min-height: 60px;
        }

        .required-star {
          color: #ef4444;
          font-weight: 700;
          font-size: 13px;
        }

        .modal-footer-task {
          padding: 16px 28px;
          border-top: 2px solid #e2e8f0;
          background: white;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .btn-cancel {
          padding: 10px 24px;
          background: white;
          color: #64748b;
          border: 1.5px solid #e2e8f0;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-cancel:hover {
          background: #f8fafc;
          border-color: #cbd5e1;
          color: #475569;
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .btn-cancel:active {
          transform: translateY(0);
        }

        .btn-primary {
          padding: 10px 24px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
          box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:active {
          transform: translateY(0);
        }

        .btn-primary svg {
          width: 16px;
          height: 16px;
        }

        /* Quick Add Client Form */
        .quick-client-form {
          padding: 24px 28px;
          background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        }

        .quick-form-header {
          margin-bottom: 20px;
          padding-bottom: 16px;
          border-bottom: 2px solid #e2e8f0;
        }

        .quick-form-header h3 {
          font-size: 18px;
          font-weight: 700;
          color: #10b981;
          margin: 0 0 6px 0;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .quick-form-header h3 svg {
          width: 18px;
          height: 18px;
        }

        .quick-form-header p {
          font-size: 12px;
          color: #64748b;
          margin: 0;
        }

        .quick-form-body {
          display: flex;
          flex-direction: column;
          gap: 14px;
        }

        .quick-form-actions {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          margin-top: 20px;
          padding-top: 16px;
          border-top: 2px solid #e2e8f0;
        }

        .inline-checkbox {
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: pointer;
          user-select: none;
          padding: 10px 12px;
          background: #f0fdf4;
          border: 1.5px solid #bbf7d0;
          border-radius: 8px;
          transition: all 0.2s;
        }

        .inline-checkbox:hover {
          background: #dcfce7;
          border-color: #86efac;
        }

        .inline-checkbox input[type="checkbox"] {
          width: 16px;
          height: 16px;
          cursor: pointer;
          accent-color: #10b981;
        }

        .inline-checkbox span {
          font-size: 12px;
          font-weight: 600;
          color: #166534;
        }

        /* Templates View Styles */
        .templates-view {
          padding: 24px;
        }

        .templates-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 24px;
          margin-bottom: 48px;
        }

        .template-card {
          background: white;
          border-radius: 12px;
          padding: 24px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          display: flex;
          flex-direction: column;
          gap: 16px;
          transition: all 0.3s;
        }

        .template-card:hover:not(.disabled) {
          transform: translateY(-4px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .template-card.disabled {
          opacity: 0.6;
        }

        .template-icon {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 80px;
          height: 80px;
          background: #f0fdf4;
          border-radius: 12px;
          margin: 0 auto;
        }

        .template-card.disabled .template-icon {
          background: #f8fafc;
        }

        .template-content h3 {
          font-size: 20px;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0 0 8px 0;
        }

        .template-content p {
          font-size: 14px;
          color: #64748b;
          margin: 0 0 16px 0;
        }

        .template-details {
          background: #f8fafc;
          border-radius: 8px;
          padding: 12px;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .template-detail-item {
          font-size: 13px;
          color: #475569;
        }

        .template-detail-item strong {
          color: #1a1a1a;
          font-weight: 600;
        }

        .btn-download-template {
          padding: 12px 20px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          transition: all 0.2s;
        }

        .btn-download-template:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-download-template:disabled {
          background: #e2e8f0;
          color: #94a3b8;
          cursor: not-allowed;
        }

        .template-instructions {
          background: white;
          border-radius: 12px;
          padding: 32px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .template-instructions h2 {
          font-size: 24px;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0 0 24px 0;
        }

        .instructions-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 24px;
          margin-bottom: 32px;
        }

        .instruction-step {
          display: flex;
          gap: 16px;
        }

        .step-number {
          flex-shrink: 0;
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          font-weight: 700;
        }

        .step-content h4 {
          font-size: 16px;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0 0 8px 0;
        }

        .step-content p {
          font-size: 14px;
          color: #64748b;
          margin: 0;
        }

        .template-notes {
          background: #fef3c7;
          border-left: 4px solid #f59e0b;
          border-radius: 8px;
          padding: 20px 24px;
        }

        .template-notes h3 {
          font-size: 16px;
          font-weight: 600;
          color: #92400e;
          margin: 0 0 12px 0;
        }

        .template-notes ul {
          margin: 0;
          padding-left: 20px;
        }

        .template-notes li {
          font-size: 14px;
          color: #78350f;
          line-height: 1.8;
          margin-bottom: 6px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
          .filters-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        @media (max-width: 768px) {
          .sidebar {
            width: 80px;
          }

          .sidebar .logo-text,
          .sidebar .nav-section-header span,
          .sidebar .user-info {
            display: none;
          }

          .stats-grid {
            grid-template-columns: 1fr;
          }

          .filters-grid {
            grid-template-columns: 1fr;
          }

          .form-row {
            grid-template-columns: 1fr;
          }

          .main-content {
            padding: 16px;
          }
        }

        /* New Task Management Modal Styles */
        .task-manage-modal-new {
          background: white;
          border-radius: 16px;
          width: 90%;
          max-width: 1100px;
          max-height: 90vh;
          overflow: hidden;
          box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4);
          animation: slideUp 0.3s ease-out;
          display: flex;
          flex-direction: column;
        }

        .task-modal-header-new {
          padding: 20px 32px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: none;
        }

        .header-content-new {
          display: flex;
          align-items: center;
          gap: 20px;
          flex: 1;
        }

        .header-content-new h2 {
          color: white;
          font-size: 22px;
          font-weight: 700;
          margin: 0;
        }

        .header-action-buttons {
          display: flex;
          gap: 12px;
        }

        .btn-complete-header,
        .btn-reopen-header {
          padding: 10px 24px;
          border: 2px solid white;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          background: white;
          color: #10b981;
        }

        .btn-reopen-header {
          background: #f59e0b;
          color: white;
          border-color: #f59e0b;
        }

        .btn-complete-header:hover {
          background: #dcfce7;
          transform: scale(1.05);
        }

        .btn-reopen-header:hover {
          background: #d97706;
          transform: scale(1.05);
        }

        .header-title-section {
          display: flex;
          align-items: center;
          gap: 16px;
        }

        .header-title-section h2 {
          color: white;
          font-size: 22px;
          font-weight: 700;
          margin: 0;
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .task-status-badge {
          display: inline-block;
        }

        .btn-close-modal-new {
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          color: white;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .btn-close-modal-new:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: rotate(90deg);
        }

        .quick-actions-bar {
          display: flex;
          gap: 12px;
          padding: 16px 32px;
          background: #f8fafc;
          border-bottom: 2px solid #e2e8f0;
        }

        .quick-action-btn {
          flex: 1;
          padding: 12px 16px;
          background: white;
          border: 1.5px solid #e2e8f0;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          cursor: pointer;
          transition: all 0.2s;
          color: #64748b;
          font-size: 13px;
          font-weight: 600;
        }

        .quick-action-btn:hover {
          border-color: #10b981;
          color: #10b981;
          background: #f0fdf4;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .task-details-body-new {
          padding: 24px 32px;
          overflow-y: auto;
          flex: 1;
          background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        }

        .view-mode-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding-bottom: 16px;
          border-bottom: 2px solid #e2e8f0;
        }

        .view-mode-header h3 {
          font-size: 20px;
          font-weight: 700;
          color: #1a1a1a;
          margin: 0;
        }

        .view-mode-actions {
          display: flex;
          gap: 10px;
        }

        .btn-action-secondary {
          padding: 10px 18px;
          background: white;
          color: #64748b;
          border: 1.5px solid #e2e8f0;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
        }

        .btn-action-secondary:hover {
          border-color: #10b981;
          color: #10b981;
          background: #f0fdf4;
        }

        .btn-action-close {
          padding: 10px 18px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-action-close:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-action-reopen {
          padding: 10px 18px;
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
          box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-action-reopen:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .details-grid-new {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
        }

        .detail-card-new {
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          padding: 20px;
          transition: all 0.3s;
        }

        .detail-card-new:hover {
          border-color: #10b981;
          box-shadow: 0 8px 24px rgba(16, 185, 129, 0.1);
          transform: translateY(-2px);
        }

        .detail-card-new.full-width {
          grid-column: 1 / -1;
        }

        .detail-card-new h4 {
          font-size: 16px;
          font-weight: 700;
          color: #10b981;
          margin: 0 0 16px 0;
          display: flex;
          align-items: center;
          gap: 8px;
          padding-bottom: 12px;
          border-bottom: 2px solid #e2e8f0;
        }

        .detail-rows {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .detail-row-new {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 0;
          border-bottom: 1px solid #f1f5f9;
        }

        .detail-row-new:last-child {
          border-bottom: none;
        }

        .label-new {
          font-size: 13px;
          font-weight: 600;
          color: #64748b;
        }

        .value-new {
          font-size: 13px;
          color: #1a1a1a;
          font-weight: 500;
          text-align: right;
        }

        .edit-mode-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding-bottom: 16px;
          border-bottom: 2px solid #e2e8f0;
        }

        .edit-mode-header h3 {
          font-size: 20px;
          font-weight: 700;
          color: #1a1a1a;
          margin: 0;
        }

        .edit-mode-actions {
          display: flex;
          gap: 12px;
        }

        .edit-form-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
          .details-grid-new {
            grid-template-columns: 1fr;
          }
        }

        /* Timesheet Modal Styles - Professional Corporate Design */
        .timesheet-modal {
          background: #ffffff;
          border-radius: 8px;
          width: 95%;
          max-width: 1600px;
          max-height: 95vh;
          overflow-y: auto;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
          animation: slideUp 0.3s ease;
        }

        .timesheet-modal-header {
          padding: 24px 40px;
          background: #1e293b;
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 3px solid #3b82f6;
          position: sticky;
          top: 0;
          z-index: 10;
        }

        .timesheet-modal-header h2 {
          font-size: 20px;
          font-weight: 600;
          margin: 0;
          letter-spacing: 0.3px;
        }

        .timesheet-modal-body {
          padding: 32px 40px;
          background: #f8fafc;
        }

        .timesheet-info-section {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          padding: 24px 28px;
          margin-bottom: 28px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .timesheet-info-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 24px 32px;
        }

        .info-item {
          display: flex;
          flex-direction: column;
          gap: 8px;
          border-left: 3px solid #e2e8f0;
          padding-left: 16px;
        }

        .info-label {
          font-size: 11px;
          font-weight: 600;
          color: #64748b;
          text-transform: uppercase;
          letter-spacing: 0.8px;
        }

        .info-value {
          font-size: 15px;
          font-weight: 600;
          color: #0f172a;
        }

        .info-value-select,
        .info-value-date {
          padding: 10px 14px;
          border: 1px solid #cbd5e1;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          color: #0f172a;
          background: white;
          transition: all 0.2s;
        }

        .info-value-select:focus,
        .info-value-date:focus {
          outline: none;
          border-color: #3b82f6;
          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
        }

        .timesheet-status-badge {
          padding: 5px 12px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 700;
          display: inline-block;
          text-transform: uppercase;
          letter-spacing: 0.8px;
          border: 1px solid;
        }

        .timesheet-status-badge.status-not-started {
          background: #fef2f2;
          color: #991b1b;
          border-color: #fca5a5;
        }

        .timesheet-status-badge.status-in-progress {
          background: #fffbeb;
          color: #92400e;
          border-color: #fcd34d;
        }

        .timesheet-status-badge.status-submitted {
          background: #f0fdf4;
          color: #166534;
          border-color: #86efac;
        }

        .timesheet-entry-section {
          margin-top: 28px;
          background: white;
          border-radius: 6px;
          padding: 24px;
          border: 1px solid #e2e8f0;
        }

        .section-title-timesheet {
          font-size: 16px;
          font-weight: 600;
          color: #0f172a;
          margin-bottom: 20px;
          padding-bottom: 12px;
          border-bottom: 2px solid #e2e8f0;
          letter-spacing: 0.3px;
        }

        .timesheet-table-wrapper {
          overflow-x: auto;
          border-radius: 6px;
          border: 1px solid #cbd5e1;
          margin-bottom: 20px;
          background: white;
        }

        .timesheet-table {
          width: 100%;
          border-collapse: collapse;
          min-width: 1300px;
        }

        .timesheet-table thead {
          background: #f1f5f9;
          border-bottom: 2px solid #cbd5e1;
        }

        .timesheet-table th {
          padding: 14px 12px;
          text-align: left;
          font-size: 11px;
          font-weight: 700;
          color: #475569;
          text-transform: uppercase;
          letter-spacing: 0.6px;
          border-right: 1px solid #e2e8f0;
        }

        .timesheet-table th:last-child {
          border-right: none;
        }

        .timesheet-table tbody tr {
          border-bottom: 1px solid #e2e8f0;
          transition: background 0.15s;
        }

        .timesheet-table tbody tr:hover {
          background: #f8fafc;
        }

        .timesheet-table tbody tr:last-child {
          border-bottom: none;
        }

        .timesheet-table td {
          padding: 12px;
          vertical-align: middle;
        }

        .total-time-cell {
          font-weight: 700;
          color: #0f172a;
          font-size: 13px;
          background: #f0f9ff;
        }

        .timesheet-input-time,
        .timesheet-input-select,
        .timesheet-input-text {
          width: 100%;
          padding: 9px 11px;
          border: 1px solid #cbd5e1;
          border-radius: 4px;
          font-size: 13px;
          transition: all 0.2s;
          background: white;
          color: #0f172a;
        }

        .timesheet-input-time:focus,
        .timesheet-input-select:focus,
        .timesheet-input-text:focus {
          outline: none;
          border-color: #3b82f6;
          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
        }

        .timesheet-input-select:disabled {
          background: #f1f5f9;
          color: #94a3b8;
          cursor: not-allowed;
        }

        .disabled-cell {
          color: #94a3b8;
          font-style: normal;
          font-size: 13px;
          text-align: center;
        }

        .btn-remove-entry {
          padding: 8px;
          background: white;
          color: #dc2626;
          border: 1px solid #dc2626;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .btn-remove-entry:hover {
          background: #dc2626;
          color: white;
        }

        .timesheet-add-buttons {
          display: flex;
          gap: 12px;
          justify-content: flex-start;
        }

        .btn-add-entry {
          padding: 11px 22px;
          border: none;
          border-radius: 4px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 8px;
          letter-spacing: 0.3px;
        }

        .btn-add-entry.btn-billable {
          background: #059669;
          color: white;
          border: 1px solid #059669;
        }

        .btn-add-entry.btn-billable:hover {
          background: #047857;
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }

        .btn-add-entry.btn-non-billable {
          background: white;
          color: #d97706;
          border: 1px solid #d97706;
        }

        .btn-add-entry.btn-non-billable:hover {
          background: #d97706;
          color: white;
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(217, 119, 6, 0.25);
        }

        .timesheet-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 20px 40px;
          border-top: 1px solid #e2e8f0;
          background: #f8fafc;
          position: sticky;
          bottom: 0;
        }

        .timesheet-modal-footer .btn-primary:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* ========================================
           INTEGRATED TIMESHEET MODAL STYLES
           ======================================== */
        
        .timesheet-modal-integrated {
          background: #fff;
          width: 95%;
          max-width: 1400px;
          max-height: 92vh;
          border-radius: 8px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .timesheet-modal-header-tabs {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #1e293b;
          padding: 0 16px 0 0;
        }

        .timesheet-tabs {
          display: flex;
        }

        .timesheet-tab {
          padding: 16px 28px;
          background: transparent;
          border: none;
          color: #94a3b8;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
          border-bottom: 3px solid transparent;
        }

        .timesheet-tab:hover {
          color: #e2e8f0;
          background: rgba(255,255,255,0.05);
        }

        .timesheet-tab.active {
          color: #fff;
          background: rgba(16, 185, 129, 0.15);
          border-bottom-color: #10b981;
        }

        /* FILL TAB CONTENT */
        .timesheet-fill-content {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #f8fafc;
        }

        .existing-timesheet-warning {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px 16px;
          background: #fef3c7;
          border: 1px solid #f59e0b;
          border-radius: 6px;
          margin-bottom: 16px;
          color: #92400e;
          font-size: 13px;
          font-weight: 500;
        }

        .existing-timesheet-warning button {
          background: none;
          border: none;
          color: #d97706;
          font-weight: 600;
          cursor: pointer;
          text-decoration: underline;
          margin-left: 4px;
        }

        .existing-timesheet-warning button:hover {
          color: #b45309;
        }

        .timesheet-info-bar {
          display: flex;
          gap: 16px;
          padding: 16px 20px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          margin-bottom: 20px;
          flex-wrap: wrap;
        }

        .info-bar-item {
          display: flex;
          flex-direction: column;
          gap: 4px;
          min-width: 120px;
        }

        .info-bar-item label {
          font-size: 10px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .info-bar-item select,
        .info-bar-item input {
          padding: 8px 10px;
          border: 1px solid #cbd5e1;
          border-radius: 4px;
          font-size: 13px;
          font-weight: 500;
          color: #0f172a;
        }

        .info-bar-item select:focus,
        .info-bar-item input:focus {
          outline: none;
          border-color: #10b981;
          box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }

        .status-select.present { color: #059669; font-weight: 600; }
        .status-select.leave { color: #dc2626; font-weight: 600; }

        .info-value {
          padding: 8px 0;
          font-size: 14px;
          font-weight: 700;
          color: #0f172a;
        }

        .info-value.posted { color: #0369a1; }
        .info-value.remaining { color: #dc2626; }
        .info-value.complete { color: #059669; }

        /* Entries Table */
        .timesheet-entries-section {
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          overflow: hidden;
          margin-bottom: 16px;
        }

        .timesheet-entries-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .timesheet-entries-table thead {
          background: #f1f5f9;
        }

        .timesheet-entries-table th {
          padding: 10px 8px;
          text-align: left;
          font-size: 10px;
          font-weight: 700;
          color: #475569;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border-bottom: 2px solid #e2e8f0;
        }

        .timesheet-entries-table td {
          padding: 8px;
          border-bottom: 1px solid #f1f5f9;
          vertical-align: middle;
        }

        .timesheet-entries-table tbody tr:hover {
          background: #f8fafc;
        }

        .timesheet-entries-table input,
        .timesheet-entries-table select {
          width: 100%;
          padding: 7px 8px;
          border: 1px solid #e2e8f0;
          border-radius: 4px;
          font-size: 12px;
        }

        .timesheet-entries-table input:focus,
        .timesheet-entries-table select:focus {
          outline: none;
          border-color: #10b981;
        }

        .timesheet-entries-table select:disabled {
          background: #f1f5f9;
          color: #94a3b8;
        }

        .total-cell {
          font-weight: 700;
          color: #0f172a;
          text-align: center;
        }

        .na-cell {
          color: #94a3b8;
          text-align: center;
          font-size: 12px;
        }

        .type-billable { color: #059669; font-weight: 600; }
        .type-nonbillable { color: #d97706; font-weight: 600; }

        .btn-remove {
          padding: 6px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 4px;
          color: #94a3b8;
          cursor: pointer;
          transition: all 0.15s;
        }

        .btn-remove:hover {
          background: #fef2f2;
          border-color: #dc2626;
          color: #dc2626;
        }

        /* Actions Row */
        .timesheet-actions-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .add-entry-buttons {
          display: flex;
          gap: 8px;
        }

        .btn-add-billable,
        .btn-add-nonbillable {
          padding: 8px 16px;
          border: none;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.15s;
        }

        .btn-add-billable {
          background: #059669;
          color: #fff;
        }

        .btn-add-billable:hover {
          background: #047857;
        }

        .btn-add-nonbillable {
          background: #fff;
          color: #d97706;
          border: 1px solid #d97706;
        }

        .btn-add-nonbillable:hover {
          background: #d97706;
          color: #fff;
        }

        .btn-save-timesheet {
          padding: 10px 28px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: #fff;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.15s;
        }

        .btn-save-timesheet:hover:not(:disabled) {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-save-timesheet:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* Edit Mode Banner */
        .edit-mode-banner {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 16px;
          background: #dbeafe;
          border: 1px solid #3b82f6;
          border-radius: 6px;
          margin-bottom: 16px;
          color: #1e40af;
          font-size: 13px;
          font-weight: 500;
        }

        .edit-mode-banner .btn-delete-small {
          margin-left: auto;
          padding: 4px 12px;
          background: #fff;
          border: 1px solid #dc2626;
          border-radius: 4px;
          color: #dc2626;
          font-size: 11px;
          font-weight: 600;
          cursor: pointer;
        }

        .edit-mode-banner .btn-delete-small:hover {
          background: #dc2626;
          color: #fff;
        }

        /* Entry Row Saved State */
        .row-saved {
          background: #f0fdf4 !important;
        }

        /* Entry Row Error State */
        .row-error {
          background: #fef2f2 !important;
          animation: pulse-error 2s infinite;
        }

        @keyframes pulse-error {
          0%, 100% { background: #fef2f2; }
          50% { background: #fee2e2; }
        }

        .input-error {
          border-color: #dc2626 !important;
          background: #fef2f2 !important;
          box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2) !important;
        }

        .error-text {
          color: #dc2626 !important;
        }

        .error-badge {
          display: inline-block;
          background: #dc2626;
          color: #fff;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 9px;
          font-weight: 700;
          margin-top: 4px;
          animation: blink 1s infinite;
        }

        @keyframes blink {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.6; }
        }

        .error-message-row {
          background: #fef2f2 !important;
        }

        .error-message-row td {
          padding: 0 !important;
          border-bottom: 2px solid #dc2626 !important;
        }

        .overlap-error-message {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
          color: #fff;
          font-size: 12px;
          font-weight: 600;
        }

        .overlap-error-message svg {
          flex-shrink: 0;
        }

        .timesheet-entries-table td {
          position: relative;
        }

        .status-saved {
          color: #059669;
          font-size: 11px;
          font-weight: 600;
        }

        .status-pending {
          color: #94a3b8;
          font-size: 12px;
        }

        .btn-save-entry {
          padding: 4px 10px;
          background: #10b981;
          color: #fff;
          border: none;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-save-entry:hover {
          background: #059669;
        }

        /* Info Bar Additional Values */
        .info-value.billable-val { color: #059669; }
        .info-value.nonbillable-val { color: #d97706; }

        /* Action Buttons in View Table */
        .action-buttons {
          display: flex;
          gap: 6px;
        }

        .btn-edit-small {
          padding: 4px 10px;
          background: #fff;
          border: 1px solid #3b82f6;
          border-radius: 4px;
          color: #3b82f6;
          font-size: 11px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-edit-small:hover {
          background: #3b82f6;
          color: #fff;
        }

        .btn-fill-small {
          padding: 4px 10px;
          background: #f59e0b;
          border: none;
          border-radius: 4px;
          color: #fff;
          font-size: 11px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-fill-small:hover {
          background: #d97706;
        }

        .btn-edit-detail {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 8px 16px;
          background: #3b82f6;
          color: #fff;
          border: none;
          border-radius: 6px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          margin-left: auto;
        }

        .btn-edit-detail:hover {
          background: #2563eb;
        }

        /* Leave Notice */
        .leave-notice {
          text-align: center;
          padding: 60px 40px;
          background: #fff;
          border: 2px dashed #e2e8f0;
          border-radius: 8px;
        }

        .leave-notice .leave-icon {
          font-size: 48px;
          margin-bottom: 12px;
        }

        .leave-notice h3 {
          font-size: 18px;
          color: #0f172a;
          margin-bottom: 8px;
        }

        .leave-notice p {
          color: #64748b;
          font-size: 14px;
          margin-bottom: 20px;
        }

        .btn-save-leave {
          padding: 12px 32px;
          background: #f59e0b;
          color: #fff;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-save-leave:hover {
          background: #d97706;
        }

        /* VIEW TAB CONTENT */
        .timesheet-view-content {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #f8fafc;
        }

        .view-filters {
          display: flex;
          gap: 16px;
          margin-bottom: 20px;
          padding: 16px 20px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
        }

        .filter-item {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .filter-item label {
          font-size: 10px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
        }

        .filter-item select,
        .filter-item input {
          padding: 8px 12px;
          border: 1px solid #cbd5e1;
          border-radius: 4px;
          font-size: 13px;
          min-width: 180px;
        }

        .timesheet-table-container {
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          overflow: hidden;
        }

        .view-timesheet-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .view-timesheet-table thead {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .view-timesheet-table th {
          padding: 12px 10px;
          text-align: left;
          font-size: 11px;
          font-weight: 700;
          color: #fff;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .view-timesheet-table tbody tr {
          border-bottom: 1px solid #f1f5f9;
          transition: background 0.1s;
        }

        .view-timesheet-table tbody tr:hover {
          background: #f8fafc;
        }

        .view-timesheet-table tbody tr.row-missing {
          background: #fef2f2;
        }

        .view-timesheet-table td {
          padding: 10px;
        }

        .col-date {
          font-weight: 600;
          color: #0f172a;
        }

        .col-hours {
          font-weight: 600;
          color: #0f172a;
        }

        .status-tag {
          padding: 4px 10px;
          border-radius: 4px;
          font-size: 10px;
          font-weight: 700;
          text-transform: uppercase;
        }

        .status-tag.status-present {
          background: #dcfce7;
          color: #166534;
        }

        .status-tag.status-full-day-leave,
        .status-tag.status-leave {
          background: #fef3c7;
          color: #92400e;
        }

        .status-tag.status-missing {
          background: #fef2f2;
          color: #991b1b;
        }

        .missing-tag {
          color: #dc2626;
          font-size: 11px;
          font-weight: 600;
        }

        .btn-view-details {
          padding: 5px 12px;
          background: #10b981;
          color: #fff;
          border: none;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-view-details:hover {
          background: #059669;
        }

        /* Detail View */
        .timesheet-detail-content {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #f8fafc;
        }

        .detail-header {
          display: flex;
          align-items: center;
          gap: 16px;
          margin-bottom: 20px;
        }

        .btn-back {
          padding: 8px 16px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 4px;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          color: #64748b;
        }

        .btn-back:hover {
          background: #f8fafc;
          color: #0f172a;
        }

        .detail-header h3 {
          font-size: 16px;
          font-weight: 600;
          color: #0f172a;
        }

        .detail-summary {
          display: flex;
          gap: 16px;
          padding: 16px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          margin-bottom: 20px;
          flex-wrap: wrap;
        }

        .summary-box {
          display: flex;
          flex-direction: column;
          gap: 4px;
          min-width: 100px;
        }

        .summary-box label {
          font-size: 10px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
        }

        .summary-box span {
          font-size: 14px;
          font-weight: 600;
          color: #0f172a;
        }

        .summary-box span.billable { color: #059669; }
        .summary-box span.nonbillable { color: #d97706; }

        .detail-entries {
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 16px;
          margin-bottom: 20px;
        }

        .detail-entries h4 {
          font-size: 14px;
          font-weight: 600;
          color: #0f172a;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e2e8f0;
        }

        .entries-detail-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 12px;
        }

        .entries-detail-table thead {
          background: #f8fafc;
        }

        .entries-detail-table th {
          padding: 8px;
          text-align: left;
          font-size: 10px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
        }

        .entries-detail-table td {
          padding: 8px;
          border-bottom: 1px solid #f1f5f9;
        }

        .type-tag {
          padding: 3px 8px;
          border-radius: 3px;
          font-size: 10px;
          font-weight: 700;
        }

        .type-tag.billable {
          background: #dcfce7;
          color: #166534;
        }

        .type-tag.nonbillable {
          background: #fef3c7;
          color: #92400e;
        }

        .desc-cell {
          max-width: 150px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .btn-delete-entry {
          padding: 4px 6px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 3px;
          color: #94a3b8;
          cursor: pointer;
        }

        .btn-delete-entry:hover {
          background: #fef2f2;
          border-color: #dc2626;
          color: #dc2626;
        }

        .no-entries {
          padding: 40px;
          text-align: center;
          color: #64748b;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
        }

        .detail-actions {
          display: flex;
          justify-content: flex-end;
        }

        .btn-delete-timesheet {
          padding: 10px 24px;
          background: #fff;
          border: 1px solid #dc2626;
          border-radius: 6px;
          color: #dc2626;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
        }

        .btn-delete-timesheet:hover {
          background: #dc2626;
          color: #fff;
        }

        /* Description Button */
        .btn-description {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 6px 10px;
          background: #f8fafc;
          border: 1px dashed #cbd5e1;
          border-radius: 4px;
          color: #64748b;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.15s;
          max-width: 150px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .btn-description:hover {
          background: #f1f5f9;
          border-color: #94a3b8;
          color: #475569;
        }

        .btn-description.has-content {
          background: #f0fdf4;
          border: 1px solid #86efac;
          color: #166534;
        }

        .btn-description.has-content:hover {
          background: #dcfce7;
        }

        /* Description Dialog */
        .description-dialog-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1100;
        }

        .description-dialog {
          background: #fff;
          border-radius: 12px;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          overflow: hidden;
        }

        .description-dialog-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px 20px;
          background: #1e293b;
          color: #fff;
        }

        .description-dialog-header h3 {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          font-weight: 600;
          margin: 0;
        }

        .description-dialog-header button {
          background: none;
          border: none;
          color: #94a3b8;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          transition: all 0.15s;
        }

        .description-dialog-header button:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }

        .description-dialog-body {
          padding: 20px;
        }

        .description-dialog-body textarea {
          width: 100%;
          height: 150px;
          padding: 12px;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          font-family: inherit;
          resize: vertical;
          line-height: 1.5;
        }

        .description-dialog-body textarea:focus {
          outline: none;
          border-color: #10b981;
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .char-count {
          text-align: right;
          font-size: 11px;
          color: #94a3b8;
          margin-top: 8px;
        }

        .description-dialog-footer {
          display: flex;
          justify-content: flex-end;
          gap: 10px;
          padding: 16px 20px;
          background: #f8fafc;
          border-top: 1px solid #e2e8f0;
        }

        .btn-cancel {
          padding: 10px 20px;
          background: #fff;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 500;
          color: #64748b;
          cursor: pointer;
        }

        .btn-cancel:hover {
          background: #f8fafc;
          color: #0f172a;
        }

        .btn-save-desc {
          padding: 10px 20px;
          background: #10b981;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
          color: #fff;
          cursor: pointer;
        }

        .btn-save-desc:hover {
          background: #059669;
        }

        /* View Description Button (in View Timesheet) */
        .btn-view-description {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 8px;
          background: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 4px;
          color: #0369a1;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.15s;
          max-width: 160px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .btn-view-description:hover {
          background: #0ea5e9;
          color: #fff;
        }

        .no-description {
          color: #94a3b8;
          font-size: 12px;
        }

        /* View Mode Dialog Styles */
        .description-dialog.view-mode .description-dialog-header {
          background: #0369a1;
        }

        .view-desc-meta {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 12px;
          background: #f0f9ff;
          border-radius: 6px;
          margin-bottom: 12px;
          font-size: 13px;
        }

        .meta-label {
          color: #64748b;
          font-weight: 500;
        }

        .meta-value {
          color: #0369a1;
          font-weight: 600;
        }

        .view-desc-content {
          padding: 16px;
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          line-height: 1.6;
          color: #334155;
          min-height: 100px;
          white-space: pre-wrap;
          word-break: break-word;
        }

        .btn-close-dialog {
          padding: 10px 24px;
          background: #0369a1;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
          color: #fff;
          cursor: pointer;
        }

        .btn-close-dialog:hover {
          background: #075985;
        }

        /* Short/Excess Hours Styling */
        .hours-short {
          color: #dc2626;
          font-weight: 700;
          font-size: 12px;
        }

        .hours-excess {
          color: #059669;
          font-weight: 700;
          font-size: 12px;
        }

        .hours-exact {
          color: #059669;
          font-weight: 600;
          font-size: 12px;
        }

        .hours-neutral {
          color: #94a3b8;
          font-size: 12px;
        }

        /* Timesheet Reports View Styles */
        .timesheet-reports-view {
          padding: 24px;
          background: #f8fafc;
          min-height: 100vh;
        }

        .timesheet-reports-view .view-header h1 {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .ts-report-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          flex-wrap: wrap;
          gap: 16px;
        }

        .ts-report-tabs {
          display: flex;
          gap: 8px;
          background: #fff;
          padding: 6px;
          border-radius: 10px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .ts-tab {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 20px;
          border: none;
          background: transparent;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 500;
          color: #64748b;
          cursor: pointer;
          transition: all 0.2s;
        }

        .ts-tab:hover {
          background: #f1f5f9;
          color: #0f172a;
        }

        .ts-tab.active {
          background: #10b981;
          color: #fff;
        }

        .ts-report-filters {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .ts-report-filters label {
          font-size: 14px;
          font-weight: 500;
          color: #475569;
        }

        .ts-report-filters input[type="month"] {
          padding: 10px 16px;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          font-size: 14px;
          background: #fff;
        }

        .ts-summary-cards {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 16px;
          margin-bottom: 24px;
        }

        .ts-summary-card {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          border-left: 4px solid #64748b;
        }

        .ts-summary-card.billable { border-left-color: #10b981; }
        .ts-summary-card.nonbillable { border-left-color: #f59e0b; }
        .ts-summary-card.entries { border-left-color: #3b82f6; }

        .ts-summary-icon {
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #f1f5f9;
          border-radius: 10px;
          color: #475569;
        }

        .ts-summary-card.billable .ts-summary-icon { background: #d1fae5; color: #059669; }
        .ts-summary-card.nonbillable .ts-summary-icon { background: #fef3c7; color: #d97706; }
        .ts-summary-card.entries .ts-summary-icon { background: #dbeafe; color: #2563eb; }

        .ts-summary-info {
          display: flex;
          flex-direction: column;
        }

        .ts-summary-value {
          font-size: 28px;
          font-weight: 700;
          color: #0f172a;
        }

        .ts-summary-label {
          font-size: 13px;
          color: #64748b;
        }

        .ts-report-content {
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          overflow: hidden;
        }

        .ts-report-section h2 {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 20px 24px;
          margin: 0;
          font-size: 18px;
          font-weight: 600;
          color: #0f172a;
          border-bottom: 1px solid #e2e8f0;
          background: #f8fafc;
        }

        /* Task Type Tabs Header */
        .ts-task-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px 24px;
          background: #f8fafc;
          border-bottom: 1px solid #e2e8f0;
          flex-wrap: wrap;
          gap: 12px;
        }

        .ts-task-header h2 {
          padding: 0;
          border-bottom: none;
          background: none;
        }

        .ts-task-type-tabs {
          display: flex;
          gap: 8px;
          background: #fff;
          padding: 4px;
          border-radius: 8px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .ts-type-tab {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 8px 16px;
          border: none;
          background: transparent;
          border-radius: 6px;
          font-size: 13px;
          font-weight: 500;
          color: #64748b;
          cursor: pointer;
          transition: all 0.2s;
        }

        .ts-type-tab:hover {
          background: #f1f5f9;
          color: #0f172a;
        }

        .ts-type-tab.active {
          background: #64748b;
          color: #fff;
        }

        .ts-type-tab.billable.active {
          background: #10b981;
        }

        .ts-type-tab.nonbillable.active {
          background: #f59e0b;
        }

        /* Task Summary Bar */
        .ts-task-summary-bar {
          display: flex;
          align-items: center;
          gap: 24px;
          padding: 12px 24px;
          background: #f1f5f9;
          border-bottom: 1px solid #e2e8f0;
        }

        .ts-task-summary-bar .summary-item {
          font-size: 14px;
          color: #475569;
        }

        .ts-task-summary-bar .summary-item strong {
          color: #0f172a;
        }

        .ts-task-summary-bar .summary-item strong.billable {
          color: #059669;
        }

        .ts-task-summary-bar .summary-item strong.nonbillable {
          color: #d97706;
        }

        .type-indicator {
          margin-left: 8px;
          font-size: 12px;
        }

        .hours-cell.billable {
          color: #059669;
        }

        .hours-cell.nonbillable {
          color: #d97706;
        }

        .ts-report-table-container {
          overflow-x: auto;
        }

        .ts-report-table {
          width: 100%;
          border-collapse: collapse;
        }

        .ts-report-table thead {
          background: #f1f5f9;
        }

        .ts-report-table th {
          padding: 14px 16px;
          text-align: left;
          font-size: 12px;
          font-weight: 600;
          color: #475569;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .ts-report-table td {
          padding: 14px 16px;
          border-bottom: 1px solid #f1f5f9;
          font-size: 14px;
          color: #334155;
        }

        .ts-report-row {
          cursor: pointer;
          transition: background 0.15s;
        }

        .ts-report-row:hover {
          background: #f8fafc;
        }

        .expand-cell {
          width: 40px;
          color: #94a3b8;
        }

        .name-cell {
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: 600;
          color: #0f172a;
        }

        .hours-cell {
          font-weight: 500;
        }

        .hours-cell.billable { color: #059669; }
        .hours-cell.nonbillable { color: #d97706; }

        .present-cell { color: #059669; font-weight: 600; }
        .leave-cell { color: #f59e0b; font-weight: 600; }

        .btn-view-daywise {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 6px;
          color: #0369a1;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.15s;
        }

        .btn-view-daywise:hover {
          background: #0ea5e9;
          color: #fff;
        }

        .expanded-row {
          background: #f8fafc;
        }

        .expanded-content {
          padding: 16px 24px 24px 56px;
        }

        .expanded-content h4 {
          margin: 0 0 12px 0;
          font-size: 14px;
          font-weight: 600;
          color: #475569;
        }

        .nested-table {
          width: 100%;
          max-width: 500px;
          border-collapse: collapse;
          background: #fff;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nested-table th {
          padding: 10px 14px;
          text-align: left;
          font-size: 11px;
          font-weight: 600;
          color: #64748b;
          background: #f1f5f9;
          text-transform: uppercase;
        }

        .nested-table td {
          padding: 10px 14px;
          font-size: 13px;
          border-bottom: 1px solid #f1f5f9;
        }

        .status-badge {
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 11px;
          font-weight: 600;
        }

        .status-badge.present { background: #d1fae5; color: #059669; }
        .status-badge.leave { background: #fef3c7; color: #d97706; }

        .no-data {
          padding: 60px 24px;
          text-align: center;
          color: #94a3b8;
          font-size: 16px;
        }

        /* Day Wise Modal */
        .daywise-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1200;
          padding: 20px;
        }

        .daywise-modal {
          background: #fff;
          border-radius: 16px;
          width: 100%;
          max-width: 900px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .daywise-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 20px 24px;
          background: #1e293b;
          color: #fff;
          border-radius: 16px 16px 0 0;
        }

        .daywise-header h3 {
          display: flex;
          align-items: center;
          gap: 10px;
          margin: 0;
          font-size: 18px;
        }

        .daywise-header button {
          background: none;
          border: none;
          color: #94a3b8;
          cursor: pointer;
          padding: 4px;
        }

        .daywise-header button:hover {
          color: #fff;
        }

        .daywise-subtitle {
          padding: 12px 24px;
          background: #f1f5f9;
          font-size: 13px;
          color: #64748b;
          border-bottom: 1px solid #e2e8f0;
        }

        .daywise-content {
          flex: 1;
          overflow-y: auto;
          padding: 20px 24px;
        }

        .daywise-date-group {
          margin-bottom: 20px;
        }

        .daywise-date-header {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 14px;
          background: #10b981;
          color: #fff;
          border-radius: 8px 8px 0 0;
          font-size: 14px;
          font-weight: 600;
        }

        .daywise-date-total {
          margin-left: auto;
          background: rgba(255,255,255,0.2);
          padding: 2px 10px;
          border-radius: 20px;
          font-size: 12px;
        }

        .daywise-table {
          width: 100%;
          border-collapse: collapse;
          border: 1px solid #e2e8f0;
          border-top: none;
          border-radius: 0 0 8px 8px;
          overflow: hidden;
        }

        .daywise-table th {
          padding: 10px 12px;
          text-align: left;
          font-size: 11px;
          font-weight: 600;
          color: #64748b;
          background: #f8fafc;
          text-transform: uppercase;
        }

        .daywise-table td {
          padding: 10px 12px;
          font-size: 13px;
          border-bottom: 1px solid #f1f5f9;
        }

        .daywise-table .hours-cell {
          font-weight: 600;
          color: #0f172a;
        }

        .daywise-table .desc-cell {
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          color: #64748b;
        }

        .type-badge {
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
        }

        .type-badge.billable { background: #d1fae5; color: #059669; }
        .type-badge.nonbillable { background: #fef3c7; color: #d97706; }

        @media (max-width: 1024px) {
          .ts-summary-cards {
            grid-template-columns: repeat(2, 1fr);
          }

          .timesheet-info-bar {
            flex-wrap: wrap;
          }

          .info-bar-item {
            flex: 1;
            min-width: calc(33% - 16px);
          }
        }

        @media (max-width: 768px) {
          .ts-summary-cards {
            grid-template-columns: 1fr;
          }

          .ts-report-controls {
            flex-direction: column;
            align-items: stretch;
          }

          .ts-report-tabs {
            overflow-x: auto;
          }

          .timesheet-modal-integrated {
            width: 100%;
            max-height: 100vh;
            border-radius: 0;
          }

          .timesheet-tab {
            padding: 12px 16px;
            font-size: 12px;
          }

          .info-bar-item {
            min-width: calc(50% - 8px);
          }

          .timesheet-entries-section {
            overflow-x: auto;
          }

          .timesheet-actions-row {
            flex-direction: column;
            gap: 12px;
          }
        }
      `}</style>

    </div>
  );
};

export default PracticeManagementApp;
